<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.7">
<title></title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


/*
 * Theme specific overrides of the preceding (asciidoc.css) CSS.
 *
 */
body {
  font-family: Garamond, Georgia, serif;
  font-size: 17px;
  color: #3E4349;
  line-height: 1.3em;
}
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Garmond, Georgia, serif;
  font-weight: normal;
  border-bottom-width: 0;
  color: #3E4349;
}
div.title, caption.title { color: #596673; font-weight: bold; }
h1 { font-size: 240%; }
h2 { font-size: 180%; }
h3 { font-size: 150%; }
h4 { font-size: 130%; }
h5 { font-size: 115%; }
h6 { font-size: 100%; }
#header h1 { margin-top: 0; }
#toc {
  color: #444444;
  line-height: 1.5;
  padding-top: 1.5em;
}
#toctitle {
  font-size: 20px;
}
#toc a {
    border-bottom: 1px dotted #999999;
    color: #444444 !important;
    text-decoration: none !important;
}
#toc a:hover {
    border-bottom: 1px solid #6D4100;
    color: #6D4100 !important;
    text-decoration: none !important;
}
div.toclevel1 { margin-top: 0.2em; font-size: 16px; }
div.toclevel2 { margin-top: 0.15em; font-size: 14px; }
em, dt, td.hdlist1 { color: black; }
strong { color: #3E4349; }
a { color: #004B6B; text-decoration: none; border-bottom: 1px dotted #004B6B; }
a:visited { color: #615FA0; border-bottom: 1px dotted #615FA0; }
a:hover { color: #6D4100; border-bottom: 1px solid #6D4100; }
div.tableblock > table, table.tableblock { border: 3px solid #E8E8E8; }
th.tableblock, td.tableblock { border: 1px solid #E8E8E8; }
ul > li > * { color: #3E4349; }
pre, tt, .monospaced { font-family: Consolas,Menlo,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; }
tt, .monospaced { font-size: 0.9em; color: black;
}
div.exampleblock > div.content, div.sidebarblock > div.content, div.listingblock > div.content { border-width: 0 0 0 3px; border-color: #E8E8E8; }
div.verseblock { border-left-width: 0; margin-left: 3em; }
div.quoteblock { border-left-width: 3px; margin-left: 0; margin-right: 0;}
div.admonitionblock td.content { border-left: 3px solid #E8E8E8; }
@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_about_this_text">About this text</h3>
<div class="paragraph"><p>A collection of solutions to questions you might have while developing
web applications with the <a href="http://www.liftweb.net">Lift web framework</a>.</p></div>
<div class="paragraph"><p>The aim is to give a single, short answer to a specific question. Where
there are different ways to achieve the same result, this cookbook just
shows one way, but may point you at alternatives in a discussion on the
solution.</p></div>
</div>
<div class="sect2">
<h3 id="_learning_about_lift">Learning about Lift</h3>
<div class="paragraph"><p>If you are looking to learn Lift, take a look at:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://simply.liftweb.net/">Simply Lift</a>.
</p>
</li>
<li>
<p>
<a href="http://www.manning.com/perrett/">Lift in Action</a>, Manning Publications.
</p>
</li>
<li>
<p>
<a href="http://exploring.liftweb.net/">Exploring Lift</a> (also known as <strong>The
Definitive Guide to Lift</strong>).
</p>
</li>
<li>
<p>
<a href="http://liftweb.net/getting_started">Getting Started</a> and
<a href="http://www.assembla.com/spaces/liftweb/wiki/Resources">Resources</a> on the
Lift web site.
</p>
</li>
<li>
<p>
<a href="http://seventhings.liftweb.net/">Seven things</a> that distinguish Lift
from other web frameworks.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_copyright">Copyright</h3>
<div class="paragraph"><p>This document is licensed Creative Commons Attribution, Non Commercial,
No Derivatives.</p></div>
</div>
<div class="sect2">
<h3 id="_contributors">Contributors</h3>
<div class="ulist"><ul>
<li>
<p>
Richard Dallaway
</p>
</li>
<li>
<p>
Jono Ferguson
</p>
</li>
<li>
<p>
Franz Bettag
</p>
</li>
<li>
<p>
Marek Å»ebrowski
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_source">Source</h3>
<div class="paragraph"><p>The source is at
<a href="https://github.com/d6y/lift-cookbook">https://github.com/d6y/lift-cookbook</a></p></div>
</div>
<div class="sect2">
<h3 id="_updates">Updates</h3>
<div class="paragraph"><p>Follow <a href="https://twitter.com/#!/liftcookbook">@LiftCookbook</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_software_versions">Software versions</h3>
<div class="paragraph"><p>Except where otherwise indicated, the examples use Lift 2.5 with SBT
0.12 and Scala 2.9</p></div>
</div>
<div class="sect2">
<h3 id="_conventions">Conventions</h3>
<div class="ulist"><ul>
<li>
<p>
<strong>Emphasised text</strong> is used for filenames, commands, introducing new
concepts.
</p>
</li>
<li>
<p>
<span class="monospaced">Constant width</span> for code and commands.
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_and_running">Install and Running</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter covers questions regarding starting development with Lift: running a first Lift application and setting up a coding environment. You&#8217;ll find answers regarding production deployment in <a href="#deployment">[deployment]</a>.</p></div>
<div class="sect2">
<h3 id="_downloading_and_running_lift">Downloading and Running Lift</h3>
<div class="sect3">
<h4 id="_problem">Problem</h4>
<div class="paragraph"><p>You want to install and run Lift on your computer.</p></div>
</div>
<div class="sect3">
<h4 id="_solution">Solution</h4>
<div class="paragraph"><p>The only prerequisite for installing and running Lift is to have Java
1.5 or later installed. Instructions for installing Java can be found at
<a href="http://java.com/">http://java.com/</a>.</p></div>
<div class="paragraph"><p>You can find out if you have Java from the shell or command prompt by asking for the version you have installed:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ java -version
java version "1.7.0_07"
Java(TM) SE Runtime Environment (build 1.7.0_07-b10)
Java HotSpot(TM) 64-Bit Server VM (build 23.3-b01, mixed mode)</pre>
</div></div>
<div class="paragraph"><p>Once you have Java, the following instructions will download, build and
start a basic Lift application.</p></div>
<div class="sect4">
<h5 id="_for_mac_and_linux">For Mac and Linux</h5>
<div class="ulist"><ul>
<li>
<p>
Visit <a href="http://liftweb.net/download">http://liftweb.net/download</a> and download the Lift 2.5-M3 ZIP file.
</p>
</li>
<li>
<p>
Unzip the file.
</p>
</li>
<li>
<p>
Start <em>Terminal</em> or your favourite shell tool.
</p>
</li>
<li>
<p>
Navigate into the unzipped folder and into the <span class="monospaced">scala_29</span> sub-folder and then into the <span class="monospaced">lift_basic</span> folder.
</p>
</li>
<li>
<p>
Run:<span class="monospaced">./sbt</span>.
</p>
</li>
<li>
<p>
Required libraries will be downloaded automatically.
</p>
</li>
<li>
<p>
At the SBT prompt (&gt;) type: <span class="monospaced">container:start</span>.
</p>
</li>
<li>
<p>
Open your browser and go to <span class="monospaced">http://127.0.0.1:8080/</span>.
</p>
</li>
<li>
<p>
When you&#8217;re done, type <span class="monospaced">exit</span> at the SBT prompt to stop your application from running.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_for_windows">For Windows</h5>
<div class="ulist"><ul>
<li>
<p>
Visit <a href="http://liftweb.net/download">http://liftweb.net/download</a> locate the link to the ZIP version of Lift 2.5-M3 and save this to disk.
</p>
</li>
<li>
<p>
Extract the contents of the ZIP file.
</p>
</li>
<li>
<p>
Navigate in <em>Explorer</em> to the extracted folder, and inside navigate into <span class="monospaced">scala_29</span> and then <span class="monospaced">lift_basic</span>.
</p>
</li>
<li>
<p>
Double click <span class="monospaced">sbt.bat</span> to run the build tool and a terminal window should open.
</p>
</li>
<li>
<p>
Required libraries will be downloaded automatically.
</p>
</li>
<li>
<p>
At the SBT prompt (&gt;) type: <span class="monospaced">container:start</span>.
</p>
</li>
<li>
<p>
You may find Windows Firewall blocking Java from running. If so, opt to "allow access".
</p>
</li>
<li>
<p>
Start your browser and go to <span class="monospaced">http://127.0.0.1:8080/</span>
</p>
</li>
<li>
<p>
When you&#8217;re done, type <span class="monospaced">exit</span> at the SBT prompt to stop your application from running.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_expected_result">Expected result</h5>
<div class="paragraph"><p>The result of the above commands should be a basic Lift application running on
your computer as shown in <a href="#LiftBasicScreenshot">[LiftBasicScreenshot]</a>.</p></div>
<div class="imageblock" id="LiftBasicScreenshot">
<div class="content">
<img src="images/apphome.png" alt="images/apphome.png" width="640">
</div>
<div class="title">Figure 1. The basic Lift application home page.</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion">Discussion</h4>
<div class="paragraph"><p>Lift isn&#8217;t installed in the usual sense of "installing software".
Instead you use standard build tools, such as SBT or Maven, to assemble your application with the Lift framework. In this recipe we downloaded a ZIP file containing four fairly minimal Lift applications, and then started one of them via the build tool.</p></div>
<div class="sect4">
<h5 id="_simple_build_tool">Simple Build Tool</h5>
<div class="paragraph"><p>Typing <span class="monospaced">sbt</span> starts the Simple Build Tool, a dependency management
tool used by Scala projects (it&#8217;s not specific to Lift).  SBT will check the project definition and download any libraries required, which includes the Lift framework.</p></div>
<div class="paragraph"><p>This download happens once, and the downloaded
files are stored on disk in <span class="monospaced">.ivy2/</span> under your home folder.</p></div>
<div class="paragraph"><p>Your application build is configured by <span class="monospaced">build.sbt</span>.  Looking inside you&#8217;ll see:</p></div>
<div class="ulist"><ul>
<li>
<p>
basic information about your application, including a name and version;
</p>
</li>
<li>
<p>
resolvers, which inform SBT where to fetch dependencies from;
</p>
</li>
<li>
<p>
settings for plugins and the Scala compiler; and
</p>
</li>
<li>
<p>
a list of dependencies required to run your application, which will include the Lift framework.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="RunningYourApplication">Running Your Application</h5>
<div class="paragraph"><p>The SBT command <span class="monospaced">container:start</span> starts the web server on the default port of 8080 and
passes requests to your Lift application. The word <em>container</em> refers to the
software you deploy your application into. There are a variety of containers (<em>Jetty</em> and
<em>Tomcat</em> are probably the best known) all of which conform to a standard for deployment.
The upshot is you can build your application and deploy to whichever one you prefer.
The <span class="monospaced">container:start</span> command uses Jetty.</p></div>
</div>
<div class="sect4">
<h5 id="_source_code">Source Code</h5>
<div class="paragraph"><p>The source code of the application resides in <span class="monospaced">src/main/webapp</span> and <span class="monospaced">src/main/scala</span>. If you take a look at <span class="monospaced">index.html</span> in the <span class="monospaced">webapp</span> folder you&#8217;ll see mention of <span class="monospaced">lift:helloWorld</span>. That&#8217;s a reference to the class defined in <span class="monospaced">scala/code/snippet/HelloWorld.scala</span>. This is a <em>snippet invocation</em> and an example of Lift&#8217;s <em>view first</em> approach to web applications. That is, there&#8217;s no routing set up for the index page to collect the data and forward it to the view. Instead, the view defines areas of the content that are replaced with functions, such as those functions defined in <span class="monospaced">HelloWorld.scala</span>.</p></div>
<div class="paragraph"><p>Lift knows to look in the <span class="monospaced">code</span> package for snippets because that package is declared as a location for snippets in <span class="monospaced">scala/bootstrap/liftweb/Boot.scala</span>. The Boot class is run when starting your application, and it&#8217;s where you can configure the behaviour of Lift.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also">See Also</h4>
<div class="paragraph"><p>The Simple Build Tool documentation is at <a href="http://www.scala-sbt.org">http://www.scala-sbt.org</a>.</p></div>
<div class="paragraph"><p>Tutorials for Lift can be found in <em>Simply Lift</em> at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a> and in <em>Lift in Action</em> (Tim Perrett, 2011, Manning Publications Co).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="texteditor">Developing Using a Text Editor</h3>
<div class="sect3">
<h4 id="_problem_2">Problem</h4>
<div class="paragraph"><p>You want to develop your Lift application using your favourite text
editor, hitting reload in your browser to see changes.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_2">Solution</h4>
<div class="paragraph"><p>Run SBT while you are editing, and ask it to detect and compile changes to Scala files.  To do that, start <span class="monospaced">sbt</span> and enter the following to the SBT prompt:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>~; container:start; container:reload /</pre>
</div></div>
<div class="paragraph"><p>When you save a source file in your editor, SBT will detect this change,
compile the file, and reload the web container.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_2">Discussion</h4>
<div class="paragraph"><p>An SBT command prefixed with <span class="monospaced">~</span> makes that command run when files
change. The first semicolon introduces a sequence of commands, where if
the first command succeeds, the second will run. The second semicolon
means the <span class="monospaced">reload</span> command will run if the <span class="monospaced">start</span> command ran OK. The <span class="monospaced">start</span>
command will recompile any Scala source files that have changed.</p></div>
<div class="paragraph"><p>When you run SBT in this way, you&#8217;ll notice the following output:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>1. Waiting for source changes... (press enter to interrupt)</pre>
</div></div>
<div class="paragraph"><p>And indeed, if you do press enter in the SBT window you&#8217;ll exit this <em>triggered
execution</em> mode and SBT will no longer be looking for file changes. However, while
SBT is watching for changes, the output will indicate when this happens with something
that looks a little like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[info] Compiling 1 Scala source to target/scala-2.9.1/classes...
[success] Total time: 1 s, completed 15-Nov-2012 18:14:46
[pool-301-thread-4] DEBUG net.liftweb.http.LiftServlet - Destroyed Lift handler.
[info] stopped o.e.j.w.WebAppContext{/,[src/main/webapp/]}
[info] NO JSP Support for /, did not find org.apache.jasper.servlet.JspServlet
[info] started o.e.j.w.WebAppContext{/,[src/main/webapp/]}
[success] Total time: 0 s, completed 15-Nov-2012 18:14:46
2. Waiting for source changes... (press enter to interrupt)</pre>
</div></div>
<div class="paragraph"><p>Edits to HTML files don&#8217;t trigger the SBT compile and reload commands.
This is because SBT&#8217;s default behaviour is to look for
Scala and Java source file changes, and also changes to files in <span class="monospaced">src/main/resources/</span>.
This works out just fine, because Jetty will use your modified HTML file when you
reload the browser page.</p></div>
<div class="paragraph"><p>Restarting the web container each time you edit a Scala file isn&#8217;t ideal. You can reduce
the need for restarts by integrating JRebel into your development environment, as described
in <a href="#jrebel">[jrebel]</a>.</p></div>
<div class="paragraph"><p>However, if you are making a serious number of edits, you may prefer to issue a <span class="monospaced">container:stop</span> command until you&#8217;re ready to run you application again with <span class="monospaced">container:start</span>. This will prevent SBT compiling and restarting your application over and over. The SBT console has a command history, and using the up and down keyboard arrows allows you to navigate to previous commands and run them by pressing the return key.  That takes some of the tedium out of these long commands.</p></div>
<div class="paragraph"><p>One error you may run into is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>java.lang.OutOfMemoryError: PermGen space</pre>
</div></div>
<div class="paragraph"><p>The <em>permanent generation</em> is a Java virtual machine concept. It&#8217;s the area of memory used for storing classes (amongst other things).  It&#8217;s a fixed size and once it is full this PermGen error appears.  As you might imagine, continually restarting a container causes many classes to be loaded and unloaded, but the process is not perfect, effectively leaking memory. The best you can do is stop and then restart SBT.  If you&#8217;re seeing this error often, check the setting for <span class="monospaced">-XX:MaxPermSize</span> inside the <span class="monospaced">sbt</span> (or <span class="monospaced">sbt.bat</span>) script, and if you can, double it.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_2">See Also</h4>
<div class="paragraph"><p>There&#8217;s more about triggered execution at <a href="http://www.scala-sbt.org/release/docs/Detailed-Topics/Triggered-Execution">http://www.scala-sbt.org/release/docs/Detailed-Topics/Triggered-Execution</a>.</p></div>
<div class="paragraph"><p>Reference for the core SBT command line: <a href="http://www.scala-sbt.org/release/docs/Detailed-Topics/Command-Line-Reference">http://www.scala-sbt.org/release/docs/Detailed-Topics/Command-Line-Reference</a>.</p></div>
<div class="paragraph"><p>Command reference for the web plugin for SBT is at: <a href="https://github.com/siasia/xsbt-web-plugin/wiki">https://github.com/siasia/xsbt-web-plugin/wiki</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="jrebel">Incorporating JRebel</h3>
<div class="sect3">
<h4 id="_problem_3">Problem</h4>
<div class="paragraph"><p>You want to avoid application restarts when you change a Scala source file by using JRebel.</p></div>
</div>
<div class="sect3">
<h4 id="_solutions">Solutions</h4>
<div class="paragraph"><p>There are three steps required: install JRebel once; each year request the free Scala license; and configure SBT to use JRebel.</p></div>
<div class="paragraph"><p>First, visit the <a href="http://zeroturnaround.com/software/jrebel/">http://zeroturnaround.com/software/jrebel/</a> and request the free Scala license.</p></div>
<div class="paragraph"><p>Second, download the "Generic ZIP Archive" version of JRebel, unzip it to where you like. For this recipe I&#8217;ve chosen to use <span class="monospaced">/opt/zt/jrebel/</span>.</p></div>
<div class="paragraph"><p>When your have received your account confirmation email from JRebel, you can copy your "authentication token" from the "Active" area of ZeroTurnaround&#8217;s site. To apply the token to your local install, run the JRebel configuration script:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ /opt/zt/jrebel/bin/jrebel-config.sh</pre>
</div></div>
<div class="paragraph"><p>For Windows navigate to and launch <span class="monospaced">bin\jrebel-config.cmd</span>.</p></div>
<div class="paragraph"><p>In the "Activation" setting select "I want to use myJRebel" and then in the "License" section paste in your activation token. Click the "Activate" button, and once you see the license status change to "You have a valid myJRebel token" click "Finish".</p></div>
<div class="paragraph"><p>Finally, configure SBT by modifying the <span class="monospaced">sbt</span> script to enable JRebel.  This means setting the <span class="monospaced">-javaagent</span> and <span class="monospaced">-noverify</span> flags for Java, and enabling the JRebel Lift plugin.</p></div>
<div class="paragraph"><p>For Mac and Linux, the script that&#8217;s included with the Lift downloads would become:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>java -Drebel.lift_plugin=true -noverify -javaagent:/opt/zt/jrebel/jrebel.jar \
 -Xmx1024M -Xss2M -XX:MaxPermSize=512m -XX:+CMSClassUnloadingEnabled -jar \
 `dirname $0`/sbt-launch-0.12.jar "$@"</pre>
</div></div>
<div class="paragraph"><p>For Windows, modify <span class="monospaced">sbt.bat</span> to be:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>set SCRIPT_DIR=%~dp0
java -Drebel.lift_plugin=true -noverify -javaagent:c:/opt/zt/jrebel/jrebel.jar \
 -XX:+CMSClassUnloadingEnabled -XX:MaxPermSize=256m -Xmx1024M -Xss2M \
 -jar "%SCRIPT_DIR%\sbt-launch-0.12.jar" %*</pre>
</div></div>
<div class="paragraph"><p>There&#8217;s nothing else to do to use JRebel.  When you start SBT you&#8217;ll see a large banner starting something like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>#############################################################

  JRebel 5.1.1 (201211271929)
  (c) Copyright ZeroTurnaround OU, Estonia, Tartu.

  Over the last 30 days JRebel prevented
  at least 335 redeploys/restarts saving you about 13.6 hours.
....</pre>
</div></div>
<div class="paragraph"><p>With JRebel installed, you can now <span class="monospaced">container:start</span> your application, modify and compile a Scala file and reload a page in your application. You&#8217;ll see a notice that the class has been reloaded:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[2012-12-16 23:15:44] JRebel: Reloading class 'code.snippet.HelloWorld'.</pre>
</div></div>
<div class="paragraph"><p>That change is live, without having to restart the container.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_3">Discussion</h4>
<div class="paragraph"><p>JRebel is very likely to speed up your development. It updates code in a running Java virtual machine, without having to stop and restart it.  The effect is that, on the whole, you can compile a class, then hit reload in your browser to see the change in your Lift application.</p></div>
<div class="paragraph"><p>Even with JRebel you will need to restart your applications from time to time, but JRebel usually reduces the number of restarts. For example, <span class="monospaced">Boot.scala</span> is run when your application starts, so if you modify something in your <span class="monospaced">Boot.scala</span> you&#8217;ll need to start and start your application. JRebel can&#8217;t help with that.</p></div>
<div class="paragraph"><p>But there are also other situations that JRebel cannot help with, such as when a superclass changes. Generally, JRebel will emit a warning about this in the console window.  If that happens, stop and start your application.</p></div>
<div class="paragraph"><p>The <span class="monospaced">-Drebel.lift_plugin=true</span> setting adds Lift-specific functionality to JRebel.  Specifically, it allows JRebel to reload changes to <span class="monospaced">LiftScreen</span>, <span class="monospaced">Wizard</span> and <span class="monospaced">RestHelper</span>. This means you can change fields or screens, and change REST <span class="monospaced">serve</span> code.</p></div>
<div class="sect4">
<h5 id="_purchased_licenses">Purchased licenses</h5>
<div class="paragraph"><p>This recipe uses a free Scala license for a service called myJRebel. This communicates with JRebel servers via the activation code.  If you have purchased a license from ZeroTurnaround, the situation is slightly different.  In this case, you will have a license key which you store in a file called <span class="monospaced">jrebel.lic</span>. You can place the file in a <span class="monospaced">.jrebel</span> folder in your home directory, or alongside <span class="monospaced">jrebel.jar</span> (e.g., in the <span class="monospaced">/opt/zt/jrebel/</span> folder if that&#8217;s where you installed JRebel), or you can specify some other location.  For the latter option, modify the <span class="monospaced">sbt</span> script and specify the location of the file by adding another Java setting:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>-Drebel.license=/path/to/jrebel.lic</pre>
</div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_3">See Also</h4>
<div class="paragraph"><p>You&#8217;ll find details about how JRebel works in the FAQ at: <a href="http://zeroturnaround.com/software/jrebel/resources/faq/">http://zeroturnaround.com/software/jrebel/resources/faq/</a>.</p></div>
<div class="paragraph"><p>The Lift support was announced in a blog post in 2012 at <a href="http://zeroturnaround.com/jrebel/lift-support-in-jrebel/">http://zeroturnaround.com/jrebel/lift-support-in-jrebel/</a>, where you&#8217;ll find more about the capabilities of the plugin.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="eclipse">Developing using Eclipse</h3>
<div class="sect3">
<h4 id="_problem_4">Problem</h4>
<div class="paragraph"><p>You want to develop your Lift application using the Eclipse IDE, hitting
reload in your browser to see changes.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_3">Solution</h4>
<div class="paragraph"><p>Use the "Scala IDE for Eclipse" plugin to Eclipse. The instructions for this
are given at <a href="http://scala-ide.org">http://scala-ide.org</a>. There are a number of options (nightly builds, milestones) but start with the stable version. This will give you an Eclipse perspective that knows about Scala.</p></div>
<div class="paragraph"><p>To create the project files to allow Eclipse to load your Lift project, install "sbteclipse" by adding the following to <span class="monospaced">projects/plugins.sbt</span> in your Lift project:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">addSbtPlugin</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"com.typesafe.sbteclipse"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"sbteclipse-plugin"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"2.1.0"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>You can then create Eclipse project files (<span class="monospaced">.project</span> and <span class="monospaced">.classpath</span>) by entering the
following to the SBT prompt:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>eclipse</pre>
</div></div>
<div class="paragraph"><p>Open the project in Eclipse by navigating to "File &gt; Import.." and select "General &gt; Existing
Projects into Workspace". Browse to and select your Lift project. You
are now set up to develop your application in Eclipse.</p></div>
<div class="paragraph"><p>To see live changes as you edit and save your work, run SBT in a separate terminal window.  That is, start <span class="monospaced">sbt</span> from a terminal window outside of Eclipse and enter the following:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>~; container:start; container:reload /</pre>
</div></div>
<div class="paragraph"><p>This behaviour of this command is described in <a href="#texteditor">[texteditor]</a>, but if you&#8217;re using JRebel (see <a href="#jrebel">[jrebel]</a>) then you just need to run <span class="monospaced">container:start</span> by itself.</p></div>
<div class="paragraph"><p>You can then edit in Eclipse, save to compile, and in your web browser hit reload to see
the changes.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_4">Discussion</h4>
<div class="paragraph"><p>One of the great benefits of an IDE is the ability to navigate source, by cmd+click (Mac) or F3 (PC).
You can ask the SBT <span class="monospaced">eclipse</span> command to download the Lift
source and Scaladoc, allowing you to click through to the Lift source from
methods and classes, which is a useful way to discover more about Lift.</p></div>
<div class="paragraph"><p>To achieve this in a project, run <span class="monospaced">eclipse with-source=true</span> in SBT, but if you want
this to be the default behaviour, add the following to your <span class="monospaced">build.sbt</span> file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>EclipseKeys<span style="color: #990000">.</span>withSource <span style="font-weight: bold"><span style="color: #0000FF">:=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you find yourself using the plugin frequently, you may wish to declare it
in your global SBT configuration files so it appies to all projects.  To do that,
create a <span class="monospaced">~/.sbt/plugins/plugins.sbt</span> file containing:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>resolvers <span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Classpaths<span style="color: #990000">.</span>typesafeResolver

<span style="font-weight: bold"><span style="color: #000000">addSbtPlugin</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"com.typesafe.sbteclipse"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"sbteclipse-plugin"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"2.1.0"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Note the blank line between the <span class="monospaced">resolvers</span> and the <span class="monospaced">addSbtPlugin</span>.  In <span class="monospaced">.sbt</span> files, a blank line is required between statements.</p></div>
<div class="paragraph"><p>Finally, set any global configurations (such as <span class="monospaced">withSource</span>) in <span class="monospaced">~/.sbt/global.sbt</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_4">See Also</h4>
<div class="paragraph"><p>There are other useful settings for sbteclipse, described at <a href="https://github.com/typesafehub/sbteclipse/wiki">https://github.com/typesafehub/sbteclipse/wiki</a>.</p></div>
<div class="paragraph"><p>The SBT <span class="monospaced">~/.sbt/</span> structure is described in the guide to using plugins at <a href="http://www.scala-sbt.org/release/docs/Getting-Started/Using-Plugins">http://www.scala-sbt.org/release/docs/Getting-Started/Using-Plugins</a> and in the wiki page for global configuration at <a href="http://www.scala-sbt.org/release/docs/Detailed-Topics/Global-Settings">http://www.scala-sbt.org/release/docs/Detailed-Topics/Global-Settings</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="idea">Developing using Intellij IDEA</h3>
<div class="sect3">
<h4 id="_problem_5">Problem</h4>
<div class="paragraph"><p>You want to use the Intellij IDEA development environment when writing your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_4">Solution</h4>
<div class="paragraph"><p>You need the Scala plugin for IntelliJ, and an SBT plugin to generate the IDEA project files.</p></div>
<div class="paragraph"><p>The IntelliJ plugin you&#8217;ll need to install once, and these instructions are for IntelliJ IDEA 12.  The details may vary between releases of the IDE, but the basic idea is to find the JetBrains Scala plugin, and download and install it.</p></div>
<div class="paragraph"><p>From the "Welcome to Intellij IDEA" screen, select "Configure" and then "Plugins". Select "Browse repositories&#8230;". In the search box, top right, type "Scala".  You&#8217;ll find on the left a number of matches: select "Scala".  On the right, you&#8217;ll see confirmation that this is the "Plugin for Scala language support" and the vendor is JetBrains Inc. Select the "Download and Install" icon from the top of the window (or right click to download and install). "Close" the dialog, and OK out of the Plugins window. You&#8217;ll be promoted to restart IntelliJ IDEA.</p></div>
<div class="paragraph"><p>With the IDE configured, you now need to add the SBT plugin inside your Lift project by adding the following to the file <span class="monospaced">projects/plugins.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">addSbtPlugin</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"com.github.mpeltonen"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"sbt-idea"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"1.2.0"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Start SBT and at the SBT prompt create the IDEA project files by typing:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gen-idea</pre>
</div></div>
<div class="paragraph"><p>This will generate the <span class="monospaced">.idea</span> and <span class="monospaced">.iml</span> files you need so you can do "File" and "Open&#8230;" in IntelliJ and navigate to your project.</p></div>
<div class="paragraph"><p>To see live changes as you edit and save your work, run SBT in a separate terminal window.  That is, start <span class="monospaced">sbt</span> from a terminal window outside of IntelliJ and enter the following:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>~; container:start; container:reload /</pre>
</div></div>
<div class="paragraph"><p>This behaviour of this command is described in <a href="#texteditor">[texteditor]</a>, but if you&#8217;re using JRebel (see <a href="#jrebel">[jrebel]</a>) then you just need to run <span class="monospaced">container:start</span> by itself.</p></div>
<div class="paragraph"><p>Each time you compile or make the project, the container will pick up the changes, and you can see them by re-loading your browser window.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_5">Discussion</h4>
<div class="paragraph"><p>By default the <span class="monospaced">gen-idea</span> command will fetch source for dependent libraries. That means out-of-the-box you can click though to Lift source code to explore it and learn more about the framework.</p></div>
<div class="paragraph"><p>Setting up the SBT IDEA plugin globally, for all SBT projects, is the same pattern as described for Eclipse in <a href="#eclipse">[eclipse]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_5">See Also</h4>
<div class="paragraph"><p>The sbt-idea plugin at <a href="https://github.com/mpeltonen/sbt-idea">https://github.com/mpeltonen/sbt-idea</a> doesn&#8217;t have a configuration guide yet. One way to discover the features is to browse the release notes in the <span class="monospaced">notes</span> folder of that project.</p></div>
<div class="paragraph"><p>JetBrains have a blog for the Scala plugin with feature news and tips: <a href="http://blog.jetbrains.com/scala/">http://blog.jetbrains.com/scala/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_viewing_the_lift_proto_h2_database">Viewing the lift_proto H2 Database</h3>
<div class="sect3">
<h4 id="_problem_6">Problem</h4>
<div class="paragraph"><p>You&#8217;re developing using the default <span class="monospaced">lift_proto.db</span> H2 database, and
you would like use a tool to look at the tables.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_5">Solution</h4>
<div class="paragraph"><p>Use the web interface included as part of H2. Here are the steps:</p></div>
<div class="ulist"><ul>
<li>
<p>
Locate the H2 JAR file. For me, this was: <span class="monospaced">~/.ivy2/cache/com.h2database/h2/jars/h2-1.2.147.jar</span>.
</p>
</li>
<li>
<p>
Start the server from a terminal window using the JAR file you found: <span class="monospaced">java -cp /path/to/h2-version.jar org.h2.tools.Server</span>
</p>
</li>
<li>
<p>
This should launch your web browser, asking you to login.
</p>
</li>
<li>
<p>
Select "Generic H2 Server" in "Saved Settings".
</p>
</li>
<li>
<p>
Enter <span class="monospaced">jdbc:h2:/path/to/youapp/lift_proto.db;AUTO_SERVER=TRUE</span> for "JDBC URL", adjusting the path for the location of your database, and adjusting the name of the database ("lift_proto.db") if different in your <span class="monospaced">Boot.scala</span>.
</p>
</li>
<li>
<p>
Press "Connect" to view and edit your database.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_discussion_6">Discussion</h4>
<div class="paragraph"><p>The default Lift projects that include a database, such as <span class="monospaced">lift_basic</span>, use the H2 relational database as it can be included as an SBT dependency and requires no external installation or configuration. It&#8217;s a fine product, although production deployments typically use standalone databases, such as PostgreSQL or MySQL.</p></div>
<div class="paragraph"><p>Even if you&#8217;re deploying to a non-H2 database it may be useful to keep H2 around because it has an in-memory mode, which is great for unit tests. This means you can create a database in-memory, no files on disk, and throw it away when your unit tests ends.</p></div>
<div class="paragraph"><p>If you don&#8217;t like the web interface, the connection settings described in this recipe should give you the information you need to configure other SQL tools.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_6">See Also</h4>
<div class="paragraph"><p>The properties of H2 are described at  <a href="http://www.h2database.com">http://www.h2database.com</a>.</p></div>
<div class="paragraph"><p>If you&#8217;re using the console frequently, consider mapping it accessible from your Lift application in development node.  This is described by Diego Medina in a blog post at <a href="https://fmpwizard.telegr.am/blog/lift-and-h2">https://fmpwizard.telegr.am/blog/lift-and-h2</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="snapshot">Using the Latest Lift build</h3>
<div class="sect3">
<h4 id="_problem_7">Problem</h4>
<div class="paragraph"><p>You want to use the latest ("snapshot") build of Lift.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_6">Solution</h4>
<div class="paragraph"><p>You need to make two changes to your <span class="monospaced">build.sbt</span> file. First, reference
the snapshot repository:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>resolvers <span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"snapshots"</span> at <span style="color: #FF0000">"http://oss.sonatype.org/content/repositories/snapshots"</span></tt></pre></div></div>
<div class="paragraph"><p>Second, change the <span class="monospaced">liftVersion</span> in your build to be the latest version. For this example, let&#8217;s use the 2.5-SNAPSHOT version of Lift:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> liftVersion <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"2.5-SNAPSHOT"</span></tt></pre></div></div>
<div class="paragraph"><p>Restarting SBT (or issuing a <span class="monospaced">reload</span> command) will trigger a download
of the latest build.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_7">Discussion</h4>
<div class="paragraph"><p>Production releases of Lift (e.g., "2.4", "2.5"), as well as milestone releases
(e.g., "2.5-M3") and release candidates (e.g., "2.5-RC1") are published
into a releases repository. When SBT downloads them, they are downloaded
once.</p></div>
<div class="paragraph"><p>Snapshot releases are different: they are the result of an automated
build, and change often. You can force SBT to resolve the latest
versions by running the command <span class="monospaced">clean</span> and then <span class="monospaced">update</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_7">See Also</h4>
<div class="paragraph"><p>To learn the detail of SNAPSHOT versions, dig into the Maven Complete Reference at <a href="http://www.sonatype.com/books/mvnref-book/reference/pom-relationships-sect-pom-syntax.html">http://www.sonatype.com/books/mvnref-book/reference/pom-relationships-sect-pom-syntax.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_new_version_of_scala">Using a New Version of Scala</h3>
<div class="sect3">
<h4 id="_problem_8">Problem</h4>
<div class="paragraph"><p>A new Scala version has just been released and you want to immediately
use it in your Lift project.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_7">Solution</h4>
<div class="paragraph"><p>You may find that the latest snapshot of Lift is built using the latest
Scala version. Failing that, and assuming you cannot wait for a build, you may still be in luck.
Providing that the Scala version is <em>binary compatible</em> with the latest
version used by Lift, you can change your build file to force the Scala
version.</p></div>
<div class="paragraph"><p>For example, assuming your <span class="monospaced">build.sbt</span> file is set up to use Lift 2.5
with Scala 2.9.1:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>scalaVersion <span style="font-weight: bold"><span style="color: #0000FF">:=</span></span> <span style="color: #FF0000">"2.9.1"</span>

libraryDependencies <span style="color: #990000">++</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> liftVersion <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"2.5"</span>
  <span style="font-weight: bold"><span style="color: #000000">Seq</span></span><span style="color: #990000">(</span>
    <span style="color: #FF0000">"net.liftweb"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"lift-webkit"</span> <span style="color: #990000">%</span> liftVersion <span style="color: #990000">%</span> <span style="color: #FF0000">"compile-&gt;default"</span>
  <span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s assume that you now want to use Scala 2.9.2 but (pretend) Lift 2.5 was only
built against Scala 2.9.1. Replace <span class="monospaced">%%</span> with <span class="monospaced">%</span> for the <span class="monospaced">net.liftweb</span>
resources and explicitly include the Scala version that Lift was built
against for each Lift component:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>scalaVersion <span style="font-weight: bold"><span style="color: #0000FF">:=</span></span> <span style="color: #FF0000">"2.9.2"</span>

libraryDependencies <span style="color: #990000">++</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> liftVersion <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"2.5"</span>
  <span style="font-weight: bold"><span style="color: #000000">Seq</span></span><span style="color: #990000">(</span>
    <span style="color: #FF0000">"net.liftweb"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"lift-webkit_2.9.1"</span> <span style="color: #990000">%</span> liftVersion <span style="color: #990000">%</span> <span style="color: #FF0000">"compile-&gt;default"</span>
  <span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>What we&#8217;ve done here is change the <span class="monospaced">scalaVersion</span> to the new version we want
to use, but explicitly specified we want the 2.9.1 Scala version for Lift.
This works if the two different Scala versions are binary compatible.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_8">Discussion</h4>
<div class="paragraph"><p>Dependencies have a particular naming convention.  For example, the <span class="monospaced">lift-webkit</span> library for Lift 2.5-M3 is called <span class="monospaced">lift-webkit_2.9.1-2.5-M3.jar</span>.  Normally in <span class="monospaced">build.sbt</span> we simply refer to <span class="monospaced">"net.liftweb" %% "lift-webkit"</span> and SBT turns that into the name of a file that can be downloaded.</p></div>
<div class="paragraph"><p>However, in this recipe we have forced SBT to explicitly fetch the 2.9.1 version
of the Lift resources rather than allow it to compute the URL to the
Lift components.  This is the difference between using <span class="monospaced">%%</span> and <span class="monospaced">%</span> in a
dependency: with <span class="monospaced">%%</span> you do not specify the Scala version as SBT will append
the <span class="monospaced">scalaVersion</span> number automatically; with <em>%</em> this automatic change is not made,
so we have to manually specify more details for the name of the library.</p></div>
<div class="paragraph"><p>Please note this only works for minor releases of Scala: major releases
break compatibility.  For example Scala 2.9.1 is compatible with Scala 2.9.0, but not 2.10.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_8">See Also</h4>
<div class="paragraph"><p>Binary compatibly in Scala is discussed on the Scala user mailing list at
<a href="http://article.gmane.org/gmane.comp.lang.scala.user/39290">http://article.gmane.org/gmane.comp.lang.scala.user/39290</a>.</p></div>
<div class="paragraph"><p>The SBT behaviour is described at: <a href="http://www.scala-sbt.org/release/docs/Getting-Started/Library-Dependencies">http://www.scala-sbt.org/release/docs/Getting-Started/Library-Dependencies</a>.</p></div>
<div class="paragraph"><p><a href="#snapshot">[snapshot]</a> describes how to use a snapshot version of Lift.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_html">HTML</h2>
<div class="sectionbody">
<div class="paragraph"><p>Generating HTML is often a major component of web applications.  This chapter is concerned with Lift&#8217;s <em>View First</em> approach and use of <em>CSS Selectors</em>.  Later chapters focus on Form processing, REST web services, and JavaScript (Ajax and Comet).</p></div>
<div class="sect2">
<h3 id="_testing_and_debugging_css_selectors">Testing and Debugging CSS Selectors</h3>
<div class="sect3">
<h4 id="_problem_9">Problem</h4>
<div class="paragraph"><p>You want to explore or debug CSS selectors interactively.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_8">Solution</h4>
<div class="paragraph"><p>Use the Scala REPL to run your CSS selector. From withing SBT use the <span class="monospaced">console</span> command to get into the REPL. Here&#8217;s an example were we test out a CSS selector which applies a href to a link:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;</span> console
<span style="color: #990000">[</span>info<span style="color: #990000">]</span> Starting scala interpreter<span style="color: #990000">...</span>
<span style="color: #990000">[</span>info<span style="color: #990000">]</span>
Welcome to Scala version <span style="color: #993399">2.9</span><span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">final</span></span>
Type in expressions to have them evaluated<span style="color: #990000">.</span>
Type <span style="font-weight: bold"><span style="color: #0000FF">:</span></span>help <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> more information<span style="color: #990000">.</span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Helpers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Helpers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> in <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #990000">&lt;</span>a<span style="color: #990000">&gt;</span>click me<span style="color: #990000">&lt;/</span>a<span style="color: #990000">&gt;</span>
in<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>Elem <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #990000">&lt;</span>a<span style="color: #990000">&gt;</span>click me<span style="color: #990000">&lt;/</span>a<span style="color: #990000">&gt;</span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> f <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"a [href]"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">"http://example.org"</span>
f<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>CssSel <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">Full</span></span><span style="color: #990000">(</span>a <span style="color: #990000">[</span>href<span style="color: #990000">]),</span> <span style="font-weight: bold"><span style="color: #000000">Full(ElemSelector(a,Full(AttrSubNode</span></span><span style="color: #990000">(</span>href<span style="color: #990000">)))))</span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">f</span></span><span style="color: #990000">(</span>in<span style="color: #990000">)</span>
res0<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>NodeSeq <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="font-weight: bold"><span style="color: #000000">NodeSeq</span></span><span style="color: #990000">(&lt;</span>a href<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"http://example.org"</span><span style="color: #990000">&gt;</span>click me<span style="color: #990000">&lt;/</span>a<span style="color: #990000">&gt;)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_9">Discussion</h4>
<div class="paragraph"><p>CSS selector transforms are one of the distinguishing features of Lift. They succinctly describe a node in your template (left-hand side) and give a replacement (right-hand side). They do take a little while to get use to, so being able to test them at the Scala REPL is useful.</p></div>
<div class="paragraph"><p>It may help to know that prior to CSS selectors Lift snippets were typically defined in terms
of a function that took a <span class="monospaced">NodeSeq</span> and returned a <span class="monospaced">NodeSeq</span>, often via the <span class="monospaced">bind</span> method.  When Lift processes such a template it knows what the input <span class="monospaced">NodeSeq</span> is, so it&#8217;s natural to supply a function that returns a <span class="monospaced">NodeSeq</span>.  You won&#8217;t see that usage so often any more, but the principle is the same.</p></div>
<div class="paragraph"><p>The CSS selector functionality in Lift gives you a <span class="monospaced">CssSel</span> function
which is <span class="monospaced">NodeSeq =&gt; NodeSeq</span>. We exploit this in the above example by constructing an input
<span class="monospaced">NodeSeq</span> (called <span class="monospaced">in</span>), then creating a CSS function (called <span class="monospaced">f</span>).  Because we know that <span class="monospaced">CssSel</span>
is defined as a <span class="monospaced">NodeSeq =&gt; NodeSeq</span> the natural way to execute the selector is to supply
the <span class="monospaced">in</span> as a parameter, and this gives us the answer, <span class="monospaced">res0</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_9">See Also</h4>
<div class="paragraph"><p>The syntax for selectors is best described in <em>Simply Lift</em> at <a href="http://simply.liftweb.net/index-7.10.html#toc-Section-7.10">http://simply.liftweb.net/index-7.10.html#toc-Section-7.10</a>.</p></div>
<div class="paragraph"><p>Section 6.1.2 of <em>Lift in Action</em> also describes selectors and gives examples.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_sequencing_css_selector_operations">Sequencing CSS Selector Operations</h3>
<div class="sect3">
<h4 id="_problem_10">Problem</h4>
<div class="paragraph"><p>You want your CSS selector binding to apply to the results of earlier
binding expressions.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_9">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">andThen</span> rather than <span class="monospaced">&amp;</span> to compose your selector expressions.</p></div>
<div class="paragraph"><p>For example, suppose we want to replace <span class="monospaced">&lt;div id="foo"/&gt;</span> with
<span class="monospaced">&lt;div id="bar"&gt;bar content&lt;/div&gt;</span> but for some reason we needed to
generate the <span class="monospaced">bar</span> div as a separate step in the selector expression:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>sbt<span style="color: #990000">&gt;</span> console
<span style="color: #990000">[</span>info<span style="color: #990000">]</span> Starting scala interpreter<span style="color: #990000">...</span>
<span style="color: #990000">[</span>info<span style="color: #990000">]</span>
Welcome to Scala version <span style="color: #993399">2.9</span><span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #990000">(</span>Java <span style="color: #993399">1.7</span><span style="color: #990000">.</span>0<span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #993399">05</span><span style="color: #990000">).</span>
Type in expressions to have them evaluated<span style="color: #990000">.</span>
Type <span style="font-weight: bold"><span style="color: #0000FF">:</span></span>help <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> more information<span style="color: #990000">.</span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Helpers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Helpers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> render <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"#foo"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #990000">&lt;</span>div id<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"bar"</span><span style="color: #990000">/&gt;</span> andThen <span style="color: #FF0000">"#bar *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">"bar content"</span>
render<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>NodeSeq <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>NodeSeq

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">(&lt;</span>div id<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"foo"</span><span style="color: #990000">/&gt;)</span>
res0<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>NodeSeq <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">NodeSeq</span></span><span style="color: #990000">(&lt;</span>div id<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"bar"</span><span style="color: #990000">&gt;</span>bar content<span style="color: #990000">&lt;/</span>div<span style="color: #990000">&gt;)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_10">Discussion</h4>
<div class="paragraph"><p>When using <span class="monospaced">&amp;</span> think of the CSS selectors as always applying to the
original template, no matter what other expressions you are combining.
This is because <span class="monospaced">&amp;</span> is aggregating the selectors together before applying them; whereas <span class="monospaced">andThen</span> is
a method of all Scala functions that composes two functions together, with the fist being
called before the second.</p></div>
<div class="paragraph"><p>Compare the example above if we change the <span class="monospaced">andThen</span> with
<span class="monospaced">&amp;</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> render <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"#foo"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #990000">&lt;</span>div id<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"bar"</span> <span style="color: #990000">/&gt;</span> <span style="color: #990000">&amp;</span> <span style="color: #FF0000">"#bar *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">"bar content"</span>
render<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>CssSel

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">(&lt;</span>div id<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"foo"</span><span style="color: #990000">/&gt;)</span>
res1<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>NodeSeq <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">NodeSeq</span></span><span style="color: #990000">(&lt;</span>div id<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"bar"</span><span style="color: #990000">&gt;&lt;/</span>div<span style="color: #990000">&gt;)</span></tt></pre></div></div>
<div class="paragraph"><p>The second expression will not match as it is applied to the original
input of <span class="monospaced">&lt;div id="foo"/&gt;</span>. There&#8217;s no <span class="monospaced">id="bar"</span> in there to match on,
so this means in the second expression adds
nothing to the <span class="monospaced">render</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_10">See Also</h4>
<div class="paragraph"><p>This topic is from the Lift mailing list, and you can see the original context there:
<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/fz3Pmlhzhfg">https://groups.google.com/forum/?fromgroups#!topic/liftweb/fz3Pmlhzhfg</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_meta_tag_contents">Setting Meta Tag Contents</h3>
<div class="sect3">
<h4 id="_problem_11">Problem</h4>
<div class="paragraph"><p>You want to set the content of an HTML meta tag using Lift.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_10">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">@</span> CSS binding name selector. For example, given:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"keywords"</span> <span style="color: #009900">content</span><span style="color: #990000">=</span><span style="color: #FF0000">"words, here, please"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The following snippet code will update the value of the contents
attribute:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"@keywords [content]"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">"words, we, really, want"</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_11">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">@</span> selector selects all elements with the given name. It&#8217;s useful in this case to change <span class="monospaced">&lt;meta name="keyword"&gt;</span> tag, but you may also see it used with elsewhere, for example with HTML forms to select input fields, such as <span class="monospaced">&lt;input name="address"&gt;</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">[content]</span> part is an example of a <em>replacement rule</em> that can follow a selector. That&#8217;s to say, it&#8217;s not specific to the <span class="monospaced">@</span> selector and can be used with other selectors.  In this example it adds or replaces the value of the attribute called "content".</p></div>
<div class="paragraph"><p>There are two other replacement rules useful for manipulating attributes: removing attributes and appending to attributes:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">[content!]</span> to remove an attribute with a matching value, which in our example would be <span class="monospaced">"@keywords [content!]" #&gt; "words, here, please"</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">[content+]</span> to append to the value, such as <span class="monospaced">"@keywords [content+]" #&gt; ", more"</span>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Although not directly relevant to <span class="monospaced">meta</span> tags, you should be aware of there is one convenient special case for appending to an attribute. If the attribute is <span class="monospaced">class</span>, a space is added together with your class value. As a demonstration of that, here&#8217;s an example of appending a class called "funky" to a <span class="monospaced">div</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> render <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"div [class+]"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">"funky"</span>
render<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>CssSel

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">(&lt;</span>div <span style="font-weight: bold"><span style="color: #0000FF">class=</span></span><span style="color: #FF0000">"wrapper"</span><span style="color: #990000">/&gt;)</span>
res0<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>NodeSeq <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">NodeSeq</span></span><span style="color: #990000">(&lt;</span>div <span style="font-weight: bold"><span style="color: #0000FF">class=</span></span><span style="color: #FF0000">"wrapper funky"</span><span style="color: #990000">&gt;&lt;/</span>div<span style="color: #990000">&gt;)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_11">See Also</h4>
<div class="paragraph"><p>The syntax for selectors is best described in <em>Simply Lift</em> at <a href="http://simply.liftweb.net/index-7.10.html">http://simply.liftweb.net/index-7.10.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_the_page_title">Setting the Page Title</h3>
<div class="sect3">
<h4 id="_problem_12">Problem</h4>
<div class="paragraph"><p>You want to set the <span class="monospaced">&lt;title&gt;</span> of the page from a Lift snippet.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_11">Solution</h4>
<div class="paragraph"><p>Select all the elements of the <span class="monospaced">title</span> element and replace them with the
text you want:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"title *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">"I am different"</span></tt></pre></div></div>
<div class="paragraph"><p>Assuming you have a <span class="monospaced">&lt;title&gt;</span> tag in your template, the above will
result in:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>I am different<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_12">Discussion</h4>
<div class="paragraph"><p>It is also possible to set the page title from the contents of <span class="monospaced">SiteMap</span>,
meaning the title used will be the title you&#8217;ve assigned to the page in
the site map:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;title</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:Menu.title"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/title&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">lift:Menu.title</span> code appends to any existing text in the title.
This means the following will have the phrase "Site Title - " in the
title followed by the page title:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;title</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:Menu.title"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Site Title - <span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you need more control, you can of course bind on title using a
regular snippet. This example uses a custom snippet to put the site
title after the page title:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;title</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:MyTitle"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/title&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">object</span></span> MyTitle <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> render <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #990000">&lt;</span>title<span style="color: #990000">&gt;&lt;</span>lift<span style="font-weight: bold"><span style="color: #0000FF">:</span></span>Menu<span style="color: #990000">.</span>title <span style="color: #990000">/&gt;</span> <span style="color: #990000">-</span> Site Title<span style="color: #990000">&lt;/</span>title<span style="color: #990000">&gt;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_12">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<em>Simply Lift</em> chapter 7: <a href="http://simply.liftweb.net/index-7.10.html">http://simply.liftweb.net/index-7.10.html</a>.
</p>
</li>
<li>
<p>
The Wiki page for SiteMap: <a href="http://www.assembla.com/spaces/liftweb/wiki/SiteMap">http://www.assembla.com/spaces/liftweb/wiki/SiteMap</a>.
</p>
</li>
<li>
<p>
The "dynamic titles on sitemap" mailing list discussion offers further options for computing page titles:
<a href="http://groups.google.com/group/liftweb/browse_thread/thread/e19bd2dda2b3159d">http://groups.google.com/group/liftweb/browse_thread/thread/e19bd2dda2b3159d</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_including_html5_shiv">Including HTML5 Shiv</h3>
<div class="sect3">
<h4 id="_problem_13">Problem</h4>
<div class="paragraph"><p>You want to include HTML5 Shiv (a.k.a. HTML5 Shim) so you can use HTML5
elements with legacy IE browsers.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_12">Solution</h4>
<div class="paragraph"><p>Put the markup in a snippet and include the snippet in your page or
template.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> code<span style="color: #990000">.</span>snippet

<span style="font-weight: bold"><span style="color: #000080">import</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>Unparsed

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Html5Shiv <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> render <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Unparsed</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"""&lt;!--[if lt IE 9]&gt;</span>
<span style="color: #FF0000">  &lt;script src="</span>http<span style="font-weight: bold"><span style="color: #0000FF">:</span></span><span style="font-style: italic"><span style="color: #9A1900">//html5shim.googlecode.com/svn/trunk/html5.js"&gt;</span></span>
  <span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;&lt;![</span>endif<span style="color: #990000">]--&gt;</span><span style="color: #FF0000">""")</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Reference the snippet in the <span class="monospaced">&lt;head&gt;</span> of your
<span class="monospaced">templates-hidden/default.html</span>, e.g.,:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:Html5Shiv"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_13">Discussion</h4>
<div class="paragraph"><p>The HTML5 parser used by Lift does not carry comments from the source
through to the rendered page. If you just tried to paste the html5shim markup into
your template you&#8217;d find it missing from the rendered page.</p></div>
<div class="paragraph"><p>We deal with this by generating unparsed markup from a snippet. If you&#8217;re looking at
<span class="monospaced">Unparsed</span> and worried, your instincts are correct.  Normally Lift would cause the
markup to be escaped, but in this case we really do want
unparsed XML content (the comment tag) included in the output.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_13">See Also</h4>
<div class="paragraph"><p>If you&#8217;re doing a lot of IE conditional includes, take a look at the mailing list
suggestion from Antonio Salazar Cardozo for using a IE confitional comment snippet: <a href="https://groups.google.com/d/msg/liftweb/kLzcJwfIqHQ/K91MdtoNz0MJ">https://groups.google.com/d/msg/liftweb/kLzcJwfIqHQ/K91MdtoNz0MJ</a>.</p></div>
<div class="paragraph"><p>The html5shim project can be found at: <a href="http://code.google.com/p/html5shim/">http://code.google.com/p/html5shim/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_returning_snippet_markup_unchanged">Returning Snippet Markup Unchanged</h3>
<div class="sect3">
<h4 id="_problem_14">Problem</h4>
<div class="paragraph"><p>You want a snippet to return the original markup associated with the
snippet invocation.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_13">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">PassThru</span> transform. For
example, suppose you have a snippet which performs a transforms when some
condition is met, but if the condition is not met, you want the snippet
return the original markup.</p></div>
<div class="paragraph"><p>Starting with the original markup&#8230;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"myclass"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>Nothing to worry about<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;we could leave it alone or change it with this snippet:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> render <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>someCondition<span style="color: #990000">)</span>
    <span style="color: #FF0000">".myclass *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>The condition happened<span style="color: #990000">&lt;/</span>p<span style="color: #990000">&gt;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
    PassThru</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_14">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">PassThru</span> is a <span class="monospaced">NodeSeq =&gt; NodeSeq</span> function that returns the input it
is given (an identity function).  It&#8217;s defined as:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>object PassThru extends Function1[NodeSeq, NodeSeq] {
  def apply(in: NodeSeq): NodeSeq = in
}</pre>
</div></div>
<div class="paragraph"><p>The pattern of converting one <span class="monospaced">NodeSeq</span> to another is simple, but also powerful enough to get you out of most situations as you can always arbitrarily re-write the <span class="monospaced">NodeSeq</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_14">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <em>How
to return the original markup associated with snippet invocation?</em> mailing list discussion: <a href="https://groups.google.com/d/msg/liftweb/A69tyIBBSdg/mUGO6_qUFqwJ">https://groups.google.com/d/msg/liftweb/A69tyIBBSdg/mUGO6_qUFqwJ</a>
</p>
</li>
<li>
<p>
Take a look at the source for <span class="monospaced">PassThru</span>, which is at <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/CssSel.scala">https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/CssSel.scala</a>, to see how this and other similar functions are defined.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_snippet_not_found_when_using_html5">Snippet Not Found when using HTML5</h3>
<div class="sect3">
<h4 id="_problem_15">Problem</h4>
<div class="paragraph"><p>You&#8217;re using Lift with the HTML5 parser and one of your snippets,
perhaps <span class="monospaced">&lt;lift:HelloWorld.howdy /&gt;</span>, is rendering with a "Class Not
Found" error.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_14">Solution</h4>
<div class="paragraph"><p>Switch to the designer-friendly snippet invocation mechanism. E.g.,</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:HellowWorld.howdy"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>...<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_15">Discussion</h4>
<div class="paragraph"><p>The HTML5 parser and the traditional Lift XHTML parser have different
behaviours. In particular the HTML5 parser converts elements and attribute names to lower
case when looking up snippets. This means Lift would take <span class="monospaced">&lt;lift:HelloWorld.howdy /&gt;</span> and look for a class called "helloworld" rather than "HelloWorld", which would be the cause of the "Class Not Found Error".</p></div>
<div class="paragraph"><p>Switching to the designer-friendly mechnism is the solution here, and you gain validating HTML as a bonus.</p></div>
<div class="paragraph"><p>In this text we use the HTML5 parser, which is set in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// Use HTML5 for rendering</span></span>
<span style="font-weight: bold"><span style="color: #000000">LiftRules.htmlProperties.default.set(</span></span> <span style="color: #990000">(</span>r<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Req<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Html5Properties</span></span><span style="color: #990000">(</span>r<span style="color: #990000">.</span>userAgent<span style="color: #990000">)</span> <span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_15">See Also</h4>
<div class="paragraph"><p>The key differences between the XHTML and HTML5 parser are outlined on the mailing list at <a href="https://groups.google.com/d/msg/liftweb/H-xe1uRLW1c/B60UH8P54VAJ">https://groups.google.com/d/msg/liftweb/H-xe1uRLW1c/B60UH8P54VAJ</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_avoiding_css_and_javascript_caching">Avoiding CSS and JavaScript Caching</h3>
<div class="sect3">
<h4 id="_problem_16">Problem</h4>
<div class="paragraph"><p>You&#8217;ve modified CSS or JavaScript in your application, but web browsers
have cached your resources and are using the older versions. You&#8217;d like
to avoid this browser caching.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_15">Solution</h4>
<div class="paragraph"><p>Add the <span class="monospaced">lift:with-resource-id</span> class attribute to script or link tags:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:with-resource-id"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"/myscript.js"</span>
 <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The addition of this class will cause Lift to append a "resource id" to
your <span class="monospaced">src</span> (or <span class="monospaced">href</span>), and as this resource id changes each time Lift
starts, it defeats browser caching.</p></div>
<div class="paragraph"><p>The resultant HTML might be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"/myscript.js?F619732897824GUCAAN=_"</span>
  <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_16">Discussion</h4>
<div class="paragraph"><p>The randome value that is appended to the resource is computed when your Lift application boots.  This means it should be stable between releases of your application.</p></div>
<div class="paragraph"><p>If you need some other behaviour from <span class="monospaced">with-resource-id</span> you can assign
a new function of type <span class="monospaced">String =&gt; String</span> to
<span class="monospaced">LiftRules.attachResourceId</span>. The default implementation, shown above,
takes the resource name ("/myscript.js" in the example) and returns the
resource name with an id appended.</p></div>
<div class="paragraph"><p>You can also wrap a number of tags inside a
<span class="monospaced">&lt;lift:with-resource-id&gt;...&lt;lift:with-resource-id&gt;</span> block. However,
avoid doing this in the <span class="monospaced">&lt;head&gt;</span> of your page as the HTML5 parser will
move the tags to be outside of the head section.</p></div>
<div class="paragraph"><p>Note that some proxies may choose not to cache resources with query
parameters at all. If that impacts you, it&#8217;s possible to code a custom resource id method
to move the random resouce ID out of the query parameter and into the path.</p></div>
<div class="paragraph"><p>Here&#8217;s one approach to doing this. Rather than generate JavaScript and CSS links that look like <span class="monospaced">/myscript.js?F61973</span>, we will generate <span class="monospaced">/cache/F61973/myscript.js</span>. We then will need to tell Lift to take requests
that look like this new format, and render the correct content for the request.  This all happens in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// The random number we're using to avoid caching</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> resourceId <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Helpers<span style="color: #990000">.</span>nextFuncName

<span style="font-style: italic"><span style="color: #9A1900">// Prefix lift:with-resource-id links with "/cache/{resouceId}"</span></span>
LiftRules<span style="color: #990000">.</span>attachResourceId <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #990000">(</span>path<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"/cache/"</span> <span style="color: #990000">+</span> resourceId <span style="color: #990000">+</span> path
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// The resource suffix we're caching: ".js" or ".css"</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> CacheableExt <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">unapply</span></span><span style="color: #990000">(</span>s<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Option<span style="color: #990000">[</span>String<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> s <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"js"</span> <span style="color: #990000">|</span> <span style="color: #FF0000">"css"</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">Some</span></span><span style="color: #990000">(</span>s<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> None
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// Remove the cache/{resourceId} from the request if there is one</span></span>
<span style="font-weight: bold"><span style="color: #000000">LiftRules.statelessRewrite.prepend</span></span><span style="color: #990000">(</span> <span style="font-weight: bold"><span style="color: #000000">NamedPF</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"BrowserCacheAssist"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">RewriteRequest</span></span><span style="color: #990000">(</span>
    <span style="font-weight: bold"><span style="color: #000000">ParsePath</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"cache"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> id <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> file<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">CacheableExt</span></span><span style="color: #990000">(</span>suffix<span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">,</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #000000">RewriteResponse</span></span><span style="color: #990000">(</span>file<span style="color: #990000">.</span>init <span style="color: #990000">++</span> <span style="font-weight: bold"><span style="color: #000000">List</span></span><span style="color: #990000">(</span>file<span style="color: #990000">.</span>last<span style="color: #990000">+</span><span style="color: #FF0000">"."</span><span style="color: #990000">+</span>suffix<span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #000000">Map[String,String]</span></span><span style="color: #990000">())</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">statelessRewrite</span> is a little long, but it&#8217;s doing quite a lot.  First, it&#8217;s matching only
request that start with "cache", followed by some value, followed by a filename, where the suffix
of the file matches the <span class="monospaced">CacheableExt</span>.  If it does, we reconstruct the path without the caching part.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_16">See Also</h4>
<div class="paragraph"><p>The source for <span class="monospaced">LiftRules</span> shows the default implementation of <span class="monospaced">attachResourceId</span>: <a href="https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/LiftRules.scala">https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/LiftRules.scala</a>.</p></div>
<div class="paragraph"><p>Google&#8217;s <em>Optimize caching</em> notes are a good source of information about browser behaviour: <a href="https://developers.google.com/speed/docs/best-practices/caching">https://developers.google.com/speed/docs/best-practices/caching</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_to_the_head_of_a_page">Adding to the Head of a Page</h3>
<div class="sect3">
<h4 id="_problem_17">Problem</h4>
<div class="paragraph"><p>You use a template for layout, but on one specific page you need to add
something to the <span class="monospaced">&lt;head&gt;</span> section.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_16">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">lift:head</span> snippet or CSS class so Lift knows to merge the
contents with the <span class="monospaced">&lt;head&gt;</span> of your page. For example, suppose you have
the following contents in <span class="monospaced">templates-hidden/default.html</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span> <span style="color: #009900">xmlns:lift</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://liftweb.net/"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">charset</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/meta&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;title</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:Menu.title"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>App: <span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"jquery"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"/classpath/jquery.js"</span>
      <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"json"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"/classpath/json.js"</span>
      <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"content"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>The main content will get bound here<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Also suppose you have <span class="monospaced">index.html</span> on which you want to include <span class="monospaced">my.css</span>
just for that page. Do so by including the CSS in the part of the page
that will get processed and mark it for the head with <span class="monospaced">lift:head</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Special<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;body</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:content_id=main"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:surround?with=default;at=content"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:head"</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"stylesheet"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"/my.css"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">'text/css'</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>Hello<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note that this <span class="monospaced">index.html</span> page is validated HTML5, and will produce a
result with the custom CSS inside the <span class="monospaced">&lt;head&gt;</span> tag, something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">charset</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>App:  Home<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span>
    <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"/classpath/jquery.js"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"jquery"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span>
    <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"/classpath/json.js"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"json"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"stylesheet"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"/my.css"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/css"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>Hello<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"/ajax_request/liftAjax.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// &lt;![CDATA[</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> lift_page <span style="color: #990000">=</span> <span style="color: #FF0000">"F557573613430HI02U4"</span><span style="color: #990000">;</span>
  <span style="font-style: italic"><span style="color: #9A1900">// ]]&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_17">Discussion</h4>
<div class="paragraph"><p>If you find your tags not appearing the the <span class="monospaced">&lt;head&gt;</span> section, check that
the HTML in your template and page is valid HTML5.</p></div>
<div class="paragraph"><p>You can also use <span class="monospaced">&lt;lift:head&gt;...&lt;/lift:head&gt;</span> to wrap a number of
expressions, and will see <span class="monospaced">&lt;head_merge&gt;...&lt;/head_merge&gt;</span> used in code
example as an alternative to <span class="monospaced">&lt;lift:head&gt;</span>.</p></div>
<div class="paragraph"><p>You may also see <span class="monospaced">data-lift="head"</span> is also used as an alternative to
<span class="monospaced">class="lift:head"</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_17">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Mailing list discussion on <em>Designer Friendly Way of Head Merge</em> at <a href="https://groups.google.com/d/msg/liftweb/rG_pOXdp4Ew/cPHTyTDhmWEJ">https://groups.google.com/d/msg/liftweb/rG_pOXdp4Ew/cPHTyTDhmWEJ</a>.
</p>
</li>
<li>
<p>
The W3C HTML validator is a useful tool for tracking down HTML markup issues that may cause problems with content being moved into the head of your page. <a href="http://validator.w3.org/">http://validator.w3.org/</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_custom_404_page">Custom 404 Page</h3>
<div class="sect3">
<h4 id="_problem_18">Problem</h4>
<div class="paragraph"><p>You want to show a customised "404" (page not found) page.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_17">Solution</h4>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> add the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">LiftRules.uriNotFound.prepend(NamedPF</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"404handler"</span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #990000">(</span>req<span style="color: #990000">,</span>failure<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #000000">NotFoundAsTemplate(ParsePath(List</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"404"</span><span style="color: #990000">),</span><span style="color: #FF0000">"html"</span><span style="color: #990000">,</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">))</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The file <span class="monospaced">src/main/webapp/404.html</span> will now be served for requests to
unknown resources.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_18">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">uriNotFound</span> Lift rule needs to return a <span class="monospaced">NotFound</span> in reply to a
<span class="monospaced">Req</span> (request) and optional <span class="monospaced">Failure</span>. This allows you to customise the
response based on the type of failure or the request that was made.</p></div>
<div class="paragraph"><p>There are three types of <span class="monospaced">NotFound</span>:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">NotFoundAsTemplate</span> is useful to invoke the Lift template processing
facilities from a <span class="monospaced">ParsePath</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">NotFoundAsResponse</span> allows you to return a specific <span class="monospaced">LiftResponse</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">NotFoundAsNode</span> wrappers a <span class="monospaced">NodeSeq</span> for Lift to translate into a 404
response.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In case you&#8217;re wondering, the two <span class="monospaced">false</span> arguments to <span class="monospaced">ParsePath</span>
indicates the path we&#8217;ve given isn&#8217;t absolute, and doesn&#8217;t end in a
slash.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_18">See Also</h4>
<div class="paragraph"><p>The Wiki entry for this topic: <a href="http://www.assembla.com/spaces/liftweb/wiki/Custom_404_-_URI_not_found_page">http://www.assembla.com/spaces/liftweb/wiki/Custom_404_-_URI_not_found_page</a></p></div>
</div>
</div>
<div class="sect2">
<h3 id="_other_custom_status_pages">Other Custom Status Pages</h3>
<div class="sect3">
<h4 id="_problem_19">Problem</h4>
<div class="paragraph"><p>You want to show a customised page for certain HTTP status codes.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_18">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">LiftRules.responseTransformers</span> to match against the response and
supply an alternative.</p></div>
<div class="paragraph"><p>For example, suppose we want to provide a customised page for 403
("Forbidden") statuses created in your Lift application. In <span class="monospaced">Boot.scala</span>
we could add the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>LiftRules<span style="color: #990000">.</span>responseTransformers<span style="color: #990000">.</span>append <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> r <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> r<span style="color: #990000">.</span>toResponse<span style="color: #990000">.</span>code <span style="font-weight: bold"><span style="color: #0000FF">==</span></span> <span style="color: #993399">403</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">RedirectResponse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"/403.html"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> r <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> r
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The file <em>src/main/webapp/403.html</em> will now be served for requests that
generate 403 status codes. Other, non 403, requests are left untransformed.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_19">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">LiftRules.responseTransformers</span> allows you to supply
<span class="monospaced">LiftResponse =&gt; LiftResponse</span> functions to change a response at the end
of the HTTP processing cycle. This is a very general mechanism: in this
example we are matching on a status code, but we could match on anything
exposed by <span class="monospaced">LiftResponse</span>.</p></div>
<div class="paragraph"><p>We&#8217;ve shown a <span class="monospaced">RedirectResponse</span> being
returned but there are many different kinds of <span class="monospaced">LiftResponse</span> we could
send to the client.</p></div>
<div class="paragraph"><p>One way to test the above example is to add the following to Boot to
make all requests to <em>/secret</em> return a 403:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> Protected <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">If(</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">ForbiddenResponse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"no way"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> entries <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">List</span></span><span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #000000">Menu.i</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Home"</span><span style="color: #990000">)</span> <span style="color: #990000">/</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">,</span>
  <span style="font-weight: bold"><span style="color: #000000">Menu.i</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"secret"</span><span style="color: #990000">)</span> <span style="color: #990000">/</span> <span style="color: #FF0000">"secret"</span> <span style="color: #990000">&gt;&gt;</span> Protected<span style="color: #990000">,</span>
  <span style="font-weight: bold"><span style="color: #000000">Menu.i</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"403"</span><span style="color: #990000">)</span> <span style="color: #990000">/</span> <span style="color: #FF0000">"403"</span> <span style="color: #990000">&gt;&gt;</span> Hidden
  <span style="font-style: italic"><span style="color: #9A1900">// rest of your site map here...</span></span>
<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>If you request <em>/secret</em>, a 403 response will be triggered, which will match the response transformer showing you
the <em>403.html</em> page.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_19">See Also</h4>
<div class="paragraph"><p><em>The Request/Response Lifecycle</em> section in <em>Exploring Lift</em> in gives more details about the processing pipeline.
<a href="http://exploring.liftweb.net/master/index-9.html#toc-Section-9.2">http://exploring.liftweb.net/master/index-9.html#toc-Section-9.2
</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_links_in_notices">Links in Notices</h3>
<div class="sect3">
<h4 id="_problem_20">Problem</h4>
<div class="paragraph"><p>You want to include a clickable link in your <span class="monospaced">S.error</span>, <span class="monospaced">S.notice</span> or
<span class="monospaced">S.warning</span> messages.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_19">Solution</h4>
<div class="paragraph"><p>Include a <span class="monospaced">NodeSeq</span> containing a link in your notice:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">S.error</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"checkPrivacyPolicy"</span><span style="color: #990000">,</span>
  <span style="color: #990000">&lt;</span>span<span style="color: #990000">&gt;</span>See our <span style="color: #990000">&lt;</span>a href<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"/policy"</span><span style="color: #990000">&gt;</span>privacy policy<span style="color: #990000">&lt;/</span>a<span style="color: #990000">&gt;&lt;/</span>span<span style="color: #990000">&gt;)</span></tt></pre></div></div>
<div class="paragraph"><p>You might pair this with the following in your template:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:Msg?id=checkPrivacyPolicy"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/div&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_20">See Also</h4>
<div class="paragraph"><p>Lift notices are described on the Wiki: <a href="http://www.assembla.com/spaces/liftweb/wiki/Lift_Notices_and_Auto_Fadeout">http://www.assembla.com/spaces/liftweb/wiki/Lift_Notices_and_Auto_Fadeout</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_rendering_textile_markup">Rendering Textile Markup</h3>
<div class="sect3">
<h4 id="_problem_21">Problem</h4>
<div class="paragraph"><p>You want to render Textile markup in your web app.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_20">Solution</h4>
<div class="paragraph"><p>Install the Lift Textile module in your <span class="monospaced">build.sbt</span> file by adding the
following to the list of dependencies:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"net.liftmodules"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"textile"</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>liftVersion <span style="color: #990000">+</span> <span style="color: #FF0000">"1.1"</span><span style="color: #990000">)</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"compile-&gt;default"</span><span style="color: #990000">,</span></tt></pre></div></div>
<div class="paragraph"><p>You can then use the module to render Textile using the <span class="monospaced">toHtml</span> method:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftmodules<span style="color: #990000">.</span>textile<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftmodules<span style="color: #990000">.</span>textile<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">TextileParser.toHtml</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"""h1. Hi!</span>
<span style="color: #FF0000"> |</span>
<span style="color: #FF0000"> | The module in "</span>Lift<span style="color: #FF0000">":http://www.liftweb.net for turning Textile markup</span>
<span style="color: #FF0000"> | into HTML is pretty easy to use.</span>
<span style="color: #FF0000"> |</span>
<span style="color: #FF0000"> | * As you can see</span>
<span style="color: #FF0000"> | * in this example</span>
<span style="color: #FF0000"> |"""</span><span style="color: #990000">)</span>
res0<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>NodeSeq <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
<span style="font-weight: bold"><span style="color: #000000">NodeSeq</span></span><span style="color: #990000">(&lt;</span>h1<span style="color: #990000">&gt;</span>Hi<span style="color: #990000">!&lt;/</span>h1<span style="color: #990000">&gt;,</span>
<span style="color: #990000">,</span> <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>The module in <span style="color: #990000">&lt;</span>a href<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"http://www.liftweb.net"</span><span style="color: #990000">&gt;</span>Lift<span style="color: #990000">&lt;/</span>a<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> turning
Textile markup into HTML is pretty easy to use<span style="color: #990000">.&lt;/</span>p<span style="color: #990000">&gt;,</span>
<span style="color: #990000">,</span> <span style="color: #990000">&lt;</span>ul<span style="color: #990000">&gt;&lt;</span>li<span style="color: #990000">&gt;</span> As you can see<span style="color: #990000">&lt;/</span>li<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>li<span style="color: #990000">&gt;</span> In <span style="font-weight: bold"><span style="color: #0000FF">this</span></span> example<span style="color: #990000">&lt;/</span>li<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;/</span>ul<span style="color: #990000">&gt;,</span>
<span style="color: #990000">,</span> <span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_20">Discussion</h4>
<div class="paragraph"><p>There&#8217;s nothing special code has to do to become a Lift module, although there are common conventions: they typically are packaged as <em>net.liftmodules</em>, but don&#8217;t have to be; they usually depend on a version of Lift; they sometimes use the hooks provided by <span class="monospaced">LiftRules</span> to provide a particular behaviour.  Anyone can create and publish a Lift module, and anyone can contribute to existing modules. In the end, they are declared as dependencies in SBT, and pulled into your code just like any other dependency.</p></div>
<div class="paragraph"><p>The dependency version is made up of two elements: the Lift version, and the module version, as shown in <a href="#ModuleVersioning">[ModuleVersioning]</a>. This is because modules have their own release cycle, so you could have versions 1.1, 1.2 and 1.3 all for the same version of Lift. However, they may also depend on certain features of Lift, hence the combined version number.</p></div>
<div class="imageblock" id="ModuleVersioning">
<div class="content">
<img src="images/moduleversioning.png" alt="images/moduleversioning.png">
</div>
<div class="title">Figure 2. The structure of a module version.</div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_21">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
There&#8217;s no real specification of what Textile is, but there are references available which cover the typical kinds of mark up to enter and what HTML you can expect to see: <a href="http://redcloth.org/hobix.com/textile/">http://redcloth.org/hobix.com/textile/</a>.
</p>
</li>
<li>
<p>
<em>Lift in Action</em>, chapter 7 contains a Wiki example that uses the
Textile plugin.
</p>
</li>
<li>
<p>
The home of the Textile module: <a href="https://github.com/liftmodules/textile">
<a href="https://github.com/liftmodules/textile">https://github.com/liftmodules/textile</a></a>.
</p>
</li>
<li>
<p>
The unit tests for the Textile module give you a good set of examples of what is supported: <a href="https://github.com/liftmodules/textile/blob/master/src/test/scala/net/liftmodules/textile/TextileSpec.scala">https://github.com/liftmodules/textile/blob/master/src/test/scala/net/liftmodules/textile/TextileSpec.scala</a>.
</p>
</li>
<li>
<p>
<a href="http://www.liftmodules.net">http://www.liftmodules.net</a> describes the module system in Lift.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_forms_processing_in_lift">Forms Processing in Lift</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section gives examples of working with Lift forms in different
ways.</p></div>
<div class="sect2">
<h3 id="_plain_old_form_processing">Plain old form processing</h3>
<div class="sect3">
<h4 id="_problem_22">Problem</h4>
<div class="paragraph"><p>You want to process form data in a regular old-fashioned, non-Ajax, way.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_21">Solution</h4>
<div class="paragraph"><p>Extract form values with <span class="monospaced">S.param</span>. For example, we can show a form,
process an input value, and echo the value back out. Here we have
<span class="monospaced">dumbForm.html</span> which contains a form wrapped in a snippet:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:DumbForm"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span>  <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"/dumbForm.html"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"it"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"something"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Go"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"result"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Pick out the values in the snippet:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> code<span style="color: #990000">.</span>snippet

<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>common<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> Helpers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">DumbForm</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> inputParam <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #FF0000">{</span>
    r <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> S<span style="color: #990000">.</span>request <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> r<span style="color: #990000">.</span>post<span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">?</span>  <span style="font-style: italic"><span style="color: #9A1900">// restricting to POST requests</span></span>
    v <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> <span style="font-weight: bold"><span style="color: #000000">S.param</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"it"</span><span style="color: #990000">)</span>
  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">yield</span></span> v

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> render <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> inputParam <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">Full</span></span><span style="color: #990000">(</span>x<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Input is: "</span><span style="color: #990000">+</span>x<span style="color: #990000">)</span>
        <span style="color: #FF0000">"#result *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> x

      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"No input present! Rendering input form HTML"</span><span style="color: #990000">)</span>
        PassThru
  <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>When you run this code you&#8217;ll see
<span class="monospaced">No input present! Rendering input form HTML</span> on the console, and when
you press "Go" you&#8217;ll see <span class="monospaced">Input is: something</span> and the "something" will
appear on the page.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_21">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">DumbForm</span> snippet extracts the input parameter using a for
comprehension. The result will be of type <span class="monospaced">Box[String]</span> which we then
match on to decide what to do next.</p></div>
<div class="paragraph"><p>In this example, we are also checking that the request is a POST request
before extracting the value of the <span class="monospaced">it</span> form parameter.</p></div>
<div class="paragraph"><p>Screen or Wizard provide alternatives for form processing, but sometimes
you just want to pull values from a request, as demonstrated in this
recipe.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_22">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<em>Simply Lift</em>, section 4.1,
<a href="http://simply.liftweb.net/index-4.1.html#toc-Section-4.1">Old Fashioned
Dumb Forms</a> and 4.9
<a href="http://stable.simply.liftweb.net/#toc-Section-4.9">But sometimes Old
Fashioned is good</a>.
</p>
</li>
<li>
<p>
<a href="https://github.com/marekzebrowski/lift-basics">Simple forms</a>, example
Lift project.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_ajax_form_processing">Ajax form processing</h3>
<div class="sect3">
<h4 id="_problem_23">Problem</h4>
<div class="paragraph"><p>You want to process a form on the server via Ajax, without reloading the
whole page.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_22">Solution</h4>
<div class="paragraph"><p>Mark your form as an Ajax form with <span class="monospaced">lift:form.ajax</span> and supply a
function to run on the server when the form is submitted. Given this
form&#8230;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:AjaxExample"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:form.ajax"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"info"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"sb"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"go!"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"result"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;we use the following snippet to accept the text field input of <span class="monospaced">info</span>
and send back a JavasScript command to update the <span class="monospaced">result</span> div with the
value sent to us:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> code<span style="color: #990000">.</span>snippet

<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Helpers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>SHtml
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>js<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> JsCmds<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>Text

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">AjaxExample</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> inputVal <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"default"</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">process</span></span><span style="color: #990000">()</span><span style="font-weight: bold"><span style="color: #0000FF">:</span></span> JsCmd <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Received: "</span><span style="color: #990000">+</span>inputVal<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">SetHtml</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"result"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">Text</span></span><span style="color: #990000">(</span>inputVal<span style="color: #990000">))</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> render <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"name=info"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #990000">(</span>
        <span style="font-weight: bold"><span style="color: #000000">SHtml.text</span></span><span style="color: #990000">(</span>inputVal<span style="color: #990000">,</span> inputVal <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">)</span> <span style="color: #990000">++</span>
        <span style="font-weight: bold"><span style="color: #000000">SHtml.hidden</span></span><span style="color: #990000">(</span>process<span style="color: #990000">)</span> <span style="color: #990000">)</span>
  <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_22">Discussion</h4>
<div class="paragraph"><p>The form&#8217;s <span class="monospaced">info</span> input is bound to a <span class="monospaced">SHtml.text</span> box which will set
the local <span class="monospaced">inputVal</span> variable to the value submitted by the form.</p></div>
<div class="paragraph"><p>The hidden field instructs Lift to call the <span class="monospaced">() =&gt;âAny</span> function
(<span class="monospaced">process</span>, in this example) when the form is submitted. The end result
is the text entered is echoed back by setting the HTML node <span class="monospaced">result</span>.
There are many other <span class="monospaced">JsCmd`s you could send, including `Noop</span> if you
decide to send nothing.</p></div>
<div class="paragraph"><p>In <span class="monospaced">SHtml</span> you will see functions starting with "ajax" (e.g.,
<span class="monospaced">ajaxText</span>). These are great for field-level Ajax interactions, such as
triggering actions on input or selection changes.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_23">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<em>Simply Lift</em>, chapter 4.8
<a href="http://stable.simply.liftweb.net/#toc-Section-4.8">Ajax</a>.
</p>
</li>
<li>
<p>
Example <a href="https://github.com/marekzebrowski/lift-basics">simple forms</a>
Lift project.
</p>
</li>
<li>
<p>
<a href="http://www.assembla.com/spaces/liftweb/wiki/cool_tips">Server side
function order</a> on the Lift Cool Tips Wiki page.
*
<a href="http://scala-tools.org/mvnsites/liftweb-2.4/net/liftweb/http/SHtml.html">SHtml
Scala Doc</a>.
</p>
</li>
<li>
<p>
Lift&#8217;s <a href="http://demo.liftweb.net/ajax">Ajax Demo page</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_ajax_json_form_processing">Ajax JSON form processing</h3>
<div class="sect3">
<h4 id="_problem_24">Problem</h4>
<div class="paragraph"><p>You want to process a form via Ajax, sending the data in JSON format.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_23">Solution</h4>
<div class="paragraph"><p>Make use of Lift&#8217;s <span class="monospaced">jlift.js</span> Javascript and <span class="monospaced">JsonHandler</span> code.
Consider this HTML, which is not in a form, but includes <span class="monospaced">jlift.js</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:JsonForm"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

 <span style="font-style: italic"><span style="color: #9A1900">&lt;!--  required for JSON forms processing --&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"/classpath/jlift.js"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:tail"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>

 <span style="font-style: italic"><span style="color: #9A1900">&lt;!--  placeholder script required to process the form --&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"jsonFormScript"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:tail"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>

 <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"formToJson"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"formToJson"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"name"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Royal Society"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"motto"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Nullius in verba"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"sb"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"go!"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"result"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The server-side code to accept the input as JSON would be as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> code<span style="color: #990000">.</span>snippet

<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> Helpers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>js<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> JsCmds<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">JsonForm</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> render <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
     <span style="color: #FF0000">"#formToJson"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #990000">((</span>ns<span style="font-weight: bold"><span style="color: #0000FF">:</span></span>NodeSeq<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">SHtml.jsonForm</span></span><span style="color: #990000">(</span>jsonHandler<span style="color: #990000">,</span> ns<span style="color: #990000">))</span> <span style="color: #990000">&amp;</span>
     <span style="color: #FF0000">"#jsonFormScript"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">Script</span></span><span style="color: #990000">(</span>jsonHandler<span style="color: #990000">.</span>jsCmd<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> jsonHandler <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> JsonHandler <span style="color: #FF0000">{</span>

      <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">apply</span></span><span style="color: #990000">(</span>in<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Any<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #0000FF">:</span></span> JsCmd <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> in <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> <span style="color: #FF0000">{</span>
          <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">JsonCmd</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"processForm"</span><span style="color: #990000">,</span> target<span style="color: #990000">,</span> params<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Map<span style="color: #990000">[</span>String<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">],</span> all<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> name <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">params.getOrElse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"name"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"No Name"</span><span style="color: #990000">)</span>
            <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> motto <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">params.getOrElse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"motto"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"No Motto"</span><span style="color: #990000">)</span>
            <span style="font-weight: bold"><span style="color: #000000">SetHtml</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"result"</span><span style="color: #990000">,</span>
                <span style="font-weight: bold"><span style="color: #000000">Text</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The motto of %s is %s"</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span>motto<span style="color: #990000">))</span> <span style="color: #990000">)</span>

          <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #000000">SetHtml("result",Text</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Unknown command"</span><span style="color: #990000">))</span>
      <span style="color: #FF0000">}</span>

    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If you click the go button and observe the network traffic, you&#8217;ll see
the following sent to the server:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"command"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"processForm"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"params"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Royal Society"</span><span style="color: #990000">,</span><span style="color: #FF0000">"motto"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Nullius in verba"</span><span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The server will send back JavaScript to update the <span class="monospaced">results</span> div with
"The motto of the Royal Society is Nullius in verba".</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_23">Discussion</h4>
<div class="paragraph"><p>The key components in the example are:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<span class="monospaced">jlift.js</span> script that makes various JSON functions available; and
</p>
</li>
<li>
<p>
generated JavaScript code (<span class="monospaced">jsonHandler.jsCmd</span>) that is included on
the page to perform the actual submission.
</p>
</li>
</ol></div>
<div class="paragraph"><p>In the binding, <span class="monospaced">SHtml.jsonForm</span> takes the <span class="monospaced">jsonHandler</span> object which
will process the form elements, and wraps your template, <span class="monospaced">ns</span>, with a
<span class="monospaced">&lt;form&gt;</span> tag. We also bind the JavasScript required to the
<span class="monospaced">jsonFormScript</span> placeholder.</p></div>
<div class="paragraph"><p>When the form is submitted, the <span class="monospaced">JsonHandler.apply</span> allows us to pattern
match on the input and extract the values we need from a <span class="monospaced">Map</span>. Note
that compiling this code will produce a warning as <span class="monospaced">Map[String,_]</span> will
be "unchecked since it is eliminated by erasure".</p></div>
<div class="paragraph"><p>If you are implementing a REST service to process JSON, consider using
Rest helpers in Lift to do that.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_24">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.javabeat.net/2011/05/using-json-forms-with-ajax-in-lift-framework/">Using
JSON forms with AJAX in Lift Framework</a>.
</p>
</li>
<li>
<p>
<em>Lift in Action</em>, section 9.1.4 "Using JSON forms with AJAX".
</p>
</li>
<li>
<p>
Example Lift application demonstrating
<a href="https://github.com/marekzebrowski/lift-basics">Simple form</a> processing.
</p>
</li>
<li>
<p>
Section 10.4, JSON, in
<a href="http://exploring.liftweb.net/master/index-10.html">Exploring Lift</a>.
</p>
</li>
<li>
<p>
<a href="http://en.wikipedia.org/wiki/Nullius_in_verba">Nullius in verba</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_conditionally_disable_a_checkbox">Conditionally disable a checkbox</h3>
<div class="sect3">
<h4 id="_problem_25">Problem</h4>
<div class="paragraph"><p>You want to add the <span class="monospaced">disabled</span> attribute to a <span class="monospaced">SHtml.checkbox</span> based on
a conditional check.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_24">Solution</h4>
<div class="paragraph"><p>Create a CSS selector transform to add the disabled attribute, and apply
it to your checkbox transform. For example, suppose you have a simple
checkbox:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Likes</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> likeTurtles <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> checkbox <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"*"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">SHtml.checkbox</span></span><span style="color: #990000">(</span>likeTurtles<span style="color: #990000">,</span> likeTurtles <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Further suppose you want to disable it roughly 50% of the time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> disabler <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>math<span style="color: #990000">.</span>random <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">.</span>5d<span style="color: #990000">)</span> <span style="color: #FF0000">"* [disabled]"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">"disabled"</span>
 <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> PassThru

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> conditionallyDisabledCheckbox <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="color: #FF0000">"*"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">disabler</span></span><span style="color: #990000">(</span> <span style="font-weight: bold"><span style="color: #000000">SHtml.checkbox</span></span><span style="color: #990000">(</span>likeTurtles<span style="color: #990000">,</span> likeTurtles <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="color: #990000">)</span> <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Using <span class="monospaced">lift:Likes.conditionallyDisabledCheckbox</span> the checkbox would be
disabled half the time.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_24">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">disabler</span> method returns a <span class="monospaced">NodeSeq=&gt;NodeSeq</span> function, meaning
when we apply it in <span class="monospaced">conditionallyDisabledCheckbox</span> we need to give it a
<span class="monospaced">NodeSeq</span>, which is exactly what <span class="monospaced">SHtml.checkbox</span> provides.</p></div>
<div class="paragraph"><p>The <span class="monospaced">[disabled]</span> part of the CSS selector is selecting the disabled
attribute and replacing it with the value on the right of the <span class="monospaced">#&gt;</span>,
which is "disabled" in this example.</p></div>
<div class="paragraph"><p>What this combination means is that half the time the disabled attribute
will be set on the checkbox, and half the time the checkbox <span class="monospaced">NodeSeq</span>
will be left untouched because <span class="monospaced">PassThru</span> does not change the <span class="monospaced">NodeSeq</span>.</p></div>
<div class="paragraph"><p>The example above separates the test from the checkbox only to make it
easier to write this discussion section. You can of course in-line the
test, as is done in the mailing list post referenced below.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_25">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Mailing list question regarding
<a href="https://groups.google.com/d/topic/liftweb/KBVhkuM1NQQ/discussion">how to
conditionally mark a SHtml.checkbox as disabled</a>.
</p>
</li>
<li>
<p>
<em>Simply Lift</em> <a href="http://simply.liftweb.net/index-7.10.html">7.10 CSS
Selector Transforms</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_use_a_select_box_with_multiple_options">Use a select box with multiple options</h3>
<div class="sect3">
<h4 id="_problem_26">Problem</h4>
<div class="paragraph"><p>You want to show the user a number of options in a select box, and allow
them to select multiple values.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_25">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">SHtml.multiSelect</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">MySnippet</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> multi <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Item</span><span style="color: #990000">(</span>id<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">,</span> name<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> inventory <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Item</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"a"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Coffee"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="font-weight: bold"><span style="color: #000000">Item</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"b"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Milk"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span>
       <span style="font-weight: bold"><span style="color: #000000">Item</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Sugar"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span>

     <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> options <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #000000">List[</span></span><span style="color: #990000">(</span>String<span style="color: #990000">,</span>String<span style="color: #990000">)]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
       <span style="font-weight: bold"><span style="color: #000000">inventory.map</span></span><span style="color: #990000">(</span>i <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #990000">(</span>i<span style="color: #990000">.</span>id <span style="color: #990000">-&gt;</span> i<span style="color: #990000">.</span>name<span style="color: #990000">))</span>

     <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> default <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> inventory<span style="color: #990000">.</span>head<span style="color: #990000">.</span>id <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span>

     <span style="color: #FF0000">"#opts *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span>
       <span style="font-weight: bold"><span style="color: #000000">SHtml.multiSelect</span></span><span style="color: #990000">(</span>options<span style="color: #990000">,</span> default<span style="color: #990000">,</span> xs <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Selected: "</span><span style="color: #990000">+</span>xs<span style="color: #990000">))</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The corresponding template would be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:MySnippet.multi?form=post"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>What can I getcha?<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"opts"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>options go here<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Submit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>This will render as something like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"/"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>What can I getcha?<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"opts"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;select</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"F25749422319ALP1BW"</span> <span style="color: #009900">multiple</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"a"</span> <span style="color: #009900">selected</span><span style="color: #990000">=</span><span style="color: #FF0000">"selected"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Coffee<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"b"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Milk<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"c"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Sugar<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;/select&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Submit"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_25">Discussion</h4>
<div class="paragraph"><p>Recall that an HTML select consists of a set of options, each of which
has a value and a name. To reflect this, the above examples takes our
<span class="monospaced">inventory</span> of objects and turns it into a list of (value,name) string
pairs, called <span class="monospaced">options</span>.</p></div>
<div class="paragraph"><p>The function given to <span class="monospaced">multiSelect</span> will receive the values (ids), not
the names, of the options. That is, if you ran the above code, and
selected "Coffee" and "Milk" the function would see <span class="monospaced">List("a", "b")</span>.</p></div>
<div class="sect4">
<h5 id="_selected_no_options">Selected no options</h5>
<div class="paragraph"><p>Be aware if no options are selected at all, your handling function is
not called. This is described in ticket 1139. One way to work around
this to to add a hidden function to reset the list. For example, we
could modify the above code to be a stateful snippet and remember the
values we selected:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">MySnippet</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> StatefulSnippet <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> dispatch <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"multi"</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> multi
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Item</span><span style="color: #990000">(</span>id<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">,</span> name<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> inventory <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Item</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"a"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Coffee"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="font-weight: bold"><span style="color: #000000">Item</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"b"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Milk"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span>
    <span style="font-weight: bold"><span style="color: #000000">Item</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Sugar"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span>

  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> options <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #000000">List[</span></span><span style="color: #990000">(</span>String<span style="color: #990000">,</span>String<span style="color: #990000">)]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">inventory.map</span></span><span style="color: #990000">(</span>i <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #990000">(</span>i<span style="color: #990000">.</span>id <span style="color: #990000">-&gt;</span> i<span style="color: #990000">.</span>name<span style="color: #990000">))</span>

  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> current <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> inventory<span style="color: #990000">.</span>head<span style="color: #990000">.</span>id <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> multi <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"#opts *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #990000">(</span>
    <span style="font-weight: bold"><span style="color: #000000">SHtml.hidden(</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> current <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #009900">Nil</span><span style="color: #990000">)</span> <span style="color: #990000">++</span>
    <span style="font-weight: bold"><span style="color: #000000">SHtml.multiSelect</span></span><span style="color: #990000">(</span>options<span style="color: #990000">,</span> current<span style="color: #990000">,</span> current <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">)</span>
  <span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Each time the form is submited the <span class="monospaced">current</span> list of IDs is set to
whatever you have selected in the browser. But note that we have started
with a hidden function that resets <span class="monospaced">current</span> to the empty list, meaning
that if the receiving function in <span class="monospaced">multiSelect</span> is never called, that
would mean you have nothing selected. That may be useful, depending on
what behaviour you need in your application.</p></div>
</div>
<div class="sect4">
<h5 id="_type_safe_options">Type-safe options</h5>
<div class="paragraph"><p>If you don&#8217;t want to work in terms of <span class="monospaced">String</span> values for an option, you
can use <span class="monospaced">multiSelectObj</span>. In this variation the list of options still
provides a text name, but the value is in terms of a class. Likewise,
the list of default values will be a list of class instances:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> options <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #000000">List[</span></span><span style="color: #990000">(</span>Item<span style="color: #990000">,</span>String<span style="color: #990000">)]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">inventory.map</span></span><span style="color: #990000">(</span>i <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">-&gt;</span> i<span style="color: #990000">.</span>name<span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> current <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> inventory<span style="color: #990000">.</span>head <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span></tt></pre></div></div>
<div class="paragraph"><p>The call to generate the multi-select from this data is similar, but
note that the function receives a list of <span class="monospaced">Item</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"#opts *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">SHtml.multiSelectObj</span></span><span style="color: #990000">(</span>options<span style="color: #990000">,</span> current<span style="color: #990000">,</span>
  <span style="color: #990000">(</span>xs<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> List<span style="color: #990000">[</span>Item<span style="color: #990000">])</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Got "</span><span style="color: #990000">+</span>xs<span style="color: #990000">)</span> <span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_enumerations">Enumerations</h5>
<div class="paragraph"><p>You can use <span class="monospaced">multiSelectObj</span> with enumerations:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Item <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Enumeration <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> Item <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Value
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> Coffee<span style="color: #990000">,</span> Milk<span style="color: #990000">,</span> Sugar <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Value
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> Item<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> options <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #000000">List[</span></span><span style="color: #990000">(</span>Item<span style="color: #990000">,</span>String<span style="color: #990000">)]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="font-weight: bold"><span style="color: #000000">Item.values.toList.map</span></span><span style="color: #990000">(</span>i <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">-&gt;</span> i<span style="color: #990000">.</span>toString<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> current <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Item<span style="color: #990000">.</span>Coffee <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> multi <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"#opts *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">SHtml.multiSelectObj[Item]</span></span><span style="color: #990000">(</span>options<span style="color: #990000">,</span> current<span style="color: #990000">,</span>
  xs <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Got "</span><span style="color: #990000">+</span>xs<span style="color: #990000">)</span> <span style="color: #990000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_26">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<em>Exploring Lift</em>, Chapter 6,
<a href="http://exploring.liftweb.net/master/index-6.html">Forms in Lift</a>.
</p>
</li>
<li>
<p>
<a href="https://www.assembla.com/spaces/liftweb/tickets/1139">Ticket 1139</a>,
Cannot clear out multiselect.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rest">REST</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_dry_urls">DRY URLs</h3>
<div class="sect3">
<h4 id="_problem_27">Problem</h4>
<div class="paragraph"><p>You found yourself repeating parts of URL paths in your RestHelper, and
you Don&#8217;t want to Repeat Yourself.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_26">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">prefix</span> in your RestHelper:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">object</span></span> RestAPI <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> RestHelper <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #000000">serve</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"bugs"</span> <span style="color: #990000">/</span> <span style="color: #FF0000">"by-state"</span> prefix <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"open"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span> JsonGet <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>None open<span style="color: #990000">&lt;/</span>p<span style="color: #990000">&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"closed"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span> JsonGet <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>None closed<span style="color: #990000">&lt;/</span>p<span style="color: #990000">&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> state <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span> JsonDelete <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>All deleted<span style="color: #990000">&lt;/</span>p<span style="color: #990000">&gt;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">)</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_26">Discussion</h4>
<div class="paragraph"><p>You can have many <span class="monospaced">serve</span> blocks in your <span class="monospaced">RestHelper</span>, which helps give
your REST service structure.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_27">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://simply.liftweb.net/index-5.3.html">RestHelper</a>, section 5.3 of
<em>Simply Lift</em>.
</p>
</li>
<li>
<p>
Wiki page on
<a href="http://www.assembla.com/spaces/liftweb/wiki/REST_Web_Services">REST Web
Services</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_google_sitemap">Google Sitemap</h3>
<div class="sect3">
<h4 id="_problem_28">Problem</h4>
<div class="paragraph"><p>You want to make a Google Sitemap using Lift&#8217;s rendering capabilities.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_27">Solution</h4>
<div class="paragraph"><p>Simply create a file (e.g. <span class="monospaced">sitemap.html</span>) in your <span class="monospaced">webapp</span> folder with
a valid XML-Sitemap markup:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"&gt;
&lt;lift:MySitemapContent.base&gt;
    &lt;url&gt;
        &lt;loc&gt;&lt;/loc&gt;
        &lt;changefreq&gt;daily&lt;/changefreq&gt;
        &lt;priority&gt;1.0&lt;/priority&gt;
        &lt;lastmod&gt;&lt;/lastmod&gt;
    &lt;/url&gt;
&lt;/lift:MySitemapContent.base&gt;
&lt;lift:MySitemapContent.list&gt;
    &lt;url&gt;
        &lt;loc&gt;&lt;/loc&gt;
        &lt;lastmod&gt;&lt;/lastmod&gt;
    &lt;/url&gt;
&lt;/lift:MySitemapContent.list&gt;
&lt;/urlset&gt;</pre>
</div></div>
<div class="paragraph"><p>Make a snippet to fill the required gaps:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">MySitemapContent</span> <span style="color: #990000">\</span><span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">lazy</span></span> <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> entries <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">MyDBRecord.findAll</span></span><span style="color: #990000">(..)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> base<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> CssSel <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
    <span style="color: #FF0000">"loc *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">"http://%s/"</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>S<span style="color: #990000">.</span>hostName<span style="color: #990000">)</span> <span style="color: #990000">&amp;</span>
    <span style="color: #FF0000">"lastmod *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">someDate.toString</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"yyyy-MM-dd'T'HH:mm:ss.SSSZZ"</span><span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> list<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> CssSel <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
    <span style="color: #FF0000">"url *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">entries.map</span></span><span style="color: #990000">(</span>post <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
    <span style="color: #FF0000">"loc *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">"http://%s%s"</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>S<span style="color: #990000">.</span>hostName<span style="color: #990000">,</span> post<span style="color: #990000">.</span>url<span style="color: #990000">)</span> <span style="color: #990000">&amp;</span>
    <span style="color: #FF0000">"lastmod *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">post.date.toString</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"yyyy-MM-dd'T'HH:mm:ss.SSSZZ"</span><span style="color: #990000">))</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that Google Sitemaps need dates to be in ISO 8601 format. The built-in`java.text.SimpleDateFormat`does not support this format prior to Java 7. If you are using Java 6 you need to use`org.joda.time.DateTime`.
With Java 7 "yyyy-MM-dd&#8217;T'HH:mmXXX" can be used as the pattern for the
formatting.</p></div>
<div class="paragraph"><p>We could run this template through Lift&#8217;s default HTML render engine and
simply add it to Lift&#8217;s own Sitemap, but we want our valid XML to be
delivered as XML rather than HTML. So instead we will use <span class="monospaced">RestHelper</span>
to return a <span class="monospaced">XmlResponse</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>rest<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> MySitemap <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> RestHelper <span style="color: #FF0000">{</span>
  serve <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">Req</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"sitemap"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">,</span> GetRequest<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #000000">XmlResponse(S.render</span></span><span style="color: #990000">(&lt;</span>lift<span style="font-weight: bold"><span style="color: #0000FF">:</span></span>embed what<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"sitemap"</span> <span style="color: #990000">/&gt;,</span>
       S<span style="color: #990000">.</span>request<span style="color: #990000">.</span>get<span style="color: #990000">.</span>request<span style="color: #990000">).</span>head<span style="color: #990000">)</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Wire this into your application in <span class="monospaced">Boot.scala</span>, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">LiftRules.statelessDispatchTable.append</span></span><span style="color: #990000">(</span>code<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>MySitemap<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Test this service using a tool like cURL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">\</span>$ curl http<span style="font-weight: bold"><span style="color: #0000FF">:</span></span><span style="font-style: italic"><span style="color: #9A1900">//127.0.0.1:8080/sitemap</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_28">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://support.google.com/webmasters/bin/answer.py?hl=en&amp;answer=156184">About
Google Sitemaps</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_missing_file_suffix">Missing file suffix</h3>
<div class="sect3">
<h4 id="_problem_29">Problem</h4>
<div class="paragraph"><p>Your RestHelper expects a filename as part of the URL, but the suffix
(extension) is missing, and you need it.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_28">Solution</h4>
<div class="paragraph"><p>Access <span class="monospaced">req.path.suffix</span> to recover the suffix. For example, when
processing <span class="monospaced">/download/123.png</span> you want to be able reconstruct
<span class="monospaced">123.png</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">reunite</span></span><span style="color: #990000">(</span>name<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">,</span> suffix<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>suffix<span style="color: #990000">.</span>isEmpty<span style="color: #990000">)</span> name <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> name<span style="color: #990000">+</span><span style="color: #FF0000">"."</span><span style="color: #990000">+</span>suffix

serve <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"download"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> name <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span> Get req <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #000000">Text</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"You requested "</span><span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #000000">reunite</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> req<span style="color: #990000">.</span>path<span style="color: #990000">.</span>suffix<span style="color: #990000">))</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Requesting this URL with a command like cURL will show you the filename
as expected:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>\$ curl http://127.0.0.1:8080/download/123.png
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
You requested 123.png</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_27">Discussion</h4>
<div class="paragraph"><p>When Lift parses a request it splits the request into constituent parts
(e.g., turning the path into a <span class="monospaced">List[String]</span>), and this includes a
separation of some suffixes. This is great for pattern matching when you
want to change behaviour based on the suffix, but a hinderance in this
particular situation.</p></div>
<div class="paragraph"><p>Only those suffixes defined in <span class="monospaced">LiftRules.explicitlyParsedSuffixes</span> are
split from the filename. This includes many of the common file suffixes
(such as "png", "atom", "json") and also some you may not be so familiar
with, such as "com". That last one is the cause of URLs that contain
email addresses being split from "user@example.org" into "user@example"
and a suffix of "com".</p></div>
<div class="paragraph"><p>You can modify <span class="monospaced">LiftRules.explicitlyParsedSuffixes</span> to be whatever set
of values you want.</p></div>
<div class="paragraph"><p>Note that if the suffix is not in <span class="monospaced">explicitlyParsedSuffixes</span>, the suffix
will be an empty String and the <span class="monospaced">name</span> (in the above example) will be
the file name with the suffix still attached.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_29">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Source for
<a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/HttpHelpers.scala">HttpHelpers.scala</a>
where you can find the default list of known suffixes.
</p>
</li>
<li>
<p>
Mailing list discussion
<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/zj8kazJPzmI">RestHelper
GET strips off .com when GETting email as parameter with .com address</a>.
</p>
</li>
<li>
<p>
<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/h5-LdtRDfiw">REST
helper: how to get file extension</a> mailing list discussion.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_failing_to_match_on_a_file_suffix">Failing to match on a file suffix</h3>
<div class="sect3">
<h4 id="_problem_30">Problem</h4>
<div class="paragraph"><p>You&#8217;re trying to match on a file suffix (extension), but your match is
failing.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_29">Solution</h4>
<div class="paragraph"><p>Ensure the suffix you&#8217;re matching on is included in
<span class="monospaced">LiftRules.explicitlyParsedSuffixes</span>.</p></div>
<div class="paragraph"><p>As an example, perhaps you want to match anything ending in <span class="monospaced">.csv</span> at
your <span class="monospaced">/reports/</span> URL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">Req</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"reports"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> name <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span><span style="color: #990000">,</span> <span style="color: #FF0000">"csv"</span><span style="color: #990000">,</span> GetRequest<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #000000">Text</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Here's your CSV report for "</span><span style="color: #990000">+</span>name<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>You&#8217;re expecting <span class="monospaced">/reports/foo.csv</span> to produce "Here&#8217;s your CSV report
for foo", but you get a 404.</p></div>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> add the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>LiftRules<span style="color: #990000">.</span>explicitlyParsedSuffixes <span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"csv"</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_28">Discussion</h4>
<div class="paragraph"><p>This is the flip side of the <em>Missing file suffix</em> recipe: Lift only
splits out the suffixes it knows about in
<span class="monospaced">LiftRules.explicitlyParsedSuffixes</span>.</p></div>
<div class="paragraph"><p>Without adding ".csv" to the <span class="monospaced">explicitlyParsedSuffixes</span>, the example URL
would match with&#8230;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">Req</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"reports"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> name <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span><span style="color: #990000">,</span> <span style="color: #FF0000">""</span><span style="color: #990000">,</span> GetRequest<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;with <span class="monospaced">name</span> set to "foo.csv" not "foo".</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_30">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="Missing+file+suffix.html">Missing file suffix</a> recipe.
</p>
</li>
<li>
<p>
<a href="https://groups.google.com/d/topic/liftweb/UwZQ8f2MmLE/discussion">REST
Requst suffix matching</a> mailing list discussion.
</p>
</li>
<li>
<p>
<a href="http://simply.liftweb.net/index-5.2.html">REST the hard way</a>, section
5.2 of <em>Simply Lift</em>.
</p>
</li>
<li>
<p>
<a href="http://simply.liftweb.net/index-5.3.html">Making it easier with
RestHelper</a>, section 5.3 of <em>Simply Lift</em>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_accept_binary_data_in_a_rest_service">Accept binary data in a REST service</h3>
<div class="sect3">
<h4 id="_problem_31">Problem</h4>
<div class="paragraph"><p>You want to accept an image upload or other binary data in your RESTful
service.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_30">Solution</h4>
<div class="paragraph"><p>Access the request body in your rest helper:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>rest<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> MyUpload <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> RestHelper <span style="color: #FF0000">{</span>
  serve <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"upload"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span> Post req <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #FF0000">{</span>
        bodyBytes <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> req<span style="color: #990000">.</span>body <span style="color: #990000">?~</span> <span style="color: #FF0000">"No Body Bytes"</span>
      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">yield</span></span> <span style="color: #990000">&lt;</span>b<span style="color: #990000">&gt;</span>got an image of <span style="color: #FF0000">{</span>bodyBytes<span style="color: #990000">.</span>length<span style="color: #FF0000">}</span> bytes<span style="color: #990000">&lt;/</span>b<span style="color: #990000">&gt;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Wire this into your application in <span class="monospaced">Boot.scala</span>, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">LiftRules.statelessDispatchTable.append</span></span><span style="color: #990000">(</span>code<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>MyUpload<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Test this service using a tool like cURL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">\</span>$ curl <span style="color: #990000">-</span>X POST <span style="color: #990000">--</span>data<span style="color: #990000">-</span>binary <span style="color: #FF0000">"@dog.jpg"</span> <span style="color: #990000">\</span>
  <span style="color: #990000">-</span>H <span style="color: #FF0000">'Content-Type: image/jpg'</span> http<span style="font-weight: bold"><span style="color: #0000FF">:</span></span><span style="font-style: italic"><span style="color: #9A1900">//127.0.0.1:8080/upload</span></span>
<span style="color: #990000">&lt;?</span>xml version<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"1.0"</span> encoding<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"UTF-8"</span><span style="color: #990000">?&gt;</span>
<span style="color: #990000">&lt;</span>b<span style="color: #990000">&gt;</span>got an image of <span style="color: #993399">43685</span> bytes<span style="color: #990000">&lt;/</span>b<span style="color: #990000">&gt;</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_29">Discussion</h4>
<div class="paragraph"><p>In the above example the binary data is accessed via the <span class="monospaced">req.body</span>,
yielding a <span class="monospaced">Box[LiftResponse]</span> which in this case is XML.</p></div>
<div class="paragraph"><p>In the case where there is no body, a 404 would be returned with a text
body of "No Body Bytes".</p></div>
<div class="paragraph"><p>Note that web containers, such as Jetty and Tomcat, may place limits on
the size of an upload. You will recognise this situation by an error
such as "java.lang.IllegalStateException: Form too large705784&gt;200000".
Check with documentation for the container for changing these limits.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_31">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/6MnWRPP3TcU">Mailing
list discussion</a> including code for restricting a request based on mime
type.
</p>
</li>
<li>
<p>
<a href="http://stackoverflow.com/questions/3861455/form-too-large-exception">Form
too large in Jetty</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_returning_json">Returning JSON</h3>
<div class="sect3">
<h4 id="_problem_32">Problem</h4>
<div class="paragraph"><p>You want to return JSON from a REST call.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_31">Solution</h4>
<div class="paragraph"><p>Use the JSON DSL. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> code<span style="color: #990000">.</span>lib

<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>rest<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>json<span style="color: #990000">.</span>JObject
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>json<span style="color: #990000">.</span>JsonDSL<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> QuotationAPI <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> RestHelper <span style="color: #FF0000">{</span>

 serve <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"quotation"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span> JsonGet <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
   <span style="color: #990000">(</span><span style="color: #FF0000">"text"</span> <span style="color: #990000">-&gt;</span> <span style="color: #FF0000">"A beach house isn't just real estate. It's a state of mind."</span><span style="color: #990000">)</span> <span style="color: #990000">~</span>
   <span style="color: #990000">(</span><span style="color: #FF0000">"by"</span> <span style="color: #990000">-&gt;</span> <span style="color: #FF0000">"Douglas Adams"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> JObject
 <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Wire this into <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">LiftRules.statelessDispatch.append</span></span><span style="color: #990000">(</span>code<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>QuotationAPI<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Running this example produces:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl -H 'Content-type: text/json' http://127.0.0.1:8080/quotation
{
  "text":"A beach house isn't just real estate. It's a state of mind.",
  "by":"Douglas Adams"
}</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_30">Discussion</h4>
<div class="paragraph"><p>The "type ascription" at the end of the JSON expression (<span class="monospaced">: JObject</span>)
tells the compiler that the expression is expected to be of type
<span class="monospaced">JObject</span>. This is required to allow the DSL to work. If would not be
required if, for example, you were calling a function that was defined
to return a <span class="monospaced">JObject</span>.</p></div>
<div class="paragraph"><p>The JSON DSL allows you to created nested structures, lists and
everything else you expect of JSON. The <em>Readme</em> in the <em>See Also</em>
section is a great place to read about the library.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_32">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="https://github.com/lift/framework/tree/master/core/json">Lift JSON
Readme</a> is a great source of documentation and examples of using the
JSON package in Lift.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_javascript_ajax_comet">Javascript, Ajax, Comet</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_trigger_server_side_code_from_a_button_press">Trigger server-side code from a button press</h3>
<div class="sect3">
<h4 id="_problem_33">Problem</h4>
<div class="paragraph"><p>You want to trigger some server-side code when the user presses a
button.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_32">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">ajaxInvoke</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Helpers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>SHtml
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>js<span style="color: #990000">.</span>JsCmds

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">MySnippet</span> <span style="color: #FF0000">{</span>

 <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> easy <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"#myButton [onclick]"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">SHtml.ajaxInvoke(</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">JsCmds.Alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hi"</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">}</span> <span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In this snippet we are binding the click event of a button with the id
of "myButton" to an <span class="monospaced">ajaxInvoke</span>: when the button is pressed, Lift
arranges for the function you gave <span class="monospaced">ajaxInvoke</span> to be executed.</p></div>
<div class="paragraph"><p>In this example, we are printing "click" to the console and returning a
JavaScript alert dialog. The corresponding HTML might be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:MySnippet.easy"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;button</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"myButton"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Click me<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_31">Discussion</h4>
<div class="paragraph"><p>The signature of the function you pass to <span class="monospaced">ajaxInvoke</span> is
<span class="monospaced">Unit =&gt; JsCmd</span>, meaning you can trigger a range of behaviours, from
returning <span class="monospaced">Noop</span> if you want nothing to happen, through changing DOM
element, all the way up to executing arbitrary JavaScript.</p></div>
<div class="paragraph"><p>The example above is using a button, but will work on any element that
has an event you can bind to.</p></div>
<div class="paragraph"><p>Related to <span class="monospaced">ajaxInvoke</span> are the following functions:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">SHtml.onEvent</span>, which has the signature <span class="monospaced">String =&gt; JsCmd</span> because it
is passed the <span class="monospaced">value</span> of the node it is attached to. In the above
example, this would be the empty string as the button has no value.
</p>
</li>
<li>
<p>
<span class="monospaced">SHtml.ajaxCall</span> which is more general than <span class="monospaced">onEvent</span>, as you give it
the expression you want passed to your server-side code.
</p>
</li>
<li>
<p>
<span class="monospaced">SHtml.jsonCall</span> which is even more general: you give it a function
that will return a JSON object when executed on the client, and this
object will be passed to your server-side function.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_see_also_33">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The "<a href="http://blog.fmpwizard.com/scala-lift-custom-wizard">Call Scala
code from JavaScript</a>" section of a blog post from Diego Medina.
</p>
</li>
<li>
<p>
<a href="http://exploring.liftweb.net/onepage/index.html#toc-Section-11">AJAX
and Comment in Lift</a> in <em>Exploring Lift</em>.
</p>
</li>
<li>
<p>
Chapter 9 of <em>Lift in Action</em>.
</p>
</li>
<li>
<p>
<em>Simply Lift</em> on
<a href="http://simply.liftweb.net/index-4.8.html#toc-Section-4.8">Ajax</a>.
</p>
</li>
<li>
<p>
Mailing list discussion on the
<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/N7ttFlumvuk">easiest
way to trigger server-side Scala code</a>.
</p>
</li>
<li>
<p>
<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/uAgy21xOMRs">Bind
a button click with SHtml.onEvent</a> mailing list thread.
</p>
</li>
<li>
<p>
<a href="https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/SHtml.scala">SHtml.scala source code</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_set_up_client_side_actions_from_your_scala_code">Set up client-side actions from your Scala code</h3>
<div class="sect3">
<h4 id="_problem_34">Problem</h4>
<div class="paragraph"><p>In your Lift code you want to set up a action that is run purely in
client-side JavaScript.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_33">Solution</h4>
<div class="paragraph"><p>Bind the appropriate event hander with Javascript. Here&#8217;s an example
where we make a button slowly fade away when you press it, but notice
that we&#8217;re setting up this binding in our server-side Lift code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">HelloWorld</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> buttonBind <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
    <span style="color: #FF0000">"#button [onclick]"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">"$('#button').fadeOut('slow')"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In the template we&#8217;d perhaps say:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:HelloWorld.buttonBind"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"button"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"button"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Click me"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Lift will render the page as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">onclick</span><span style="color: #990000">=</span><span style="color: #FF0000">"$('#button').fadeOut('slow')"</span>
    <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Click me"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"button"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"button"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_32">Discussion</h4>
<div class="paragraph"><p>Lift includes a JavaScript abstraction which you can use to build up
more elaborate expressions for the client-side. For example you can
combine basic commands:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> buttonBind <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="color: #FF0000">"#button [onclick]"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #990000">(</span>
     <span style="font-weight: bold"><span style="color: #000000">Alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Here we go..."</span><span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="font-weight: bold"><span style="color: #000000">RedirectTo</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"http://liftweb.net"</span><span style="color: #990000">)</span>
    <span style="color: #990000">).</span>toJsCmd</tt></pre></div></div>
<div class="paragraph"><p>&#8230;which pops up an alert dialog and then sends you to liftweb.net.
<em>Exploring Lift</em> gives a good summary of the commands available to you.</p></div>
<div class="paragraph"><p>Another option is to use <span class="monospaced">JE.Call</span> to execute a Javascript function with
parameters. Suppose we have this function defined:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">greet</span></span><span style="color: #990000">(</span>who<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello "</span><span style="color: #990000">+</span>who<span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We could bind a client-side button press to this client-side function
like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> buttonBind <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="color: #FF0000">"#button [onclick]"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">JE.Call</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"greet"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"you"</span><span style="color: #990000">).</span>toJsCmd</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_34">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="https://groups.google.com/d/msg/liftweb/uAgy21xOMRs/bDjS69VWpp4J">mailing list discussion</a> that suggested this.
</p>
</li>
<li>
<p>
<a href="http://exploring.liftweb.net/master/index-10.html#toc-Chapter-10">Chapter 10</a> of <em>Exploring Lift</em>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_focus_on_a_field_on_page_load">Focus on a field on page load</h3>
<div class="sect3">
<h4 id="_problem_35">Problem</h4>
<div class="paragraph"><p>When a page loads you want the browser to select a particular field for
input focus from the user&#8217;s keyboard.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_34">Solution</h4>
<div class="paragraph"><p>Wrap your snippet with <span class="monospaced">FocusOnLoad</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>js<span style="color: #990000">.</span>JsCmds<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="color: #990000">...</span>
<span style="color: #FF0000">"name=username"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">FocusOnLoad(SHtml.text</span></span><span style="color: #990000">(</span>username<span style="color: #990000">,</span> username <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The above will match against <span class="monospaced">name="username"</span> element in the HTML and
replace it with a text input field that will be focused on automatically
when the page loads.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_33">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">FocusOnLoad</span> is an example of a <span class="monospaced">NodeSeq =&gt; NodeSeq</span> transformation. In
this case, it takes the result of <span class="monospaced">SHtml.text</span> and appends it with the
JavasScript required to set focus on that field. The example uses
<span class="monospaced">SHtml.text</span> but it could be any <span class="monospaced">NodeSeq</span>.</p></div>
<div class="paragraph"><p>Related classes are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">Focus</span>, which takes an element id and sets focus on the element via a
<span class="monospaced">JsCmd</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">SetValueAndFocus</span> which is like <span class="monospaced">Focus</span> but takes an additional
<span class="monospaced">String</span> value to set on the element.
</p>
</li>
</ul></div>
<div class="paragraph"><p>These two are useful if you need to set focus from Ajax or Comet
components, or any JavaScript Lift response.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_35">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://exploring.liftweb.net/master/index-10.html#toc-Chapter-10">Lift
and JavaScript</a>, <em>Exploring Lift</em>, chapter 10.
</p>
</li>
<li>
<p>
<a href="http://groups.google.com/group/liftweb/browse_thread/thread/c513317f7b01b40a/a95a0426c7e17a46?lnk=gst&amp;q=FocusOnLoad#">FocusOnLoad
for fields you&#8217;re creating in a snippet</a>
</p>
</li>
<li>
<p>
<a href="http://groups.google.com/group/liftweb/browse_thread/thread/541e6f3a156ccc47/fc501899e7537290?lnk=gst&amp;q=FocusOnLoad#fc501899e7537290">FocusOnLoad
in LiftScreen</a>
</p>
</li>
<li>
<p>
<a href="http://stackoverflow.com/questions/3852122/how-do-i-keep-focus-on-a-textbox-using-lift-the-scala-framework">How
do I keep focus on a textbox?</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/js/JsCommands.scala">JsCommands.scala
source</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_add_css_class_to_an_ajax_form">Add CSS class to an Ajax Form</h3>
<div class="sect3">
<h4 id="_problem_36">Problem</h4>
<div class="paragraph"><p>You want to set the CSS class of an AJAX form.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_35">Solution</h4>
<div class="paragraph"><p>Name the class via <span class="monospaced">?class=</span> query parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:form.ajax?class=myClass"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_34">Discussion</h4>
<div class="paragraph"><p>If you need to set multiple CSS classes, encode a space between the
class names, e.g., <span class="monospaced">class=myClass%20anotherClass</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_36">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<em>Simply Lift</em> on <a href="http://simply.liftweb.net/index-4.8.html">Ajax</a>.
</p>
</li>
<li>
<p>
Mailing list on <a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/EEINT9t8Wd4">Attaching
CSS class to ajax form using designer friendly template doesn&#8217;t work</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_show_a_template_inside_a_page_dynamically">Show a template inside a page dynamically</h3>
<div class="sect3">
<h4 id="_problem_37">Problem</h4>
<div class="paragraph"><p>You want to load an entire page with template and snippets inside of
another template on the fly (i.e., without a browser refresh).</p></div>
</div>
<div class="sect3">
<h4 id="_solution_36">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">Template</span> to load the template, and <span class="monospaced">SetHtml</span> to place the content
on the page.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> code<span style="color: #990000">.</span>snippet

<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> Helpers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> js<span style="color: #990000">.</span>JsCmds<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">MySnippet</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> sendContent <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Templates</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"some"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #FF0000">"page"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span><span style="color: #990000">).</span>
    <span style="font-weight: bold"><span style="color: #000000">map</span></span><span style="color: #990000">(</span>ns <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">SetHtml</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"here"</span><span style="color: #990000">,</span> ns<span style="color: #990000">))</span> openOr Noop

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> render <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"name=clickme [onclick]"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">SHtml.ajaxInvoke</span></span><span style="color: #990000">(</span>sendContent <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Combine this with:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:MySnippet"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;button</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"clickme"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Click Me<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"here"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Content will appear here<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Clicking the button will cause the content of <span class="monospaced">/some/page.html</span> to be
loaded into the <span class="monospaced">here</span> div.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_35">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">Templates</span> produces a <span class="monospaced">Box[NodeSeq]</span>, the contents of which are mapped
to a <span class="monospaced">JsCmd</span> which is sent back to the browser to put the contents of
the page into the div.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_37">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://scala-tools.org/mvnsites/liftweb-2.4/net/liftweb/http/js/JsCmds$$SetHtml.html">SetHtml</a>
documentation.
</p>
</li>
<li>
<p>
<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/C5UhQn5blHk">Loading Pages With Templates from Other Pages</a> mailing list discussion.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pipeline">Pipeline</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter deals with solutions relating to the Lift processing
pipeline.</p></div>
<div class="paragraph"><p>You can get a great overview of the pipeline, including diagrams, from
<em>Exploring Lift</em> at <a href="http://exploring.liftweb.net/master/index-9.html#toc-Section-9.2">http://exploring.liftweb.net/master/index-9.html#toc-Section-9.2</a>
and also from from the Lift pipeline Wiki page at
<a href="http://www.assembla.com/spaces/liftweb/wiki/HTTP_Pipeline">http://www.assembla.com/spaces/liftweb/wiki/HTTP_Pipeline</a>.</p></div>
<div class="sect2">
<h3 id="_streaming_content">Streaming Content</h3>
<div class="sect3">
<h4 id="_problem_38">Problem</h4>
<div class="paragraph"><p>You want to stream content back to the web client.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_37">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">OutputStreamResponse</span>, passing it a function that will write to the
<span class="monospaced">OutputStream</span> that Lift supplies.</p></div>
<div class="paragraph"><p>In this example we&#8217;ll stream all the integers from 1:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span><span style="color: #FF0000">{</span>Req<span style="color: #990000">,</span>OutputStreamResponse<span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>rest<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Numbers <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> RestHelper <span style="color: #FF0000">{</span>

  <span style="font-style: italic"><span style="color: #9A1900">// Generate numbers, converted to Array[Byte]</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> infinite <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Stream.from(1).map</span></span><span style="color: #990000">(</span>num2bytes<span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">num2bytes</span></span><span style="color: #990000">(</span>x<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #990000">(</span>x <span style="color: #990000">+</span> <span style="color: #FF0000">"</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">getBytes</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"utf-8"</span><span style="color: #990000">)</span>

  serve <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">Req</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"numbers"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #000000">OutputStreamResponse(</span></span> <span style="color: #990000">(</span>out<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">infinite.foreach</span></span><span style="color: #990000">(</span>out<span style="color: #990000">.</span>write<span style="color: #990000">)</span> <span style="color: #990000">)</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Wire this into Lift in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">LiftRules.dispatch.append</span></span><span style="color: #990000">(</span>Numbers<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Visiting <em>http://127.0.0.1:8080/numbers</em> will generate a 200 status code
and start producing the integers from 1.</p></div>
<div class="paragraph"><p>For more control over status codes, headers and cookies, there are a
variety of signatures for the <span class="monospaced">OutputStreamResponse</span> object. For the
most control, create an instance of the <span class="monospaced">OutputStreamResponse</span> class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">OutputStreamResponse</span><span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #000000">out:</span></span> <span style="color: #990000">(</span>OutputStream<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> Unit<span style="color: #990000">,</span>
  size<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Long</span><span style="color: #990000">,</span>
  headers<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #000000">List[</span></span><span style="color: #990000">(</span>String<span style="color: #990000">,</span> String<span style="color: #990000">)],</span>
  cookies<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> List<span style="color: #990000">[</span>HTTPCookie<span style="color: #990000">],</span>
  code<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_36">Discussion</h4>
<div class="paragraph"><p>The function you give as the first argument to <span class="monospaced">OutputStreamResponse</span> is
called with the output stream to the client. This means that the bytes
you are writing to the <span class="monospaced">out</span> stream are being written to the client.</p></div>
<div class="paragraph"><p>Any headers you set (such as <span class="monospaced">Content-type</span>), or status code, may
already have been set by the time your function is called. Note that
setting <span class="monospaced">size</span> to <span class="monospaced">-1</span> causes the <span class="monospaced">Content-length</span> header to be skipped.</p></div>
<div class="paragraph"><p>There are two related types of response: <span class="monospaced">InMemoryResponse</span> and
<span class="monospaced">StreamingResponse</span></p></div>
<div class="sect4">
<h5 id="_inmemoryresponse">InMemoryResponse</h5>
<div class="paragraph"><p><span class="monospaced">InMemoryResponse</span> is useful if you have already assembled the full
content to send to the client. The signature is straightforward:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">InMemoryResponse</span><span style="color: #990000">(</span>
  data<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Array<span style="color: #990000">[</span><span style="color: #009900">Byte</span><span style="color: #990000">],</span>
  headers<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #000000">List[</span></span><span style="color: #990000">(</span>String<span style="color: #990000">,</span> String<span style="color: #990000">)],</span>
  cookies<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> List<span style="color: #990000">[</span>HTTPCookie<span style="color: #990000">],</span>
  code<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_streamingresponse">StreamingResponse</h5>
<div class="paragraph"><p><span class="monospaced">StreamingResponse</span> pulls bytes into the output stream. This contrasts
with <span class="monospaced">OutputStreamResponse</span>, where you are pushing data to the client.</p></div>
<div class="paragraph"><p>Construct this type of response by providing a method that can be read
from:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">StreamingResponse</span><span style="color: #990000">(</span>
  data<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #FF0000">{</span><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">(</span>buf<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Array<span style="color: #990000">[</span><span style="color: #009900">Byte</span><span style="color: #990000">])</span><span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="font-weight: bold"><span style="color: #000000">onEnd:</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> Unit<span style="color: #990000">,</span>
  size<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Long</span><span style="color: #990000">,</span>
  headers<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #000000">List[</span></span><span style="color: #990000">(</span>String<span style="color: #990000">,</span> String<span style="color: #990000">)],</span>
  cookies<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> List<span style="color: #990000">[</span>HTTPCookie<span style="color: #990000">],</span>
  code<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Notice the use of a structural type for the <span class="monospaced">data</span> parameter. Anything
with a matching <span class="monospaced">read</span> method can be given here, including
<span class="monospaced">java.io.InputStream</span>-like objects, meaning <span class="monospaced">StreamingResponse</span> can act
as a pipe from input to output. Lift pulls 8k chunks from your
<span class="monospaced">StreamingResponse</span> to send to the client.</p></div>
<div class="paragraph"><p>Your <span class="monospaced">data</span> <span class="monospaced">read</span> function should follow the semantics of Java IO and
return "the total number of bytes read into the buffer, or -1 is there
is no more data because the end of the stream has been reached".</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_38">See Also</h4>
<div class="paragraph"><p>The contract for Java IO is described at <a href="http://docs.oracle.com/javase/6/docs/api/java/io/InputStream.html">http://docs.oracle.com/javase/6/docs/api/java/io/InputStream.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_serving_a_file_with_access_control">Serving a File with Access Control</h3>
<div class="sect3">
<h4 id="_problem_39">Problem</h4>
<div class="paragraph"><p>You have a file on disk, you want to allow a user to download it, but
only if they are allowed to. If they are not allowed to, you
want to explain why.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_38">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">RestHelper</span> to serve the file or an explanation page.</p></div>
<div class="paragraph"><p>For example,
suppose we have the file <em>/tmp/important</em> and we only want selected
requests to download that file from the <em>/download/important</em> URL. The
structure for that would be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">object</span></span> DownloadService <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> RestHelper <span style="color: #FF0000">{</span>

  <span style="font-style: italic"><span style="color: #9A1900">// Code explained below to go here</span></span>

  serve <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"download"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="font-weight: bold"><span style="color: #000000">Known</span></span><span style="color: #990000">(</span>fileId<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span> Get req <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>permitted<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #000000">fileResponse</span></span><span style="color: #990000">(</span>fileId<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
        <span style="font-weight: bold"><span style="color: #000000">Full(RedirectResponse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"/sorry"</span><span style="color: #990000">))</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We are allowing users to download "known" files. That is, files which we
approve of for access. We do this because opening up the file system to
any unfiltered end-user input pretty much means your server will be
compromised.</p></div>
<div class="paragraph"><p>For our example, <span class="monospaced">Known</span> is checking a static list of names:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> knownFiles <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">List</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"important"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Known <span style="color: #FF0000">{</span>
 <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">unapply</span></span><span style="color: #990000">(</span>fileId<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Option<span style="color: #990000">[</span>String<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">knownFiles.find</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">==</span></span> fileId<span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>For requests to these known resources, we convert the REST request into
a <span class="monospaced">Box[LiftResponse]</span>. For permitted access we serve up the file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> permitted <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> scala<span style="color: #990000">.</span>math<span style="color: #990000">.</span>random <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span><span style="color: #990000">.</span>5d

<span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">fileResponse</span></span><span style="color: #990000">(</span>fileId<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Box<span style="color: #990000">[</span>LiftResponse<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #FF0000">{</span>
    file <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> Box <span style="color: #990000">!!</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">java.io.File</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"/tmp/"</span><span style="color: #990000">+</span>fileId<span style="color: #990000">)</span>
    input <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> <span style="font-weight: bold"><span style="color: #000000">tryo</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">java.io.FileInputStream</span></span><span style="color: #990000">(</span>file<span style="color: #990000">))</span>
 <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">yield</span></span> <span style="font-weight: bold"><span style="color: #000000">StreamingResponse</span></span><span style="color: #990000">(</span>input<span style="color: #990000">,</span>
    <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> input<span style="color: #990000">.</span>close<span style="color: #990000">,</span>
    file<span style="color: #990000">.</span>length<span style="color: #990000">,</span>
    <span style="color: #990000">(</span><span style="color: #FF0000">"Content-Disposition"</span> <span style="color: #990000">-&gt;</span> <span style="color: #FF0000">"attachment; filename="</span><span style="color: #990000">+</span>fileId<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span><span style="color: #990000">,</span>
    <span style="color: #009900">Nil</span><span style="color: #990000">,</span> <span style="color: #993399">200</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>If no permission is given, the user is redirected to <span class="monospaced">/sorry.html</span>.</p></div>
<div class="paragraph"><p>All of this is wired into Lift in <span class="monospaced">Boot.scala</span> with:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">LiftRules.dispatch.append</span></span><span style="color: #990000">(</span>DownloadService<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_37">Discussion</h4>
<div class="paragraph"><p>By turning the request into a <span class="monospaced">Box[LiftResponse]</span> we are able to serve
up the file, send the user to a different page, and also allow Lift to
handle the 404 (<span class="monospaced">Empty</span>) cases.</p></div>
<div class="paragraph"><p>If we added a test to see if the file existed on disk in <span class="monospaced">fileResponse</span>
that would cause the method to evaluate to <span class="monospaced">Empty</span> for missing files,
which triggers a 404. As the code stands, if the file does not exist,
the <span class="monospaced">tryo</span> would give us a <span class="monospaced">Failure</span> which would turn into a 404 error
with a body of "/tmp/important (No such file or directory)".</p></div>
<div class="paragraph"><p>Because we are testing for known resources via the <span class="monospaced">Known</span> extractor as
part of the pattern for <em>/download/</em>, unknown resources will not be
passed through to our <span class="monospaced">File</span> access code. Again, Lift will return a 404
for these.</p></div>
<div class="paragraph"><p>Guard expressions can also be useful for these kinds of situations:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>serve <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"download"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="font-weight: bold"><span style="color: #000000">Known</span></span><span style="color: #990000">(</span>id<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span> Get <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> permitted <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">fileResponse</span></span><span style="color: #990000">(</span>id<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"download"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> Get req <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">RedirectResponse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"/sorry"</span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>You can mix and match extractors, guards and conditions in your response
to best fit the way you want the code to look and work.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_39">See Also</h4>
<div class="paragraph"><p>This recipe comes from the <em>PHP&#8217;s readfile equivalent for Lift</em> discussion on the Lift mailing list: <a href="https://groups.google.com/d/topic/liftweb/7N2OUInltUE/discussion">https://groups.google.com/d/topic/liftweb/7N2OUInltUE/discussion</a>.</p></div>
<div class="paragraph"><p><em>Chatper 24: Extractors</em> from <em>Programming in Scala</em>: <a href="http://www.artima.com/pins1ed/extractors.html">http://www.artima.com/pins1ed/extractors.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_access_restriction_by_http_header">Access Restriction by HTTP header</h3>
<div class="sect3">
<h4 id="_problem_40">Problem</h4>
<div class="paragraph"><p>You need to control access to a page based on the value of a HTTP
header.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_39">Solution</h4>
<div class="paragraph"><p>Use a custom <span class="monospaced">If</span> in SiteMap:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> HeaderRequired <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">If</span></span><span style="color: #990000">(</span>
  <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">S.request.map(_.header</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ALLOWED"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">==</span></span> <span style="font-weight: bold"><span style="color: #000000">Full</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"YES"</span><span style="color: #990000">))</span> openOr <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"Access not allowed"</span>
<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">// Build SiteMap</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> entries <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">List</span></span><span style="color: #990000">(</span>
      <span style="font-weight: bold"><span style="color: #000000">Menu.i</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Restricted"</span><span style="color: #990000">)</span> <span style="color: #990000">/</span> <span style="color: #FF0000">"restricted"</span> <span style="color: #990000">&gt;&gt;</span> HeaderRequired
<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>In this example <em>restricted.html</em> can only be viewed if the request
includes a HTTP header called <span class="monospaced">ALLOWED</span> with a value of <span class="monospaced">Yes</span>. Any other
request for the page will be redirected with a Lift error notice of
"Access not allowed".</p></div>
<div class="paragraph"><p>This can be tested from the command line using a tool like cURL:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://127.0.0.1:8080/restricted.html -H "ALLOWED:YES"</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_38">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">If</span> test ensures the <span class="monospaced">() =&gt; Boolean</span> function you supply as a first
argument returns <span class="monospaced">true</span> before the page it applies to is shown. The
second argument is what Lift does if the test isn&#8217;t true, and should be
a <span class="monospaced">() =&gt; LiftResponse</span> function, meaning you can return whatever you
like, including redirects to other pages.</p></div>
<div class="paragraph"><p>In the example we are making use of a convenient implicit conversation
from a <span class="monospaced">String</span> ("Access not allowed") to a redirection that will take
the user to the home page (actually
<span class="monospaced">LiftRules.siteMapFailRedirectLocation</span>) with a notice which shows the
string.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_40">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Chapter 7, "SiteMap and access control" in <em>Lift in Action</em>.
</p>
</li>
<li>
<p>
[Chapter 7 of <em>Exploring Lift</em>: <a href="http://exploring.liftweb.net/onepage/index.html#toc-Chapter-7">http://exploring.liftweb.net/onepage/index.html#toc-Chapter-7</a>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This recipe is derived from the <em>Testing a Loc for a HTTP Header Value for Access Control</em> mailing list discussion: <a href="https://groups.google.com/d/topic/liftweb/CtSGkPbgEVw/discussion">https://groups.google.com/d/topic/liftweb/CtSGkPbgEVw/discussion</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_debugging_a_request">Debugging a Request</h3>
<div class="sect3">
<h4 id="_problem_41">Problem</h4>
<div class="paragraph"><p>You want to debug a request and see what&#8217;s arriving to your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_40">Solution</h4>
<div class="paragraph"><p>Add an <span class="monospaced">onBeginServicing</span> function in <span class="monospaced">Boot.scala</span> to log the request.
For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>LiftRules<span style="color: #990000">.</span>onBeginServicing<span style="color: #990000">.</span>append <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> r <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Received: "</span><span style="color: #990000">+</span>r<span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_39">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">onBeginServicing</span> call is called early in the Lift pipeline, before
<span class="monospaced">S</span> is set up, and before Lift has the chance to 404 your request. The
function signature it expects is <span class="monospaced">Req =&gt; Unit</span>.</p></div>
<div class="paragraph"><p>If you want to select only certain paths, you can. For example, to track
all requests starting <em>/paypal</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>LiftRules<span style="color: #990000">.</span>onBeginServicing<span style="color: #990000">.</span>append <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> r <span style="font-weight: bold"><span style="color: #0000FF">@</span></span> <span style="font-weight: bold"><span style="color: #000000">Req(List</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"paypal"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span>r<span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>There is also an <span class="monospaced">onEndServicing</span> which can be given functions of type
<span class="monospaced">(Req, Box[LiftResponse]) =&gt; Unit</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_41">See Also</h4>
<div class="paragraph"><p>There are various hooks into the Lift pipeline, and further explanation on the mailing list.  For example, <em>What&#8217;s the difference between LiftRules.early and LiftRules.onBeginServicing and when does S.locale get initialized?</em> from the Lift mailing list: <a href="https://groups.google.com/d/topic/liftweb/K0S1rU0qtX0/discussion">https://groups.google.com/d/topic/liftweb/K0S1rU0qtX0/discussion</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="OnSession">Running Code when Sessions are Created (or Destroyed)</h3>
<div class="sect3">
<h4 id="_problem_42">Problem</h4>
<div class="paragraph"><p>You want to carry out actions when a session is created or destroyed.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_41">Solution</h4>
<div class="paragraph"><p>Make use of the hooks in <span class="monospaced">LiftSession</span>. For example, in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>LiftSession<span style="color: #990000">.</span>afterSessionCreate <span style="font-weight: bold"><span style="color: #0000FF">::=</span></span>
 <span style="color: #990000">(</span> <span style="color: #990000">(</span>s<span style="font-weight: bold"><span style="color: #0000FF">:</span></span>LiftSession<span style="color: #990000">,</span> r<span style="font-weight: bold"><span style="color: #0000FF">:</span></span>Req<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Session created"</span><span style="color: #990000">)</span> <span style="color: #990000">)</span>

LiftSession<span style="color: #990000">.</span>onBeginServicing <span style="font-weight: bold"><span style="color: #0000FF">::=</span></span>
 <span style="color: #990000">(</span> <span style="color: #990000">(</span>s<span style="font-weight: bold"><span style="color: #0000FF">:</span></span>LiftSession<span style="color: #990000">,</span> r<span style="font-weight: bold"><span style="color: #0000FF">:</span></span>Req<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Processing request"</span><span style="color: #990000">)</span> <span style="color: #990000">)</span>

LiftSession<span style="color: #990000">.</span>onShutdownSession <span style="font-weight: bold"><span style="color: #0000FF">::=</span></span>
 <span style="color: #990000">(</span> <span style="color: #990000">(</span>s<span style="font-weight: bold"><span style="color: #0000FF">:</span></span>LiftSession<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Session going away"</span><span style="color: #990000">)</span> <span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_40">Discussion</h4>
<div class="paragraph"><p>The hooks in <span class="monospaced">LiftSession</span> allow you to insert code at various points in
the session lifecycle: when the session is created, at the start of
servicing the request, after servicing, when the session is about to
shutdown, at shutdown&#8230; the pipeline diagrams from the start of this chapter
is a useful guide to these stages.</p></div>
<div class="paragraph"><p>If the request path has been marked as being stateless via
<span class="monospaced">LiftRules.statelessReqTest</span>, the above example would only execute the
<span class="monospaced">onBeginServicing</span> functions.</p></div>
<div class="paragraph"><p>Note that the Lift session is not the same as the HTTP Session.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_42">See Also</h4>
<div class="paragraph"><p>These hooks are used in an example application to demonstrate how you might log a user out of your web application if they login via another browser:  <a href="https://github.com/dpp/starting_point/commit/729f05f9010b80139440369c4e1d0889cac346cf">https://github.com/dpp/starting_point/commit/729f05f9010b80139440369c4e1d0889cac346cf</a>.</p></div>
<div class="paragraph"><p>Session management is discussed in section 9.5 of <em>Exploring Lift</em>: <a href="http://exploring.liftweb.net/master/index-9.html#toc-Section-9.5">http://exploring.liftweb.net/master/index-9.html#toc-Section-9.5</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="ShutdownHooks">Run Code when Lift Shuts Down</h3>
<div class="sect3">
<h4 id="_problem_43">Problem</h4>
<div class="paragraph"><p>You want to have some code executed when your Lift application is
shutting down.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_42">Solution</h4>
<div class="paragraph"><p>Append to <span class="monospaced">LiftRules.unloadHooks</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">LiftRules.unloadHooks.append(</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Shutting down"</span><span style="color: #990000">)</span> <span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_41">Discussion</h4>
<div class="paragraph"><p>You append functions of type <span class="monospaced">() =&gt; Unit</span> and these functions are run
right at the end of the Lift handler, after sessions have been
destroyed, Lift actors have been shutdown, and requests have finished
being handled. This is triggered, in the words of the Java servlet
specification, "by the web container to indicate to a filter that it is
being taken out of service".</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_43">See Also</h4>
<div class="paragraph"><p><a href="#RunTasksPeriodically">[RunTasksPeriodically]</a> includes an example of using a unload hook.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RunningStateless">Running Stateless</h3>
<div class="sect3">
<h4 id="_problem_44">Problem</h4>
<div class="paragraph"><p>You want to force you application to be stateless at the HTTP level.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_43">Solution</h4>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>LiftRules<span style="color: #990000">.</span>enableContainerSessions <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
LiftRules<span style="color: #990000">.</span>statelessReqTest<span style="color: #990000">.</span>append <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>All requests will now be treated as stateless. Any attempt to use state,
such as via <span class="monospaced">SessionVar</span> for example, will trigger a warning in
developer mode: "Access to Lift&#8217;s statefull features from Stateless mode.
The operation on state will not complete."</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_42">Discussion</h4>
<div class="paragraph"><p>HTTP session creation is controlled via <span class="monospaced">enableContainerSessions</span>, and
applies for all requests. Leaving this value at the default (<span class="monospaced">true</span>)
allows more fine-grained control over which requests are stateless.</p></div>
<div class="paragraph"><p>Using <span class="monospaced">statelessReqTest</span> allows you to decide based on the
<span class="monospaced">StatelessReqTest</span> if it should be stateless (<span class="monospaced">true</span>) or not (<span class="monospaced">false</span>).
For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">asset</span></span><span style="color: #990000">(</span>file<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="font-weight: bold"><span style="color: #000000">List</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".js"</span><span style="color: #990000">,</span> <span style="color: #FF0000">".gif"</span><span style="color: #990000">,</span> <span style="color: #FF0000">".css"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">exists</span></span><span style="color: #990000">(</span>file<span style="color: #990000">.</span>endsWith<span style="color: #990000">)</span>

LiftRules<span style="color: #990000">.</span>statelessReqTest<span style="color: #990000">.</span>append <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">StatelessReqTest</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"index"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span><span style="color: #990000">,</span> httpReq<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>  <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">StatelessReqTest(List</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">,</span> file<span style="color: #990000">),</span>  <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">asset</span></span><span style="color: #990000">(</span>file<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This example would only make the index page and any GIFs, JavaScript and
CSS files stateless. The <span class="monospaced">httpReq</span> part is a <span class="monospaced">HTTPRequest</span> instance,
allowing you to base the decision on the content of the request
(cookies, user agent, etc).</p></div>
<div class="paragraph"><p>Another option is <span class="monospaced">LiftRules.statelessDispatch</span> which allows you to
register a function which returns a <span class="monospaced">LiftResponse</span>. This will be
executed without a session, and convenient for REST-based services.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_44">See Also</h4>
<div class="paragraph"><p>This stateless request control was introduced in Lift 2.2.  The announcement on the mailing list gives more details: <a href="https://groups.google.com/d/topic/liftweb/2rVMCnWppSo/discussion">https://groups.google.com/d/topic/liftweb/2rVMCnWppSo/discussion</a>.</p></div>
<div class="paragraph"><p>The Wiki page on stateless requests describes Lift&#8217;s behaviour if statefull actions are attempted: <a href="http://www.assembla.com/wiki/show/liftweb/Stateless_Requests">http://www.assembla.com/wiki/show/liftweb/Stateless_Requests</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_catch_any_exception">Catch Any exception</h3>
<div class="sect3">
<h4 id="_problem_45">Problem</h4>
<div class="paragraph"><p>You want a wrapper around all requests to catch exceptions and display
something to the user.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_44">Solution</h4>
<div class="paragraph"><p>Declare an exception handler in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>LiftRules<span style="color: #990000">.</span>exceptionHandler<span style="color: #990000">.</span>prepend <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #990000">(</span>runMode<span style="color: #990000">,</span> request<span style="color: #990000">,</span> exception<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #000000">logger.error</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Boom! At "</span><span style="color: #990000">+</span>request<span style="color: #990000">.</span>uri<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">InternalServerErrorResponse</span></span><span style="color: #990000">()</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In the above example, all exceptions for all requests at all run modes
are being matched, causing an error to be logged and a 500 (internal
server error) to be returned to the browser.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_43">Discussion</h4>
<div class="paragraph"><p>The partial function you add to <span class="monospaced">exceptionHandler</span> needs to return a
<span class="monospaced">LiftResponse</span> (i.e., something to send to the browser). The default
behaviour is to return an <span class="monospaced">XhtmlResponse</span>, which in
<span class="monospaced">Props.RunModes.Development</span> gives details of the exception, and in all
other run modes simply says "Something unexpected happened".</p></div>
<div class="paragraph"><p>You can return any kind of <span class="monospaced">LiftResponse</span>, including <span class="monospaced">RedirectResponse</span>,
<span class="monospaced">JsonResponse</span>, <span class="monospaced">XmlResponse</span>, <span class="monospaced">JavaScriptResponse</span> and so on.</p></div>
<div class="paragraph"><p>This second example shows matching on Ajax requests only, and returning
a JavaScript dialog to the browser:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>js<span style="color: #990000">.</span>JsCmds<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> ajax <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> LiftRules<span style="color: #990000">.</span>ajaxPath

LiftRules<span style="color: #990000">.</span>exceptionHandler<span style="color: #990000">.</span>prepend <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #990000">(</span>mode<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">Req</span></span><span style="color: #990000">(</span>ajax <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">,</span> PostRequest<span style="color: #990000">),</span> ex<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #000000">logger.error</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Error handing ajax"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">JavaScriptResponse(Alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Boom!"</span><span style="color: #990000">))</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This Ajax example will jump in before Lift&#8217;s default behaviour for Ajax
errors. The default is to retry the Ajax command three times
(<span class="monospaced">LiftRules.ajaxRetryCount</span>), and then execute
<span class="monospaced">LiftRules.ajaxDefaultFailure</span>, which will pop up a dialog saying: "The
server cannot be contacted at this time"</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_45">See Also</h4>
<div class="paragraph"><p>This recipe was derived from a mailing list discussion: <a href="http://groups.google.com/group/liftweb/browse_thread/thread/842954ffc333b0f9">http://groups.google.com/group/liftweb/browse_thread/thread/842954ffc333b0f9</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_accessing_span_class_monospaced_httpservletrequest_span">Accessing <span class="monospaced">HttpServletRequest</span></h3>
<div class="sect3">
<h4 id="_problem_46">Problem</h4>
<div class="paragraph"><p>To satisfy some API you need access to the <span class="monospaced">HttpServletRequest</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_45">Solution</h4>
<div class="paragraph"><p>Cast <span class="monospaced">S.request</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>S
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span>provider<span style="color: #990000">.</span>servlet<span style="color: #990000">.</span>HTTPRequestServlet
<span style="font-weight: bold"><span style="color: #000080">import</span></span> javax<span style="color: #990000">.</span>servlet<span style="color: #990000">.</span>http<span style="color: #990000">.</span>HttpServletRequest

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> servletRequest<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Box<span style="color: #990000">[</span>HttpServletRequest<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #FF0000">{</span>
  req <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> S<span style="color: #990000">.</span>request
  inner <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> <span style="font-weight: bold"><span style="color: #000000">Box.asA[HTTPRequestServlet]</span></span><span style="color: #990000">(</span>req<span style="color: #990000">.</span>request<span style="color: #990000">)</span>
<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">yield</span></span> inner<span style="color: #990000">.</span>req</tt></pre></div></div>
<div class="paragraph"><p>You can then make your API call:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>servletRequest<span style="color: #990000">.</span>foreach <span style="color: #FF0000">{</span> r <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">yourApiCall</span></span><span style="color: #990000">(</span>r<span style="color: #990000">)</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_44">Discussion</h4>
<div class="paragraph"><p>Note that the results is a <span class="monospaced">Box</span> because there might not be a request
when you evaluate <span class="monospaced">servletRequest</span>&#8201;&#8212;&#8201;or you might one day port to a
different deployment environment and not be running on a standard Java
servlet container.</p></div>
<div class="paragraph"><p>As your code will have a direct dependency on the Java Servlet API,
you&#8217;ll need to include this dependency in your SBT build:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"javax.servlet"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"servlet-api"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"2.5"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"provided-&gt;default"</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_46">See Also</h4>
<div class="paragraph"><p>This recipe was created from the mailing list <em>HttpRequest conversion</em> discussion: <a href="https://groups.google.com/d/topic/liftweb/67tQXSY9XS4/discussion">https://groups.google.com/d/topic/liftweb/67tQXSY9XS4/discussion</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_secure_requests_only">Secure Requests Only</h3>
<div class="sect3">
<h4 id="_problem_47">Problem</h4>
<div class="paragraph"><p>You want to ensure clients are using HTTPs.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_46">Solution</h4>
<div class="paragraph"><p>Add an <span class="monospaced">earlyResponse</span> function in <span class="monospaced">Boot.scala</span> redirecting insecure
requests. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>LiftRules<span style="color: #990000">.</span>earlyResponse<span style="color: #990000">.</span>append <span style="color: #FF0000">{</span> <span style="color: #990000">(</span>req<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Req<span style="color: #990000">)</span> â <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>req<span style="color: #990000">.</span>request<span style="color: #990000">.</span>scheme <span style="color: #990000">!</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"https"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> uriAndQueryString <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> req<span style="color: #990000">.</span>uri <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">req.request.queryString.map</span></span><span style="color: #990000">(</span>s <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #FF0000">"?"</span><span style="color: #990000">+</span>s<span style="color: #990000">)</span> openOr <span style="color: #FF0000">""</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> uri <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"https://%s%s"</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>req<span style="color: #990000">.</span>request<span style="color: #990000">.</span>serverName<span style="color: #990000">,</span> uriAndQueryString<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">Full(PermRedirectResponse</span></span><span style="color: #990000">(</span>uri<span style="color: #990000">,</span> req<span style="color: #990000">,</span> req<span style="color: #990000">.</span>cookies<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">*))</span>
<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> Empty <span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_45">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">earlyResponse</span> call is called early in the Lift pipeline. It is
used to execute code before a request is handled and, if required, exit the
pipeline and return a response. The function signature expected is
<span class="monospaced">Req =&gt; Box[LiftResponse]</span>.</p></div>
<div class="paragraph"><p>The ideal method to ensure requests are served using the correct scheme
would be via web server configuration, such as Apache or Nginx. This
isn&#8217;t possible in some cases, such as when your application is deployed
to a PaaS such as CloudBees.</p></div>
<div class="sect4">
<h5 id="_amazon_load_balancer">Amazon Load Balancer</h5>
<div class="paragraph"><p>For Amazon Elastic Load Balancer note that you need to use
<span class="monospaced">X-Forwarded-Proto</span> header to detect HTTPs. As mentioned in their
<em>Overview of Elastic Load Balancing</em> document, "Your server access logs
contain only the protocol used between the server and the load balancer;
they contain no information about the protocol used between the client
and the load balancer." In this situation modify the above test from
<span class="monospaced">req.request.scheme != "https"</span> to:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">req.header</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"X-Forwarded-Proto"</span><span style="color: #990000">)</span> <span style="color: #990000">!</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Full</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"https"</span><span style="color: #990000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_47">See Also</h4>
<div class="paragraph"><p>The <em>Overview of Elastic Load Balancing</em> can be found at: <a href="http://docs.amazonwebservices.com/ElasticLoadBalancing/latest/DeveloperGuide/arch-loadbalancing.html">http://docs.amazonwebservices.com/ElasticLoadBalancing/latest/DeveloperGuide/arch-loadbalancing.html</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Squeryl">Relational database persistence with Record and Squeryl</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_using_a_jndi_datasource">Using a JNDI datasource</h3>
<div class="sect3">
<h4 id="_problem_48">Problem</h4>
<div class="paragraph"><p>You want to use a JNDI data source for your Record+Squeryl Lift
application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_47">Solution</h4>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> call <span class="monospaced">initWithSquerylSession</span>&#8230;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> javax<span style="color: #990000">.</span>sql<span style="color: #990000">.</span>DataSource
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> ds <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">InitialContext</span></span><span style="color: #990000">().</span>
  <span style="font-weight: bold"><span style="color: #000000">lookup</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"java:comp/env/jdbc/mydb"</span><span style="color: #990000">).</span>asInstanceOf<span style="color: #990000">[</span>DataSource<span style="color: #990000">]</span>

<span style="font-weight: bold"><span style="color: #000000">SquerylRecord.initWithSquerylSession</span></span><span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #000000">Session.create(ds.getConnection</span></span><span style="color: #990000">(),</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> MySQLAdapter<span style="color: #990000">)</span> <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;replacing <span class="monospaced">mydb</span> with the name given to your database in your JNDI
configuration, and replacing <span class="monospaced">MySQLAdapter</span> with the appropriate adapter
for the database you are using.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_46">Discussion</h4>
<div class="paragraph"><p>The Java Naming and Directory Interface (JNDI) is service provided by
the web container (e.g., Jetty, Tomcat, etc) which allows you to
configure a database connection in the container and then refer the
connection by name in your application. One advantage of this is that
you can avoid including database credentials to your Lift source base.</p></div>
<div class="paragraph"><p>The configuration of JNDI is different for each container, and may vary
with versions of the container you use. The <em>See Also</em> section includes
links to the documentation pages for popular containers.</p></div>
<div class="paragraph"><p>Some environments may also require that you to mention the JNDI resource
in your <span class="monospaced">src/main/webapp/WEB-INF/web.xml</span> file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;resource-ref&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;res-ref-name&gt;</span></span>jdbc/mydb<span style="font-weight: bold"><span style="color: #0000FF">&lt;/res-ref-name&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;res-type&gt;</span></span>javax.sql.DataSource<span style="font-weight: bold"><span style="color: #0000FF">&lt;/res-type&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;res-auth&gt;</span></span>Container<span style="font-weight: bold"><span style="color: #0000FF">&lt;/res-auth&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resource-ref&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_48">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
List of
<a href="http://squeryl.org/api/org/squeryl/adapters/package.html">Squeryl database adapters</a>.
</p>
</li>
<li>
<p>
An example <a href="http://www.assembla.com/spaces/liftweb/wiki/Apache_and_Jetty_Configuration">Jetty JNDI configuration</a> on the Lift wiki.
</p>
</li>
<li>
<p>
<a href="http://docs.codehaus.org/display/JETTY/JNDI">Jetty 6 JNDI documentation</a>.
</p>
</li>
<li>
<p>
Eclipse <a href="http://wiki.eclipse.org/Jetty/Howto/Configure_JNDI_Datasource">Jetty JNDI documentation</a>.
</p>
</li>
<li>
<p>
<a href="http://tomcat.apache.org/tomcat-7.0-doc/jndi-resources-howto.html">Tomcat 7</a> JNDI information.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_validation_to_a_field">Adding validation to a field</h3>
<div class="sect3">
<h4 id="_problem_49">Problem</h4>
<div class="paragraph"><p>You want to add validation to a field in your model.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_48">Solution</h4>
<div class="paragraph"><p>Override <span class="monospaced">validations</span>. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> title <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">StringField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #993399">256</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> validations <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">valMinLen</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Title cannot be blank"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span>validations
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In your snippet you can check the validations, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> thing <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">MyThing.createRecord.title</span></span><span style="color: #990000">(</span>title<span style="color: #990000">)</span>
thing<span style="color: #990000">.</span>validate <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #009900">Nil</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// No validation problems, so code here to save thing</span></span>
    <span style="font-weight: bold"><span style="color: #000000">S.redirectTo</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"/success"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> xs <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-style: italic"><span style="color: #9A1900">// One or more validation problems!</span></span>
    <span style="font-weight: bold"><span style="color: #000000">S.error</span></span><span style="color: #990000">(</span>xs<span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In your template, you can reference the column to show any error:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;p</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:Msg?id=title_id&amp;errorClass=error"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Msg to appear here<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_47">Discussion</h4>
<div class="paragraph"><p>The built-in validations are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">valMinLen</span>&#8201;&#8212;&#8201;validate a string is at least a given length, as shown above.
</p>
</li>
<li>
<p>
<span class="monospaced">valMaxLen</span>&#8201;&#8212;&#8201;validate that a string is not above a given length.
</p>
</li>
<li>
<p>
<span class="monospaced">valRegex</span>&#8201;&#8212;&#8201;validate a string matches the given pattern.
</p>
</li>
</ul></div>
<div class="paragraph"><p>An example of regular expression validation would be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>util<span style="color: #990000">.</span>regex<span style="color: #990000">.</span>Pattern

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> url <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">StringField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #993399">1024</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> validations <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
    <span style="font-weight: bold"><span style="color: #000000">valRegex</span></span><span style="color: #990000">(</span> <span style="font-weight: bold"><span style="color: #000000">Pattern.compile</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"^https?://.*"</span><span style="color: #990000">),</span>
              <span style="color: #FF0000">"URLs should start http:// or https://"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span>validations
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_49">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Source for <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala">BaseField.scala</a> which includes the definition of <span class="monospaced">StringValidators</span>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_custom_validation_logic">Implementing custom validation logic</h3>
<div class="sect3">
<h4 id="_problem_50">Problem</h4>
<div class="paragraph"><p>You want to provide your own validation logic and apply it to a field in
a record.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_49">Solution</h4>
<div class="paragraph"><p>Implement a function from the type of field you want to validate to
<span class="monospaced">List[FieldError]</span>. Perhaps we want to ensure that no-one added to the
database can have the same name, so we need to provide a
<span class="monospaced">String =&gt; List[FieldError]</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Person</span> <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Record<span style="color: #990000">[</span>Person<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> KeyedRecord<span style="color: #990000">[</span>Person<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> meta <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Person

  <span style="font-weight: bold"><span style="color: #0000FF">@</span></span><span style="font-weight: bold"><span style="color: #000000">Column</span></span><span style="color: #990000">(</span>name <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"id"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> idField <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">LongField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> name <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">StringField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #993399">100</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> validations <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
      <span style="font-weight: bold"><span style="color: #000000">valUnique</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Please change your name"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span>validations
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">valUnique</span></span><span style="color: #990000">(</span>errorMsg<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> â <span style="font-weight: bold"><span style="color: #000000">String)</span></span><span style="color: #990000">(</span>name<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #0000FF">:</span></span> List<span style="color: #990000">[</span>FieldError<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
    <span style="font-weight: bold"><span style="color: #000000">Person.byName</span></span><span style="color: #990000">(</span>name<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">Some</span></span><span style="color: #990000">(</span>name<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">FieldError</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name<span style="color: #990000">,</span> errorMsg<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="color: #009900">Nil</span>
  <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_48">Discussion</h4>
<div class="paragraph"><p>By convention validation functions have two argument lists: the first
for the error message; the second to receive the value to validate. This
allows you to easily re-use your validation function on other fields.</p></div>
<div class="paragraph"><p>The <span class="monospaced">FieldError</span> you return needs to know the field it applies to as
well as the message to display. In the example the field is <span class="monospaced">name</span>, but
we&#8217;ve used <span class="monospaced">this.name</span> to avoid confusion with the <span class="monospaced">Some(name)</span> in the
pattern match or the <span class="monospaced">name</span> passed as an argument to <span class="monospaced">valUnique</span>.</p></div>
<div class="paragraph"><p>In case you&#8217;re wondering, the implementation of <span class="monospaced">Person.byName</span> might
be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">byName</span></span><span style="color: #990000">(</span>name<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="font-weight: bold"><span style="color: #000000">from</span></span><span style="color: #990000">(</span>YourSchema<span style="color: #990000">.</span>people<span style="color: #990000">)</span>
  <span style="color: #990000">(</span>p <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">where(lower</span></span><span style="color: #990000">(</span>p<span style="color: #990000">.</span>name<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">===</span></span> <span style="font-weight: bold"><span style="color: #000000">lower</span></span><span style="color: #990000">(</span>name<span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #000000">select</span></span> <span style="color: #990000">(</span>l<span style="color: #990000">)).</span>headOption</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_50">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Source for <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala">BaseField.scala</a> which includes the definition of <span class="monospaced">StringValidators</span>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_modify_a_field_value_before_it_is_set">Modify a field value before it is set</h3>
<div class="sect3">
<h4 id="_problem_51">Problem</h4>
<div class="paragraph"><p>You want to modify the value of a field, so the value in your model is
the modified version.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_50">Solution</h4>
<div class="paragraph"><p>Override <span class="monospaced">setFilter</span>. For example, to remove leading and trailing
whitespace entered by the user:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> title <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">StringField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #993399">256</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
   <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> setFilter <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> trim <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span>setFilter
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_49">Discussion</h4>
<div class="paragraph"><p>The built-in filters are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">crop</span>&#8201;&#8212;&#8201;enforces the field&#8217;s min and max length by truncation.
</p>
</li>
<li>
<p>
<span class="monospaced">trim</span>&#8201;&#8212;&#8201;applies <span class="monospaced">String.trim</span> to the field value.
</p>
</li>
<li>
<p>
<span class="monospaced">toUpper</span> and <span class="monospaced">toLower</span>&#8201;&#8212;&#8201;change the case of the field value.
</p>
</li>
<li>
<p>
<span class="monospaced">removeRegExChars</span>&#8201;&#8212;&#8201;removes matching regular expression characters.
</p>
</li>
<li>
<p>
<span class="monospaced">notNull</span>&#8201;&#8212;&#8201;coverts null values to an empty string.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_see_also_51">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Source for <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala">BaseField.scala</a> which includes the definition of the filters.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_put_a_random_value_in_a_column">Put a random value in a column</h3>
<div class="sect3">
<h4 id="_problem_52">Problem</h4>
<div class="paragraph"><p>You need a column to hold a random value.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_51">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">UniqueIdField</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> myColumn <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">UniqueIdField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span><span style="color: #993399">32</span><span style="color: #990000">)</span> <span style="color: #FF0000">{}</span></tt></pre></div></div>
<div class="paragraph"><p>The size value, 32 in this example, controls the number of characters in
the random field.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_50">Discussion</h4>
<div class="paragraph"><p>The field is a kind of <span class="monospaced">StringField</span> and the default value for the field
comes from <span class="monospaced">StringHelpers.randomString</span>.</p></div>
<div class="paragraph"><p>Note the <span class="monospaced">{}</span> in the example: this is required as <span class="monospaced">UniqueIdField</span> is an
abstract class.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_52">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Source for <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/StringHelpers.scala">StringHelpers</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_automatic_created_and_updated_timestamps_for_a_squeryl_record">Automatic created and updated timestamps for a Squeryl Record</h3>
<div class="sect3">
<h4 id="_problem_53">Problem</h4>
<div class="paragraph"><p>You want created and updated fields on your records and would like them
automatically updated when a row is added or updated.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_52">Solution</h4>
<div class="paragraph"><p>Define the following traits:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">trait</span></span> <span style="color: #008080">Created</span><span style="color: #990000">[</span>T <span style="font-weight: bold"><span style="color: #0000FF">&lt;:</span></span> Created<span style="color: #990000">[</span>T<span style="color: #990000">]]</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Record<span style="color: #990000">[</span>T<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  self<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> T <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> created<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> DateTimeField<span style="color: #990000">[</span>T<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">DateTimeField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> defaultValue <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Calendar<span style="color: #990000">.</span>getInstance
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">trait</span></span> <span style="color: #008080">Updated</span><span style="color: #990000">[</span>T <span style="font-weight: bold"><span style="color: #0000FF">&lt;:</span></span> Updated<span style="color: #990000">[</span>T<span style="color: #990000">]]</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Record<span style="color: #990000">[</span>T<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  self<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> T <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> updated <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">DateTimeField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> defaultValue <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Calendar<span style="color: #990000">.</span>getInstance
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> onUpdate <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">updated</span></span><span style="color: #990000">(</span>Calendar<span style="color: #990000">.</span>getInstance<span style="color: #990000">)</span>

<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">trait</span></span> <span style="color: #008080">CreatedUpdated</span><span style="color: #990000">[</span>T <span style="font-weight: bold"><span style="color: #0000FF">&lt;:</span></span> Updated<span style="color: #990000">[</span>T<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> Created<span style="color: #990000">[</span>T<span style="color: #990000">]]</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span>
  Updated<span style="color: #990000">[</span>T<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> Created<span style="color: #990000">[</span>T<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
    self<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> T <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Add to your model, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">YourRecord</span> <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Record<span style="color: #990000">[</span>YourRecord<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> KeyedRecord<span style="color: #990000">[</span><span style="color: #009900">Long</span><span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> CreatedUpdated<span style="color: #990000">[</span>YourRecord<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> meta <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> YourRecord
    <span style="font-style: italic"><span style="color: #9A1900">//field entries ...</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, arrange for the <span class="monospaced">updated</span> field to be updated:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">YourSchema</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Schema <span style="color: #FF0000">{</span>
  <span style="color: #990000">...</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> callbacks <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Seq</span></span><span style="color: #990000">(</span>
    beforeUpdate<span style="color: #990000">[</span>YourRecord<span style="color: #990000">]</span> call <span style="color: #FF0000">{</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">.</span>onUpdate<span style="color: #FF0000">}</span>
  <span style="color: #990000">)</span>
  <span style="color: #990000">...</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_51">Discussion</h4>
<div class="paragraph"><p><em>This recipe requires Lift 2.5 or later.</em></p></div>
<div class="paragraph"><p>Although there is a built in <span class="monospaced">net.lifetweb.record.LifecycleCallbacks</span>
trait in which allows you trigger behaviour onUpdate, afterDelete and so
on, it is only for use on individual Fields, rather than Records. As our
goal is to update the <span class="monospaced">updated</span> field when any part of the Record
changes, we can&#8217;t use the <span class="monospaced">LiftcycleCallbacks</span> here.</p></div>
<div class="paragraph"><p>Instead, the <span class="monospaced">CreatedUpdated</span> trait simplifies adding an <span class="monospaced">updated</span> and
<span class="monospaced">created</span> fields to a Record, but we do need to remember to add a hook
into the schema to ensure the <span class="monospaced">updated</span> value is changed when a record
is modified. This is why we set the <span class="monospaced">callbacks</span> on the Schema.</p></div>
<div class="paragraph"><p>It should be noted that <span class="monospaced">onUpdate</span> is only called on full updates and
not on partial updates with Squeryl. A full update is when the object is
altered and then saved; a partial update is where you attempt to alter
many objects via a query.</p></div>
<div class="paragraph"><p>If you&#8217;re interested in other automations for Record, the Squery schema
callbacks also support other triggered behaviours:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">beforeInsert</span> and <span class="monospaced">afterInsert</span>
</p>
</li>
<li>
<p>
<span class="monospaced">afterSelect</span>
</p>
</li>
<li>
<p>
<span class="monospaced">beforeUpdate</span> and <span class="monospaced">afterUpdate</span>
</p>
</li>
<li>
<p>
<span class="monospaced">beforeDelete</span> and <span class="monospaced">afterDelete</span>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_see_also_53">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://squeryl.org/inserts-updates-delete.html">Explanation of full vs
partial update in Squeryl</a>.
</p>
</li>
<li>
<p>
Mailing list discussion
<a href="https://groups.google.com/d/msg/liftweb/G4U14pQbZZ4/V24YvhUPvEEJ">regarding
LifecycleCallbacks</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_sql">Logging SQL</h3>
<div class="sect3">
<h4 id="_problem_54">Problem</h4>
<div class="paragraph"><p>You want to see the SQL being executed by Record with Squeryl.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_53">Solution</h4>
<div class="paragraph"><p>Add the following anytime you have a Squeryl season, such as just before
your query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">org.squeryl.Session.currentSession.setLogger</span></span><span style="color: #990000">(</span> s <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span>s<span style="color: #990000">)</span> <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>By providing a <span class="monospaced">String =&gt; Unit</span> function to <span class="monospaced">setLogger</span>, Squeryl will
execute that function with the SQL it runs. In this example, we are
simply printing the SQL to the console.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_52">Discussion</h4>
<div class="paragraph"><p>This recipe is not specific to Lift, and will work wherever you use
Squeryl.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_54">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Squeryl <a href="http://squeryl.org/getting-started.html">getting started</a> page.
</p>
</li>
<li>
<p>
Squeryl page on <a href="http://squeryl.org/miscellaneous.html">logging the
generated SQL</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_model_a_column_with_mysql_mediumtext">Model a column with MySQL MEDIUMTEXT</h3>
<div class="sect3">
<h4 id="_problem_55">Problem</h4>
<div class="paragraph"><p>You want to use MySQL&#8217;s <span class="monospaced">MEDIUMTEXT</span> for a column, but <span class="monospaced">StringField</span>
doesn&#8217;t have this option.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_54">Solution</h4>
<div class="paragraph"><p>Use Squeryl&#8217;s <span class="monospaced">dbType</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">on(mytable)</span></span><span style="color: #990000">(</span>t <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">declare</span></span><span style="color: #990000">(</span>
  t<span style="color: #990000">.</span>mycolumn defineAs <span style="font-weight: bold"><span style="color: #000000">dbType</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"MEDIUMTEXT"</span><span style="color: #990000">)</span>
<span style="color: #990000">))</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_53">Discussion</h4>
<div class="paragraph"><p>You can continue to use <span class="monospaced">StringField</span>, but regardless of the size you
pass, the schema will be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">create</span></span> <span style="font-weight: bold"><span style="color: #0000FF">table</span></span> mytable <span style="color: #990000">(</span>
    mycolumn <span style="color: #009900">MEDIUMTEXT</span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span>
<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>This recipe is not specific to Lift, and will work wherever you use
Squeryl.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_55">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Squeryl <a href="http://squeryl.org/schema-definition.html">schema defintion</a>
page.
</p>
</li>
<li>
<p>
<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/TXbDGdX54LQ">MySQL,
Squeryl and MEDIUMTEXT with Record</a> mailing list discussion.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_mysql_unicode_charset_encoding">MySQL Unicode Charset Encoding</h3>
<div class="sect3">
<h4 id="_problem_56">Problem</h4>
<div class="paragraph"><p>Some characters stored in your MySQL database are appearing as <span class="monospaced">???</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_55">Solution</h4>
<div class="paragraph"><p>Ensure:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">Boot.scala</span> includes: <span class="monospaced">LiftRules.early.append(_.setCharacterEncoding("UTF-8"))</span>
</p>
</li>
<li>
<p>
Your JDBC connections URL includes <span class="monospaced">?useUnicode=true&amp;characterEncoding=UTF-8</span>
</p>
</li>
<li>
<p>
Your MySQL database has been created using a UTF-8 character set.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_see_also_56">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/DL9AFyU5y2k">EMail thread on the Lift mailing list</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/d6y/mysql-lift-charset-test">MySQL UTF-8 test Lift app</a> - although it uses SBT 0.7 so is rather out of date.
</p>
</li>
<li>
<p>
<a href="http://dev.mysql.com/doc/refman/5.6/en/connector-j-reference-configuration-properties.html">MySQL JDBC COnfiguration reference</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_relational_database_persistence_with_mapper">Relational database persistence with Mapper</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_sequence_numbers_and_existing_data">Sequence numbers and existing data</h3>
<div class="sect3">
<h4 id="_problem_57">Problem</h4>
<div class="paragraph"><p>You have a table with data in it, but Lift inserts new records with a
primary key starting from 1, or some other value that may already exist.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_56">Solution</h4>
<div class="paragraph"><p>Work with the native sequence facility in your database to set the
starting sequence value to be the value you want Lift to use.</p></div>
<div class="paragraph"><p>The first step is to work out what value you want the sequence to start
from. Most likely this will be just after the largest primary key ID in
the table you&#8217;re working with. With PostgreSQL, for example, you can
check this via the <span class="monospaced">psql</span> command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">SELECT</span></span> MAX<span style="color: #990000">(</span>id<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">FROM</span></span> mytable<span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>To find out what sequences exist, run <span class="monospaced">\ds</span> in <span class="monospaced">psql</span>. The sequence to
change will contain the name of your table. You can then change the
value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">ALTER</span></span> SEQUENCE mytable_id_seq RESTART <span style="font-weight: bold"><span style="color: #0000FF">WITH</span></span> <span style="color: #993399">1000</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_54">Discussion</h4>
<div class="paragraph"><p>Lift defers to the database sequence facility to generate primary key
values. If you insert data by-passing the sequence, the sequence value
will not know about the specific primary key values you have used (this
is not Lift-specific). The solution above resolves this by updating the
starting sequence number to skip over the rows that already exist in
your database.</p></div>
<div class="paragraph"><p>The same instructions apply for using Record as well as Mapper.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_57">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Mailing list discussion "<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/eAelsvlFkaI">Mapper starts counting primary keys with key 1 in a non-empty table</a>".
</p>
</li>
<li>
<p>
PostgreSQL <a href="http://www.postgresql.org/docs/9.1/static/functions-sequence.html">Sequence
Manipulation Functions</a>.
</p>
</li>
<li>
<p>
MySQL <a href="http://dev.mysql.com/doc/refman/5.6/en/example-auto-increment.html">AUTO-INCREMENT</a>
describes how to use ALTER TABLE to change the sequence value.
</p>
</li>
<li>
<p>
<a href="http://www.techonthenet.com/oracle/sequences.php">Updating ORACLE sequence</a> involves changing the incrementing step to cover the values to skip.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_detect_if_the_schema_has_changed">Detect if the schema has changed</h3>
<div class="sect3">
<h4 id="_problem_58">Problem</h4>
<div class="paragraph"><p>You do not want to automatically migrate your schema, but you want to
know if it is out of date.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_57">Solution</h4>
<div class="paragraph"><p>Run <span class="monospaced">Schemifier</span> and capture the changes it would make if allowed. For
example, in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> cmds <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Schemifier.schemify</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span> Schemifier<span style="color: #990000">.</span>infoF <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">,</span> User<span style="color: #990000">,</span> Company<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(!</span>cmds<span style="color: #990000">.</span>isEmpty<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">error</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Database schema is out of date. The following is missing: </span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">+</span>
    <span style="font-weight: bold"><span style="color: #000000">cmds.mkString</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">))</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_55">Discussion</h4>
<div class="paragraph"><p>The arguments and return value for <span class="monospaced">schemify</span> are:</p></div>
<div class="ulist"><ul>
<li>
<p>
performWrite - the example uses <span class="monospaced">false</span> meaning the database won&#8217;t be updated.
</p>
</li>
<li>
<p>
structureOnly - <span class="monospaced">true</span> to check the tables and columns (not indexes).
</p>
</li>
<li>
<p>
logFunc - for logging, but only if we are writing to the database, which we are not.
</p>
</li>
<li>
<p>
tables (mapper objects) - the tables to include.
</p>
</li>
<li>
<p>
The result is a <span class="monospaced">List[String]</span> which are the statements required to update the database.
</p>
</li>
</ul></div>
<div class="paragraph"><p>From the above description you may be able to select the parameters that
best fit your needs.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_58">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/lift/framework/blob/master/persistence/mapper/src/main/scala/net/liftweb/mapper/Schemifier.scala">Schemifier.scala</a> source.
</p>
</li>
<li>
<p>
<a href="https://groups.google.com/forum/?fromgroups#!msg/liftweb/DM4kYVz_Z2c/vO0t-So3vVcJ">Mailing
list discussion</a>.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mongodb_persistence_with_record">MongoDB Persistence with Record</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section gives recipes for making use of MongoDB in your Lift
application. For recipes regarding Mongo itself, check out the MongoDB Cookbook at <a href="http://cookbook.mongodb.org/">http://cookbook.mongodb.org/</a>.</p></div>
<div class="paragraph"><p>Many of the code examples in this chapter can be found in: <a href="https://github.com/LiftCookbook/cookbook_mongo">https://github.com/LiftCookbook/cookbook_mongo</a>.</p></div>
<div class="sect2">
<h3 id="ConnectingToMongo">Connecting to a Mongo Database</h3>
<div class="sect3">
<h4 id="_problem_59">Problem</h4>
<div class="paragraph"><p>You want to connect to a MongoDB.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_58">Solution</h4>
<div class="paragraph"><p>Add the Lift Mongo dependencies to your build and configure a connection using <span class="monospaced">net.liftweb.mongodb</span> and <span class="monospaced">com.mongodb</span>.</p></div>
<div class="paragraph"><p>In <span class="monospaced">Build.sbt</span> add the following to <span class="monospaced">libraryDependencies</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"net.liftweb"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"lift-mongodb-record"</span> <span style="color: #990000">%</span> liftVersion<span style="color: #990000">,</span></tt></pre></div></div>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>mongodb<span style="color: #990000">.</span><span style="color: #FF0000">{</span>ServerAddress<span style="color: #990000">,</span> Mongo<span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>mongodb<span style="color: #990000">.</span><span style="color: #FF0000">{</span>MongoDB<span style="color: #990000">,</span>DefaultMongoIdentifier<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> server <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ServerAddress</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"127.0.0.1"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"20717"</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">MongoDB.defineDb</span></span><span style="color: #990000">(</span>DefaultMongoIdentifier<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Mongo</span></span><span style="color: #990000">(</span>server<span style="color: #990000">),</span> <span style="color: #FF0000">"mydb"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This will give you a connection to a local MongoDB database called
"mydb".</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_56">Discussion</h4>
<div class="paragraph"><p>If your database needs authentication, use <span class="monospaced">MongoDB.defineDbAuth</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">MongoDB.defineDbAuth</span></span><span style="color: #990000">(</span>DefaultMongoIdentifier<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Mongo</span></span><span style="color: #990000">(</span>server<span style="color: #990000">),</span>
  <span style="color: #FF0000">"mydb"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"username"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"password"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Some cloud services will give you a URL to connect to, such as
"mongodb://alex.mongohq.com:10050/fglvBskrsdsdsDaGNs1". In this case, the host and
the port make up the first part, and the database name is the part after
the <span class="monospaced">/</span>.</p></div>
<div class="paragraph"><p>If you need to turn a URL like this into a connection, you can do so by
using <span class="monospaced">java.net.URI</span> to parse the URL and make a connection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">object</span></span> MongoUrl <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">defineDb</span></span><span style="color: #990000">(</span>id<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> MongoIdentifier<span style="color: #990000">,</span> url<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> uri <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">URI</span></span><span style="color: #990000">(</span>url<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> db <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> uri<span style="color: #990000">.</span>getPath drop <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> server <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Mongo</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ServerAddress</span></span><span style="color: #990000">(</span>uri<span style="color: #990000">.</span>getHost<span style="color: #990000">,</span> uri<span style="color: #990000">.</span>getPort<span style="color: #990000">))</span>

    <span style="font-weight: bold"><span style="color: #000000">Option(uri.getUserInfo).map(_.split</span></span><span style="color: #990000">(</span><span style="color: #FF0000">":"</span><span style="color: #990000">))</span> <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">Some(Array</span></span><span style="color: #990000">(</span>user<span style="color: #990000">,</span>pass<span style="color: #990000">))</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #000000">MongoDB.defineDbAuth</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> server<span style="color: #990000">,</span> db<span style="color: #990000">,</span> user<span style="color: #990000">,</span> pass<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #000000">MongoDB.defineDb</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> server<span style="color: #990000">,</span> db<span style="color: #990000">)</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000000">MongoUrl.defineDb</span></span><span style="color: #990000">(</span>DefaultMongoIdentifier<span style="color: #990000">,</span>
  <span style="color: #FF0000">"mongodb://user:pass@127.0.0.1:27017/myDb"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The full URL scheme for MongoDB is more complicated, allowing for multiple hosts and connection parameters, but the above code handles optional user name and password fields and may be enough to get you up and running with your Mongo configuration.</p></div>
<div class="paragraph"><p>The <span class="monospaced">DefaultMongoIdentifier</span> is a value used to identify a particular connection.  Lift keeps a map of identifiers to connections, meaning you can connect to more than on database.  The common case is a single database, and that is usually assigned to <span class="monospaced">DefaultMongoIdentifier</span>.</p></div>
<div class="paragraph"><p>However, if you do need to access two Monogo databases, you can create a new identifier and assign it as part of your record.  For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">object</span></span> OtherMongoIdentifier <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> MongoIdentifier <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> jndiName<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"other"</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000000">MongoUrl.defineDb</span></span><span style="color: #990000">(</span>OtherMongoIdentifier<span style="color: #990000">,</span> <span style="color: #FF0000">"mongodb://127.0.0.1:27017/other"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Country <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Country <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> MongoMetaRecord<span style="color: #990000">[</span>Country<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> collectionName <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"example.earth"</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> mongoIdentifier <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> OtherMongoIdentifier
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">lift-mongodb-record</span> dependency itself depends on another Lift module, <span class="monospaced">lift-mongodb</span>, which provides connectivity and other other lower-level access to MongoDB. Both bottom out with the MongoDB Java driver.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_59">See Also</h4>
<div class="paragraph"><p>Connection configuration that includes replica sets and Mongo options, such as timeout settings, are described on the Lift wiki at:  <a href="https://www.assembla.com/wiki/show/liftweb/Mongo_Configuration">https://www.assembla.com/wiki/show/liftweb/Mongo_Configuration</a>.</p></div>
<div class="paragraph"><p>The full specification for Mongo connection URLs is: <a href="http://docs.mongodb.org/manual/reference/connection-string/">http://docs.mongodb.org/manual/reference/connection-string/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MongoHashMap">Storing a HashMap in a Mongo Record</h3>
<div class="sect3">
<h4 id="_problem_60">Problem</h4>
<div class="paragraph"><p>You want to store a hash map in Mongo.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_59">Solution</h4>
<div class="paragraph"><p>Create a Mongo Record which contains a <span class="monospaced">MongoMapField</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>mongodb<span style="color: #990000">.</span>record<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>mongodb<span style="color: #990000">.</span>record<span style="color: #990000">.</span>field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Country</span> <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> MongoRecord<span style="color: #990000">[</span>Country<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> StringPk<span style="color: #990000">[</span>Country<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> meta <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Country
  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> population <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">MongoMapField[Country,Int]</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Country <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Country <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> MongoMetaRecord<span style="color: #990000">[</span>Country<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> collectionName <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"example.earth"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In this example we are creating a record for information about a country,
and the <span class="monospaced">population</span> is a map from a <span class="monospaced">String</span> key to an <span class="monospaced">Integer</span> value.</p></div>
<div class="paragraph"><p>We can use it in a snippet like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Places</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> uk <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Country.find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"uk"</span><span style="color: #990000">)</span> openOr <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> info <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Map</span></span><span style="color: #990000">(</span>
      <span style="color: #FF0000">"Brighton"</span> <span style="color: #990000">-&gt;</span> <span style="color: #993399">134293</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"Birmingham"</span> <span style="color: #990000">-&gt;</span> <span style="color: #993399">970892</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"Liverpool"</span> <span style="color: #990000">-&gt;</span> <span style="color: #993399">469017</span><span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #000000">Country.createRecord.id("uk").population</span></span><span style="color: #990000">(</span>info<span style="color: #990000">).</span>save
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> facts <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"#facts"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="color: #990000">(</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #FF0000">{</span> <span style="color: #990000">(</span>name<span style="color: #990000">,</span>pop<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> uk<span style="color: #990000">.</span>population<span style="color: #990000">.</span>is <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">yield</span></span>
      <span style="color: #FF0000">".name *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> name <span style="color: #990000">&amp;</span> <span style="color: #FF0000">".pop *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> pop
  <span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>When this snippet is called, it looks up a record by <span class="monospaced">_id</span> of "uk" or
creates it using some canned information. The template to go with the
snippet could include:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"lift:Places.facts"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;thead&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;&lt;th&gt;</span></span>City<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;&lt;th&gt;</span></span>Population<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;&lt;/tr&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/thead&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;tbody&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"facts"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;td</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Name here<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;&lt;td</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"pop"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Population<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tbody&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>In Mongo the resulting data structure would be:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ mongo cookbook
MongoDB shell version: 2.0.6
connecting to: cookbook
&gt; show collections
example.earth
system.indexes
&gt; db.example.earth.find().pretty()
{
  "_id" : "uk",
  "population" : {
    "Brighton" : 134293,
    "Birmingham" : 970892,
    "Liverpool" : 469017
  }
}</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_57">Discussion</h4>
<div class="paragraph"><p>If you do not set a value for the map, the default will be an empty map, represented in Mongo
as:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>({ "_id" : "uk", "population" : { } })</pre>
</div></div>
<div class="paragraph"><p>An alternative is to mark the field as optional:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">object</span></span> population <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">MongoMapField[Country,Int]</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> optional<span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If you now write the document without a <span class="monospaced">population</span> set, the field will be omitted in Mongo:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; db.example.earth.find();
{ "_id" : "uk" }</pre>
</div></div>
<div class="paragraph"><p>To append data to the map from your snippet, you can modify the record to supply a
new <span class="monospaced">Map</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">uk.population</span></span><span style="color: #990000">(</span>uk<span style="color: #990000">.</span>population<span style="color: #990000">.</span>is <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #FF0000">"Westminster"</span><span style="color: #990000">-&gt;</span><span style="color: #993399">81766</span><span style="color: #990000">)).</span>update</tt></pre></div></div>
<div class="paragraph"><p>Note that we are using <span class="monospaced">update</span> here, rather than <span class="monospaced">save</span>.  The <span class="monospaced">save</span> method is pretty smart and will either insert a new document into a Mongo collection or <em>replace</em> an existing document based on the <span class="monospaced">_id</span>.  Update is different: it detects just the changed fields of the document and updates them. It will send this command to Mongo for the document:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{ "$set" : { "population" : { "Brighton" : 134293 , "Liverpool" : 469017 ,
  "Birmingham" : 970892 , "Westminster" : 81766} }</pre>
</div></div>
<div class="paragraph"><p>You&#8217;ll probably want to use <span class="monospaced">update</span> over <span class="monospaced">save</span> for changes to existing records.</p></div>
<div class="paragraph"><p>To access an individual element of the map, you can use <span class="monospaced">get</span> (or <span class="monospaced">value</span>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">uk.population.get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"San Francisco"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">// will throw java.util.NoSuchElementException</span></span></tt></pre></div></div>
<div class="paragraph"><p>â¦or you can access via the standard Scala map interface:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> sf <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Option<span style="color: #990000">[</span><span style="color: #009900">Int</span><span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">uk.population.is.get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"San Francisco"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="sect4">
<h5 id="_what_a_span_class_monospaced_mongomapfield_span_can_contain">What a <span class="monospaced">MongoMapField</span> Can Contain</h5>
<div class="paragraph"><p>You should be aware that <span class="monospaced">MongoMapField</span> supports only primitive types.</p></div>
<div class="paragraph"><p>The mapped field used in this recipe is typed <span class="monospaced">String =&gt; Int</span>, but of course
Mongo will let you mix types such as putting a <span class="monospaced">String</span> or a <span class="monospaced">Boolean</span> as a population value.
If you do modify the Mongo record in the database outside of Lift and mix types, you&#8217;ll get a <span class="monospaced">java.lang.ClassCastException</span> at
runtime.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_60">See Also</h4>
<div class="paragraph"><p>A discussion on the mailing list regarding the limited type support in <span class="monospaced">MongoMapField</span> and a possible way around it by overriding <span class="monospaced">asDBObject</span> can be found at: <a href="https://groups.google.com/d/msg/liftweb/XoseG-8mIPc/OLyIu6FrHIgJ">https://groups.google.com/d/msg/liftweb/XoseG-8mIPc/OLyIu6FrHIgJ</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MongoEmbedding">Embedding a Document Inside a Mongo Record</h3>
<div class="sect3">
<h4 id="_problem_61">Problem</h4>
<div class="paragraph"><p>You have a Mongo record, and you want to embed another set of values
inside it as a single entity.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_60">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">BsonRecord</span> to define the document to embed, and embed it using
<span class="monospaced">BsonRecordField</span>. Here&#8217;s an example of storing information about an
image within a record:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>record<span style="color: #990000">.</span>field<span style="color: #990000">.</span><span style="color: #FF0000">{</span>IntField<span style="color: #990000">,</span>StringField<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Image</span> <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> BsonRecord<span style="color: #990000">[</span>Image<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> meta <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Image
  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> url <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">StringField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #993399">1024</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> width <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">IntField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> height <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">IntField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Image <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Image <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> BsonMetaRecord<span style="color: #990000">[</span>Image<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>We can reference instances of the <span class="monospaced">Image</span> class via <span class="monospaced">BsonRecordField</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Country</span> <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> MongoRecord<span style="color: #990000">[</span>Country<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> StringPk<span style="color: #990000">[</span>Country<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> meta <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Country
  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> flag <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">BsonRecordField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> Image<span style="color: #990000">)</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Country <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Country <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> MongoMetaRecord<span style="color: #990000">[</span>Country<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> collectionName <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"example.earth"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>To associate a value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> unionJack <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="font-weight: bold"><span style="color: #000000">Image.createRecord.url("http://bit.ly/unionflag200").width(200).height</span></span><span style="color: #990000">(</span><span style="color: #993399">100</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">uk.createRecord.id("uk").flag(unionJack).save</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>In Mongo, the resulting data structure would be:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; db.example.earth.findOne()
{
  "_id" : "uk",
  "flag" : {
    "url" : "http://bit.ly/unionflag200",
    "width" : 200,
    "height" : 100
  }
}</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_58">Discussion</h4>
<div class="paragraph"><p>If you don&#8217;t set a value on the embedded document, the default will be
saved as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"flag"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"width"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #FF0000">"height"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #FF0000">"url"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">""</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>You can prevent this by making the image optional:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">object</span></span> image <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">BsonRecordField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> Image<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> optional<span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">?</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>With <span class="monospaced">optional_?</span> set in this way the image part of the Mongo document
won&#8217;t be saved if the value is not set. Within Scala you will then want
to access the value with <span class="monospaced">valueBox</span> call:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> img <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Box<span style="color: #990000">[</span>Image<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> uk<span style="color: #990000">.</span>flag<span style="color: #990000">.</span>valueBox</tt></pre></div></div>
<div class="paragraph"><p>In fact, regardless of the setting of <span class="monospaced">optional_?</span> you can access the
value using <span class="monospaced">valueBox</span>.</p></div>
<div class="paragraph"><p>An alternative is optional values is to always provide a default value for the embedded
document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">object</span></span> image <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">BsonRecordField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> Image<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
 <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> defaultValue <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="font-weight: bold"><span style="color: #000000">Image.createRecord.url("http://bit.ly/unionflag200").width(200).height</span></span><span style="color: #990000">(</span><span style="color: #993399">100</span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_61">See Also</h4>
<div class="paragraph"><p>The Lift Wiki describes BsonRecord in more detail at: <a href="https://www.assembla.com/spaces/liftweb/wiki/Mongo_Record_Embedded_Objects">https://www.assembla.com/spaces/liftweb/wiki/Mongo_Record_Embedded_Objects</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_linking_between_mongo_records">Linking Between Mongo Records</h3>
<div class="sect3">
<h4 id="_problem_62">Problem</h4>
<div class="paragraph"><p>You have a Mongo record and want to include a link to another record.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_61">Solution</h4>
<div class="paragraph"><p>Create a reference using a <span class="monospaced">MongoRefField</span> such as <span class="monospaced">ObjectIdRefField</span> or
<span class="monospaced">StringRefField</span>, and dereference the record using the <span class="monospaced">obj</span> call.</p></div>
<div class="paragraph"><p>As an example we can create records representing countries, where a
country references the planet where you can find it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Planet</span> <span style="font-weight: bold"><span style="color: #0000FF">private</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> MongoRecord<span style="color: #990000">[</span>Planet<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> StringPk<span style="color: #990000">[</span>Planet<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> meta <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Planet
  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> review <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">StringField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span><span style="color: #993399">1024</span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Planet <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Planet <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> MongoMetaRecord<span style="color: #990000">[</span>Planet<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> collectionName <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"example.planet"</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Country</span> <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> MongoRecord<span style="color: #990000">[</span>Country<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> StringPk<span style="color: #990000">[</span>Country<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> meta <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> Country
  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> planet <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">StringRefField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> Planet<span style="color: #990000">,</span> <span style="color: #993399">128</span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Country <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Country <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> MongoMetaRecord<span style="color: #990000">[</span>Country<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> collectionName <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"example.country"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In a snippet we can make us of the link:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">HelloWorld</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> uk <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Country.find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"uk"</span><span style="color: #990000">)</span> openOr <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> earth <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Planet.createRecord.id("earth").review</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Harmless"</span><span style="color: #990000">).</span>save
    <span style="font-weight: bold"><span style="color: #000000">Country.createRecord.id("uk").planet</span></span><span style="color: #990000">(</span>earth<span style="color: #990000">.</span>id<span style="color: #990000">.</span>is<span style="color: #990000">).</span>save
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> facts <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
    <span style="color: #FF0000">".country *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> uk<span style="color: #990000">.</span>id <span style="color: #990000">&amp;</span>
    <span style="color: #FF0000">".planet"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> uk<span style="color: #990000">.</span>planet<span style="color: #990000">.</span>obj<span style="color: #990000">.</span>map <span style="color: #FF0000">{</span> p <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
      <span style="color: #FF0000">".name *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> p<span style="color: #990000">.</span>id <span style="color: #990000">&amp;</span>
      <span style="color: #FF0000">".review *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> p<span style="color: #990000">.</span>review <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>For the value <span class="monospaced">uk</span> we lookup an existing record, or create one if none
is found. Note that <span class="monospaced">earth</span> is created as a separate Mongo record, and
then referenced in the <span class="monospaced">planet</span> field with the id of the planet.</p></div>
<div class="paragraph"><p>Retrieving the reference is via the <span class="monospaced">obj</span> method, which returns a
<span class="monospaced">Box[Planet]</span> in this example.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_59">Discussion</h4>
<div class="paragraph"><p>Referenced records are fetched from Mongo when you call the <span class="monospaced">obj</span> method
on a <span class="monospaced">MongoRefField</span>. You can see this by turning on logging in the
Mongo driver. Do this by adding the following to the start of your
<span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">System.setProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"DEBUG.MONGO"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"true"</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">System.setProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"DB.TRACE"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"true"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Having done this, the first time you run the snippet above your console
will include:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>INFO: find: cookbook.example.country { "_id" : "uk"}
INFO: update: cookbook.example.planet { "_id" : "earth"} { "_id" : "earth" ,
    "review" : "Harmless"}
INFO: update: cookbook.example.country { "_id" : "uk"} { "_id" : "uk" ,
    "planet" : "earth"}
INFO: find: cookbook.example.planet { "_id" : "earth"}</pre>
</div></div>
<div class="paragraph"><p>What you&#8217;re seeing here is the initial look up for "uk", followed by the
creation of the "earth" record and an update which is saving the "uk"
record. Finally, there is a lookup of "earth" when <span class="monospaced">uk.obj</span> is called in
the <span class="monospaced">fact</span> method.</p></div>
<div class="paragraph"><p>The <span class="monospaced">obj</span> call will cache the <span class="monospaced">planet</span> reference. That means you could
say&#8230;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">".country *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> uk<span style="color: #990000">.</span>id <span style="color: #990000">&amp;</span>
<span style="color: #FF0000">".planet *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">uk.planet.obj.map</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">.</span>id<span style="color: #990000">)</span> <span style="color: #990000">&amp;</span>
<span style="color: #FF0000">".review *"</span> <span style="font-weight: bold"><span style="color: #0000FF">#</span></span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">uk.planet.obj.map</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">.</span>review<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;and you&#8217;d still only see one query for the "earth" record despite
calling <span class="monospaced">obj</span> multiple times. The flip side of that is if the "earth"
record was updated elsewhere in Mongo after you called <span class="monospaced">obj</span> you would
not see the change from a call to <span class="monospaced">uk.obj</span> unless you reloaded the <span class="monospaced">uk</span>
record first.</p></div>
<div class="sect4">
<h5 id="_querying_by_reference">Querying by Reference</h5>
<div class="paragraph"><p>Searching for records by a reference is straight-forward:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> earth <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Planet <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #990000">...</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> onEarth <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> List<span style="color: #990000">[</span>Country<span style="color: #990000">]</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Country.findAll</span></span><span style="color: #990000">(</span>Country<span style="color: #990000">.</span>planet<span style="color: #990000">.</span>name<span style="color: #990000">,</span> earth<span style="color: #990000">.</span>id<span style="color: #990000">.</span>is<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Or in this case, because we have <span class="monospaced">String</span> references, we could just say:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> onEarth <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> List<span style="color: #990000">[</span>Country<span style="color: #990000">]</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Country.findAll</span></span><span style="color: #990000">(</span>Country<span style="color: #990000">.</span>planet<span style="color: #990000">.</span>name<span style="color: #990000">,</span> <span style="color: #FF0000">"earth"</span><span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_updating_and_deleting">Updating and Deleting</h5>
<div class="paragraph"><p>Updating a reference is as you&#8217;d expect:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">uk.planet.obj.foreach(_.review</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Mostly harmless."</span><span style="color: #990000">).</span>update<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This would result in the changed field being set:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>INFO: update: cookbook.example.planet { "_id" : "earth"} { "$set" : {
   "review" : "Mostly harmless."}}</pre>
</div></div>
<div class="paragraph"><p>A <span class="monospaced">uk.planet.obj</span> call will now return a planet with the new review.</p></div>
<div class="paragraph"><p>Or you could replace the reference with another:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">uk.planet</span></span><span style="color: #990000">(</span> <span style="font-weight: bold"><span style="color: #000000">Planet.createRecord.id</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"mars"</span><span style="color: #990000">).</span>save<span style="color: #990000">.</span>id<span style="color: #990000">.</span>is <span style="color: #990000">).</span>save</tt></pre></div></div>
<div class="paragraph"><p>Again, note that the reference is via the id of the record (<span class="monospaced">save.id.is</span>), not the record itself.</p></div>
<div class="paragraph"><p>To remove the reference:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">uk.planet</span></span><span style="color: #990000">(</span>Empty<span style="color: #990000">).</span>save</tt></pre></div></div>
<div class="paragraph"><p>This removes the link, but the Mongo record pointed to by the link will remain in the database. If you remove
the object being referenced, a later call to <span class="monospaced">obj</span> will return an
<span class="monospaced">Empty</span> box.</p></div>
</div>
<div class="sect4">
<h5 id="_types_of_link">Types of Link</h5>
<div class="paragraph"><p>The example uses a <span class="monospaced">StringRefField</span> as the Mongo records themselves use <span class="monospaced">String</span> as the <span class="monospaced">_id</span>. Other reference types are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">ObjectIdRefField</span>&#8201;&#8212;&#8201;possibly the most frequently used kind of reference, when you want to reference via the usual default <span class="monospaced">ObjectId</span> reference in Mongo.
</p>
</li>
<li>
<p>
<span class="monospaced">UUIDRefField</span>&#8201;&#8212;&#8201;for records with an ID based on <span class="monospaced">java.util.UUID</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">StringRefField</span>&#8201;&#8212;&#8201;as used in this example, where you control the ID as a <span class="monospaced">String</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">IntRefField</span> and <span class="monospaced">LongRefField</span>&#8201;&#8212;&#8201;for when you&#8217;re using a numeric value as an ID.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_62">See Also</h4>
<div class="paragraph"><p>10Gen Inc&#8217;s <em>Data Modeling Decisions</em> describes embedding of documents compared to referencing objects. You&#8217;ll find the article at: <a href="http://docs.mongodb.org/manual/core/data-modeling/">http://docs.mongodb.org/manual/core/data-modeling/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="QueryingWithRogue">Using Rogue</h3>
<div class="sect3">
<h4 id="_problem_63">Problem</h4>
<div class="paragraph"><p>You want to use Foursquare&#8217;s type-safe domain specific language (DSL), Rogue, for querying and updating Mongo records.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_62">Solution</h4>
<div class="paragraph"><p>You need to include the Rogue dependency in your build and import Rogue into your code.</p></div>
<div class="paragraph"><p>For the first step, edit <span class="monospaced">build.sbt</span> and add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"com.foursquare"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"rogue"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"1.1.8"</span> <span style="font-weight: bold"><span style="color: #000000">intransitive</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>In your code <span class="monospaced">import com.foursquare.rogue._</span> and then start using Rogue.  For example, using the Scala console (see <a href="#MongoScalaConsole">[MongoScalaConsole]</a>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>foursquare<span style="color: #990000">.</span>rogue<span style="color: #990000">.</span>Rogue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>foursquare<span style="color: #990000">.</span>rogue<span style="color: #990000">.</span>Rogue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000080">import</span></span> code<span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> code<span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">Country.where</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">.</span>id eqs <span style="color: #FF0000">"uk"</span><span style="color: #990000">).</span>fetch
res1<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> List<span style="color: #990000">[</span>code<span style="color: #990000">.</span>model<span style="color: #990000">.</span>Country<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">List</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">code</span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>Country<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">{</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>id<span style="font-weight: bold"><span style="color: #0000FF">=</span></span>uk<span style="color: #990000">,</span>
  <span style="font-weight: bold"><span style="color: #000000">population=Map</span></span><span style="color: #990000">(</span>Brighton<span style="color: #990000">-&gt;</span><span style="color: #993399">134293</span><span style="color: #990000">,</span> Liverpool<span style="color: #990000">-&gt;</span><span style="color: #993399">469017</span><span style="color: #990000">,</span> Birmingham<span style="color: #990000">-&gt;</span><span style="color: #993399">970892</span><span style="color: #990000">)</span><span style="color: #FF0000">}</span><span style="color: #990000">)</span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">Country.where</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">.</span>id eqs <span style="color: #FF0000">"uk"</span><span style="color: #990000">).</span>count
res2<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Long</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #993399">1</span>

scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">Country.where</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">.</span>id eqs <span style="color: #FF0000">"uk"</span><span style="color: #990000">).</span>
  <span style="font-weight: bold"><span style="color: #000000">modify</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">.</span>population at <span style="color: #FF0000">"Brighton"</span> inc <span style="color: #993399">1</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">updateOne</span></span><span style="color: #990000">()</span>
</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_60">Discussion</h4>
<div class="paragraph"><p>Rogue is able to use information in your Lift Record to offer an elegant way to query and update records. It&#8217;s type safe meaning, for example, if you try to use an <span class="monospaced">Int</span> where a <span class="monospaced">String</span> is expected in a query, Mongo would allow that and fail to find results at runtime, but Rogue enables Scala to reject the query at compile timeRogue</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>scala<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">Country.where</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">.</span>id eqs <span style="color: #993399">7</span><span style="color: #990000">).</span>fetch
<span style="color: #990000">&lt;</span>console<span style="font-weight: bold"><span style="color: #0000FF">&gt;:</span></span><span style="color: #993399">20</span><span style="font-weight: bold"><span style="color: #0000FF">:</span></span> error<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> mismatch<span style="color: #990000">;</span>
 found   <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #990000">(</span><span style="color: #993399">7</span><span style="color: #990000">)</span>
 required<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String
              <span style="font-weight: bold"><span style="color: #000000">Country.where</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">.</span>id eqs <span style="color: #993399">7</span><span style="color: #990000">).</span>fetch</tt></pre></div></div>
<div class="paragraph"><p>The DSL constructs a query which we then <span class="monospaced">fetch</span> to send the query to MongoDB. That last method, <span class="monospaced">fetch</span>, is just one of the ways to run the query. Others include:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">count</span>&#8201;&#8212;&#8201;queries Mongo for the size of the result set.
</p>
</li>
<li>
<p>
<span class="monospaced">countDistinct</span>&#8201;&#8212;&#8201;the number of distinct values in the results.
</p>
</li>
<li>
<p>
<span class="monospaced">exists</span>&#8201;&#8212;&#8201;true if there&#8217;s any record that matches the query.
</p>
</li>
<li>
<p>
<span class="monospaced">get</span>&#8201;&#8212;&#8201;returns an <span class="monospaced">Option[T]</span> from the query.
</p>
</li>
<li>
<p>
<span class="monospaced">fetch(limit: Int)</span>&#8201;&#8212;&#8201;like <span class="monospaced">fetch</span> but returns at most <span class="monospaced">limit</span> results.
</p>
</li>
<li>
<p>
<span class="monospaced">updateOne</span>, <span class="monospaced">updateMulti</span>, <span class="monospaced">upsertOne</span> and <span class="monospaced">upsertMulti</span>&#8201;&#8212;&#8201;modify a single document, or all documents, that match the query.
</p>
</li>
<li>
<p>
<span class="monospaced">findAndDeleteOne</span> and <span class="monospaced">bulkDelete_!!</span>&#8201;&#8212;&#8201;to delete records.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The query language itself is expressive, and the best place to explore the variety of queries is in the <span class="monospaced">QueryTest</span> specification in the source for Rogue.  You&#8217;ll find a link to this in the README of the project on Github.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Rogue is working towards a v2 release which introduces a number of new concepts. If you want to give it a try, take a look at the
instructions and comments on the Rogue
mailing list at: <a href="https://groups.google.com/d/topic/rogue-users/SdtFCU-w3ng/">https://groups.google.com/d/topic/rogue-users/SdtFCU-w3ng/</a>.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_63">See Also</h4>
<div class="paragraph"><p>For geospacial queries, see <a href="#MongoGeospatial">[MongoGeospatial]</a>.</p></div>
<div class="paragraph"><p>The README page for Rogue is a great starting point, and includes a link to <span class="monospaced">QueryTest</span> giving plenty of example queries to crib from: <a href="https://github.com/foursquare/rogue">https://github.com/foursquare/rogue</a>.</p></div>
<div class="paragraph"><p>The motivation for Rogue is described in a Foursquare engineering blog post: <a href="http://engineering.foursquare.com/2011/01/21/rogue-a-type-safe-scala-dsl-for-querying-mongodb/">http://engineering.foursquare.com/2011/01/21/rogue-a-type-safe-scala-dsl-for-querying-mongodb/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MongoGeospatial">Storing Geospatial Values</h3>
<div class="sect3">
<h4 id="_problem_64">Problem</h4>
<div class="paragraph"><p>You want to store latitude and longitude information in Mongo.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_63">Solution</h4>
<div class="paragraph"><p>Use Rogue&#8217;s <span class="monospaced">LatLong</span> class to embed location information in your model. For
example, we can store the location of a city like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>foursquare<span style="color: #990000">.</span>rogue<span style="color: #990000">.</span>Rogue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>foursquare<span style="color: #990000">.</span>rogue<span style="color: #990000">.</span>LatLong

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">City</span> <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> MongoRecord<span style="color: #990000">[</span>City<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> ObjectIdPk<span style="color: #990000">[</span>City<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> meta <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> City

  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> name <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">StringField</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #993399">60</span><span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> loc <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> MongoCaseClassField<span style="color: #990000">[</span>City<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">LatLong]</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> City <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> City <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> MongoMetaRecord<span style="color: #990000">[</span>City<span style="color: #990000">]</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>mongodb<span style="color: #990000">.</span>BsonDSL<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
  <span style="font-weight: bold"><span style="color: #000000">ensureIndex</span></span><span style="color: #990000">(</span>loc<span style="color: #990000">.</span>name <span style="color: #990000">-&gt;</span> <span style="color: #FF0000">"2d"</span><span style="color: #990000">,</span> unique<span style="font-weight: bold"><span style="color: #0000FF">=true</span></span><span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> collectionName <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"example.city"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We can store values like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> place <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">LatLong</span></span><span style="color: #990000">(</span><span style="color: #993399">50.819059</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">0.136642</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> city <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">City.createRecord.name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Brighton, UK"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">loc(pos).save</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This will produce data in Mongo that looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">ObjectId</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"50f2f9d43004ad90bbc06b83"</span><span style="color: #990000">),</span>
  <span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Brighton, UK"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"loc"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"lat"</span> <span style="color: #990000">:</span> <span style="color: #993399">50.819059</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"long"</span> <span style="color: #990000">:</span> <span style="color: #990000">-</span><span style="color: #993399">0.136642</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_61">Discussion</h4>
<div class="paragraph"><p>MongoDB supports <em>geospatial indexes</em>, and we&#8217;re making use of this by doing two things.  First,
we are storing the location information in one of MongoDB&#8217;s permitted formats.  The format is
an embedding document containing the coordinates. We could also have use a array of two values
to represent the point.</p></div>
<div class="paragraph"><p>Second, we&#8217;re creating a index of type "2d", which allows us to use Mongo&#8217;s geospatial functions such as <span class="monospaced">$near</span> and <span class="monospaced">$within</span>. The <span class="monospaced">unique=true</span> in the <span class="monospaced">ensureIndex</span> highlights that you can control
whether locations needs to be unique (<span class="monospaced">true</span>, no duplications) or not (<span class="monospaced">false</span>).</p></div>
<div class="paragraph"><p>With regard to the unique index, you&#8217;ll note that we&#8217;re calling <span class="monospaced">save(true)</span> on the <span class="monospaced">City</span> in
this example, rather than the plain <span class="monospaced">save</span> in most other recipes.  We could use <span class="monospaced">save</span> here, and
it would work fine, but difference is that <span class="monospaced">save(true)</span> raises the <em>write concern</em> level
from "normal" to "safe".</p></div>
<div class="paragraph"><p>With the normal write concern, the call to <span class="monospaced">save</span> would return as soon
as the request has gone down the wire to the Mongo server.  This gives a certain degree of reliability in that
<span class="monospaced">save</span> would fail if the network had gone away. However, there&#8217;s no indication that the server has
processed the request.  For example, if we tried to insert a city at the exact same location as one that was already in the database, the index uniqueness rule would be violated and the record would not be saved.  With just <span class="monospaced">save</span> (or <span class="monospaced">save(false)</span>) our Lift application would not receive this error, and the call would fail silently. Raising the concern to "safe" causes <span class="monospaced">save(true)</span> to wait for an acknowledgment from the Mongo server, which means the application will receive exceptions for some kinds of errors.</p></div>
<div class="paragraph"><p>As an example, if we tried to insert a duplicate city, our call to <span class="monospaced">save(true)</span> would result in:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>com<span style="color: #990000">.</span>mongodb<span style="color: #990000">.</span>MongoException$DuplicateKey<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> E11000 duplicate key
  error index<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> cookbook<span style="color: #990000">.</span>example<span style="color: #990000">.</span>city<span style="color: #990000">.</span>$loc<span style="font-weight: bold"><span style="color: #0000FF">_</span></span>2d</tt></pre></div></div>
<div class="paragraph"><p>There are other levels of write concern, available via another variant of <span class="monospaced">save</span> which takes a <span class="monospaced">WriteConcern</span> as an argument.</p></div>
<div class="paragraph"><p>If you ever need to drop an index, the MongoDB command is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>db.example.city.dropIndex( "loc_2d" )</pre>
</div></div>
<div class="sect4">
<h5 id="_querying">Querying</h5>
<div class="paragraph"><p>The reason this recipe uses Rogue&#8217;s <span class="monospaced">LatLong</span> class is to enable us to query using the Rogue DSL.  Suppose we&#8217;ve inserted other cities into our collection:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; db.example.city.find({}, {_id:0} )
{"name": "London, UK", "loc": {"lat": 51.5, "long": -0.166667} }
{"name": "Brighton, UK", "loc": {"lat": 50.819059, "long": -0.136642} }
{"name": "Paris, France", "loc": {"lat": 48.866667, "long": 2.333333} }
{"name": "Berlin, Germany", "loc": {"lat": 52.533333, "long": 13.416667} }
{"name": "Sydney, Australia", "loc": {"lat": -33.867387, "long": 151.207629} }
{"name": "New York, USA", "loc": {"lat": 40.714623, "long": -74.006605} }</pre>
</div></div>
<div class="paragraph"><p>We can now find those cities within a 500km of London:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>foursquare<span style="color: #990000">.</span>rogue<span style="color: #990000">.</span><span style="color: #FF0000">{</span>LatLong<span style="color: #990000">,</span> Degrees<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> centre <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">LatLong</span></span><span style="color: #990000">(</span><span style="color: #993399">51.5</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">0.166667</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> radius <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Degrees(</span></span> <span style="color: #990000">(</span><span style="color: #993399">500</span> <span style="color: #990000">/</span> <span style="color: #993399">6378.137</span><span style="color: #990000">).</span>toDegrees <span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> nearby <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">City.where</span></span><span style="color: #990000">(</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">.</span>loc <span style="font-weight: bold"><span style="color: #000000">near</span></span> <span style="color: #990000">(</span>centre<span style="color: #990000">.</span>lat<span style="color: #990000">,</span> centre<span style="color: #990000">.</span>long<span style="color: #990000">,</span> radius<span style="color: #990000">)</span> <span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">fetch</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>This would query MongoDB with this clause&#8230;</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{ "loc" : { "$near" : [ 51.5 , -0.166667 , 4.491576420597608]}}</pre>
</div></div>
<div class="paragraph"><p>&#8230;which will identify London, Brighton and Paris as near to London.</p></div>
<div class="paragraph"><p>The form of the query is a centre point and a spherical radius.  Records falling
inside that radius match the query and are returned closest first. We calculate
the radius in radians: 500km divided by the radius of the Earth, approximately 6378km, gives
us an angle in radians. We convert this to <span class="monospaced">Degrees</span> as required by Rogue.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_64">See Also</h4>
<div class="paragraph"><p>The MongoDB manual discusses geospatial index at: <a href="http://docs.mongodb.org/manual/core/geospatial-indexes/">http://docs.mongodb.org/manual/core/geospatial-indexes/</a>.</p></div>
<div class="paragraph"><p>You can learn more about write concerns at <a href="http://docs.mongodb.org/manual/core/write-operations/">http://docs.mongodb.org/manual/core/write-operations/</a>, and
the various values to pass to <span class="monospaced">save</span> are described in the Java MongoDB driver: <a href="http://api.mongodb.org/java/current/">http://api.mongodb.org/java/current/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MongoScalaConsole">Running Queries from the Scala Console</h3>
<div class="sect3">
<h4 id="_problem_65">Problem</h4>
<div class="paragraph"><p>You want to try out a few queries interactively from the Scala console.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_64">Solution</h4>
<div class="paragraph"><p>Start the console from your project, call <span class="monospaced">boot()</span>, and then interact with your model.</p></div>
<div class="paragraph"><p>For example, using the
Mongo records developed as part of <a href="#ConnectingToMongo">[ConnectingToMongo]</a>, we can perform a basic query:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sbt
...
&gt; console
[info] Compiling 1 Scala source to /cookbook_mongo/target/scala-2.9.1/classes...
[info] Starting scala interpreter...
[info]
Welcome to Scala version 2.9.1.final ...
Type in expressions to have them evaluated.
Type :help for more information.

scala&gt; import bootstrap.liftweb._
import bootstrap.liftweb._

scala&gt; new Boot().boot

scala&gt; import code.model._
import code.model._

scala&gt; Country.findAll
res2: List[code.model.Country] = List(class code.model.Country={_id=uk,
  population=Map(Brighton -&gt; 134293, Liverpool -&gt; 469017,
  Birmingham -&gt; 970892)})

scala&gt; :q</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_62">Discussion</h4>
<div class="paragraph"><p>Running everything in <span class="monospaced">Boot</span> may be a little heavy handed, especially if you starting up various services and background tasks.  All we need to do is define a database connection. For example, using the example code presented in <a href="#ConnectingToMongo">[ConnectingToMongo]</a>, we could initialise a conection with:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>scala&gt; import bootstrap.liftweb._
import bootstrap.liftweb._

scala&gt; import net.liftweb.mongodb._
import net.liftweb.mongodb._

scala&gt; MongoUrl.defineDb(DefaultMongoIdentifier,
  "mongodb://127.0.0.1:27017/cookbook")

scala&gt; Country.findAll
res2: List[code.model.Country] = List(class code.model.Country={_id=uk,
  population=Map(Brighton -&gt; 134293, Liverpool -&gt; 469017,
    Birmingham -&gt; 970892)})</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_65">See Also</h4>
<div class="paragraph"><p><a href="#ConnectingToMongo">[ConnectingToMongo]</a> for connecting to MongoDB and <a href="#QueryingWithRogue">[QueryingWithRogue]</a> for querying with Rogue.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MongoUnitTest">Unit Testing Record with Mongo</h3>
<div class="sect3">
<h4 id="_problem_66">Problem</h4>
<div class="paragraph"><p>You want to write unit tests to run against your Lift Record code with MongoDB.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_65">Solution</h4>
<div class="paragraph"><p>Using the Specs2 testing framework, surround your specification with a <em>context</em> which creates and connects to a database for each test and destroys it after the test runs.</p></div>
<div class="paragraph"><p>Create a Scala trait to set up and destroy a connection to Mongo.  We&#8217;ll be mixing this trait into your specifications:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span><span style="color: #FF0000">{</span>Req<span style="color: #990000">,</span> S<span style="color: #990000">,</span> LiftSession<span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>StringHelpers
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>common<span style="color: #990000">.</span>Empty
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>mongodb<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>mongodb<span style="color: #990000">.</span>ServerAddress
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>mongodb<span style="color: #990000">.</span>Mongo
<span style="font-weight: bold"><span style="color: #000080">import</span></span> org<span style="color: #990000">.</span>specs2<span style="color: #990000">.</span>mutable<span style="color: #990000">.</span>Around
<span style="font-weight: bold"><span style="color: #000080">import</span></span> org<span style="color: #990000">.</span>specs2<span style="color: #990000">.</span>execute<span style="color: #990000">.</span>Result

<span style="font-weight: bold"><span style="color: #0000FF">trait</span></span> <span style="color: #008080">MongoTestKit</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> server <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Mongo</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ServerAddress</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"127.0.0.1"</span><span style="color: #990000">,</span> <span style="color: #993399">27017</span><span style="color: #990000">))</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> dbName <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"test_"</span><span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>getClass<span style="color: #990000">.</span>getName
    <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">replace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"."</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_"</span><span style="color: #990000">)</span>
    <span style="color: #990000">.</span>toLowerCase

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">initDb</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Unit <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">MongoDB.defineDb</span></span><span style="color: #990000">(</span>DefaultMongoIdentifier<span style="color: #990000">,</span> server<span style="color: #990000">,</span> dbName<span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">destroyDb</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Unit <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">MongoDB.use</span></span><span style="color: #990000">(</span>DefaultMongoIdentifier<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> d <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">d.dropDatabase</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span>
    MongoDB<span style="color: #990000">.</span>close
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">trait</span></span> <span style="color: #008080">TestLiftSession</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> session <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">LiftSession</span></span><span style="color: #990000">(</span><span style="color: #FF0000">""</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">StringHelpers.randomString</span></span><span style="color: #990000">(</span><span style="color: #993399">20</span><span style="color: #990000">),</span> Empty<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">inSession[T]</span></span><span style="color: #990000">(</span>a<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> T<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #0000FF">:</span></span> T <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">S.init</span></span><span style="color: #990000">(</span>Req<span style="color: #990000">.</span>nil<span style="color: #990000">,</span> session<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> a <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> MongoContext <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Around <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> TestLiftSession <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> around<span style="color: #990000">[</span>T <span style="font-weight: bold"><span style="color: #0000FF">&lt;%</span></span> <span style="font-weight: bold"><span style="color: #000000">Result]</span></span><span style="color: #990000">(</span>testToRun<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>T<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">initDb</span></span><span style="color: #990000">()</span>
      <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
        inSession <span style="color: #FF0000">{</span>
          testToRun
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">finally</span></span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">destroyDb</span></span><span style="color: #990000">()</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This trait provides the plumbing for connection to a Mongo server running locally, and creates a database based on the name of the class it is mixed into.  The important part is the <span class="monospaced">MongoContext</span> which ensures that <span class="monospaced">around</span> your specification the database is initialized, and that after your specification is run, it is cleaned up.</p></div>
<div class="paragraph"><p>To use this in a specification, mix in the trait and then add the context:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> org<span style="color: #990000">.</span>specs2<span style="color: #990000">.</span>mutable<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">MySpec</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Specification <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> MongoTestKit  <span style="color: #FF0000">{</span>

  sequential

  <span style="color: #FF0000">"My Record"</span> should <span style="color: #FF0000">{</span>

    <span style="color: #FF0000">"be able to create records"</span> in MongoContext <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> r <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> MyRecord<span style="color: #990000">.</span>createRecord
      <span style="font-style: italic"><span style="color: #9A1900">// ...your useful test here...</span></span>
      r<span style="color: #990000">.</span>valueBox<span style="color: #990000">.</span>isDefined must beTrue
    <span style="color: #FF0000">}</span>

  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>You can now run the test in SBT by typing <span class="monospaced">test</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; test
[info] Compiling 1 Scala source to target/scala-2.9.1/test-classes...
[info] My Record should
[info] + be able to create records
[info]
[info]
[info] Total for specification MySpec
[info] Finished in 1 second, 199 ms
[info] 1 example, 0 failure, 0 error
[info]
[info] Passed: : Total 1, Failed 0, Errors 0, Passed 0, Skipped 0
[success] Total time: 1 s, completed 03-Jan-2013 22:47:54</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_63">Discussion</h4>
<div class="paragraph"><p>Lift normally provides all the scaffolding you need to connect and run against MongoDB. Without a running Lift application, we need to ensure Mongo is configured when our tests run outside of Lift, and that&#8217;s what the <span class="monospaced">MongoTestKit</span> trait is providing for us.</p></div>
<div class="paragraph"><p>The one unusual part of the test set up is including a <span class="monospaced">TestLiftSession</span>. This provides an empty session around your test, which is useful if you are accessing or testing state-related code (e.g., access to <span class="monospaced">S</span>).  It&#8217;s not strictly necessary for running tests against Record, but it has been included here because you may want to do that at some point, for example if you are testing user login via Mongo Records.</p></div>
<div class="paragraph"><p>There are a few nice tricks in SBT to help you run tests. Running <span class="monospaced">test</span> will run all the tests in your project. If you want to focus on just one test, you can:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; test-only org.example.code.MySpec</pre>
</div></div>
<div class="paragraph"><p>This command also supports wildcards, so if we only wanted to run tests that start with the word "Mongo" we could:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; test-only org.example.code.Mongo*</pre>
</div></div>
<div class="paragraph"><p>There&#8217;s also <span class="monospaced">test-quick</span> (in SBT 0.12) which will only run tests that have not been run, have changed, or failed last time and <span class="monospaced">~test</span> to watch for changes in tests and run them.</p></div>
<div class="paragraph"><p><span class="monospaced">test-only</span> together with modifications to <span class="monospaced">around</span> in <span class="monospaced">MongoTestKit</span> can be a good way to track down any issues you have with a test.  By disabling the call to <span class="monospaced">destroyDb()</span> you can jump into the MongoDB shell and examine the state of the database after a test has run.</p></div>
<div class="paragraph"><p>One way to resolve that is to clean up each individual collection, by defining the collections you need to clean up, and replacing <span class="monospaced">destroyDb</span> with a method that will remove all entries in those collections:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">lazy</span></span> <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> collections <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> List<span style="color: #990000">[</span>MongoMetaRecord<span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">]]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">List</span></span><span style="color: #990000">(</span>MyRecord<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">destroyDb</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Unit <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">collections.foreach</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span> bulkDelete<span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">!!</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> BasicDBObject<span style="color: #990000">)</span>
  MongoDB<span style="color: #990000">.</span>close
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that the collection list is <span class="monospaced">lazy</span> to avoid start up of the Record system before we&#8217;ve initialized our database connections.</p></div>
<div class="sect4">
<h5 id="_database_cleanup">Database Cleanup</h5>
<div class="paragraph"><p>Around each test we&#8217;ve simply deleted the database so the next time we try to use it, it&#8217;ll be empty.  In some situations you may not be able to do this.  For example, if you&#8217;re running tests against a database hosted with companies such as MongoLabs or MongoHQ, then deleting the database will mean you won&#8217;t be able to connect to it next time you run.</p></div>
</div>
<div class="sect4">
<h5 id="_parallel_tests">Parallel Tests</h5>
<div class="paragraph"><p>If your tests are modifying data and have the potential to interact, you&#8217;ll want to stop SBT from running your tests in parallel. A symptom of this would be tests that fail apparently randomly, or working tests that stop working when you add a new test, or tests that seem to lock up.  Disable by adding the following to <span class="monospaced">build.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>parallelExecution in Test <span style="font-weight: bold"><span style="color: #0000FF">:=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span></tt></pre></div></div>
<div class="paragraph"><p>You&#8217;ll notice that the example specification includes the line: <span class="monospaced">sequential</span>.  This disables the default behaviour in Specs2 of running all tests concurrently.</p></div>
</div>
<div class="sect4">
<h5 id="_running_tests_in_ides">Running tests in IDEs</h5>
<div class="paragraph"><p>IntelliJ IDEA detects and allows you to runs Specs2 tests automatically.  With Eclipse, you&#8217;ll need to include the JUnit runner annotation at the start of your specification:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> org<span style="color: #990000">.</span>junit<span style="color: #990000">.</span>runner<span style="color: #990000">.</span>RunWith
<span style="font-weight: bold"><span style="color: #000080">import</span></span> org<span style="color: #990000">.</span>specs2<span style="color: #990000">.</span>runner<span style="color: #990000">.</span>JUnitRunner

<span style="font-weight: bold"><span style="color: #0000FF">@</span></span><span style="font-weight: bold"><span style="color: #000000">RunWith</span></span><span style="color: #990000">(</span>classOf<span style="color: #990000">[</span>JUnitRunner<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">MySpec</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Specification <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> MongoTestKit  <span style="color: #FF0000">{</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>You can then "Run As&#8230;" the class in Eclipse.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_66">See Also</h4>
<div class="paragraph"><p>Specs2 is documented at: <a href="http://specs2.org/">http://specs2.org/</a>.</p></div>
<div class="paragraph"><p>If you prefer to use the Scala Test framework (<a href="http://www.scalatest.org">http://www.scalatest.org</a>), take a look at Tim Nelson&#8217;s <em>Mongo Auth</em> Lift module at <a href="https://github.com/eltimn/lift-mongoauth">https://github.com/eltimn/lift-mongoauth</a>. It includes tests using that framework that run against Mongo.  Much of what Tim has written there has been used to produce this recipe for Specs2.</p></div>
<div class="paragraph"><p>The Lift Mongo Record library includes a variation on testing with Specs2, using just <span class="monospaced">Before</span> and <span class="monospaced">After</span> rather than the <span class="monospaced">around</span> example used in this recipe. If you prefer that approach, you&#8217;ll find the code in: <a href="https://github.com/lift/framework/tree/master/persistence/mongodb-record/src/test/scala/net/liftweb/mongodb/record">https://github.com/lift/framework/tree/master/persistence/mongodb-record/src/test/scala/net/liftweb/mongodb/record</a>.</p></div>
<div class="paragraph"><p>Flapdoodle (<a href="https://github.com/flapdoodle-oss/embedmongo.flapdoodle.de">https://github.com/flapdoodle-oss/embedmongo.flapdoodle.de</a> provides a way to automate the download, install, set up and clean up of a MongoDB database. This automation is something you can wrap around your unit tests, and a Specs2 integration is included using the same <span class="monospaced">Before</span> and <span class="monospaced">After</span> approach to testing used by Lift Mongo Record: <a href="https://github.com/athieriot/specs2-embedmongo">https://github.com/athieriot/specs2-embedmongo</a>.</p></div>
<div class="paragraph"><p>The test interface provided by SBT, such as the <span class="monospaced">test</span> command, also supports the ability to fork tests, set specific configurations for test cases, and ways to select which tests are run. You&#8217;ll find it at: <a href="http://www.scala-sbt.org/release/docs/Detailed-Topics/Testing">http://www.scala-sbt.org/release/docs/Detailed-Topics/Testing</a>.</p></div>
<div class="paragraph"><p>The Lift Wiki describes more about unit testing and Lift sessions:
<a href="https://www.assembla.com/wiki/show/liftweb/Unit_Testing_Snippets_With_A_Logged_In_User">https://www.assembla.com/wiki/show/liftweb/Unit_Testing_Snippets_With_A_Logged_In_User</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_in_and_around_lift">In and Around Lift</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section gives examples of working with Lift and other systems, such
as sending email or scheduling tasks.</p></div>
<div class="sect2">
<h3 id="_sending_plain_text_email">Sending plain text email</h3>
<div class="sect3">
<h4 id="_problem_67">Problem</h4>
<div class="paragraph"><p>You want to send a plain email from your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_66">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">Mailer</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Mailer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000000">Mailer.sendMail</span></span><span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #000000">From</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"you@example.org"</span><span style="color: #990000">),</span>
  <span style="font-weight: bold"><span style="color: #000000">Subject</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello"</span><span style="color: #990000">),</span>
  <span style="font-weight: bold"><span style="color: #000000">To</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"other@example.org"</span><span style="color: #990000">),</span>
  <span style="font-weight: bold"><span style="color: #000000">PlainMailBodyType</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello from Lift"</span><span style="color: #990000">)</span> <span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_64">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">Mailer</span> sends the message asynchronously, meaning <span class="monospaced">sendMail</span> will
return immediately, so you don&#8217;t have to worry about the time costs of
negotiating with an SMTP server. There&#8217;s also a <span class="monospaced">blockingSendMail</span>
method if you want to wait.</p></div>
<div class="paragraph"><p>By default, the SMTP server used will be <span class="monospaced">localhost</span>. You can change
this by setting the <span class="monospaced">mail.smtp.host</span> property. For example, add the line
<span class="monospaced">mail.smtp.host=smtp.example.org</span> to
<span class="monospaced">src/mail/resources/props/default.props</span>. Mailer also supports JNDI as a
source of email sessions.</p></div>
<div class="paragraph"><p>The signature of <span class="monospaced">sendMail</span> requires a <span class="monospaced">From</span>, <span class="monospaced">Subject</span> and then any
number of <span class="monospaced">MailTypes</span>. In the example we added two: <span class="monospaced">PlainMailBodyType</span>
and <span class="monospaced">To</span>. You can add others including <span class="monospaced">BCC</span>, <span class="monospaced">ReplyTo</span> and
<span class="monospaced">MessageHeader</span> (a name and value pair), and you can add them multiple
times.</p></div>
<div class="paragraph"><p>The default character set is UTF-8. If you need to change this replace
the use of <span class="monospaced">PlainMailBodyType</span> with
<span class="monospaced">PlainPlusBodyType("Hello from Lift", "ISO8859_1")</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_67">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://exploring.liftweb.net/master/index-F.html#toc-Appendix-F">Exploring
Lift</a>, Appendix F.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_html_email">Sending HTML email</h3>
<div class="sect3">
<h4 id="_problem_68">Problem</h4>
<div class="paragraph"><p>You want to send an HTML email from your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_67">Solution</h4>
<div class="paragraph"><p>Give <span class="monospaced">Mailer</span> a <span class="monospaced">NodeSeq</span> containing your HTML message:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Mailer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> html <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #990000">&lt;</span>html<span style="color: #990000">&gt;</span>
   <span style="color: #990000">&lt;</span>head<span style="color: #990000">&gt;</span>
     <span style="color: #990000">&lt;</span>title<span style="color: #990000">&gt;</span>Hello<span style="color: #990000">&lt;/</span>title<span style="color: #990000">&gt;</span>
   <span style="color: #990000">&lt;/</span>head<span style="color: #990000">&gt;</span>
   <span style="color: #990000">&lt;</span>body<span style="color: #990000">&gt;</span>
    <span style="color: #990000">&lt;</span>h1<span style="color: #990000">&gt;</span>Hello<span style="color: #990000">&lt;/</span>h1<span style="color: #990000">&gt;</span>
   <span style="color: #990000">&lt;/</span>body<span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;/</span>html<span style="color: #990000">&gt;</span>

<span style="font-weight: bold"><span style="color: #000000">Mailer.sendMail</span></span><span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #000000">From</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Myself &lt;me@example.org&gt;"</span><span style="color: #990000">),</span>
  <span style="font-weight: bold"><span style="color: #000000">Subject</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello"</span><span style="color: #990000">),</span>
  <span style="font-weight: bold"><span style="color: #000000">To</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"you@example.org"</span><span style="color: #990000">),</span>
  html<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_65">Discussion</h4>
<div class="paragraph"><p>An implicit converts the <span class="monospaced">NodeSeq</span> into a <span class="monospaced">XHTMLMailBodyType</span>. This
ensures the mime type of the email is "text/html". Despite the name of
XHTML, the message is to converted into a string for transmission using
HTML5 semantics.</p></div>
<div class="paragraph"><p>The character encoding for HTML email, UTF-8, can be changed by setting
<span class="monospaced">mail.charset</span> in your Lift properties file.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_authenticated_email">Sending authenticated email</h3>
<div class="sect3">
<h4 id="_problem_69">Problem</h4>
<div class="paragraph"><p>You need to authenticate with an SMTP server to send email.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_68">Solution</h4>
<div class="paragraph"><p>Set the <span class="monospaced">Mailer.authenticator</span> in <span class="monospaced">Boot</span> with the credentials for your
SMTP server and enable the <span class="monospaced">mail.smtp.auth</span> flag in your Lift props
file.</p></div>
<div class="paragraph"><p>Modify <span class="monospaced">Boot.scala</span> to include:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Mailer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> javax<span style="color: #990000">.</span>mail<span style="color: #990000">.</span><span style="color: #FF0000">{</span>Authenticator<span style="color: #990000">,</span>PasswordAuthentication<span style="color: #FF0000">}</span>

Mailer<span style="color: #990000">.</span>authenticator <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #FF0000">{</span>
  user <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> <span style="font-weight: bold"><span style="color: #000000">Props.get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"mail.user"</span><span style="color: #990000">)</span>
  pass <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> <span style="font-weight: bold"><span style="color: #000000">Props.get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"mail.password"</span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">yield</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Authenticator <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> getPasswordAuthentication <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">PasswordAuthentication</span></span><span style="color: #990000">(</span>user<span style="color: #990000">,</span>pass<span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In this example we expect the username and password to come from Lift
properties, so we need to modify
<span class="monospaced">src/main/resources/props/default.props</span> to include them:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>mail<span style="color: #990000">.</span>smtp<span style="color: #990000">.</span>auth<span style="font-weight: bold"><span style="color: #0000FF">=true</span></span>
mail<span style="color: #990000">.</span>user<span style="font-weight: bold"><span style="color: #0000FF">=</span></span>me<span style="font-weight: bold"><span style="color: #0000FF">@</span></span>example<span style="color: #990000">.</span>org
mail<span style="color: #990000">.</span>password<span style="font-weight: bold"><span style="color: #0000FF">=</span></span>correct horse battery staple
mail<span style="color: #990000">.</span>smtp<span style="color: #990000">.</span>host<span style="font-weight: bold"><span style="color: #0000FF">=</span></span>smtp<span style="color: #990000">.</span>sendgrid<span style="color: #990000">.</span>net</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_66">Discussion</h4>
<div class="paragraph"><p>We&#8217;ve used Lift properties as a way to configure SMTP authentication.
This has the benefit of allowing us to enable authentication for just
some run modes. For example, if our <span class="monospaced">default.props</span> did not contain
authentication settings, but our <span class="monospaced">production.default.props</span> did, then no
authentication would happen in development mode, ensuring we can&#8217;t
accidentally send email outside of a production environment.</p></div>
<div class="paragraph"><p>But you don&#8217;t have to use a properties file for this (the Lift Mailer
also supports JNDI). However, some mail services do require
<span class="monospaced">mail.smtp.auth=true</span> to be set.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_68">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
The <a href="http://javamail.kenai.com/nonav/javadocs/com/sun/mail/smtp/package-summary.html">com.sun.mail.smtp description</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_email_with_attachments">Sending email with attachments</h3>
<div class="sect3">
<h4 id="_problem_70">Problem</h4>
<div class="paragraph"><p>You want to send an email with one or more attachments.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_69">Solution</h4>
<div class="paragraph"><p>Use Mailer&#8217;s <span class="monospaced">XHTMLPlusImages</span> body types:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> content <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"Planet,Discoverer</span><span style="color: #CC33CC">\r\n</span><span style="color: #FF0000">"</span> <span style="color: #990000">+</span>
  <span style="color: #FF0000">"HR 8799 c, Marois et al</span><span style="color: #CC33CC">\r\n</span><span style="color: #FF0000">"</span> <span style="color: #990000">+</span>
  <span style="color: #FF0000">"Kepler-22b, Kepler Science Team</span><span style="color: #CC33CC">\r\n</span><span style="color: #FF0000">"</span>

<span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">CSVFile</span><span style="color: #990000">(</span>bytes<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Array<span style="color: #990000">[</span><span style="color: #009900">Byte</span><span style="color: #990000">],</span>
  filename<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"file.csv"</span><span style="color: #990000">,</span>
  mime<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"text/csv; charset=utf8; header=present"</span> <span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> attach <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">CSVFile(content.mkString.getBytes</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"utf8"</span><span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> body <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>Please research the enclosed<span style="color: #990000">.&lt;/</span>p<span style="color: #990000">&gt;</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> msg <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">XHTMLPlusImages</span></span><span style="color: #990000">(</span>body<span style="color: #990000">,</span>
  <span style="font-weight: bold"><span style="color: #000000">PlusImageHolder</span></span><span style="color: #990000">(</span>attach<span style="color: #990000">.</span>filename<span style="color: #990000">,</span> attach<span style="color: #990000">.</span>mime<span style="color: #990000">,</span> attach<span style="color: #990000">.</span>bytes<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #000000">Mailer.sendMail</span></span><span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #000000">From</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"me@example.org"</span><span style="color: #990000">,</span>
  <span style="font-weight: bold"><span style="color: #000000">Subject</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Planets"</span><span style="color: #990000">),</span>
  <span style="font-weight: bold"><span style="color: #000000">To</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"you@example.org"</span><span style="color: #990000">),</span>
  msg<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_67">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">XHTMLPlusImages</span> can also accept more than one <span class="monospaced">PlusImageHolder</span> if you
have more than one file to attach.</p></div>
<div class="paragraph"><p>Messages are sent using the "related" multi-part mime heading with
"inline" disposition.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_69">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Lift ticket 1197 to <a href="https://github.com/lift/framework/issues/1197">improve Mailer functionality for attachments</a>
</p>
</li>
<li>
<p>
Wikipedia entry on <a href="http://en.wikipedia.org/wiki/MIME">Multipurpose Internet Mail Extensions (MIME)</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_email_rather_than_sending">Logging email rather than sending</h3>
<div class="sect3">
<h4 id="_problem_71">Problem</h4>
<div class="paragraph"><p>You don&#8217;t want email sent when developing your Lift application locally,
but you do want to see what would have been sent.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_70">Solution</h4>
<div class="paragraph"><p>The solution is to use <span class="monospaced">Mailer.devModeSend</span> and here is an example for
<span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Mailer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> javax<span style="color: #990000">.</span>mail<span style="color: #990000">.</span>internet<span style="color: #990000">.</span><span style="color: #FF0000">{</span>MimeMessage<span style="color: #990000">,</span>MimeMultipart<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">stringify</span></span><span style="color: #990000">(</span>m<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Any<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> m <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> mm<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> MimeMultipart <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">mm.getBodyPart</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">).</span>getContent
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> otherwise <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> otherwise<span style="color: #990000">.</span>toString
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000000">Mailer.devModeSend.default.set(</span></span> <span style="color: #990000">(</span>m<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> MimeMessage<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #000000">logger.info</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Would have sent "</span><span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #000000">stringify</span></span><span style="color: #990000">(</span>m<span style="color: #990000">.</span>getContent<span style="color: #990000">))</span>
<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This example is changing the behaviour of <span class="monospaced">Mailer</span> when your Lift
application is in developer mode (which it is by default). We are
logging a message only, and using a utility function to get the contents
of the first body part of the message. The key part is setting a
<span class="monospaced">MimeMessage =&gt; Unit</span> function on <span class="monospaced">Mailer.devModeSend</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_68">Discussion</h4>
<div class="paragraph"><p>When developing an application it is inconvenient to have to worry about
setting up an SMTP server or inadvertently sending test messages to
users. The above is a useful way to know what would have been sent.</p></div>
<div class="paragraph"><p>You can control how and if mail is sent using the <span class="monospaced">*ModeSend</span> functions
available for the different Lift RunModes (dev, staging, production,
profile, pilot and test). The default is to send email, except for
<span class="monospaced">testModeSend</span>, which only logs the send.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_run_a_task_later">Run a task later</h3>
<div class="sect3">
<h4 id="_problem_72">Problem</h4>
<div class="paragraph"><p>You want to schedule code to run later.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_71">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">net.liftweb.util.Schedule</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">Schedule(</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"doing it"</span><span style="color: #990000">),</span> <span style="color: #993399">30</span> seconds<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This would cause "doing it" to be printed on the console after 30
seconds.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_69">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">Schedule</span> also includes a <span class="monospaced">schedule</span> method which will send a specified
actor a specified message after a given delay.</p></div>
<div class="paragraph"><p>The above example makes use of the Lift <span class="monospaced">TimeHelpers</span>, but there are
variant calls that accept <span class="monospaced">Long</span> millisecond values.</p></div>
<div class="paragraph"><p>Schedule returns a <span class="monospaced">ScheduledFuture[Unit]</span> from the Java concurrency
library, which allows you to <span class="monospaced">cancel</span> the activity.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_70">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/Schedule.scala">Schedule.scala</a>
source.
</p>
</li>
<li>
<p>
<a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ScheduledFuture.html">java.util.concurrent.ScheduledFuture</a> JavaDoc.
</p>
</li>
<li>
<p>
Recipe for <a href="Run+tasks+periodically.html">Running tasks periodically</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="RunTasksPeriodically">Run Tasks Periodically</h3>
<div class="sect3">
<h4 id="_problem_73">Problem</h4>
<div class="paragraph"><p>You want a scheduled task to run periodically.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_72">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">net.liftweb.util.Schedule</span> ensuring that you call <span class="monospaced">schedule</span> again
during your task to re-schedule it. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Schedule
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>actor<span style="color: #990000">.</span>LiftActor
<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Helpers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> MyScheduledTask <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> LiftActor <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">DoIt</span><span style="color: #990000">()</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Stop</span><span style="color: #990000">()</span>

  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> stopped <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>

   <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> messageHandler <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
     <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> DoIt <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
       <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(!</span>stopped<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #000000">Schedule.schedule</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> DoIt<span style="color: #990000">,</span> <span style="color: #993399">10</span> minutes<span style="color: #990000">)</span>
       <span style="font-style: italic"><span style="color: #9A1900">// ... do useful work here</span></span>

     <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> Stop <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
       stopped <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The example creates a <span class="monospaced">LiftActor</span> for the work to be done. On receipt of
a <span class="monospaced">DoIt</span> message, the actor re-schedules itself before doing whatever
useful work needs to be done. In this way, the actor will be called
every 10 minutes.</p></div>
<div class="paragraph"><p>The <span class="monospaced">Schedule.schedule</span> call is ensuring that <span class="monospaced">this</span> actor is sent the
<span class="monospaced">DoIt</span> message after 10 minutes.</p></div>
<div class="paragraph"><p>To start this process off, possibly in <span class="monospaced">Boot.scala</span>, just send the
<span class="monospaced">DoIt</span> message to the actor.</p></div>
<div class="paragraph"><p>To ensure the process stops correctly when Lift shuts down, we register
a shutdown hook in <span class="monospaced">Boot.scala</span> to send the <span class="monospaced">Stop</span> message to prevent
future re-schedules:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">LiftRules.unloadHooks.append(</span></span> <span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> MyScheduledTask <span style="color: #990000">!</span> MyScheduledTask<span style="color: #990000">.</span>Stop <span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_70">Discussion</h4>
<div class="paragraph"><p>Without the <span class="monospaced">Stop</span> message your actor would continue to be rescheduled
until the JVM exits. This may be acceptable, but note that during
development with SBT, without the <span class="monospaced">Stop</span> message, you will continue to
schedule tasks after issuing the <span class="monospaced">container:stop</span> command.</p></div>
<div class="paragraph"><p>Schedule returns a <span class="monospaced">ScheduledFuture[Unit]</span> from the Java concurrency
library, which allows you to <span class="monospaced">cancel</span> the activity.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_71">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/Schedule.scala">Schedule.scala</a> source.
</p>
</li>
<li>
<p>
<a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ScheduledFuture.html">java.util.concurrent.ScheduledFuture</a> JavaDoc.
</p>
</li>
<li>
<p>
Chapter 1 of <em>Lift in Action</em> includes a CometActor clock example that
uses <span class="monospaced">Schedule</span>, and further examples can be found in chapters 4 and 9.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_fetching_urls">Fetching URLs</h3>
<div class="sect3">
<h4 id="_problem_74">Problem</h4>
<div class="paragraph"><p>You want to fetch a URL from inside your Lift app.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_73">Solution</h4>
<div class="paragraph"><p>Use <em>Dispatch</em>, "a library for HTTP interaction, from asynchronous GETs
to multi-part OAuth-enticated POSTs". Before you start, include the
dependencies in your <span class="monospaced">build.sbt</span> file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>libraryDependencies <span style="color: #990000">++</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Seq</span></span><span style="color: #990000">(</span>
 <span style="color: #FF0000">"net.databinder"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"dispatch-core"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"0.8.8"</span><span style="color: #990000">,</span>
 <span style="color: #FF0000">"net.databinder"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"dispatch-http"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"0.8.8"</span><span style="color: #990000">,</span>
 <span style="color: #FF0000">"net.databinder"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"dispatch-tagsoup"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"0.8.8"</span>
<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Databinder is structured into a set of modules (e.g., for oAuth and
Twitter). Above we&#8217;re including a set for an example of fetching a URL
and extracting all the meta tags:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> scala<span style="color: #990000">.</span>xml<span style="color: #990000">.</span>NodeSeq
<span style="font-weight: bold"><span style="color: #000080">import</span></span> dispatch<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> dispatch<span style="color: #990000">.</span>tagsoup<span style="color: #990000">.</span>TagSoupHttp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> page <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">url</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"http://www.w3.org/"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">metas</span></span><span style="color: #990000">(</span>ns<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> NodeSeq<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> ns <span style="color: #990000">\\</span> <span style="color: #FF0000">"meta"</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> result<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> NodeSeq <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Http</span></span><span style="color: #990000">(</span>page <span style="color: #990000">&lt;/&gt;</span> metas<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The above produces:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">NodeSeq</span></span><span style="color: #990000">(&lt;</span>meta content<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"text/html; charset=utf-8"</span> http<span style="color: #990000">-</span>equiv<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"Content-Type"</span><span style="color: #990000">&gt;&lt;/</span>meta<span style="color: #990000">&gt;,</span>
 <span style="color: #990000">&lt;</span>meta content<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"width=device-width"</span> name<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"viewport"</span><span style="color: #990000">&gt;&lt;/</span>meta<span style="color: #990000">&gt;,</span>
 <span style="color: #990000">&lt;</span>meta content<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"The World Wide Web Consortium (W3C) is an international community where</span>
<span style="color: #FF0000">  Member organizations, a full-time staff, and the public work together to develop Web</span>
<span style="color: #FF0000">  standards."</span> name<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"description"</span><span style="color: #990000">&gt;&lt;/</span>meta<span style="color: #990000">&gt;)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_71">Discussion</h4>
<div class="paragraph"><p>As URL fetching has latency, you will want to look at making the request
from an actor, a lazy-load snippet, via the various Dispatch executors
or similar mechanism.</p></div>
<div class="paragraph"><p><em>Dispatch</em> offers a range of operators in addition to the <span class="monospaced">&lt;/&gt;</span> XML one
used above. You can extract text, JSON, consume the stream, or throw
away the content. The <em>Periodic table</em> gives a great high-level view of
what&#8217;s available.</p></div>
<div class="paragraph"><p>Related to <em>TagSoup</em>, <em>Dispatch</em> also integrates with <em>JSoup</em>, which
includes functions for manipulating the real-world HTML you fetch.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_72">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://dispatch.databinder.net/Dispatch.html">Dispatch</a>.
</p>
</li>
<li>
<p>
<a href="http://www.flotsam.nl/dispatch-periodic-table.html">Periodic table of Dispatch operators</a>.
</p>
</li>
<li>
<p>
<a href="http://dispatch.databinder.net/JSoup.html">JSoup Dispatch</a> documentation.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deployment">Production Deployment</h2>
<div class="sectionbody">
<div class="paragraph"><p>Deploying a Lift application to production means little more than packaging it and ensuring you set the <em>run mode</em> to <span class="monospaced">production</span>. The recipes in this chapter show how to do this for various hosted services.</p></div>
<div class="paragraph"><p>You can also install and run a <em>container</em> such as Tomcat or Jetty on your own servers. Containers were introduced in <a href="#RunningYourApplication">[RunningYourApplication]</a>. This brings with it the need to understand how to install, configure, start, stop and manage each container, and how to integrate it with load balancers or other front-ends. These are large topics, and you can find out more from such sources as:</p></div>
<div class="ulist"><ul>
<li>
<p>
The deployment section of the Lift Wiki at <a href="https://www.assembla.com/spaces/liftweb/wiki/Deployment">https://www.assembla.com/spaces/liftweb/wiki/Deployment</a>.
</p>
</li>
<li>
<p>
Timothy Perrett (2012), <em>Lift in Action</em>, Chapter 15, "Deployment and scaling", Manning Publications Co.
</p>
</li>
<li>
<p>
Jason Brittain and Ian F. Darwin (2007), <em>Tomcat: The Definitive Guide</em>, O&#8217;Reilly Media, Inc.
</p>
</li>
<li>
<p>
Tanuj Khare (2012) <em>Apache Tomcat 7 Essentials</em>, Packt Publishing.
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="CloudBees">Deploying to CloudBees</h3>
<div class="sect3">
<h4 id="_problem_75">Problem</h4>
<div class="paragraph"><p>You have an account with the CloudBees PaaS hosting environment, and you
want to deploy your Lift application there.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_74">Solution</h4>
<div class="paragraph"><p>Use the SBT <span class="monospaced">package</span> command to produce a WAR file that can be deployed
to CloudBees, and then use the CloudBees SDK to configure and deploy your
application.</p></div>
<div class="paragraph"><p>From within the CloudBees "Grand Central" console, create a new application under your account. In what follows we&#8217;ll assume your account is called <em>myaccount</em> and your application is called <em>myapp</em>.</p></div>
<div class="paragraph"><p>For the best performance you will want to ensure the Lift run mode is set to
"production". Do this from the CloudBees SDK command line:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ bees config<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">set</span></span> -a myaccount/myapp run<span style="color: #990000">.</span><span style="color: #009900">mode</span><span style="color: #990000">=</span>production</tt></pre></div></div>
<div class="paragraph"><p>This will set the run mode to production for your CloudBees applications
identified as "myaccount/myapp". Omitting the <span class="monospaced">-a</span> will set it for your
whole CloudBees account.</p></div>
<div class="paragraph"><p>CloudBees will remember this setting, so you only need to do it once.</p></div>
<div class="paragraph"><p>You can then deploy:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ sbt package
<span style="color: #990000">...</span>
<span style="color: #990000">[</span>info<span style="color: #990000">]</span> Packaging /Users/richard/myapp/target/scala-<span style="color: #993399">2.9</span><span style="color: #990000">.</span><span style="color: #993399">1</span>/myapp<span style="color: #990000">.</span>war<span style="color: #990000">...</span>
<span style="color: #990000">...</span>
$ bees -a app<span style="color: #990000">:</span>deploy <span style="color: #990000">.</span>/target/scala-<span style="color: #993399">2.9</span><span style="color: #990000">.</span><span style="color: #993399">1</span>/myapp<span style="color: #990000">.</span>war</tt></pre></div></div>
<div class="paragraph"><p>This will send your WAR file to CloudBees and deploy it.  You&#8217;ll see the location (URL) of your application output from the bees <span class="monospaced">app:deploy</span> command when it completes.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_72">Discussion</h4>
<div class="paragraph"><p>If you are deploying an application to multiple CloudBees
instances, be aware that by default CloudBees will round robin requests
to each instance. If you use any of Lift&#8217;s state features you&#8217;ll want to
enable session affinity (sticky sessions):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ bees app<span style="color: #990000">:</span>update -a myaccount/myapp <span style="color: #009900">stickySession</span><span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you are using comet, it&#8217;ll work fine, but the CloudBees default is to enable
<em>request buffering</em>. This allows CloudBees to do smart things, such as re-routing
requests in a cluster if one machine does not respond. A
consequence of request buffering is that long-polling comet requests will timeout more
often. To turn this feature off, run the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ bees app<span style="color: #990000">:</span>update -a myaccount/myapp <span style="color: #009900">disableProxyBuffering</span><span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span></tt></pre></div></div>
<div class="paragraph"><p>As with the run mode setting, CloudBees will remember these settings, so you
only need to set them once.</p></div>
<div class="sect4">
<h5 id="_rdbms_configuration">RDBMS Configuration</h5>
<div class="paragraph"><p>If you are using a SQL database in your application, you&#8217;ll want to
configure <span class="monospaced">src/main/webapp/WEB-INF/cloudbees-web.xml</span>. For
example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;cloudbees-web-app</span></span> <span style="color: #009900">xmlns</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://www.cloudbees.com/xml/webapp/1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;appid&gt;</span></span>myaccount/myapp<span style="font-weight: bold"><span style="color: #0000FF">&lt;/appid&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;resource</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"jdbc/mydb"</span> <span style="color: #009900">auth</span><span style="color: #990000">=</span><span style="color: #FF0000">"Container"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"javax.sql.DataSource"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"username"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"dbuser"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"password"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"dbpassword"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"url"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"jdbc:cloudbees://mydb"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

  <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- For these connections settings, see:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">   http://commons.apache.org/dbcp/configuration.html</span></span>
<span style="font-style: italic"><span style="color: #9A1900">  --&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"maxActive"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"maxIdle"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"2"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"maxWait"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"15000"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"removeAbandoned"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"removeAbandonedTimeout"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"300"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"logAbandoned"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

  <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- Avoid idle timeouts --&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"validationQuery"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"SELECT 1"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;param</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"testOnBorrow"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/resource&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;/cloudbees-web-app&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The above is a JNDI database configuration, defining a connection to a
CloudBees database called "mydb". This will be used by Lift if the JNDI
name is referenced in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DefaultConnectionIdentifier<span style="color: #990000">.</span>jndiName <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"jdbc/mydb"</span>

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(!</span>DB<span style="color: #990000">.</span>jndiJdbcConnAvailable<span style="font-weight: bold"><span style="color: #0000FF">_</span></span><span style="color: #990000">?)</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// set up alternative local database connection here</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Because the JDNI setting is only defined in <span class="monospaced">cloudbees-web.xml</span> it will
only be available in a CloudBees environment. This means you can develop
against a different database locally, and use your CloudBees database
when deploying.</p></div>
</div>
<div class="sect4">
<h5 id="_host_ip_and_port_number">Host IP and Port Number</h5>
<div class="paragraph"><p>Generally you don&#8217;t need to know about your deployed instance&#8217;s public host name and port number. Requests to your application URL are routed to the specific instance by CloudBees. However there are situations, especially when you have multiple instances, where you do need to find this out. For example, if you want to receive messages from Amazon&#8217;s Simple Notification Service (SNS), then each instance will need to give a direct URL to SNS when the application boots.</p></div>
<div class="paragraph"><p>To get the public hostname, you need to make a HTTP request to <span class="monospaced">http://instance-data/latest/meta-data/public-hostname</span>, as documented at <a href="https://developer.cloudbees.com/bin/view/Main/Finding+out+app+port+and+hostname">https://developer.cloudbees.com/bin/view/Main/Finding+out+app+port+and+hostname</a>.  For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> io<span style="color: #990000">.</span>Source

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> beesPublicHostname <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Box<span style="color: #990000">[</span>String<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> tryo <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">Source.fromURL</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"http://instance-data/latest/meta-data/public-hostname"</span><span style="color: #990000">).</span>
    <span style="font-weight: bold"><span style="color: #000000">getLines</span></span><span style="color: #990000">().</span>toStream<span style="color: #990000">.</span>head
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This will return a <span class="monospaced">Full</span> hostname on the CloudBees environment, but when running locally will fail and return a <span class="monospaced">Failure</span>. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">Failure(instance-data,Full</span></span><span style="color: #990000">(</span>java<span style="color: #990000">.</span>net<span style="color: #990000">.</span>UnknownHostException<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> instance<span style="color: #990000">-</span>data<span style="color: #990000">),</span>Empty<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The port number can be read from the JVM system property of <span class="monospaced">sun.java.command</span>. This is the command that started your application and it includes the port number. An example would be:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>net.stax.appserver.bootstrap.Bootstrap -dir /var/genapp/apps/d414b3f4/staxcat
  -port 8783 -config /var/genapp/apps/d414b3f4/appserver.xml</pre>
</div></div>
<div class="paragraph"><p>We can pick out the port number with a regular expression:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> beesPort <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Box<span style="color: #990000">[</span>String<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #FF0000">{</span>
  command <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> Box <span style="color: #990000">!!</span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"sun.java.command"</span><span style="color: #990000">)</span>
  port <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> <span style="color: #FF0000">""".*-port (</span><span style="color: #CC33CC">\d</span><span style="color: #FF0000">+) .*"""</span><span style="color: #990000">.</span>r findFirstMatchIn command
<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">yield</span></span> port group <span style="color: #993399">1</span></tt></pre></div></div>
<div class="paragraph"><p>Running locally this will return a <span class="monospaced">Empty</span> box, but on CloudBees you&#8217;ll see a <span class="monospaced">Full[String]</span> port number.</p></div>
<div class="paragraph"><p>You might put these two values together as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>net<span style="color: #990000">.</span>InetAddress

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> hostAndPort <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
  <span style="color: #990000">(</span>beesPublicHostname openOr InetAddress<span style="color: #990000">.</span>getLocalHost<span style="color: #990000">.</span>getHostAddress<span style="color: #990000">)</span> <span style="color: #990000">+</span>
  <span style="color: #FF0000">":"</span> <span style="color: #990000">+</span> <span style="color: #990000">(</span>beesPort openOr <span style="color: #FF0000">"8080"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Running locally <span class="monospaced">hostAndPort</span> might be <span class="monospaced">192.168.1.60:8080</span> and running on CloudBees it would be something like <span class="monospaced">ec2-204-236-222-252.compute-1.amazonaws.com:8520</span>.</p></div>
</div>
<div class="sect4">
<h5 id="_clickstarts">ClickStarts</h5>
<div class="paragraph"><p>ClickStart Applications are templates to quickly get an application, and automated build, up and running at CloudBees. The Lift ClickStart creates a private Git source repository at CloudBees which contains a Lift 2.4 application, provisions a MySQL database, creates a Maven-based Jenkins build, and deploys the application.  All you need to do is provide a name for the application (without whitespace).</p></div>
<div class="paragraph"><p>To access the Git source repository created for you, you&#8217;ll need to upload a SSH public key. You can do this in the "My Keys" section of your account settings on the CloudBees web site.</p></div>
<div class="paragraph"><p>The build that&#8217;s created for you will automatically build and deploy your application to CloudBees when you push changes to your Git repository.</p></div>
<div class="paragraph"><p>If all of that&#8217;s a good match to the technologies and services you want to use, ClickStart is a great way to deploy your application. Alternatively, it gives you a starting point from which you can modify elements; or you could fork the CloudBees Lift template and create your own from <a href="https://github.com/CloudBees-community/lift_template">https://github.com/CloudBees-community/lift_template</a>.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_73">See Also</h4>
<div class="paragraph"><p>The CloudBees SDK provides command line tools for configuring and controlling applications. It can be found at <a href="https://wiki.cloudbees.com/bin/view/RUN/BeesSDK">https://wiki.cloudbees.com/bin/view/RUN/BeesSDK</a>.</p></div>
<div class="paragraph"><p>The CloudBees developer portal (<a href="https://developer.cloudbees.com">https://developer.cloudbees.com</a>)contains a "Resources" section which provides details of the CloudBees services.</p></div>
<div class="paragraph"><p>A plugin is available to automate deployments from SBT. The plugin and the excellent
instructions for installing and configuring it can be found at <a href="https://github.com/timperrett/sbt-cloudbees-plugin">https://github.com/timperrett/sbt-cloudbees-plugin</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="Beanstalk">Deploying to Amazon Elastic Beanstalk</h3>
<div class="sect3">
<h4 id="_problem_76">Problem</h4>
<div class="paragraph"><p>You want to run your Lift application on Amazon Web Services (AWS) Elastic Beanstalk.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_75">Solution</h4>
<div class="paragraph"><p>Create a new Tomcat 7 <em>environment</em>, use SBT to package your Lift application as a WAR file, and then deploy the application to your environment.</p></div>
<div class="paragraph"><p>To create a new environment, visit the AWS console, navigate to Elastic Beanstalk and select "Apache Tomcat 7" as your environment. This will create and launch a default Beanstalk application. This will take a few minutes, but eventually report "Successfully running version Sample Application". You&#8217;ll be shown the URL of the application (something like <span class="monospaced">http://default-environment-nsdmixm7ja.elasticbeanstalk.com</span>) and visiting the URL you&#8217;re given will show the running default Amazon application.</p></div>
<div class="paragraph"><p>Prepare your WAR file by running:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ sbt package</tt></pre></div></div>
<div class="paragraph"><p>This will write a WAR file into the <span class="monospaced">target</span> folder.  To deploy this WAR file from the AWS Beanstalk web console (see <a href="#ConsoleImage">[ConsoleImage]</a>), select the "Versions" tab under the "Elastic Beanstalk Application Details" and click the "Upload new version" button. You&#8217;ll be given a dialog where you give a version label and use the "Choose file" button to select the WAR file you just built.  You can either upload and deploy in one step, or upload first and then select the version in the console and hit the "Deploy" button.</p></div>
<div class="paragraph"><p>The Beanstalk console will show "Environment updating&#8230;" and after some minutes it&#8217;ll report "Successfully running".  Your Lift application is now deployed and running on Beanstalk.</p></div>
<div class="paragraph"><p>A final step is to enable Lift&#8217;s production run mode. From the environment in the AWS Beanstalk web console, follow the "Edit Configuration" link. A dialog will appear, and under the "Container" tab add <span class="monospaced">-Drun.mode=production</span> to the "JVM Command Line Options" and hit "Apply Changes" to redeploy your application.</p></div>
<div class="imageblock" id="ConsoleImage">
<div class="content">
<img src="images/beanstalkconsole.png" alt="images/beanstalkconsole.png" width="640">
</div>
<div class="title">Figure 3. AWS Console, with Elastic Beanstalk service selected.</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_73">Discussion</h4>
<div class="paragraph"><p>Elastic Beanstalk provides a pre-built stack of software and infrastructure, in this case: Linux, Tomcat 7, a 64 bit "t1.micro" EC2 instance, load balancing, and an S3 bucket. That&#8217;s the <em>environment</em> and it has reasonable default settings.  Beanstalk also provides an easy way to deploy your Lift application.  As we&#8217;ve seen in this recipe, you upload an application (WAR file) to Beanstalk and deploy it to the environment.</p></div>
<div class="paragraph"><p>As with many cloud providers keep in mind that you want to avoid local file storage. The reason for this is to allow instances to be terminated or restarted without data loss. With your Beanstalk application you do have a file system and you can write to it, but it is lost if the image is restarted. You can get persistent local file storage, for example using Amazon Elastic Block Storage, but you&#8217;re fighting against the nature of the platform.</p></div>
<div class="paragraph"><p>Log files are written to the local file system. To access them, from the AWS console, navigate to your environment, into the "Logs" tab and hit the "Snapshot" button. This will take a copy of the logs and store them in an S3 bucket, and give you a link to the file contents.  This is a single file showing the content of variety of log files, and <span class="monospaced">catalina.out</span> will be the one showing any output from your Lift application.  If you want to try to keep these log files around, you can configure the environment to rotate the logs to S3 every hour from the "Container" tab under "Edit Configuration".</p></div>
<div class="paragraph"><p>The Lift application WAR files are stored in the same S3 bucket that the logs are stored in. From the AWS console, you&#8217;ll find it under the S3 page listed with a name like <span class="monospaced">elasticbeanstalk-us-east-1-5989673916964</span>. You&#8217;ll note that the AWS uploads makes your WAR filename unique by adding a prefix to each filename. If you need to be able to tell the difference between these files in S3, one good approach is to is to bump the <span class="monospaced">version</span> value in your <span class="monospaced">build.sbt</span> file.  This version number is included in the WAR filename.</p></div>
<div class="sect4">
<h5 id="_multiple_instances">Multiple Instances</h5>
<div class="paragraph"><p>Beanstalks enables <em>auto scaling</em> by default. That is, it launches a single instance of your Lift application, but if the load increases above a threshold, up to four instances may be running.</p></div>
<div class="paragraph"><p>If you&#8217;re making use of Lift&#8217;s state features, you&#8217;ll need to enable sticky sessions from the "Load Balancer" tab of the environment configuration. It&#8217;s a check box named "Enable Session Stickiness"--it&#8217;s easy to miss, but that tab does scroll to show more options if you don&#8217;t see it first time.</p></div>
</div>
<div class="sect4">
<h5 id="_working_with_a_database">Working with a Database</h5>
<div class="paragraph"><p>There&#8217;s nothing unusual you have to do to use Lift and a database from Beanstalk. However, Beanstalk does try to make it easy for you to work with Amazon&#8217;s Relational Database Service (RDS).  Either when creating your Beanstalk environment, or from the configuration options later, you can add an RDS instance, which cab be an Oracle, SQL-Server or MySQL database.</p></div>
<div class="paragraph"><p>The MySQL option will create a MySQL 5.5 InnoDB database. The database will be accessible from Beanstalk, but not from elsewhere on the Internet. To change that, modify the security groups for the RDS instance from the AWS web console.  For example, you might permit access from your IP address.</p></div>
<div class="paragraph"><p>When your application launches with an associated RDS instance, the JVM system properties include settings for the database name, host, port, user and password.  You could pull them together like this in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">Class.forName</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"com.mysql.jdbc.Driver"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> connection <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #FF0000">{</span>
  host <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> Box <span style="color: #990000">!!</span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"RDS_HOSTNAME"</span><span style="color: #990000">)</span>
  port <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> Box <span style="color: #990000">!!</span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"RDS_PORT"</span><span style="color: #990000">)</span>
  db   <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> Box <span style="color: #990000">!!</span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"RDS_DB_NAME"</span><span style="color: #990000">)</span>
  user <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> Box <span style="color: #990000">!!</span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"RDS_USERNAME"</span><span style="color: #990000">)</span>
  pass <span style="font-weight: bold"><span style="color: #0000FF">&lt;-</span></span> Box <span style="color: #990000">!!</span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"RDS_PASSWORD"</span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">yield</span></span> <span style="font-weight: bold"><span style="color: #000000">DriverManager.getConnection</span></span><span style="color: #990000">(</span>
    <span style="color: #FF0000">"jdbc:mysql://%s:%s/%s"</span> <span style="font-weight: bold"><span style="color: #000000">format</span></span> <span style="color: #990000">(</span>host<span style="color: #990000">,</span>port<span style="color: #990000">,</span>db<span style="color: #990000">),</span>
    user<span style="color: #990000">,</span> pass<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>That would give you a <span class="monospaced">Box[Connection]</span> which, if <span class="monospaced">Full</span>, you could use in a <span class="monospaced">SquerylRecord.initWithSquerylSession</span> call for example (see <a href="#Squeryl">[Squeryl]</a>).</p></div>
<div class="paragraph"><p>Alternatively you might want to guarantee a connection by supplying defaults for all the values with something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">Class.forName</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"com.mysql.jdbc.Driver"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> connection <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> host <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"RDS_HOSTNAME"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"localhost"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> port <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"RDS_PORT"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"3306"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> db <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"RDS_DB_NAME"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"db"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> user <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"RDS_USERNAME"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sa"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> pass <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">System.getProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"RDS_PASSWORD"</span><span style="color: #990000">,</span> <span style="color: #FF0000">""</span><span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #000000">DriverManager.getConnection</span></span><span style="color: #990000">(</span>
    <span style="color: #FF0000">"jdbc:mysql://%s:%s/%s"</span> <span style="font-weight: bold"><span style="color: #000000">format</span></span> <span style="color: #990000">(</span>host<span style="color: #990000">,</span>port<span style="color: #990000">,</span>db<span style="color: #990000">),</span>
    user<span style="color: #990000">,</span> pass<span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_74">See Also</h4>
<div class="paragraph"><p>Amazon provide a walk-through with screen shots, showing how to create a Beanstalk application.  It&#8217;s at: <a href="http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/GettingStarted.Walkthrough.html">http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/GettingStarted.Walkthrough.html</a>.</p></div>
<div class="paragraph"><p><em>Elastic Beanstalk</em>, by van Villet <em>et al</em> (2011, O&#8217;Reilly Media, Inc) goes into the details of the Beanstalk infrastructure, how to work with Eclipse, enabling continuous integration, and how to hack the instance, for example to use NGINX as a front-end to Beanstalk.</p></div>
<div class="paragraph"><p>The Amazon documentation for "Configuring Databases with AWS Elastic Beanstalk" describes the RDS settings in more detail: <a href="http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/using-features.managing.db.html">http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/using-features.managing.db.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="HerokuDeployment">Deploying to Heroku</h3>
<div class="sect3">
<h4 id="_problem_77">Problem</h4>
<div class="paragraph"><p>You want to deploy your Lift application to your account on the Heroku cloud platform.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_76">Solution</h4>
<div class="paragraph"><p>Package your Lift application as a WAR file and use the Heroku deploy plugin to send and run your application. This will give you an application running under Tomcat 7. Anyone can use this method to deploy an application but Heroku only provide support for it for Enterprise Java customers.</p></div>
<div class="paragraph"><p>This recipe walks through the process in three stages: one-time set up; deployment of the WAR; and configuration of your Lift application for production performance.</p></div>
<div class="paragraph"><p>If you&#8217;ve not already done so, download and install the Heroku command line tools ("Toolbelt") and login using your Heuroku credentials and upload an SSH key:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ heroku login
Enter your Heroku credentials.
Email: you@example.org
Password (typing will be hidden):
Found the following SSH public keys:
1) github.pub
2) id_rsa.pub
Which would you like to use with your Heroku account? 2
Uploading SSH public key ~/.ssh/id_rsa.pub... done
Authentication successful.</pre>
</div></div>
<div class="paragraph"><p>Install the deploy plugin:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ heroku plugins:install https://github.com/heroku/heroku-deploy
Installing heroku-deploy... done</pre>
</div></div>
<div class="paragraph"><p>With that one-time set up complete, you can create an application on Heroku. Here we&#8217;ve not specified a name so we given a random name of <span class="monospaced">glacial-waters-6292</span> which we will use throughout this recipe:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ heroku create
Creating glacial-waters-6292... done, stack is cedar
http://glacial-waters-6292.herokuapp.com/ | git@heroku.com:glacial-waters-6292.git</pre>
</div></div>
<div class="paragraph"><p>Before deploying, we set the Lift run mode to production.  This is done via the <span class="monospaced">config:set</span> command.  First check the current settings for <span class="monospaced">JAVA_OPTS</span> and then modify the options by adding <span class="monospaced">-Drun.mode=production</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ heroku config:get JAVA_OPTS --app glacial-waters-6292
-Xmx384m -Xss512k -XX:+UseCompressedOops

$ heroku config:set JAVA_OPTS="-Drun.mode=production -Xmx384m -Xss512k
  -XX:+UseCompressedOops" --app glacial-waters-6292</pre>
</div></div>
<div class="paragraph"><p>We can deploy to Heroku by packaging the application as a WAR file, and then running the Heroku <span class="monospaced">deploy:war</span> command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ sbt package
<span style="color: #990000">....</span>
<span style="color: #990000">[</span>info<span style="color: #990000">]</span> Packaging target/scala-<span style="color: #993399">2.9</span><span style="color: #990000">.</span><span style="color: #993399">1</span>/myapp-<span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span>war <span style="color: #990000">...</span>
<span style="color: #990000">....</span>
$ heroku deploy<span style="color: #990000">:</span>war --war target/scala-<span style="color: #993399">2.9</span><span style="color: #990000">.</span><span style="color: #993399">1</span>/myapp-<span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span>war
  --app glacial-waters-<span style="color: #993399">6292</span>
Uploading target/scala-<span style="color: #993399">2.9</span><span style="color: #990000">.</span><span style="color: #993399">1</span>/myapp-<span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span>war<span style="color: #990000">............</span><span style="font-weight: bold"><span style="color: #0000FF">done</span></span>
Deploying to glacial-waters-<span style="color: #993399">6292</span><span style="color: #990000">.........</span><span style="font-weight: bold"><span style="color: #0000FF">done</span></span>
Created release v6</tt></pre></div></div>
<div class="paragraph"><p>Your Lift application is now running on Heroku.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_74">Discussion</h4>
<div class="paragraph"><p>There are a few important comments regarding Lift applications on Heroku. First, note that there&#8217;s no support for session affinity. This means if you deploy to multiple <em>dynos</em> (Heroku terminology for instances), there is no co-ordination over which requests go to which servers. As a consequence, you won&#8217;t be able to make use of Lift&#8217;s stateful features and will want to turn them off (<a href="#RunningStateless">[RunningStateless]</a> describes for how to do that).</p></div>
<div class="paragraph"><p>Second, if you are using Lift comet features, there&#8217;s an adjustment to make in <span class="monospaced">Boot.scala</span> to work a little better in the Heroku environment:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>LiftRules<span style="color: #990000">.</span>cometRequestTimeout <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Full</span></span><span style="color: #990000">(</span><span style="color: #993399">25</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This setting controls how long Lift waits before testing a comet connection. We&#8217;re replacing the Lift default of 120 seconds
with 25 seconds because Heroku terminates connections after 30 seconds.  Although Lift recovers from this, the user experience may be to see a delay when interacting with a page.</p></div>
<div class="paragraph"><p>A third important point to note is that the dyno will be restarted every day. Additionally, if you are only running one web dyno, it will be idled after an hour of inactivity. You can see this happening by tailing your application log:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ heroku logs -t --app glacial-waters-<span style="color: #993399">6292</span>
<span style="color: #990000">...</span>
<span style="color: #993399">2012</span>-<span style="color: #993399">12</span>-31T11<span style="color: #990000">:</span><span style="color: #993399">31</span><span style="color: #990000">:</span><span style="color: #993399">39</span><span style="color: #990000">+</span><span style="color: #993399">00</span><span style="color: #990000">:</span><span style="color: #993399">00</span> heroku<span style="color: #990000">[</span>web<span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">]:</span> Idling
<span style="color: #993399">2012</span>-<span style="color: #993399">12</span>-31T11<span style="color: #990000">:</span><span style="color: #993399">31</span><span style="color: #990000">:</span><span style="color: #993399">41</span><span style="color: #990000">+</span><span style="color: #993399">00</span><span style="color: #990000">:</span><span style="color: #993399">00</span> heroku<span style="color: #990000">[</span>web<span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">]:</span> Stopping all processes with SIGTERM
<span style="color: #993399">2012</span>-<span style="color: #993399">12</span>-31T11<span style="color: #990000">:</span><span style="color: #993399">31</span><span style="color: #990000">:</span><span style="color: #993399">43</span><span style="color: #990000">+</span><span style="color: #993399">00</span><span style="color: #990000">:</span><span style="color: #993399">00</span> heroku<span style="color: #990000">[</span>web<span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">]:</span> Process exited with status <span style="color: #993399">143</span>
<span style="color: #993399">2012</span>-<span style="color: #993399">12</span>-31T11<span style="color: #990000">:</span><span style="color: #993399">31</span><span style="color: #990000">:</span><span style="color: #993399">43</span><span style="color: #990000">+</span><span style="color: #993399">00</span><span style="color: #990000">:</span><span style="color: #993399">00</span> heroku<span style="color: #990000">[</span>web<span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">]:</span> State changed from up to down</tt></pre></div></div>
<div class="paragraph"><p>Anyone visiting your Lift application will cause Heroku to unidle your application.</p></div>
<div class="paragraph"><p>Note, though, that the application was stopped with a <span class="monospaced">SIGTERM</span>.  This is a Unix signal sent to a process, the JVM in this case, to request it to stop.  Unfortunately the Tomcat application on Heroku does not use this signal to request Lift to shutdown. This may be of little consequence to you, but if you do have external resources you want to release to other actions to take at shutdown, you need to register a shutdown hook with the JVM.</p></div>
<div class="paragraph"><p>For example, you might add this to <span class="monospaced">Boot.scala</span> if you&#8217;re running on Heroku:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">Runtime.getRuntime().addShutdownHook</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Thread <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Shutdown hook being called"</span><span style="color: #990000">)</span>
    <span style="font-style: italic"><span style="color: #9A1900">// Do useful clean up here</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Do not count on being able to do much during shutdown.  Heroku allows around 10 seconds before killing the JVM after issuing the <span class="monospaced">SIGTERM</span>.</p></div>
<div class="paragraph"><p>Possibly a more general approach is to perform clean up using Lift&#8217;s unload hooks (see <a href="#ShutdownHooks">[ShutdownHooks]</a>) and then arrange the hooks to be called when Heroku sends the signal to terminate:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">Runtime.getRuntime().addShutdownHook</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Thread <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    LiftRules<span style="color: #990000">.</span>unloadHooks<span style="color: #990000">.</span>toList<span style="color: #990000">.</span>foreach<span style="color: #FF0000">{</span> f <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> tryo <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #000000">f</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This handling of <span class="monospaced">SIGTERM</span> may be a surprise, but if we look at how the application is running on Heroku, things become clearer.  The dyno is an allocation of resources (512m of memory) and allows an arbitrary command to run. The command being run is a Java process starting a "webapp runner" package. You can see this in two ways. First, if you shell to your dyno, you&#8217;ll see a WAR file as well as a JAR file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ heroku run bash --app glacial-waters-<span style="color: #993399">6292</span>
Running `bash` attached to terminal<span style="color: #990000">...</span> up<span style="color: #990000">,</span> run<span style="color: #990000">.</span><span style="color: #993399">8802</span>
<span style="color: #990000">~</span> $ ls
Procfile  myapp-<span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span>war  webapp-runner-<span style="color: #993399">7.0</span><span style="color: #990000">.</span><span style="color: #993399">29.3</span><span style="color: #990000">.</span>jar</tt></pre></div></div>
<div class="paragraph"><p>Second, by looking at the processes executing:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ heroku ps --app glacial-waters-<span style="color: #993399">6292</span>
<span style="color: #990000">===</span> web<span style="color: #990000">:</span> `<span style="color: #009900">${PRE_JAVA}</span>java <span style="color: #009900">${JAVA_OPTS}</span> -jar webapp-runner-<span style="color: #993399">7.0</span><span style="color: #990000">.</span><span style="color: #993399">29.3</span><span style="color: #990000">.</span>jar
 --port <span style="color: #009900">${PORT}</span> <span style="color: #009900">${WEBAPP_RUNNER_OPTS}</span> myapp-<span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span>war`
web<span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">:</span> up <span style="color: #993399">2013</span><span style="color: #990000">/</span><span style="color: #993399">01</span><span style="color: #990000">/</span><span style="color: #993399">01</span> <span style="color: #993399">22</span><span style="color: #990000">:</span><span style="color: #993399">37</span><span style="color: #990000">:</span><span style="color: #993399">35</span> <span style="color: #990000">(~</span> 31s ago<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Here we see a Java process executing a JAR file called <span class="monospaced">webapp-runner-7.0.29.3.jar</span> which is passed our WAR file as an argument. This is not identical to the Tomcat <span class="monospaced">catalina.sh</span> script you may be more familiar with, but instead is this launcher process: <a href="https://github.com/jsimone/webapp-runner">https://github.com/jsimone/webapp-runner</a>. As it does not register a handler to deal with <span class="monospaced">SIGTERM</span>, so we will have to if we need to release any resources during shutdown.</p></div>
<div class="paragraph"><p>All of this means that if you want to launch a Lift application in a different way, you can. You&#8217;d need to wrap an appropriate container (Jetty or Tomcat for example), and provide a <span class="monospaced">main</span> method for Heroku to call. This is sometimes called "containerless deployment".</p></div>
<div class="paragraph"><p>If you are not a Heruoku Enterprise Java customer, and you&#8217;re uncomfortable with the unsupported nature of the <span class="monospaced">deploy:war</span> plugin, you now know what you need to do to run in a supported way: provide a <span class="monospaced">main</span> method that launches you application and listen for connections. The <em>See Also</em> section gives pointers for how to do this.</p></div>
<div class="sect4">
<h5 id="_database_access_in_heroku">Database Access in Heroku</h5>
<div class="paragraph"><p>Heroku make no restrictions on which databases you can connect to from your Lift application, but they try to make it easy to use their PostgreSQL service by attaching a free database to applications you create.</p></div>
<div class="paragraph"><p>You can find out if you have a database by running the <span class="monospaced">pg</span> command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ heroku pg --app glacial-waters-<span style="color: #993399">6292</span>
<span style="color: #990000">===</span> HEROKU_POSTGRESQL_BLACK_URL <span style="color: #990000">(</span>DATABASE_URL<span style="color: #990000">)</span>
Plan<span style="color: #990000">:</span>        Dev
Status<span style="color: #990000">:</span>      available
Connections<span style="color: #990000">:</span> <span style="color: #993399">0</span>
PG Version<span style="color: #990000">:</span>  <span style="color: #993399">9.1</span><span style="color: #990000">.</span><span style="color: #993399">6</span>
Created<span style="color: #990000">:</span>     <span style="color: #993399">2012</span>-<span style="color: #993399">12</span>-<span style="color: #993399">31</span> <span style="color: #993399">10</span><span style="color: #990000">:</span><span style="color: #993399">02</span> UTC
Data Size<span style="color: #990000">:</span>   <span style="color: #993399">5.9</span> MB
Tables<span style="color: #990000">:</span>      <span style="color: #993399">0</span>
Rows<span style="color: #990000">:</span>        <span style="color: #993399">0</span><span style="color: #990000">/</span><span style="color: #993399">10000</span> <span style="color: #990000">(</span>In compliance<span style="color: #990000">)</span>
Fork/Follow<span style="color: #990000">:</span> Unsupported</tt></pre></div></div>
<div class="paragraph"><p>The URL of the database is provided to your Lift application as the <span class="monospaced">DATABASE_URL</span> environment variable. It will have a value something like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>postgres://gghetjutddgr:RNC_lINakkk899HHYEFUppwG@ec2-54-243-230-119.compute-1.
 amazonaws.com:5432/d44nsahps11hda</pre>
</div></div>
<div class="paragraph"><p>This URL contains a user name, password, host and database name, but needs to be manipulated to be used by JDBC.  To do so, you might include the following in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt> Box <span style="color: #990000">!!</span> <span style="font-weight: bold"><span style="color: #000000">System.getenv</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"DATABASE_URL"</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">Full</span></span><span style="color: #990000">(</span>url<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #000000">initHerokuDb</span></span><span style="color: #990000">(</span>url<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-style: italic"><span style="color: #9A1900">// configure local database perhaps</span></span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">initHerokuDb</span></span><span style="color: #990000">(</span>dbInfo<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">Class.forName</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"org.postgresql.Driver"</span><span style="color: #990000">)</span>

  <span style="font-style: italic"><span style="color: #9A1900">// Extract credentials from Heroku database URL:</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> dbUri <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">URI</span></span><span style="color: #990000">(</span>dbInfo<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> <span style="font-weight: bold"><span style="color: #000000">Array</span></span><span style="color: #990000">(</span>user<span style="color: #990000">,</span> pass<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">dbUri.getUserInfo.split</span></span><span style="color: #990000">(</span><span style="color: #FF0000">":"</span><span style="color: #990000">)</span>

  <span style="font-style: italic"><span style="color: #9A1900">// Construct JDBC connection string from the URI:</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> connection <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">DriverManager.getConnection</span></span><span style="color: #990000">(</span>
    <span style="color: #FF0000">"jdbc:postgresql://"</span> <span style="color: #990000">+</span> dbUri<span style="color: #990000">.</span>getHost <span style="color: #990000">+</span> <span style="color: #FF0000">':'</span> <span style="color: #990000">+</span> dbUri<span style="color: #990000">.</span>getPort <span style="color: #990000">+</span>
      dbUri<span style="color: #990000">.</span>getPath<span style="color: #990000">,</span> user<span style="color: #990000">,</span> pass<span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #000000">SquerylRecord.initWithSquerylSession</span></span><span style="color: #990000">(</span>
    <span style="font-weight: bold"><span style="color: #000000">Session.create</span></span><span style="color: #990000">(</span>connection<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> PostgreSqlAdapter<span style="color: #990000">))</span>

  <span style="font-weight: bold"><span style="color: #000000">S.addAround</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> LoanWrapper <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">apply[T]</span></span><span style="color: #990000">(</span>f<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> T<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #0000FF">:</span></span> T <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> inTransaction <span style="color: #FF0000">{</span> f <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Here we are testing for the presence of the <span class="monospaced">DATABASE_URL</span> environment variable, which would indicate that we are in the Heroku environment. The example code then goes on to initialize Squeryl Record in Lift (described in <a href="#Squeryl">[Squeryl]</a>) using the Heroku database settings.</p></div>
<div class="paragraph"><p>For it to run <span class="monospaced">build.sbt</span> needs the appropriate dependencies for Record and PostgresSQL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">...</span>
<span style="color: #FF0000">"postgresql"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"postgresql"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"9.1-901.jdbc4"</span><span style="color: #990000">,</span>
<span style="color: #FF0000">"net.liftweb"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"lift-record"</span> <span style="color: #990000">%</span> liftVersion<span style="color: #990000">,</span>
<span style="color: #FF0000">"net.liftweb"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"lift-squeryl-record"</span> <span style="color: #990000">%</span> liftVersion<span style="color: #990000">,</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>With this in place, your Lift application can make use of the Heroku database. You can also access the database from the shell, e.g.,:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ pg<span style="color: #990000">:</span>psql --app glacial-waters-<span style="color: #993399">6292</span>
psql <span style="color: #990000">(</span><span style="color: #993399">9.1</span><span style="color: #990000">.</span><span style="color: #993399">4</span><span style="color: #990000">,</span> server <span style="color: #993399">9.1</span><span style="color: #990000">.</span><span style="color: #993399">6</span><span style="color: #990000">)</span>
SSL connection <span style="color: #990000">(</span>cipher<span style="color: #990000">:</span> DHE-RSA-AES<span style="color: #993399">256</span>-SHA<span style="color: #990000">,</span> bits<span style="color: #990000">:</span> <span style="color: #993399">256</span><span style="color: #990000">)</span>
Type <span style="color: #FF0000">"help"</span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="font-weight: bold"><span style="color: #0000FF">help</span></span><span style="color: #990000">.</span>

<span style="color: #009900">d44nsahps11hda</span><span style="color: #990000">=&gt;</span> <span style="color: #990000">\</span>d
No relations found<span style="color: #990000">.</span>
<span style="color: #009900">d44nsahps11hda</span><span style="color: #990000">=&gt;</span> <span style="color: #990000">\</span>q
$</tt></pre></div></div>
<div class="paragraph"><p>To access via a JDBC tool outside of the Heroku environment, you&#8217;ll need to include parameters to force SSL. For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>jdbc:postgresql://ec2-54-243-230-119.compute-1.amazonaws.com:5432/d44nsahps11hda?
  username=gghetjutddgr&amp;password=RNC_lINakkk899HHYEFUppwG&amp;ssl=true&amp;sslfactory=
  org.postgresql.ssl.NonValidatingFactory</pre>
</div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_75">See Also</h4>
<div class="paragraph"><p>Both the Scala and Java articles at Heroku are useful to learn more of the details described in this recipe: <a href="https://devcenter.heroku.com/categories/scala">https://devcenter.heroku.com/categories/scala</a> and <a href="https://devcenter.heroku.com/categories/java">https://devcenter.heroku.com/categories/java</a>.</p></div>
<div class="paragraph"><p><em>Dynos and the Dyno Manifold</em> are described at: <a href="https://devcenter.heroku.com/articles/dynos">https://devcenter.heroku.com/articles/dynos</a>.</p></div>
<div class="paragraph"><p>The JVM shutdown hooks are described in the JDK documentation: <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Runtime.html">http://docs.oracle.com/javase/7/docs/api/java/lang/Runtime.html</a>.</p></div>
<div class="paragraph"><p>Heroku&#8217;s guide to containerless deployment makes use of Maven to package your application, as is documented at <a href="https://devcenter.heroku.com/articles/java-webapp-runner">https://devcenter.heroku.com/articles/java-webapp-runner</a>.  There are also a template SBT project from Matthew Henderson that includes a <span class="monospaced">JettyLauncher</span> class: <a href="https://github.com/ghostm/lift_blank_heroku">https://github.com/ghostm/lift_blank_heroku</a>.</p></div>
<div class="paragraph"><p>The way Heroku deal with comet long-poling is described at <a href="https://devcenter.heroku.com/articles/request-timeout">https://devcenter.heroku.com/articles/request-timeout</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="DistributedComet">Distributing Comet Across Multiple Servers</h3>
<div class="sect3">
<h4 id="_problem_78">Problem</h4>
<div class="paragraph"><p>You use Lift&#8217;s Comet support, and want to run across multiple servers for increased redundancy or to handle increased load.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_77">Solution</h4>
<div class="paragraph"><p>Use the <em>publish/subscribe</em> (pubsub) model to connect each server to a <em>topic</em> and route comet message out to the topic where it can be broadcast to all servers that are part of your application.</p></div>
<div class="paragraph"><p>There are a variety of technologies you can use to accomplish this, such as databases, message systems, actor systems. For this recipe we will use the RabitMQ message service, but there are examples using CouchDB and Amazon&#8217;s Simple Notification Service in the <em>See Also</em> section.</p></div>
<div class="paragraph"><p>Regardless of the technology, the principle is that illustrated in <a href="#DistributedCometDiagram">[DistributedCometDiagram]</a>. A comet event originating on one Lift application, is sent to a service for redistribution. It is the responsibility of this service (labeled as "topic" in the figure) is to ensure all the participating Lift applications receive the event so it can be processed as normal by Lift.</p></div>
<div class="imageblock" id="DistributedCometDiagram">
<div class="content">
<img src="images/topic.png" alt="images/topic.png" width="640">
</div>
<div class="title">Figure 4. Comet events originating on one server are distributed via a topic.</div>
</div>
<div class="paragraph"><p>The first step is to download and install RabbitMQ from <a href="http://rabbitmq.com/">http://rabbitmq.com/</a>. Then start the server:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ ./sbin/rabbitmq-server -detatched</pre>
</div></div>
<div class="paragraph"><p>This command will produce various messages as it starts but will eventually say: "broker running".</p></div>
<div class="paragraph"><p>The Lift application we&#8217;ll use to demonstrate the pubsub pattern is the real-time chat application, described in <em>Simply Lift</em>.
The first modification is to include the Lift module to talk to RabbitMQ. This is a one-line addition to the <span class="monospaced">libraryDependencies</span> in <span class="monospaced">build.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"net.liftmodules"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"amqp"</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>liftVersion <span style="color: #990000">+</span> <span style="color: #FF0000">"-1.1"</span><span style="color: #990000">),</span></tt></pre></div></div>
<div class="paragraph"><p>AMQP stands for Advanced Message Queuing Protocol, a protocol that RabbitMQ talks. The AMQP module provides abstract actors to send and receive messages, and we will implement these actors as <span class="monospaced">RemoteSend</span> and <span class="monospaced">RemoteReceiver</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> code<span style="color: #990000">.</span>comet

<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftmodules<span style="color: #990000">.</span>amqp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>rabbitmq<span style="color: #990000">.</span>client<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Rabbit <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> factory <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ConnectionFactory</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ConnectionParameters<span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> host <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"127.0.0.1"</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> port <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #993399">5672</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> exchange <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"lift.chat"</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> routing <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">""</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> durable <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> noAck <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> RemoteSend <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">AMQPSender[String]</span></span><span style="color: #990000">(</span>factory<span style="color: #990000">,</span> host<span style="color: #990000">,</span> port<span style="color: #990000">,</span>
    exchange<span style="color: #990000">,</span> routing<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">configure</span></span><span style="color: #990000">(</span>channel<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Channel<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span>
      <span style="font-weight: bold"><span style="color: #000000">channel.exchangeDeclare</span></span><span style="color: #990000">(</span>exchange<span style="color: #990000">,</span> <span style="color: #FF0000">"fanout"</span><span style="color: #990000">,</span> durable<span style="color: #990000">)</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">object</span></span> RemoteReceiver <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> <span style="font-weight: bold"><span style="color: #000000">AMQPDispatcher[String]</span></span><span style="color: #990000">(</span>factory<span style="color: #990000">,</span> host<span style="color: #990000">,</span> port<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">configure</span></span><span style="color: #990000">(</span>channel<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Channel<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">channel.exchangeDeclare</span></span><span style="color: #990000">(</span>exchange<span style="color: #990000">,</span> <span style="color: #FF0000">"fanout"</span><span style="color: #990000">,</span> durable<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> queueName <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">channel.queueDeclare().getQueue</span></span><span style="color: #990000">()</span>
      <span style="font-weight: bold"><span style="color: #000000">channel.queueBind</span></span><span style="color: #990000">(</span>queueName<span style="color: #990000">,</span> exchange<span style="color: #990000">,</span> routing<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">channel.basicConsume</span></span><span style="color: #990000">(</span>queueName<span style="color: #990000">,</span> noAck<span style="color: #990000">,</span>
        <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">SerializedConsumer</span></span><span style="color: #990000">(</span>channel<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">))</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This code is establishing <span class="monospaced">RemoteSend</span> and <span class="monospaced">RemoteReceiver</span> actors that serialise <span class="monospaced">String</span> values via RabbitMQ.  This code is explored in the <em>Discussion</em> section below.</p></div>
<div class="paragraph"><p>To make use of this and route comet messages over RabbitMQ we need to make two changes.  In <span class="monospaced">Boot.scala</span> we need to start listening for messages from RabbitMQ:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>RemoteReceiver <span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">AMQPAddListener</span></span><span style="color: #990000">(</span>ChatServer<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This is attaching the <span class="monospaced">ChatServer</span> as a listener for AMQP messages from the <span class="monospaced">RemoteReciver</span>.</p></div>
<div class="paragraph"><p>The final change is to the <span class="monospaced">ChatServer</span> itself.  The regular behaviour of the <span class="monospaced">ChatServer</span> is to receive a <span class="monospaced">String</span> message from a client and update all the screens attached to the comet server:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> lowPriority <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> s <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> msgs <span style="font-weight: bold"><span style="color: #0000FF">:</span></span><span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> s<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #000000">updateListeners</span></span><span style="color: #990000">()</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The change to route messages over RabbitMQ is to redirect any <span class="monospaced">String</span> from clients to RabbitMQ, and handle any AMQP messages from RabbitMQ and update all clients:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> lowPriority <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">AMQPMessage</span></span><span style="color: #990000">(</span>s<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> msgs <span style="font-weight: bold"><span style="color: #0000FF">:</span></span><span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> s<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #000000">updateListeners</span></span><span style="color: #990000">()</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> s<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> RemoteSend <span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">AMQPMessage</span></span><span style="color: #990000">(</span>s<span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This change means all our comet chat messages go out to RabbitMQ where they are distributed to all the instances of our Lift application, and all the instances receive the messages back as <span class="monospaced">AMQPMessage</span> instances and update chat clients as normal.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_75">Discussion</h4>
<div class="paragraph"><p>To run more than one instance of your Lift application locally, you&#8217;ll want to start SBT as normal, and then in another terminal start again but on a different port number:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sbt
...
&gt; set port in container.Configuration := 9090
[info] Reapplying settings...
[info] Set current project to RabbitMQ Chat (in build file:rabbitmq_chat/)
&gt; container:start</pre>
</div></div>
<div class="paragraph"><p>You can then visit one application at <span class="monospaced">http://127.0.0.1:8080</span> and another at <span class="monospaced">http://127.0.0.1:9090</span>.</p></div>
<div class="paragraph"><p>In the example code, you can see that <span class="monospaced">AMQPSender[T]</span> and <span class="monospaced">AMQPDispatcher[T]</span> take care of most of the work for us, and we provide some configuration.  In the case of <span class="monospaced">RemoteSend</span> we&#8217;re configuring the <span class="monospaced">AMQPSender</span> to work with <span class="monospaced">String</span> messages and to work with an <em>exchange</em> called "lift.chat". In RabbitMQ the exchange is the entity we send messages to, and the exchange has the responsibility for passing on the message.  In this case the exchange is a <em>fanout</em> (a simple kind of topic) where each subscriber receives a copy of any messages sent to the exchange.  This is clearly what we want to get our chat messages sent to all connected Lift instances of the chat application.</p></div>
<div class="paragraph"><p>The <span class="monospaced">RemoteReceiver</span> is also configured to receive <span class="monospaced">String</span> messages, although the configuration is a little longer. Here, as well as indicating the exchange to be used, we declare a <em>temporary queue</em> for our Lift instance.  The queue is the place where RabbitMQ sends messages, and what we&#8217;re saying here is that each receiver has its own queue. The fanout exchange will ensure any message sent to the exchange is placed into every queue. The queue has a random name assigned by RabbitMQ and is destroyed we disconnect from it.</p></div>
<div class="paragraph"><p>The final part of the <span class="monospaced">RemoteReceiver</span> is to specify how we consume messages. The default behaviour of <span class="monospaced">RemoteSend</span> is to serialise objects, so we mirror that in the receiver by using the <span class="monospaced">SerializedConsumer</span> class provided by the AMQP module.</p></div>
<div class="paragraph"><p>To see the behaviour of RabbitMQ, it&#8217;s useful to install the management web console.  From the directory where you installed RabbitMQ:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ ./sbin/rabbitmq-plugins enable rabbitmq_management</pre>
</div></div>
<div class="paragraph"><p>Visit the administrative web interface at <span class="monospaced">http://127.0.0.1:15672/</span> and login.  The default username and password is "guest".</p></div>
<div class="paragraph"><p>Having to have RabbitMQ (or other type of pubsub solution) running during development may be inconvenient. In that case, you can simply not initialize the service in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>Props<span style="color: #990000">.</span>productionMode<span style="color: #990000">)</span>
  RemoteReceiver <span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">AMQPAddListener</span></span><span style="color: #990000">(</span>ChatServer<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>And in the chat server, only send to local clients:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">override</span></span> <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> lowPriority <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #000000">AMQPMessage</span></span><span style="color: #990000">(</span>s<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> msgs <span style="font-weight: bold"><span style="color: #0000FF">:</span></span><span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> s<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #000000">updateListeners</span></span><span style="color: #990000">()</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> s<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>Props<span style="color: #990000">.</span>productionMode<span style="color: #990000">)</span> RemoteSend <span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">AMQPMessage</span></span><span style="color: #990000">(</span>s<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span> msgs <span style="font-weight: bold"><span style="color: #0000FF">:</span></span><span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> s<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #000000">updateListeners</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that <span class="monospaced">Props.productionMode</span> is <span class="monospaced">true</span> for the run modes of <span class="monospaced">Production</span>, <span class="monospaced">Staging</span> and <span class="monospaced">Pilot</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_76">See Also</h4>
<div class="paragraph"><p>The Lift Chat example is described in <em>Simply Lift</em> at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a>. The source code used in this recipe can be found at: <a href="https://github.com/LiftCookbook/rabbitmq_chat">https://github.com/LiftCookbook/rabbitmq_chat</a>.</p></div>
<div class="paragraph"><p>The Lift AMQP module is: <a href="https://github.com/liftmodules/amqp">https://github.com/liftmodules/amqp</a>.</p></div>
<div class="paragraph"><p>If you want to learn more about RabbitMQ, take a look at the tutorials (<a href="http://www.rabbitmq.com/tutorials/tutorial-five-java.html">http://www.rabbitmq.com/tutorials/tutorial-five-java.html</a>) or Alvaro Videla and Jason J.W. Williams (2012), <em>RabbitMQ in Action: Distributed Messaging for Everyone</em>, Manning Publications.</p></div>
<div class="paragraph"><p>Diego Medina has implemented a distributed comet solution using CouchDB, and has described it in a blog post at <a href="https://fmpwizard.telegr.am/blog/distributed-comet-chat-lift">https://fmpwizard.telegr.am/blog/distributed-comet-chat-lift</a>.</p></div>
<div class="paragraph"><p>Amazon&#8217;s Simple Notification Service (SNS) is a fanout facility so can also be used to implement this pattern. You can find a Lift module for SNS at <a href="https://github.com/SpiralArm/liftmodules-aws-sns">https://github.com/SpiralArm/liftmodules-aws-sns</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_contributing_bug_reports_amp_getting_help">Contributing, Bug Reports &amp; Getting Help</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_you_8217_d_like_some_help">You&#8217;d Like Some Help</h3>
<div class="sect3">
<h4 id="_problem_79">Problem</h4>
<div class="paragraph"><p>You&#8217;re stuck on something in Lift and you&#8217;d like some help.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_78">Solution</h4>
<div class="paragraph"><p>Ask a question on the Lift mailing list at <a href="https://groups.google.com/group/liftweb">https://groups.google.com/group/liftweb</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_76">Discussion</h4>
<div class="paragraph"><p>You will find some information about Lift on StackOverflow, Quora and elsewhere, but the mailing list is <em>the</em> place to go to get help and support. You can search the archive to see if your question has already been addressed, but questions are very welcome as it helps the Lift community understand what users need and what might be causing problems or need explanation. Much of what you&#8217;re reading here originates from questions that have been asked on the mailing list.</p></div>
<div class="paragraph"><p>New members to the mailing list are moderated to help reduce spam. This means the first time you post your message may take a few hours to show up.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_77">See Also</h4>
<div class="paragraph"><p>The Lift community is one of the things that makes Lift what it is. Please take a look at <a href="http://liftweb.net/community">http://liftweb.net/community</a> before posting: you&#8217;ll get the best response with a polite question.</p></div>
<div class="paragraph"><p>If you need paid consulting, development or SLA-backed support, there&#8217;s a list of organizations on the Wiki at <a href="https://www.assembla.com/spaces/liftweb/wiki/Commercial_Support">https://www.assembla.com/spaces/liftweb/wiki/Commercial_Support</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_report_bugs">How to Report Bugs</h3>
<div class="sect3">
<h4 id="_problem_80">Problem</h4>
<div class="paragraph"><p>You&#8217;ve found a bug and want to report it.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_79">Solution</h4>
<div class="paragraph"><p>Discuss your findings on the Lift mailing list, saying what you&#8217;re
seeing, and what you&#8217;d expect to see.</p></div>
<div class="paragraph"><p>By all means look at the existing tickets to see if your issue is there or recently fixed, but please do not
raise a ticket unless asked to do so by a Lift committer on the mailing list.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_77">Discussion</h4>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>If Lift is not behaving as you expect, please ask questions about what
you&#8217;re seeing. The ideal form of these questions is "When I do X, my
Lift app does Y, but I expect it to do Z, why?" This provides a set of
language to discuss your application and the way that Lift responds to
requests. Perhaps there&#8217;s a way of improving Lift. Perhaps there&#8217;s a
concept that&#8217;s different in Lift than you might be used to. Perhaps
there&#8217;s a documentation issue that can help bridge the gap between what
Lift is doing and what you expect it to do. Most importantly, just
because Lift is behaving differently than you expect it to, it&#8217;s not
necessarily a bug in Lift.</p></div>
</div>
<div class="attribution">
<em>http://lift.la/expected-behavior-in-the-lift-community</em><br>
&#8212; David Pollack
</div></div>
<div class="paragraph"><p>A great way to get help with the issue you have, or getting a bug fixed, is to produce a small example to illustrate the problem and posting it on GitHub. The key is to provide instructions so someone can run the example and see exactly what you see without having to jump though hoops.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_78">See Also</h4>
<div class="paragraph"><p>You&#8217;ll find a list of tickets at <a href="http://ticket.liftweb.net/">http://ticket.liftweb.net/</a>.</p></div>
<div class="paragraph"><p>If you&#8217;re asked to, or want to, post example code there&#8217;s a guide at <a href="http://www.assembla.com/wiki/show/liftweb/Posting_example_code">http://www.assembla.com/wiki/show/liftweb/Posting_example_code</a>.</p></div>
<div class="paragraph"><p>If you&#8217;ve found a bug, and you&#8217;re asked to create a ticket, the main thing to do is to include a link to the mailing list discussion of the issue, as described at <a href="http://www.assembla.com/wiki/show/liftweb/Creating_tickets">http://www.assembla.com/wiki/show/liftweb/Creating_tickets</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="LiftCodeContributions">Contributing Small Code Changes and ScalaDoc</h3>
<div class="sect3">
<h4 id="_problem_81">Problem</h4>
<div class="paragraph"><p>You have a small change or ScalaDoc improvement you&#8217;d like incorporated into Lift.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_80">Solution</h4>
<div class="paragraph"><p>You can issue pull requests against the Lift source providing your change meets one of the following requirements:</p></div>
<div class="ulist"><ul>
<li>
<p>
It&#8217;s change to a comment.
</p>
</li>
<li>
<p>
It&#8217;s example code.
</p>
</li>
<li>
<p>
It&#8217;s a <em>small</em> change, enhancements, or bug fix to Lift.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Your pull request must include an edit to add your signature to the bottom of the <span class="monospaced">contributors.md</span> file.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_78">Discussion</h4>
<div class="paragraph"><p>Historically Lift had a strict contributor policy of simply not accepting any code contributions except from committers who had signed an agreement to assign copyright to the Lift project.  This allowed corporations wanting to adopt Lift to do so without litigation concerns.</p></div>
<div class="paragraph"><p>The safety is still there, now via the requirement for a signature on the contributors file, which reads:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>By submitting this pull request which includes my name and email address (the email address may be in a non-robot readable format), I agree that the entirety of the contribution is my own original work, that there are no prior claims on this work including, but not limited to, any agreements I may have with my employer or other contracts, and that I license this work under an Apache 2.0 license.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>What&#8217;s a small change? That&#8217;s a good question, and if you&#8217;re unsure, talk about your proposed change on the mailing list.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_79">See Also</h4>
<div class="paragraph"><p>This contribution policy was introduced in November 2012, and can be read about at <a href="http://www.lift.la/blog/new_contribution_policy">http://www.lift.la/blog/new_contribution_policy</a>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">contributors.md</span> file is found at: <a href="https://github.com/lift/framework/blob/master/contributors.md">https://github.com/lift/framework/blob/master/contributors.md</a>.</p></div>
<div class="paragraph"><p>The Lift source is on GitHub at <a href="https://github.com/lift/">https://github.com/lift/</a>.  The <em>framework</em> project is probably the one you want, although you&#8217;ll also find Git repositories for examples and Lift web sites there.</p></div>
<div class="paragraph"><p>GitHub provide an introduction to pull requests at <a href="https://help.github.com/articles/using-pull-requests">https://help.github.com/articles/using-pull-requests</a>.</p></div>
<div class="paragraph"><p><a href="#modules">[modules]</a> describes how to share code of any size via Lift modules.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="wiki">Contributing Documentation</h3>
<div class="sect3">
<h4 id="_problem_82">Problem</h4>
<div class="paragraph"><p>You&#8217;d like to contribute documentation to Lift.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_81">Solution</h4>
<div class="paragraph"><p>Update or add to the Lift wiki at <a href="https://www.assembla.com/wiki/show/liftweb">https://www.assembla.com/wiki/show/liftweb</a>.</p></div>
<div class="paragraph"><p>You&#8217;ll need to sign in, or create a free account, with Assembla, the company that hosts the wiki. You then need to become a <em>watcher</em> of the Lift wiki, which is offered as a link on the top right of the Lift wiki page.  As a watcher you can edit pages and create new pages.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_79">Discussion</h4>
<div class="paragraph"><p>If you&#8217;re unsure about a change you&#8217;d like to make, just ask for feedback on the Lift mailing list.</p></div>
<div class="paragraph"><p>One limitation of the watcher role on Assembla is that you cannot move pages. If you create a new page in the wrong section, or want to reorganise pages, you&#8217;ll need to ask on the Lift mailing list for someone with permissions to do that for you.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_80">See Also</h4>
<div class="paragraph"><p>The markup format for the Wiki pages is Textile. A reference guide can be found at: <a href="http://redcloth.org/hobix.com/textile/">http://redcloth.org/hobix.com/textile/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_add_a_new_recipe_to_this_cookbook">How to Add a New Recipe to this Cookbook</h3>
<div class="sect3">
<h4 id="_problem_83">Problem</h4>
<div class="paragraph"><p>You&#8217;d like to add a section or chapter to this cookbook.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_82">Solution</h4>
<div class="paragraph"><p>If you&#8217;re comfortable using Git, you can fork the repository and send a
pull request.</p></div>
<div class="paragraph"><p>Alternatively, download a template file, write your recipe, and email
to the Lift mailing list at <a href="https://groups.google.com/group/liftweb">https://groups.google.com/group/liftweb</a>.</p></div>
<div class="paragraph"><p>You can find the template file at: <a href="https://raw.github.com/d6y/lift-cookbook/master/template.asciidoc">https://raw.github.com/d6y/lift-cookbook/master/template.asciidoc</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_80">Discussion</h4>
<div class="paragraph"><p>Anything you&#8217;ve puzzled over, or things which have surprised you, impressed you or are non-obvious are great topics for recipes. Improvements, discussions and clarifications of existing recipes are welcome too.</p></div>
<div class="paragraph"><p>The cookbook is structured using a markup language called Asciidoc. If you&#8217;re familiar with Markdown or Textile, you&#8217;ll find similarities. For the cookbook you only need to know about section headings, source code formatting and links.  Examples of all of these are in the <span class="monospaced">template.asciidoc</span> file.</p></div>
<div class="paragraph"><p>To find out where to make a change you need to know that each chapter is a separate file, and each recipe is a section in that file.</p></div>
<div class="sect4">
<h5 id="_licensing">Licensing</h5>
<div class="paragraph"><p>We ask contributors the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
You agree to license your work (including the words you write, the code you use and any images) to us under the Creative Commons Attribution, Non Commercial, No Derivatives license.
</p>
</li>
<li>
<p>
You assert that the work is your own, or you have the necessary permission for the work.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To keep things simple, all author royalties from this book are given to charity.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_81">See Also</h4>
<div class="paragraph"><p>The source to this book is at: <a href="https://github.com/d6y/lift-cookbook/">https://github.com/d6y/lift-cookbook/</a>.</p></div>
<div class="paragraph"><p>The AsciiDoc cheetsheet at <a href="http://powerman.name/doc/asciidoc">http://powerman.name/doc/asciidoc</a> is a quick way to get into AsciiDoc, but if you need more, the AsciiDoc home page has the details: <a href="http://www.methods.co.nz/asciidoc/">http://www.methods.co.nz/asciidoc/</a>.</p></div>
<div class="paragraph"><p>GitHub provide an introduction to pull requests at <a href="https://help.github.com/articles/using-pull-requests">https://help.github.com/articles/using-pull-requests</a>.</p></div>
<div class="paragraph"><p><a href="#wiki">[wiki]</a> describes other ways to contribution documentation to Lift.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="modules">Sharing Code in Modules</h3>
<div class="sect3">
<h4 id="_problem_84">Problem</h4>
<div class="paragraph"><p>You have code you&#8217;d like to share between Lift projects.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_83">Solution</h4>
<div class="paragraph"><p>Create a Lift module, and then reference the module from your Lift projects.</p></div>
<div class="paragraph"><p>As an example, let&#8217;s create a module to embed the Snowstorm snow fall effect on every page in your Lift web application (please don&#8217;t do this).</p></div>
<div class="paragraph"><p>There&#8217;s nothing special about modules: they are code, packaged and used like any other dependency. What makes them possible is the exposure of extension points via <span class="monospaced">LiftRules</span>. The main convention is to have an <span class="monospaced">init</span> method that Lift applications can use to initialize your module.</p></div>
<div class="paragraph"><p>For our snow storm we&#8217;re going to package some JavaScript and inject the script onto every page.</p></div>
<div class="paragraph"><p>Starting with the <span class="monospaced">lift_blank</span> template downloaded from liftweb.net, we can remove all the source and HTML files as this won&#8217;t be a runnable Lift application in itself. However, it will leave us with the regular Lift structure and build configuration.</p></div>
<div class="paragraph"><p>Our module will need the Snowstorm JavaScript file from <a href="https://github.com/scottschiller/snowstorm/">https://github.com/scottschiller/snowstorm/</a> copied as <span class="monospaced">resources/toserve/snowstorm.js</span>.  This will place the JavaScript file on the classpath of our Lift application.</p></div>
<div class="paragraph"><p>The final piece of the module is to ensure the JavaScript is included on every page:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> net<span style="color: #990000">.</span>liftmodules<span style="color: #990000">.</span>snowstorm

<span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftweb<span style="color: #990000">.</span>http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> Snowstorm <span style="color: #FF0000">{</span>

 <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Unit <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>

  ResourceServer<span style="color: #990000">.</span>allow <span style="color: #FF0000">{</span>
     <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"snowstorm.js"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">addSnow</span></span><span style="color: #990000">(</span>s<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> LiftSession<span style="color: #990000">,</span> r<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> Req<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">S.putInHead</span></span><span style="color: #990000">(</span>
    <span style="color: #990000">&lt;</span>script <span style="font-weight: bold"><span style="color: #0000FF">type=</span></span><span style="color: #FF0000">"text/javascript"</span> src<span style="font-weight: bold"><span style="color: #0000FF">=</span></span><span style="color: #FF0000">"/classpath/snowstorm.js"</span><span style="color: #990000">&gt;&lt;/</span>script<span style="color: #990000">&gt;</span> <span style="color: #990000">)</span>

  LiftSession<span style="color: #990000">.</span>onBeginServicing <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> addSnow <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span>  LiftSession<span style="color: #990000">.</span>onBeginServicing

 <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Here we are plugging into Lift&#8217;s processing pipeline and adding the required
JavaScript to the head of every page.</p></div>
<div class="paragraph"><p>We modify <span class="monospaced">build.sbt</span> to give the module a name, organisation and version number.  We also can remove many of the dependencies and the web plugin as we only depend on the web API elements of Lift:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>name <span style="font-weight: bold"><span style="color: #0000FF">:=</span></span> <span style="color: #FF0000">"snowstorm"</span>

version <span style="font-weight: bold"><span style="color: #0000FF">:=</span></span> <span style="color: #FF0000">"1.0.0"</span>

organization <span style="font-weight: bold"><span style="color: #0000FF">:=</span></span> <span style="color: #FF0000">"net.liftmodules"</span>

scalaVersion <span style="font-weight: bold"><span style="color: #0000FF">:=</span></span> <span style="color: #FF0000">"2.9.1"</span>

resolvers <span style="color: #990000">++</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Seq</span></span><span style="color: #990000">(</span>
   <span style="color: #FF0000">"snapshots"</span> at <span style="color: #FF0000">"http://oss.sonatype.org/content/repositories/snapshots"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"releases"</span> at <span style="color: #FF0000">"http://oss.sonatype.org/content/repositories/releases"</span>
<span style="color: #990000">)</span>

scalacOptions <span style="color: #990000">++</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Seq</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"-deprecation"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"-unchecked"</span><span style="color: #990000">)</span>

libraryDependencies <span style="color: #990000">++</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> liftVersion <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"2.5-M3"</span>
  <span style="font-weight: bold"><span style="color: #000000">Seq</span></span><span style="color: #990000">(</span>
    <span style="color: #FF0000">"net.liftweb"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"lift-webkit"</span>  <span style="color: #990000">%</span> liftVersion  <span style="color: #990000">%</span> <span style="color: #FF0000">"compile"</span>
  <span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We can publish this plugin to the repository on disk by starting SBT and typing:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>publish-local</pre>
</div></div>
<div class="paragraph"><p>With our module built and published, we can now include it in our Lift applications. To do that, modify the Lift application&#8217;s <span class="monospaced">build.sbt</span> to reference this new "snowstorm" dependency:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>libraryDependencies <span style="color: #990000">++</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> liftVersion <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="color: #FF0000">"2.5-M3"</span>
  <span style="font-weight: bold"><span style="color: #000000">Seq</span></span><span style="color: #990000">(</span>
  <span style="color: #990000">...</span>
  <span style="color: #FF0000">"net.liftmodules"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"snowstorm"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"1.0.0"</span><span style="color: #990000">,</span>
  <span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>In our Lift application&#8217;s <span class="monospaced">Boot.scala</span> we finally initialise the plugin:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> net<span style="color: #990000">.</span>liftmodules<span style="color: #990000">.</span>snowstorm<span style="color: #990000">.</span>Snowstorm
<span style="font-weight: bold"><span style="color: #000000">Snowstorm.init</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>When we run our Lift application, white snow will be falling on every page, supplied by the module.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_81">Discussion</h4>
<div class="paragraph"><p>The module is self contained: there&#8217;s no need for users to copy JavaScript files around or modify their templates.  To achieve that we&#8217;ve made use of <span class="monospaced">ResourceServer</span>.  When we reference the JavaScript file via <span class="monospaced">/classpath/snowstorm.js</span>, Lift will attempt to locate <span class="monospaced">snowstorm.js</span> from the classpath.  This is what we want for our Lift application because <span class="monospaced">snowstorm.js</span> will be inside the module JAR file.</p></div>
<div class="paragraph"><p>However, we do not want to expose all files on the classpath to anyone visiting our application. To avoid that, Lift looks for resources inside a <span class="monospaced">toserve</span> folder, which for our purposes means files and folders inside <span class="monospaced">src/main/resources/toserve</span>.  You can think of <span class="monospaced">/classpath</span> meaning <span class="monospaced">toserve</span> (although, you can change those values via <span class="monospaced">LiftRules.resourceServerPath</span> and <span class="monospaced">ResourceServer.baseResourceLocation</span>).</p></div>
<div class="paragraph"><p>As a further precaution you need to explicitly allow access to these resources.  That&#8217;s done with:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ResourceServer<span style="color: #990000">.</span>allow <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"snowstorm.js"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span> <span style="color: #009900">Nil</span> <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We&#8217;re just always returning <span class="monospaced">true</span> for anyone who asks for this resource, but we could dynamically control access here if we wanted.</p></div>
<div class="paragraph"><p><span class="monospaced">S.putInHead</span> adds the JavaScript to the head of a page, and is triggered on every page by <span class="monospaced">LiftSession.onBeginServicing</span> (also discussed in <a href="#OnSession">[OnSession]</a>). We could make use of <span class="monospaced">Req</span> here to restrict the snow storm to particular pages, but we&#8217;re adding it to every page.</p></div>
<div class="paragraph"><p>Hopefully you can see that anything you can do in a Lift application you can probably turn into a Lift module.  A typical approach might be to have functionality in a Lift application, and then factor out settings in <span class="monospaced">Boot</span> into a module <span class="monospaced">init</span> method.  For example, if you wanted to provide REST services as a module, that would be possible and is an approach taken by the Lift Paypal module.</p></div>
<div class="sect4">
<h5 id="_making_your_module_available">Making your Module Available</h5>
<div class="paragraph"><p>If you do want your module to be used by a wider audience, you need to publish it to a public repository, such as Sonatype or CloudBees. You&#8217;ll also want to keep your module up-to-date with Lift releases. There are a few conventions around this.</p></div>
<div class="paragraph"><p>One convention is to include the Lift version as part of the module version number.  For example, version 1.0.0 of your module for Lift 2.5 would be "2.5-1.0.0".  This is verbose but makes it clear which version of your module is compatible with which versions of Lift.  It also means you need to keep your module up-to-date with Lift releases.</p></div>
<div class="paragraph"><p>One way to ease that is to make a modification to your module build to allow the Lift version number to change. This makes it possible to automate the build when new versions of Lift are released. To do that, create <span class="monospaced">project/LiftModule.scala</span> in your module:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> sbt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> sbt<span style="color: #990000">.</span>Keys<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> LiftModuleBuild <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Build <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> liftVersion <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">SettingKey[String]</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"liftVersion"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"Version number of the Lift Web Framework"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> project <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Project</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"LiftModule"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">file</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"."</span><span style="color: #990000">))</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This defines a setting to control the Lift version number.  You use it in your module <span class="monospaced">build.sbt</span> like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>name <span style="font-weight: bold"><span style="color: #0000FF">:=</span></span> <span style="color: #FF0000">"snowstorm"</span>

liftVersion <span style="color: #990000">&lt;&lt;</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> liftVersion <span style="color: #990000">??</span> <span style="color: #FF0000">"2.5-SNAPSHOT"</span>

version <span style="color: #990000">&lt;&lt;</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> liftVersion apply <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #0000FF">_</span></span> <span style="color: #990000">+</span> <span style="color: #FF0000">"-1.0.0-SNAPSHOT"</span> <span style="color: #FF0000">}</span>

<span style="color: #990000">...</span>

libraryDependencies <span style="color: #990000">&lt;++</span><span style="font-weight: bold"><span style="color: #0000FF">=</span></span> liftVersion <span style="color: #FF0000">{</span> v <span style="font-weight: bold"><span style="color: #0000FF">=&gt;</span></span>
  <span style="color: #FF0000">"net.liftweb"</span> <span style="color: #990000">%%</span> <span style="color: #FF0000">"lift-webkit"</span> <span style="color: #990000">%</span> v <span style="color: #990000">%</span> <span style="color: #FF0000">"compile-&gt;default"</span> <span style="font-weight: bold"><span style="color: #0000FF">::</span></span>
  <span style="color: #009900">Nil</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>What this gives you is a way for the version of your module to depend on the <span class="monospaced">liftVersion</span> value.  This in turn can be set via a script.  This is what we do to publish a range of Lift Modules after each Lift release, as described at <a href="https://www.assembla.com/spaces/liftweb/wiki/Releasing_the_modules">https://www.assembla.com/spaces/liftweb/wiki/Releasing_the_modules</a>.</p></div>
<div class="paragraph"><p>Don&#8217;t forget to announce your module on the Lift mailing list.</p></div>
</div>
<div class="sect4">
<h5 id="_debugging_your_module">Debugging Your Module</h5>
<div class="paragraph"><p>When working on a module and testing it in a Lift application, it would be a chore to have to publish your module each time you changed it. Fortunately, SBT allows your Lift application to depend on the source of a module.  To use this, change your Lift project to remove the dependency on the published module and instead add a local dependency by creating <span class="monospaced">project/LocalModuleDev.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> sbt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">_</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">object</span></span> LocalModuleDev <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Build <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">lazy</span></span> <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> root <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Project</span></span><span style="color: #990000">(</span><span style="color: #FF0000">""</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">file</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"."</span><span style="color: #990000">))</span> <span style="font-weight: bold"><span style="color: #000000">dependsOn</span></span><span style="color: #990000">(</span>snow<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">lazy</span></span> <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> snow <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">ProjectRef(uri</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"../snowstorm"</span><span style="color: #990000">),</span> <span style="color: #FF0000">"LiftModule"</span><span style="color: #990000">)</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We are assuming that the snowstorm source can be found at <span class="monospaced">../snowstorm</span> relative to the Lift application we are using. With this in place, when you build your Lift project, SBT will automatically compile and depend on changes in the local <span class="monospaced">snowstorm</span> module.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_82">See Also</h4>
<div class="paragraph"><p>Originally Lift included a set of modules, but these have been separated out to individual projects at <a href="https://github.com/liftmodules/">https://github.com/liftmodules/</a>.  The Lift contributor policy outlined in <a href="#LiftCodeContributions">[LiftCodeContributions]</a> doesn&#8217;t apply to Lift modules: you&#8217;re free to contribute to these modules as you would any other open source project.</p></div>
<div class="paragraph"><p>The Lift wiki pages for modules can be reached via <a href="http://liftmodules.net">http://liftmodules.net</a>.</p></div>
<div class="paragraph"><p>The Snowstorm project ("setting CPUs on fire worldwide every winter since 2003") is at: <a href="https://github.com/scottschiller/snowstorm/">https://github.com/scottschiller/snowstorm/</a> and the module developed for this recipe is at <a href="https://github.com/LiftCookbook/snowstorm-example-module">https://github.com/LiftCookbook/snowstorm-example-module</a>.</p></div>
<div class="paragraph"><p>To publish to Sonatype, take a look at their guide: <a href="https://docs.sonatype.org/display/Repository/Sonatype+OSS+Maven+Repository+Usage+Guide">https://docs.sonatype.org/display/Repository/Sonatype+OSS+Maven+Repository+Usage+Guide</a>. CloudBees offer an open source repository, which you can learn about via <a href="http://www.cloudbees.com/foss/foss-dev.cb">http://www.cloudbees.com/foss/foss-dev.cb</a>.</p></div>
<div class="paragraph"><p>There are other ways to structure common code between Lift applications. For an example that uses SBT modules and Git, see the mailing list discussion on "Modularize Lift Applications" at <a href="https://groups.google.com/d/msg/liftweb/7GA5t0lefzI/c1wf6W1keDcJ">https://groups.google.com/d/msg/liftweb/7GA5t0lefzI/c1wf6W1keDcJ</a>.</p></div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated 2013-01-15 14:20:52 GMT
</div>
</div>
</body>
</html>
