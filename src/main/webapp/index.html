<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.8">
<title></title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


/*
 * Theme specific overrides of the preceding (asciidoc.css) CSS.
 *
 */
body {
  font-family: Garamond, Georgia, serif;
  font-size: 17px;
  color: #3E4349;
  line-height: 1.3em;
}
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Garmond, Georgia, serif;
  font-weight: normal;
  border-bottom-width: 0;
  color: #3E4349;
}
div.title, caption.title { color: #596673; font-weight: bold; }
h1 { font-size: 240%; }
h2 { font-size: 180%; }
h3 { font-size: 150%; }
h4 { font-size: 130%; }
h5 { font-size: 115%; }
h6 { font-size: 100%; }
#header h1 { margin-top: 0; }
#toc {
  color: #444444;
  line-height: 1.5;
  padding-top: 1.5em;
}
#toctitle {
  font-size: 20px;
}
#toc a {
    border-bottom: 1px dotted #999999;
    color: #444444 !important;
    text-decoration: none !important;
}
#toc a:hover {
    border-bottom: 1px solid #6D4100;
    color: #6D4100 !important;
    text-decoration: none !important;
}
div.toclevel1 { margin-top: 0.2em; font-size: 16px; }
div.toclevel2 { margin-top: 0.15em; font-size: 14px; }
em, dt, td.hdlist1 { color: black; }
strong { color: #3E4349; }
a { color: #004B6B; text-decoration: none; border-bottom: 1px dotted #004B6B; }
a:visited { color: #615FA0; border-bottom: 1px dotted #615FA0; }
a:hover { color: #6D4100; border-bottom: 1px solid #6D4100; }
div.tableblock > table, table.tableblock { border: 3px solid #E8E8E8; }
th.tableblock, td.tableblock { border: 1px solid #E8E8E8; }
ul > li > * { color: #3E4349; }
pre, tt, .monospaced { font-family: Consolas,Menlo,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; }
tt, .monospaced { font-size: 0.9em; color: black;
}
div.exampleblock > div.content, div.sidebarblock > div.content, div.listingblock > div.content { border-width: 0 0 0 3px; border-color: #E8E8E8; }
div.verseblock { border-left-width: 0; margin-left: 3em; }
div.quoteblock { border-left-width: 3px; margin-left: 0; margin-right: 0;}
div.admonitionblock td.content { border-left: 3px solid #E8E8E8; }
/*
  pygmentize filter
*/
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f4f4f4; }
.highlight .c { color: #008800; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #AA22FF; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #008800; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #008800 } /* Comment.Preproc */
.highlight .c1 { color: #008800; font-style: italic } /* Comment.Single */
.highlight .cs { color: #008800; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #AA22FF; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #AA22FF; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #AA22FF; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #AA22FF } /* Keyword.Pseudo */
.highlight .kr { color: #AA22FF; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #00BB00; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BB4444 } /* Literal.String */
.highlight .na { color: #BB4444 } /* Name.Attribute */
.highlight .nb { color: #AA22FF } /* Name.Builtin */
.highlight .nc { color: #0000FF } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #00A000 } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #B8860B } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BB4444 } /* Literal.String.Backtick */
.highlight .sc { color: #BB4444 } /* Literal.String.Char */
.highlight .sd { color: #BB4444; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BB4444 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BB4444 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BB4444 } /* Literal.String.Single */
.highlight .ss { color: #B8860B } /* Literal.String.Symbol */
.highlight .bp { color: #AA22FF } /* Name.Builtin.Pseudo */
.highlight .vc { color: #B8860B } /* Name.Variable.Class */
.highlight .vg { color: #B8860B } /* Name.Variable.Global */
.highlight .vi { color: #B8860B } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */



@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_about_this_text">About this text</h3>
<div class="paragraph"><p>A collection of solutions to questions you might have while developing
web applications with the <a href="http://www.liftweb.net">Lift web framework</a>.</p></div>
<div class="paragraph"><p>The aim is to give a single, short answer to a specific question. Where
there are different ways to achieve the same result, this cookbook just
shows one way, but may point you at alternatives in a discussion on the
solution.</p></div>
</div>
<div class="sect2">
<h3 id="_learning_about_lift">Learning about Lift</h3>
<div class="paragraph"><p>If you are looking to learn Lift, take a look at:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Simply Lift</em>, online at <a href="http://simply.liftweb.net">http://simply.liftweb.net</a>.
</p>
</li>
<li>
<p>
<a href="http://www.packtpub.com/lift-web-applications/book">Lift Web Applications How-to</a>, PACKT Publishing, 2013.
</p>
</li>
<li>
<p>
<a href="http://www.manning.com/perrett/">Lift in Action</a>, Manning Publications, 2011.
</p>
</li>
<li>
<p>
<em>Seven Things</em> that distinguish Lift from other web frameworks: <a href="http://seventhings.liftweb.net">http://seventhings.liftweb.net/</a>.
</p>
</li>
<li>
<p>
<em>Exploring Lift</em> online at <a href="http://exploring.liftweb.net">http://exploring.liftweb.net</a> &#8201;&#8212;&#8201;also known as <a href="http://www.apress.com/9781430224211">The
Definitive Guide to Lift</a>, Apress Media, 2009.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_copyright">Copyright</h3>
<div class="paragraph"><p>This document is licensed Creative Commons Attribution, Non Commercial,
No Derivatives.</p></div>
</div>
<div class="sect2">
<h3 id="_contributors">Contributors</h3>
<div class="ulist"><ul>
<li>
<p>
Richard Dallaway
</p>
</li>
<li>
<p>
Jono Ferguson
</p>
</li>
<li>
<p>
<strong>Franz Bettag</strong>  Franz is an enthusiastic Scala Hacker for several years now. He joined the Lift team in January 2012 and actively tweets and blogs about his newest Scala adventures. Find him at <a href="https://twitter.com/fbettag">https://twitter.com/fbettag</a>
</p>
</li>
<li>
<p>
Marek Żebrowski
</p>
</li>
<li>
<p>
<strong>Peter Robinett</strong>  Peter is a web and mobile developer and a Lift committer. He can be found on the web at <a href="http://www.bubblefoundry.com">http://www.bubblefoundry.com</a> and on Twitter at <a href="http://twitter.com/pr1001">http://twitter.com/pr1001</a>.
</p>
</li>
<li>
<p>
<strong>Kevin Lau</strong> is a founder of few web apps with a focus in AWS cloud, iOS and Lift.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_source">Source</h3>
<div class="paragraph"><p>The source is at
<a href="https://github.com/d6y/lift-cookbook">https://github.com/d6y/lift-cookbook</a></p></div>
</div>
<div class="sect2">
<h3 id="_updates">Updates</h3>
<div class="paragraph"><p>Follow <a href="https://twitter.com/#!/liftcookbook">@LiftCookbook</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_software_versions">Software versions</h3>
<div class="paragraph"><p>Except where otherwise indicated, the examples use Lift 2.5 with SBT
0.12 and Scala 2.9</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="InstallAndRunning">Install and Running</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter covers questions regarding starting development with Lift: running a first Lift application and setting up a coding environment. You&#8217;ll find answers regarding production deployment in <a href="#deployment">[deployment]</a>.</p></div>
<div class="sect2">
<h3 id="DownloadAndRun">Downloading and Running Lift</h3>
<div class="sect3">
<h4 id="_problem">Problem</h4>
<div class="paragraph"><p>You want to install and run Lift on your computer.</p></div>
</div>
<div class="sect3">
<h4 id="_solution">Solution</h4>
<div class="paragraph"><p>The only prerequisite for installing and running Lift is to have Java
1.5 or later installed. Instructions for installing Java can be found at
<a href="http://java.com/">http://java.com/</a>.</p></div>
<div class="paragraph"><p>You can find out if you have Java from the shell or command prompt by asking for the version you have installed:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ java -version
java version "1.7.0_13"
Java(TM) SE Runtime Environment (build 1.7.0_13-b20)
Java HotSpot(TM) 64-Bit Server VM (build 23.7-b01, mixed mode)</pre>
</div></div>
<div class="paragraph"><p>Once you have Java, the following instructions will download, build and
start a basic Lift application.</p></div>
<div class="sect4">
<h5 id="_for_mac_and_linux">For Mac and Linux</h5>
<div class="ulist"><ul>
<li>
<p>
Visit <a href="http://liftweb.net/download">http://liftweb.net/download</a> and download the Lift 2.5-RC2 ZIP file.
</p>
</li>
<li>
<p>
Unzip the file.
</p>
</li>
<li>
<p>
Start <em>Terminal</em> or your favourite shell tool.
</p>
</li>
<li>
<p>
Navigate into the unzipped folder and into the <span class="monospaced">scala_29</span> sub-folder and then into the <span class="monospaced">lift_basic</span> folder.
</p>
</li>
<li>
<p>
Run:<span class="monospaced">./sbt</span>.
</p>
</li>
<li>
<p>
Required libraries will be downloaded automatically.
</p>
</li>
<li>
<p>
At the SBT prompt (&gt;) type: <span class="monospaced">container:start</span>.
</p>
</li>
<li>
<p>
Open your browser and go to <span class="monospaced">http://127.0.0.1:8080/</span>.
</p>
</li>
<li>
<p>
When you&#8217;re done, type <span class="monospaced">exit</span> at the SBT prompt to stop your application from running.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_for_windows">For Windows</h5>
<div class="ulist"><ul>
<li>
<p>
Visit <a href="http://liftweb.net/download">http://liftweb.net/download</a> locate the link to the ZIP version of Lift 2.5-RC2 and save this to disk.
</p>
</li>
<li>
<p>
Extract the contents of the ZIP file.
</p>
</li>
<li>
<p>
Navigate in <em>Explorer</em> to the extracted folder, and inside navigate into <span class="monospaced">scala_29</span> and then <span class="monospaced">lift_basic</span>.
</p>
</li>
<li>
<p>
Double click <span class="monospaced">sbt.bat</span> to run the build tool and a terminal window should open.
</p>
</li>
<li>
<p>
Required libraries will be downloaded automatically.
</p>
</li>
<li>
<p>
At the SBT prompt (&gt;) type: <span class="monospaced">container:start</span>.
</p>
</li>
<li>
<p>
You may find Windows Firewall blocking Java from running. If so, opt to "allow access".
</p>
</li>
<li>
<p>
Start your browser and go to <span class="monospaced">http://127.0.0.1:8080/</span>
</p>
</li>
<li>
<p>
When you&#8217;re done, type <span class="monospaced">exit</span> at the SBT prompt to stop your application from running.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_expected_result">Expected result</h5>
<div class="paragraph"><p>The result of the above commands should be a basic Lift application running on
your computer as shown in <a href="#LiftBasicScreenshot">[LiftBasicScreenshot]</a>.</p></div>
<div class="imageblock" id="LiftBasicScreenshot">
<div class="content">
<img src="images/apphome.png" alt="images/apphome.png" width="640">
</div>
<div class="title">Figure 1. The basic Lift application home page.</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion">Discussion</h4>
<div class="paragraph"><p>Lift isn&#8217;t installed in the usual sense of "installing software".
Instead you use standard build tools, such as SBT or Maven, to assemble your application with the Lift framework. In this recipe we downloaded a ZIP file containing four fairly minimal Lift applications, and then started one of them via the build tool.</p></div>
<div class="sect4">
<h5 id="_simple_build_tool">Simple Build Tool</h5>
<div class="paragraph"><p>Typing <span class="monospaced">sbt</span> starts the Simple Build Tool, a dependency management
tool used by Scala projects (it&#8217;s not specific to Lift).  SBT will check the project definition and download any libraries required, which includes the Lift framework.</p></div>
<div class="paragraph"><p>This download happens once, and the downloaded
files are stored on disk in <span class="monospaced">.ivy2/</span> under your home folder.</p></div>
<div class="paragraph"><p>Your application build is configured by <span class="monospaced">build.sbt</span>.  Looking inside you&#8217;ll see:</p></div>
<div class="ulist"><ul>
<li>
<p>
basic information about your application, including a name and version;
</p>
</li>
<li>
<p>
resolvers, which inform SBT where to fetch dependencies from;
</p>
</li>
<li>
<p>
settings for plugins and the Scala compiler; and
</p>
</li>
<li>
<p>
a list of dependencies required to run your application, which will include the Lift framework.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="RunningYourApplication">Running Your Application</h5>
<div class="paragraph"><p>The SBT command <span class="monospaced">container:start</span> starts the web server on the default port of 8080 and
passes requests to your Lift application. The word <em>container</em> refers to the
software you deploy your application into. There are a variety of containers (<em>Jetty</em> and
<em>Tomcat</em> are probably the best known) all of which conform to a standard for deployment.
The upshot is you can build your application and deploy to whichever one you prefer.
The <span class="monospaced">container:start</span> command uses Jetty.</p></div>
</div>
<div class="sect4">
<h5 id="_source_code">Source Code</h5>
<div class="paragraph"><p>The source code of the application resides in <span class="monospaced">src/main/webapp</span> and <span class="monospaced">src/main/scala</span>. If you take a look at <span class="monospaced">index.html</span> in the <span class="monospaced">webapp</span> folder you&#8217;ll see mention of <span class="monospaced">lift:helloWorld</span>. That&#8217;s a reference to the class defined in <span class="monospaced">scala/code/snippet/HelloWorld.scala</span>. This is a <em>snippet invocation</em> and an example of Lift&#8217;s <em>view first</em> approach to web applications. That is, there&#8217;s no routing set up for the index page to collect the data and forward it to the view. Instead, the view defines areas of the content that are replaced with functions, such as those functions defined in <span class="monospaced">HelloWorld.scala</span>.</p></div>
<div class="paragraph"><p>Lift knows to look in the <span class="monospaced">code</span> package for snippets because that package is declared as a location for snippets in <span class="monospaced">scala/bootstrap/liftweb/Boot.scala</span>. The Boot class is run when starting your application, and it&#8217;s where you can configure the behaviour of Lift.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also">See Also</h4>
<div class="paragraph"><p>The Simple Build Tool documentation is at <a href="http://www.scala-sbt.org">http://www.scala-sbt.org</a>.</p></div>
<div class="paragraph"><p>Tutorials for Lift can be found in <em>Simply Lift</em> at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a> and in <em>Lift in Action</em> (Tim Perrett, 2011, Manning Publications Co).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="LiftFromScratch">Creating a Lift Project from Scratch using SBT</h3>
<div class="sect3">
<h4 id="_problem_2">Problem</h4>
<div class="paragraph"><p>You want want to create a Lift web project from scratch without using the ZIP files provided on the official Lift website.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_2">Solution</h4>
<div class="paragraph"><p>You will need to configure SBT and the Lift project yourself. Luckily, only five small files are needed.</p></div>
<div class="paragraph"><p>First, create an SBT plugin file at <span class="monospaced">project/plugins.sbt</span> (all file names are given relative to the project root directory):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">libraryDependencies</span> <span class="o">&lt;+=</span> <span class="n">sbtVersion</span><span class="o">(</span><span class="n">v</span> <span class="k">=&gt;</span> <span class="n">v</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="s">&quot;0.11.0&quot;</span> <span class="k">=&gt;</span> <span class="s">&quot;com.github.siasia&quot;</span> <span class="o">%%</span> <span class="s">&quot;xsbt-web-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;0.11.0-0.2.8&quot;</span>
  <span class="k">case</span> <span class="s">&quot;0.11.1&quot;</span> <span class="k">=&gt;</span> <span class="s">&quot;com.github.siasia&quot;</span> <span class="o">%%</span> <span class="s">&quot;xsbt-web-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;0.11.1-0.2.10&quot;</span>
  <span class="k">case</span> <span class="s">&quot;0.11.2&quot;</span> <span class="k">=&gt;</span> <span class="s">&quot;com.github.siasia&quot;</span> <span class="o">%%</span> <span class="s">&quot;xsbt-web-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;0.11.2-0.2.11&quot;</span>
  <span class="k">case</span> <span class="s">&quot;0.11.3&quot;</span> <span class="k">=&gt;</span> <span class="s">&quot;com.github.siasia&quot;</span> <span class="o">%%</span> <span class="s">&quot;xsbt-web-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;0.11.3-0.2.11.1&quot;</span>
  <span class="k">case</span> <span class="n">x</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">&quot;0.12&quot;</span><span class="o">))</span> <span class="k">=&gt;</span>
    <span class="s">&quot;com.github.siasia&quot;</span> <span class="o">%%</span> <span class="s">&quot;xsbt-web-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;0.12.0-0.2.11.1&quot;</span>
<span class="o">})</span>
</pre></div></div></div>
<div class="paragraph"><p>This file tells SBT that you will be using the xsbt-web-plugin and chooses the correct version based upon your version of SBT.</p></div>
<div class="paragraph"><p>Next, create an SBT build file, <span class="monospaced">build.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">organization</span> <span class="o">:=</span> <span class="s">&quot;org.yourorganization&quot;</span>

<span class="n">name</span> <span class="o">:=</span> <span class="s">&quot;liftfromscratch&quot;</span>

<span class="n">version</span> <span class="o">:=</span> <span class="s">&quot;0.1-SNAPSHOT&quot;</span>

<span class="n">scalaVersion</span> <span class="o">:=</span> <span class="s">&quot;2.10.0&quot;</span>

<span class="n">seq</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">siasia</span><span class="o">.</span><span class="nc">WebPlugin</span><span class="o">.</span><span class="n">webSettings</span> <span class="k">:_</span><span class="kt">*</span><span class="o">)</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5-RC2&quot;</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-webkit&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span> <span class="o">%</span> <span class="s">&quot;compile&quot;</span><span class="o">,</span>
    <span class="s">&quot;org.eclipse.jetty&quot;</span> <span class="o">%</span> <span class="s">&quot;jetty-webapp&quot;</span> <span class="o">%</span> <span class="s">&quot;8.1.7.v20120910&quot;</span> <span class="o">%</span> <span class="s">&quot;container,test&quot;</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Feel free to change the various versions, though be aware that certain versions of Lift are only build for certain versions of Scala.</p></div>
<div class="paragraph"><p>Now that you have a the basics of an SBT project, you can launch the <span class="monospaced">sbt</span> console. It should load all the necessary dependencies, including the proper Scala version, and bring you to a prompt.</p></div>
<div class="paragraph"><p>Next, create the following file at <span class="monospaced">src/main/webapp/WEB-INF/web.xml</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE web-app SYSTEM &quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;&gt;</span>
<span class="nt">&lt;web-app&gt;</span>
  <span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>LiftFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;display-name&gt;</span>Lift Filter<span class="nt">&lt;/display-name&gt;</span>
    <span class="nt">&lt;description&gt;</span>The Filter that intercepts Lift calls<span class="nt">&lt;/description&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>net.liftweb.http.LiftFilter<span class="nt">&lt;/filter-class&gt;</span>
  <span class="nt">&lt;/filter&gt;</span>
  <span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>LiftFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/filter-mapping&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">web.xml</span> files tells web containers, such as Jetty as configured by xsbt-web-plugin, to pass all requests on to Lift.</p></div>
<div class="paragraph"><p>Next, create a sample <span class="monospaced">index.html</span> file at <span class="monospaced">src/main/webapp/index.html</span> for our Lift app to load. For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Lift From Scratch<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome, you now have a working Lift installation<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Finally, setup the basic Lift boot settings by creating a <span class="monospaced">Boot.scala</span> file at <span class="monospaced">src/main/scala/bootstrap/Boot.scala</span>. The following contents will be sufficient:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">bootstrap.liftweb</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">Html5Properties</span><span class="o">,</span> <span class="nc">LiftRules</span><span class="o">,</span> <span class="nc">Req</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.sitemap.</span><span class="o">{</span><span class="nc">Menu</span><span class="o">,</span> <span class="nc">SiteMap</span><span class="o">}</span>

<span class="cm">/**</span>
<span class="cm"> * A class that&#39;s instantiated early and run.  It allows the application</span>
<span class="cm"> * to modify lift&#39;s environment</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">Boot</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">boot</span> <span class="o">{</span>
    <span class="c1">// where to search snippet</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">addToPackages</span><span class="o">(</span><span class="s">&quot;org.yourorganization.liftfromscratch&quot;</span><span class="o">)</span>

    <span class="c1">// Build SiteMap</span>
    <span class="k">def</span> <span class="n">sitemap</span><span class="o">()</span><span class="k">:</span> <span class="kt">SiteMap</span> <span class="o">=</span> <span class="nc">SiteMap</span><span class="o">(</span>
      <span class="nc">Menu</span><span class="o">.</span><span class="n">i</span><span class="o">(</span><span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">/</span> <span class="s">&quot;index&quot;</span>
    <span class="o">)</span>

    <span class="c1">// Use HTML5 for rendering</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">htmlProperties</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">set</span><span class="o">((</span><span class="n">r</span><span class="k">:</span> <span class="kt">Req</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="k">new</span> <span class="nc">Html5Properties</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">userAgent</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Congratulations, you now have a working Lift project!</p></div>
<div class="paragraph"><p>You can verify that you have a working Lift project by launching the Jetty web container from the <span class="monospaced">sbt</span> console with the <span class="monospaced">container:start</span> command. First the <span class="monospaced">Boot.scala</span> file should be compile and then you should be notified that Jetty has launched is listening at <a href="http://localhost:8080">http://localhost:8080</a>. You should be able to go to the address in your web browser and see the rendered <span class="monospaced">index.html</span> file you create earlier.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_2">Discussion</h4>
<div class="paragraph"><p>As shown above, creating a Lift project from scratch is a relatively simple process. However, it can be a tricky one for newcomers, especially if you are not used to the JVM ecosystem and its conventions for web containers. If you run into problems, make sure the files are in the correct locations and that their contents were not mistakenly modified. If all else fails, refere to the sample project below or ask for help on the <a href="http://groups.google.com/group/liftweb">Lift mailing list</a>.</p></div>
<div class="paragraph"><p>Lift projects using SBT or similar build tools follow a standard project layout, where Scala source code is in <span class="monospaced">src/main/scala</span> and web resources are in <span class="monospaced">src/main/webapp</span>. Your Scala files must be placed either directly at <span class="monospaced">src/main/scala</span> or in nested directories matching organization and name you defined in <span class="monospaced">build.sbt</span>, in our case giving us <span class="monospaced">src/main/scala/org/yourorganization/liftfromscratch/</span>. Test files match the directory structure but are placed in <span class="monospaced">src/test/</span> instead of <span class="monospaced">src/main/</span>. Likewise, the <span class="monospaced">web.xml</span> file must be placed in <span class="monospaced">src/main/webapp/WEB-INF/</span> for it to be properly detected.</p></div>
<div class="paragraph"><p>Given these conventions, you should have a directly structure looking quite, if not exactly, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>- project root directory
  | build.sbt
  - project/
    | plugins.sbt
  - src/
    - main/
      - scala/
        - bootstrap/
          | Boot.scala
        - org/
          - yourorganization/
            - liftfromscratch/
              | &lt;your Scala code goes here&gt;
      - webapp/
        | index.html
        | &lt;any other web resources - images, HTML, JavaScript, etc - go here&gt;
        - WEB-INF/
          | web.xml
    - test/
      - scala/
        - org/
          - yourorganization/
            - liftfromscratch/
              | &lt;your tests go here&gt;</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_2">See Also</h4>
<div class="paragraph"><p>There is a sample project created using this method at: <a href="https://github.com/bubblefoundry/lift-from-scratch">https://github.com/bubblefoundry/lift-from-scratch</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="texteditor">Developing Using a Text Editor</h3>
<div class="sect3">
<h4 id="_problem_3">Problem</h4>
<div class="paragraph"><p>You want to develop your Lift application using your favourite text
editor, hitting reload in your browser to see changes.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_3">Solution</h4>
<div class="paragraph"><p>Run SBT while you are editing, and ask it to detect and compile changes to Scala files.  To do that, start <span class="monospaced">sbt</span> and enter the following to the SBT prompt:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>~; container:start; container:reload /</pre>
</div></div>
<div class="paragraph"><p>When you save a source file in your editor, SBT will detect this change,
compile the file, and reload the web container.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_3">Discussion</h4>
<div class="paragraph"><p>An SBT command prefixed with <span class="monospaced">~</span> makes that command run when files
change. The first semicolon introduces a sequence of commands, where if
the first command succeeds, the second will run. The second semicolon
means the <span class="monospaced">reload</span> command will run if the <span class="monospaced">start</span> command ran OK. The <span class="monospaced">start</span>
command will recompile any Scala source files that have changed.</p></div>
<div class="paragraph"><p>When you run SBT in this way, you&#8217;ll notice the following output:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>1. Waiting for source changes... (press enter to interrupt)</pre>
</div></div>
<div class="paragraph"><p>And indeed, if you do press enter in the SBT window you&#8217;ll exit this <em>triggered
execution</em> mode and SBT will no longer be looking for file changes. However, while
SBT is watching for changes, the output will indicate when this happens with something
that looks a little like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[info] Compiling 1 Scala source to target/scala-2.9.1/classes...
[success] Total time: 1 s, completed 15-Nov-2012 18:14:46
[pool-301-thread-4] DEBUG net.liftweb.http.LiftServlet - Destroyed Lift handler.
[info] stopped o.e.j.w.WebAppContext{/,[src/main/webapp/]}
[info] NO JSP Support for /, did not find org.apache.jasper.servlet.JspServlet
[info] started o.e.j.w.WebAppContext{/,[src/main/webapp/]}
[success] Total time: 0 s, completed 15-Nov-2012 18:14:46
2. Waiting for source changes... (press enter to interrupt)</pre>
</div></div>
<div class="paragraph"><p>Edits to HTML files don&#8217;t trigger the SBT compile and reload commands.
This is because SBT&#8217;s default behaviour is to look for
Scala and Java source file changes, and also changes to files in <span class="monospaced">src/main/resources/</span>.
This works out just fine, because Jetty will use your modified HTML file when you
reload the browser page.</p></div>
<div class="paragraph"><p>Restarting the web container each time you edit a Scala file isn&#8217;t ideal. You can reduce
the need for restarts by integrating JRebel into your development environment, as described
in <a href="#jrebel">[jrebel]</a>.</p></div>
<div class="paragraph"><p>However, if you are making a serious number of edits, you may prefer to issue a <span class="monospaced">container:stop</span> command until you&#8217;re ready to run you application again with <span class="monospaced">container:start</span>. This will prevent SBT compiling and restarting your application over and over. The SBT console has a command history, and using the up and down keyboard arrows allows you to navigate to previous commands and run them by pressing the return key.  That takes some of the tedium out of these long commands.</p></div>
<div class="paragraph"><p>One error you may run into is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>java.lang.OutOfMemoryError: PermGen space</pre>
</div></div>
<div class="paragraph"><p>The <em>permanent generation</em> is a Java virtual machine concept. It&#8217;s the area of memory used for storing classes (amongst other things).  It&#8217;s a fixed size and once it is full this PermGen error appears.  As you might imagine, continually restarting a container causes many classes to be loaded and unloaded, but the process is not perfect, effectively leaking memory. The best you can do is stop and then restart SBT.  If you&#8217;re seeing this error often, check the setting for <span class="monospaced">-XX:MaxPermSize</span> inside the <span class="monospaced">sbt</span> (or <span class="monospaced">sbt.bat</span>) script, and if you can, double it.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_3">See Also</h4>
<div class="paragraph"><p>There&#8217;s more about triggered execution at <a href="http://www.scala-sbt.org/release/docs/Detailed-Topics/Triggered-Execution">http://www.scala-sbt.org/release/docs/Detailed-Topics/Triggered-Execution</a>.</p></div>
<div class="paragraph"><p>Reference for the core SBT command line: <a href="http://www.scala-sbt.org/release/docs/Detailed-Topics/Command-Line-Reference">http://www.scala-sbt.org/release/docs/Detailed-Topics/Command-Line-Reference</a>.</p></div>
<div class="paragraph"><p>Command reference for the web plugin for SBT is at: <a href="https://github.com/siasia/xsbt-web-plugin/wiki">https://github.com/siasia/xsbt-web-plugin/wiki</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="jrebel">Incorporating JRebel</h3>
<div class="sect3">
<h4 id="_problem_4">Problem</h4>
<div class="paragraph"><p>You want to avoid application restarts when you change a Scala source file by using JRebel.</p></div>
</div>
<div class="sect3">
<h4 id="_solutions">Solutions</h4>
<div class="paragraph"><p>There are three steps required: install JRebel once; each year request the free Scala license; and configure SBT to use JRebel.</p></div>
<div class="paragraph"><p>First, visit the <a href="http://zeroturnaround.com/software/jrebel/">http://zeroturnaround.com/software/jrebel/</a> and request the free Scala license.</p></div>
<div class="paragraph"><p>Second, download the "Generic ZIP Archive" version of JRebel, unzip it to where you like. For this recipe I&#8217;ve chosen to use <span class="monospaced">/opt/zt/jrebel/</span>.</p></div>
<div class="paragraph"><p>When your have received your account confirmation email from JRebel, you can copy your "authentication token" from the "Active" area of ZeroTurnaround&#8217;s site. To apply the token to your local install, run the JRebel configuration script:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ /opt/zt/jrebel/bin/jrebel-config.sh</pre>
</div></div>
<div class="paragraph"><p>For Windows navigate to and launch <span class="monospaced">bin\jrebel-config.cmd</span>.</p></div>
<div class="paragraph"><p>In the "Activation" setting select "I want to use myJRebel" and then in the "License" section paste in your activation token. Click the "Activate" button, and once you see the license status change to "You have a valid myJRebel token" click "Finish".</p></div>
<div class="paragraph"><p>Finally, configure SBT by modifying the <span class="monospaced">sbt</span> script to enable JRebel.  This means setting the <span class="monospaced">-javaagent</span> and <span class="monospaced">-noverify</span> flags for Java, and enabling the JRebel Lift plugin.</p></div>
<div class="paragraph"><p>For Mac and Linux, the script that&#8217;s included with the Lift downloads would become:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>java -Drebel.lift_plugin=true -noverify -javaagent:/opt/zt/jrebel/jrebel.jar \
 -Xmx1024M -Xss2M -XX:MaxPermSize=512m -XX:+CMSClassUnloadingEnabled -jar \
 `dirname $0`/sbt-launch-0.12.jar "$@"</pre>
</div></div>
<div class="paragraph"><p>For Windows, modify <span class="monospaced">sbt.bat</span> to be:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>set SCRIPT_DIR=%~dp0
java -Drebel.lift_plugin=true -noverify -javaagent:c:/opt/zt/jrebel/jrebel.jar \
 -XX:+CMSClassUnloadingEnabled -XX:MaxPermSize=256m -Xmx1024M -Xss2M \
 -jar "%SCRIPT_DIR%\sbt-launch-0.12.jar" %*</pre>
</div></div>
<div class="paragraph"><p>There&#8217;s nothing else to do to use JRebel.  When you start SBT you&#8217;ll see a large banner starting something like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>#############################################################

  JRebel 5.1.1 (201211271929)
  (c) Copyright ZeroTurnaround OU, Estonia, Tartu.

  Over the last 30 days JRebel prevented
  at least 335 redeploys/restarts saving you about 13.6 hours.
....</pre>
</div></div>
<div class="paragraph"><p>With JRebel installed, you can now <span class="monospaced">container:start</span> your application, modify and compile a Scala file and reload a page in your application. You&#8217;ll see a notice that the class has been reloaded:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[2012-12-16 23:15:44] JRebel: Reloading class 'code.snippet.HelloWorld'.</pre>
</div></div>
<div class="paragraph"><p>That change is live, without having to restart the container.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_4">Discussion</h4>
<div class="paragraph"><p>JRebel is very likely to speed up your development. It updates code in a running Java virtual machine, without having to stop and restart it.  The effect is that, on the whole, you can compile a class, then hit reload in your browser to see the change in your Lift application.</p></div>
<div class="paragraph"><p>Even with JRebel you will need to restart your applications from time to time, but JRebel usually reduces the number of restarts. For example, <span class="monospaced">Boot.scala</span> is run when your application starts, so if you modify something in your <span class="monospaced">Boot.scala</span> you&#8217;ll need to start and start your application. JRebel can&#8217;t help with that.</p></div>
<div class="paragraph"><p>But there are also other situations that JRebel cannot help with, such as when a superclass changes. Generally, JRebel will emit a warning about this in the console window.  If that happens, stop and start your application.</p></div>
<div class="paragraph"><p>The <span class="monospaced">-Drebel.lift_plugin=true</span> setting adds Lift-specific functionality to JRebel.  Specifically, it allows JRebel to reload changes to <span class="monospaced">LiftScreen</span>, <span class="monospaced">Wizard</span> and <span class="monospaced">RestHelper</span>. This means you can change fields or screens, and change REST <span class="monospaced">serve</span> code.</p></div>
<div class="sect4">
<h5 id="_purchased_licenses">Purchased licenses</h5>
<div class="paragraph"><p>This recipe uses a free Scala license for a service called myJRebel. This communicates with JRebel servers via the activation code.  If you have purchased a license from ZeroTurnaround, the situation is slightly different.  In this case, you will have a license key which you store in a file called <span class="monospaced">jrebel.lic</span>. You can place the file in a <span class="monospaced">.jrebel</span> folder in your home directory, or alongside <span class="monospaced">jrebel.jar</span> (e.g., in the <span class="monospaced">/opt/zt/jrebel/</span> folder if that&#8217;s where you installed JRebel), or you can specify some other location.  For the latter option, modify the <span class="monospaced">sbt</span> script and specify the location of the file by adding another Java setting:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>-Drebel.license=/path/to/jrebel.lic</pre>
</div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_4">See Also</h4>
<div class="paragraph"><p>You&#8217;ll find details about how JRebel works in the FAQ at: <a href="http://zeroturnaround.com/software/jrebel/resources/faq/">http://zeroturnaround.com/software/jrebel/resources/faq/</a>.</p></div>
<div class="paragraph"><p>The Lift support was announced in a blog post in 2012 at <a href="http://zeroturnaround.com/jrebel/lift-support-in-jrebel/">http://zeroturnaround.com/jrebel/lift-support-in-jrebel/</a>, where you&#8217;ll find more about the capabilities of the plugin.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="eclipse">Developing using Eclipse</h3>
<div class="sect3">
<h4 id="_problem_5">Problem</h4>
<div class="paragraph"><p>You want to develop your Lift application using the Eclipse IDE, hitting
reload in your browser to see changes.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_4">Solution</h4>
<div class="paragraph"><p>Use the "Scala IDE for Eclipse" plugin to Eclipse. The instructions for this
are given at <a href="http://scala-ide.org">http://scala-ide.org</a>. There are a number of options (nightly builds, milestones) but start with the stable version. This will give you an Eclipse perspective that knows about Scala.</p></div>
<div class="paragraph"><p>To create the project files to allow Eclipse to load your Lift project, install "sbteclipse" by adding the following to <span class="monospaced">projects/plugins.sbt</span> in your Lift project:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">addSbtPlugin</span><span class="o">(</span><span class="s">&quot;com.typesafe.sbteclipse&quot;</span> <span class="o">%</span> <span class="s">&quot;sbteclipse-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;2.1.2&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>You can then create Eclipse project files (<span class="monospaced">.project</span> and <span class="monospaced">.classpath</span>) by entering the
following to the SBT prompt:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>eclipse</pre>
</div></div>
<div class="paragraph"><p>Open the project in Eclipse by navigating to "File &gt; Import.." and select "General &gt; Existing
Projects into Workspace". Browse to and select your Lift project. You
are now set up to develop your application in Eclipse.</p></div>
<div class="paragraph"><p>To see live changes as you edit and save your work, run SBT in a separate terminal window.  That is, start <span class="monospaced">sbt</span> from a terminal window outside of Eclipse and enter the following:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>~; container:start; container:reload /</pre>
</div></div>
<div class="paragraph"><p>This behaviour of this command is described in <a href="#texteditor">[texteditor]</a>, but if you&#8217;re using JRebel (see <a href="#jrebel">[jrebel]</a>) then you just need to run <span class="monospaced">container:start</span> by itself.</p></div>
<div class="paragraph"><p>You can then edit in Eclipse, save to compile, and in your web browser hit reload to see
the changes.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_5">Discussion</h4>
<div class="paragraph"><p>One of the great benefits of an IDE is the ability to navigate source, by cmd+click (Mac) or F3 (PC).
You can ask the SBT <span class="monospaced">eclipse</span> command to download the Lift
source and Scaladoc, allowing you to click through to the Lift source from
methods and classes, which is a useful way to discover more about Lift.</p></div>
<div class="paragraph"><p>To achieve this in a project, run <span class="monospaced">eclipse with-source=true</span> in SBT, but if you want
this to be the default behaviour, add the following to your <span class="monospaced">build.sbt</span> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">EclipseKeys</span><span class="o">.</span><span class="n">withSource</span> <span class="o">:=</span> <span class="kc">true</span>
</pre></div></div></div>
<div class="paragraph"><p>If you find yourself using the plugin frequently, you may wish to declare it
in your global SBT configuration files so it appies to all projects.  To do that,
create a <span class="monospaced">~/.sbt/plugins/plugins.sbt</span> file containing:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">resolvers</span> <span class="o">+=</span> <span class="nc">Classpaths</span><span class="o">.</span><span class="n">typesafeResolver</span>

<span class="n">addSbtPlugin</span><span class="o">(</span><span class="s">&quot;com.typesafe.sbteclipse&quot;</span> <span class="o">%</span> <span class="s">&quot;sbteclipse-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;2.1.2&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Note the blank line between the <span class="monospaced">resolvers</span> and the <span class="monospaced">addSbtPlugin</span>.  In <span class="monospaced">.sbt</span> files, a blank line is required between statements.</p></div>
<div class="paragraph"><p>Finally, set any global configurations (such as <span class="monospaced">withSource</span>) in <span class="monospaced">~/.sbt/global.sbt</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_5">See Also</h4>
<div class="paragraph"><p>There are other useful settings for sbteclipse, described at <a href="https://github.com/typesafehub/sbteclipse/wiki">https://github.com/typesafehub/sbteclipse/wiki</a>.  You&#8217;ll also find the latest version number for the plugin on that site.</p></div>
<div class="paragraph"><p>The SBT <span class="monospaced">~/.sbt/</span> structure is described in the guide to using plugins at <a href="http://www.scala-sbt.org/release/docs/Getting-Started/Using-Plugins">http://www.scala-sbt.org/release/docs/Getting-Started/Using-Plugins</a> and in the wiki page for global configuration at <a href="http://www.scala-sbt.org/release/docs/Detailed-Topics/Global-Settings">http://www.scala-sbt.org/release/docs/Detailed-Topics/Global-Settings</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="idea">Developing using Intellij IDEA</h3>
<div class="sect3">
<h4 id="_problem_6">Problem</h4>
<div class="paragraph"><p>You want to use the Intellij IDEA development environment when writing your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_5">Solution</h4>
<div class="paragraph"><p>You need the Scala plugin for IntelliJ, and an SBT plugin to generate the IDEA project files.</p></div>
<div class="paragraph"><p>The IntelliJ plugin you&#8217;ll need to install once, and these instructions are for IntelliJ IDEA 12.  The details may vary between releases of the IDE, but the basic idea is to find the JetBrains Scala plugin, and download and install it.</p></div>
<div class="paragraph"><p>From the "Welcome to Intellij IDEA" screen, select "Configure" and then "Plugins". Select "Browse repositories&#8230;". In the search box, top right, type "Scala".  You&#8217;ll find on the left a number of matches: select "Scala".  On the right, you&#8217;ll see confirmation that this is the "Plugin for Scala language support" and the vendor is JetBrains Inc. Select the "Download and Install" icon from the top of the window (or right click to download and install). "Close" the dialog, and OK out of the Plugins window. You&#8217;ll be promoted to restart IntelliJ IDEA.</p></div>
<div class="paragraph"><p>With the IDE configured, you now need to add the SBT plugin inside your Lift project by adding the following to the file <span class="monospaced">projects/plugins.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">addSbtPlugin</span><span class="o">(</span><span class="s">&quot;com.github.mpeltonen&quot;</span> <span class="o">%</span> <span class="s">&quot;sbt-idea&quot;</span> <span class="o">%</span> <span class="s">&quot;1.3.0&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Start SBT and at the SBT prompt create the IDEA project files by typing:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gen-idea</pre>
</div></div>
<div class="paragraph"><p>This will generate the <span class="monospaced">.idea</span> and <span class="monospaced">.iml</span> files that IntelliJ uses. Inside IntelliJ you can open the project from the "File" menu, picking "Open&#8230;" and then navigating to your project and selecting the directory.</p></div>
<div class="paragraph"><p>To see live changes as you edit and save your work, run SBT in a separate terminal window.  That is, start <span class="monospaced">sbt</span> from a terminal window outside of IntelliJ and enter the following:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>~; container:start; container:reload /</pre>
</div></div>
<div class="paragraph"><p>This behaviour of this command is described in <a href="#texteditor">[texteditor]</a>, but if you&#8217;re using JRebel (see <a href="#jrebel">[jrebel]</a>) then you just need to run <span class="monospaced">container:start</span> by itself.</p></div>
<div class="paragraph"><p>Each time you compile or make the project, the container will pick up the changes, and you can see them by re-loading your browser window.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_6">Discussion</h4>
<div class="paragraph"><p>By default the <span class="monospaced">gen-idea</span> command will fetch source for dependent libraries. That means out-of-the-box you can click though to Lift source code to explore it and learn more about the framework.</p></div>
<div class="paragraph"><p>If you want to try the latest snapshot version of the plugin, you&#8217;ll need to include the snapshot repository in your <span class="monospaced">plugin.sbt</span> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">resolvers</span> <span class="o">+=</span> <span class="s">&quot;Sonatype snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;http://oss.sonatype.org/content/repositories/snapshots/&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>Setting up the SBT IDEA plugin globally, for all SBT projects, is the same pattern as described for Eclipse in <a href="#eclipse">[eclipse]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_6">See Also</h4>
<div class="paragraph"><p>The sbt-idea plugin at <a href="https://github.com/mpeltonen/sbt-idea">https://github.com/mpeltonen/sbt-idea</a> doesn&#8217;t have a configuration guide yet. One way to discover the features is to browse the release notes in the <span class="monospaced">notes</span> folder of that project.</p></div>
<div class="paragraph"><p>JetBrains have a blog for the Scala plugin with feature news and tips: <a href="http://blog.jetbrains.com/scala/">http://blog.jetbrains.com/scala/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="ViewH2">Viewing the lift_proto H2 Database</h3>
<div class="sect3">
<h4 id="_problem_7">Problem</h4>
<div class="paragraph"><p>You&#8217;re developing using the default <span class="monospaced">lift_proto.db</span> H2 database, and
you would like use a tool to look at the tables.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_6">Solution</h4>
<div class="paragraph"><p>Use the web interface included as part of H2. Here are the steps:</p></div>
<div class="ulist"><ul>
<li>
<p>
Locate the H2 JAR file. For me, this was: <span class="monospaced">~/.ivy2/cache/com.h2database/h2/jars/h2-1.2.147.jar</span>.
</p>
</li>
<li>
<p>
Start the server from a terminal window using the JAR file you found: <span class="monospaced">java -cp /path/to/h2-version.jar org.h2.tools.Server</span>
</p>
</li>
<li>
<p>
This should launch your web browser, asking you to login.
</p>
</li>
<li>
<p>
Select "Generic H2 Server" in "Saved Settings".
</p>
</li>
<li>
<p>
Enter <span class="monospaced">jdbc:h2:/path/to/youapp/lift_proto.db;AUTO_SERVER=TRUE</span> for "JDBC URL", adjusting the path for the location of your database, and adjusting the name of the database ("lift_proto.db") if different in your <span class="monospaced">Boot.scala</span>.
</p>
</li>
<li>
<p>
Press "Connect" to view and edit your database.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_discussion_7">Discussion</h4>
<div class="paragraph"><p>The default Lift projects that include a database, such as <span class="monospaced">lift_basic</span>, use the H2 relational database as it can be included as an SBT dependency and requires no external installation or configuration. It&#8217;s a fine product, although production deployments typically use standalone databases, such as PostgreSQL or MySQL.</p></div>
<div class="paragraph"><p>Even if you&#8217;re deploying to a non-H2 database it may be useful to keep H2 around because it has an in-memory mode, which is great for unit tests. This means you can create a database in-memory, no files on disk, and throw it away when your unit tests ends.</p></div>
<div class="paragraph"><p>If you don&#8217;t like the web interface, the connection settings described in this recipe should give you the information you need to configure other SQL tools.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_7">See Also</h4>
<div class="paragraph"><p>The properties of H2 are described at  <a href="http://www.h2database.com">http://www.h2database.com</a>.</p></div>
<div class="paragraph"><p>If you&#8217;re using the console frequently, consider mapping it accessible from your Lift application in development node.  This is described by Diego Medina in a blog post at <a href="https://fmpwizard.telegr.am/blog/lift-and-h2">https://fmpwizard.telegr.am/blog/lift-and-h2</a>.</p></div>
<div class="paragraph"><p>The example Lift project for <a href="#Squeryl">[Squeryl]</a> has the H2 console enabled. The source is: <a href="https://github.com/LiftCookbook/cookbook_squeryl">https://github.com/LiftCookbook/cookbook_squeryl</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="snapshot">Using the Latest Lift build</h3>
<div class="sect3">
<h4 id="_problem_8">Problem</h4>
<div class="paragraph"><p>You want to use the latest ("snapshot") build of Lift.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_7">Solution</h4>
<div class="paragraph"><p>You need to make two changes to your <span class="monospaced">build.sbt</span> file. First, reference
the snapshot repository:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">resolvers</span> <span class="o">+=</span> <span class="s">&quot;snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;http://oss.sonatype.org/content/repositories/snapshots&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>Second, change the <span class="monospaced">liftVersion</span> in your build to be the latest version. For this example, let&#8217;s use the 2.5-SNAPSHOT version of Lift:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5-SNAPSHOT&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>Restarting SBT (or issuing a <span class="monospaced">reload</span> command) will trigger a download
of the latest build.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_8">Discussion</h4>
<div class="paragraph"><p>Production releases of Lift (e.g., "2.4", "2.5"), as well as milestone releases
(e.g., "2.5-M3") and release candidates (e.g., "2.5-RC1") are published
into a releases repository. When SBT downloads them, they are downloaded
once.</p></div>
<div class="paragraph"><p>Snapshot releases are different: they are the result of an automated
build, and change often. You can force SBT to resolve the latest
versions by running the command <span class="monospaced">clean</span> and then <span class="monospaced">update</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_8">See Also</h4>
<div class="paragraph"><p>To learn the detail of SNAPSHOT versions, dig into the Maven Complete Reference at <a href="http://www.sonatype.com/books/mvnref-book/reference/pom-relationships-sect-pom-syntax.html">http://www.sonatype.com/books/mvnref-book/reference/pom-relationships-sect-pom-syntax.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="NewScala">Using a New Version of Scala</h3>
<div class="sect3">
<h4 id="_problem_9">Problem</h4>
<div class="paragraph"><p>A new Scala version has just been released and you want to immediately
use it in your Lift project.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_8">Solution</h4>
<div class="paragraph"><p>You may find that the latest snapshot of Lift is built using the latest
Scala version. Failing that, and assuming you cannot wait for a build, you may still be in luck.
Providing that the Scala version is <em>binary compatible</em> with the latest
version used by Lift, you can change your build file to force the Scala
version.</p></div>
<div class="paragraph"><p>For example, assuming your <span class="monospaced">build.sbt</span> file is set up to use Lift 2.5
with Scala 2.9.1:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scalaVersion</span> <span class="o">:=</span> <span class="s">&quot;2.9.1&quot;</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5&quot;</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-webkit&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span> <span class="o">%</span> <span class="s">&quot;compile-&gt;default&quot;</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Let&#8217;s assume that you now want to use Scala 2.9.2 but (pretend) Lift 2.5 was only
built against Scala 2.9.1. Replace <span class="monospaced">%%</span> with <span class="monospaced">%</span> for the <span class="monospaced">net.liftweb</span>
resources and explicitly include the Scala version that Lift was built
against for each Lift component:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scalaVersion</span> <span class="o">:=</span> <span class="s">&quot;2.9.2&quot;</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5&quot;</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%</span> <span class="s">&quot;lift-webkit_2.9.1&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span> <span class="o">%</span> <span class="s">&quot;compile-&gt;default&quot;</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>What we&#8217;ve done here is change the <span class="monospaced">scalaVersion</span> to the new version we want
to use, but explicitly specified we want the 2.9.1 Scala version for Lift.
This works if the two different Scala versions are binary compatible.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_9">Discussion</h4>
<div class="paragraph"><p>Dependencies have a particular naming convention.  For example, the <span class="monospaced">lift-webkit</span> library for Lift 2.5-RC2 is called <span class="monospaced">lift-webkit_2.9.1-2.5-RC2.jar</span>.  Normally in <span class="monospaced">build.sbt</span> we simply refer to <span class="monospaced">"net.liftweb" %% "lift-webkit"</span> and SBT turns that into the name of a file that can be downloaded.</p></div>
<div class="paragraph"><p>However, in this recipe we have forced SBT to explicitly fetch the 2.9.1 version
of the Lift resources rather than allow it to compute the URL to the
Lift components.  This is the difference between using <span class="monospaced">%%</span> and <span class="monospaced">%</span> in a
dependency: with <span class="monospaced">%%</span> you do not specify the Scala version as SBT will append
the <span class="monospaced">scalaVersion</span> number automatically; with <em>%</em> this automatic change is not made,
so we have to manually specify more details for the name of the library.</p></div>
<div class="paragraph"><p>Please note this only works for minor releases of Scala: major releases
break compatibility.  For example Scala 2.9.1 is compatible with Scala 2.9.0, but not 2.10.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_9">See Also</h4>
<div class="paragraph"><p>Binary compatibly in Scala is discussed on the Scala user mailing list at
<a href="http://article.gmane.org/gmane.comp.lang.scala.user/39290">http://article.gmane.org/gmane.comp.lang.scala.user/39290</a>.</p></div>
<div class="paragraph"><p>The SBT behaviour is described at: <a href="http://www.scala-sbt.org/release/docs/Getting-Started/Library-Dependencies">http://www.scala-sbt.org/release/docs/Getting-Started/Library-Dependencies</a>.</p></div>
<div class="paragraph"><p><a href="#snapshot">[snapshot]</a> describes how to use a snapshot version of Lift.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="HTML">HTML</h2>
<div class="sectionbody">
<div class="paragraph"><p>Generating HTML is often a major component of web applications.  This chapter is concerned with Lift&#8217;s <em>View First</em> approach and use of <em>CSS Selectors</em>.  Later chapters focus more specifically on form processing, REST web services, JavaScript, Ajax and Comet.</p></div>
<div class="paragraph"><p>Code for this chapter is at: <a href="https://github.com/LiftCookbook/cookbook_html">https://github.com/LiftCookbook/cookbook_html</a>.</p></div>
<div class="sect2">
<h3 id="TestingAndDebuggingSelectors">Testing and Debugging CSS Selectors</h3>
<div class="sect3">
<h4 id="_problem_10">Problem</h4>
<div class="paragraph"><p>You want to explore or debug CSS selectors interactively.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_9">Solution</h4>
<div class="paragraph"><p>You can use the Scala REPL to run your CSS selectors.</p></div>
<div class="paragraph"><p>Here&#8217;s an example were we test out a CSS selector which adds an <em>href</em> attribute to a link.
Start from within SBT and use the <span class="monospaced">console</span> command to get into the REPL:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; console
[info] Starting scala interpreter...
[info]
Welcome to Scala version 2.9.1.final
Type in expressions to have them evaluated.
Type :help for more information.</pre>
</div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">f</span> <span class="k">=</span> <span class="s">&quot;a [href]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;http://example.org&quot;</span>
<span class="n">f</span><span class="k">:</span> <span class="kt">net.liftweb.util.CssSel</span> <span class="o">=</span>
  <span class="o">(</span><span class="nc">Full</span><span class="o">(</span><span class="n">a</span> <span class="o">[</span><span class="kt">href</span><span class="o">]),</span> <span class="nc">Full</span><span class="o">(</span><span class="nc">ElemSelector</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="nc">Full</span><span class="o">(</span><span class="nc">AttrSubNode</span><span class="o">(</span><span class="n">href</span><span class="o">)))))</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">in</span> <span class="k">=</span> <span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="n">click</span> <span class="n">me</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="n">in</span><span class="k">:</span> <span class="kt">scala.xml.Elem</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="n">click</span> <span class="n">me</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">in</span><span class="o">)</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span>
  <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;http://example.org&quot;</span><span class="o">&gt;</span><span class="n">click</span> <span class="n">me</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">Helpers._</span> import brings in the CSS Selector functionality, which we then exercise by creating a selector, calling it with a (very simple) template and observing the result.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_10">Discussion</h4>
<div class="paragraph"><p>CSS selector transforms are one of the distinguishing features of Lift. They succinctly describe a node in your template (left-hand side) and give a replacement (operation, the right-hand side). They do take a little while to get use to, so being able to test them at the Scala REPL is useful.</p></div>
<div class="paragraph"><p>It may help to know that prior to CSS selectors Lift snippets were typically defined in terms
of a function that took a <span class="monospaced">NodeSeq</span> and returned a <span class="monospaced">NodeSeq</span>, often via a method called <span class="monospaced">bind</span>. Lift would take your template, which would be the input <span class="monospaced">NodeSeq</span>, apply the function, and returns a new <span class="monospaced">NodeSeq</span>.  You won&#8217;t see that usage so often any more, but the principle is the same.</p></div>
<div class="paragraph"><p>The CSS selector functionality in Lift gives you a <span class="monospaced">CssSel</span> function
which is <span class="monospaced">NodeSeq =&gt; NodeSeq</span>. We exploit this in the above example by constructing an input
<span class="monospaced">NodeSeq</span> (called <span class="monospaced">in</span>), then creating a CSS function (called <span class="monospaced">f</span>).  Because we know that <span class="monospaced">CssSel</span>
is defined as a <span class="monospaced">NodeSeq =&gt; NodeSeq</span> the natural way to execute the selector is to supply
the <span class="monospaced">in</span> as a parameter, and this gives us the answer, <span class="monospaced">res0</span>.</p></div>
<div class="paragraph"><p>If you use an IDE that supports a <em>worksheet</em>, which both Eclipse and IntelliJ IDEA do, then you can also run transformations in a worksheet.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_10">See Also</h4>
<div class="paragraph"><p>The syntax for selectors is best described in <em>Simply Lift</em> at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SequencingSelectorOps">Sequencing CSS Selector Operations</h3>
<div class="sect3">
<h4 id="_problem_11">Problem</h4>
<div class="paragraph"><p>You want your CSS selector binding to apply to the results of earlier
binding expressions.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_10">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">andThen</span> rather than <span class="monospaced">&amp;</span> to compose your selector expressions.</p></div>
<div class="paragraph"><p>For example, suppose we want to replace <span class="monospaced">&lt;div id="foo"/&gt;</span> with
<span class="monospaced">&lt;div id="bar"&gt;bar content&lt;/div&gt;</span> but for some reason we needed to
generate the <span class="monospaced">bar</span> div as a separate step in the selector expression:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>sbt&gt; console
[info] Starting scala interpreter...
[info]
Welcome to Scala version 2.9.1.final (Java 1.7.0_05).
Type in expressions to have them evaluated.
Type :help for more information.</pre>
</div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;#foo&quot;</span> <span class="o">#&gt;</span> <span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;bar&quot;</span><span class="o">/&gt;</span> <span class="n">andThen</span> <span class="s">&quot;#bar *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;bar content&quot;</span>
<span class="n">render</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=&gt;</span> <span class="n">scala</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="nc">NodeSeq</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">render</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;foo&quot;</span><span class="o">/&gt;)</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;bar&quot;</span><span class="o">&gt;</span><span class="n">bar</span> <span class="n">content</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_11">Discussion</h4>
<div class="paragraph"><p>When using <span class="monospaced">&amp;</span> think of the CSS selectors as always applying to the
original template, no matter what other expressions you are combining.
This is because <span class="monospaced">&amp;</span> is aggregating the selectors together before applying them; whereas <span class="monospaced">andThen</span> is
a method of all Scala functions that composes two functions together, with the first being
called before the second.</p></div>
<div class="paragraph"><p>Compare the example above if we change the <span class="monospaced">andThen</span> to
<span class="monospaced">&amp;</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;#foo&quot;</span> <span class="o">#&gt;</span> <span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;bar&quot;</span> <span class="o">/&gt;</span> <span class="o">&amp;</span> <span class="s">&quot;#bar *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;bar content&quot;</span>
<span class="n">render</span><span class="k">:</span> <span class="kt">net.liftweb.util.CssSel</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">render</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;foo&quot;</span><span class="o">/&gt;)</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;bar&quot;</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="paragraph"><p>The second expression will not match as it is applied to the original
input of <span class="monospaced">&lt;div id="foo"/&gt;</span>. The selector of <span class="monospaced">#bar</span> won&#8217;t match on that,
and adds nothing to the results of <span class="monospaced">render</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_11">See Also</h4>
<div class="paragraph"><p>The Lift Wiki page for CSS Selectors also describes this use of <span class="monospaced">andThen</span>: <a href="https://www.assembla.com/spaces/liftweb/wiki/Binding_via_CSS_Selectors">https://www.assembla.com/spaces/liftweb/wiki/Binding_via_CSS_Selectors</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SetMetaTag">Setting Meta Tag Contents</h3>
<div class="sect3">
<h4 id="_problem_12">Problem</h4>
<div class="paragraph"><p>You want to set the content of an HTML meta tag using Lift.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_11">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">@</span> CSS binding name selector. For example, given:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;keywords&quot;</span> <span class="na">content=</span><span class="s">&quot;words, here, please&quot;</span> <span class="nt">/&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The following snippet code will update the value of the contents
attribute:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;@keywords [content]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;words, we, really, want&quot;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_12">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">@</span> selector selects all elements with the given name. It&#8217;s useful in this case to change <span class="monospaced">&lt;meta name="keyword"&gt;</span> tag, but you may also see it used with elsewhere. For example, in an HTML form you can select input fields such as <span class="monospaced">&lt;input name="address"&gt;</span> with <span class="monospaced">"@address"</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">[content]</span> part is an example of a <em>replacement rule</em> that can follow a selector. That&#8217;s to say, it&#8217;s not specific to the <span class="monospaced">@</span> selector and can be used with other selectors.  In this example it replaces the value of the attribute called "content".  If the meta tag had no "content" attribute, it would be added.</p></div>
<div class="paragraph"><p>There are two other replacement rules useful for manipulating attributes:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">[content!]</span>&#8201;&#8212;&#8201;to remove an attribute with a matching value.
</p>
</li>
<li>
<p>
<span class="monospaced">[content+]</span>&#8201;&#8212;&#8201;to append to the value.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Examples of these would be&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">in</span> <span class="k">=</span> <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;keywords&quot;</span> <span class="n">content</span><span class="o">=</span><span class="s">&quot;words, here, please&quot;</span> <span class="o">/&gt;</span>
<span class="n">in</span><span class="k">:</span> <span class="kt">scala.xml.Elem</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;keywords&quot;</span> <span class="n">content</span><span class="o">=</span><span class="s">&quot;words, here, please&quot;</span><span class="o">&gt;&lt;/</span><span class="n">meta</span><span class="o">&gt;</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">remove</span> <span class="k">=</span> <span class="s">&quot;@keywords [content!]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;words, here, please&quot;</span>
<span class="n">remove</span><span class="k">:</span> <span class="kt">net.liftweb.util.CssSel</span> <span class="o">=</span> <span class="nc">CssBind</span><span class="o">(</span><span class="nc">Full</span><span class="o">(</span><span class="nd">@keywords</span> <span class="o">[</span><span class="kt">content!</span><span class="o">]),</span>
  <span class="nc">Full</span><span class="o">(</span><span class="nc">NameSelector</span><span class="o">(</span><span class="n">keywords</span><span class="o">,</span><span class="nc">Full</span><span class="o">(</span><span class="nc">AttrRemoveSubNode</span><span class="o">(</span><span class="n">content</span><span class="o">)))))</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">remove</span><span class="o">(</span><span class="n">in</span><span class="o">)</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;keywords&quot;</span><span class="o">&gt;&lt;/</span><span class="n">meta</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;and&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">add</span> <span class="k">=</span> <span class="s">&quot;@keywords [content+]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;, thank you&quot;</span>
<span class="n">add</span><span class="k">:</span> <span class="kt">net.liftweb.util.CssSel</span> <span class="o">=</span> <span class="nc">CssBind</span><span class="o">(</span><span class="nc">Full</span><span class="o">(</span><span class="nd">@keywords</span> <span class="o">[</span><span class="kt">content+</span><span class="o">]),</span>
  <span class="nc">Full</span><span class="o">(</span><span class="nc">NameSelector</span><span class="o">(</span><span class="n">keywords</span><span class="o">,</span><span class="nc">Full</span><span class="o">(</span><span class="nc">AttrAppendSubNode</span><span class="o">(</span><span class="n">content</span><span class="o">)))))</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">add</span><span class="o">(</span><span class="n">in</span><span class="o">)</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">meta</span> <span class="n">content</span><span class="o">=</span><span class="s">&quot;words, here, please, thank you&quot;</span>
  <span class="n">name</span><span class="o">=</span><span class="s">&quot;keywords&quot;</span><span class="o">&gt;&lt;/</span><span class="n">meta</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="sect4">
<h5 id="_appending_to_a_span_class_monospaced_class_span_attribute">Appending to a <span class="monospaced">class</span> Attribute</h5>
<div class="paragraph"><p>Although not directly relevant to <span class="monospaced">meta</span> tags, you should be aware of there is one convenient special case for appending to an attribute. If the attribute is <span class="monospaced">class</span>, a space is added together with your class value. As a demonstration of that, here&#8217;s an example of appending a class called "btn-primary" to a <span class="monospaced">div</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;div [class+]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;btn-primary&quot;</span>
<span class="n">render</span><span class="k">:</span> <span class="kt">net.liftweb.util.CssSel</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">render</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;btn&quot;</span><span class="o">/&gt;)</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">(&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;)</span>
</pre></div></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_12">See Also</h4>
<div class="paragraph"><p>The syntax for selectors is best described in <em>Simply Lift</em> at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a>.</p></div>
<div class="paragraph"><p>See <a href="#TestingAndDebuggingSelectors">[TestingAndDebuggingSelectors]</a> for how to run selectors from the REPL.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SetPageTitle">Setting the Page Title</h3>
<div class="sect3">
<h4 id="_problem_13">Problem</h4>
<div class="paragraph"><p>You want to set the <span class="monospaced">&lt;title&gt;</span> of the page from a Lift snippet.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_12">Solution</h4>
<div class="paragraph"><p>Select all the elements of the <span class="monospaced">title</span> element and replace them with the
text you want:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;title *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;I am different&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>Assuming you have a <span class="monospaced">&lt;title&gt;</span> tag in your template, the above will
result in:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>I am different<span class="nt">&lt;/title&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_13">Discussion</h4>
<div class="paragraph"><p>This example uses a element selector, which picks out tags in the HTML template, and replaces the content.</p></div>
<div class="paragraph"><p>As an alternative, it is also possible to set the page title from the contents of <span class="monospaced">SiteMap</span>,
meaning the title used will be the title you&#8217;ve assigned to the page in
the site map.  To do that, make use of <span class="monospaced">Menu.title</span> in your template directly:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;title</span> <span class="na">data-lift=</span><span class="s">&quot;Menu.title&quot;</span><span class="nt">&gt;&lt;/title&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">Menu.title</span> code appends to any existing text in the title.
This means the following will have the phrase "Site Title - " in the
title followed by the page title:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;title</span> <span class="na">data-lift=</span><span class="s">&quot;Menu.title&quot;</span><span class="nt">&gt;</span>Site Title - <span class="nt">&lt;/title&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>If you need more control, you can of course bind on <span class="monospaced">&lt;title&gt;</span> using a
regular snippet. This example uses a custom snippet to put the site
title after the page title:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;title</span> <span class="na">data-lift=</span><span class="s">&quot;MyTitle&quot;</span><span class="nt">&gt;&lt;/title&gt;</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">MyTitle</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;&lt;</span><span class="n">lift</span><span class="k">:</span><span class="kt">Menu.title</span> <span class="kt">/&gt;</span> <span class="kt">-</span> <span class="kt">Site</span> <span class="kt">Title&lt;/title&gt;</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_13">See Also</h4>
<div class="paragraph"><p>At <a href="https://www.assembla.com/spaces/liftweb/wiki/SiteMap">https://www.assembla.com/spaces/liftweb/wiki/SiteMap</a> there&#8217;s more about Site Map and the <span class="monospaced">Menu</span> snippets.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="ConditionalIncludes">HTML Conditional Comments</h3>
<div class="sect3">
<h4 id="_problem_14">Problem</h4>
<div class="paragraph"><p>You want to make use of Internet Explorer HTML conditional comments in your templates.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_13">Solution</h4>
<div class="paragraph"><p>Put the markup in a snippet and include the snippet in your page or
template.</p></div>
<div class="paragraph"><p>For example, suppose we want to include the HTML5 Shiv (a.k.a. HTML5 Shim) JavaScript so we can use HTML5
elements with legacy IE browsers.  To do that our snippet would be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">scala.xml.Unparsed</span>

<span class="k">object</span> <span class="nc">Html5Shiv</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="nc">Unparsed</span><span class="o">(</span><span class="s">&quot;&quot;&quot;&lt;!--[if lt IE 9]&gt;</span>
<span class="s">    &lt;script src=&quot;http://html5shim.googlecode.com/svn/trunk/html5.js&quot;&gt;</span>
<span class="s">    &lt;/script&gt;&lt;![endif]--&gt;&quot;&quot;&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We would then reference the snippet in the <span class="monospaced">&lt;head&gt;</span> of a page, perhaps even in
all pages via <span class="monospaced">templates-hidden/default.html</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">data-lift=</span><span class="s">&quot;Html5Shiv&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_14">Discussion</h4>
<div class="paragraph"><p>The HTML5 parser used by Lift does not carry comments from the source
through to the rendered page. If you just tried to paste the <em>html5shim</em> markup into
your template you&#8217;d find it missing from the rendered page.</p></div>
<div class="paragraph"><p>We deal with this by generating unparsed markup from a snippet. If you&#8217;re looking at
<span class="monospaced">Unparsed</span> and worried, your instincts are correct.  Normally Lift would cause the
markup to be escaped, but in this case we really do want
unparsed XML content (the comment tag) included in the output.</p></div>
<div class="paragraph"><p>If you find you&#8217;re using IE conditional comments frequently, you may want to create a more general version of the snippet.
For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">xml.</span><span class="o">{</span><span class="nc">NodeSeq</span><span class="o">,</span> <span class="nc">Unparsed</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.S</span>

<span class="k">object</span> <span class="nc">IEOnly</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">condition</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
    <span class="n">S</span><span class="o">.</span><span class="n">attr</span><span class="o">(</span><span class="s">&quot;cond&quot;</span><span class="o">)</span> <span class="n">openOr</span> <span class="s">&quot;IE&quot;</span>

  <span class="k">def</span> <span class="n">render</span><span class="o">(</span><span class="n">ns</span><span class="k">:</span> <span class="kt">NodeSeq</span><span class="o">)</span> <span class="k">:</span> <span class="kt">NodeSeq</span> <span class="o">=</span>
    <span class="nc">Unparsed</span><span class="o">(</span><span class="s">&quot;&lt;!--[if &quot;</span> <span class="o">+</span> <span class="n">condition</span> <span class="o">+</span> <span class="s">&quot;]&gt;&quot;</span><span class="o">)</span> <span class="o">++</span> <span class="n">ns</span> <span class="o">++</span> <span class="nc">Unparsed</span><span class="o">(</span><span class="s">&quot;&lt;![endif]--&gt;&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>It would be used like this&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;IEOnly&quot;</span><span class="nt">&gt;</span>
  A div just for IE
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;and produces output like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c">&lt;!--[if IE]&gt;&lt;div&gt;</span>
<span class="c">  A div just for IE</span>
<span class="c">&lt;/div&gt;&lt;![endif]--&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Notice that the <span class="monospaced">condition</span> test defaults to "IE", but first tries to look for an attribute called "cond".  This allows you to write:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;IEOnly?cond=lt+IE+9&quot;</span><span class="nt">&gt;</span>
  You&#39;re using IE 8 or earlier
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">+</span> symbol is the the URL encoding for a space, resulting in:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;&lt;div&gt;</span>
<span class="c">  You&#39;re using IE 8 or earlier</span>
<span class="c">&lt;/div&gt;&lt;![endif]--&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_14">See Also</h4>
<div class="paragraph"><p>The <span class="monospaced">IEOnly</span> example is derived from a posting on the mailing list from Antonio Salazar Cardozo: <a href="https://groups.google.com/d/msg/liftweb/kLzcJwfIqHQ/K91MdtoNz0MJ">https://groups.google.com/d/msg/liftweb/kLzcJwfIqHQ/K91MdtoNz0MJ</a>.</p></div>
<div class="paragraph"><p>The html5shim project can be found at: <a href="http://code.google.com/p/html5shim/">http://code.google.com/p/html5shim/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="PassThru">Returning Snippet Markup Unchanged</h3>
<div class="sect3">
<h4 id="_problem_15">Problem</h4>
<div class="paragraph"><p>You want a snippet to return the original markup associated with the
snippet invocation.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_14">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">PassThru</span> transform.</p></div>
<div class="paragraph"><p>For
example, suppose you have a snippet which performs a transforms when some
condition is met, but if the condition is not met, you want the snippet
return the original markup.</p></div>
<div class="paragraph"><p>Starting with the original markup&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;h2&gt;</span>Pass Thru Example<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;p&gt;</span>There&#39;s a 50:50 chance of seeing &quot;Try again&quot; or &quot;Congratulations!&quot;:<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;PassThruSnippet&quot;</span><span class="nt">&gt;</span>
  Try again - this is the template content.
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;we could leave it alone or change it with this snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.PassThru</span>

<span class="k">import</span> <span class="nn">scala.util.Random</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">class</span> <span class="nc">PassThruSnippet</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">fiftyFifty</span> <span class="k">=</span> <span class="nc">Random</span><span class="o">.</span><span class="n">nextBoolean</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fiftyFifty</span><span class="o">)</span> <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Congratulations! The content was changed&quot;</span><span class="o">)</span>
    <span class="k">else</span> <span class="nc">PassThru</span>

<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_15">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">PassThru</span> is an <em>identity function</em> of type <span class="monospaced">NodeSeq =&gt; NodeSeq</span>. It returns the input it
is given:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">PassThru</span> <span class="k">extends</span> <span class="nc">Function1</span><span class="o">[</span><span class="kt">NodeSeq</span>, <span class="kt">NodeSeq</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">NodeSeq</span><span class="o">)</span><span class="k">:</span> <span class="kt">NodeSeq</span> <span class="o">=</span> <span class="n">in</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>A related example is <span class="monospaced">ClearNodes</span>, defined as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">ClearNodes</span> <span class="k">extends</span> <span class="nc">Function1</span><span class="o">[</span><span class="kt">NodeSeq</span>, <span class="kt">NodeSeq</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">NodeSeq</span><span class="o">)</span><span class="k">:</span> <span class="kt">NodeSeq</span> <span class="o">=</span> <span class="nc">NodeSeq</span><span class="o">.</span><span class="nc">Empty</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The pattern of converting one <span class="monospaced">NodeSeq</span> to another is simple, but also powerful enough to get you out of most situations as you can always arbitrarily re-write the <span class="monospaced">NodeSeq</span>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SnippetNotFound">Snippet Not Found when using HTML5</h3>
<div class="sect3">
<h4 id="_problem_16">Problem</h4>
<div class="paragraph"><p>You&#8217;re using Lift with the HTML5 parser and one of your snippets is rendering with a "Class Not
Found" error. It even happens for <span class="monospaced">&lt;lift:HelloWorld.howdy /&gt;</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_15">Solution</h4>
<div class="paragraph"><p>Switch to the designer-friendly snippet invocation mechanism. E.g.,</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;HellowWorld.howdy&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_16">Discussion</h4>
<div class="paragraph"><p>The HTML5 parser and the traditional Lift XHTML parser have different
behaviours. In particular the HTML5 parser converts elements and attribute names to lower
case when looking up snippets. This means Lift would take <span class="monospaced">&lt;lift:HelloWorld.howdy /&gt;</span> and look for a class called "helloworld" rather than "HelloWorld", which would be the cause of the "Class Not Found Error".</p></div>
<div class="paragraph"><p>Switching to the designer-friendly mechanism is the solution here, and you gain validating HTML as a bonus.</p></div>
<div class="paragraph"><p>In this Cookbook we use the HTML5 parser, which is set in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Use HTML5 for rendering</span>
<span class="nc">LiftRules</span><span class="o">.</span><span class="n">htmlProperties</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">set</span><span class="o">(</span> <span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Req</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="k">new</span> <span class="nc">Html5Properties</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">userAgent</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_15">See Also</h4>
<div class="paragraph"><p>The key differences between the XHTML and HTML5 parser are outlined on the mailing list at <a href="https://groups.google.com/d/msg/liftweb/H-xe1uRLW1c/B60UH8P54VAJ">https://groups.google.com/d/msg/liftweb/H-xe1uRLW1c/B60UH8P54VAJ</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="AvoidAssetCaching">Avoiding CSS and JavaScript Caching</h3>
<div class="sect3">
<h4 id="_problem_17">Problem</h4>
<div class="paragraph"><p>You&#8217;ve modified CSS or JavaScript in your application, but web browsers
have cached your resources and are using the older versions. You&#8217;d like
to avoid this browser caching.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_16">Solution</h4>
<div class="paragraph"><p>Add the <span class="monospaced">with-resource-id</span> data-lift attribute to script or link tags:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">data-lift=</span><span class="s">&quot;with-resource-id&quot;</span> <span class="na">src=</span><span class="s">&quot;/myscript.js&quot;</span>
 <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The addition of this attribute will cause Lift to append a "resource id" to
your <span class="monospaced">src</span> (or <span class="monospaced">href</span>), and as this resource id changes each time Lift
starts, it defeats browser caching.</p></div>
<div class="paragraph"><p>The resultant HTML might be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/myscript.js?F619732897824GUCAAN=_&quot;</span>
  <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="nt">&gt;&lt;/script&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_17">Discussion</h4>
<div class="paragraph"><p>The random value that is appended to the resource is computed when your Lift application boots.  This means it should be stable between releases of your application.</p></div>
<div class="paragraph"><p>If you need some other behaviour from <span class="monospaced">with-resource-id</span> you can assign
a new function of type <span class="monospaced">String =&gt; String</span> to
<span class="monospaced">LiftRules.attachResourceId</span>. The default implementation, shown above,
takes the resource name, "/myscript.js" in the example, and returns the
resource name with an id appended.</p></div>
<div class="paragraph"><p>You can also wrap a number of tags inside a
<span class="monospaced">&lt;lift:with-resource-id&gt;...&lt;lift:with-resource-id&gt;</span> block. However,
avoid doing this in the <span class="monospaced">&lt;head&gt;</span> of your page as the HTML5 parser will
move the tags to be outside of the head section.</p></div>
<div class="paragraph"><p>Note that some proxies may choose not to cache resources with query
parameters at all. If that impacts you, it&#8217;s possible to code a custom resource-id method
to move the random resource ID out of the query parameter and into the path.</p></div>
<div class="paragraph"><p>Here&#8217;s one approach to doing this. Rather than generate JavaScript and CSS links that look like <span class="monospaced">/assets/style.css?F61973</span>, we will generate <span class="monospaced">/cache/F61973/assets/style.css</span>. We then will need to tell Lift to take requests
that look like this new format, and render the correct content for the request.  The code for this is:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.lib</span>

<span class="k">import</span> <span class="nn">net.liftweb.util._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http._</span>

<span class="k">object</span> <span class="nc">CustomResourceId</span> <span class="o">{</span>

 <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="c1">// The random number we&#39;re using to avoid caching</span>
  <span class="k">val</span> <span class="n">resourceId</span> <span class="k">=</span> <span class="nc">Helpers</span><span class="o">.</span><span class="n">nextFuncName</span>

  <span class="c1">// Prefix with-resource-id links with &quot;/cache/{resouceId}&quot;</span>
  <span class="nc">LiftRules</span><span class="o">.</span><span class="n">attachResourceId</span> <span class="k">=</span> <span class="o">(</span><span class="n">path</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
   <span class="s">&quot;/cache/&quot;</span> <span class="o">+</span> <span class="n">resourceId</span> <span class="o">+</span> <span class="n">path</span>
  <span class="o">}</span>

  <span class="c1">// Remove the cache/{resourceId} from the request if there is one</span>
  <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessRewrite</span><span class="o">.</span><span class="n">prepend</span><span class="o">(</span> <span class="nc">NamedPF</span><span class="o">(</span><span class="s">&quot;BrowserCacheAssist&quot;</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">case</span> <span class="nc">RewriteRequest</span><span class="o">(</span><span class="nc">ParsePath</span><span class="o">(</span><span class="s">&quot;cache&quot;</span> <span class="o">::</span> <span class="n">id</span> <span class="o">::</span> <span class="n">file</span><span class="o">,</span> <span class="n">suffix</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">),</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">RewriteResponse</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">suffix</span><span class="o">)</span>
  <span class="o">})</span>

 <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This would be initialised in <span class="monospaced">Boot.scala</span>&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">CustomResourceId</span><span class="o">.</span><span class="n">init</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;or you could just paste all the code into <span class="monospaced">Boot.scala</span>, if you prefer.</p></div>
<div class="paragraph"><p>With the code in place, we can, for example, modify <span class="monospaced">templates-hidden/default.html</span> and add a resource ID class to jQuery:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;jquery&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;with-resource-id&quot;</span>
  <span class="na">src=</span><span class="s">&quot;/classpath/jquery.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>At run-time this would be rendered in HTML as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">id=</span><span class="s">&quot;jquery&quot;</span>
  <span class="na">src=</span><span class="s">&quot;/cache/F352555437877UHCNRW/classpath/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Most of the work for this is happening in the <span class="monospaced">statelessRewrite</span>, which is working at a low-level inside Lift. The two parts to it are:</p></div>
<div class="ulist"><ul>
<li>
<p>
A <span class="monospaced">RewriteRequest</span> which is the pattern we&#8217;re matching on; and
</p>
</li>
<li>
<p>
A <span class="monospaced">RewriteResponse</span> which is the result we want if the request matches.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Looking at the <span class="monospaced">RewriteRequest</span> first, this expects three arguments: the path, which we care about, and then the method (e.g., <span class="monospaced">GetRequest</span>, <span class="monospaced">PutRequest</span>, etc) and the <span class="monospaced">HTTPRequest</span> itself, neither of which concern us in this instance.  In the path part we&#8217;re match on patterns that start with "cache", followed by something (we don&#8217;t care what), and then the rest of the path, represented by the name <span class="monospaced">file</span>.  In that situation, we rewrite to the original path, which is just the <span class="monospaced">file</span> with the <span class="monospaced">suffix</span>, effectively removing the <span class="monospaced">/cache/F352555437877UHCNRW</span> part.  This is the content that Lift will serve.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_16">See Also</h4>
<div class="paragraph"><p>The source for <span class="monospaced">LiftRules</span> shows the default implementation of <span class="monospaced">attachResourceId</span>: <a href="https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/LiftRules.scala">https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/LiftRules.scala</a>.</p></div>
<div class="paragraph"><p>Google&#8217;s <em>Optimize caching</em> notes are a good source of information about browser behaviour: <a href="https://developers.google.com/speed/docs/best-practices/caching">https://developers.google.com/speed/docs/best-practices/caching</a>.</p></div>
<div class="paragraph"><p>You can learn more about URL re-writing at the Lift wiki: <a href="https://www.assembla.com/spaces/liftweb/wiki/URL_Rewriting">https://www.assembla.com/spaces/liftweb/wiki/URL_Rewriting</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="AddToHead">Adding to the Head of a Page</h3>
<div class="sect3">
<h4 id="_problem_18">Problem</h4>
<div class="paragraph"><p>You use a template for layout, but on one specific page you need to add
something to the <span class="monospaced">&lt;head&gt;</span> section.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_17">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">head</span> snippet or CSS class so Lift knows to merge the
contents with the <span class="monospaced">&lt;head&gt;</span> of your page. For example, suppose you have
the following contents in <span class="monospaced">templates-hidden/default.html</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">xmlns:lift=</span><span class="s">&quot;http://liftweb.net/&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;&lt;/meta&gt;</span>
    <span class="nt">&lt;title</span> <span class="na">data-lift=</span><span class="s">&quot;Menu.title&quot;</span><span class="nt">&gt;</span>App: <span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;jquery&quot;</span> <span class="na">src=</span><span class="s">&quot;/classpath/jquery.js&quot;</span>
      <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;json&quot;</span> <span class="na">src=</span><span class="s">&quot;/classpath/json.js&quot;</span>
      <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
 <span class="nt">&lt;/head&gt;</span>
 <span class="nt">&lt;body&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span>The main content will get bound here<span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Also suppose you have <span class="monospaced">index.html</span> on which you want to include <span class="monospaced">red-titles.css</span> to just change the style of just this page.</p></div>
<div class="paragraph"><p>Do so by including the CSS in the part of the page that will get processed and mark it for the head with <span class="monospaced">head</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
 <span class="nt">&lt;head&gt;</span>
   <span class="nt">&lt;title&gt;</span>Special<span class="nt">&lt;/title&gt;</span>
 <span class="nt">&lt;/head&gt;</span>
 <span class="nt">&lt;body</span> <span class="na">data-lift-content-id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;surround?with=default;at=content&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">data-lift=</span><span class="s">&quot;head&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
       <span class="na">href=</span><span class="s">&quot;red-titles.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Hello<span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that this <span class="monospaced">index.html</span> page is validated HTML5, and will produce a
result with the custom CSS inside the <span class="monospaced">&lt;head&gt;</span> tag, something like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>App:  Home<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
    <span class="na">src=</span><span class="s">&quot;/classpath/jquery.js&quot;</span> <span class="na">id=</span><span class="s">&quot;jquery&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
    <span class="na">src=</span><span class="s">&quot;/classpath/json.js&quot;</span> <span class="na">id=</span><span class="s">&quot;json&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;red-titles.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;/head&gt;</span>
 <span class="nt">&lt;body&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;h2&gt;</span>Hello<span class="nt">&lt;/h2&gt;</span>
   <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/ajax_request/liftAjax.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="c1">// &lt;![CDATA[</span>
  <span class="kd">var</span> <span class="nx">lift_page</span> <span class="o">=</span> <span class="s2">&quot;F557573613430HI02U4&quot;</span><span class="p">;</span>
  <span class="c1">// ]]&gt;</span>
  <span class="nt">&lt;/script&gt;</span>
 <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_18">Discussion</h4>
<div class="paragraph"><p>If you find your tags not appearing the the <span class="monospaced">&lt;head&gt;</span> section, check that
the HTML in your template and page is valid HTML5.</p></div>
<div class="paragraph"><p>You can also use <span class="monospaced">&lt;lift:head&gt;...&lt;/lift:head&gt;</span> to wrap a number of
expressions, and will see <span class="monospaced">&lt;head_merge&gt;...&lt;/head_merge&gt;</span> used in code
example as an alternative to <span class="monospaced">&lt;lift:head&gt;</span>.</p></div>
<div class="paragraph"><p>Another variant you may see is <span class="monospaced">class="lift:head"</span>, as an alternative to <span class="monospaced">data-lift="head"</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">head</span> snippet is a built-in snippet, but otherwise no different from any snippet you might write.  What the snippet does is emit a <span class="monospaced">&lt;head&gt;</span> block, containing the elements you want in the head.  These can be <span class="monospaced">&lt;title&gt;</span>, <span class="monospaced">&lt;link&gt;</span>, <span class="monospaced">&lt;meta&gt;</span>, <span class="monospaced">&lt;style&gt;</span>, <span class="monospaced">&lt;script&gt;</span> or <span class="monospaced">&lt;base&gt;</span> tags.  How does this <span class="monospaced">&lt;head&gt;</span> block produced by the <span class="monospaced">head</span> snippet end up inside the main <span class="monospaced">&lt;head&gt;</span> section of the page?  When Lift processes your template, it automatically merges all <span class="monospaced">&lt;head&gt;</span> tags into the main <span class="monospaced">&lt;head&gt;</span> section of the page.</p></div>
<div class="paragraph"><p>You might suspect you can therefore put a plain old <span class="monospaced">&lt;head&gt;</span> section anywhere on your template, but that would not necessarily be valid HTML5 mark up.</p></div>
<div class="paragraph"><p>There&#8217;s also <span class="monospaced">tail</span> which works in a similar way, except anything marked with this snippet is moved to be just before the close of the body tag.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_17">See Also</h4>
<div class="paragraph"><p><a href="#JavaScriptTail">[JavaScriptTail]</a> describes how to move JavaScript to the end of the page.</p></div>
<div class="paragraph"><p>The W3C HTML validator is a useful tool for tracking down HTML markup issues that may cause problems with content being moved into the head of your page. <a href="http://validator.w3.org/">http://validator.w3.org/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="Custom404">Custom 404 Page</h3>
<div class="sect3">
<h4 id="_problem_19">Problem</h4>
<div class="paragraph"><p>You want to show a customised "404" (not found) page.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_18">Solution</h4>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> add the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http._</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">uriNotFound</span><span class="o">.</span><span class="n">prepend</span><span class="o">(</span><span class="nc">NamedPF</span><span class="o">(</span><span class="s">&quot;404handler&quot;</span><span class="o">){</span>
  <span class="k">case</span> <span class="o">(</span><span class="n">req</span><span class="o">,</span><span class="n">failure</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">NotFoundAsTemplate</span><span class="o">(</span><span class="nc">ParsePath</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">&quot;404&quot;</span><span class="o">),</span><span class="s">&quot;html&quot;</span><span class="o">,</span><span class="kc">true</span><span class="o">,</span><span class="kc">false</span><span class="o">))</span>
<span class="o">})</span>
</pre></div></div></div>
<div class="paragraph"><p>The file <span class="monospaced">src/main/webapp/404.html</span> will now be served for requests to
unknown resources.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_19">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">uriNotFound</span> Lift rule needs to return a <span class="monospaced">NotFound</span> in reply to a
<span class="monospaced">Req</span> and <span class="monospaced">Box[Failure]</span>. This allows you to customise the
response based on the type of failure or the request that was made.</p></div>
<div class="paragraph"><p>There are three types of <span class="monospaced">NotFound</span>:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">NotFoundAsTemplate</span>&#8201;&#8212;&#8201;useful to invoke the Lift template processing
facilities from a <span class="monospaced">ParsePath</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">NotFoundAsResponse</span>&#8201;&#8212;&#8201;allows you to return a specific <span class="monospaced">LiftResponse</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">NotFoundAsNode</span>&#8201;&#8212;&#8201;wrappers a <span class="monospaced">NodeSeq</span> for Lift to translate into a 404
response.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In the example we&#8217;re matching any not found situation, regardless of the request and the failure, and evaluating
this as a resource identified by <span class="monospaced">ParsePath</span>.  The path we&#8217;ve used is <span class="monospaced">/404.html</span>.</p></div>
<div class="paragraph"><p>In case you&#8217;re wondering, the last two <span class="monospaced">true</span> and <span class="monospaced">false</span> arguments to <span class="monospaced">ParsePath</span>
indicates the path we&#8217;ve given is absolute, and doesn&#8217;t end in a
slash.  <span class="monospaced">ParsePath</span> is a representation for a URI path, and exposing
if the path is absolute or ends in a slash are useful flags for matching on, but
in this case, they&#8217;re not relevant.</p></div>
<div class="paragraph"><p>Be aware that 404 pages, when rendered this way, won&#8217;t have a location in the site map. That&#8217;s because we&#8217;ve not included the <span class="monospaced">404.html</span> file in the site map, and we don&#8217;t have to because we&#8217;re rendering via <span class="monospaced">NotFoundAsTemplate</span> rather than sending a redirect to <em>/404.html</em>. However, this means that if you display an error page using a template that contains <span class="monospaced">Menu.builder</span> or similar (as <span class="monospaced">templates-hidden/default.html</span> does), you&#8217;ll see "No Navigation Defined".  In that case, you&#8217;ll probably want to use a different template on your 404 page.</p></div>
<div class="paragraph"><p>As an alternative, you could include the 404 page in your site map but make it hidden when the site map is displayed via the <span class="monospaced">Menu.builder</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Menu</span><span class="o">.</span><span class="n">i</span><span class="o">(</span><span class="s">&quot;404&quot;</span><span class="o">)</span> <span class="o">/</span> <span class="s">&quot;404&quot;</span> <span class="o">&gt;&gt;</span> <span class="nc">Hidden</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_18">See Also</h4>
<div class="paragraph"><p><a href="#CatchException">[CatchException]</a> for how to catch any exception thrown from your code.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="CustomStatusPage">Other Custom Status Pages</h3>
<div class="sect3">
<h4 id="_problem_20">Problem</h4>
<div class="paragraph"><p>You want to show a customised page for certain HTTP status codes.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_19">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">LiftRules.responseTransformers</span> to match against the response and
supply an alternative.</p></div>
<div class="paragraph"><p>For example, suppose we want to provide a custom page for 403
("Forbidden") statuses created in our Lift application.  Further suppose that
this page might contain snippets so will need to pass through the Lift
rendering flow.</p></div>
<div class="paragraph"><p>To do this in <span class="monospaced">Boot.scala</span> we define the <span class="monospaced">LiftResponse</span> we want to generate
and use the response when a 403 status is about to be produced by Lift:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">my403</span> <span class="k">:</span> <span class="kt">Box</span><span class="o">[</span><span class="kt">LiftResponse</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">session</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">session</span>
    <span class="n">req</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">request</span>
    <span class="n">template</span> <span class="k">=</span> <span class="nc">Templates</span><span class="o">(</span><span class="s">&quot;403&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
    <span class="n">response</span> <span class="k">&lt;-</span> <span class="n">session</span><span class="o">.</span><span class="n">processTemplate</span><span class="o">(</span><span class="n">template</span><span class="o">,</span> <span class="n">req</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="o">,</span> <span class="mi">403</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">response</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">responseTransformers</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">resp</span> <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">toResponse</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">403</span> <span class="k">=&gt;</span> <span class="n">my403</span> <span class="n">openOr</span> <span class="n">resp</span>
  <span class="k">case</span> <span class="n">resp</span> <span class="k">=&gt;</span> <span class="n">resp</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The file <em>src/main/webapp/403.html</em> will now be served for requests that
generate 403 status codes. Other non-403 responses are left untouched.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_20">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">LiftRules.responseTransformers</span> allows you to supply
<span class="monospaced">LiftResponse =&gt; LiftResponse</span> functions to change a response right at the end
of the HTTP processing cycle. This is a very general mechanism: in this
example we are matching on a status code, but we could match on anything
exposed by <span class="monospaced">LiftResponse</span>.</p></div>
<div class="paragraph"><p>In the recipe we processes a template to give a response, but you may find
situations where other kinds of response make sense, such as a <span class="monospaced">InMemoryResponse</span>.</p></div>
<div class="paragraph"><p>You could even simplify the example to just this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">responseTransformers</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">resp</span> <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">toResponse</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">403</span> <span class="k">=&gt;</span> <span class="nc">RedirectResponse</span><span class="o">(</span><span class="s">&quot;/403.html&quot;</span><span class="o">)</span>
  <span class="k">case</span> <span class="n">resp</span> <span class="k">=&gt;</span> <span class="n">resp</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>That will work just fine, with the only downside that the HTTP status code sent back to the web browser won&#8217;t be a 403 code.</p></div>
<div class="paragraph"><p>A more general approach, if you&#8217;re customising a number of pages, would be to define the status codes you want to
customise, create a page for each, and then only match on those pages:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">responseTransformers</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Customised</span><span class="o">(</span><span class="n">resp</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">resp</span>
  <span class="k">case</span> <span class="n">resp</span> <span class="k">=&gt;</span> <span class="n">resp</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Customised</span> <span class="o">{</span>

  <span class="c1">// The pages we have customised: 403.html and 500.html</span>
  <span class="k">val</span> <span class="n">definedPages</span> <span class="k">=</span> <span class="mi">403</span> <span class="o">::</span> <span class="mi">500</span> <span class="o">::</span> <span class="nc">Nil</span>

  <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">resp</span><span class="k">:</span> <span class="kt">LiftResponse</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">LiftResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">definedPages</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="k">_</span> <span class="o">==</span> <span class="n">resp</span><span class="o">.</span><span class="n">toResponse</span><span class="o">.</span><span class="n">code</span><span class="o">).</span><span class="n">flatMap</span><span class="o">(</span><span class="n">toResponse</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">toResponse</span><span class="o">(</span><span class="n">status</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Box</span><span class="o">[</span><span class="kt">LiftResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">session</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">session</span>
      <span class="n">req</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">request</span>
      <span class="n">template</span> <span class="k">=</span> <span class="nc">Templates</span><span class="o">(</span><span class="n">status</span><span class="o">.</span><span class="n">toString</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
      <span class="n">response</span> <span class="k">&lt;-</span> <span class="n">session</span><span class="o">.</span><span class="n">processTemplate</span><span class="o">(</span><span class="n">template</span><span class="o">,</span> <span class="n">req</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="o">,</span> <span class="n">status</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">response</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The convention in <span class="monospaced">Customised</span> is that we have a HTML file in <span class="monospaced">src/main/webapp</span> which matches
the status code we want to show, but of course you can change that by using a different
pattern in the argument to <span class="monospaced">Templates</span>.</p></div>
<div class="paragraph"><p>One way to test the above examples is to add the following to <span class="monospaced">Boot.scala</span> to
make all requests to <em>/secret</em> return a 403:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="nc">Protected</span> <span class="k">=</span> <span class="nc">If</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="kc">false</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">ForbiddenResponse</span><span class="o">(</span><span class="s">&quot;No!&quot;</span><span class="o">))</span>

<span class="k">val</span> <span class="n">entries</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
  <span class="nc">Menu</span><span class="o">.</span><span class="n">i</span><span class="o">(</span><span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">/</span> <span class="s">&quot;index&quot;</span><span class="o">,</span>
  <span class="nc">Menu</span><span class="o">.</span><span class="n">i</span><span class="o">(</span><span class="s">&quot;secret&quot;</span><span class="o">)</span> <span class="o">/</span> <span class="s">&quot;secret&quot;</span> <span class="o">&gt;&gt;</span> <span class="nc">Protected</span><span class="o">,</span>
  <span class="c1">// rest of your site map here...</span>
<span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>If you request <em>/secret</em>, a 403 response will be triggered, which will match the response transformer showing you
the contents of the <em>403.html</em> template.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">In Lift 3 <span class="monospaced">responseTransformers</span> will be modified to be a partial function, meaning you&#8217;ll be able to leave off the final <span class="monospaced">case r =&gt; r</span> part of this example.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_19">See Also</h4>
<div class="paragraph"><p><a href="#Custom404">[Custom404]</a> explains the built-in support for custom 404 messages.</p></div>
<div class="paragraph"><p><a href="#CatchException">[CatchException]</a> for how to catch any exception thrown from your code.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="LinksInNotice">Links in Notices</h3>
<div class="sect3">
<h4 id="_problem_21">Problem</h4>
<div class="paragraph"><p>You want to include a clickable link in your <span class="monospaced">S.error</span>, <span class="monospaced">S.notice</span> or
<span class="monospaced">S.warning</span> messages.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_20">Solution</h4>
<div class="paragraph"><p>Include a <span class="monospaced">NodeSeq</span> containing a link in your notice:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">S</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;checkPrivacyPolicy&quot;</span><span class="o">,</span>
  <span class="o">&lt;</span><span class="n">span</span><span class="o">&gt;</span><span class="nc">See</span> <span class="n">our</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;/policy&quot;</span><span class="o">&gt;</span><span class="n">privacy</span> <span class="n">policy</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">span</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="paragraph"><p>You might pair this with the following in your template&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;Msg?id=checkPrivacyPolicy&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_21">Discussion</h4>
<div class="paragraph"><p>You may be more familiar with the <span class="monospaced">S.error(String)</span> signature of the Lift notices than the versions
that take a <span class="monospaced">NodeSeq</span> as an argument, but the <span class="monospaced">String</span> versions just convert the <span class="monospaced">String</span> argument
to a <span class="monospaced">scala.xml.Text</span> kind of <span class="monospaced">NodeSeq</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_20">See Also</h4>
<div class="paragraph"><p>Lift notices are described on the Wiki: <a href="http://www.assembla.com/spaces/liftweb/wiki/Lift_Notices_and_Auto_Fadeout">http://www.assembla.com/spaces/liftweb/wiki/Lift_Notices_and_Auto_Fadeout</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="DownloadLink">Link to Download Data</h3>
<div class="sect3">
<h4 id="_problem_22">Problem</h4>
<div class="paragraph"><p>You want a button or a link which, which clicked, will trigger a download in the browser rather than visiting a page.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_21">Solution</h4>
<div class="paragraph"><p>Create a link using <span class="monospaced">SHtml.link</span>, provide a function to return a <span class="monospaced">LiftResponse</span> and wrap the response in a <span class="monospaced">ResponseShortcutException</span>.</p></div>
<div class="paragraph"><p>As an example, we will create a snippet that shows the user a poem and provides a link to download the poem as a text file.  The template for this snippet will present each line of the poem separated by a <span class="monospaced">&lt;br&gt;</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>A poem<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;DownloadLink&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;blockquote&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;poem&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;line&quot;</span><span class="nt">&gt;</span>line goes here<span class="nt">&lt;/span&gt;</span> <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/blockquote&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>download link here<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The snippet itself will render the poem and replace the download link with one which will send a
response that the browser will interpret as a file to download:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http._</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">class</span> <span class="nc">DownloadLink</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">poem</span> <span class="k">=</span>
    <span class="s">&quot;Roses are red,&quot;</span> <span class="o">::</span>
    <span class="s">&quot;Violets are blue,&quot;</span> <span class="o">::</span>
    <span class="s">&quot;Lift rocks!&quot;</span> <span class="o">::</span>
    <span class="s">&quot;And so do you.&quot;</span> <span class="o">::</span> <span class="nc">Nil</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
    <span class="s">&quot;.poem&quot;</span> <span class="o">#&gt;</span> <span class="n">poem</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="s">&quot;.line&quot;</span> <span class="o">#&gt;</span> <span class="n">line</span><span class="o">)</span> <span class="o">&amp;</span>
    <span class="s">&quot;a&quot;</span> <span class="o">#&gt;</span> <span class="n">downloadLink</span>

  <span class="k">def</span> <span class="n">downloadLink</span> <span class="k">=</span>
    <span class="nc">SHtml</span><span class="o">.</span><span class="n">link</span><span class="o">(</span><span class="s">&quot;/notused&quot;</span><span class="o">,</span>
      <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">ResponseShortcutException</span><span class="o">(</span><span class="n">poemTextFile</span><span class="o">),</span>
      <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Download&quot;</span><span class="o">)</span> <span class="o">)</span>

  <span class="k">def</span> <span class="n">poemTextFile</span> <span class="k">:</span> <span class="kt">LiftResponse</span> <span class="o">=</span>
    <span class="nc">InMemoryResponse</span><span class="o">(</span>
      <span class="n">poem</span><span class="o">.</span><span class="n">mkString</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">getBytes</span><span class="o">(</span><span class="s">&quot;UTF-8&quot;</span><span class="o">),</span>
      <span class="s">&quot;Content-Type&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;text/plain; charset=utf8&quot;</span> <span class="o">::</span>
      <span class="s">&quot;Content-Disposition&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;attachment; filename=\&quot;poem.txt\&quot;&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
      <span class="n">cookies</span><span class="k">=</span><span class="nc">Nil</span><span class="o">,</span> <span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Recall that <span class="monospaced">SHtml.link</span> generates a link and executes a function you supply before following the link.</p></div>
<div class="paragraph"><p>The trick here is that wrapping the <span class="monospaced">LiftResponse</span> in a <span class="monospaced">ResponseShortcutException</span> will indicate
to Lift that the response is complete, so the page being linked to (<span class="monospaced">notused</span>) won&#8217;t be processed. The browser is happy: it has a response to the link the user clicked on, and will render it how it wants to, which in this case will probably be by saving the file to disk.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_22">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">SHtml.link</span> works by generating a URL which Lift associates with the function you give it. On a page called <span class="monospaced">downloadlink</span>, the URL will look something like:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>downloadlink?F845451240716XSXE3G=_#notused</pre>
</div></div>
<div class="paragraph"><p>When that link is followed, Lift looks up the function and executes it, before processing the linked-to resource. However, in this case, we are short-cutting the Lift pipeline by throwing this particular exception.  This is caught by Lift and the response wrapped by the exception is taken as the final response from the request.</p></div>
<div class="paragraph"><p>This short-cutting is used by <span class="monospaced">S.redirectTo</span> via <span class="monospaced">ResponseShortcutException.redirect</span>. This companion object also defines <span class="monospaced">shortcutResponse</span> which you can use like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.ResponseShortcutException._</span>

<span class="k">def</span> <span class="n">downloadLink</span> <span class="k">=</span>
  <span class="nc">SHtml</span><span class="o">.</span><span class="n">link</span><span class="o">(</span><span class="s">&quot;/notused&quot;</span><span class="o">,</span>
    <span class="o">()</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="n">S</span><span class="o">.</span><span class="n">notice</span><span class="o">(</span><span class="s">&quot;The file was downloaded&quot;</span><span class="o">)</span>
      <span class="k">throw</span> <span class="n">shortcutResponse</span><span class="o">(</span><span class="n">poemTextFile</span><span class="o">)</span>
    <span class="o">},</span>
    <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Download&quot;</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>We&#8217;ve included a <span class="monospaced">S.notice</span> to highlight that <span class="monospaced">throw shortcutResponse</span> will process Lift notices when the page next loads, whereas <span class="monospaced">throw new ResponseShortcutException</span> does not.  In this case, the notice will not appear when the user downloads the file, but it will be included the next time notices are shown, such as when the user navigates to another page.  For many situations, the difference is immaterial.</p></div>
<div class="paragraph"><p>This recipe has used Lift&#8217;s stateful features.  You can see how useful it is to be able to close over state (the poem), and offer the data for download from memory.  If you&#8217;ve created a report from a database, you can offer it as a download without having to re-generate the items from the database.</p></div>
<div class="paragraph"><p>However, in other situations you might want to avoid holding this data as a function on a link. In that case, you&#8217;ll want to create a REST service that returns a <span class="monospaced">LiftResponse</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_21">See Also</h4>
<div class="paragraph"><p><a href="#REST">[REST]</a> looks at REST-based services in Lift.</p></div>
<div class="paragraph"><p><a href="#RestStreamContent">[RestStreamContent]</a> discusses <span class="monospaced">InMemoryResponse</span> and similar responses to return content to the browser</p></div>
<div class="paragraph"><p>For reports, the Apache POI project, <a href="http://poi.apache.org/">http://poi.apache.org/</a>, includes libraries for generating Excel files; and OpenCSV, <a href="http://opencsv.sourceforge.net">http://opencsv.sourceforge.net</a>, is a library for generating CSV files.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="TestingReq">Test on a Req</h3>
<div class="sect3">
<h4 id="_problem_23">Problem</h4>
<div class="paragraph"><p>You want to be able to test a function that needs a <span class="monospaced">Req</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_22">Solution</h4>
<div class="paragraph"><p>Supply a mock request to Lift&#8217;s <span class="monospaced">MockWeb.testReq</span>, and run your test in the context of the <span class="monospaced">Req</span> supplied by <span class="monospaced">testReq</span>.</p></div>
<div class="paragraph"><p>The first step is to add Lift&#8217;s Test Kit as dependency to your project in <span class="monospaced">build.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-testkit&quot;</span> <span class="o">%</span> <span class="s">&quot;2.5-RC2&quot;</span> <span class="o">%</span> <span class="s">&quot;test&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>To demonstrate how to use <span class="monospaced">testReq</span> we will test a function that detects a Google crawler. Google identifies
crawlers via various "User-Agent" header on a request, so the function we want to test would look like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.lib</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.Req</span>

<span class="k">object</span> <span class="nc">RobotDetector</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">botNames</span> <span class="k">=</span>
    <span class="s">&quot;Googlebot&quot;</span> <span class="o">::</span>
    <span class="s">&quot;Mediapartners-Google&quot;</span> <span class="o">::</span>
    <span class="s">&quot;AdsBot-Google&quot;</span> <span class="o">::</span> <span class="nc">Nil</span>

  <span class="k">def</span> <span class="n">known_?</span><span class="o">(</span><span class="n">ua</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
    <span class="n">botNames</span><span class="o">.</span><span class="n">exists</span><span class="o">(</span><span class="n">ua</span> <span class="n">contains</span> <span class="k">_</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">googlebot_?</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Req</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span>
    <span class="n">r</span><span class="o">.</span><span class="n">header</span><span class="o">(</span><span class="s">&quot;User-Agent&quot;</span><span class="o">).</span><span class="n">exists</span><span class="o">(</span><span class="n">known_?</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We have the list of magic <span class="monospaced">botNames</span> that Google sends as a user agent, and we define a check, <span class="monospaced">known_?</span>, that takes the user agent string and looks to see if any robot satisfies the condition of being contained in that user agent string.</p></div>
<div class="paragraph"><p>The <span class="monospaced">googlebot_?</span> method is given a Lift <span class="monospaced">Req</span> object and from this we look up the header.  This evaluates to a <span class="monospaced">Box[String]</span> as it&#8217;s possible there is no header. We find the answer by seeing if there exists in the <span class="monospaced">Box</span> a value that satisfies the <span class="monospaced">known_?</span> condition.</p></div>
<div class="paragraph"><p>To test this, we create a user agent string, prepare a <span class="monospaced">MockHttpServletRequest</span> with the header, and use Lift&#8217;s <span class="monospaced">MockWeb</span> to turn the low-level request into a Lift <span class="monospaced">Req</span> for us to test with:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.lib</span>

<span class="k">import</span> <span class="nn">org.specs2.mutable._</span>
<span class="k">import</span> <span class="nn">net.liftweb.mocks.MockHttpServletRequest</span>
<span class="k">import</span> <span class="nn">net.liftweb.mockweb.MockWeb</span>

<span class="k">class</span> <span class="nc">SingleRobotDetectorSpec</span> <span class="k">extends</span> <span class="nc">Specification</span> <span class="o">{</span>

  <span class="s">&quot;Google Bot Detector&quot;</span> <span class="n">should</span> <span class="o">{</span>

    <span class="s">&quot;spot a web crawler&quot;</span> <span class="n">in</span> <span class="o">{</span>

      <span class="k">val</span> <span class="n">userAgent</span> <span class="k">=</span> <span class="s">&quot;Mozilla/5.0 (compatible; Googlebot/2.1)&quot;</span>

      <span class="c1">// Mock a request with the right header:</span>
      <span class="k">val</span> <span class="n">http</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MockHttpServletRequest</span><span class="o">()</span>
      <span class="n">http</span><span class="o">.</span><span class="n">headers</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;User-Agent&quot;</span> <span class="o">-&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="n">userAgent</span><span class="o">))</span>

      <span class="c1">// Test with a Lift Req:</span>
      <span class="nc">MockWeb</span><span class="o">.</span><span class="n">testReq</span><span class="o">(</span><span class="n">http</span><span class="o">)</span> <span class="o">{</span> <span class="n">r</span> <span class="k">=&gt;</span>
        <span class="nc">RobotDetector</span><span class="o">.</span><span class="n">googlebot_?</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="n">must</span> <span class="n">beTrue</span>
      <span class="o">}</span>
    <span class="o">}</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Running this from SBT with the "test" command would produce:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[info] SingleRobotDetectorSpec
[info]
[info] Google Bot Detector should
[info] + spot a web crawler
[info]
[info] Total for specification SingleRobotDetectorSpec
[info] Finished in 18 ms
[info] 1 example, 0 failure, 0 error</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_23">Discussion</h4>
<div class="paragraph"><p>Although <span class="monospaced">MockWeb.testReq</span> is handling the creation of a <span class="monospaced">Req</span> for us, the environment for that <span class="monospaced">Req</span> is supplied by the <span class="monospaced">MockHttpServletRequest</span>. To configure a request, create an instance of the mock and mutate the state of it as required before using it with <span class="monospaced">testReq</span>.</p></div>
<div class="paragraph"><p>Aside from HTTP headers, you can set cookies, content type, query parameters, the HTTP method, authentication type, and the body.  There are variations on the <span class="monospaced">body</span> assignment, which conveniently set the content type depending on the value you assign:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">JValue</span> will use content type of "application/json".
</p>
</li>
<li>
<p>
<span class="monospaced">NodeSeq</span> will use "text/xml" (or you can supply an alternative).
</p>
</li>
<li>
<p>
<span class="monospaced">String</span> uses "text/plain" (unless you supply an alternative).
</p>
</li>
<li>
<p>
<span class="monospaced">Array[Byte]</span> does not set the content type.
</p>
</li>
</ul></div>
<div class="sect4">
<h5 id="_data_table">Data Table</h5>
<div class="paragraph"><p>In the example test above it would be tedious to have to set up the same code repeatedly for different user agents.  Specs2&#8217;s <em>Data Table</em> provides a compact way to run different example values through the same test:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.lib</span>

<span class="k">import</span> <span class="nn">org.specs2._</span>
<span class="k">import</span> <span class="nn">matcher._</span>
<span class="k">import</span> <span class="nn">net.liftweb.mocks.MockHttpServletRequest</span>
<span class="k">import</span> <span class="nn">net.liftweb.mockweb.MockWeb</span>

<span class="k">class</span> <span class="nc">RobotDetectorSpec</span> <span class="k">extends</span> <span class="nc">Specification</span> <span class="k">with</span> <span class="nc">DataTables</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">is</span> <span class="k">=</span> <span class="s">&quot;Can detect Google robots&quot;</span> <span class="o">^</span> <span class="o">{</span>
    <span class="s">&quot;Bot?&quot;</span> <span class="o">||</span> <span class="s">&quot;User Agent&quot;</span> <span class="o">|</span>
    <span class="kc">true</span>   <span class="o">!!</span> <span class="s">&quot;Mozilla/5.0 (Googlebot/2.1)&quot;</span> <span class="o">|</span>
    <span class="kc">true</span>   <span class="o">!!</span> <span class="s">&quot;Googlebot-Video/1.0&quot;</span> <span class="o">|</span>
    <span class="kc">true</span>   <span class="o">!!</span> <span class="s">&quot;Mediapartners-Google&quot;</span> <span class="o">|</span>
    <span class="kc">true</span>   <span class="o">!!</span> <span class="s">&quot;AdsBot-Google&quot;</span> <span class="o">|</span>
    <span class="kc">false</span>  <span class="o">!!</span> <span class="s">&quot;Mozilla/5.0 (KHTML, like Gecko)&quot;</span> <span class="o">|&gt;</span> <span class="o">{</span>
    <span class="o">(</span><span class="n">expectedResult</span><span class="o">,</span> <span class="n">userAgent</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">http</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MockHttpServletRequest</span><span class="o">()</span>
      <span class="n">http</span><span class="o">.</span><span class="n">headers</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;User-Agent&quot;</span> <span class="o">-&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="n">userAgent</span><span class="o">))</span>
      <span class="nc">MockWeb</span><span class="o">.</span><span class="n">testReq</span><span class="o">(</span><span class="n">http</span><span class="o">)</span> <span class="o">{</span> <span class="n">r</span> <span class="k">=&gt;</span>
        <span class="nc">RobotDetector</span><span class="o">.</span><span class="n">googlebot_?</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="n">must_==</span> <span class="n">expectedResult</span>
      <span class="o">}</span>
     <span class="o">}</span>
    <span class="o">}</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The core of this test is essentially unchanged: we create a mock, set the user agent, and check the result of <span class="monospaced">googlebot_?</span>.  The difference is that Specs2 is providing a neat way to list
out the various scenarios and pipe them through a function.</p></div>
<div class="paragraph"><p>The output from running this under SBT would be:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[info] Can detect Google robots
[info] + Bot?  | User Agent
[info]   true  | Mozilla/5.0 (Googlebot/2.1)
[info]   true  | Googlebot-Video/1.0
[info]   true  | Mediapartners-Google
[info]   true  | AdsBot-Google
[info]   false | Mozilla/5.0 (KHTML, like Gecko)
[info]
[info] Total for specification RobotDetectorSpec
[info] Finished in 1 ms
[info] 1 example, 0 failure, 0 error</pre>
</div></div>
<div class="paragraph"><p>Although the expected value appears first in our table, there&#8217;s no requirement to put it first.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_22">See Also</h4>
<div class="paragraph"><p>The Lift wiki discusses this topic and also other approaches such as testing with Selenium. <a href="https://www.assembla.com/spaces/liftweb/wiki/Testing_Lift_Applications">https://www.assembla.com/spaces/liftweb/wiki/Testing_Lift_Applications</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="Textile">Rendering Textile Markup</h3>
<div class="sect3">
<h4 id="_problem_24">Problem</h4>
<div class="paragraph"><p>You want to render Textile markup in your web application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_23">Solution</h4>
<div class="paragraph"><p>Install the Lift Textile module in your <span class="monospaced">build.sbt</span> file by adding the
following to the list of dependencies:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;net.liftmodules&quot;</span> <span class="o">%%</span> <span class="s">&quot;textile&quot;</span> <span class="o">%</span> <span class="o">(</span><span class="n">liftVersion</span> <span class="o">+</span> <span class="s">&quot;1.3&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>You can then use the module to render Textile using the <span class="monospaced">toHtml</span> method.</p></div>
<div class="paragraph"><p>For example, starting SBT after adding the module and running the SBT <em>console</em> command allows you to try out the module:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">net.liftmodules.textile._</span>
<span class="k">import</span> <span class="nn">net.liftmodules.textile._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="nc">TextileParser</span><span class="o">.</span><span class="n">toHtml</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s"> | h1. Hi!</span>
<span class="s"> |</span>
<span class="s"> | The module in &quot;Lift&quot;:http://www.liftweb.net for turning Textile markup</span>
<span class="s"> | into HTML is pretty easy to use.</span>
<span class="s"> |</span>
<span class="s"> | * As you can see.</span>
<span class="s"> | * In this example.</span>
<span class="s"> | &quot;&quot;&quot;</span><span class="o">)</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">scala.xml.NodeSeq</span> <span class="o">=</span>
<span class="nc">NodeSeq</span><span class="o">(,</span> <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="nc">Hi</span><span class="o">!&lt;/</span><span class="n">h1</span><span class="o">&gt;,</span>
<span class="o">,</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">The</span> <span class="n">module</span> <span class="n">in</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;http://www.liftweb.net&quot;</span><span class="o">&gt;</span><span class="nc">Lift</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">turning</span> <span class="nc">Textile</span>
  <span class="n">markup</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;&lt;/</span><span class="n">br</span><span class="o">&gt;</span><span class="n">into</span> <span class="nc">HTML</span> <span class="n">is</span> <span class="n">pretty</span> <span class="n">easy</span> <span class="n">to</span> <span class="n">use</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;,</span>
<span class="o">,</span> <span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;</span> <span class="nc">As</span> <span class="n">you</span> <span class="n">can</span> <span class="n">see</span><span class="o">.&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span> <span class="nc">In</span> <span class="k">this</span> <span class="n">example</span><span class="o">.&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;,</span>
<span class="o">,</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>It&#8217;s a little easier to see the output if we pretty print it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">pp</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrettyPrinter</span><span class="o">(</span><span class="n">width</span><span class="k">=</span><span class="mi">35</span><span class="o">,</span> <span class="n">step</span><span class="k">=</span><span class="mi">2</span><span class="o">)</span>
<span class="n">pp</span><span class="k">:</span> <span class="kt">scala.xml.PrettyPrinter</span> <span class="o">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="nc">PrettyPrinter</span><span class="k">@</span><span class="mi">54</span><span class="n">c19de8</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">pp</span><span class="o">.</span><span class="n">formatNodes</span><span class="o">(</span><span class="n">res0</span><span class="o">)</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
<span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="nc">Hi</span><span class="o">!&lt;/</span><span class="n">h1</span><span class="o">&gt;&lt;</span><span class="n">p</span><span class="o">&gt;</span>
  <span class="nc">The</span> <span class="n">module</span> <span class="n">in</span>
  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;http://www.liftweb.net&quot;</span><span class="o">&gt;</span>
    <span class="nc">Lift</span>
  <span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
  <span class="k">for</span> <span class="n">turning</span> <span class="nc">Textile</span> <span class="n">markup</span>
  <span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;&lt;/</span><span class="n">br</span><span class="o">&gt;</span>
  <span class="n">into</span> <span class="nc">HTML</span> <span class="n">is</span> <span class="n">pretty</span> <span class="n">easy</span> <span class="n">to</span> <span class="n">use</span><span class="o">.</span>
<span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span> <span class="nc">As</span> <span class="n">you</span> <span class="n">can</span> <span class="n">see</span><span class="o">.&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span> <span class="nc">In</span> <span class="k">this</span> <span class="n">example</span><span class="o">.&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_24">Discussion</h4>
<div class="paragraph"><p>There&#8217;s nothing special code has to do to become a Lift module, although there are common conventions: they typically are packaged as <em>net.liftmodules</em>, but don&#8217;t have to be; they usually depend on a version of Lift; they sometimes use the hooks provided by <span class="monospaced">LiftRules</span> to provide a particular behaviour.  Anyone can create and publish a Lift module, and anyone can contribute to existing modules. In the end, they are declared as dependencies in SBT, and pulled into your code just like any other dependency.</p></div>
<div class="paragraph"><p>The dependency version is made up of two elements: the Lift version, and the module version, as shown in <a href="#ModuleVersioning">[ModuleVersioning]</a>. This is because modules have their own release cycle, so you could have versions 1.1, 1.2 and 1.3 all for the same version of Lift. However, they may also depend on certain features of Lift, hence the combined version number.</p></div>
<div class="imageblock" id="ModuleVersioning">
<div class="content">
<img src="images/moduleversioning.png" alt="images/moduleversioning.png">
</div>
<div class="title">Figure 2. The structure of a module version.</div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_23">See Also</h4>
<div class="paragraph"><p>There&#8217;s no real specification of what Textile is, but there are references available which cover the typical kinds of mark up to enter and what HTML you can expect to see: <a href="http://redcloth.org/hobix.com/textile/">http://redcloth.org/hobix.com/textile/</a>.</p></div>
<div class="paragraph"><p>The home of the Textile module: <a href="https://github.com/liftmodules/textile">https://github.com/liftmodules/textile</a>.</p></div>
<div class="paragraph"><p>The unit tests for the Textile module give you a good set of examples of what is supported: <a href="https://github.com/liftmodules/textile/blob/master/src/test/scala/net/liftmodules/textile/TextileSpec.scala">https://github.com/liftmodules/textile/blob/master/src/test/scala/net/liftmodules/textile/TextileSpec.scala</a>.</p></div>
<div class="paragraph"><p><a href="#modules">[modules]</a> describes how to create modules.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Forms">Forms Processing in Lift</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section gives examples of working with Lift forms in different
ways.  You&#8217;ll find many of the examples in <a href="https://github.com/LiftCookbook/cookbook_forms">https://github.com/LiftCookbook/cookbook_forms</a>.</p></div>
<div class="sect2">
<h3 id="PlainFormProcessing">Plain Old Form Processing</h3>
<div class="sect3">
<h4 id="_problem_25">Problem</h4>
<div class="paragraph"><p>You want to process form data in a regular old-fashioned, non-Ajax, way.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_24">Solution</h4>
<div class="paragraph"><p>Extract form values with <span class="monospaced">S.param</span>, process the values, and produce some output.</p></div>
<div class="paragraph"><p>For example, we can show a form, process an input value, and give a message back as a notice.  The template is a regular HTML form, with the addition of a snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">data-lift=</span><span class="s">&quot;Plain&quot;</span> <span class="na">action=</span><span class="s">&quot;/plain&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;What&#39;s your name?&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Go&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>In the snippet we can pick out the value of the field "name" with <span class="monospaced">S.param("name")</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.common.Full</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.S</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.PassThru</span>

<span class="k">object</span> <span class="nc">Plain</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="n">S</span><span class="o">.</span><span class="n">param</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">S</span><span class="o">.</span><span class="n">notice</span><span class="o">(</span><span class="s">&quot;Hello &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">)</span>
      <span class="n">S</span><span class="o">.</span><span class="n">redirectTo</span><span class="o">(</span><span class="s">&quot;/plain&quot;</span><span class="o">)</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
      <span class="nc">PassThru</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>When you reach this template in your browser, the first time through there will be no parameter so we just pass back the form unchanged. You can then enter a value into the "name" field and submit the form. This will result in Lift processing the template again, but this time with a value for the "name" input.  The result will be your browser redirected to a page with a message set for display.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_25">Discussion</h4>
<div class="paragraph"><p>Manually plucking parameters from a request isn&#8217;t making the best use of Lift, but sometimes you need to do it, and <span class="monospaced">S.param</span> is the way you can process request parameters.</p></div>
<div class="paragraph"><p>The result of <span class="monospaced">S.param</span> is a <span class="monospaced">Box[String]</span>, and in the above example we pattern match on a value.  With more than one parameter you&#8217;re probably see <span class="monospaced">S.param</span> used in this way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">name</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">param</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
    <span class="n">pet</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">param</span><span class="o">(</span><span class="s">&quot;petName&quot;</span><span class="o">)</span>
  <span class="o">}</span> <span class="o">{</span>
    <span class="n">S</span><span class="o">.</span><span class="n">notice</span><span class="o">(</span><span class="s">&quot;Hello %s and %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="n">pet</span><span class="o">))</span>
    <span class="n">S</span><span class="o">.</span><span class="n">redirectTo</span><span class="o">(</span><span class="s">&quot;/plain&quot;</span><span class="o">)</span>
  <span class="o">}</span>

 <span class="nc">PassThru</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>If both "name" and "petName" are provided, the body of the <em>for</em> will be evaluated.</p></div>
<div class="paragraph"><p>Related function on <span class="monospaced">S</span> include:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">S.params(name)</span>&#8201;&#8212;&#8201;producing a <span class="monospaced">List[String]</span> for all the request parameters with the given name.
</p>
</li>
<li>
<p>
<span class="monospaced">S.post_?</span>, <span class="monospaced">S.get_?</span>-- to see if the request was a GET or POST.
</p>
</li>
<li>
<p>
<span class="monospaced">S.getRequestHeader(name)</span>&#8201;&#8212;&#8201;giving the <span class="monospaced">Box[String]</span> for a header in the request with the given name.
</p>
</li>
<li>
<p>
<span class="monospaced">S.request</span>&#8201;&#8212;&#8201;to access the <span class="monospaced">Box[Req]</span> which gives you access to further HTTP-specific information about the request.
</p>
</li>
</ul></div>
<div class="paragraph"><p>As an example of using <span class="monospaced">S.request</span> we could produce a <span class="monospaced">List[String]</span> for the values of all request parameters that have "name" somewhere in their parameter name:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">names</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">req</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">toList</span>
  <span class="n">paramName</span> <span class="k">&lt;-</span> <span class="n">req</span><span class="o">.</span><span class="n">paramNames</span>
  <span class="k">if</span> <span class="n">paramName</span><span class="o">.</span><span class="n">toLowerCase</span> <span class="n">contains</span> <span class="s">&quot;name&quot;</span>
  <span class="n">value</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">param</span><span class="o">(</span><span class="n">paramName</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">value</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that by opening up <span class="monospaced">S.request</span> we can access all the parameter names via <span class="monospaced">paramNames</span> function on <span class="monospaced">Req</span>.</p></div>
<div class="paragraph"><p>Screen or Wizard provide alternatives for form processing, but sometimes
you just want to pull values from a request, as demonstrated in this
recipe.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_24">See Also</h4>
<div class="paragraph"><p><em>Simply Lift</em> covers a variety of ways of processing forms.  See: <a href="http://simply.liftweb.net">http://simply.liftweb.net</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="AjaxFormProcessing">Ajax Form Processing</h3>
<div class="sect3">
<h4 id="_problem_26">Problem</h4>
<div class="paragraph"><p>You want to process a form on the server via Ajax, without reloading the
whole page.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_25">Solution</h4>
<div class="paragraph"><p>Mark your form as an Ajax form with <span class="monospaced">lift:form.ajax</span> and supply a
function to run on the server when the form is submitted. Given this
form&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;AjaxExample&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;form</span> <span class="na">data-lift=</span><span class="s">&quot;form.ajax&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;info&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;sb&quot;</span> <span class="na">value=</span><span class="s">&quot;go!&quot;</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;/form&gt;</span>
 <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;result&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;we use the following snippet to accept the text field input of <span class="monospaced">info</span>
and send back a JavasScript command to update the <span class="monospaced">result</span> div with the
value sent to us:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js._</span>
<span class="k">import</span> <span class="nn">JsCmds._</span>

<span class="k">import</span> <span class="nn">scala.xml.Text</span>

<span class="k">class</span> <span class="nc">AjaxExample</span> <span class="o">{</span>

  <span class="k">var</span> <span class="n">inputVal</span> <span class="k">=</span> <span class="s">&quot;default&quot;</span>

  <span class="k">def</span> <span class="n">process</span><span class="o">()</span><span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="s">&quot;Received: &quot;</span><span class="o">+</span><span class="n">inputVal</span><span class="o">)</span>
    <span class="nc">SetHtml</span><span class="o">(</span><span class="s">&quot;result&quot;</span><span class="o">,</span> <span class="nc">Text</span><span class="o">(</span><span class="n">inputVal</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>
    <span class="s">&quot;name=info&quot;</span> <span class="o">#&gt;</span> <span class="o">(</span>
        <span class="nc">SHtml</span><span class="o">.</span><span class="n">text</span><span class="o">(</span><span class="n">inputVal</span><span class="o">,</span> <span class="n">inputVal</span> <span class="k">=</span> <span class="k">_</span><span class="o">)</span> <span class="o">++</span>
        <span class="nc">SHtml</span><span class="o">.</span><span class="n">hidden</span><span class="o">(</span><span class="n">process</span><span class="o">)</span> <span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_26">Discussion</h4>
<div class="paragraph"><p>The form&#8217;s <span class="monospaced">info</span> input is bound to a <span class="monospaced">SHtml.text</span> box which will set
the local <span class="monospaced">inputVal</span> variable to the value submitted by the form.</p></div>
<div class="paragraph"><p>The hidden field instructs Lift to call the <span class="monospaced">() =&gt; Any</span> function
(<span class="monospaced">process</span>, in this example) when the form is submitted. The end result
is the text entered is echoed back by setting the HTML node <span class="monospaced">result</span>.
There are many other <span class="monospaced">JsCmd`s you could send, including `Noop</span> if you
decide to send nothing.</p></div>
<div class="paragraph"><p>In <span class="monospaced">SHtml</span> you will see functions starting with "ajax" (e.g.,
<span class="monospaced">ajaxText</span>). These are great for field-level Ajax interactions, such as
triggering actions on input or selection changes.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_25">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<em>Simply Lift</em>, chapter 4.8
<a href="http://stable.simply.liftweb.net/#toc-Section-4.8">Ajax</a>.
</p>
</li>
<li>
<p>
Example <a href="https://github.com/marekzebrowski/lift-basics">simple forms</a>
Lift project.
</p>
</li>
<li>
<p>
<a href="http://www.assembla.com/spaces/liftweb/wiki/cool_tips">Server side
function order</a> on the Lift Cool Tips Wiki page.
*
<a href="http://scala-tools.org/mvnsites/liftweb-2.4/net/liftweb/http/SHtml.html">SHtml
Scala Doc</a>.
</p>
</li>
<li>
<p>
Lift&#8217;s <a href="http://demo.liftweb.net/ajax">Ajax Demo page</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="JsonForms">Ajax JSON Form Processing</h3>
<div class="sect3">
<h4 id="_problem_27">Problem</h4>
<div class="paragraph"><p>You want to process a form via Ajax, sending the data in JSON format.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_26">Solution</h4>
<div class="paragraph"><p>Make use of Lift&#8217;s <span class="monospaced">jlift.js</span> Javascript and <span class="monospaced">JsonHandler</span> code.
Consider this HTML, which is not in a form, but includes <span class="monospaced">jlift.js</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;JsonForm&quot;</span> <span class="nt">&gt;</span>

 <span class="c">&lt;!--  required for JSON forms processing --&gt;</span>
 <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/classpath/jlift.js&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;tail&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>

 <span class="c">&lt;!--  placeholder script required to process the form --&gt;</span>
 <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;jsonFormScript&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;tail&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>

 <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;formToJson&quot;</span> <span class="na">name=</span><span class="s">&quot;formToJson&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;Royal Society&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;motto&quot;</span> <span class="na">value=</span><span class="s">&quot;Nullius in verba&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;sb&quot;</span> <span class="na">value=</span><span class="s">&quot;go!&quot;</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;result&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The server-side code to accept the input as JSON would be as follows:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util._</span>
<span class="k">import</span> <span class="nn">Helpers._</span>

<span class="k">import</span> <span class="nn">net.liftweb.http._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js._</span>
<span class="k">import</span> <span class="nn">JsCmds._</span>

<span class="k">import</span> <span class="nn">scala.xml._</span>

<span class="k">class</span> <span class="nc">JsonForm</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
     <span class="s">&quot;#formToJson&quot;</span> <span class="o">#&gt;</span> <span class="o">((</span><span class="n">ns</span><span class="k">:</span><span class="kt">NodeSeq</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">jsonForm</span><span class="o">(</span><span class="n">jsonHandler</span><span class="o">,</span> <span class="n">ns</span><span class="o">))</span> <span class="o">&amp;</span>
     <span class="s">&quot;#jsonFormScript&quot;</span> <span class="o">#&gt;</span> <span class="nc">Script</span><span class="o">(</span><span class="n">jsonHandler</span><span class="o">.</span><span class="n">jsCmd</span><span class="o">)</span>

    <span class="k">object</span> <span class="nc">jsonHandler</span> <span class="k">extends</span> <span class="nc">JsonHandler</span> <span class="o">{</span>

      <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">Any</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span> <span class="n">in</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">JsonCmd</span><span class="o">(</span><span class="s">&quot;processForm&quot;</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">params</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="k">_</span><span class="o">],</span> <span class="n">all</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">params</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;No Name&quot;</span><span class="o">)</span>
            <span class="k">val</span> <span class="n">motto</span> <span class="k">=</span> <span class="n">params</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;motto&quot;</span><span class="o">,</span> <span class="s">&quot;No Motto&quot;</span><span class="o">)</span>
            <span class="nc">SetHtml</span><span class="o">(</span><span class="s">&quot;result&quot;</span><span class="o">,</span>
                <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;The motto of %s is %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="n">motto</span><span class="o">))</span> <span class="o">)</span>

          <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
            <span class="nc">SetHtml</span><span class="o">(</span><span class="s">&quot;result&quot;</span><span class="o">,</span><span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Unknown command&quot;</span><span class="o">))</span>
      <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>If you click the go button and observe the network traffic, you&#8217;ll see
the following sent to the server:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;command&quot;</span><span class="o">:</span> <span class="s2">&quot;processForm&quot;</span><span class="p">,</span>
  <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Royal Society&quot;</span><span class="p">,</span><span class="s2">&quot;motto&quot;</span><span class="o">:</span><span class="s2">&quot;Nullius in verba&quot;</span><span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The server will send back JavaScript to update the <span class="monospaced">results</span> div with
"The motto of the Royal Society is Nullius in verba".</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_27">Discussion</h4>
<div class="paragraph"><p>The key components in the example are:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<span class="monospaced">jlift.js</span> script that makes various JSON functions available; and
</p>
</li>
<li>
<p>
generated JavaScript code (<span class="monospaced">jsonHandler.jsCmd</span>) that is included on
the page to perform the actual submission.
</p>
</li>
</ol></div>
<div class="paragraph"><p>In the binding, <span class="monospaced">SHtml.jsonForm</span> takes the <span class="monospaced">jsonHandler</span> object which
will process the form elements, and wraps your template, <span class="monospaced">ns</span>, with a
<span class="monospaced">&lt;form&gt;</span> tag. We also bind the JavasScript required to the
<span class="monospaced">jsonFormScript</span> placeholder.</p></div>
<div class="paragraph"><p>When the form is submitted, the <span class="monospaced">JsonHandler.apply</span> allows us to pattern
match on the input and extract the values we need from a <span class="monospaced">Map</span>. Note
that compiling this code will produce a warning as <span class="monospaced">Map[String,_]</span> will
be "unchecked since it is eliminated by erasure".</p></div>
<div class="paragraph"><p>If you are implementing a REST service to process JSON, consider using
Rest helpers in Lift to do that.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_26">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.javabeat.net/2011/05/using-json-forms-with-ajax-in-lift-framework/">Using
JSON forms with AJAX in Lift Framework</a>.
</p>
</li>
<li>
<p>
<em>Lift in Action</em>, section 9.1.4 "Using JSON forms with AJAX".
</p>
</li>
<li>
<p>
Example Lift application demonstrating
<a href="https://github.com/marekzebrowski/lift-basics">Simple form</a> processing.
</p>
</li>
<li>
<p>
Section 10.4, JSON, in
<a href="http://exploring.liftweb.net/master/index-10.html">Exploring Lift</a>.
</p>
</li>
<li>
<p>
<a href="http://en.wikipedia.org/wiki/Nullius_in_verba">Nullius in verba</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="DisableCheckbox">Conditionally Disable a Checkbox</h3>
<div class="sect3">
<h4 id="_problem_28">Problem</h4>
<div class="paragraph"><p>You want to add the <span class="monospaced">disabled</span> attribute to a <span class="monospaced">SHtml.checkbox</span> based on
a conditional check.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_27">Solution</h4>
<div class="paragraph"><p>Create a CSS selector transform to add the disabled attribute, and apply
it to your checkbox transform. For example, suppose you have a simple
checkbox:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Likes</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">likeTurtles</span> <span class="k">=</span> <span class="kc">false</span>
  <span class="k">def</span> <span class="n">checkbox</span> <span class="k">=</span> <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">checkbox</span><span class="o">(</span><span class="n">likeTurtles</span><span class="o">,</span> <span class="n">likeTurtles</span> <span class="k">=</span> <span class="k">_</span> <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Further suppose you want to disable it roughly 50% of the time:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">disabler</span> <span class="k">=</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">math</span><span class="o">.</span><span class="n">random</span> <span class="o">&gt;</span> <span class="mf">0.5d</span><span class="o">)</span> <span class="s">&quot;* [disabled]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;disabled&quot;</span>
 <span class="k">else</span> <span class="nc">PassThru</span>

<span class="k">def</span> <span class="n">conditionallyDisabledCheckbox</span> <span class="k">=</span>
  <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="n">disabler</span><span class="o">(</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">checkbox</span><span class="o">(</span><span class="n">likeTurtles</span><span class="o">,</span> <span class="n">likeTurtles</span> <span class="k">=</span> <span class="k">_</span> <span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Using <span class="monospaced">lift:Likes.conditionallyDisabledCheckbox</span> the checkbox would be
disabled half the time.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_28">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">disabler</span> method returns a <span class="monospaced">NodeSeq=&gt;NodeSeq</span> function, meaning
when we apply it in <span class="monospaced">conditionallyDisabledCheckbox</span> we need to give it a
<span class="monospaced">NodeSeq</span>, which is exactly what <span class="monospaced">SHtml.checkbox</span> provides.</p></div>
<div class="paragraph"><p>The <span class="monospaced">[disabled]</span> part of the CSS selector is selecting the disabled
attribute and replacing it with the value on the right of the <span class="monospaced">#&gt;</span>,
which is "disabled" in this example.</p></div>
<div class="paragraph"><p>What this combination means is that half the time the disabled attribute
will be set on the checkbox, and half the time the checkbox <span class="monospaced">NodeSeq</span>
will be left untouched because <span class="monospaced">PassThru</span> does not change the <span class="monospaced">NodeSeq</span>.</p></div>
<div class="paragraph"><p>The example above separates the test from the checkbox only to make it
easier to write this discussion section. You can of course in-line the
test, as is done in the mailing list post referenced below.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_27">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Mailing list question regarding
<a href="https://groups.google.com/d/topic/liftweb/KBVhkuM1NQQ/discussion">how to
conditionally mark a SHtml.checkbox as disabled</a>.
</p>
</li>
<li>
<p>
<em>Simply Lift</em> <a href="http://simply.liftweb.net/index-7.10.html">7.10 CSS
Selector Transforms</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="MultiSelectBox">Use a Select Box with Multiple Options</h3>
<div class="sect3">
<h4 id="_problem_29">Problem</h4>
<div class="paragraph"><p>You want to show the user a number of options in a select box, and allow
them to select multiple values.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_28">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">SHtml.multiSelect</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MySnippet</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">multi</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="k">class</span> <span class="nc">Item</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">inventory</span> <span class="k">=</span> <span class="nc">Item</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="s">&quot;Coffee&quot;</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Item</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">,</span> <span class="s">&quot;Milk&quot;</span><span class="o">)</span> <span class="o">::</span>
       <span class="nc">Item</span><span class="o">(</span><span class="s">&quot;c&quot;</span><span class="o">,</span> <span class="s">&quot;Sugar&quot;</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span>

     <span class="k">val</span> <span class="n">options</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">String</span>,<span class="kt">String</span><span class="o">)]</span> <span class="k">=</span>
       <span class="n">inventory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="n">id</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="o">))</span>

     <span class="k">val</span> <span class="n">default</span> <span class="k">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">id</span> <span class="o">::</span> <span class="nc">Nil</span>

     <span class="s">&quot;#opts *&quot;</span> <span class="o">#&gt;</span>
       <span class="nc">SHtml</span><span class="o">.</span><span class="n">multiSelect</span><span class="o">(</span><span class="n">options</span><span class="o">,</span> <span class="n">default</span><span class="o">,</span> <span class="n">xs</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Selected: &quot;</span><span class="o">+</span><span class="n">xs</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The corresponding template would be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;MySnippet.multi?form=post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p&gt;</span>What can I getcha?<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;opts&quot;</span><span class="nt">&gt;</span>options go here<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Submit&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>This will render as something like:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;&lt;div&gt;</span>
  <span class="nt">&lt;p&gt;</span>What can I getcha?<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;opts&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;select</span> <span class="na">name=</span><span class="s">&quot;F25749422319ALP1BW&quot;</span> <span class="na">multiple=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;a&quot;</span> <span class="na">selected=</span><span class="s">&quot;selected&quot;</span><span class="nt">&gt;</span>Coffee<span class="nt">&lt;/option&gt;</span>
     <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;b&quot;</span><span class="nt">&gt;</span>Milk<span class="nt">&lt;/option&gt;</span>
     <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;c&quot;</span><span class="nt">&gt;</span>Sugar<span class="nt">&lt;/option&gt;</span>
   <span class="nt">&lt;/select&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">value=</span><span class="s">&quot;Submit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_29">Discussion</h4>
<div class="paragraph"><p>Recall that an HTML select consists of a set of options, each of which
has a value and a name. To reflect this, the above examples takes our
<span class="monospaced">inventory</span> of objects and turns it into a list of (value,name) string
pairs, called <span class="monospaced">options</span>.</p></div>
<div class="paragraph"><p>The function given to <span class="monospaced">multiSelect</span> will receive the values (ids), not
the names, of the options. That is, if you ran the above code, and
selected "Coffee" and "Milk" the function would see <span class="monospaced">List("a", "b")</span>.</p></div>
<div class="sect4">
<h5 id="_selected_no_options">Selected No Options</h5>
<div class="paragraph"><p>Be aware if no options are selected at all, your handling function is
not called. This is described in ticket 1139. One way to work around
this to to add a hidden function to reset the list. For example, we
could modify the above code to be a stateful snippet and remember the
values we selected:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MySnippet</span> <span class="k">extends</span> <span class="nc">StatefulSnippet</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">dispatch</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;multi&quot;</span> <span class="k">=&gt;</span> <span class="n">multi</span>
  <span class="o">}</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Item</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">inventory</span> <span class="k">=</span> <span class="nc">Item</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="s">&quot;Coffee&quot;</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Item</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">,</span> <span class="s">&quot;Milk&quot;</span><span class="o">)</span> <span class="o">::</span>
    <span class="nc">Item</span><span class="o">(</span><span class="s">&quot;c&quot;</span><span class="o">,</span> <span class="s">&quot;Sugar&quot;</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span>

  <span class="k">val</span> <span class="n">options</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">String</span>,<span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="n">id</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="o">))</span>

  <span class="k">var</span> <span class="n">current</span> <span class="k">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">id</span> <span class="o">::</span> <span class="nc">Nil</span>

  <span class="k">def</span> <span class="n">multi</span> <span class="k">=</span> <span class="s">&quot;#opts *&quot;</span> <span class="o">#&gt;</span> <span class="o">(</span>
    <span class="nc">SHtml</span><span class="o">.</span><span class="n">hidden</span><span class="o">(</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">current</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">)</span> <span class="o">++</span>
    <span class="nc">SHtml</span><span class="o">.</span><span class="n">multiSelect</span><span class="o">(</span><span class="n">options</span><span class="o">,</span> <span class="n">current</span><span class="o">,</span> <span class="n">current</span> <span class="k">=</span> <span class="k">_</span><span class="o">)</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Each time the form is submited the <span class="monospaced">current</span> list of IDs is set to
whatever you have selected in the browser. But note that we have started
with a hidden function that resets <span class="monospaced">current</span> to the empty list, meaning
that if the receiving function in <span class="monospaced">multiSelect</span> is never called, that
would mean you have nothing selected. That may be useful, depending on
what behaviour you need in your application.</p></div>
</div>
<div class="sect4">
<h5 id="_type_safe_options">Type-safe Options</h5>
<div class="paragraph"><p>If you don&#8217;t want to work in terms of <span class="monospaced">String</span> values for an option, you
can use <span class="monospaced">multiSelectObj</span>. In this variation the list of options still
provides a text name, but the value is in terms of a class. Likewise,
the list of default values will be a list of class instances:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">options</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">Item</span>,<span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="o">))</span>
<span class="k">val</span> <span class="n">current</span> <span class="k">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">head</span> <span class="o">::</span> <span class="nc">Nil</span>
</pre></div></div></div>
<div class="paragraph"><p>The call to generate the multi-select from this data is similar, but
note that the function receives a list of <span class="monospaced">Item</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;#opts *&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">multiSelectObj</span><span class="o">(</span><span class="n">options</span><span class="o">,</span> <span class="n">current</span><span class="o">,</span>
  <span class="o">(</span><span class="n">xs</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Item</span><span class="o">])</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Got &quot;</span><span class="o">+</span><span class="n">xs</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect4">
<h5 id="_enumerations">Enumerations</h5>
<div class="paragraph"><p>You can use <span class="monospaced">multiSelectObj</span> with enumerations:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">Item</span> <span class="k">extends</span> <span class="nc">Enumeration</span> <span class="o">{</span>
  <span class="k">type</span> <span class="kt">Item</span> <span class="o">=</span> <span class="nc">Value</span>
  <span class="k">val</span> <span class="nc">Coffee</span><span class="o">,</span> <span class="nc">Milk</span><span class="o">,</span> <span class="nc">Sugar</span> <span class="k">=</span> <span class="nc">Value</span>
<span class="o">}</span>

<span class="k">import</span> <span class="nn">Item._</span>

<span class="k">val</span> <span class="n">options</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">Item</span>,<span class="kt">String</span><span class="o">)]</span> <span class="k">=</span>
  <span class="nc">Item</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">toList</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">.</span><span class="n">toString</span><span class="o">))</span>

<span class="k">var</span> <span class="n">current</span> <span class="k">=</span> <span class="nc">Item</span><span class="o">.</span><span class="nc">Coffee</span> <span class="o">::</span> <span class="nc">Nil</span>

<span class="k">def</span> <span class="n">multi</span> <span class="k">=</span> <span class="s">&quot;#opts *&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">multiSelectObj</span><span class="o">[</span><span class="kt">Item</span><span class="o">](</span><span class="n">options</span><span class="o">,</span> <span class="n">current</span><span class="o">,</span>
  <span class="n">xs</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Got &quot;</span><span class="o">+</span><span class="n">xs</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_28">See Also</h4>
<div class="paragraph"><p><a href="#SelectOptionChange">[SelectOptionChange]</a> describes how to trigger a server-side action when a selection changes in the browser.</p></div>
<div class="paragraph"><p><em>Exploring Lift</em>, Chapter 6, "Forms in Lift", <a href="http://exploring.liftweb.net/">http://exploring.liftweb.net/</a>.</p></div>
<div class="paragraph"><p>Ticket relating to no options being selected: <a href="https://github.com/lift/framework/issues/1139">https://github.com/lift/framework/issues/1139</a></p></div>
</div>
</div>
<div class="sect2">
<h3 id="FileUpload">File Upload</h3>
<div class="sect3">
<h4 id="_problem_30">Problem</h4>
<div class="paragraph"><p>You want a snippet to allow users to upload a file to your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_29">Solution</h4>
<div class="paragraph"><p>Use a <span class="monospaced">FileParamHolder</span> in your snippet, and extract file information from it when the form is submitted.</p></div>
<div class="paragraph"><p>Starting with a form which is marked as "multipart=true":</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>File Upload<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;jquery&quot;</span> <span class="na">src=</span><span class="s">&quot;/classpath/jquery.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;json&quot;</span> <span class="na">src=</span><span class="s">&quot;/classpath/json.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;form</span> <span class="na">data-lift=</span><span class="s">&quot;FileUploadSnippet?form=post;multipart=true&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;file&quot;</span><span class="nt">&gt;</span>
     Select a file: <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;file&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
   <span class="nt">&lt;/label&gt;</span>
   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Submit&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>We can bind the form in a snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.FileParamHolder</span>
<span class="k">import</span> <span class="nn">net.liftweb.common.</span><span class="o">{</span><span class="nc">Loggable</span><span class="o">,</span> <span class="nc">Full</span><span class="o">,</span> <span class="nc">Empty</span><span class="o">,</span> <span class="nc">Box</span><span class="o">}</span>


<span class="k">class</span> <span class="nc">FileUploadSnippet</span> <span class="k">extends</span> <span class="nc">Loggable</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>

    <span class="k">var</span> <span class="n">upload</span> <span class="k">:</span> <span class="kt">Box</span><span class="o">[</span><span class="kt">FileParamHolder</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Empty</span>

    <span class="k">def</span> <span class="n">processForm</span><span class="o">()</span> <span class="k">=</span> <span class="n">upload</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="nc">FileParamHolder</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">mimeType</span><span class="o">,</span> <span class="n">fileName</span><span class="o">,</span> <span class="n">file</span><span class="o">))</span> <span class="k">=&gt;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;%s of type %s is %d bytes long&quot;</span> <span class="n">format</span> <span class="o">(</span><span class="n">fileName</span><span class="o">,</span> <span class="n">mimeType</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="n">length</span><span class="o">))</span>

      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="o">(</span><span class="s">&quot;No file?&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="s">&quot;#file&quot;</span> <span class="o">#&gt;</span> <span class="n">fileUpload</span><span class="o">(</span><span class="n">f</span> <span class="k">=&gt;</span> <span class="n">upload</span> <span class="k">=</span> <span class="nc">Full</span><span class="o">(</span><span class="n">f</span><span class="o">))</span> <span class="o">&amp;</span>
      <span class="s">&quot;type=submit&quot;</span> <span class="o">#&gt;</span> <span class="n">onSubmitUnit</span><span class="o">(</span><span class="n">processForm</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This allows you to access the <span class="monospaced">Array[Byte]</span> of the file in the <span class="monospaced">processForm</span> method when the form is submitted.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_30">Discussion</h4>
<div class="paragraph"><p>HTTP includes an encoding type of "multipart/form-data" which was introduced to support binary data uploads.  The <span class="monospaced">?form=post;multipart=true</span> parameters in the template mark the form with this encoding, and the HTML generated will look
like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;/fileupload&quot;</span><span class="nt">&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>When the browser submits the form, Lift detects the "multipart/form-data" encoding and extracts any files from the request.  These are available as <span class="monospaced">uploadedFiles</span> on a <span class="monospaced">Req</span> object, for example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">files</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">FileParamHolder</span><span class="o">]</span> <span class="k">=</span> <span class="n">S</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">uploadedFiles</span><span class="o">)</span> <span class="n">openOr</span> <span class="nc">Nil</span>
</pre></div></div></div>
<div class="paragraph"><p>However, as we&#8217;re dealing with a form with a single upload field it&#8217;s easier to use <span class="monospaced">SHtml.fileUpload</span> to bind the input to our <span class="monospaced">upload</span> variable.  Lift arranges for the function <span class="monospaced">f =&gt; upload = Full(f)</span> to be called when a file is selected and uploaded via this field. If the file is zero length, the function is not called.</p></div>
<div class="paragraph"><p>The default behaviour for Lift is to read the file into memory and present it as a <span class="monospaced">FileParamHolder</span>.  In this recipe we&#8217;re pattern matching on the fields of the <span class="monospaced">FileParamHolder</span> and simply printing out what we know about the file.  We&#8217;re ignoring the first parameter which will be Lift&#8217;s generated name for the field, but capturing the mime type, original filename and the raw data that was in the file.</p></div>
<div class="paragraph"><p>You probably don&#8217;t want to use this method for very large files.  In fact, <span class="monospaced">LiftRules</span> provides a number of size restrictions which you can control:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">LiftRules.maxMimeFileSize</span>&#8201;&#8212;&#8201;the maximum size of any single file uploaded (7MB by default).
</p>
</li>
<li>
<p>
<span class="monospaced">LiftRules.maxMimeSize</span>&#8201;&#8212;&#8201;the maximum size of the multi-part upload in total (8MB by default)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Why two settings?  Because when the form is submitted, there may be a number of fields on the form.  For example, in the recipe the value of the submit button is send as one of the parts, and the file is sent as another. Hence, you might want to limit file size, but allow for some field values, or multiple files, to be submitted.</p></div>
<div class="paragraph"><p>If you hit the size limit an exception will be thrown from the underlying file upload library. You can catch the exception, as described in <a href="#CatchException">[CatchException]</a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">exceptionHandler</span><span class="o">.</span><span class="n">prepend</span> <span class="o">{</span>
  <span class="k">case</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="n">x</span> <span class="k">:</span> <span class="kt">FileUploadIOException</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">ResponseWithReason</span><span class="o">(</span><span class="nc">BadResponse</span><span class="o">(),</span> <span class="s">&quot;Unable to process file. Too large?&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Be aware that the container (Jetty, Tomcat) or any web server (Apache, NGINX) may also have limits on file upload sizes.</p></div>
<div class="paragraph" id="UploadToDisk"><p>Uploading a file into memory may be fine for some situations, but you may want to upload larger items to disk and then processes them in Lift as a stream.  Lift supports this via the following setting:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">handleMimeFile</span> <span class="k">=</span> <span class="nc">OnDiskFileParamHolder</span><span class="o">.</span><span class="n">apply</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">handleMimeFile</span> variable expects to be given a function that takes a field name, mime type, filename and <span class="monospaced">InputStream</span> and returns a <span class="monospaced">FileParamHolder</span>.  The default implementation of this is the <span class="monospaced">InMemFileParamHolder</span>, but changing to <span class="monospaced">OnDiskFileParamHolder</span> means Lift will write the file to disk first. You can of course implement your own handler in addition to using <span class="monospaced">OnDiskFileParamHolder</span> or <span class="monospaced">InMemFileParamHolder</span>.</p></div>
<div class="paragraph"><p>With <span class="monospaced">OnDiskFileParamHolder</span>, the file will be written to a temporary location (<span class="monospaced">System.getProperty("java.io.tmpdir")</span>) but it&#8217;s up to you to remove it when you&#8217;re done with the file. For example, our snippet could change to:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">processForm</span><span class="o">()</span> <span class="k">=</span> <span class="n">upload</span> <span class="k">match</span> <span class="o">{</span>

  <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="n">content</span> <span class="k">:</span> <span class="kt">OnDiskFileParamHolder</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;File: &quot;</span><span class="o">+</span><span class="n">content</span><span class="o">.</span><span class="n">localFile</span><span class="o">.</span><span class="n">getAbsolutePath</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">in</span><span class="k">:</span> <span class="kt">InputStream</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">fileStream</span>
    <span class="c1">// ...do something with the stream here...</span>
    <span class="k">val</span> <span class="n">wasDeleted_?</span> <span class="k">=</span> <span class="n">content</span><span class="o">.</span><span class="n">localFile</span><span class="o">.</span><span class="n">delete</span><span class="o">()</span>

  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="o">(</span><span class="s">&quot;No file?&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Be aware that <span class="monospaced">OnDiskFileParamHolder</span> implements <span class="monospaced">FileParamHolder</span> so would  match the original <span class="monospaced">FileParamHolder</span> pattern used in the recipe. However, if you access the <span class="monospaced">file</span> field of <span class="monospaced">OnDiskFileParamHolder</span>, you&#8217;ll bring the file into memory, which would defeat the point of storing it on disk to process it as a stream.</p></div>
<div class="paragraph"><p>If you want to monitor the progress of the upload on the server side, you can. There&#8217;s a hook in <span class="monospaced">LiftRules</span> which called as the upload is running:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">progressPrinter</span><span class="o">(</span><span class="n">bytesRead</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">contentLength</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">fieldIndex</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&quot;Read %d of %d for %d&quot;</span> <span class="n">format</span> <span class="o">(</span><span class="n">bytesRead</span><span class="o">,</span> <span class="n">contentLength</span><span class="o">,</span> <span class="n">fieldIndex</span><span class="o">))</span>
<span class="o">}</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">progressListener</span> <span class="k">=</span> <span class="n">progressPrinter</span>
</pre></div></div></div>
<div class="paragraph"><p>This is the progress of the whole multi-part upload, not just the file being uploaded.  In particular, the <span class="monospaced">contentLength</span> may not be known (in which case it will be <span class="monospaced">-1</span>), but if it is known it is the size of the complete multi-part upload. In the example in this recipe that would include the size of the file, but also the submit button value.  This also explains the <span class="monospaced">fieldIndex</span>, which is a counter as to which part is being processed. It will take on the values of 0 and 1 for the two parts in this example.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_29">See Also</h4>
<div class="paragraph"><p>The HTTP file upload mechanics are described in RFC 1867, <em>Form-based File Upload in HTML</em>:
<a href="http://tools.ietf.org/html/rfc1867">http://tools.ietf.org/html/rfc1867</a></p></div>
<div class="paragraph"><p><a href="#RestBinaryData">[RestBinaryData]</a> discusses file upload in the context of a REST service.</p></div>
<div class="paragraph"><p>See <a href="#AjaxFileUpload">[AjaxFileUpload]</a> for an example of an Ajax file upload through integration with a JavaScript library, providing progress indicators and drag-and-drop support.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="REST">REST</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter looks at recipes around REST web services, via Lift&#8217;s <span class="monospaced">RestHelper</span> trait. For an introduction, take a look at the Lift wiki page at <a href="https://www.assembla.com/spaces/liftweb/wiki/REST_Web_Services">https://www.assembla.com/spaces/liftweb/wiki/REST_Web_Services</a> and chapter 5 of <em>Simply Lift</em> at <a href="http://simply.liftweb.net">http://simply.liftweb.net</a>.</p></div>
<div class="paragraph"><p>The sample code from this chapter is at: <a href="https://github.com/LiftCookbook/cookbook_rest">https://github.com/LiftCookbook/cookbook_rest</a>.</p></div>
<div class="sect2">
<h3 id="DRYURLs">DRY URLs</h3>
<div class="sect3">
<h4 id="_problem_31">Problem</h4>
<div class="paragraph"><p>You found yourself repeating parts of URL paths in your <span class="monospaced">RestHelper</span>, and
you Don&#8217;t want to Repeat Yourself.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_30">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">prefix</span> in your <span class="monospaced">RestHelper</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>

<span class="k">object</span> <span class="nc">IssuesService</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">IssuesService</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">serve</span><span class="o">(</span><span class="s">&quot;issues&quot;</span> <span class="o">/</span> <span class="s">&quot;by-state&quot;</span> <span class="n">prefix</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;open&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">XmlGet</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">None</span> <span class="n">open</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
    <span class="k">case</span> <span class="s">&quot;closed&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">XmlGet</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">None</span> <span class="n">closed</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
    <span class="k">case</span> <span class="s">&quot;closed&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">XmlDelete</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">All</span> <span class="n">deleted</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
  <span class="o">})</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This service responds to URLs of <em>/issues/by-state/open</em> and <em>/issues/by-state/closed</em> and we have
factored out the common part as a <span class="monospaced">prefix</span>.</p></div>
<div class="paragraph"><p>Wire this into <span class="monospaced">Boot.scala</span> with:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">code.rest.IssuesService</span>
<span class="nc">IssuesService</span><span class="o">.</span><span class="n">init</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>We can test the service with cURL:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl -H 'Content-Type: application/xml'
    http://localhost:8080/issues/by-state/open
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;p&gt;None open&lt;/p&gt;

$ curl -X DELETE -H 'Content-Type: application/xml'
    http://localhost:8080/issues/by-state/closed
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;p&gt;All deleted&lt;/p&gt;</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_31">Discussion</h4>
<div class="paragraph"><p>You can have many <span class="monospaced">serve</span> blocks in your <span class="monospaced">RestHelper</span>, which helps give
your REST service structure.</p></div>
<div class="paragraph"><p>In this example we&#8217;ve arbitrarily decided to return XML and to match on an XML request using <span class="monospaced">XmlGet</span> and <span class="monospaced">XmlDelete</span>.  The test for an XML request requires a content-type of <em>text/xml</em> or <em>application/xml</em>, a request for a path that ends with <span class="monospaced">.xml</span>.   This is why the cURL request includes a header with with the <span class="monospaced">-H</span> flag.  If we hadn&#8217;t included that, the request would not match any of our patterns, and the result would be a 404 response.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_30">See Also</h4>
<div class="paragraph"><p><a href="#JSONREST">[JSONREST]</a> gives an example of accepting and returning JSON.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MissingSuffix">Missing File Suffix</h3>
<div class="sect3">
<h4 id="_problem_32">Problem</h4>
<div class="paragraph"><p>Your <span class="monospaced">RestHelper</span> expects a filename as part of the URL, but the suffix
(extension) is missing, and you need it.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_31">Solution</h4>
<div class="paragraph"><p>Access <span class="monospaced">req.path.suffix</span> to recover the suffix.</p></div>
<div class="paragraph"><p>For example, when
processing <span class="monospaced">/download/123.png</span> you want to be able reconstruct
<span class="monospaced">123.png</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">object</span> <span class="nc">Reunite</span> <span class="k">extends</span> <span class="nc">RestHelper</span>  <span class="o">{</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">reunite</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">suffix</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">suffix</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="n">name</span> <span class="k">else</span> <span class="n">name</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">suffix</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;download&quot;</span> <span class="o">::</span> <span class="n">file</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;You requested &quot;</span><span class="o">+</span><span class="n">reunite</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Reunite</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We we are matching on <span class="monospaced">download</span> but rather than using the <span class="monospaced">file</span> value directly, we pass it through the <span class="monospaced">reunite</span> function first to attach the suffix back on (if any).</p></div>
<div class="paragraph"><p>Requesting this URL with a command like cURL will show you the filename
as expected:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://127.0.0.1:8080/download/123.png
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
You requested 123.png</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_32">Discussion</h4>
<div class="paragraph"><p>When Lift parses a request it splits the request into constituent parts
(e.g., turning the path into a <span class="monospaced">List[String]</span>). This includes a
separation of <em>some</em> suffixes. This is good for pattern matching when you
want to change behaviour based on the suffix, but a hindrance in this
particular situation.</p></div>
<div class="paragraph"><p>Only those suffixes defined in <span class="monospaced">LiftRules.explicitlyParsedSuffixes</span> are
split from the filename. This includes many of the common file suffixes
(such as "png", "atom", "json") and also some you may not be so familiar
with, such as "com".</p></div>
<div class="paragraph"><p>Note that if the suffix is not in <span class="monospaced">explicitlyParsedSuffixes</span>, the suffix
will be an empty String and the <span class="monospaced">name</span> (in the above example) will be
the file name with the suffix still attached.</p></div>
<div class="paragraph"><p>Depending on your needs, you could alternatively add a guard condition to check for the file suffix:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="s">&quot;download&quot;</span> <span class="o">::</span> <span class="n">file</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s">&quot;png&quot;</span> <span class="k">=&gt;</span>
  <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;You requested PNG file called &quot;</span><span class="o">+</span><span class="n">file</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Or rather than simply attaching the suffix back on, you could take the opportunity to negotiate the format to send back to the client. For example, if the client supports the WebP image format, you might prefer to send that:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">object</span> <span class="nc">Reunite</span> <span class="k">extends</span> <span class="nc">RestHelper</span>  <span class="o">{</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Reunite</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;negotiate&quot;</span> <span class="o">::</span> <span class="n">file</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">toSend</span> <span class="k">=</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">header</span><span class="o">(</span><span class="s">&quot;Accept&quot;</span><span class="o">).</span><span class="n">exists</span><span class="o">(</span><span class="k">_</span> <span class="o">==</span> <span class="s">&quot;image/webp&quot;</span><span class="o">))</span> <span class="n">file</span><span class="o">+</span><span class="s">&quot;.webp&quot;</span>
        <span class="k">else</span> <span class="n">file</span><span class="o">+</span><span class="s">&quot;.png&quot;</span>

      <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;You requested &quot;</span><span class="o">+</span><span class="n">file</span><span class="o">+</span><span class="s">&quot;, would send &quot;</span><span class="o">+</span><span class="n">toSend</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Calling this service would check the HTTP Accept header before deciding what resource to send:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://localhost:8080/negotiate/123
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
You requested 123, would send 123.png

$ curl http://localhost:8080/negotiate/123 -H "Accept: image/webp"
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
You requested 123, would send 123.webp</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_31">See Also</h4>
<div class="paragraph"><p><a href="#MissingDotCom">[MissingDotCom]</a> shows how to remove items from <span class="monospaced">explicitlyParsedSuffixes</span>.</p></div>
<div class="paragraph"><p>The source for <span class="monospaced">HttpHelpers.scala</span> contains the <span class="monospaced">explicitlyParsedSuffixes</span> list, which is the default list of suffixes that Lift parses from a URL:  <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/HttpHelpers.scala">https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/HttpHelpers.scala
</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MissingDotCom">Missing .com from Email Addresses</h3>
<div class="paragraph"><p>When submitting an email address to a REST service, a domain ending ".com" is stripped before your REST service can handle the request.</p></div>
<div class="sect3">
<h4 id="_solution_32">Solution</h4>
<div class="paragraph"><p>Modify <span class="monospaced">LiftRules.explicitlyParsedSuffixes</span> so that Lift doesn&#8217;t change URLs that end with ".com".</p></div>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.Helpers</span>
<span class="nc">LiftRules</span><span class="o">.</span><span class="n">explicitlyParsedSuffixes</span> <span class="k">=</span> <span class="nc">Helpers</span><span class="o">.</span><span class="n">knownSuffixes</span> <span class="o">&amp;~</span> <span class="o">(</span><span class="nc">Set</span><span class="o">(</span><span class="s">&quot;com&quot;</span><span class="o">))</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_33">Discussion</h4>
<div class="paragraph"><p>By default Lift will strip off file suffixes from URLs to make it easy to match on suffixes. An example would be needing to match on all requests ending in ".xml" or ".pdf".  However, ".com" is registered as one of those suffixes, but is inconvenient if you have URLs that end with email addresses.</p></div>
<div class="paragraph"><p>Note that this doesn&#8217;t impact email addresses in the middle of URLs.  For example, consider the following REST service:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">object</span> <span class="nc">Suffix</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Suffix</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;email&quot;</span> <span class="o">::</span> <span class="n">e</span> <span class="o">::</span> <span class="s">&quot;send&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;In middle: &quot;</span><span class="o">+</span><span class="n">e</span><span class="o">)</span>

    <span class="k">case</span> <span class="s">&quot;email&quot;</span> <span class="o">::</span> <span class="n">e</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;At end: &quot;</span><span class="o">+</span><span class="n">e</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>With this service <span class="monospaced">init</span> method called in <span class="monospaced">Boot.scala</span> we could then make requests and observe the issue:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://localhost:8080/email/you@example.com/send
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
In middle: you@example.com

$ curl http://localhost:8080/email/you@example.com
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
At end: you@example</pre>
</div></div>
<div class="paragraph"><p>The ".com" is being treated as a file suffix, which is why the solution of removing it from the list of suffixes will resolve this problem.</p></div>
<div class="paragraph"><p>Note that because other top-level domains, such as ".uk", ".nl", ".gov", are not in <span class="monospaced">explicitlyParsedSuffixes</span>, those email addresses are left untouched.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_32">See Also</h4>
<div class="paragraph"><p><a href="#MissingSuffix">[MissingSuffix]</a> describes the suffix processing in more detail.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SuffixMatchFail">Failing to Match on a File Suffix</h3>
<div class="sect3">
<h4 id="_problem_33">Problem</h4>
<div class="paragraph"><p>You&#8217;re trying to match on a file suffix (extension), but your match is
failing.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_33">Solution</h4>
<div class="paragraph"><p>Ensure the suffix you&#8217;re matching on is included in
<span class="monospaced">LiftRules.explicitlyParsedSuffixes</span>.</p></div>
<div class="paragraph"><p>As an example, perhaps you want to match anything ending in <span class="monospaced">.csv</span> at
your <span class="monospaced">/reports/</span> URL:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;reports&quot;</span> <span class="o">::</span> <span class="n">name</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="s">&quot;csv&quot;</span><span class="o">,</span> <span class="nc">GetRequest</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Here&#39;s your CSV report for &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>You&#8217;re expecting <span class="monospaced">/reports/foo.csv</span> to produce "Here&#8217;s your CSV report
for foo", but you get a 404.</p></div>
<div class="paragraph"><p>To resolve this, include "csv" as a file suffix that Lift knows to split from URLs.  In <span class="monospaced">Boot.scala</span> call:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">explicitlyParsedSuffixes</span> <span class="o">+=</span> <span class="s">&quot;csv&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>The pattern will now match.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_34">Discussion</h4>
<div class="paragraph"><p>Without adding ".csv" to the <span class="monospaced">explicitlyParsedSuffixes</span>, the example URL
would match with:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;reports&quot;</span> <span class="o">::</span> <span class="n">name</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="nc">GetRequest</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="nc">Text</span><span class="o">(</span><span class="s">&quot;Here&#39;s your CSV report for &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Here we&#8217;re matching on no suffix (<span class="monospaced">""</span>). In this case <span class="monospaced">name</span> would be set to "foo.csv".  This is because Lift separates file suffixes from the end of URLs only for file suffixes that are registered with <span class="monospaced">explicitlyParsedSuffixes</span>.  Because <span class="monospaced">csv</span> is not one of the default registered suffixes, "foo.csv" is not split. That&#8217;s why <span class="monospaced">csv</span> in the suffix position of <span class="monospaced">Req</span> pattern match won&#8217;t match the request, but an empty string in that position will.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_33">See Also</h4>
<div class="paragraph"><p><a href="#MissingSuffix">[MissingSuffix]</a> explains more about the suffix removal in Lift.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RestBinaryData">Accept binary data in a REST service</h3>
<div class="sect3">
<h4 id="_problem_34">Problem</h4>
<div class="paragraph"><p>You want to accept an image upload, or other binary data, in your RESTful
service.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_34">Solution</h4>
<div class="paragraph"><p>Access the request body in your REST helper:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>

<span class="k">object</span> <span class="nc">Upload</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Upload</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;upload&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Post</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span>
        <span class="n">bodyBytes</span> <span class="k">&lt;-</span> <span class="n">req</span><span class="o">.</span><span class="n">body</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="o">&lt;</span><span class="n">info</span><span class="o">&gt;</span><span class="nc">Received</span> <span class="o">{</span><span class="n">bodyBytes</span><span class="o">.</span><span class="n">length</span><span class="o">}</span> <span class="n">bytes</span><span class="o">&lt;/</span><span class="n">info</span><span class="o">&gt;</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Wire this into your application in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">code.rest.Upload</span>
<span class="nc">Upload</span><span class="o">.</span><span class="n">init</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>Test this service using a tool like cURL:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl -X POST --data-binary "@dog.jpg" -H 'Content-Type: image/jpg'
    http://127.0.0.1:8080/upload
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;info&gt;Received 1365418 bytes&lt;/info&gt;</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_35">Discussion</h4>
<div class="paragraph"><p>In the above example the binary data is accessed via the <span class="monospaced">req.body</span>, which returns
 a <span class="monospaced">Box[Array[Byte]]</span>.  We turn this into a <span class="monospaced">Box[Elem]</span> to send back to the client.
 Implicits in <span class="monospaced">RestHelper</span> turn this into an <span class="monospaced">XmlResponse</span> for Lift to handle.</p></div>
<div class="paragraph"><p>Note that web containers, such as Jetty and Tomcat, may place limits on
the size of an upload. You will recognise this situation by an error
such as "java.lang.IllegalStateException: Form too large705784&gt;200000".
Check with documentation for the container for changing these limits.</p></div>
<div class="paragraph"><p>To restrict the type of image you accept, you could add a guard-condition on the match, but you may find you have more readable code by moving the logic into an <span class="monospaced">unapply</span> method on an object.  For example, to restrict an upload to just a JPEG you could say:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">serve</span> <span class="o">{</span>
  <span class="k">case</span> <span class="s">&quot;jpg&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Post</span> <span class="nc">JPeg</span><span class="o">(</span><span class="n">req</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">bodyBytes</span> <span class="k">&lt;-</span> <span class="n">req</span><span class="o">.</span><span class="n">body</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="o">&lt;</span><span class="n">info</span><span class="o">&gt;</span><span class="nc">Jpeg</span> <span class="nc">Received</span> <span class="o">{</span><span class="n">bodyBytes</span><span class="o">.</span><span class="n">length</span><span class="o">}</span> <span class="n">bytes</span><span class="o">&lt;/</span><span class="n">info</span><span class="o">&gt;</span>
  <span class="o">}</span>

<span class="k">object</span> <span class="nc">JPeg</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">Req</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Req</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">req</span><span class="o">.</span><span class="n">contentType</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span> <span class="o">==</span> <span class="s">&quot;image/jpg&quot;</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">req</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We have defined an extractor called <span class="monospaced">JPeg</span> which returns <span class="monospaced">Some[Req]</span> if the content type of the upload is "image/jpg"; otherwise the result will be <span class="monospaced">None</span>.  This is used in the REST pattern match as <span class="monospaced">JPeg(req)</span>.  Note that the <span class="monospaced">unapply</span> needs to return <span class="monospaced">Option[Req]</span> as this is what&#8217;s expected by the <span class="monospaced">Post</span> extractor.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_34">See Also</h4>
<div class="paragraph"><p>Odersky <em>et al.</em>, (2008), <em>Programming in Scala</em>, chapter 24, discusses extractors in detail: <a href="http://www.artima.com/pins1ed/extractors.html">http://www.artima.com/pins1ed/extractors.html</a>.</p></div>
<div class="paragraph"><p><a href="#FileUpload">[FileUpload]</a> describes form-based (multi-part) file uploads</p></div>
</div>
</div>
<div class="sect2">
<h3 id="JSONREST">Returning JSON</h3>
<div class="sect3">
<h4 id="_problem_35">Problem</h4>
<div class="paragraph"><p>You want to return JSON from a REST call.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_35">Solution</h4>
<div class="paragraph"><p>Use the Lift JSON domain specific language (DSL). For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.LiftRules</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.JsonAST._</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.JsonDSL._</span>

<span class="k">object</span> <span class="nc">QuotationsAPI</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">QuotationsAPI</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;quotation&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">JsonGet</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="o">(</span><span class="s">&quot;text&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;A beach house isn&#39;t just real estate. It&#39;s a state of mind.&quot;</span><span class="o">)</span> <span class="o">~</span>
        <span class="o">(</span><span class="s">&quot;by&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;Douglas Adams&quot;</span><span class="o">)</span> <span class="k">:</span> <span class="kt">JValue</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Wire this into <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">code.rest.QuotationsAPI</span>
<span class="nc">QuotationsAPI</span><span class="o">.</span><span class="n">init</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>Running this example produces:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl -H 'Content-type: text/json' http://127.0.0.1:8080/quotation
{
  "text":"A beach house isn't just real estate. It's a state of mind.",
  "by":"Douglas Adams"
}</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_36">Discussion</h4>
<div class="paragraph"><p>The <em>type ascription</em> at the end of the JSON expression (<span class="monospaced">: JValue</span>)
tells the compiler that the expression is expected to be of type
<span class="monospaced">JValue</span>. This is required to allow the DSL to apply. If would not be
required if, for example, you were calling a function that was defined
to return a <span class="monospaced">JValue</span>.</p></div>
<div class="paragraph"><p>The JSON DSL allows you to created nested structures, lists and
everything else you expect of JSON.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_35">See Also</h4>
<div class="paragraph"><p>The README file for the lift-json project is a great source of examples for using the JSON DSL: <a href="https://github.com/lift/framework/tree/master/core/json">https://github.com/lift/framework/tree/master/core/json</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="GoogleSitemap">Google Sitemap</h3>
<div class="sect3">
<h4 id="_problem_36">Problem</h4>
<div class="paragraph"><p>You want to make a Google Sitemap using Lift&#8217;s rendering capabilities.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_36">Solution</h4>
<div class="paragraph"><p>Create the sitemap structure, and bind to it as you would for any template in Lift.</p></div>
<div class="paragraph"><p>Start with a <span class="monospaced">sitemap.html</span> in your <span class="monospaced">webapp</span> folder containing valid XML-Sitemap markup:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span>
<span class="nt">&lt;urlset</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;url</span> <span class="na">data-lift=</span><span class="s">&quot;SitemapContent.base&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;loc&gt;&lt;/loc&gt;</span>
        <span class="nt">&lt;changefreq&gt;</span>daily<span class="nt">&lt;/changefreq&gt;</span>
        <span class="nt">&lt;priority&gt;</span>1.0<span class="nt">&lt;/priority&gt;</span>
        <span class="nt">&lt;lastmod&gt;&lt;/lastmod&gt;</span>
    <span class="nt">&lt;/url&gt;</span>
    <span class="nt">&lt;url</span> <span class="na">data-lift=</span><span class="s">&quot;SitemapContent.list&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;loc&gt;&lt;/loc&gt;</span>
        <span class="nt">&lt;lastmod&gt;&lt;/lastmod&gt;</span>
    <span class="nt">&lt;/url&gt;</span>
<span class="nt">&lt;/urlset&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Make a snippet to fill the required gaps:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">org.joda.time.DateTime</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.CssSel</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.S</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="k">class</span> <span class="nc">SitemapContent</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Post</span><span class="o">(</span><span class="n">url</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span>

  <span class="k">lazy</span> <span class="k">val</span> <span class="n">entries</span> <span class="k">=</span>
    <span class="nc">Post</span><span class="o">(</span><span class="s">&quot;/welcome&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DateTime</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Post</span><span class="o">(</span><span class="s">&quot;/about&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DateTime</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span>

  <span class="k">val</span> <span class="n">siteLastUdated</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DateTime</span>

  <span class="k">def</span> <span class="n">base</span><span class="k">:</span> <span class="kt">CssSel</span> <span class="o">=</span>
    <span class="s">&quot;loc *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;http://%s/&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">S</span><span class="o">.</span><span class="n">hostName</span><span class="o">)</span> <span class="o">&amp;</span>
      <span class="s">&quot;lastmod *&quot;</span> <span class="o">#&gt;</span> <span class="n">siteLastUdated</span><span class="o">.</span><span class="n">toString</span><span class="o">(</span><span class="s">&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZZ&quot;</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">list</span><span class="k">:</span> <span class="kt">CssSel</span> <span class="o">=</span>
    <span class="s">&quot;url *&quot;</span> <span class="o">#&gt;</span> <span class="n">entries</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">post</span> <span class="k">=&gt;</span>
      <span class="s">&quot;loc *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;http://%s%s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">S</span><span class="o">.</span><span class="n">hostName</span><span class="o">,</span> <span class="n">post</span><span class="o">.</span><span class="n">url</span><span class="o">)</span> <span class="o">&amp;</span>
        <span class="s">&quot;lastmod *&quot;</span> <span class="o">#&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">toString</span><span class="o">(</span><span class="s">&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZZ&quot;</span><span class="o">))</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This example is using canned data for two pages.</p></div>
<div class="paragraph"><p>Apply the template and snippet in a REST service at <span class="monospaced">/sitemap</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>

<span class="k">object</span> <span class="nc">Sitemap</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>
  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;sitemap&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="nc">GetRequest</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="nc">XmlResponse</span><span class="o">(</span>
        <span class="n">S</span><span class="o">.</span><span class="n">render</span><span class="o">(&lt;</span><span class="n">lift</span><span class="k">:</span><span class="kt">embed</span> <span class="kt">what</span><span class="o">=</span><span class="s">&quot;sitemap&quot;</span> <span class="o">/&gt;,</span>
        <span class="n">S</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">request</span><span class="o">).</span><span class="n">head</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Wire this into your application in <span class="monospaced">Boot.scala</span>, for example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="nc">Sitemap</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Test this service using a tool like cURL:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>curl http://127.0.0.1:8080/sitemap

&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>?&gt;
&lt;urlset <span class="nv">xmlns</span><span class="o">=</span><span class="s2">&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span>&gt;
    &lt;url&gt;
        &lt;loc&gt;http://127.0.0.1/&lt;/loc&gt;
        &lt;changefreq&gt;daily&lt;/changefreq&gt;
        &lt;priority&gt;1.0&lt;/priority&gt;
        &lt;lastmod&gt;2013-02-10T19:16:12.433+00:00&lt;/lastmod&gt;
    &lt;/url&gt;
    &lt;url&gt;
        &lt;loc&gt;http://127.0.0.1/welcome&lt;/loc&gt;
        &lt;lastmod&gt;2013-02-10T19:16:12.434+00:00&lt;/lastmod&gt;
    &lt;/url&gt;&lt;url&gt;
        &lt;loc&gt;http://127.0.0.1/about&lt;/loc&gt;
        &lt;lastmod&gt;2013-02-10T19:16:12.434+00:00&lt;/lastmod&gt;
    &lt;/url&gt;
&lt;/urlset&gt;
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_37">Discussion</h4>
<div class="paragraph"><p>You may be wondering why we&#8217;ve used REST here, when we could have used a regular HTML template and snippet. The reason is that we want XML rather than HTML output.  We use the same mechanism, but invoke it and wrap it in an <span class="monospaced">XmlResponse</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">S.render</span> method takes a <span class="monospaced">NodeSeq</span> and a <span class="monospaced">HTTPRequst</span>. The first we supply by running the <span class="monospaced">sitemap.html</span> snippet; the second is simply the current request.  <span class="monospaced">XmlResponse</span> requires a <span class="monospaced">Node</span> rather than a <span class="monospaced">NodeSeq</span>, which is why we call <span class="monospaced">head</span>&#8201;&#8212;&#8201;as there&#8217;s only one node in the response, this does what we need.</p></div>
<div class="paragraph"><p>Note that Google Sitemaps need dates to be in ISO 8601 format. The built-in <span class="monospaced">java.text.SimpleDateFormat</span> does not support this format prior to Java 7. If you are using Java 6 you need to use <span class="monospaced">org.joda.time.DateTime</span> as we are in this example.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_36">See Also</h4>
<div class="paragraph"><p>Sitemaps are described at: <a href="http://support.google.com/webmasters/bin/answer.py?hl=en&amp;answer=156184">http://support.google.com/webmasters/bin/answer.py?hl=en&amp;answer=156184</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="iOSNativePost">Calling REST Service from a Native iOS Application</h3>
<div class="sect3">
<h4 id="_problem_37">Problem</h4>
<div class="paragraph"><p>You want to make a HTTP POST from a native iOS device to a Lift REST service.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_37">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">NSURLConnection</span> ensuring you set the content-type to "application/json".</p></div>
<div class="paragraph"><p>For example, suppose we want to call this service:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.JsonDSL._</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.JsonAST._</span>

<span class="k">object</span> <span class="nc">Shouty</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">greet</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">:</span> <span class="kt">JValue</span> <span class="o">=</span>
    <span class="s">&quot;greeting&quot;</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="s">&quot;HELLO &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">.</span><span class="n">toUpperCase</span><span class="o">)</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;shout&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">JsonPost</span> <span class="n">json</span><span class="o">-&gt;</span><span class="n">request</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span> <span class="nc">JString</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="o">(</span><span class="n">json</span> <span class="o">\\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">toOpt</span> <span class="o">}</span>
      <span class="k">yield</span> <span class="n">greet</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The service expects a JSON post with a parameter of "name", and it returns a greeting as a JSON object.  To demonstrate the data to and from the service, we can include the service in <span class="monospaced">Boot.scala</span>&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessDispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Shouty</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;and then call it from the command line:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl -d '{ "name" : "Richard" }' -X POST -H 'Content-type: application/json'
   http://127.0.0.1:8080/shout
{
  "greeting":"HELLO RICHARD"
}</pre>
</div></div>
<div class="paragraph"><p>We can implement the POST request using <span class="monospaced">NSURLConnection</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="s">@&quot;http://localhost:8080/shout&quot;</span><span class="p">;</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">postAction</span> <span class="p">{</span>
  <span class="c1">// JSON data:</span>
  <span class="n">NSDictionary</span><span class="o">*</span> <span class="n">dic</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;name&quot;</span><span class="o">:</span> <span class="s">@&quot;Richard&quot;</span><span class="p">};</span>
  <span class="n">NSData</span><span class="o">*</span> <span class="n">jsonData</span> <span class="o">=</span>
    <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="n">dataWithJSONObject</span><span class="o">:</span><span class="n">dic</span> <span class="n">options</span><span class="o">:</span><span class="mi">0</span> <span class="n">error</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
  <span class="n">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">NSMutableURLRequest</span> <span class="n">requestWithURL</span><span class="o">:</span><span class="p">[</span><span class="n">NSURL</span> <span class="n">URLWithString</span><span class="o">:</span><span class="n">url</span><span class="p">]</span>
    <span class="nl">cachePolicy:</span><span class="n">NSURLRequestUseProtocolCachePolicy</span> <span class="n">timeoutInterval</span><span class="o">:</span><span class="mf">60.0</span><span class="p">];</span>

  <span class="c1">// Construct HTTP request:</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setHTTPMethod</span><span class="o">:</span><span class="s">@&quot;POST&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setValue</span><span class="o">:</span><span class="s">@&quot;application/json&quot;</span> <span class="n">forHTTPHeaderField</span><span class="o">:</span><span class="s">@&quot;Content-Type&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setValue</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">jsonData</span> <span class="n">length</span><span class="p">]]</span>
    <span class="nl">forHTTPHeaderField:</span><span class="s">@&quot;Content-Length&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setHTTPBody</span><span class="o">:</span> <span class="n">jsonData</span><span class="p">];</span>

  <span class="c1">// Send the request:</span>
  <span class="n">NSURLConnection</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSURLConnection</span> <span class="n">alloc</span><span class="p">]</span>
    <span class="nl">initWithRequest:</span><span class="n">request</span> <span class="n">delegate</span><span class="o">:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:</span><span class="p">(</span><span class="n">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span>
  <span class="nl">didReceiveResponse:</span><span class="p">(</span><span class="n">NSURLResponse</span> <span class="o">*</span><span class="p">)</span><span class="nv">response</span> <span class="p">{</span>
   <span class="c1">// Start off with new, empty, response data</span>
   <span class="n">self</span><span class="p">.</span><span class="n">receivedJSONData</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableData</span> <span class="n">data</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:</span><span class="p">(</span><span class="n">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span>
  <span class="nl">didReceiveData:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">data</span> <span class="p">{</span>
   <span class="c1">// append incoming data</span>
   <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">receivedJSONData</span> <span class="n">appendData</span><span class="o">:</span><span class="n">data</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:</span><span class="p">(</span><span class="n">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span>
  <span class="nl">didFailWithError:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
   <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error occurred &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connectionDidFinishLoading:</span><span class="p">(</span><span class="n">NSURLConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span> <span class="p">{</span>
  <span class="n">NSError</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
  <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">JSON</span> <span class="o">=</span>
    <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="n">JSONObjectWithData</span><span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">receivedJSONData</span>
    <span class="nl">options:</span> <span class="n">NSJSONReadingMutableContainers</span> <span class="n">error</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">];</span>
  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Return result: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">JSON</span> <span class="n">objectForKey</span><span class="o">:</span><span class="s">@&quot;greeting&quot;</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Obviously in this example we&#8217;ve used hard-coded values and URLs, but this will hopefully
be a starting point for use in your application.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_38">Discussion</h4>
<div class="paragraph"><p>There are many ways to do HTTP POST from iOS and it can be confusing to identify the correct way that works, especially without the aid of external library. The example above uses the iOS native API.</p></div>
<div class="paragraph"><p>Another way is to use <em>AFNetworking</em>. This is a popular external library for iOS development, can cope with many scenarios and is simple to use:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">#import &quot;AFHTTPClient.h&quot;</span>
<span class="cp">#import &quot;AFNetworking.h&quot;</span>
<span class="cp">#import &quot;JSONKit.h&quot;</span>

<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="s">@&quot;http://localhost:8080/shout&quot;</span><span class="p">;</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">postAction</span> <span class="p">{</span>
  <span class="c1">// JSON data:</span>
  <span class="n">NSDictionary</span><span class="o">*</span> <span class="n">dic</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;name&quot;</span><span class="o">:</span> <span class="s">@&quot;Richard&quot;</span><span class="p">};</span>
  <span class="n">NSData</span><span class="o">*</span> <span class="n">jsonData</span> <span class="o">=</span>
   <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="n">dataWithJSONObject</span><span class="o">:</span><span class="n">dic</span> <span class="n">options</span><span class="o">:</span><span class="mi">0</span> <span class="n">error</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>

  <span class="c1">// Construct HTTP request:</span>
  <span class="n">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span>
   <span class="p">[</span><span class="n">NSMutableURLRequest</span> <span class="n">requestWithURL</span><span class="o">:</span><span class="p">[</span><span class="n">NSURL</span> <span class="n">URLWithString</span><span class="o">:</span><span class="n">url</span><span class="p">]</span>
    <span class="nl">cachePolicy:</span><span class="n">NSURLRequestUseProtocolCachePolicy</span> <span class="n">timeoutInterval</span><span class="o">:</span><span class="mf">60.0</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setHTTPMethod</span><span class="o">:</span><span class="s">@&quot;POST&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setValue</span><span class="o">:</span><span class="s">@&quot;application/json&quot;</span> <span class="n">forHTTPHeaderField</span><span class="o">:</span><span class="s">@&quot;Content-Type&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setValue</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">jsonData</span> <span class="n">length</span><span class="p">]]</span>
    <span class="nl">forHTTPHeaderField:</span><span class="s">@&quot;Content-Length&quot;</span><span class="p">];</span>
  <span class="p">[</span><span class="n">request</span> <span class="n">setHTTPBody</span><span class="o">:</span> <span class="n">jsonData</span><span class="p">];</span>

  <span class="c1">// Send the request:</span>
  <span class="n">AFJSONRequestOperation</span> <span class="o">*</span><span class="n">operation</span> <span class="o">=</span>
    <span class="p">[[</span><span class="n">AFJSONRequestOperation</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithRequest</span><span class="o">:</span> <span class="n">request</span><span class="p">];</span>
  <span class="p">[</span><span class="n">operation</span> <span class="n">setCompletionBlockWithSuccess</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span>
    <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span>
  <span class="p">{</span>
     <span class="n">NSString</span> <span class="o">*</span><span class="n">response</span> <span class="o">=</span> <span class="p">[</span><span class="n">operation</span> <span class="n">responseString</span><span class="p">];</span>

     <span class="c1">// Use JSONKit to deserialize the response into NSDictionary</span>
     <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">deserializedJSON</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span> <span class="n">objectFromJSONString</span><span class="p">];</span>
     <span class="p">[</span><span class="n">deserializedJSON</span> <span class="n">count</span><span class="p">];</span>

     <span class="c1">// The response object can be a NSDicionary or a NSArray:</span>
      <span class="k">if</span><span class="p">([</span><span class="n">deserializedJSON</span> <span class="n">count</span><span class="p">]</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Return value: %@&quot;</span><span class="p">,[</span><span class="n">deserializedJSON</span> <span class="n">objectForKey</span><span class="o">:</span><span class="s">@&quot;greeting&quot;</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">deserializedJSONArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span> <span class="n">objectFromJSONString</span><span class="p">];</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Return array value: %@&quot;</span><span class="p">,</span> <span class="n">deserializedJSONArray</span> <span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span><span class="n">failure</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error: %@&quot;</span><span class="p">,</span><span class="n">error</span><span class="p">);</span>
  <span class="p">}];</span>
  <span class="p">[</span><span class="n">operation</span> <span class="n">start</span><span class="p">];</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">NSURLConnection</span> approach is more versatile and gives you starting point to craft your own solution, such as by making the content type more specific. However, <span class="monospaced">AFNetworking</span> is popular and you may prefer that route.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_37">See Also</h4>
<div class="paragraph"><p>You may find the "Complete REST Example" in <em>Simply Lift</em> to be a good test ground for your calls to Lift. <a href="http://simply.liftweb.net/index-5.4.html">http://simply.liftweb.net/index-5.4.html</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ajax">JavaScript, Ajax, Comet</h2>
<div class="sectionbody">
<div class="paragraph"><p>For an introduction to Lift&#8217;s Ajax and Comet features, read <em>Simply Lift</em> at <a href="http://simply.liftweb.net">http://simply.liftweb.net</a>, chapter 9 of <em>Lift in Action</em> (Perrett, 2012, Manning Publications Co.), or watch Diego Medina&#8217;s video presentation at <a href="https://fmpwizard.telegr.am/blog/comet-actors-presentation">https://fmpwizard.telegr.am/blog/comet-actors-presentation</a>.</p></div>
<div class="paragraph"><p>This chapter&#8217;s source code is: <a href="https://github.com/LiftCookbook/cookbook_ajax">https://github.com/LiftCookbook/cookbook_ajax</a>.</p></div>
<div class="sect2">
<h3 id="ButtonTriggerServerCode">Trigger Server-Side Code from a Button</h3>
<div class="sect3">
<h4 id="_problem_38">Problem</h4>
<div class="paragraph"><p>You want to trigger some server-side code when the user presses a
button.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_38">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">ajaxInvoke</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.</span><span class="o">{</span><span class="nc">JsCmd</span><span class="o">,</span> <span class="nc">JsCmds</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.common.Loggable</span>

<span class="k">object</span> <span class="nc">AjaxInvoke</span> <span class="k">extends</span> <span class="nc">Loggable</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">callback</span><span class="o">()</span> <span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;The button was pressed&quot;</span><span class="o">)</span>
    <span class="nc">JsCmds</span><span class="o">.</span><span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;You clicked it&quot;</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">button</span> <span class="k">=</span> <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">ajaxInvoke</span><span class="o">(</span><span class="n">callback</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In this snippet we are binding the click event of a button to an <span class="monospaced">ajaxInvoke</span>: when the button is pressed, Lift
arranges for the function you gave <span class="monospaced">ajaxInvoke</span> to be executed.</p></div>
<div class="paragraph"><p>That function, <span class="monospaced">callback</span>, is just logging a message and returning a JavaScript alert to the browser. The corresponding HTML might include:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;AjaxInvoke.button&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;button&gt;</span>Click Me<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_39">Discussion</h4>
<div class="paragraph"><p>The signature of the function you pass to <span class="monospaced">ajaxInvoke</span> is
<span class="monospaced">Unit =&gt; JsCmd</span>, meaning you can trigger a range of behaviours, from
returning <span class="monospaced">Noop</span> if you want nothing to happen, through changing DOM
element, all the way up to executing arbitrary JavaScript.</p></div>
<div class="paragraph"><p>The example above is using a button, but will work on any element that
has an event you can bind to.  We&#8217;re binding to <em>onclick</em> but it could be any event
the DOM exposes.</p></div>
<div class="paragraph"><p>Related to <span class="monospaced">ajaxInvoke</span> are the following functions:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">SHtml.onEvent</span> which calls a function with the signature <span class="monospaced">String =&gt; JsCmd</span> because it
is passed the <span class="monospaced">value</span> of the node it is attached to. In the above
example, this would be the empty string as the button has no value.
</p>
</li>
<li>
<p>
<span class="monospaced">SHtml.ajaxCall</span> which is, in a sense, more general than <span class="monospaced">onEvent</span>, as you give it the expression you want passed to your server-side code.
</p>
</li>
<li>
<p>
<span class="monospaced">SHtml.jsonCall</span> which is even more general still: you give it a function
that will return a JSON object when executed on the client, and this
object will be passed to your server-side function.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Let&#8217;s look at each of these in turn.</p></div>
<div class="sect4">
<h5 id="_onevent_8201_8212_8201_receiving_the_span_class_monospaced_value_span_of_a_dom_element">onEvent&#8201;&#8212;&#8201;Receiving the <span class="monospaced">value</span> of a DOM Element</h5>
<div class="paragraph"><p>You can use <span class="monospaced">onEvent</span> with any element that has a <span class="monospaced">value</span> attribute and responds to the event you choose to bind to. The function you supply to <span class="monospaced">onEvent</span> is called with the element&#8217;s value. As an example, we can write a snippet which presents a challenge to the user, and validates the response:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">scala.util.Random</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.Alert</span>

<span class="k">object</span> <span class="nc">OnEvent</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span> <span class="k">=</span> <span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">sum</span> <span class="k">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

    <span class="s">&quot;p *&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;What is %d + %d?&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span> <span class="o">&amp;</span>
    <span class="s">&quot;input [onchange]&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">onEvent</span><span class="o">(</span> <span class="n">answer</span> <span class="k">=&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">answer</span> <span class="o">==</span> <span class="n">sum</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span> <span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Correct!&quot;</span><span class="o">)</span>
      <span class="k">else</span> <span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Try again&quot;</span><span class="o">)</span>
     <span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This snippet prompts the user to add two random numbers in the <span class="monospaced">&lt;p&gt;</span> tag, and binds a validation function to the <span class="monospaced">&lt;input&gt;</span> on the page:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;OnEvent&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p&gt;</span>Problem appears here<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">placeholder=</span><span class="s">&quot;Type your answer&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>When <span class="monospaced">onchange</span> is triggered (by pressing return or the tab key, for example), the text entered is sent to our <span class="monospaced">onEvent</span> function as a <span class="monospaced">String</span>.</p></div>
</div>
<div class="sect4">
<h5 id="_ajaxcall_8201_8212_8201_receiving_an_arbitrary_client_side_string">ajaxCall&#8201;&#8212;&#8201;Receiving an Arbitrary Client-Side String</h5>
<div class="paragraph"><p>Where <span class="monospaced">onEvent</span> sends <span class="monospaced">this.value</span> to your server-side code, <span class="monospaced">ajaxCall</span> allows you to specify the client-side expression used to produce a value.</p></div>
<div class="paragraph"><p>To demonstrate this we can create a template that includes two elements: a button and a text field.  We&#8217;ll bind our function to the button, but read a value from the input field:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;AjaxCall&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;41&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
  <span class="nt">&lt;button&gt;</span>Increment<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>We want to arrange for the button to read the <span class="monospaced">num</span> field, increment it, and return it back to the input field:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JE.ValById</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds._</span>

<span class="k">object</span> <span class="nc">AjaxCall</span> <span class="o">{</span>

 <span class="k">def</span> <span class="n">increment</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
  <span class="n">asInt</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span> <span class="n">openOr</span> <span class="n">in</span>

 <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span>
   <span class="nc">SHtml</span><span class="o">.</span><span class="n">ajaxCall</span><span class="o">(</span><span class="nc">ValById</span><span class="o">(</span><span class="s">&quot;num&quot;</span><span class="o">),</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">SetValById</span><span class="o">(</span><span class="s">&quot;num&quot;</span><span class="o">,</span> <span class="n">increment</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="o">)</span>

 <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The first argument to <span class="monospaced">ajaxCall</span> is the expression that will produce a value for our function. It can be any <span class="monospaced">JsExp</span>, and we&#8217;ve
used <span class="monospaced">ValById</span> which looks up the value of an element by the id attribute.  We could have used a regular JQuery expression to achieve the same effect with: <span class="monospaced">JsRaw("$('#num').val()")</span>.</p></div>
<div class="paragraph"><p>Our second argument to <span class="monospaced">ajaxCall</span> takes the value of the <span class="monospaced">JsExp</span> expression as a <span class="monospaced">String</span>. We&#8217;re using one of Lift&#8217;s JavaScript command to replaces the value with a new value. The new value is the result of incrementing the number (providing it is a number).</p></div>
<div class="paragraph"><p>The end result is that you press the button, and the number updates. It should go without saying that these are simple illustrations, and you probably don&#8217;t want a server round-trip to add one to a number. The techniques come into their own when there is some action of value to perform on the server.</p></div>
<div class="paragraph"><p>You may have guessed that <span class="monospaced">onEvent</span> is implemented as an <span class="monospaced">ajaxCall</span> for <span class="monospaced">JsRaw("this.value")</span>.</p></div>
</div>
<div class="sect4">
<h5 id="_jsoncall_8201_8212_8201_receiving_a_json_value">jsonCall&#8201;&#8212;&#8201;Receiving a JSON Value</h5>
<div class="paragraph"><p>Both <span class="monospaced">ajaxCall</span> and <span class="monospaced">onEvent</span> end up evaluating a <span class="monospaced">String =&gt; JsCmd</span> function. By contrast, <span class="monospaced">jsonCall</span> has the signature <span class="monospaced">JValue =&gt; JsCmd</span>, meaning you can pass more complex data structures from JavaScript to your Lift application.</p></div>
<div class="paragraph"><p>To demonstrate this, we&#8217;ll create a template that asks for input, has a function to convert the input into JSON, and a button to send the JSON to the server:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;JsonCall&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p&gt;</span>Enter an addition question:<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;x&quot;</span><span class="nt">&gt;</span> + <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;y&quot;</span><span class="nt">&gt;</span> = <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;z&quot;</span><span class="nt">&gt;</span>.
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;button&gt;</span>Check<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
// <span class="cp">&lt;![CDATA[</span>
<span class="cp">function currentQuestion() {</span>
<span class="cp">  return {</span>
<span class="cp">    first:  parseInt($(&#39;#x&#39;).val()),</span>
<span class="cp">    second: parseInt($(&#39;#y&#39;).val()),</span>
<span class="cp">    answer: parseInt($(&#39;#z&#39;).val())</span>
<span class="cp">  };</span>
<span class="cp">}</span>
<span class="cp">// ]]&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>On the server we&#8217;ll check that the JSON represents a valid integer addition problem:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.</span><span class="o">{</span><span class="nc">JsCmd</span><span class="o">,</span> <span class="nc">JE</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.common.Loggable</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.JsonAST._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.Alert</span>
<span class="k">import</span> <span class="nn">net.liftweb.json.DefaultFormats</span>

<span class="k">object</span> <span class="nc">JsonCall</span> <span class="k">extends</span> <span class="nc">Loggable</span> <span class="o">{</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="n">formats</span> <span class="k">=</span> <span class="nc">DefaultFormats</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Question</span><span class="o">(</span><span class="n">first</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">second</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">answer</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">valid_?</span> <span class="k">=</span> <span class="n">first</span> <span class="o">+</span> <span class="n">second</span> <span class="o">==</span> <span class="n">answer</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>

    <span class="k">def</span> <span class="n">validate</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">JValue</span><span class="o">)</span> <span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
      <span class="n">value</span><span class="o">.</span><span class="n">extractOpt</span><span class="o">[</span><span class="kt">Question</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">valid_?</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Looks good&quot;</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;That doesn&#39;t add up&quot;</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;That doesn&#39;t make sense&quot;</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span>
      <span class="nc">SHtml</span><span class="o">.</span><span class="n">jsonCall</span><span class="o">(</span> <span class="nc">JE</span><span class="o">.</span><span class="nc">Call</span><span class="o">(</span><span class="s">&quot;currentQuestion&quot;</span><span class="o">),</span> <span class="n">validate</span> <span class="k">_</span> <span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Working from the bottom of this snippet up, we see a binding of the <span class="monospaced">&lt;button&gt;</span> to the <span class="monospaced">jsonCall</span>. The value we&#8217;ll be working on is the value provided by the JavaScript function called <span class="monospaced">currentQuestion</span>.  This was defined on the template page.  When the button is clicked the JavaScript function is called and the resulting value will be presented to <span class="monospaced">validate</span>, which is our <span class="monospaced">JValue =&gt; JsCmd</span> function.</p></div>
<div class="paragraph"><p>All <span class="monospaced">validate</span> does is log the JSON data and alert back if the question looks correct or not.  To do this we use the Lift JSON ability to extract JSON to a case class and call the <span class="monospaced">valid_?</span> test to see if the numbers add up.  This will evaluate to <span class="monospaced">Some(true)</span> if the addition works, <span class="monospaced">Some(false)</span> if the addition isn&#8217;t correct or <span class="monospaced">None</span> if the input is missing or not a valid integer.</p></div>
<div class="paragraph"><p>Running the code and entering 1, 2 and 3 into the text fields will produce the following in the server log:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">JObject</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="nc">JField</span><span class="o">(</span><span class="n">first</span><span class="o">,</span><span class="nc">JInt</span><span class="o">(</span><span class="mi">1</span><span class="o">)),</span> <span class="nc">JField</span><span class="o">(</span><span class="n">second</span><span class="o">,</span><span class="nc">JInt</span><span class="o">(</span><span class="mi">2</span><span class="o">)),</span>
  <span class="nc">JField</span><span class="o">(</span><span class="n">answer</span><span class="o">,</span><span class="nc">JInt</span><span class="o">(</span><span class="mi">3</span><span class="o">))))</span>
</pre></div></div></div>
<div class="paragraph"><p>This is the <span class="monospaced">JValue</span> representation of the JSON.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_38">See Also</h4>
<div class="paragraph"><p><a href="#SelectOptionChange">[SelectOptionChange]</a> includes an example of <span class="monospaced">SHtml.onEvents</span> which will bind a function to a number of events on a <span class="monospaced">NodeSeq</span>.</p></div>
<div class="paragraph"><p>For another example of <span class="monospaced">AjaxInvoke</span> take a look at the <em>Call Scala code from JavaScript</em> section of Diego Medina&#8217;s blog at: <a href="http://blog.fmpwizard.com/scala-lift-custom-wizard">http://blog.fmpwizard.com/scala-lift-custom-wizard</a>.</p></div>
<div class="paragraph"><p><em>Exploring Lift</em>, chapter 10, lists various <span class="monospaced">JsExp</span> classes you can use for <span class="monospaced">ajaxCall</span>: <a href="http://exploring.liftweb.net/master/index-10.html">http://exploring.liftweb.net/master/index-10.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SelectOptionChange">Call Server when Select Option Changes</h3>
<div class="sect3">
<h4 id="_problem_39">Problem</h4>
<div class="paragraph"><p>When a HTML select option is selected, you want to trigger a function on the server.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_39">Solution</h4>
<div class="paragraph"><p>Register a <span class="monospaced">String =&gt; JsCmd</span> function with <span class="monospaced">SHtml.ajaxSelect</span>.</p></div>
<div class="paragraph"><p>In this example we will lookup the distance from Earth to the planet a user selects.  This lookup will
happen on the server and update the browser with the result:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;HtmlSelectSnippet&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>Planet:<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;&lt;/select&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;distance&quot;</span><span class="nt">&gt;</span>Distance will appear here<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.common.Empty</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml.ajaxSelect</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmd</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.SetHtml</span>
<span class="k">import</span> <span class="nn">xml.Text</span>

<span class="k">class</span> <span class="nc">HtmlSelectSnippet</span> <span class="o">{</span>

  <span class="c1">// Our &quot;database&quot; maps planet names to distances:</span>
  <span class="k">type</span> <span class="kt">Planet</span> <span class="o">=</span> <span class="nc">String</span>
  <span class="k">type</span> <span class="kt">LightYears</span> <span class="o">=</span> <span class="nc">Double</span>

  <span class="k">val</span> <span class="n">database</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">Planet</span>,<span class="kt">LightYears</span><span class="o">](</span>
    <span class="s">&quot;Alpha Centauri Bb&quot;</span> <span class="o">-&gt;</span> <span class="mf">4.23</span><span class="o">,</span>
    <span class="s">&quot;Tau Ceti e&quot;</span> <span class="o">-&gt;</span> <span class="mf">11.90</span><span class="o">,</span>
    <span class="s">&quot;Tau Ceti f&quot;</span> <span class="o">-&gt;</span> <span class="mf">11.90</span><span class="o">,</span>
    <span class="s">&quot;Gliese 876 d&quot;</span> <span class="o">-&gt;</span> <span class="mf">15.00</span><span class="o">,</span>
    <span class="s">&quot;82 G Eridani b&quot;</span> <span class="o">-&gt;</span> <span class="mf">19.71</span>
  <span class="o">)</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>

    <span class="c1">// To show the user a blank label and blank value option:</span>
    <span class="k">val</span> <span class="n">blankOption</span> <span class="k">=</span> <span class="o">(</span><span class="s">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;&quot;</span><span class="o">)</span>

    <span class="c1">// The complete list of options includes everything in our database:</span>
    <span class="k">val</span> <span class="n">options</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">String</span>,<span class="kt">String</span><span class="o">)]</span> <span class="k">=</span>
      <span class="n">blankOption</span> <span class="o">::</span>
      <span class="n">database</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">p</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">p</span><span class="o">,</span><span class="n">p</span><span class="o">)).</span><span class="n">toList</span>

    <span class="c1">// Nothing is selected by default:</span>
    <span class="k">val</span> <span class="n">default</span> <span class="k">=</span> <span class="nc">Empty</span>

    <span class="c1">// The function to call when an option is picked:</span>
    <span class="k">def</span> <span class="n">handler</span><span class="o">(</span><span class="n">selected</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span> <span class="o">{</span>
      <span class="nc">SetHtml</span><span class="o">(</span><span class="s">&quot;distance&quot;</span><span class="o">,</span> <span class="nc">Text</span><span class="o">(</span><span class="n">database</span><span class="o">(</span><span class="n">selected</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot; light years&quot;</span><span class="o">))</span>
    <span class="o">}</span>

    <span class="c1">// Bind the &lt;select&gt; tag:</span>
    <span class="s">&quot;select&quot;</span> <span class="o">#&gt;</span> <span class="n">ajaxSelect</span><span class="o">(</span><span class="n">options</span><span class="o">,</span> <span class="n">default</span><span class="o">,</span> <span class="n">handler</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The last line of the code is doing the work for us.  It is generating the options and binding
the selection to a function called <span class="monospaced">handler</span>.  The handler function is called with the value
of the selected item.</p></div>
<div class="paragraph"><p>We&#8217;re using the same <span class="monospaced">String</span> (the planet name) for the option label and value, but they could be
different.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_40">Discussion</h4>
<div class="paragraph"><p>To understand what&#8217;s going on here, take a look at the HTML that Lift produces:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;dropdown&quot;</span>
  <span class="na">onchange=</span><span class="s">&quot;liftAjax.lift_ajaxHandler(&#39;F470183993611Y15ZJU=&#39; +</span>
<span class="s">    this.options[this.selectedIndex].value, null, null, null)&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;&lt;/option&gt;</span>
  <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;Tau Ceti e&quot;</span><span class="nt">&gt;</span>Tau Ceti e<span class="nt">&lt;/option&gt;</span>
  ...
<span class="nt">&lt;/select&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">handler</span> function has been stored by Lift under the identifier of "F470183993611Y15ZJU" (in this particular rendering). An "onchange" event handler is attached to the select and the function is passed the value of the selected option. The <span class="monospaced">lift_ajaxHandler</span> JavaScript function is defined in <span class="monospaced">liftAjax.js</span> which is automatically added to your page.</p></div>
<div class="sect4">
<h5 id="_collecting_the_value_on_form_submission">Collecting the Value on Form Submission</h5>
<div class="paragraph"><p>If you need to additionally capture the selected value on a regular form submission, you can make use of <span class="monospaced">SHtml.onEvents</span>.  This attaches event listeners to a <span class="monospaced">NodeSeq</span>, triggering a server-side function when the event occurs.  We can use this with a regular form with a regular select box, but wire in Ajax calls to the server when the select changes.</p></div>
<div class="paragraph"><p>To make use of this, our snippet changes very little:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">var</span> <span class="n">selectedValue</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

<span class="s">&quot;select&quot;</span> <span class="o">#&gt;</span> <span class="n">onEvents</span><span class="o">(</span><span class="s">&quot;onchange&quot;</span><span class="o">)(</span><span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">select</span><span class="o">(</span><span class="n">options</span><span class="o">,</span> <span class="n">default</span><span class="o">,</span> <span class="n">selectedValue</span> <span class="k">=</span> <span class="k">_</span><span class="o">)</span>
<span class="o">}</span> <span class="o">&amp;</span>
<span class="s">&quot;type=submit&quot;</span> <span class="o">#&gt;</span> <span class="n">onSubmitUnit</span><span class="o">(</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">S</span><span class="o">.</span><span class="n">notice</span><span class="o">(</span><span class="s">&quot;Destination &quot;</span><span class="o">+</span><span class="n">selectedValue</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>We are arranging for the same <span class="monospaced">handler</span> function to be called when an "onchange" event is triggered.  This event binding is applied to a regular <span class="monospaced">SHtml.select</span>, which is storing the <span class="monospaced">selectedValue</span> when the form is submitted. We also bind a submit button to a function which generates a notice of which planet was selected.</p></div>
<div class="paragraph"><p>The corresponding HTML also changes little.  We need to add a button and make sure the form is marked as such:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;HtmlSelectFormSnippet?form=post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>Planet:<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;&lt;/select&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;distance&quot;</span><span class="nt">&gt;</span>Distance will appear here<span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Book Ticket&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Now when you change a selected value you see the dynamically updated distance calculation, but pressing the "Book Ticket" button also delivers the value to the server.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_39">See Also</h4>
<div class="paragraph"><p><a href="#MultiSelectBox">[MultiSelectBox]</a> describes how to use classes rather than <span class="monospaced">String</span> values for select boxes.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="ClientSideOnlyActions">Creating Client-Side Actions from your Scala Code</h3>
<div class="sect3">
<h4 id="_problem_40">Problem</h4>
<div class="paragraph"><p>In your Lift code you want to set up a action that is run purely in
client-side JavaScript.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_40">Solution</h4>
<div class="paragraph"><p>Bind your JavaScript directly to the event handler you want to run.</p></div>
<div class="paragraph"><p>Here&#8217;s an example where we make a button slowly fade away when you press it, but notice
that we&#8217;re setting up this binding in our server-side Lift code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="k">object</span> <span class="nc">ClientSide</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span> <span class="s">&quot;$(this).fadeOut()&quot;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In the template we&#8217;d perhaps say:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;ClientSide&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;button&gt;</span>Click Me<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Lift will render the page as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">&quot;$(this).fadeOut()&quot;</span><span class="nt">&gt;</span>Click Me<span class="nt">&lt;/button&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_41">Discussion</h4>
<div class="paragraph"><p>Lift includes a JavaScript abstraction which you can use to build up
more elaborate expressions for the client-side. For example you can
combine basic commands&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.</span><span class="o">{</span><span class="nc">Alert</span><span class="o">,</span> <span class="nc">RedirectTo</span><span class="o">}</span>

<span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span>
  <span class="o">(</span><span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Here we go...&quot;</span><span class="o">)</span> <span class="o">&amp;</span> <span class="nc">RedirectTo</span><span class="o">(</span><span class="s">&quot;http://liftweb.net&quot;</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;which pops up an alert dialog and then sends you to <em>http://liftweb.net</em>. The HTML would be rendered as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">&quot;alert(&amp;quot;Here we go...&amp;quot;);</span>
<span class="s">window.location = &amp;quot;http://liftweb.net&amp;quot;;&quot;</span><span class="nt">&gt;</span>Click Me<span class="nt">&lt;/button&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Another option is to use <span class="monospaced">JE.Call</span> to execute a JavaScript function with
parameters. Suppose we have this function defined:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">greet</span><span class="p">(</span><span class="nx">who</span><span class="p">,</span> <span class="nx">times</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">times</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Hello &quot;</span><span class="o">+</span><span class="nx">who</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We could bind a client-side button press to this client-side function
like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.js.JE</span>

<span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
  <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span> <span class="nc">JE</span><span class="o">.</span><span class="nc">Call</span><span class="o">(</span><span class="s">&quot;greet&quot;</span><span class="o">,</span> <span class="s">&quot;World!&quot;</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>On the client-side, we&#8217;d see:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">&quot;greet(&amp;quot;World!&amp;quot;,3)&quot;</span><span class="nt">&gt;</span>Click Me For Greeting<span class="nt">&lt;/button&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that the types <span class="monospaced">String</span> and <span class="monospaced">Int</span> have been preserved in the JavaScript syntax of the call. This has happened because <span class="monospaced">JE.Call</span> takes a variable number of <span class="monospaced">JsExp</span> arguments after the JavaScript function name. There are wrappers for JavaScript primitive types (<span class="monospaced">JE.Str</span>, <span class="monospaced">JE.Num</span>, <span class="monospaced">JsTrue</span>, <span class="monospaced">JsFalse</span>) and implicit conversions to save you having to wrap the Scala values yourself.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_40">See Also</h4>
<div class="paragraph"><p>Chapter 10 of <em>Exploring Lift</em> at <a href="http://exploring.liftweb.net/">http://exploring.liftweb.net/</a> gives a list of <span class="monospaced">JsCmds</span> and <span class="monospaced">JE</span> expressions.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="FocusOnLoad">Focus on a Field on Page Load</h3>
<div class="sect3">
<h4 id="_problem_41">Problem</h4>
<div class="paragraph"><p>When a page loads you want the browser to select a particular field for
input focus from the user&#8217;s keyboard.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_41">Solution</h4>
<div class="paragraph"><p>Wrap the input with a <span class="monospaced">FocusOnLoad</span> command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.FocusOnLoad</span>

<span class="k">class</span> <span class="nc">Focus</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;name=username&quot;</span> <span class="o">#&gt;</span> <span class="nc">FocusOnLoad</span><span class="o">(&lt;</span><span class="n">input</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="o">/&gt;)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The CSS transform in <span class="monospaced">render</span> will match against <span class="monospaced">name="username"</span> element in the HTML and
replace it with a text input field that will be focused on automatically
when the page loads.</p></div>
<div class="paragraph"><p>Although we&#8217;re focusing on in-line HTML, this could be any <span class="monospaced">NodeSeq</span>, such as the one produced by <span class="monospaced">SHtml.text</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_42">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">FocusOnLoad</span> is an example of a <span class="monospaced">NodeSeq =&gt; NodeSeq</span> transformation. It appends to the <span class="monospaced">NodeSeq</span> with the
JavaScript required to set focus on that field.</p></div>
<div class="paragraph"><p>The JavaScript that performs the focus simply looks up the node in the DOM by ID and calls <span class="monospaced">focus</span> on it. Although the example code above doesn&#8217;t specify an ID, the <span class="monospaced">FocusOn</span> command is smart enough to add one automatically for us.</p></div>
<div class="paragraph"><p>There are two related <span class="monospaced">JsCmd</span>:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">Focus</span>&#8201;&#8212;&#8201;takes an element ID and sets focus on the element.
</p>
</li>
<li>
<p>
<span class="monospaced">SetValueAndFocus</span>&#8201;&#8212;&#8201;which is like <span class="monospaced">Focus</span> but takes an additional
<span class="monospaced">String</span> value to populate the element with.
</p>
</li>
</ul></div>
<div class="paragraph"><p>These two are useful if you need to set focus from Ajax or Comet
components dynamically.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_41">See Also</h4>
<div class="paragraph"><p>The source for <span class="monospaced">FocusOnLoad</span> is worth checking out to understand how it, and related commands, are constructed.  This may help you package your own JavaScript functionality up into commands that can be used in CSS binding expressions: <a href="https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/js/JsCommands.scala">https://github.com/lift/framework/blob/master/web/webkit/src/main/scala/net/liftweb/http/js/JsCommands.scala</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="CSSClassOnAjaxForm">Add CSS Class to an Ajax Form</h3>
<div class="sect3">
<h4 id="_problem_42">Problem</h4>
<div class="paragraph"><p>You want to set the CSS class of an AJAX form.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_42">Solution</h4>
<div class="paragraph"><p>Name the class via <span class="monospaced">?class=</span> query parameter:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">data-lift=</span><span class="s">&quot;form.ajax?class=boxed&quot;</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_43">Discussion</h4>
<div class="paragraph"><p>If you need to set multiple CSS classes, encode a space between the
class names, e.g., <span class="monospaced">class=boxed+primary</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">form.ajax</span> construction is a regular snippet call: the <span class="monospaced">Form</span> snippet is one of the handful of built-in snippets, and in this case we&#8217;re calling the <span class="monospaced">ajax</span> method on that object.  However, normally snippet calls do not copy attributes into the resulting markup, but this snippet is implemented to do exactly that.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_42">See Also</h4>
<div class="paragraph"><p>For an example of accessing these query parameters in your own snippets, see <a href="#ConditionalIncludes">[ConditionalIncludes]</a>.</p></div>
<div class="paragraph"><p><em>Simply Lift</em>, chapter 4, introduces Ajax forms at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="DynamicTemplateLoading">Running a Template via JavaScript</h3>
<div class="sect3">
<h4 id="_problem_43">Problem</h4>
<div class="paragraph"><p>You want to load an entire page, with template and snippets executed, inside of the current page (i.e., without a browser refresh).</p></div>
</div>
<div class="sect3">
<h4 id="_solution_43">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">Template</span> to load the template, and <span class="monospaced">SetHtml</span> to place the content
on the page.</p></div>
<div class="paragraph"><p>Let&#8217;s populate a <span class="monospaced">&lt;div&gt;</span> with the site home page when a button is pressed:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;TemplateLoad&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;inject&quot;</span><span class="nt">&gt;</span>Content will appear here<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;button&gt;</span>Load Template<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The corresponding snippet would be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">SHtml</span><span class="o">,</span> <span class="nc">Templates</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.</span><span class="o">{</span><span class="nc">SetHtml</span><span class="o">,</span> <span class="nc">Noop</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmd</span>

<span class="k">object</span> <span class="nc">TemplateLoad</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">content</span> <span class="k">:</span> <span class="kt">JsCmd</span> <span class="o">=</span>
    <span class="nc">Templates</span><span class="o">(</span><span class="s">&quot;index&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">ns</span> <span class="k">=&gt;</span> <span class="nc">SetHtml</span><span class="o">(</span><span class="s">&quot;inject&quot;</span><span class="o">,</span> <span class="n">ns</span><span class="o">))</span> <span class="n">openOr</span> <span class="nc">Noop</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;button [onclick]&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">ajaxInvoke</span><span class="o">(</span><span class="n">content</span> <span class="k">_</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Clicking the button will cause the content of <span class="monospaced">/index.html</span> to be
loaded into the <span class="monospaced">inject</span> element.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_44">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">Templates</span> produces a <span class="monospaced">Box[NodeSeq]</span>.  In the example above, we map this content into a <span class="monospaced">JsCmd</span> which will populate the <span class="monospaced">inject</span> div.</p></div>
<div class="paragraph"><p>If you write unit tests to access templates, be aware that you may need to modify your development or testing environment to include the <span class="monospaced">webapps</span> folder.  To do this for SBT, add the following to <span class="monospaced">build.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">unmanagedResourceDirectories</span> <span class="n">in</span> <span class="nc">Test</span> <span class="o">&lt;+=</span> <span class="o">(</span><span class="n">baseDirectory</span><span class="o">)</span> <span class="o">{</span> <span class="k">_</span> <span class="o">/</span> <span class="s">&quot;src/main/webapp&quot;</span> <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>For your IDE you&#8217;ll need to add <span class="monospaced">webapp</span> as a source folder, if your running tests that try to locate templates.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_43">See Also</h4>
<div class="paragraph"><p><a href="#ButtonTriggerServerCode">[ButtonTriggerServerCode]</a> describes <span class="monospaced">ajaxInvoke</span> and related methods.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="JavaScriptTail">Move JavaScript to End of Page</h3>
<div class="sect3">
<h4 id="_problem_44">Problem</h4>
<div class="paragraph"><p>You want the JavaScript created in your snippet to be included at the end of the HTML page.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_44">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">S.appendJs</span> which places your JavaScript just before the closing <span class="monospaced">&lt;/body&gt;</span> tag, along with other JavaScript produced by Lift.</p></div>
<div class="paragraph"><p>In this HTML we have placed a <span class="monospaced">&lt;script&gt;</span> tag in the middle of the page, and marked it with a snippet called <span class="monospaced">JavascriptTail</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span> <span class="na">http-equiv=</span><span class="s">&quot;content-type&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>JavaScript in Tail<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">data-lift-content-id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;surround?with=default;at=content&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h2&gt;</span>Javascript in the tail of the page<span class="nt">&lt;/h2&gt;</span>

  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;JavascriptTail&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/script&gt;</span>

  <span class="nt">&lt;p&gt;</span>
    The JavaScript about to be run will have been moved
    to the end of this page, just before the closing
    body tag.
  <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">&lt;script&gt;</span> content will be generated by a snippet.
It doesn&#8217;t need to be a <span class="monospaced">&lt;script&gt;</span> tag: the snippet just replaces the content with nothing, but
hanging the snippet on the <span class="monospaced">&lt;script&gt;</span> tag is a reminder of the purpose of the snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.Alert</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.S</span>
<span class="k">import</span> <span class="nn">xml.NodeSeq</span>

<span class="k">class</span> <span class="nc">JavascriptTail</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">S</span><span class="o">.</span><span class="n">appendJs</span><span class="o">(</span><span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Hi&quot;</span><span class="o">))</span>
    <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="nc">NodeSeq</span><span class="o">.</span><span class="nc">Empty</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Although the snippet is rendering nothing, it calls <span class="monospaced">S.appendJs</span> with a <span class="monospaced">JsCmd</span>.  This will produce the following in the page just before the end of the body:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="c1">// &lt;![CDATA[</span>
<span class="nx">jQuery</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Hi&quot;</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">// ]]&gt;</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Although the snippet was in the middle of the page, the JavaScript appears at the
end of the page.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_45">Discussion</h4>
<div class="paragraph"><p>There are three other ways you could tackle this problem.  The first is to move your JavaScript to an external file, and simply include it on the page where you want it.  For substantial JavaScript code, this might make sense.</p></div>
<div class="paragraph"><p>The second is a variation on <span class="monospaced">S.appendJs</span>: <span class="monospaced">S.appendGlobalJs</span> works in the same way but does not include the jQuery <span class="monospaced">ready</span> around your JavaScript.  This means you have no guarantee the DOM has loaded when your function is called.</p></div>
<div class="paragraph"><p>A third option is wrap your JavaScript in a <span class="monospaced">&lt;lift:tail&gt;</span> snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">JavascriptTail</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
    <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="o">&lt;</span><span class="n">lift</span><span class="k">:</span><span class="kt">tail&gt;</span><span class="o">{</span><span class="kt">Script</span><span class="o">(</span><span class="kt">OnLoad</span><span class="o">(</span><span class="kt">Alert</span><span class="o">(</span><span class="err">&quot;</span><span class="kt">Hi</span><span class="err">&quot;</span><span class="o">)))}</span><span class="kt">&lt;/lift:tail&gt;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that <span class="monospaced">lift:tail</span> is a general-purpose Lift snippet and be used to move various kinds of content to the end of the page, not just JavaScript.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_44">See Also</h4>
<div class="paragraph"><p><a href="#AddToHead">[AddToHead]</a> discusses a related Lift snippet for moving content to the head of the page.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="CometSessionLossJS">Run JavaScript on Comet Session Loss</h3>
<div class="sect3">
<h4 id="_problem_45">Problem</h4>
<div class="paragraph"><p>You&#8217;re using a comet actor and you want to arrange for some JavaScript to be executed in the event of the session being lost.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_45">Solution</h4>
<div class="paragraph"><p>Configure your JavaScript via <span class="monospaced">LiftRules.noCometSessionCmd</span>.</p></div>
<div class="paragraph"><p>As an example we can modify the standard Lift chat demo to save the message being typed in the event of the session loss.  In the style of the demo we would have a Ajax form for entering a message and the comet chat area for displaying messages received:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">data-lift=</span><span class="s">&quot;form.ajax&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;ChatSnippet&quot;</span> <span class="na">id=</span><span class="s">&quot;message&quot;</span>
    <span class="na">placeholder=</span><span class="s">&quot;Type a message&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;comet?type=ChatClient&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li&gt;</span>A message<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>To this we can add a function, <span class="monospaced">stash</span>, which we want to be called in the event of a comet session being lost:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="c1">// &lt;![CDATA[</span>
<span class="kd">function</span> <span class="nx">stash</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">saveCookie</span><span class="p">(</span><span class="s2">&quot;stashed&quot;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#message&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
  <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">jQuery</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">stashedValue</span> <span class="o">=</span> <span class="nx">readCookie</span><span class="p">(</span><span class="s2">&quot;stashed&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#message&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">stashedValue</span><span class="p">);</span>
  <span class="nx">deleteCookie</span><span class="p">(</span><span class="s2">&quot;stashed&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Definition of saveCookie, readCookie, deleteCookie omitted.</span>

<span class="nt">&lt;/script&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Our <span class="monospaced">stash</span> function will save the current value of the input field in a cookie called "stashed".  We arrange, on page load, to check for that cookie and insert the value into our message field.</p></div>
<div class="paragraph"><p>The final part is to modify <span class="monospaced">Boot.scala</span> to register our <span class="monospaced">stash</span> function:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds.Run</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">noCometSessionCmd</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">set</span><span class="o">(</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">Run</span><span class="o">(</span><span class="s">&quot;stash()&quot;</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>In this way, if a session is lost while composing a chat message, the browser will stash the message, and when the page re-loads the message will be recovered.</p></div>
<div class="paragraph"><p>To test the example, type a message into the message field, then restart your Lift application.  Wait 10 seconds, and you&#8217;ll see the effect.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_46">Discussion</h4>
<div class="paragraph"><p>Without changing <span class="monospaced">noCometSessionCmd</span>, the default behavior of Lift is to arrange for the browser to load the page <span class="monospaced">LiftRules.noCometSessionPage</span>&#8201;&#8212;&#8201;which will be <span class="monospaced">/</span> unless you change it.  This is carried out via the JavaScript function <span class="monospaced">lift_sessionLost</span> in <span class="monospaced">cometAjax.js</span>.</p></div>
<div class="paragraph"><p>By providing our own <span class="monospaced">() =&gt; JsCmd</span> function to <span class="monospaced">LiftRules.noCometSessionCmd</span>, Lift arranges to call this function and deliver the <span class="monospaced">JsCmd</span>  to the browser, rather than <span class="monospaced">lift_sessionLost</span>.  If you watch the HTTP traffic between your browser and Lift, you&#8217;ll see the <span class="monospaced">stash</span> function call being returned in response to a comet request.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Factory</div>
<div class="paragraph"><p>The <span class="monospaced">noCometSessionCmd.default.set</span> call is making use of Lift&#8217;s dependency injection. Specifically, it&#8217;s setting up the "supply side" of the dependency. Although we&#8217;re setting a default here, it&#8217;s possible in Lift to supply different behaviours with different scopes: request or session.  See <a href="https://www.assembla.com/spaces/liftweb/wiki/Dependency_Injection">https://www.assembla.com/spaces/liftweb/wiki/Dependency_Injection</a>.</p></div>
</div></div>
<div class="paragraph"><p>This recipe has focused on the handling of loss of session for Comet, and for Ajax, there&#8217;s a corresponding <span class="monospaced">LiftRules.noAjaxSessionCmd</span> setting.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_45">See Also</h4>
<div class="paragraph"><p>You&#8217;ll find the <em>The ubiquitous Chat app</em> in <em>Simply Lift</em>: <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a>.</p></div>
<div class="paragraph"><p>Being able to debug HTTP traffic is a useful way to understand how your Comet or Ajax application is performing.  There are many plugins and products to help with this, such as the <em>HttpFox</em> plugin for Firefox: <a href="https://addons.mozilla.org/en-us/firefox/addon/httpfox/">https://addons.mozilla.org/en-us/firefox/addon/httpfox/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="AjaxFileUpload">Ajax File Upload</h3>
<div class="sect3">
<h4 id="_problem_46">Problem</h4>
<div class="paragraph"><p>You want to offer your users an Ajax file upload tool, with progress bars and drag and drop support.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_46">Solution</h4>
<div class="paragraph"><p>Add Sebastian Tschan&#8217;s <em>jQuery File Upload</em> widget (<a href="https://github.com/blueimp/jQuery-File-Upload">https://github.com/blueimp/jQuery-File-Upload</a>) to your project, and implement a REST end point to receive files.</p></div>
<div class="paragraph"><p>The first step is to download the widget, and drag the <span class="monospaced">js</span> folder into your application as <span class="monospaced">src/main/webapp/js</span>.  We can then use the JavaScript in a template:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>jQuery File Upload Example<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;h1&gt;</span>Drag files onto this page<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;fileupload&quot;</span> <span class="na">type=</span><span class="s">&quot;file&quot;</span> <span class="na">name=</span><span class="s">&quot;files[]&quot;</span> <span class="na">data-url=</span><span class="s">&quot;/upload&quot;</span> <span class="na">multiple</span><span class="nt">&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;progress&quot;</span> <span class="na">style=</span><span class="s">&quot;width:20em; border: 1pt solid silver; display: none&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;progress-bar&quot;</span> <span class="na">style=</span><span class="s">&quot;background: green; height: 1em; width:0%&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/vendor/jquery.ui.widget.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/jquery.iframe-transport.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/jquery.fileupload.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;script&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#fileupload&#39;</span><span class="p">).</span><span class="nx">fileupload</span><span class="p">({</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
      <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#progress-bar&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;0%&#39;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#progress&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">submit</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">progressall</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">progress</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">data</span><span class="p">.</span><span class="nx">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#progress-bar&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">progress</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">files</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;p/&gt;&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#progress&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>This template provides an input field for files, an area to use as a progress indicator, and configures the widget when the page loads in a JQuery <span class="monospaced">$( ... )</span> block.</p></div>
<div class="paragraph"><p>The final part is to implement a Lift REST service to receive the file or files.  The URL of the service, <span class="monospaced">/upload</span>, is set in <span class="monospaced">data-url</span> on the <span class="monospaced">input</span> field, and that&#8217;s the address we match on:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.OkResponse</span>

<span class="k">object</span> <span class="nc">AjaxFileUpload</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="n">serve</span> <span class="o">{</span>

    <span class="k">case</span> <span class="s">&quot;upload&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Post</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">file</span> <span class="k">&lt;-</span> <span class="n">req</span><span class="o">.</span><span class="n">uploadedFiles</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">println</span><span class="o">(</span><span class="s">&quot;Received: &quot;</span><span class="o">+</span><span class="n">file</span><span class="o">.</span><span class="n">fileName</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="nc">OkResponse</span><span class="o">()</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This implementation simply logs the name of the file received and acknowledges successful delivery with a 200 status code back to the widget.</p></div>
<div class="paragraph"><p>As with all REST services, it needs to be registered in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="nc">AjaxFileUpload</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>By default the widget makes the whole HTML page a drop-target for files, meaning you can drag a file onto the page and it will immediately be uploaded to your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_47">Discussion</h4>
<div class="paragraph"><p>In this recipe we&#8217;ve shown just the basic integration of the widget with a Lift application.  The demo site for the widget, <a href="http://blueimp.github.com/jQuery-File-Upload/">http://blueimp.github.com/jQuery-File-Upload/</a>, shows other capabilities, and provides documentation on how to integrate them.</p></div>
<div class="paragraph"><p>May of the features just require JavaScript configuration.  For example, we&#8217;ve used the widget&#8217;s <span class="monospaced">add</span>, <span class="monospaced">progressall</span>, and <span class="monospaced">done</span> handlers to show, update and then fade out a progress bar.  When the upload is completed, the name of the uploaded file is appended to the page.</p></div>
<div class="paragraph"><p>In the REST service the uploaded file are available via the <span class="monospaced">uploadedFiles</span> method on the request. When Lift receives a multi-part form it automatically extracts files as <span class="monospaced">uploadedFiles</span>, each of which is a <span class="monospaced">FileParamHolder</span> which gives us access to the <span class="monospaced">fileName</span>, <span class="monospaced">length</span>, <span class="monospaced">mimeType</span> and <span class="monospaced">fileStream</span>.</p></div>
<div class="paragraph"><p>By default uploaded files are held in memory, but that can be changed (see <a href="#UploadToDisk">[UploadToDisk]</a> in <a href="#FileUpload">[FileUpload]</a>).</p></div>
<div class="paragraph"><p>In the recipe we return a 200 (<span class="monospaced">OkResponse</span>).  If we wanted to signal to the widget that a file was rejected we can return another code. For example, perhaps we want to reject all files except PNG images.  On the server-side we can do that by replacing the <span class="monospaced">OkResponse</span> with a test:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">ResponseWithReason</span><span class="o">,</span> <span class="nc">BadResponse</span><span class="o">,</span> <span class="nc">OkResponse</span><span class="o">}</span>

<span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">uploadedFiles</span><span class="o">.</span><span class="n">exists</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">mimeType</span> <span class="o">!=</span> <span class="s">&quot;image/png&quot;</span> <span class="o">))</span>
  <span class="nc">ResponseWithReason</span><span class="o">(</span><span class="nc">BadResponse</span><span class="o">(),</span> <span class="s">&quot;Only PNGs&quot;</span><span class="o">)</span>
<span class="k">else</span>
  <span class="nc">OkResponse</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>We would mirror this with a <span class="monospaced">fail</span> handler in the client JavaScript:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nx">fail</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">errorThrown</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>If we uploaded, say a JPEG, the browser would show an alert dialog reporting "Only PNGs".</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_46">See Also</h4>
<div class="paragraph"><p>Diego Medina has posted a Gist of Lift REST code to integrate more fully with the image upload and image reviewing features of the widget, specifically implementing the JSON response that the widget expects for that functionality.  You&#8217;ll find it at: <a href="https://gist.github.com/a6715d1e3664f73cd03a">https://gist.github.com/a6715d1e3664f73cd03a</a>.</p></div>
<div class="paragraph"><p><a href="#FileUpload">[FileUpload]</a> describes the basic file upload behaviour of Lift and how to control where files are stored.</p></div>
<div class="paragraph"><p>Antonio Salazar Cardozo has posted example code for performing Ajax file upload using Lift&#8217;s Ajax mechanisms, which avoids external JavaScript libraries. You can find a description and link to the code at: <a href="https://groups.google.com/d/msg/liftweb/OuN1sqRMO_c/TrUGUaSvoN4J">https://groups.google.com/d/msg/liftweb/OuN1sqRMO_c/TrUGUaSvoN4J</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Pipeline">Request Pipeline</h2>
<div class="sectionbody">
<div class="paragraph"><p>When a request reaches Lift there are a number of points where you can jump in an control what Lift does, or send back a different kind of response, or control access.  This chapter looks at the pipeline through examples of different kinds of <span class="monospaced">LiftResponse</span> and configurations.</p></div>
<div class="paragraph"><p>You can get a great overview of the pipeline, including diagrams, from the Lift pipeline Wiki page at
<a href="http://www.assembla.com/spaces/liftweb/wiki/HTTP_Pipeline">http://www.assembla.com/spaces/liftweb/wiki/HTTP_Pipeline</a>.</p></div>
<div class="paragraph"><p>See <a href="https://github.com/LiftCookbook/cookbook_pipeline">https://github.com/LiftCookbook/cookbook_pipeline</a> for the source code that accompanies this chapter.</p></div>
<div class="sect2">
<h3 id="DebugRequest">Debugging a Request</h3>
<div class="sect3">
<h4 id="_problem_47">Problem</h4>
<div class="paragraph"><p>You want to debug a request and see what&#8217;s arriving to your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_47">Solution</h4>
<div class="paragraph"><p>Add an <span class="monospaced">onBeginServicing</span> function in <span class="monospaced">Boot.scala</span> to log the request.
For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">onBeginServicing</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">r</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Received: &quot;</span><span class="o">+</span><span class="n">r</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_48">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">onBeginServicing</span> call is called quite early in the Lift pipeline, before
<span class="monospaced">S</span> is set up, and before Lift has the chance to 404 your request.  The function signature it expects is <span class="monospaced">Req =&gt; Unit</span>.
We&#8217;re just logging, but the functions could be used for other purposes.</p></div>
<div class="paragraph"><p>If you want to select only certain paths, you can. For example, to track
all requests starting <em>/paypal</em>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">onBeginServicing</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">r</span> <span class="k">@</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;paypal&quot;</span> <span class="o">::</span> <span class="k">_</span><span class="o">),</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This pattern will match any request starting <em>/paypal</em>, and we&#8217;re ignoring the suffix on the request if any, and the type of request (e.g., GET, POST or so on).</p></div>
<div class="paragraph"><p>There&#8217;s also <span class="monospaced">LiftRules.early</span> which is called before <span class="monospaced">onBeginServicing</span>.  It expects a <span class="monospaced">HTTPRequest =&gt; Unit</span> function, so is a little lower-level than the <span class="monospaced">Req</span> used in <span class="monospaced">onBeginServicing</span>.  However, it will be called by all requests that pass through Lift. For example, you could mark a request as something that the container should handle by itself:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">liftRequest</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;robots&quot;</span> <span class="o">::</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">false</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Which this in place a request for <em>robots.txt</em> will be logged by <span class="monospaced">LiftRules.early</span> but won&#8217;t make it to any of the other methods described in this recipe.</p></div>
<div class="paragraph"><p>If you need access to state (e.g., <span class="monospaced">S</span>), use <span class="monospaced">earlyInStateful</span>, which is based on a <span class="monospaced">Box[Req]</span> not a <span class="monospaced">Req</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">earlyInStateful</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="c1">// access S here</span>
  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>It&#8217;s possible for your <span class="monospaced">earlyInStateful</span> function to be called twice. This will happen when a new session is being set up.  You can prevent this by only matching on requests in a running Lift session:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">earlyInStateful</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="k">if</span> <span class="nc">LiftRules</span><span class="o">.</span><span class="n">getLiftSession</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="n">running_?</span> <span class="k">=&gt;</span> <span class="c1">// access S here</span>
  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Finally, there&#8217;s also <span class="monospaced">earlyInStateless</span> which like <span class="monospaced">earlyInStateful</span> works on a <span class="monospaced">Box[Req]</span> but in other respects is the same as <span class="monospaced">onBeginServicing</span>. It is triggered after <span class="monospaced">early</span> and before <span class="monospaced">earlyInStateful</span>.</p></div>
<div class="paragraph"><p>As a summary, the functions described in this recipe are called in this order:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">LiftRules.early</span>
</p>
</li>
<li>
<p>
<span class="monospaced">LiftRules.onBeginServicing</span>
</p>
</li>
<li>
<p>
<span class="monospaced">LiftRules.earlyInStateless</span>
</p>
</li>
<li>
<p>
<span class="monospaced">LiftRules.earlyInStateful</span>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_see_also_47">See Also</h4>
<div class="paragraph"><p>If you need to catch the end of a request, there is also an <span class="monospaced">onEndServicing</span> which can be given functions of type
<span class="monospaced">(Req, Box[LiftResponse]) =&gt; Unit</span>.</p></div>
<div class="paragraph"><p><a href="#RunningStateless">[RunningStateless]</a> describe show to force requests to be stateless.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="OnSession">Running Code when Sessions are Created (or Destroyed)</h3>
<div class="sect3">
<h4 id="_problem_48">Problem</h4>
<div class="paragraph"><p>You want to carry out actions when a session is created or destroyed.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_48">Solution</h4>
<div class="paragraph"><p>Make use of the hooks in <span class="monospaced">LiftSession</span>. For example, in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftSession</span><span class="o">.</span><span class="n">afterSessionCreate</span> <span class="o">::=</span>
 <span class="o">(</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span><span class="kt">LiftSession</span><span class="o">,</span> <span class="n">r</span><span class="k">:</span><span class="kt">Req</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Session created&quot;</span><span class="o">)</span> <span class="o">)</span>

<span class="nc">LiftSession</span><span class="o">.</span><span class="n">onBeginServicing</span> <span class="o">::=</span>
 <span class="o">(</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span><span class="kt">LiftSession</span><span class="o">,</span> <span class="n">r</span><span class="k">:</span><span class="kt">Req</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Processing request&quot;</span><span class="o">)</span> <span class="o">)</span>

<span class="nc">LiftSession</span><span class="o">.</span><span class="n">onShutdownSession</span> <span class="o">::=</span>
 <span class="o">(</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span><span class="kt">LiftSession</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Session going away&quot;</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>If the request path has been marked as being stateless via
<span class="monospaced">LiftRules.statelessReqTest</span>, the above example would only execute the
<span class="monospaced">onBeginServicing</span> functions.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_49">Discussion</h4>
<div class="paragraph"><p>The hooks in <span class="monospaced">LiftSession</span> allow you to insert code at various points in
the session lifecycle: when the session is created, at the start of
servicing the request, after servicing, when the session is about to
shutdown, at shutdown&#8230; the pipeline diagrams mentioned at the start of this chapter
are a useful guide to these stages.</p></div>
<div class="paragraph"><p>Note that the Lift session is not the same as the HTTP Session. Lift bridges from the HTTP session to it&#8217;s own session management.  This is described in some detail in <em>Exploring Lift</em> (see <em>See Also</em>).</p></div>
<div class="paragraph"><p>The full list of session hooks is:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">onSetupSession</span>&#8201;&#8212;&#8201;this will be the first hook called when a session is created.
</p>
</li>
<li>
<p>
<span class="monospaced">afterSessionCreate</span>&#8201;&#8212;&#8201;called after all <span class="monospaced">onSetupSession</span> functions have been called.
</p>
</li>
<li>
<p>
<span class="monospaced">onBeginServicing</span>&#8201;&#8212;&#8201;at the start of the request processing.
</p>
</li>
<li>
<p>
<span class="monospaced">onEndServicing</span>&#8201;&#8212;&#8201;and the end of request processing.
</p>
</li>
<li>
<p>
<span class="monospaced">onAboutToShutdownSession</span>&#8201;&#8212;&#8201;called just before a session is shutdown, for example when a session expires or the Lift application is being shutdown.
</p>
</li>
<li>
<p>
<span class="monospaced">onShutdownSession</span>&#8201;&#8212;&#8201;called after all <span class="monospaced">onAboutToShutdownSession</span> functions have been run.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you are testing testing these hooks, you might want to make session expire faster than the 30 minutes of inactivity used by default in Lift.  To do this, supply a millisecond value to <span class="monospaced">LiftRules.sessionInactivityTimeout</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// 30 second inactivity timeout</span>
<span class="nc">LiftRules</span><span class="o">.</span><span class="n">sessionInactivityTimeout</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="nc">Full</span><span class="o">(</span><span class="mi">1000L</span> <span class="o">*</span> <span class="mi">30</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>There are two other hooks in <span class="monospaced">LiftSession</span>: <span class="monospaced">onSessionActivate</span> and <span class="monospaced">onSessionPassivate</span>. These may be of use if you are working with a servlet container in distributed mode, and want to be notified when the servlet HTTP session is about to be serialized (passivated) and de-serialized (activated) between container instances. These hooks are rarely used.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_48">See Also</h4>
<div class="paragraph"><p>Session management is discussed in section 9.5 of <em>Exploring Lift</em>: <a href="http://exploring.liftweb.net/">http://exploring.liftweb.net/</a>.</p></div>
<div class="paragraph"><p><a href="#RunningStateless">[RunningStateless]</a> shows how to run without state.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="ShutdownHooks">Run Code when Lift Shuts Down</h3>
<div class="sect3">
<h4 id="_problem_49">Problem</h4>
<div class="paragraph"><p>You want to have some code executed when your Lift application is
shutting down.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_49">Solution</h4>
<div class="paragraph"><p>Append to <span class="monospaced">LiftRules.unloadHooks</span>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">unloadHooks</span><span class="o">.</span><span class="n">append</span><span class="o">(</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Shutting down&quot;</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_50">Discussion</h4>
<div class="paragraph"><p>You append functions of type <span class="monospaced">() =&gt; Unit</span> to <span class="monospaced">unloadHooks</span>, and these functions are run
right at the end of the Lift handler, after sessions have been
destroyed, Lift actors have been shutdown, and requests have finished
being handled.</p></div>
<div class="paragraph"><p>This is triggered, in the words of the Java servlet
specification, "by the web container to indicate to a filter that it is
being taken out of service".</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_49">See Also</h4>
<div class="paragraph"><p><a href="#RunTasksPeriodically">[RunTasksPeriodically]</a> includes an example of using a unload hook.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RunningStateless">Running Stateless</h3>
<div class="sect3">
<h4 id="_problem_50">Problem</h4>
<div class="paragraph"><p>You want to force your application to be stateless at the HTTP level.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_50">Solution</h4>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">enableContainerSessions</span> <span class="k">=</span> <span class="kc">false</span>
<span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessReqTest</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span> <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="kc">true</span> <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>All requests will now be treated as stateless. Any attempt to use state,
such as via <span class="monospaced">SessionVar</span> for example, will trigger a warning in
developer mode: "Access to Lift&#8217;s statefull features from Stateless mode.
The operation on state will not complete."</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_51">Discussion</h4>
<div class="paragraph"><p>HTTP session creation is controlled via <span class="monospaced">enableContainerSessions</span>, and
applies for all requests. Leaving this value at the default (<span class="monospaced">true</span>)
allows more fine-grained control over which requests are stateless.</p></div>
<div class="paragraph"><p>Using <span class="monospaced">statelessReqTest</span> allows you to decide, based on the
<span class="monospaced">StatelessReqTest</span> case class, if a request should be stateless (<span class="monospaced">true</span>) or not (<span class="monospaced">false</span>).
For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">asset</span><span class="o">(</span><span class="n">file</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
  <span class="nc">List</span><span class="o">(</span><span class="s">&quot;.js&quot;</span><span class="o">,</span> <span class="s">&quot;.gif&quot;</span><span class="o">,</span> <span class="s">&quot;.css&quot;</span><span class="o">).</span><span class="n">exists</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="n">endsWith</span><span class="o">)</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">statelessReqTest</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">StatelessReqTest</span><span class="o">(</span><span class="s">&quot;index&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="n">httpReq</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
  <span class="k">case</span> <span class="nc">StatelessReqTest</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">file</span><span class="o">),</span>  <span class="k">_</span><span class="o">)</span> <span class="k">if</span> <span class="n">asset</span><span class="o">(</span><span class="n">file</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This example would only make the index page and any GIFs, JavaScript and
CSS files stateless. The <span class="monospaced">httpReq</span> part is a <span class="monospaced">HTTPRequest</span> instance,
allowing you to base the decision on the content of the request
(cookies, user agent, etc).</p></div>
<div class="paragraph"><p>Another option is <span class="monospaced">LiftRules.statelessDispatch</span> which allows you to
register a function which returns a <span class="monospaced">LiftResponse</span>. This will be
executed without a session, and convenient for REST-based services.</p></div>
<div class="paragraph"><p>If you just need to mark an entry in Sitemap as being stateless, you can:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Menu</span><span class="o">.</span><span class="n">i</span><span class="o">(</span><span class="s">&quot;Stateless Page&quot;</span><span class="o">)</span> <span class="o">/</span> <span class="s">&quot;demo&quot;</span> <span class="o">&gt;&gt;</span> <span class="nc">Stateless</span>
</pre></div></div></div>
<div class="paragraph"><p>A request for <em>/demo</em> would be processed without state.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_50">See Also</h4>
<div class="paragraph"><p><a href="#REST">[REST]</a> contains recipes for REST-based services in Lift.</p></div>
<div class="paragraph"><p>The Lift Wiki gives further details on the processing of stateless requests: <a href="http://www.assembla.com/wiki/show/liftweb/Stateless_Requests">http://www.assembla.com/wiki/show/liftweb/Stateless_Requests</a>.</p></div>
<div class="paragraph"><p>This stateless request control was introduced in Lift 2.2.  The announcement on the mailing list gives more details: <a href="https://groups.google.com/d/msg/liftweb/2rVMCnWppSo/KoaUMHeQAEAJ">https://groups.google.com/d/msg/liftweb/2rVMCnWppSo/KoaUMHeQAEAJ</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="CatchException">Catch Any Exception</h3>
<div class="sect3">
<h4 id="_problem_51">Problem</h4>
<div class="paragraph"><p>You want a wrapper around all requests to catch exceptions and display
something to the user.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_51">Solution</h4>
<div class="paragraph"><p>Declare an exception handler in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">exceptionHandler</span><span class="o">.</span><span class="n">prepend</span> <span class="o">{</span>
  <span class="k">case</span> <span class="o">(</span><span class="n">runMode</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Failed at: &quot;</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="o">)</span>
    <span class="nc">InternalServerErrorResponse</span><span class="o">()</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In the above example, all exceptions for all requests at all run modes
are being matched, causing an error to be logged and a 500 (internal
server error) to be returned to the browser.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_52">Discussion</h4>
<div class="paragraph"><p>The partial function you add to <span class="monospaced">exceptionHandler</span> needs to return a
<span class="monospaced">LiftResponse</span> (i.e., something to send to the browser). The default
behaviour is to return an <span class="monospaced">XhtmlResponse</span>, which in
<span class="monospaced">Props.RunModes.Development</span> gives details of the exception, and in all
other run modes simply says: "Something unexpected happened".</p></div>
<div class="paragraph"><p>You can return any kind of <span class="monospaced">LiftResponse</span>, including <span class="monospaced">RedirectResponse</span>,
<span class="monospaced">JsonResponse</span>, <span class="monospaced">XmlResponse</span>, <span class="monospaced">JavaScriptResponse</span> and so on.</p></div>
<div class="paragraph"><p>The example above just sends a standard 500 error. That won&#8217;t be very helpful to your users.
An alternative is to render a custom message, but retain the 500 status code which will be
useful for external site monitoring services if you use them:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">exceptionHandler</span><span class="o">.</span><span class="n">prepend</span> <span class="o">{</span>
  <span class="k">case</span> <span class="o">(</span><span class="n">runMode</span><span class="o">,</span> <span class="n">req</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Failed at: &quot;</span><span class="o">+</span><span class="n">req</span><span class="o">.</span><span class="n">uri</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">content</span> <span class="k">=</span> <span class="n">S</span><span class="o">.</span><span class="n">render</span><span class="o">(&lt;</span><span class="n">lift</span><span class="k">:</span><span class="kt">embed</span> <span class="kt">what</span><span class="o">=</span><span class="s">&quot;500&quot;</span> <span class="o">/&gt;,</span> <span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="o">)</span>
    <span class="nc">XmlResponse</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="n">head</span><span class="o">,</span> <span class="mi">500</span><span class="o">,</span> <span class="s">&quot;text/html&quot;</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="n">cookies</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Here we are sending back a response with a 500 status code, but the content is the
<span class="monospaced">Node</span> that results from running <span class="monospaced">src/main/webapp/template-hidden/500.html</span>.  Create that
file with the message you want to show to users:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>500<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">data-lift-content-id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;surround?with=default;at=content&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Something is wrong!<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;p&gt;</span>It&#39;s our fault - sorry<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>You can also control what to send to clients when processing Ajax requests.  In the
following example, we&#8217;re matching just on Ajax POST requests, and returning
custom JavaScript to the browser:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.js.JsCmds._</span>

<span class="k">val</span> <span class="n">ajax</span> <span class="k">=</span> <span class="nc">LiftRules</span><span class="o">.</span><span class="n">ajaxPath</span>

<span class="nc">LiftRules</span><span class="o">.</span><span class="n">exceptionHandler</span><span class="o">.</span><span class="n">prepend</span> <span class="o">{</span>
  <span class="k">case</span> <span class="o">(</span><span class="n">mode</span><span class="o">,</span> <span class="nc">Req</span><span class="o">(</span><span class="n">ajax</span> <span class="o">::</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="nc">PostRequest</span><span class="o">),</span> <span class="n">ex</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Error handing ajax&quot;</span><span class="o">)</span>
    <span class="nc">JavaScriptResponse</span><span class="o">(</span><span class="nc">Alert</span><span class="o">(</span><span class="s">&quot;Boom!&quot;</span><span class="o">))</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>You could test out this handling code by creating an Ajax button that always produces
an exception:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.SHtml</span>

<span class="k">class</span> <span class="nc">ThrowsException</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">def</span> <span class="n">fail</span> <span class="k">=</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="o">(</span><span class="s">&quot;not implemented&quot;</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="s">&quot;*&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">ajaxButton</span><span class="o">(</span><span class="s">&quot;Press Me&quot;</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">fail</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This Ajax example will jump in before Lift&#8217;s default behaviour for Ajax
errors. The default is to retry the Ajax command three times
(<span class="monospaced">LiftRules.ajaxRetryCount</span>), and then execute
<span class="monospaced">LiftRules.ajaxDefaultFailure</span>, which will pop up a dialog saying: "The
server cannot be contacted at this time"</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_51">See Also</h4>
<div class="paragraph"><p><a href="#Custom404">[Custom404]</a> for how to create a custom 404 (not found) page.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RestStreamContent">Streaming Content</h3>
<div class="sect3">
<h4 id="_problem_52">Problem</h4>
<div class="paragraph"><p>You want to stream content back to the web client.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_52">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">OutputStreamResponse</span>, passing it a function that will write to the
<span class="monospaced">OutputStream</span> that Lift supplies.</p></div>
<div class="paragraph"><p>In this example we&#8217;ll stream all the integers from one, via a REST service:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">Req</span><span class="o">,</span><span class="nc">OutputStreamResponse</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.rest._</span>

<span class="k">object</span> <span class="nc">Numbers</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="c1">// Convert a number to a String, and then to UTF-8 bytes</span>
  <span class="c1">// to send down the output stream.</span>
  <span class="k">def</span> <span class="n">num2bytes</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">)</span> <span class="n">getBytes</span><span class="o">(</span><span class="s">&quot;utf-8&quot;</span><span class="o">)</span>

  <span class="c1">// Generate numbers using a Scala stream:</span>
  <span class="k">def</span> <span class="n">infinite</span> <span class="k">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">num2bytes</span><span class="o">)</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="s">&quot;numbers&quot;</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="nc">OutputStreamResponse</span><span class="o">(</span> <span class="n">out</span> <span class="k">=&gt;</span> <span class="n">infinite</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="o">)</span> <span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Scala&#8217;s <span class="monospaced">Stream</span> class is a way to generate a sequence with lazy evaluation. The values being
produced by <span class="monospaced">infinite</span> are used as example data to stream back to the client.</p></div>
<div class="paragraph"><p>Wire this into Lift in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">Numbers</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Visiting <em>http://127.0.0.1:8080/numbers</em> will generate a 200 status code
and start producing the integers from 1. The numbers are produced quite quickly, so you
probably don&#8217;t want to try that in your web browser, but instead from something that
is easier to stop, such as cURL.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_53">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">OutputStreamResponse</span> expects a function of type <span class="monospaced">OutputStream =&gt; Unit</span>. The
<span class="monospaced">OutputStream</span> argument is the output stream to the client.  This means the bytes
we write to the stream are written to the client. In the above example&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">OutputStreamResponse</span><span class="o">(</span><span class="n">out</span> <span class="k">=&gt;</span> <span class="n">infinite</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;we are making use of the <span class="monospaced">write(byte[])</span> method on Java&#8217;s <span class="monospaced">OutputStream</span> (<span class="monospaced">out</span>), and sending it
the <span class="monospaced">Array[Byte]</span> being generated from our <span class="monospaced">infinite</span> stream.</p></div>
<div class="paragraph"><p>For more control over status codes, headers and cookies, there are a
variety of signatures for the <span class="monospaced">OutputStreamResponse</span> object. For the
most control, create an instance of the <span class="monospaced">OutputStreamResponse</span> class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">OutputStreamResponse</span><span class="o">(</span>
  <span class="n">out</span><span class="k">:</span> <span class="o">(</span><span class="kt">OutputStream</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">,</span>
  <span class="n">size</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
  <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">)],</span>
  <span class="n">cookies</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HTTPCookie</span><span class="o">],</span>
  <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Any headers you set (such as <span class="monospaced">Content-type</span>), or status code, may
already have been set by the time your output function is called. Note that
setting <span class="monospaced">size</span> to <span class="monospaced">-1</span> causes the <span class="monospaced">Content-length</span> header to be skipped.</p></div>
<div class="paragraph"><p>There are two related types of response: <span class="monospaced">InMemoryResponse</span> and
<span class="monospaced">StreamingResponse</span>.</p></div>
<div class="sect4">
<h5 id="_inmemoryresponse">InMemoryResponse</h5>
<div class="paragraph"><p><span class="monospaced">InMemoryResponse</span> is useful if you have already assembled the full
content to send to the client. The signature is straightforward:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">InMemoryResponse</span><span class="o">(</span>
  <span class="n">data</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">],</span>
  <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">)],</span>
  <span class="n">cookies</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HTTPCookie</span><span class="o">],</span>
  <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>As an example, we can modify the recipe and force our <span class="monospaced">infinite</span> sequence of numbers to produce the first few numbers as a <span class="monospaced">Array[Byte]</span> in memory:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="n">serve</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Req</span><span class="o">(</span><span class="nc">AsInt</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">InMemoryResponse</span><span class="o">(</span><span class="n">infinite</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="n">n</span><span class="o">).</span><span class="n">toArray</span><span class="o">.</span><span class="n">flatten</span><span class="o">,</span> <span class="nc">Nil</span><span class="o">,</span> <span class="nc">Nil</span><span class="o">,</span> <span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">AsInt</span> helper in Lift matches on an integer, meaning that a request starting with a number matches and we&#8217;ll return that many numbers from the infinite sequence. We&#8217;re not setting headers or cookies, and this request produces what you&#8217;d expect:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://127.0.0.1:8080/3
1
2
3</pre>
</div></div>
</div>
<div class="sect4">
<h5 id="_streamingresponse">StreamingResponse</h5>
<div class="paragraph"><p><span class="monospaced">StreamingResponse</span> pulls bytes into the output stream. This contrasts
with <span class="monospaced">OutputStreamResponse</span>, where you are pushing data to the client.</p></div>
<div class="paragraph"><p>Construct this type of response by providing a class with a <span class="monospaced">read</span> method that can be read
from:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">StreamingResponse</span><span class="o">(</span>
  <span class="n">data</span><span class="k">:</span> <span class="o">{</span><span class="kt">def</span> <span class="kt">read</span><span class="o">(</span><span class="kt">buf:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">])</span><span class="kt">:</span> <span class="kt">Int</span><span class="o">},</span>
  <span class="n">onEnd</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">,</span>
  <span class="n">size</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
  <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">)],</span>
  <span class="n">cookies</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HTTPCookie</span><span class="o">],</span>
  <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Notice the use of a structural type for the <span class="monospaced">data</span> parameter. Anything
with a matching <span class="monospaced">read</span> method can be given here, including
<span class="monospaced">java.io.InputStream</span>-like objects, meaning <span class="monospaced">StreamingResponse</span> can act
as a pipe from input to output. Lift pulls 8k chunks from your
<span class="monospaced">StreamingResponse</span> to send to the client.</p></div>
<div class="paragraph"><p>Your <span class="monospaced">data</span> <span class="monospaced">read</span> function should follow the semantics of Java IO and
return "the total number of bytes read into the buffer, or -1 is there
is no more data because the end of the stream has been reached".</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_52">See Also</h4>
<div class="paragraph"><p>The contract for Java IO is described at <a href="http://docs.oracle.com/javase/6/docs/api/java/io/InputStream.html">http://docs.oracle.com/javase/6/docs/api/java/io/InputStream.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="DiskAccessControl">Serving a File with Access Control</h3>
<div class="sect3">
<h4 id="_problem_53">Problem</h4>
<div class="paragraph"><p>You have a file on disk, you want to allow a user to download it, but
only if they are allowed to. If they are not allowed to, you
want to explain why.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_53">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">RestHelper</span> to serve the file or an explanation page.</p></div>
<div class="paragraph"><p>For example,
suppose we have the file <em>/tmp/important</em> and we only want selected
requests to download that file from the <em>/download/important</em> URL. The
structure for that would be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.rest</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.rest.RestHelper</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">StreamingResponse</span><span class="o">,</span> <span class="nc">LiftResponse</span><span class="o">,</span> <span class="nc">RedirectResponse</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.common.</span><span class="o">{</span><span class="nc">Box</span><span class="o">,</span> <span class="nc">Full</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">java.io.</span><span class="o">{</span><span class="nc">FileInputStream</span><span class="o">,</span> <span class="nc">File</span><span class="o">}</span>

<span class="k">object</span> <span class="nc">DownloadService</span> <span class="k">extends</span> <span class="nc">RestHelper</span> <span class="o">{</span>

  <span class="c1">// (code explained below to go here)</span>

  <span class="n">serve</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;download&quot;</span> <span class="o">::</span> <span class="nc">Known</span><span class="o">(</span><span class="n">fileId</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">permitted</span><span class="o">)</span> <span class="n">fileResponse</span><span class="o">(</span><span class="n">fileId</span><span class="o">)</span>
      <span class="k">else</span> <span class="nc">Full</span><span class="o">(</span><span class="nc">RedirectResponse</span><span class="o">(</span><span class="s">&quot;/sorry&quot;</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We are allowing users to download "known" files. That is, files which we
approve of for access. We do this because opening up the file system to
any unfiltered end-user input pretty much means your server will be
compromised.</p></div>
<div class="paragraph"><p>For our example, <span class="monospaced">Known</span> is checking a static list of names:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">knownFiles</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;important&quot;</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">Known</span> <span class="o">{</span>
 <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">fileId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">knownFiles</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="k">_</span> <span class="o">==</span> <span class="n">fileId</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>For requests to these known resources, we convert the REST request into
a <span class="monospaced">Box[LiftResponse]</span>. For permitted access we serve up the file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">private</span> <span class="k">def</span> <span class="n">permitted</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">random</span> <span class="o">&lt;</span> <span class="mf">0.5d</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">fileResponse</span><span class="o">(</span><span class="n">fileId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Box</span><span class="o">[</span><span class="kt">LiftResponse</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="n">file</span> <span class="k">&lt;-</span> <span class="nc">Box</span> <span class="o">!!</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">&quot;/tmp/&quot;</span><span class="o">+</span><span class="n">fileId</span><span class="o">)</span>
    <span class="n">input</span> <span class="k">&lt;-</span> <span class="n">tryo</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">))</span>
 <span class="o">}</span> <span class="k">yield</span> <span class="nc">StreamingResponse</span><span class="o">(</span><span class="n">input</span><span class="o">,</span>
    <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">input</span><span class="o">.</span><span class="n">close</span><span class="o">,</span>
    <span class="n">file</span><span class="o">.</span><span class="n">length</span><span class="o">,</span>
    <span class="n">headers</span><span class="k">=</span><span class="nc">Nil</span><span class="o">,</span>
    <span class="n">cookies</span><span class="k">=</span><span class="nc">Nil</span><span class="o">,</span>
    <span class="mi">200</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>If no permission is given, the user is redirected to <span class="monospaced">/sorry.html</span>.</p></div>
<div class="paragraph"><p>All of this is wired into Lift in <span class="monospaced">Boot.scala</span> with:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="nc">DownloadService</span><span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_54">Discussion</h4>
<div class="paragraph"><p>By turning the request into a <span class="monospaced">Box[LiftResponse]</span> we are able to serve
up the file, send the user to a different page, and also allow Lift to
handle the 404 (<span class="monospaced">Empty</span>) cases.</p></div>
<div class="paragraph"><p>If we added a test to see if the file existed on disk in <span class="monospaced">fileResponse</span>
that would cause the method to evaluate to <span class="monospaced">Empty</span> for missing files,
which triggers a 404. As the code stands, if the file does not exist,
the <span class="monospaced">tryo</span> would give us a <span class="monospaced">Failure</span> which would turn into a 404 error
with a body of "/tmp/important (No such file or directory)".</p></div>
<div class="paragraph"><p>Because we are testing for known resources via the <span class="monospaced">Known</span> extractor as
part of the pattern for <em>/download/</em>, unknown resources will not be
passed through to our <span class="monospaced">File</span> access code. Again, Lift will return a 404
for these.</p></div>
<div class="paragraph"><p>Guard expressions can also be useful for these kinds of situations:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">serve</span> <span class="o">{</span>
  <span class="k">case</span> <span class="s">&quot;download&quot;</span> <span class="o">::</span> <span class="nc">Known</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="nc">Get</span> <span class="k">_</span> <span class="k">if</span> <span class="n">permitted</span> <span class="k">=&gt;</span> <span class="n">fileResponse</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
  <span class="k">case</span> <span class="s">&quot;download&quot;</span> <span class="o">::</span> <span class="k">_</span> <span class="nc">Get</span> <span class="n">req</span> <span class="k">=&gt;</span> <span class="nc">RedirectResponse</span><span class="o">(</span><span class="s">&quot;/sorry&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>You can mix and match extractors, guards and conditions in your response
to best fit the way you want the code to look and work.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_53">See Also</h4>
<div class="paragraph"><p><em>Chatper 24: Extractors</em> from <em>Programming in Scala</em>: <a href="http://www.artima.com/pins1ed/extractors.html">http://www.artima.com/pins1ed/extractors.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RestrictByHeader">Access Restriction by HTTP Header</h3>
<div class="sect3">
<h4 id="_problem_54">Problem</h4>
<div class="paragraph"><p>You need to control access to a page based on the value of a HTTP
header.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_54">Solution</h4>
<div class="paragraph"><p>Use a custom <span class="monospaced">If</span> in SiteMap:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="nc">HeaderRequired</span> <span class="k">=</span> <span class="nc">If</span><span class="o">(</span>
  <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">S</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">header</span><span class="o">(</span><span class="s">&quot;ALLOWED&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="nc">Full</span><span class="o">(</span><span class="s">&quot;YES&quot;</span><span class="o">))</span> <span class="n">openOr</span> <span class="kc">false</span><span class="o">,</span>
  <span class="s">&quot;Access not allowed&quot;</span>
<span class="o">)</span>

<span class="c1">// Build SiteMap</span>
<span class="k">val</span> <span class="n">entries</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
  <span class="nc">Menu</span><span class="o">.</span><span class="n">i</span><span class="o">(</span><span class="s">&quot;Header Required&quot;</span><span class="o">)</span> <span class="o">/</span> <span class="s">&quot;header-required&quot;</span> <span class="o">&gt;&gt;</span> <span class="nc">HeaderRequired</span>
<span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>In this example <em>header-required.html</em> can only be viewed if the request
includes a HTTP header called <span class="monospaced">ALLOWED</span> with a value of <span class="monospaced">YES</span>. Any other
request for the page will be redirected with a Lift error notice of
"Access not allowed".</p></div>
<div class="paragraph"><p>This can be tested from the command line using a tool like cURL:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://127.0.0.1:8080/header-required.html -H "ALLOWED:YES"</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_55">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">If</span> test ensures the <span class="monospaced">() =&gt; Boolean</span> function you supply as a first
argument returns <span class="monospaced">true</span> before the page it applies to is shown. In this example
we&#8217;ll get true if the request contains a header called "ALLOWED", and the optional
value of that header is <span class="monospaced">Full("YES")</span>.  This is a <span class="monospaced">LocParam</span> (location parameter) which
modifies the site map item. It can be appended to any menu items you want using the <span class="monospaced">&gt;&gt;</span> method.</p></div>
<div class="paragraph"><p>Note that without the header, the test will be false. This will mean with link to the page will not appear the
menu generated by <span class="monospaced">Menu.builder</span>.</p></div>
<div class="paragraph"><p>The second argument to the <span class="monospaced">If()</span> is what Lift does if the test isn&#8217;t true when the user tries to access the page.  It&#8217;s
a <span class="monospaced">() =&gt; LiftResponse</span> function.  This means return whatever you
like, including redirects to other pages.  In the example we are making use of a convenient implicit conversation
from a <span class="monospaced">String</span> ("Access not allowed") to a redirection that will take
the user to the home page.</p></div>
<div class="paragraph"><p>If you visit the page without a header, you&#8217;ll
see a notice saying "Access not allowed".  This will be the home page of the site, but
that&#8217;s just the default.</p></div>
<div class="paragraph"><p>You can request that Lift show a different page by setting <span class="monospaced">LiftRules.siteMapFailRedirectLocation</span> in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">siteMapFailRedirectLocation</span> <span class="k">=</span> <span class="s">&quot;static&quot;</span> <span class="o">::</span> <span class="s">&quot;permission&quot;</span> <span class="o">::</span> <span class="nc">Nil</span>
</pre></div></div></div>
<div class="paragraph"><p>If you then try to access <em>header-required.html</em> without the header set, you&#8217;ll be redirected to <em>/static/permission</em> and shown the content of
whatever you put in that page.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_54">See Also</h4>
<div class="paragraph"><p>The Lift wiki gives a summary of Lift&#8217;s Site Map and the tests you can include in site map entries: <a href="https://www.assembla.com/wiki/show/liftweb/SiteMap">https://www.assembla.com/wiki/show/liftweb/SiteMap</a>.</p></div>
<div class="paragraph"><p>There are further details in chapter 7 of <em>Exploring Lift</em> at <a href="http://exploring.liftweb.net">http://exploring.liftweb.net</a>, and "SiteMap and access control", chapter 7 of <em>Lift in Action</em> (Perrett, 2012, Manning Publications Co.).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="HttpServletRequest">Accessing <span class="monospaced">HttpServletRequest</span></h3>
<div class="sect3">
<h4 id="_problem_55">Problem</h4>
<div class="paragraph"><p>To satisfy some API you need access to the <span class="monospaced">HttpServletRequest</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_55">Solution</h4>
<div class="paragraph"><p>Cast <span class="monospaced">S.request</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.S</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.provider.servlet.HTTPRequestServlet</span>
<span class="k">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span>

<span class="k">def</span> <span class="n">servletRequest</span><span class="k">:</span> <span class="kt">Box</span><span class="o">[</span><span class="kt">HttpServletRequest</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">req</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">request</span>
  <span class="n">inner</span> <span class="k">&lt;-</span> <span class="nc">Box</span><span class="o">.</span><span class="n">asA</span><span class="o">[</span><span class="kt">HTTPRequestServlet</span><span class="o">](</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">inner</span><span class="o">.</span><span class="n">req</span>
</pre></div></div></div>
<div class="paragraph"><p>You can then make your API call:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">servletRequest</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">r</span> <span class="k">=&gt;</span> <span class="n">yourApiCall</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_56">Discussion</h4>
<div class="paragraph"><p>Lift abstracts away from the low-level HTTP request, and from the details of the
servlet container your application is running in.  However, it&#8217;s reassuring to know, if you
absolutely need it, there is a way to get back down to the low-level.</p></div>
<div class="paragraph"><p>Note that the results of <span class="monospaced">servletRequest</span> is a <span class="monospaced">Box</span> because there might not be a request
when you evaluate <span class="monospaced">servletRequest</span>&#8201;&#8212;&#8201;or you might one day port to a
different deployment environment and not be running on a standard Java
servlet container.</p></div>
<div class="paragraph"><p>As your code will have a direct dependency on the Java Servlet API,
you&#8217;ll need to include this dependency in your SBT build:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;javax.servlet&quot;</span> <span class="o">%</span> <span class="s">&quot;servlet-api&quot;</span> <span class="o">%</span> <span class="s">&quot;2.5&quot;</span> <span class="o">%</span> <span class="s">&quot;provided-&gt;default&quot;</span>
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="RewriteForHttps">Force HTTPS Requests</h3>
<div class="sect3">
<h4 id="_problem_56">Problem</h4>
<div class="paragraph"><p>You want to ensure clients are using HTTPs.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_56">Solution</h4>
<div class="paragraph"><p>Add an <span class="monospaced">earlyResponse</span> function in <span class="monospaced">Boot.scala</span> redirecting http requests to https
equivalents. For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">earlyResponse</span><span class="o">.</span><span class="n">append</span> <span class="o">{</span> <span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">Req</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">scheme</span> <span class="o">!=</span> <span class="s">&quot;https&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">uriAndQuery</span> <span class="k">=</span> <span class="n">req</span><span class="o">.</span><span class="n">uri</span> <span class="o">+</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">queryString</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="s">&quot;?&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">)</span> <span class="n">openOr</span> <span class="s">&quot;&quot;</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="s">&quot;https://%s%s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">serverName</span><span class="o">,</span> <span class="n">uriAndQuery</span><span class="o">)</span>
    <span class="nc">Full</span><span class="o">(</span><span class="nc">PermRedirectResponse</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">req</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="n">cookies</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">))</span>
  <span class="o">}</span>
  <span class="k">else</span> <span class="nc">Empty</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_57">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">earlyResponse</span> call is called early in the Lift pipeline. It is
used to execute code before a request is handled and, if required, exit the
pipeline and return a response. The function signature expected is
<span class="monospaced">Req =&gt; Box[LiftResponse]</span>.</p></div>
<div class="paragraph"><p>In this example we are testing for a request that is not "https", and then
formulating a new URL that starts "https" and appends to it the rest of the
original URL and any query parameters. With this created, we return a redirections
to the new URL, along with any cookies that were set.</p></div>
<div class="paragraph"><p>By evaluating to <span class="monospaced">Empty</span> for other requests (i.e., https requets), Lift will continue passing the request
through the pipeline as usual.</p></div>
<div class="paragraph"><p>The ideal method to ensure requests are served using the correct scheme
would be via web server configuration, such as Apache or Nginx. This
isn&#8217;t possible in some cases, such as when your application is deployed
to a PaaS such as CloudBees.</p></div>
<div class="sect4">
<h5 id="_amazon_load_balancer">Amazon Load Balancer</h5>
<div class="paragraph"><p>For Amazon Elastic Load Balancer note that you need to use
<span class="monospaced">X-Forwarded-Proto</span> header to detect HTTPS. As mentioned in their
<em>Overview of Elastic Load Balancing</em> document, "Your server access logs
contain only the protocol used between the server and the load balancer;
they contain no information about the protocol used between the client
and the load balancer."</p></div>
<div class="paragraph"><p>In this situation modify the above test from
<span class="monospaced">req.request.scheme != "https"</span> to:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">req</span><span class="o">.</span><span class="n">header</span><span class="o">(</span><span class="s">&quot;X-Forwarded-Proto&quot;</span><span class="o">)</span> <span class="o">!=</span> <span class="nc">Full</span><span class="o">(</span><span class="s">&quot;https&quot;</span><span class="o">)</span>
</pre></div></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_55">See Also</h4>
<div class="paragraph"><p>The <em>Overview of Elastic Load Balancing</em> can be found at: <a href="http://docs.amazonwebservices.com/ElasticLoadBalancing/latest/DeveloperGuide/arch-loadbalancing.html">http://docs.amazonwebservices.com/ElasticLoadBalancing/latest/DeveloperGuide/arch-loadbalancing.html</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Squeryl">Relational Database Persistence with Record and Squeryl</h2>
<div class="sectionbody">
<div class="paragraph"><p>Squeryl is an object-relational mapping library.  It converts Scala classes into tables, rows and columns in a relational database, and provides a way to write SQL-like queries that are type-checked by the Scala compiler. The Lift Squeryl Record module integrates Squeryl with Record, meaning your Lift application and use Squeryl to store and fetch data while making use of the features of record, such as data validation.</p></div>
<div class="paragraph"><p>The code in this chapter can be found at: <a href="https://github.com/LiftCookbook/cookbook_squeryl">https://github.com/LiftCookbook/cookbook_squeryl</a>.</p></div>
<div class="sect2">
<h3 id="ConfiguringSqueryl">Configuring Squeryl and Record</h3>
<div class="sect3">
<h4 id="_problem_57">Problem</h4>
<div class="paragraph"><p>You want to configure your Lift application to use Squeryl and Record.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_57">Solution</h4>
<div class="paragraph"><p>Include the Squeryl-Record dependency in your build, and in <span class="monospaced">Boot.scala</span> provide a database connection function to <span class="monospaced">SquerylRecord.initWithSquerylSession</span>.</p></div>
<div class="paragraph"><p>For example, to configure Squeryl with PostgreSQL, modify <span class="monospaced">build.sbt</span> to add two dependencies, one for Squeryl-Record and one for the database driver:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5-RC2&quot;</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-webkit&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span><span class="o">,</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-squeryl-record&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span><span class="o">,</span>
    <span class="s">&quot;postgresql&quot;</span> <span class="o">%</span> <span class="s">&quot;postgresql&quot;</span> <span class="o">%</span> <span class="s">&quot;9.1-901.jdbc4&quot;</span>
    <span class="o">...</span>
    <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This will give you access to Squeryl version 0.9.5-6.</p></div>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> we define a connection and register it with Squeryl:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Class</span><span class="o">.</span><span class="n">forName</span><span class="o">(</span><span class="s">&quot;org.postgresql.Driver&quot;</span><span class="o">)</span>

<span class="k">def</span> <span class="n">connection</span> <span class="k">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(</span>
  <span class="s">&quot;jdbc:postgresql://localhost/mydb&quot;</span><span class="o">,</span>
  <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="s">&quot;password&quot;</span><span class="o">)</span>

<span class="nc">SquerylRecord</span><span class="o">.</span><span class="n">initWithSquerylSession</span><span class="o">(</span>
  <span class="nc">Session</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">connection</span><span class="o">,</span> <span class="k">new</span> <span class="nc">PostgreSqlAdapter</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>All Squeryl queries need to run in the context of a transaction.  One way to provide a transaction is to configure
a transaction around all HTTP requests. This is also configured in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">S</span><span class="o">.</span><span class="n">addAround</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoanWrapper</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">inTransaction</span> <span class="o">{</span> <span class="n">f</span> <span class="o">}</span>
<span class="o">})</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_58">Discussion</h4>
<div class="paragraph"><p>You can use any JVM persistence mechanism with Lift. What Lift Record provides is a light interface around persistence with bindings to Lift&#8217;s CSS transforms, screens and wizards. Squeryl-Record is a concrete implementation to connect Record with Squeryl.  This means you can use standard Record objects, which are effectively your schema, with Squeryl and write queries which are validated at compile time.</p></div>
<div class="paragraph"><p>Plugging into Squeryl means initializing Squeryl&#8217;s session management, which allows us to wrap queries in Squeryl&#8217;s <span class="monospaced">transaction</span> and <span class="monospaced">inTransaction</span> functions.  The difference between these two calls is that <span class="monospaced">inTransaction</span> will start a new transaction if one doesn&#8217;t exist, whereas <span class="monospaced">transaction</span> always creates a new transaction.</p></div>
<div class="paragraph"><p>By ensuring a transaction is available for all HTTP requests via <span class="monospaced">addAround</span>, we can write queries in Lift and for the most part not have to establish transactions ourselves unless we want to.  For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.RecordTypeMode._</span>
<span class="k">val</span> <span class="n">r</span> <span class="k">=</span> <span class="n">myTable</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">MyRecord</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">myField</span><span class="o">(</span><span class="n">aValue</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>In this recipe, the <span class="monospaced">PostgreSqlAdapter</span> is being used. Squeryl also supports: <span class="monospaced">OracleAdapter</span>, <span class="monospaced">MySQLInnoDBAdapter</span> and <span class="monospaced">MySQLAdapter</span>, <span class="monospaced">MSSQLServer</span>, <span class="monospaced">H2Adapter</span>, <span class="monospaced">DB2Adapter</span> and <span class="monospaced">DerbyAdapter</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_56">See Also</h4>
<div class="paragraph"><p>The Squeryl <em>Getting Started Guide</em> links to more information about session management and configuration: <a href="http://squeryl.org/getting-started.html">http://squeryl.org/getting-started.html</a>.</p></div>
<div class="paragraph"><p>See <a href="#SquerylJNDI">[SquerylJNDI]</a> for configuring connections via Java Naming and Directory Interface (JNDI).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylJNDI">Using a JNDI Datasource</h3>
<div class="sect3">
<h4 id="_problem_58">Problem</h4>
<div class="paragraph"><p>You want to use a JNDI data source for your Record+Squeryl Lift
application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_58">Solution</h4>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> call <span class="monospaced">initWithSquerylSession</span> with a <span class="monospaced">DataSource</span> looked up from the JDNI context:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">javax.sql.DataSource</span>
<span class="k">val</span> <span class="n">ds</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">InitialContext</span><span class="o">().</span>
  <span class="n">lookup</span><span class="o">(</span><span class="s">&quot;java:comp/env/jdbc/mydb&quot;</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">DataSource</span><span class="o">]</span>

<span class="nc">SquerylRecord</span><span class="o">.</span><span class="n">initWithSquerylSession</span><span class="o">(</span>
  <span class="nc">Session</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">MySQLAdapter</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;replacing <span class="monospaced">mydb</span> with the name given to your database in your JNDI
configuration, and replacing <span class="monospaced">MySQLAdapter</span> with the appropriate adapter
for the database you are using.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_59">Discussion</h4>
<div class="paragraph"><p>The Java Naming and Directory Interface (JNDI) is service provided by
the web container (e.g., Jetty, Tomcat) which allows you to
configure a database connection in the container and then refer the
connection by name in your application. One advantage of this is that
you can avoid including database credentials to your Lift source base.</p></div>
<div class="paragraph"><p>The configuration of JNDI is different for each container, and may vary
with versions of the container you use. The <em>See Also</em> section includes
links to the documentation pages for popular containers.</p></div>
<div class="paragraph"><p>Some environments may also require that you to reference the JNDI resource
in your <span class="monospaced">src/main/webapp/WEB-INF/web.xml</span> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;resource-ref&gt;</span>
 <span class="nt">&lt;res-ref-name&gt;</span>jdbc/mydb<span class="nt">&lt;/res-ref-name&gt;</span>
 <span class="nt">&lt;res-type&gt;</span>javax.sql.DataSource<span class="nt">&lt;/res-type&gt;</span>
 <span class="nt">&lt;res-auth&gt;</span>Container<span class="nt">&lt;/res-auth&gt;</span>
<span class="nt">&lt;/resource-ref&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_57">See Also</h4>
<div class="paragraph"><p>Resources for JDNI configuration include:</p></div>
<div class="ulist"><ul>
<li>
<p>
An example on the Lift Wiki for Apache and Jetty configuration at:<a href="http://www.assembla.com/spaces/liftweb/wiki/Apache_and_Jetty_Configuration">http://www.assembla.com/spaces/liftweb/wiki/Apache_and_Jetty_Configuration</a>.
</p>
</li>
<li>
<p>
The documentation for Jetty gives examples for various databases: <a href="http://www.eclipse.org/jetty/documentation/current/jndi-datasource-examples.html">http://www.eclipse.org/jetty/documentation/current/jndi-datasource-examples.html</a>.
</p>
</li>
<li>
<p>
For Tomcat, the JNDI configuration guide is: <a href="http://tomcat.apache.org/tomcat-7.0-doc/jndi-resources-howto.html#JDBC_Data_Sources">http://tomcat.apache.org/tomcat-7.0-doc/jndi-resources-howto.html#JDBC_Data_Sources</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylOneToMany">One-to-Many Relationship</h3>
<div class="sect3">
<h4 id="_problem_59">Problem</h4>
<div class="paragraph"><p>You want to model a one-to-many relationship, such as a satellite belonging to a single planet, but a planet possibly having many satellites.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_59">Solution</h4>
<div class="paragraph"><p>Use Squeryl&#8217;s <span class="monospaced">oneToManyRelation</span> in your schema, and on your Lift model include a reference from the satellite to the planet.</p></div>
<div class="paragraph"><p>The objective is to model the relationship as shown in <a href="#SquerylPlanetOneToManyFigure">[SquerylPlanetOneToManyFigure]</a>.</p></div>
<div class="imageblock" id="SquerylPlanetOneToManyFigure">
<div class="content">
<img src="images/planets.png" alt="images/planets.png" width="640">
</div>
<div class="title">Figure 3. One planet may have many satellites, but a satellite orbits just one planet.</div>
</div>
<div class="paragraph"><p>In code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.model</span>

<span class="k">import</span> <span class="nn">org.squeryl.Schema</span>
<span class="k">import</span> <span class="nn">net.liftweb.record.</span><span class="o">{</span><span class="nc">MetaRecord</span><span class="o">,</span> <span class="nc">Record</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.KeyedRecord</span>
<span class="k">import</span> <span class="nn">net.liftweb.record.field.</span><span class="o">{</span><span class="nc">StringField</span><span class="o">,</span> <span class="nc">LongField</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.RecordTypeMode._</span>

<span class="k">object</span> <span class="nc">MySchema</span> <span class="k">extends</span> <span class="nc">Schema</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">planets</span> <span class="k">=</span> <span class="n">table</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span>
  <span class="k">val</span> <span class="n">satellites</span> <span class="k">=</span> <span class="n">table</span><span class="o">[</span><span class="kt">Satellite</span><span class="o">]</span>

  <span class="k">val</span> <span class="n">planetToSatellites</span> <span class="k">=</span> <span class="n">oneToManyRelation</span><span class="o">(</span><span class="n">planets</span><span class="o">,</span> <span class="n">satellites</span><span class="o">).</span>
    <span class="n">via</span><span class="o">((</span><span class="n">p</span><span class="o">,</span><span class="n">s</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="o">===</span> <span class="n">s</span><span class="o">.</span><span class="n">planetId</span><span class="o">)</span>

  <span class="n">on</span><span class="o">(</span><span class="n">satellites</span><span class="o">)</span> <span class="o">{</span> <span class="n">s</span> <span class="k">=&gt;</span>
    <span class="n">declare</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">planetId</span> <span class="n">defineAs</span> <span class="n">indexed</span><span class="o">(</span><span class="s">&quot;planet_idx&quot;</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">class</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Planet</span>
    <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span>
    <span class="k">lazy</span> <span class="k">val</span> <span class="n">satellites</span> <span class="k">=</span> <span class="nc">MySchema</span><span class="o">.</span><span class="n">planetToSatellites</span><span class="o">.</span><span class="n">left</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Planet</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span>

  <span class="k">class</span> <span class="nc">Satellite</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Satellite</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
     <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Satellite</span>
     <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
     <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span>
     <span class="k">val</span> <span class="n">planetId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
     <span class="k">lazy</span> <span class="k">val</span> <span class="n">planet</span> <span class="k">=</span> <span class="nc">MySchema</span><span class="o">.</span><span class="n">planetToSatellites</span><span class="o">.</span><span class="n">right</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">Satellite</span> <span class="k">extends</span> <span class="nc">Satellite</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Satellite</span><span class="o">]</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This schema defines the two tables based on the Record classes, as <span class="monospaced">table[Planet]</span> and <span class="monospaced">table[Satellite]</span>. It establishes a <span class="monospaced">oneToManyRelation</span> based on (<span class="monospaced">via</span>) the <span class="monospaced">planetId</span> in the satellite table.</p></div>
<div class="paragraph"><p>This gives Squeryl the information it needs to produce a foreign key to constrain the <span class="monospaced">planetId</span> to reference an existing record in the planet table. This can be seen in the schema generated by Squeryl:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">-- table declarations :</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">Planet</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">idField</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span>
  <span class="p">);</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">Satellite</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">idField</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span><span class="p">,</span>
    <span class="n">planetId</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span>
  <span class="p">);</span>
<span class="c1">-- indexes on Satellite</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">planet_idx</span> <span class="k">on</span> <span class="n">Satellite</span> <span class="p">(</span><span class="n">planetId</span><span class="p">);</span>
<span class="c1">-- foreign key constraints :</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">Satellite</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">SatelliteFK1</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
  <span class="k">references</span> <span class="n">Planet</span><span class="p">(</span><span class="n">idField</span><span class="p">);</span>
</pre></div></div></div>
<div class="paragraph"><p>An index called <span class="monospaced">planet_idx</span> is declared on the <span class="monospaced">planetId</span> field to improve query performance during joins.</p></div>
<div class="paragraph"><p>Finally we make use of the <span class="monospaced">planetToSatellites.left</span> and <span class="monospaced">right</span> methods to establish lookup queries as <span class="monospaced">Planet.satellites</span> and <span class="monospaced">Satellite.planet</span>.  We can demonstrate their use by inserting example data and running the queries:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">inTransaction</span> <span class="o">{</span>
  <span class="n">code</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="nc">MySchema</span><span class="o">.</span><span class="n">create</span>

  <span class="k">import</span> <span class="nn">code.model.MySchema._</span>

  <span class="k">val</span> <span class="n">earth</span> <span class="k">=</span> <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Earth&quot;</span><span class="o">))</span>
  <span class="k">val</span> <span class="n">mars</span> <span class="k">=</span> <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Mars&quot;</span><span class="o">))</span>

  <span class="c1">// .save as a short-hand for satellite.insert when we don&#39;t need</span>
  <span class="c1">// to immediately reference the record (save returns Unit).</span>
  <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;The Moon&quot;</span><span class="o">).</span><span class="n">planetId</span><span class="o">(</span><span class="n">earth</span><span class="o">.</span><span class="n">idField</span><span class="o">.</span><span class="n">is</span><span class="o">).</span><span class="n">save</span>
  <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Phobos&quot;</span><span class="o">).</span><span class="n">planetId</span><span class="o">(</span><span class="n">mars</span><span class="o">.</span><span class="n">idField</span><span class="o">.</span><span class="n">is</span><span class="o">).</span><span class="n">save</span>

  <span class="k">val</span> <span class="n">deimos</span> <span class="k">=</span> <span class="n">satellites</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span>
    <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Deimos&quot;</span><span class="o">).</span><span class="n">planetId</span><span class="o">(</span><span class="n">mars</span><span class="o">.</span><span class="n">idField</span><span class="o">.</span><span class="n">is</span><span class="o">)</span> <span class="o">)</span>

  <span class="n">println</span><span class="o">(</span><span class="s">&quot;Deimos orbits: &quot;</span><span class="o">+</span><span class="n">deimos</span><span class="o">.</span><span class="n">planet</span><span class="o">.</span><span class="n">single</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span><span class="o">)</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&quot;Moons of Mars are: &quot;</span><span class="o">+</span><span class="n">mars</span><span class="o">.</span><span class="n">satellites</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span><span class="o">))</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Running this code produce the output:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Deimos orbits: Mars
Moons of Mars are: List(Phobos, Deimos)</pre>
</div></div>
<div class="paragraph"><p>In this example code we&#8217;re calling <span class="monospaced">deimos.planet.single</span> which returns one result or will thrown an exception if the associated planet was not found. <span class="monospaced">headOption</span> is the safer way if there&#8217;s a chance the record will not be found, as it will evaluate to <span class="monospaced">None</span> or <span class="monospaced">Some[Planet]</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_60">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">planetToSatellites.left</span> method is not a simple collection of <span class="monospaced">Satellite</span> objects.  It&#8217;s a Squeryl <span class="monospaced">Query[Satellite]</span>, meaning you can treat it like any other kind of <span class="monospaced">Queryable[Satellite]</span>.  For example we could ask for those satellites of a planet that are alphabetically after "E", which for Mars would match "Phobos":</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">mars</span><span class="o">.</span><span class="n">satellites</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="n">gt</span> <span class="s">&quot;E&quot;</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">left</span> method result is also a <span class="monospaced">OneToMany[Satellite]</span> which adds the following methods:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">assign</span>&#8201;&#8212;&#8201;adds a new relationship, but does not update the database.
</p>
</li>
<li>
<p>
<span class="monospaced">associate</span>&#8201;&#8212;&#8201;which is like <span class="monospaced">assign</span> but does update the database.
</p>
</li>
<li>
<p>
<span class="monospaced">deleteAll</span>&#8201;&#8212;&#8201;to remove the relationships.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <span class="monospaced">assign</span> call gives the satellite the relationship to the planet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">express</span> <span class="k">=</span> <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Mars Express&quot;</span><span class="o">)</span>
<span class="n">mars</span><span class="o">.</span><span class="n">satellites</span><span class="o">.</span><span class="n">assign</span><span class="o">(</span><span class="n">express</span><span class="o">)</span>
<span class="n">express</span><span class="o">.</span><span class="n">save</span>
</pre></div></div></div>
<div class="paragraph"><p>The next time we query <span class="monospaced">mars.satellites</span> we will find the Mars Express orbiter.</p></div>
<div class="paragraph"><p>A call to <span class="monospaced">associate</span> would go one step further for us, making Squeryl insert or update the satellite automatically:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">express</span> <span class="k">=</span> <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Mars Express&quot;</span><span class="o">)</span>
<span class="n">mars</span><span class="o">.</span><span class="n">satellites</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">express</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>The third method, <span class="monospaced">deleteAll</span> does what it sounds like it should do. It would execute the following and return the number of rows removed:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">delete</span> <span class="k">from</span> <span class="n">Satellite</span>
</pre></div></div></div>
<div class="paragraph"><p>The right side of the one-to-many also has additional methods added by <span class="monospaced">ManyToOne[Planet]</span> of <span class="monospaced">assign</span> and <span class="monospaced">delete</span>.  Be aware that to delete the "one" side of a many-to-one, anything assigned to record will need to have been deleted already to avoid a database constraint error that would arise from, for example, leaving satellites referencing non-existent planets.</p></div>
<div class="paragraph"><p>As <span class="monospaced">left</span> and <span class="monospaced">right</span> are queries, it means each time you use them you&#8217;ll be sending a new query to the database.  Squeryl refer to these forms as <em>stateless relations</em>.</p></div>
<div class="paragraph"><p>The <em>stateful</em> versions of <span class="monospaced">left</span> and <span class="monospaced">right</span> look like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
 <span class="o">...</span>
 <span class="k">lazy</span> <span class="k">val</span> <span class="n">satellites</span> <span class="k">:</span> <span class="kt">StatefulOneToMany</span><span class="o">[</span><span class="kt">Satellite</span><span class="o">]</span> <span class="k">=</span>
   <span class="nc">MySchema</span><span class="o">.</span><span class="n">planetToSatellites</span><span class="o">.</span><span class="n">leftStateful</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Satellite</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Satellite</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="n">planet</span> <span class="k">:</span> <span class="kt">StatefulManyToOne</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">MySchema</span><span class="o">.</span><span class="n">planetToSatellites</span><span class="o">.</span><span class="n">rightStateful</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This change means the results of <span class="monospaced">mars.satellites</span> will be cached. Subsequent calls on that instance of a <span class="monospaced">Planet</span> won&#8217;t trigger a round trip to the database. You can still <span class="monospaced">associate</span> new records or <span class="monospaced">deleteAll</span> records which will work as you expect, but if a relationship is added or changed elsewhere you&#8217;ll need to call <span class="monospaced">refresh</span> on the relation to see the change.</p></div>
<div class="paragraph"><p>Which version should you use? That will depend on your application, but you can use both in the same record if you need to.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_58">See Also</h4>
<div class="paragraph"><p>Squeryl relations are documented at <a href="http://squeryl.org/relations.html">http://squeryl.org/relations.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylManyToMany">Many-to-Many Relationship</h3>
<div class="sect3">
<h4 id="_problem_60">Problem</h4>
<div class="paragraph"><p>You want to model a many-to-many relationship, such as a planet being visted by many space probes, but a space probe also visiting many planets.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_60">Solution</h4>
<div class="paragraph"><p>Use Squeryl&#8217;s <span class="monospaced">manyToManyRelation</span> in your schema, and implement a record to hold the join between the two sides of the relationship. <a href="#SquerylPlanetManyToManyFigure">[SquerylPlanetManyToManyFigure]</a> shows the structure we will create in this recipe, where <span class="monospaced">Visit</span> is the record that will connect each many to the other many.</p></div>
<div class="imageblock" id="SquerylPlanetManyToManyFigure">
<div class="content">
<img src="images/visits.png" alt="images/visits.png" width="640">
</div>
<div class="title">Figure 4. Many-to-many: Jupiter was visited by Juno and Voyager 1; Saturn was visited by Voyager.</div>
</div>
<div class="paragraph"><p>The schema is defined in terms of two tables, one for planets and one for space probes, plus a relationship between the two based on a third class, called <span class="monospaced">Visit</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.model</span>

<span class="k">import</span> <span class="nn">org.squeryl.Schema</span>
<span class="k">import</span> <span class="nn">net.liftweb.record.</span><span class="o">{</span><span class="nc">MetaRecord</span><span class="o">,</span> <span class="nc">Record</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.KeyedRecord</span>
<span class="k">import</span> <span class="nn">net.liftweb.record.field.</span><span class="o">{</span><span class="nc">IntField</span><span class="o">,</span> <span class="nc">StringField</span><span class="o">,</span> <span class="nc">LongField</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.RecordTypeMode._</span>
<span class="k">import</span> <span class="nn">org.squeryl.dsl.ManyToMany</span>

<span class="k">object</span> <span class="nc">MySchema</span> <span class="k">extends</span> <span class="nc">Schema</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">planets</span> <span class="k">=</span> <span class="n">table</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span>
  <span class="k">val</span> <span class="n">probes</span> <span class="k">=</span> <span class="n">table</span><span class="o">[</span><span class="kt">Probe</span><span class="o">]</span>

  <span class="k">val</span> <span class="n">probeVisits</span> <span class="k">=</span> <span class="n">manyToManyRelation</span><span class="o">(</span><span class="n">probes</span><span class="o">,</span> <span class="n">planets</span><span class="o">).</span><span class="n">via</span><span class="o">[</span><span class="kt">Visit</span><span class="o">]</span> <span class="o">{</span>
    <span class="o">(</span><span class="n">probe</span><span class="o">,</span> <span class="n">planet</span><span class="o">,</span> <span class="n">visit</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="o">(</span><span class="n">visit</span><span class="o">.</span><span class="n">probeId</span> <span class="o">===</span> <span class="n">probe</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="n">visit</span><span class="o">.</span><span class="n">planetId</span> <span class="o">===</span> <span class="n">planet</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">class</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Planet</span>
    <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span>
    <span class="k">lazy</span> <span class="k">val</span> <span class="n">probes</span> <span class="k">:</span> <span class="kt">ManyToMany</span><span class="o">[</span><span class="kt">Probe</span>,<span class="kt">Visit</span><span class="o">]</span> <span class="k">=</span>
      <span class="nc">MySchema</span><span class="o">.</span><span class="n">probeVisits</span><span class="o">.</span><span class="n">right</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Planet</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span>

  <span class="k">class</span> <span class="nc">Probe</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Probe</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Probe</span>
    <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span>
    <span class="k">lazy</span> <span class="k">val</span> <span class="n">planets</span> <span class="k">:</span> <span class="kt">ManyToMany</span><span class="o">[</span><span class="kt">Planet</span>,<span class="kt">Visit</span><span class="o">]</span> <span class="k">=</span>
      <span class="nc">MySchema</span><span class="o">.</span><span class="n">probeVisits</span><span class="o">.</span><span class="n">left</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">Probe</span> <span class="k">extends</span> <span class="nc">Probe</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Probe</span><span class="o">]</span>

  <span class="k">class</span> <span class="nc">Visit</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Visit</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Visit</span>
    <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">planetId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">probeId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">Visit</span> <span class="k">extends</span> <span class="nc">Visit</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Visit</span><span class="o">]</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> we can print out the schema&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">inTransaction</span> <span class="o">{</span>
  <span class="n">code</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="nc">MySchema</span><span class="o">.</span><span class="n">printDdl</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;which will produce something like this, depending on the database in use:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">-- table declarations :</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">Planet</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">idField</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span>
  <span class="p">);</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">Probe</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">idField</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span>
  <span class="p">);</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">Visit</span> <span class="p">(</span>
    <span class="n">idField</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span><span class="p">,</span>
    <span class="n">planetId</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">probeId</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span>
  <span class="p">);</span>
<span class="c1">-- foreign key constraints :</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">Visit</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">VisitFK1</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">probeId</span><span class="p">)</span>
  <span class="k">references</span> <span class="n">Probe</span><span class="p">(</span><span class="n">idField</span><span class="p">);</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">Visit</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">VisitFK2</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
  <span class="k">references</span> <span class="n">Planet</span><span class="p">(</span><span class="n">idField</span><span class="p">);</span>
</pre></div></div></div>
<div class="paragraph"><p>Notice that the <span class="monospaced">visit</span> table will hold a row for each relationship between a <span class="monospaced">planetId</span> and <span class="monospaced">probeId</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">Planet.probes</span> and <span class="monospaced">Probe.planets</span> provide an <span class="monospaced">associate</span> method to establish a new relationship. For example, we can establish a set of planets and probes&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">jupiter</span> <span class="k">=</span> <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Jupiter&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">saturn</span> <span class="k">=</span> <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Saturn&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">juno</span> <span class="k">=</span> <span class="n">probes</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Probe</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Juno&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">voyager1</span> <span class="k">=</span> <span class="n">probes</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Probe</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Voyager 1&quot;</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;and then connect them:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">juno</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">jupiter</span><span class="o">)</span>
<span class="n">voyager1</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">jupiter</span><span class="o">)</span>
<span class="n">voyager1</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">saturn</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>We can also use <span class="monospaced">Probe.planets</span> and <span class="monospaced">Planet.probes</span> as a query to look up the associations.  To access all the probes that had visited each planet in a snippet, we can write this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">class</span> <span class="nc">ManyToManySnippet</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span>
    <span class="s">&quot;#planet-visits&quot;</span> <span class="o">#&gt;</span> <span class="n">planets</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">planet</span> <span class="k">=&gt;</span>
      <span class="s">&quot;.planet-name *&quot;</span> <span class="o">#&gt;</span> <span class="n">planet</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span> <span class="o">&amp;</span>
      <span class="s">&quot;.probe-name *&quot;</span> <span class="o">#&gt;</span> <span class="n">planet</span><span class="o">.</span><span class="n">probes</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The snippet could be combined with a template like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;ManyToManySnippet&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Planet facts<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;planet-visits&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;planet-name&quot;</span><span class="nt">&gt;</span>Name will be here<span class="nt">&lt;/span&gt;</span> was visited by:
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;probe-name&quot;</span><span class="nt">&gt;</span>Probe name goes here<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The top half of <a href="#SquerylManyToManyScreengrab">[SquerylManyToManyScreengrab]</a> gives an example of the output from this snippet and template.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_61">Discussion</h4>
<div class="paragraph"><p>The Squeryl DSL <span class="monospaced">manyToManyRelation(probes, planets).via[Visit]</span> is the core element here connecting our <span class="monospaced">Planet</span>, <span class="monospaced">Probe</span> and <span class="monospaced">Visit</span> records together. It allows us to access the "left" and "right" sides of the relationship in our model as <span class="monospaced">Probe.planets</span> and <span class="monospaced">Planet.probes</span>.</p></div>
<div class="paragraph"><p>As with <a href="#SquerylOneToMany">[SquerylOneToMany]</a> for one-to-many relationships, the left and right sides are queries. When you ask for <span class="monospaced">Planet.probes</span> the database is queried appropriately with a join on the <span class="monospaced">Visit</span> records:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">Select</span>
  <span class="n">Probe</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
  <span class="n">Probe</span><span class="p">.</span><span class="n">idField</span>
<span class="k">From</span>
  <span class="n">Visit</span><span class="p">,</span>
  <span class="n">Probe</span>
<span class="k">Where</span>
  <span class="p">(</span><span class="n">Visit</span><span class="p">.</span><span class="n">probeId</span> <span class="o">=</span> <span class="n">Probe</span><span class="p">.</span><span class="n">idField</span><span class="p">)</span> <span class="k">and</span> <span class="p">(</span><span class="n">Visit</span><span class="p">.</span><span class="n">planetId</span> <span class="o">=</span> <span class="o">?</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Also as described in <a href="#SquerylOneToMany">[SquerylOneToMany]</a> there are stateful variants of <span class="monospaced">left</span> and <span class="monospaced">right</span> to cache the query results.</p></div>
<div class="paragraph"><p>In the data we inserted into the database, we did not have to mention <span class="monospaced">Visit</span>. The Squeryl <span class="monospaced">manyToManyRelation</span> has enough information to know how to insert a visit as the relationship.  Incidentally, it doesn&#8217;t matter which way round we make the calls in a many-to-many relationship.  The following two expressions are equivalent and result in the same database structure:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">juno</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">jupiter</span><span class="o">)</span>
<span class="c1">// ..or..</span>
<span class="n">jupiter</span><span class="o">.</span><span class="n">probes</span><span class="o">.</span><span class="n">associate</span><span class="o">(</span><span class="n">juno</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>You might even wonder why we had to bother with defining a <span class="monospaced">Visit</span> record at all, but there are benefits in doing so. For example, you can attach additional information onto the join table, such as the year the probe visited a planet.</p></div>
<div class="paragraph"><p>To do this, we modify the record to include the additional field:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Visit</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Visit</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Visit</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">planetId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">probeId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">year</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">IntField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="monospaced">Visit</span> is still a container for the <span class="monospaced">planetId</span> and <span class="monospaced">probeId</span> references, but we also have a plain integer holder for the year of the visit.</p></div>
<div class="paragraph"><p>To record a visit year, we need the <span class="monospaced">assign</span> method provided by <span class="monospaced">ManyToMany[T]</span>.  This will establish the relationship, but not change the database. Instead, it returns the <span class="monospaced">Visit</span> instance which we can change and then store in the database:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">probeVisits</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="n">voyager1</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">assign</span><span class="o">(</span><span class="n">saturn</span><span class="o">).</span><span class="n">year</span><span class="o">(</span><span class="mi">1980</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>The return type of <span class="monospaced">assign</span> in this case is <span class="monospaced">Visit</span>, and <span class="monospaced">Visit</span> has a <span class="monospaced">year</span> field. Inserting the <span class="monospaced">Visit</span> record via <span class="monospaced">probeVisits</span> will create a row in the table for visits.</p></div>
<div class="paragraph"><p>To access this extra information on the <span class="monospaced">Visit</span> object, you can make use of a couple of methods provided by <span class="monospaced">ManyToMany[T]</span>:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">associations</span>&#8201;&#8212;&#8201;a query returning the <span class="monospaced">Visit</span> objects related to the <span class="monospaced">Planet.probes</span> or <span class="monospaced">Probe.planets</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">associationMap</span>&#8201;&#8212;&#8201;a query returning pairs of <span class="monospaced">(Planet,Visit)</span> or <span class="monospaced">(Probe,Visit)</span> depending on which side of the join you call it on (probes or planets).
</p>
</li>
</ul></div>
<div class="paragraph"><p>For example, in a snippet we could list all the space probes, and for each probe show the planet it visited and what year it was there.  The snippet would look like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;#probe-visits&quot;</span> <span class="o">#&gt;</span> <span class="n">probes</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">probe</span> <span class="k">=&gt;</span>
  <span class="s">&quot;.probe-name *&quot;</span> <span class="o">#&gt;</span> <span class="n">probe</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span> <span class="o">&amp;</span>
  <span class="s">&quot;.visit&quot;</span> <span class="o">#&gt;</span> <span class="n">probe</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">associationMap</span><span class="o">.</span><span class="n">collect</span> <span class="o">{</span>
    <span class="k">case</span> <span class="o">(</span><span class="n">planet</span><span class="o">,</span> <span class="n">visit</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="s">&quot;.planet-name *&quot;</span> <span class="o">#&gt;</span> <span class="n">planet</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span> <span class="o">&amp;</span>
      <span class="s">&quot;.year&quot;</span> <span class="o">#&gt;</span> <span class="n">visit</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">is</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We are using <span class="monospaced">collect</span> here rather than <span class="monospaced">map</span> just to match the <span class="monospaced">(Planet,Visit)</span> tuple and give the values meaningful names. You could also use <span class="monospaced">(for { (planet, visit) &lt;- probe.planets.associationMap } yield ...)</span> if you prefer.</p></div>
<div class="paragraph"><p>The lower-half of <a href="#SquerylManyToManyScreengrab">[SquerylManyToManyScreengrab]</a> demonstrates how this snippet would render when combined with the following template:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Probe facts<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;probe-visits&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p&gt;&lt;span</span> <span class="na">class=</span><span class="s">&quot;probe-name&quot;</span><span class="nt">&gt;</span>Space craft name<span class="nt">&lt;/span&gt;</span> visited:<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;visit&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;planet-name&quot;</span><span class="nt">&gt;</span>Name here<span class="nt">&lt;/span&gt;</span> in <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;year&quot;</span><span class="nt">&gt;</span>n<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="imageblock" id="SquerylManyToManyScreengrab">
<div class="content">
<img src="images/visitsscreengrab.png" alt="images/visitsscreengrab.png" width="640">
</div>
<div class="title">Figure 5. Example output from using the many-to-many features in this recipe.</div>
</div>
<div class="paragraph"><p>To remove an association you have access to <span class="monospaced">dissociate</span> and <span class="monospaced">dissociateAll</span> on the <span class="monospaced">left</span> and <span class="monospaced">right</span> queries.  To remove a single association:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">numRowsChanged</span> <span class="k">=</span> <span class="n">juno</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">dissociate</span><span class="o">(</span><span class="n">jupiter</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This would be executed in SQL as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">delete</span> <span class="k">from</span> <span class="n">Visit</span>
<span class="k">where</span>
  <span class="n">probeId</span> <span class="o">=</span> <span class="o">?</span> <span class="k">and</span> <span class="n">planetId</span> <span class="o">=</span> <span class="o">?</span>
</pre></div></div></div>
<div class="paragraph"><p>To remove all the associations:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">numRowsChanged</span> <span class="k">=</span> <span class="n">jupiter</span><span class="o">.</span><span class="n">probes</span><span class="o">.</span><span class="n">dissociateAll</span>
</pre></div></div></div>
<div class="paragraph"><p>The SQL for this is:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">delete</span> <span class="k">from</span> <span class="n">Visit</span>
<span class="k">where</span>
  <span class="n">Visit</span><span class="p">.</span><span class="n">planetId</span> <span class="o">=</span> <span class="o">?</span>
</pre></div></div></div>
<div class="paragraph"><p>What you cannot do is delete a <span class="monospaced">Planet</span> or <span class="monospaced">Probe</span> if that record still has associations in the <span class="monospaced">Visit</span> relationship.  What you&#8217;d get is a referential integrity exception thrown.  Instead, you&#8217;ll need to <span class="monospaced">dissociatateAll</span> first:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">jupiter</span><span class="o">.</span><span class="n">probes</span><span class="o">.</span><span class="n">dissociateAll</span>
<span class="n">planets</span><span class="o">.</span><span class="n">delete</span><span class="o">(</span><span class="n">jupiter</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>However, if you do want <em>cascading deletes</em> you can achieve this by overriding the default behaviour in your schema:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// To automatically remove probes when we remove planets:</span>
<span class="n">probeVisits</span><span class="o">.</span><span class="n">rightForeignKeyDeclaration</span><span class="o">.</span><span class="n">constrainReference</span><span class="o">(</span><span class="n">onDelete</span> <span class="n">cascade</span><span class="o">)</span>

<span class="c1">// To automatically remove planets when we remove probes:</span>
<span class="n">probeVisits</span><span class="o">.</span><span class="n">leftForeignKeyDeclaration</span><span class="o">.</span><span class="n">constrainReference</span><span class="o">(</span><span class="n">onDelete</span> <span class="n">cascade</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This is part of the schema, in that it will change the table constraints, with <span class="monospaced">printDdl</span> producing this (depending on the database you use):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">alter</span> <span class="k">table</span> <span class="n">Visit</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">VisitFK1</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">probeId</span><span class="p">)</span>
  <span class="k">references</span> <span class="n">Probe</span><span class="p">(</span><span class="n">idField</span><span class="p">)</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">cascade</span><span class="p">;</span>

<span class="k">alter</span> <span class="k">table</span> <span class="n">Visit</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">VisitFK2</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
  <span class="k">references</span> <span class="n">Planet</span><span class="p">(</span><span class="n">idField</span><span class="p">)</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">cascade</span><span class="p">;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_59">See Also</h4>
<div class="paragraph"><p><a href="#SquerylOneToMany">[SquerylOneToMany]</a>, on one-to-many relationships, discusses <span class="monospaced">leftStateful</span> and <span class="monospaced">rightStaeful</span> relations, which are also applicable for many-to-many relationships.</p></div>
<div class="paragraph"><p>Foreign keys, cascading deletes, are described at: <a href="http://squeryl.org/relations.html">http://squeryl.org/relations.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="FieldValidation">Adding Validation to a Field</h3>
<div class="sect3">
<h4 id="_problem_61">Problem</h4>
<div class="paragraph"><p>You want to add validation to a field in your model, so that users are informed of missing fields or fields that aren&#8217;t acceptable to your application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_61">Solution</h4>
<div class="paragraph"><p>Override the <span class="monospaced">validations</span> method on your field and provide one re more validation functions.</p></div>
<div class="paragraph"><p>As an example, imagine we have a database of planets and we want to ensure any new planets entered by users have names of at least five characters.  We add this as a validation on our record:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> <span class="k">class</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>   <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Planet</span>
    <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">override</span> <span class="k">def</span> <span class="n">validations</span> <span class="k">=</span>
        <span class="n">valMinLen</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">&quot;Name too short&quot;</span><span class="o">)</span> <span class="k">_</span> <span class="o">::</span> <span class="k">super</span><span class="o">.</span><span class="n">validations</span>
    <span class="o">}</span>

  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>To check the validation, in our snippet we call <span class="monospaced">validate</span> on the record which will return all the errors for the record:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code</span>
<span class="k">package</span> <span class="nn">snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="n">S</span><span class="o">,</span><span class="nc">SHtml</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="k">import</span> <span class="nn">model.MySchema._</span>

<span class="k">class</span> <span class="nc">ValidateSnippet</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">newPlanet</span> <span class="k">=</span> <span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span>

    <span class="k">def</span> <span class="n">validateAndSave</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">newPlanet</span><span class="o">.</span><span class="n">validate</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Nil</span> <span class="k">=&gt;</span>
        <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="n">newPlanet</span><span class="o">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">notice</span><span class="o">(</span><span class="s">&quot;Planet &#39;%s&#39; saved&quot;</span> <span class="n">format</span> <span class="n">newPlanet</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is</span><span class="o">)</span>

      <span class="k">case</span> <span class="n">errors</span> <span class="k">=&gt;</span>
        <span class="n">S</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="n">errors</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="s">&quot;#planetName&quot;</span> <span class="o">#&gt;</span> <span class="n">newPlanet</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">toForm</span> <span class="o">&amp;</span>
    <span class="s">&quot;type=submit&quot;</span> <span class="o">#&gt;</span> <span class="nc">SHtml</span><span class="o">.</span><span class="n">onSubmitUnit</span><span class="o">(</span><span class="n">validateAndSave</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>When the snippet runs we render the <span class="monospaced">Planet.name</span> field and wire up a submit button to call the <span class="monospaced">validateAndSave</span> method.</p></div>
<div class="paragraph"><p>If the <span class="monospaced">validate</span> call indicates there are no errors (<span class="monospaced">Nil</span>), we can save the record and inform the user via a notice.  If there are errors, we render all of them with <span class="monospaced">S.error</span>.</p></div>
<div class="paragraph"><p>The corresponding template could be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Planet Name Validation<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">data-lift-content-id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span> <span class="na">data-lift=</span><span class="s">&quot;surround?with=default;at=content&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Add a planet<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;Msgs?showAll=false&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;lift:notice</span><span class="na">_class</span><span class="nt">&gt;</span>noticeBox<span class="err">&lt;</span>/lift:notice_class&gt;
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;p&gt;</span>
    Planet names need to be at least 5 characters long.
  <span class="nt">&lt;/p&gt;</span>

  <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;ValidateSnippet?form&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;div&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;planetName&quot;</span><span class="nt">&gt;</span>Planet name:<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;planetName&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">data-lift=</span><span class="s">&quot;Msg?id=name_id&amp;errorClass=error&quot;</span><span class="nt">&gt;</span>
        Msg to appear here
      <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>

  <span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>In this template the error message is shown next to the <span class="monospaced">input</span> field, styled with a CSS class of <span class="monospaced">errorClass</span>. The success notice
is shown near the top of the page, just below the <span class="monospaced">&lt;h1&gt;</span> heading, using a styled called <span class="monospaced">noticeBox</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_62">Discussion</h4>
<div class="paragraph"><p>The built-in validations are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">valMinLen</span>&#8201;&#8212;&#8201;validate a string is at least a given length, as shown above.
</p>
</li>
<li>
<p>
<span class="monospaced">valMaxLen</span>&#8201;&#8212;&#8201;validate that a string is not above a given length.
</p>
</li>
<li>
<p>
<span class="monospaced">valRegex</span>&#8201;&#8212;&#8201;validate a string matches the given pattern.
</p>
</li>
</ul></div>
<div class="paragraph"><p>An example of regular expression validation on a field would be:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">java.util.regex.Pattern</span>

<span class="k">val</span> <span class="n">url</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">1024</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">validations</span> <span class="k">=</span>
    <span class="n">valRegex</span><span class="o">(</span> <span class="nc">Pattern</span><span class="o">.</span><span class="n">compile</span><span class="o">(</span><span class="s">&quot;^https?://.*&quot;</span><span class="o">),</span>
              <span class="s">&quot;URLs should start http:// or https://&quot;</span><span class="o">)</span> <span class="k">_</span> <span class="o">::</span>
    <span class="k">super</span><span class="o">.</span><span class="n">validations</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The list of errors from <span class="monospaced">validate</span> are of type <span class="monospaced">List[FieldError]</span>.  The <span class="monospaced">S.error</span> method accepts this list and registered each validation error message so it can be shown on the page.  It does this by associating the message with an ID for the field, allowing you to pick out just the errors for an individual field, as we do in this recipe.  The ID is stored on the field, and in the case of <span class="monospaced">Planet.name</span> it is available as <span class="monospaced">Planet.name.uniqueFieldId</span>.  It&#8217;s a <span class="monospaced">Box[String]</span> with a value of <span class="monospaced">Full("name_id")</span>.  It is this <span class="monospaced">name_id</span> value that we used in the <span class="monospaced">lift:Msg?id=name_id&amp;errorClass=error</span> markup to pick out just the error for this field.</p></div>
<div class="paragraph"><p>You don&#8217;t have to use <span class="monospaced">S.error</span> to display validation messages.  You can roll your own display code, making use of the <span class="monospaced">FieldError</span> directly.  As you can see from the source for <span class="monospaced">FieldError</span>, the error is available as a <span class="monospaced">msg</span> property:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">FieldError</span><span class="o">(</span><span class="n">field</span><span class="k">:</span> <span class="kt">FieldIdentifier</span><span class="o">,</span> <span class="n">msg</span><span class="k">:</span> <span class="kt">NodeSeq</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">toString</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">uniqueFieldId</span> <span class="o">+</span> <span class="s">&quot; : &quot;</span> <span class="o">+</span> <span class="n">msg</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_60">See Also</h4>
<div class="paragraph"><p>The <span class="monospaced">BaseField.scala</span> class in the Lift source code contains the definition of the built-in <span class="monospaced">StringValidators</span>. Find the source at: <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala">https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala</a>.</p></div>
<div class="paragraph"><p><a href="#Forms">[Forms]</a> describes form processing, notices and errors.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="CustomValidation">Custom Validation Logic</h3>
<div class="sect3">
<h4 id="_problem_62">Problem</h4>
<div class="paragraph"><p>You want to provide your own validation logic and apply it to a field in
a record.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_62">Solution</h4>
<div class="paragraph"><p>Implement a function from the type of the field to
<span class="monospaced">List[FieldError]</span>, and reference the function in the <span class="monospaced">validations</span> on the field.</p></div>
<div class="paragraph"><p>Here&#8217;s an example: we have a database of planets, and when a user
enters a new planet, we want the name to be unique.  The name of the planet
is a <span class="monospaced">String</span>, so we need to provide a function from <span class="monospaced">String =&gt; List[FieldError]</span>.</p></div>
<div class="paragraph"><p>With the validation function defined (<span class="monospaced">valUnique</span>, below), we include it in the list of <span class="monospaced">validations</span> on the
<span class="monospaced">name</span> field:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.FieldError</span>

<span class="k">class</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Planet</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">idField</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">validations</span> <span class="k">=</span>
      <span class="n">valUnique</span><span class="o">(</span><span class="s">&quot;Planet already exists&quot;</span><span class="o">)</span> <span class="k">_</span> <span class="o">::</span>
      <span class="k">super</span><span class="o">.</span><span class="n">validations</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">valUnique</span><span class="o">(</span><span class="n">errorMsg</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">String</span><span class="o">)(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">FieldError</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Planet</span><span class="o">.</span><span class="n">unique_?</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="kc">true</span> <span class="k">=&gt;</span> <span class="nc">FieldError</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="n">errorMsg</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span>
      <span class="k">case</span> <span class="kc">false</span> <span class="k">=&gt;</span> <span class="nc">Nil</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Planet</span> <span class="k">with</span> <span class="nc">MetaRecord</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">unique_?</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">from</span><span class="o">(</span><span class="n">planets</span><span class="o">)</span> <span class="o">{</span> <span class="n">p</span> <span class="k">=&gt;</span>
    <span class="n">where</span><span class="o">(</span><span class="n">lower</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="o">)</span> <span class="o">===</span> <span class="n">lower</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="n">select</span><span class="o">(</span><span class="n">p</span><span class="o">)</span>
  <span class="o">}.</span><span class="n">isEmpty</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The validation is triggered just like any other validation, as described in <a href="#FieldValidation">[FieldValidation]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_63">Discussion</h4>
<div class="paragraph"><p>By convention validation functions have two argument lists: the first
for the error message; the second to receive the value to validate. This
allows you to easily re-use your validation function on other fields.  For example,
if you wanted to validate that satellites have a unique name, you could use
exactly the same function but provide a different error message.</p></div>
<div class="paragraph"><p>The <span class="monospaced">FieldError</span> you return needs to know the field it applies to as
well as the message to display. In the example the field is <span class="monospaced">name</span>, but
we&#8217;ve used <span class="monospaced">this.name</span> to avoid confusion with the <span class="monospaced">name</span> parameter passed
into the <span class="monospaced">valUnique</span> function.</p></div>
<div class="paragraph"><p>The example code has used text for the error message, but there is a variation of <span class="monospaced">FieldError</span> that
accepts <span class="monospaced">NodeSeq</span>.  This allows you to produce safe markup as part of the error if you need to.  For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">FieldError</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">Please</span> <span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;/policy&quot;</span><span class="o">&gt;</span><span class="n">our</span> <span class="n">name</span> <span class="n">policy</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;)</span>
</pre></div></div></div>
<div class="paragraph"><p>For internationalisation, you may prefer to pass in a key to the validation function, and
resolve it via <span class="monospaced">S.?</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">validations</span> <span class="k">=</span>
      <span class="n">valUnique</span><span class="o">(</span><span class="s">&quot;validation.planet&quot;</span><span class="o">)</span> <span class="k">_</span> <span class="o">::</span>
      <span class="k">super</span><span class="o">.</span><span class="n">validations</span>
  <span class="o">}</span>

<span class="c1">// ...combined with...</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">valUnique</span><span class="o">(</span><span class="n">errorKey</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">String</span><span class="o">)(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">FieldError</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Planet</span><span class="o">.</span><span class="n">unique_?</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="kc">false</span> <span class="k">=&gt;</span> <span class="nc">FieldError</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="n">S</span> <span class="o">?</span> <span class="n">errorKey</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span>
    <span class="k">case</span> <span class="kc">true</span> <span class="k">=&gt;</span> <span class="nc">Nil</span>
  <span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_61">See Also</h4>
<div class="paragraph"><p><a href="#FieldValidation">[FieldValidation]</a> discusses field validation and the built-in validations.</p></div>
<div class="paragraph"><p>Text localisation is discussed on the Lift wiki at: <a href="https://www.assembla.com/wiki/show/liftweb/Localization">https://www.assembla.com/wiki/show/liftweb/Localization</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylFilter">Modify a Field Value Before it is Set</h3>
<div class="sect3">
<h4 id="_problem_63">Problem</h4>
<div class="paragraph"><p>You want to modify the value of a field, so the value in your model is
the modified version.  For example, to clean a value by removing leading and trailing whitespace.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_63">Solution</h4>
<div class="paragraph"><p>Override <span class="monospaced">setFilter</span> and provide a list of functions to apply to a field.</p></div>
<div class="paragraph"><p>To remove leading and trailing whitespace entered by the user, the field would use the <span class="monospaced">trim</span> filter:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">override</span> <span class="k">def</span> <span class="n">setFilter</span> <span class="k">=</span> <span class="n">trim</span> <span class="k">_</span> <span class="o">::</span> <span class="k">super</span><span class="o">.</span><span class="n">setFilter</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_64">Discussion</h4>
<div class="paragraph"><p>The built-in filters are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">crop</span>&#8201;&#8212;&#8201;enforces the field&#8217;s min and max length by truncation.
</p>
</li>
<li>
<p>
<span class="monospaced">trim</span>&#8201;&#8212;&#8201;applies <span class="monospaced">String.trim</span> to the field value.
</p>
</li>
<li>
<p>
<span class="monospaced">toUpper</span> and <span class="monospaced">toLower</span>&#8201;&#8212;&#8201;change the case of the field value.
</p>
</li>
<li>
<p>
<span class="monospaced">removeRegExChars</span>&#8201;&#8212;&#8201;removes matching regular expression characters.
</p>
</li>
<li>
<p>
<span class="monospaced">notNull</span>&#8201;&#8212;&#8201;coverts null values to an empty string.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Filters are run before validation. This means if you have a minimum length validation and the trim filter, for example, users cannot pass the validation test by just including spaces on the end of the value they enter.</p></div>
<div class="paragraph"><p>A filter for a <span class="monospaced">String</span> field would be of type <span class="monospaced">String =&gt; String</span>, and the <span class="monospaced">setFilter</span> function expects a <span class="monospaced">List</span> of these.  Knowing this, it&#8217;s straight-forward to write custom filters. For example, here&#8217;s is a filter that applies a simple form of title case on our <span class="monospaced">name</span> field:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> <span class="k">def</span> <span class="n">titleCase</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
  <span class="n">in</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\\s&quot;</span><span class="o">).</span>
  <span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toList</span><span class="o">).</span>
  <span class="n">collect</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">x</span> <span class="o">::</span> <span class="n">xs</span>  <span class="k">=&gt;</span> <span class="o">(</span><span class="nc">Character</span><span class="o">.</span><span class="n">toUpperCase</span><span class="o">(</span><span class="n">x</span><span class="o">).</span><span class="n">toString</span> <span class="o">::</span> <span class="n">xs</span><span class="o">).</span><span class="n">mkString</span>
  <span class="o">}.</span><span class="n">mkString</span><span class="o">(</span><span class="s">&quot; &quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This function is splitting the input string on spaces, converting each word into a list of characters, converting the first character into upper case, and then gluing the strings back together.</p></div>
<div class="paragraph"><p>When installed as a filter&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">256</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">override</span> <span class="k">def</span> <span class="n">setFilter</span> <span class="k">=</span>
    <span class="n">trim</span> <span class="k">_</span> <span class="o">::</span> <span class="n">titleCase</span> <span class="k">_</span> <span class="o">::</span> <span class="k">super</span><span class="o">.</span><span class="n">setFilter</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;a user entering "jaglan beta" as a planet name would see it stored in the database as "Jaglan Beta".</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_62">See Also</h4>
<div class="paragraph"><p>The best place to understand the filters is the trait <span class="monospaced">StringValidators</span> in the source for <span class="monospaced">BaseField</span>: <a href="https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala">https://github.com/lift/framework/blob/master/core/util/src/main/scala/net/liftweb/util/BaseField.scala</a>.</p></div>
<div class="paragraph"><p>If you really do need to apply title case to a value, the Apache Commons <span class="monospaced">WordUtils</span> class provides ready-made functions for this.  See: <a href="http://commons.apache.org/lang/">http://commons.apache.org/lang/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylUnitTest">Testing with Specs2</h3>
<div class="sect3">
<h4 id="_problem_64">Problem</h4>
<div class="paragraph"><p>You want to write Specs2 unit tests which access your database model with Squeryl and Record.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_64">Solution</h4>
<div class="paragraph"><p>Use an in-memory database, and arrange for it to be set up around your test.</p></div>
<div class="paragraph"><p>There are three parts to this: including a database in your project and connect to it in an in-memory mode; creating a re-usable trait to set up the database; and then using the trait in your test.</p></div>
<div class="paragraph"><p>The H2 database has an in memory mode, meaning it won&#8217;t save data to disk. It needs to be included in <span class="monospaced">build.sbt</span> as a dependency. Whilst you are editing <span class="monospaced">build.sbt</span> also disable SBT&#8217;s parallel test execution to prevent database tests from influencing each other:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&quot;com.h2database&quot;</span> <span class="o">%</span> <span class="s">&quot;h2&quot;</span> <span class="o">%</span> <span class="s">&quot;1.3.170&quot;</span>

<span class="n">parallelExecution</span> <span class="n">in</span> <span class="nc">Test</span> <span class="o">:=</span> <span class="kc">false</span>
</pre></div></div></div>
<div class="paragraph"><p>Create a trait to initialise the database and create the schema:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.model</span>

<span class="k">import</span> <span class="nn">java.sql.DriverManager</span>

<span class="k">import</span> <span class="nn">org.squeryl.Session</span>
<span class="k">import</span> <span class="nn">org.squeryl.adapters.H2Adapter</span>

<span class="k">import</span> <span class="nn">net.liftweb.util.StringHelpers</span>
<span class="k">import</span> <span class="nn">net.liftweb.common._</span>
<span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="n">S</span><span class="o">,</span> <span class="nc">Req</span><span class="o">,</span> <span class="nc">LiftSession</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.SquerylRecord</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.RecordTypeMode._</span>

<span class="k">import</span> <span class="nn">org.specs2.mutable.Around</span>
<span class="k">import</span> <span class="nn">org.specs2.execute.Result</span>

<span class="k">trait</span> <span class="nc">TestLiftSession</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">session</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LiftSession</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="nc">StringHelpers</span><span class="o">.</span><span class="n">randomString</span><span class="o">(</span><span class="mi">20</span><span class="o">),</span> <span class="nc">Empty</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">inSession</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">init</span><span class="o">(</span><span class="nc">Req</span><span class="o">.</span><span class="n">nil</span><span class="o">,</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span> <span class="n">a</span> <span class="o">}</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">DBTestKit</span> <span class="k">extends</span> <span class="nc">Loggable</span> <span class="o">{</span>

  <span class="nc">Class</span><span class="o">.</span><span class="n">forName</span><span class="o">(</span><span class="s">&quot;org.h2.Driver&quot;</span><span class="o">)</span>

  <span class="nc">Logger</span><span class="o">.</span><span class="n">setup</span> <span class="k">=</span> <span class="nc">Full</span><span class="o">(</span><span class="n">net</span><span class="o">.</span><span class="n">liftweb</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">LoggingAutoConfigurer</span><span class="o">())</span>
  <span class="nc">Logger</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">apply</span><span class="o">()</span> <span class="o">}</span>

  <span class="k">def</span> <span class="n">configureH2</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">SquerylRecord</span><span class="o">.</span><span class="n">initWithSquerylSession</span><span class="o">(</span>
      <span class="nc">Session</span><span class="o">.</span><span class="n">create</span><span class="o">(</span>
        <span class="nc">DriverManager</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(</span><span class="s">&quot;jdbc:h2:mem:dbname;DB_CLOSE_DELAY=-1&quot;</span><span class="o">,</span> <span class="s">&quot;sa&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">),</span>
        <span class="k">new</span> <span class="n">H2Adapter</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">createDb</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">inTransaction</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">MySchema</span><span class="o">.</span><span class="n">drop</span>
        <span class="nc">MySchema</span><span class="o">.</span><span class="n">create</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">e</span> <span class="k">:</span> <span class="kt">Throwable</span> <span class="o">=&gt;</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;DB Schema error&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
          <span class="k">throw</span> <span class="n">e</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">InMemoryDB</span><span class="o">()</span> <span class="k">extends</span> <span class="nc">Around</span> <span class="k">with</span> <span class="nc">DBTestKit</span> <span class="k">with</span> <span class="nc">TestLiftSession</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">around</span><span class="o">[</span><span class="kt">T</span> <span class="k">&lt;%</span> <span class="kt">Result</span><span class="o">](</span><span class="n">testToRun</span><span class="k">:</span> <span class="o">=&gt;</span><span class="n">T</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">configureH2</span>
    <span class="n">createDb</span>
    <span class="n">inSession</span> <span class="o">{</span>
      <span class="n">inTransaction</span> <span class="o">{</span>
        <span class="n">testToRun</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In summary, this trail provides an <span class="monospaced">InMemoryDB</span> <em>context</em> for Specs2. This context ensures that the database is configured, the schema created and a transaction is supplied around your test.</p></div>
<div class="paragraph"><p>Finally, mix the trait into your test and execute in the scope of the <span class="monospaced">InMemoryDB</span> context.</p></div>
<div class="paragraph"><p>As an example, using the schema from <a href="#SquerylOneToMany">[SquerylOneToMany]</a> we can test that the planet Mars has two moons:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.model</span>

<span class="k">import</span> <span class="nn">org.specs2.mutable._</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.RecordTypeMode._</span>
<span class="k">import</span> <span class="nn">MySchema._</span>

<span class="k">class</span> <span class="nc">PlanetsSpec</span> <span class="k">extends</span> <span class="nc">Specification</span> <span class="k">with</span> <span class="nc">DBTestKit</span> <span class="o">{</span>

  <span class="n">sequential</span>

  <span class="s">&quot;Planets&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="s">&quot;know that Mars has two moons&quot;</span> <span class="o">&gt;&gt;</span> <span class="nc">InMemoryDB</span><span class="o">()</span> <span class="o">{</span>

      <span class="k">val</span> <span class="n">mars</span> <span class="k">=</span> <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Mars&quot;</span><span class="o">))</span>
      <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Phobos&quot;</span><span class="o">).</span><span class="n">planetId</span><span class="o">(</span><span class="n">mars</span><span class="o">.</span><span class="n">idField</span><span class="o">.</span><span class="n">is</span><span class="o">).</span><span class="n">save</span>
      <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Deimos&quot;</span><span class="o">).</span><span class="n">planetId</span><span class="o">(</span><span class="n">mars</span><span class="o">.</span><span class="n">idField</span><span class="o">.</span><span class="n">is</span><span class="o">).</span><span class="n">save</span>

      <span class="n">mars</span><span class="o">.</span><span class="n">satellites</span><span class="o">.</span><span class="n">size</span> <span class="n">must_==</span> <span class="mi">2</span>
    <span class="o">}</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Running this with SBT&#8217;s <span class="monospaced">test</span> command would show a success:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; test
[info] PlanetsSpec
[info]
[info] Planets
[info] + know that Mars has two moons
[info]
[info]
[info] Total for specification PlanetsSpec
[info] Finished in 1 second, 274 ms
[info] 1 example, 0 failure, 0 error
[info]
[info] Passed: : Total 1, Failed 0, Errors 0, Passed 1, Skipped 0
[success] Total time: 3 s, completed 03-Feb-2013 11:31:16</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_65">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">DBTestKit</span> trait has to do quite a lot of work for us.  At the lowest level, it loads the H2 driver and configures Squeryl with an in-memory connection. The <span class="monospaced">mem</span> part of the JDBC connection string (<span class="monospaced">jdbc:h2:mem:dbname;DB_CLOSE_DELAY=-1</span>) means that H2 won&#8217;t try to persist the data to disk.  The database just resides in memory, so there are no files in disk to maintain, and it runs quickly.</p></div>
<div class="paragraph"><p>By default, when a connection is closed, the in memory database is destroyed. In this recipe we&#8217;ve disabled that by adding the <span class="monospaced">DB_CLOSE_DELAY=-1</span>, which will allow us to write unit tests that span connections if we want to.</p></div>
<div class="paragraph"><p>The next step up from connection management is the creation of the database schema in memory. We do this in <span class="monospaced">createDb</span> by throwing away the schema and any data when we start a test, and create it afresh.  If you have very common test datasets, this might be a good place to insert that data before your test runs.</p></div>
<div class="paragraph"><p>These steps are brought together at the <span class="monospaced">InMemoryDB</span> class, which implements a Specs2 interface for code to run <span class="monospaced">Around</span> a test.  We&#8217;ve also wrapped the test around a <span class="monospaced">TestLiftSession</span>. This provides an empty session, which is useful if you are accessing state-related code (such as the <span class="monospaced">S</span> object).  It&#8217;s not necessary for running tests against Record and Squeryl, but it has been included here because you may want to do that at some point.</p></div>
<div class="paragraph"><p>In our specification itself, we mix in the <span class="monospaced">DBTestKit</span> and reference the <span class="monospaced">InMemoryDB</span> context on the tests that access the database.  You&#8217;ll note that we&#8217;ve used <span class="monospaced">&gt;&gt;</span> rather than Specs2&#8217;s <span class="monospaced">should</span> and <span class="monospaced">in</span> that you may have seen elsewhere. This is to avoid name conflicts between Specs2 and Squery that you might come across.</p></div>
<div class="paragraph"><p>As we disabled parallel execution with SBT, we also disable parallel execution in Specs2 with <span class="monospaced">sequential</span>.  We are doing this to prevent a situation where one test might be expecting data that another test is modifying at the same time.</p></div>
<div class="paragraph"><p>If all the tests in a specification are going to use the database, you can use the Specs2 <span class="monospaced">AroundContextExample[T]</span> to avoid having to mention <span class="monospaced">InMemoryDB</span> on every test.  To do that, mix in <span class="monospaced">AroundContextExample[InMemoryDB]</span> and define <span class="monospaced">aroundContext</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.model</span>

<span class="k">import</span> <span class="nn">MySchema._</span>

<span class="k">import</span> <span class="nn">org.specs2.mutable._</span>
<span class="k">import</span> <span class="nn">org.specs2.specification.AroundContextExample</span>
<span class="k">import</span> <span class="nn">net.liftweb.squerylrecord.RecordTypeMode._</span>

<span class="k">class</span> <span class="nc">AlternativePlanetsSpec</span> <span class="k">extends</span> <span class="nc">Specification</span> <span class="k">with</span>
  <span class="nc">AroundContextExample</span><span class="o">[</span><span class="kt">InMemoryDB</span><span class="o">]</span> <span class="o">{</span>

  <span class="n">sequential</span>

  <span class="k">def</span> <span class="n">aroundContext</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">InMemoryDB</span><span class="o">()</span>

  <span class="s">&quot;Solar System&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="s">&quot;know that Mars has two moons&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">{</span>

      <span class="k">val</span> <span class="n">mars</span> <span class="k">=</span> <span class="n">planets</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Mars&quot;</span><span class="o">))</span>
      <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Phobos&quot;</span><span class="o">).</span><span class="n">planetId</span><span class="o">(</span><span class="n">mars</span><span class="o">.</span><span class="n">idField</span><span class="o">.</span><span class="n">is</span><span class="o">).</span><span class="n">save</span>
      <span class="nc">Satellite</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Deimos&quot;</span><span class="o">).</span><span class="n">planetId</span><span class="o">(</span><span class="n">mars</span><span class="o">.</span><span class="n">idField</span><span class="o">.</span><span class="n">is</span><span class="o">).</span><span class="n">save</span>

      <span class="n">mars</span><span class="o">.</span><span class="n">satellites</span><span class="o">.</span><span class="n">size</span> <span class="n">must_==</span> <span class="mi">2</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>All the tests in <span class="monospaced">AlternativePlanetsSpec</span> will now be run with an <span class="monospaced">InMemoryDB</span> around them.</p></div>
<div class="paragraph"><p>We&#8217;ve used a database with an in-memory mode for the advantages of speed and no files to clean up. However, you could use any regular database: you&#8217;d need to change the driver and connection string.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_63">See Also</h4>
<div class="paragraph"><p>See <a href="http://www.h2database.com/html/features.html#in_memory_databases">http://www.h2database.com/html/features.html#in_memory_databases</a> for more about H2&#8217;s in-memory database settings.</p></div>
<div class="paragraph"><p><a href="#MongoUnitTest">[MongoUnitTest]</a> discusses unit testing with MongoDB, but the comments on SBT&#8217;s other testing commands and testing in an IDE would apply to this recipie too.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RandomValueColumn">Store a Random Value in a Column</h3>
<div class="sect3">
<h4 id="_problem_65">Problem</h4>
<div class="paragraph"><p>You need a column to hold a random value.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_65">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">UniqueIdField</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.record.field.UniqueIdField</span>
<span class="k">val</span> <span class="n">randomId</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">UniqueIdField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">32</span><span class="o">)</span> <span class="o">{}</span>
</pre></div></div></div>
<div class="paragraph"><p>Note the <span class="monospaced">{}</span> in the example: this is required as <span class="monospaced">UniqueIdField</span> is an
abstract class.</p></div>
<div class="paragraph"><p>The size value, 32, indicates how many random characters to create.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_66">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">UniqueIdField</span> field is a kind of <span class="monospaced">StringField</span> and the default value for the field
comes from <span class="monospaced">StringHelpers.randomString</span>. The value is randomly generated, but not guaranteed to be unique in the database.</p></div>
<div class="paragraph"><p>The database column backing the <span class="monospaced">UniqueIdField</span> in this recipe will be a <span class="monospaced">varchar(32) not null</span> or similar.  The value stored will look like:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>GOJFGQRLS5GVYGPH3L3HRNXTATG3RM5M</pre>
</div></div>
<div class="paragraph"><p>As the value is made up of just letters and numbers, it makes it easy to use in URLs as there are no characters to escape. For example, it could be used in a link to allow a user to validate their account when sent the link over email, which is one of the uses in <span class="monospaced">ProtoUser</span>.</p></div>
<div class="paragraph"><p>If you need to change the value, the <span class="monospaced">reset</span> method on the field will generate a new random string for the field.</p></div>
<div class="paragraph"><p>If you need an automatic value that is even more likely to be unique per-row, you can add a field that wraps a <em>universally unique identifier</em> (UUID):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">java.util.UUID</span>

<span class="k">val</span> <span class="n">uuid</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">36</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">defaultValue</span> <span class="k">=</span> <span class="nc">UUID</span><span class="o">.</span><span class="n">randomUUID</span><span class="o">().</span><span class="n">toString</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This will automatically insert values of the form "6481a844-460a-a4e0-9191-c808e3051519" in records you create.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_64">See Also</h4>
<div class="paragraph"><p>Java&#8217;s UUID support is described at <a href="http://docs.oracle.com/javase/7/docs/api/java/util/UUID.html">http://docs.oracle.com/javase/7/docs/api/java/util/UUID.html</a> and includes a link to RFC 4122 which defines UUIDs.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylUpdatedCreated">Automatic Created and Updated Timestamps</h3>
<div class="sect3">
<h4 id="_problem_66">Problem</h4>
<div class="paragraph"><p>You want created and updated timestamps on your records and would like them
automatically updated when a row is added or updated.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_66">Solution</h4>
<div class="paragraph"><p>Define the following traits:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.model</span>

<span class="k">import</span> <span class="nn">java.util.Calendar</span>

<span class="k">import</span> <span class="nn">net.liftweb.record.field.DateTimeField</span>
<span class="k">import</span> <span class="nn">net.liftweb.record.Record</span>

<span class="k">trait</span> <span class="nc">Created</span><span class="o">[</span><span class="kt">T</span> <span class="k">&lt;:</span> <span class="kt">Created</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="nc">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
  <span class="n">self</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span>
  <span class="k">val</span> <span class="n">created</span><span class="k">:</span> <span class="kt">DateTimeField</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DateTimeField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">defaultValue</span> <span class="k">=</span> <span class="nc">Calendar</span><span class="o">.</span><span class="n">getInstance</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">Updated</span><span class="o">[</span><span class="kt">T</span> <span class="k">&lt;:</span> <span class="kt">Updated</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="nc">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
  <span class="n">self</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span>

  <span class="k">val</span> <span class="n">updated</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DateTimeField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">defaultValue</span> <span class="k">=</span> <span class="nc">Calendar</span><span class="o">.</span><span class="n">getInstance</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">onUpdate</span> <span class="k">=</span> <span class="k">this</span><span class="o">.</span><span class="n">updated</span><span class="o">(</span><span class="nc">Calendar</span><span class="o">.</span><span class="n">getInstance</span><span class="o">)</span>

<span class="o">}</span>

<span class="k">trait</span> <span class="nc">CreatedUpdated</span><span class="o">[</span><span class="kt">T</span> <span class="k">&lt;:</span> <span class="kt">Updated</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="kt">with</span> <span class="kt">Created</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="nc">extends</span>
  <span class="nc">Updated</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">with</span> <span class="nc">Created</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
    <span class="n">self</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Add the trait to the model. For example, we can modify a <span class="monospaced">Planet</span> record to include
the time the record was created and updated:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Planet</span> <span class="k">private</span> <span class="o">()</span> <span class="k">extends</span> <span class="nc">Record</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span>
  <span class="k">with</span> <span class="nc">KeyedRecord</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="k">with</span> <span class="nc">CreatedUpdated</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Planet</span>
    <span class="c1">// field entries as normal...</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Finally, arrange for the <span class="monospaced">updated</span> field to be updated:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MySchema</span> <span class="k">extends</span> <span class="nc">Schema</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">callbacks</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
    <span class="n">beforeUpdate</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="n">call</span> <span class="o">{</span><span class="k">_</span><span class="o">.</span><span class="n">onUpdate</span><span class="o">}</span>
  <span class="o">)</span>
  <span class="o">...</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_67">Discussion</h4>
<div class="paragraph"><p>Although there is a built in <span class="monospaced">net.liftweb.record.LifecycleCallbacks</span>
trait in which allows you trigger behaviour onUpdate, afterDelete and so
on, it is only for use on individual fields, rather than records. As our
goal is to update the <span class="monospaced">updated</span> field when any part of the Record
changes, we can&#8217;t use the <span class="monospaced">LiftcycleCallbacks</span> here.</p></div>
<div class="paragraph"><p>Instead, the <span class="monospaced">CreatedUpdated</span> trait simplifies adding an <span class="monospaced">updated</span> and
<span class="monospaced">created</span> fields to a Record, but we do need to remember to add a hook
into the schema to ensure the <span class="monospaced">updated</span> value is changed when a record
is modified. This is why we set the <span class="monospaced">callbacks</span> on the Schema.</p></div>
<div class="paragraph"><p>The schema for records with <span class="monospaced">CreatedUpdated</span> mixed in will include two additional columns:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">updated</span> <span class="k">timestamp</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
<span class="n">created</span> <span class="k">timestamp</span> <span class="k">not</span> <span class="k">null</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">timestamp</span> is used for the H2 database.  For other databases the type may be different.</p></div>
<div class="paragraph"><p>The values can be accessed like any other record field.  Using the example data from <a href="#SquerylOneToMany">[SquerylOneToMany]</a> we could run the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">updated</span> <span class="k">:</span> <span class="kt">Calendar</span> <span class="o">=</span> <span class="n">mars</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">id</span>
<span class="k">val</span> <span class="n">created</span> <span class="k">:</span> <span class="kt">Calendar</span> <span class="o">=</span> <span class="n">mars</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">is</span>
</pre></div></div></div>
<div class="paragraph"><p>If you only need created time, or updated time, just mix in the <span class="monospaced">Created[T]</span> or <span class="monospaced">Updaed[T]</span> trait instead of <span class="monospaced">CreatedUpdated[T]</span>.</p></div>
<div class="paragraph"><p>It should be noted that <span class="monospaced">onUpdate</span> is only called on full updates and
not on partial updates with Squeryl. A full update is when the object is
altered and then saved; a partial update is where you attempt to alter
many objects via a query.</p></div>
<div class="paragraph"><p>If you&#8217;re interested in other automations for Record, the Squery schema
callbacks also support other triggered behaviours:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">beforeInsert</span> and <span class="monospaced">afterInsert</span>
</p>
</li>
<li>
<p>
<span class="monospaced">afterSelect</span>
</p>
</li>
<li>
<p>
<span class="monospaced">beforeUpdate</span> and <span class="monospaced">afterUpdate</span>
</p>
</li>
<li>
<p>
<span class="monospaced">beforeDelete</span> and <span class="monospaced">afterDelete</span>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_see_also_65">See Also</h4>
<div class="paragraph"><p>For a discussion of the difference between partial and full updates in Squeryl, see : <a href="http://squeryl.org/inserts-updates-delete.html">http://squeryl.org/inserts-updates-delete.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylLogging">Logging SQL</h3>
<div class="sect3">
<h4 id="_problem_67">Problem</h4>
<div class="paragraph"><p>You want to see the SQL being executed by Squeryl.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_67">Solution</h4>
<div class="paragraph"><p>Add the following anytime you have a Squeryl season, such as just before
your query:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">org</span><span class="o">.</span><span class="n">squeryl</span><span class="o">.</span><span class="nc">Session</span><span class="o">.</span><span class="n">currentSession</span><span class="o">.</span><span class="n">setLogger</span><span class="o">(</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>By providing a <span class="monospaced">String =&gt; Unit</span> function to <span class="monospaced">setLogger</span>, Squeryl will
execute that function with the SQL it runs. In this example, we are
simply printing the SQL to the console.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_68">Discussion</h4>
<div class="paragraph"><p>You&#8217;ll probably want to use the logging facilities in Lift to capture SQL.  For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.snippet</span>

<span class="k">import</span> <span class="nn">net.liftweb.common.Loggable</span>
<span class="k">import</span> <span class="nn">org.squeryl.Session</span>

<span class="k">class</span> <span class="nc">MySnippet</span> <span class="k">extends</span> <span class="nc">Loggable</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">render</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Session</span><span class="o">.</span><span class="n">currentSession</span><span class="o">.</span><span class="n">setLogger</span><span class="o">(</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">)</span>
    <span class="c1">// ...your snippet code here...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This will log queries according to the settings for the logging system, typically the Logback project configured in <span class="monospaced">src/resources/props/default.logback.xml</span>.</p></div>
<div class="paragraph"><p>It can be inconvenient to have to enable logging in each snippet during development.  To trigger logging for all snippets, you can modify the <span class="monospaced">addAround</span> call in <span class="monospaced">Boot.scala</span>.</p></div>
<div class="paragraph"><p>Recall from <a href="#ConfiguringSqueryl">[ConfiguringSqueryl]</a> that this is usually defined as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">S</span><span class="o">.</span><span class="n">addAround</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoanWrapper</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">inTransaction</span> <span class="o">{</span> <span class="n">f</span> <span class="o">}</span>
<span class="o">})</span>
</pre></div></div></div>
<div class="paragraph"><p>To enable logging in each session, we can modify <span class="monospaced">Boot.scala</span> to mix in logging and enable logging on every session:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Boot</span> <span class="k">extends</span> <span class="nc">Loggable</span> <span class="o">{</span>

  <span class="c1">// ...boot as usual here...</span>

  <span class="n">S</span><span class="o">.</span><span class="n">addAround</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoanWrapper</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">inTransaction</span> <span class="o">{</span>
      <span class="nc">Session</span><span class="o">.</span><span class="n">currentSession</span><span class="o">.</span><span class="n">setLogger</span><span class="o">(</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">)</span>
      <span class="n">f</span>
    <span class="o">}</span>
  <span class="o">})</span>

<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_66">See Also</h4>
<div class="paragraph"><p>Squeryl <span class="monospaced">setLogger</span> is documented at: <a href="http://squeryl.org/miscellaneous.html">http://squeryl.org/miscellaneous.html</a>.</p></div>
<div class="paragraph"><p>You can learn about logging in Lift from the Logging wiki page: <a href="https://www.assembla.com/spaces/liftweb/wiki/Logging">https://www.assembla.com/spaces/liftweb/wiki/Logging</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="SquerylMediumText">Model a Column with MySQL MEDIUMTEXT</h3>
<div class="sect3">
<h4 id="_problem_68">Problem</h4>
<div class="paragraph"><p>You want to use MySQL&#8217;s <span class="monospaced">MEDIUMTEXT</span> for a column, but <span class="monospaced">StringField</span>
doesn&#8217;t have this option.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_68">Solution</h4>
<div class="paragraph"><p>Use Squeryl&#8217;s <span class="monospaced">dbType</span> in your schema:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">MySchema</span> <span class="k">extends</span> <span class="nc">Schema</span> <span class="o">{</span>
  <span class="n">on</span><span class="o">(</span><span class="n">mytable</span><span class="o">)(</span><span class="n">t</span> <span class="k">=&gt;</span> <span class="n">declare</span><span class="o">(</span>
    <span class="n">t</span><span class="o">.</span><span class="n">mycolumn</span> <span class="n">defineAs</span> <span class="n">dbType</span><span class="o">(</span><span class="s">&quot;MEDIUMTEXT&quot;</span><span class="o">)</span>
  <span class="o">))</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This schema setting will give you the correct column type in MySQL:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">create</span> <span class="k">table</span> <span class="n">mytable</span> <span class="p">(</span>
    <span class="n">mycolumn</span> <span class="n">MEDIUMTEXT</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
</pre></div></div></div>
<div class="paragraph"><p>On the record you can use <span class="monospaced">StringField</span> as usual.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_69">Discussion</h4>
<div class="paragraph"><p>This recipe hints at the flexibility available with Squery&#8217;s schema definition DSL.  The column attribute in this example is just one of a variety of adjustments you can make to the default choices that Squeryl uses.</p></div>
<div class="paragraph"><p>For example, you can use the syntax to chain column attributes for a single column, and also defined multiple columns at the same time:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">MySchema</span> <span class="k">extends</span> <span class="nc">Schema</span> <span class="o">{</span>
  <span class="n">on</span><span class="o">(</span><span class="n">mytable</span><span class="o">)(</span><span class="n">t</span> <span class="k">=&gt;</span> <span class="n">declare</span><span class="o">(</span>
    <span class="n">t</span><span class="o">.</span><span class="n">mycolumn</span> <span class="n">defineAs</span><span class="o">(</span><span class="n">dbType</span><span class="o">(</span><span class="s">&quot;MEDIUMTEXT&quot;</span><span class="o">),</span><span class="n">indexed</span><span class="o">),</span>
    <span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="n">definedAs</span><span class="o">(</span><span class="n">unique</span><span class="o">,</span> <span class="n">named</span><span class="o">(</span><span class="s">&quot;MY_ID&quot;</span><span class="o">))</span>
  <span class="o">))</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_67">See Also</h4>
<div class="paragraph"><p>The schema definition page for Squeryl gives examples of attributes you can apply to tables and columns: <a href="http://squeryl.org/schema-definition.html">http://squeryl.org/schema-definition.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MySQLCharSet">MySQL Character Set Encoding</h3>
<div class="sect3">
<h4 id="_problem_69">Problem</h4>
<div class="paragraph"><p>Some characters stored in your MySQL database are appearing as <span class="monospaced">???</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_69">Solution</h4>
<div class="paragraph"><p>Ensure that:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">LiftRules.early.append(_.setCharacterEncoding("UTF-8"))</span> is included in <span class="monospaced">Boot.scala</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">?useUnicode=true&amp;characterEncoding=UTF-8</span> is included in your JDBC connections URL.
</p>
</li>
<li>
<p>
Your MySQL database has been created using a UTF-8 character set.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_discussion_70">Discussion</h4>
<div class="paragraph"><p>There are a number of interactions here which can impact characters going into, and coming out of, a MySQL database.  The basic problem is that bytes transferred across networks have no meaning unless you know the encoding.</p></div>
<div class="paragraph"><p>The <span class="monospaced">setCharacterEncoding("UTF-8")</span> call in <span class="monospaced">Boot.scala</span> is being applied to every <span class="monospaced">HTTPRequest</span> which ultimately, in a servlet container, is applied to a <span class="monospaced">ServletRequest</span>. This is how parameters in a request are going to be interpreted by the servlet container when received.</p></div>
<div class="paragraph"><p>The flip side of this is that responses from Lift are encoded as UTF-8.  You&#8217;ll see this in a number of places. For example, <span class="monospaced">templates-hidden/default</span> includes:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;content-type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span> <span class="nt">/&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Also, the <span class="monospaced">LiftResponse</span> classes set the encoding as UTF-8.</p></div>
<div class="paragraph"><p>Another aspect is how character data from Lift is sent to the database over the network.  This is controlled by the parameters to the JDBC driver.  The default for MySQL is to detect the encoding, but it seems from experience that this is not a great option, so we force the UTF-8 encoding.</p></div>
<div class="paragraph"><p>Finally, the MySQL database itself needs to store the data as UTF-8.  The default character encoding is not UTF-8, so you&#8217;ll need to specify the encoding when you create the database:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">myDb</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_68">See Also</h4>
<div class="paragraph"><p>The MySQL JDBC configuration guide is at: <a href="http://dev.mysql.com/doc/refman/5.6/en/connector-j-reference-configuration-properties.html">http://dev.mysql.com/doc/refman/5.6/en/connector-j-reference-configuration-properties.html</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_relational_database_persistence_with_mapper">Relational database persistence with Mapper</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_sequence_numbers_and_existing_data">Sequence numbers and existing data</h3>
<div class="sect3">
<h4 id="_problem_70">Problem</h4>
<div class="paragraph"><p>You have a table with data in it, but Lift inserts new records with a
primary key starting from 1, or some other value that may already exist.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_70">Solution</h4>
<div class="paragraph"><p>Work with the native sequence facility in your database to set the
starting sequence value to be the value you want Lift to use.</p></div>
<div class="paragraph"><p>The first step is to work out what value you want the sequence to start
from. Most likely this will be just after the largest primary key ID in
the table you&#8217;re working with. With PostgreSQL, for example, you can
check this via the <span class="monospaced">psql</span> command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">SELECT</span> <span class="k">MAX</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">mytable</span><span class="p">;</span>
</pre></div></div></div>
<div class="paragraph"><p>To find out what sequences exist, run <span class="monospaced">\ds</span> in <span class="monospaced">psql</span>. The sequence to
change will contain the name of your table. You can then change the
value:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">ALTER</span> <span class="n">SEQUENCE</span> <span class="n">mytable_id_seq</span> <span class="k">RESTART</span> <span class="k">WITH</span> <span class="mi">1000</span><span class="p">;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_71">Discussion</h4>
<div class="paragraph"><p>Lift defers to the database sequence facility to generate primary key
values. If you insert data by-passing the sequence, the sequence value
will not know about the specific primary key values you have used (this
is not Lift-specific). The solution above resolves this by updating the
starting sequence number to skip over the rows that already exist in
your database.</p></div>
<div class="paragraph"><p>The same instructions apply for using Record as well as Mapper.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_69">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
Mailing list discussion "<a href="https://groups.google.com/forum/?fromgroups#!topic/liftweb/eAelsvlFkaI">Mapper starts counting primary keys with key 1 in a non-empty table</a>".
</p>
</li>
<li>
<p>
PostgreSQL <a href="http://www.postgresql.org/docs/9.1/static/functions-sequence.html">Sequence
Manipulation Functions</a>.
</p>
</li>
<li>
<p>
MySQL <a href="http://dev.mysql.com/doc/refman/5.6/en/example-auto-increment.html">AUTO-INCREMENT</a>
describes how to use ALTER TABLE to change the sequence value.
</p>
</li>
<li>
<p>
<a href="http://www.techonthenet.com/oracle/sequences.php">Updating ORACLE sequence</a> involves changing the incrementing step to cover the values to skip.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_detect_if_the_schema_has_changed">Detect if the schema has changed</h3>
<div class="sect3">
<h4 id="_problem_71">Problem</h4>
<div class="paragraph"><p>You do not want to automatically migrate your schema, but you want to
know if it is out of date.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_71">Solution</h4>
<div class="paragraph"><p>Run <span class="monospaced">Schemifier</span> and capture the changes it would make if allowed. For
example, in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">cmds</span> <span class="k">=</span> <span class="nc">Schemifier</span><span class="o">.</span><span class="n">schemify</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="nc">Schemifier</span><span class="o">.</span><span class="n">infoF</span> <span class="k">_</span><span class="o">,</span> <span class="nc">User</span><span class="o">,</span> <span class="nc">Company</span><span class="o">)</span>

<span class="k">if</span> <span class="o">(!</span><span class="n">cmds</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">error</span><span class="o">(</span><span class="s">&quot;Database schema is out of date. The following is missing: \n&quot;</span><span class="o">+</span>
    <span class="n">cmds</span><span class="o">.</span><span class="n">mkString</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">))</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_72">Discussion</h4>
<div class="paragraph"><p>The arguments and return value for <span class="monospaced">schemify</span> are:</p></div>
<div class="ulist"><ul>
<li>
<p>
performWrite - the example uses <span class="monospaced">false</span> meaning the database won&#8217;t be updated.
</p>
</li>
<li>
<p>
structureOnly - <span class="monospaced">true</span> to check the tables and columns (not indexes).
</p>
</li>
<li>
<p>
logFunc - for logging, but only if we are writing to the database, which we are not.
</p>
</li>
<li>
<p>
tables (mapper objects) - the tables to include.
</p>
</li>
<li>
<p>
The result is a <span class="monospaced">List[String]</span> which are the statements required to update the database.
</p>
</li>
</ul></div>
<div class="paragraph"><p>From the above description you may be able to select the parameters that
best fit your needs.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_70">See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/lift/framework/blob/master/persistence/mapper/src/main/scala/net/liftweb/mapper/Schemifier.scala">Schemifier.scala</a> source.
</p>
</li>
<li>
<p>
<a href="https://groups.google.com/forum/?fromgroups#!msg/liftweb/DM4kYVz_Z2c/vO0t-So3vVcJ">Mailing
list discussion</a>.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mongodb_persistence_with_record">MongoDB Persistence with Record</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section gives recipes for making use of MongoDB in your Lift
application. For recipes regarding Mongo itself, check out the MongoDB Cookbook at <a href="http://cookbook.mongodb.org/">http://cookbook.mongodb.org/</a>.</p></div>
<div class="paragraph"><p>Many of the code examples in this chapter can be found in: <a href="https://github.com/LiftCookbook/cookbook_mongo">https://github.com/LiftCookbook/cookbook_mongo</a>.</p></div>
<div class="sect2">
<h3 id="ConnectingToMongo">Connecting to a Mongo Database</h3>
<div class="sect3">
<h4 id="_problem_72">Problem</h4>
<div class="paragraph"><p>You want to connect to a MongoDB.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_72">Solution</h4>
<div class="paragraph"><p>Add the Lift Mongo dependencies to your build and configure a connection using <span class="monospaced">net.liftweb.mongodb</span> and <span class="monospaced">com.mongodb</span>.</p></div>
<div class="paragraph"><p>In <span class="monospaced">Build.sbt</span> add the following to <span class="monospaced">libraryDependencies</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-mongodb-record&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span><span class="o">,</span>
</pre></div></div></div>
<div class="paragraph"><p>In <span class="monospaced">Boot.scala</span> add:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">com.mongodb.</span><span class="o">{</span><span class="nc">ServerAddress</span><span class="o">,</span> <span class="nc">Mongo</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.mongodb.</span><span class="o">{</span><span class="nc">MongoDB</span><span class="o">,</span><span class="nc">DefaultMongoIdentifier</span><span class="o">}</span>

<span class="k">val</span> <span class="n">server</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ServerAddress</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">,</span> <span class="s">&quot;20717&quot;</span><span class="o">)</span>
<span class="nc">MongoDB</span><span class="o">.</span><span class="n">defineDb</span><span class="o">(</span><span class="nc">DefaultMongoIdentifier</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Mongo</span><span class="o">(</span><span class="n">server</span><span class="o">),</span> <span class="s">&quot;mydb&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This will give you a connection to a local MongoDB database called
"mydb".</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_73">Discussion</h4>
<div class="paragraph"><p>If your database needs authentication, use <span class="monospaced">MongoDB.defineDbAuth</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">MongoDB</span><span class="o">.</span><span class="n">defineDbAuth</span><span class="o">(</span><span class="nc">DefaultMongoIdentifier</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Mongo</span><span class="o">(</span><span class="n">server</span><span class="o">),</span>
  <span class="s">&quot;mydb&quot;</span><span class="o">,</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="s">&quot;password&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Some cloud services will give you a URL to connect to, such as
"mongodb://alex.mongohq.com:10050/fglvBskrsdsdsDaGNs1". In this case, the host and
the port make up the first part, and the database name is the part after
the <span class="monospaced">/</span>.</p></div>
<div class="paragraph"><p>If you need to turn a URL like this into a connection, you can do so by
using <span class="monospaced">java.net.URI</span> to parse the URL and make a connection:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">MongoUrl</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">defineDb</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">MongoIdentifier</span><span class="o">,</span> <span class="n">url</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">URI</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">db</span> <span class="k">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">getPath</span> <span class="n">drop</span> <span class="mi">1</span>
    <span class="k">val</span> <span class="n">server</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Mongo</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServerAddress</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="n">getHost</span><span class="o">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">getPort</span><span class="o">))</span>

    <span class="nc">Option</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="n">getUserInfo</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;:&quot;</span><span class="o">))</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">pass</span><span class="o">))</span> <span class="k">=&gt;</span>
        <span class="nc">MongoDB</span><span class="o">.</span><span class="n">defineDbAuth</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">server</span><span class="o">,</span> <span class="n">db</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">pass</span><span class="o">)</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
        <span class="nc">MongoDB</span><span class="o">.</span><span class="n">defineDb</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">server</span><span class="o">,</span> <span class="n">db</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>

<span class="nc">MongoUrl</span><span class="o">.</span><span class="n">defineDb</span><span class="o">(</span><span class="nc">DefaultMongoIdentifier</span><span class="o">,</span>
  <span class="s">&quot;mongodb://user:pass@127.0.0.1:27017/myDb&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>The full URL scheme for MongoDB is more complicated, allowing for multiple hosts and connection parameters, but the above code handles optional user name and password fields and may be enough to get you up and running with your Mongo configuration.</p></div>
<div class="paragraph"><p>The <span class="monospaced">DefaultMongoIdentifier</span> is a value used to identify a particular connection.  Lift keeps a map of identifiers to connections, meaning you can connect to more than on database.  The common case is a single database, and that is usually assigned to <span class="monospaced">DefaultMongoIdentifier</span>.</p></div>
<div class="paragraph"><p>However, if you do need to access two Monogo databases, you can create a new identifier and assign it as part of your record.  For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">OtherMongoIdentifier</span> <span class="k">extends</span> <span class="nc">MongoIdentifier</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">jndiName</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;other&quot;</span>
<span class="o">}</span>

<span class="nc">MongoUrl</span><span class="o">.</span><span class="n">defineDb</span><span class="o">(</span><span class="nc">OtherMongoIdentifier</span><span class="o">,</span> <span class="s">&quot;mongodb://127.0.0.1:27017/other&quot;</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">Country</span> <span class="k">extends</span> <span class="nc">Country</span> <span class="k">with</span> <span class="nc">MongoMetaRecord</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">collectionName</span> <span class="k">=</span> <span class="s">&quot;example.earth&quot;</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">mongoIdentifier</span> <span class="k">=</span> <span class="nc">OtherMongoIdentifier</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">lift-mongodb-record</span> dependency itself depends on another Lift module, <span class="monospaced">lift-mongodb</span>, which provides connectivity and other other lower-level access to MongoDB. Both bottom out with the MongoDB Java driver.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_71">See Also</h4>
<div class="paragraph"><p>Connection configuration that includes replica sets and Mongo options, such as timeout settings, are described on the Lift wiki at:  <a href="https://www.assembla.com/wiki/show/liftweb/Mongo_Configuration">https://www.assembla.com/wiki/show/liftweb/Mongo_Configuration</a>.</p></div>
<div class="paragraph"><p>The full specification for Mongo connection URLs is: <a href="http://docs.mongodb.org/manual/reference/connection-string/">http://docs.mongodb.org/manual/reference/connection-string/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MongoHashMap">Storing a HashMap in a Mongo Record</h3>
<div class="sect3">
<h4 id="_problem_73">Problem</h4>
<div class="paragraph"><p>You want to store a hash map in Mongo.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_73">Solution</h4>
<div class="paragraph"><p>Create a Mongo Record which contains a <span class="monospaced">MongoMapField</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.mongodb.record._</span>
<span class="k">import</span> <span class="nn">net.liftweb.mongodb.record.field._</span>

<span class="k">class</span> <span class="nc">Country</span> <span class="k">private</span> <span class="o">()</span> <span class="k">extends</span> <span class="nc">MongoRecord</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span> <span class="k">with</span> <span class="nc">StringPk</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Country</span>
  <span class="k">object</span> <span class="nc">population</span> <span class="k">extends</span> <span class="nc">MongoMapField</span><span class="o">[</span><span class="kt">Country</span>,<span class="kt">Int</span><span class="o">](</span><span class="k">this</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Country</span> <span class="k">extends</span> <span class="nc">Country</span> <span class="k">with</span> <span class="nc">MongoMetaRecord</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">collectionName</span> <span class="k">=</span> <span class="s">&quot;example.earth&quot;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In this example we are creating a record for information about a country,
and the <span class="monospaced">population</span> is a map from a <span class="monospaced">String</span> key to an <span class="monospaced">Integer</span> value.</p></div>
<div class="paragraph"><p>We can use it in a snippet like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Places</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">uk</span> <span class="k">=</span> <span class="nc">Country</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="s">&quot;uk&quot;</span><span class="o">)</span> <span class="n">openOr</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">info</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span>
      <span class="s">&quot;Brighton&quot;</span> <span class="o">-&gt;</span> <span class="mi">134293</span><span class="o">,</span>
      <span class="s">&quot;Birmingham&quot;</span> <span class="o">-&gt;</span> <span class="mi">970892</span><span class="o">,</span>
      <span class="s">&quot;Liverpool&quot;</span> <span class="o">-&gt;</span> <span class="mi">469017</span><span class="o">)</span>

    <span class="nc">Country</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">id</span><span class="o">(</span><span class="s">&quot;uk&quot;</span><span class="o">).</span><span class="n">population</span><span class="o">(</span><span class="n">info</span><span class="o">).</span><span class="n">save</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">facts</span> <span class="k">=</span> <span class="s">&quot;#facts&quot;</span> <span class="o">#&gt;</span> <span class="o">(</span>
    <span class="k">for</span> <span class="o">{</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="n">pop</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">uk</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">is</span> <span class="o">}</span> <span class="k">yield</span>
      <span class="s">&quot;.name *&quot;</span> <span class="o">#&gt;</span> <span class="n">name</span> <span class="o">&amp;</span> <span class="s">&quot;.pop *&quot;</span> <span class="o">#&gt;</span> <span class="n">pop</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>When this snippet is called, it looks up a record by <span class="monospaced">_id</span> of "uk" or
creates it using some canned information. The template to go with the
snippet could include:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-lift=</span><span class="s">&quot;Places.facts&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;thead&gt;</span>
   <span class="nt">&lt;tr&gt;&lt;th&gt;</span>City<span class="nt">&lt;/th&gt;&lt;th&gt;</span>Population<span class="nt">&lt;/th&gt;&lt;/tr&gt;</span>
  <span class="nt">&lt;/thead&gt;</span>
  <span class="nt">&lt;tbody&gt;</span>
   <span class="nt">&lt;tr</span> <span class="na">id=</span><span class="s">&quot;facts&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Name here<span class="nt">&lt;/td&gt;&lt;td</span> <span class="na">class=</span><span class="s">&quot;pop&quot;</span><span class="nt">&gt;</span>Population<span class="nt">&lt;/td&gt;</span>
   <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/tbody&gt;</span>
 <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>In Mongo the resulting data structure would be:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ mongo cookbook
MongoDB shell version: 2.0.6
connecting to: cookbook
&gt; show collections
example.earth
system.indexes
&gt; db.example.earth.find().pretty()
{
  "_id" : "uk",
  "population" : {
    "Brighton" : 134293,
    "Birmingham" : 970892,
    "Liverpool" : 469017
  }
}</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_74">Discussion</h4>
<div class="paragraph"><p>If you do not set a value for the map, the default will be an empty map, represented in Mongo
as:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>({ "_id" : "uk", "population" : { } })</pre>
</div></div>
<div class="paragraph"><p>An alternative is to mark the field as optional:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">population</span> <span class="k">extends</span> <span class="nc">MongoMapField</span><span class="o">[</span><span class="kt">Country</span>,<span class="kt">Int</span><span class="o">](</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">optional_?</span> <span class="k">=</span> <span class="kc">true</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>If you now write the document without a <span class="monospaced">population</span> set, the field will be omitted in Mongo:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; db.example.earth.find();
{ "_id" : "uk" }</pre>
</div></div>
<div class="paragraph"><p>To append data to the map from your snippet, you can modify the record to supply a
new <span class="monospaced">Map</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">uk</span><span class="o">.</span><span class="n">population</span><span class="o">(</span><span class="n">uk</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">is</span> <span class="o">+</span> <span class="o">(</span><span class="s">&quot;Westminster&quot;</span><span class="o">-&gt;</span><span class="mi">81766</span><span class="o">)).</span><span class="n">update</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that we are using <span class="monospaced">update</span> here, rather than <span class="monospaced">save</span>.  The <span class="monospaced">save</span> method is pretty smart and will either insert a new document into a Mongo collection or <em>replace</em> an existing document based on the <span class="monospaced">_id</span>.  Update is different: it detects just the changed fields of the document and updates them. It will send this command to Mongo for the document:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{ "$set" : { "population" : { "Brighton" : 134293 , "Liverpool" : 469017 ,
  "Birmingham" : 970892 , "Westminster" : 81766} }</pre>
</div></div>
<div class="paragraph"><p>You&#8217;ll probably want to use <span class="monospaced">update</span> over <span class="monospaced">save</span> for changes to existing records.</p></div>
<div class="paragraph"><p>To access an individual element of the map, you can use <span class="monospaced">get</span> (or <span class="monospaced">value</span>):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">uk</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;San Francisco&quot;</span><span class="o">)</span>
<span class="c1">// will throw java.util.NoSuchElementException</span>
</pre></div></div></div>
<div class="paragraph"><p>…or you can access via the standard Scala map interface:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">sf</span> <span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">uk</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">is</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;San Francisco&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="sect4">
<h5 id="_what_a_span_class_monospaced_mongomapfield_span_can_contain">What a <span class="monospaced">MongoMapField</span> Can Contain</h5>
<div class="paragraph"><p>You should be aware that <span class="monospaced">MongoMapField</span> supports only primitive types.</p></div>
<div class="paragraph"><p>The mapped field used in this recipe is typed <span class="monospaced">String =&gt; Int</span>, but of course
Mongo will let you mix types such as putting a <span class="monospaced">String</span> or a <span class="monospaced">Boolean</span> as a population value.
If you do modify the Mongo record in the database outside of Lift and mix types, you&#8217;ll get a <span class="monospaced">java.lang.ClassCastException</span> at
runtime.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_72">See Also</h4>
<div class="paragraph"><p>A discussion on the mailing list regarding the limited type support in <span class="monospaced">MongoMapField</span> and a possible way around it by overriding <span class="monospaced">asDBObject</span> can be found at: <a href="https://groups.google.com/d/msg/liftweb/XoseG-8mIPc/OLyIu6FrHIgJ">https://groups.google.com/d/msg/liftweb/XoseG-8mIPc/OLyIu6FrHIgJ</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MongoEmbedding">Embedding a Document Inside a Mongo Record</h3>
<div class="sect3">
<h4 id="_problem_74">Problem</h4>
<div class="paragraph"><p>You have a Mongo record, and you want to embed another set of values
inside it as a single entity.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_74">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">BsonRecord</span> to define the document to embed, and embed it using
<span class="monospaced">BsonRecordField</span>. Here&#8217;s an example of storing information about an
image within a record:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.record.field.</span><span class="o">{</span><span class="nc">IntField</span><span class="o">,</span><span class="nc">StringField</span><span class="o">}</span>

<span class="k">class</span> <span class="nc">Image</span> <span class="k">private</span> <span class="o">()</span> <span class="k">extends</span> <span class="nc">BsonRecord</span><span class="o">[</span><span class="kt">Image</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Image</span>
  <span class="k">object</span> <span class="nc">url</span> <span class="k">extends</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">1024</span><span class="o">)</span>
  <span class="k">object</span> <span class="nc">width</span> <span class="k">extends</span> <span class="nc">IntField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
  <span class="k">object</span> <span class="nc">height</span> <span class="k">extends</span> <span class="nc">IntField</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Image</span> <span class="k">extends</span> <span class="nc">Image</span> <span class="k">with</span> <span class="nc">BsonMetaRecord</span><span class="o">[</span><span class="kt">Image</span><span class="o">]</span>
</pre></div></div></div>
<div class="paragraph"><p>We can reference instances of the <span class="monospaced">Image</span> class via <span class="monospaced">BsonRecordField</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Country</span> <span class="k">private</span> <span class="o">()</span> <span class="k">extends</span> <span class="nc">MongoRecord</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span> <span class="k">with</span> <span class="nc">StringPk</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Country</span>
  <span class="k">object</span> <span class="nc">flag</span> <span class="k">extends</span> <span class="nc">BsonRecordField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">Image</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Country</span> <span class="k">extends</span> <span class="nc">Country</span> <span class="k">with</span> <span class="nc">MongoMetaRecord</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">collectionName</span> <span class="k">=</span> <span class="s">&quot;example.earth&quot;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>To associate a value:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">unionJack</span> <span class="k">=</span>
  <span class="nc">Image</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">url</span><span class="o">(</span><span class="s">&quot;http://bit.ly/unionflag200&quot;</span><span class="o">).</span><span class="n">width</span><span class="o">(</span><span class="mi">200</span><span class="o">).</span><span class="n">height</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>

<span class="n">uk</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">id</span><span class="o">(</span><span class="s">&quot;uk&quot;</span><span class="o">).</span><span class="n">flag</span><span class="o">(</span><span class="n">unionJack</span><span class="o">).</span><span class="n">save</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>In Mongo, the resulting data structure would be:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; db.example.earth.findOne()
{
  "_id" : "uk",
  "flag" : {
    "url" : "http://bit.ly/unionflag200",
    "width" : 200,
    "height" : 100
  }
}</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_75">Discussion</h4>
<div class="paragraph"><p>If you don&#8217;t set a value on the embedded document, the default will be
saved as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s2">&quot;flag&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;width&quot;</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>You can prevent this by making the image optional:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">image</span> <span class="k">extends</span> <span class="nc">BsonRecordField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">Image</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">optional_?</span> <span class="k">=</span> <span class="kc">true</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>With <span class="monospaced">optional_?</span> set in this way the image part of the Mongo document
won&#8217;t be saved if the value is not set. Within Scala you will then want
to access the value with <span class="monospaced">valueBox</span> call:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">img</span> <span class="k">:</span> <span class="kt">Box</span><span class="o">[</span><span class="kt">Image</span><span class="o">]</span> <span class="k">=</span> <span class="n">uk</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">valueBox</span>
</pre></div></div></div>
<div class="paragraph"><p>In fact, regardless of the setting of <span class="monospaced">optional_?</span> you can access the
value using <span class="monospaced">valueBox</span>.</p></div>
<div class="paragraph"><p>An alternative is optional values is to always provide a default value for the embedded
document:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">object</span> <span class="nc">image</span> <span class="k">extends</span> <span class="nc">BsonRecordField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">Image</span><span class="o">)</span> <span class="o">{</span>
 <span class="k">override</span> <span class="k">def</span> <span class="n">defaultValue</span> <span class="k">=</span>
  <span class="nc">Image</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">url</span><span class="o">(</span><span class="s">&quot;http://bit.ly/unionflag200&quot;</span><span class="o">).</span><span class="n">width</span><span class="o">(</span><span class="mi">200</span><span class="o">).</span><span class="n">height</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_73">See Also</h4>
<div class="paragraph"><p>The Lift Wiki describes BsonRecord in more detail at: <a href="https://www.assembla.com/spaces/liftweb/wiki/Mongo_Record_Embedded_Objects">https://www.assembla.com/spaces/liftweb/wiki/Mongo_Record_Embedded_Objects</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_linking_between_mongo_records">Linking Between Mongo Records</h3>
<div class="sect3">
<h4 id="_problem_75">Problem</h4>
<div class="paragraph"><p>You have a Mongo record and want to include a link to another record.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_75">Solution</h4>
<div class="paragraph"><p>Create a reference using a <span class="monospaced">MongoRefField</span> such as <span class="monospaced">ObjectIdRefField</span> or
<span class="monospaced">StringRefField</span>, and dereference the record using the <span class="monospaced">obj</span> call.</p></div>
<div class="paragraph"><p>As an example we can create records representing countries, where a
country references the planet where you can find it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Planet</span> <span class="k">private</span><span class="o">()</span> <span class="k">extends</span> <span class="nc">MongoRecord</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="k">with</span> <span class="nc">StringPk</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Planet</span>
  <span class="k">object</span> <span class="nc">review</span> <span class="k">extends</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span><span class="mi">1024</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Planet</span> <span class="k">extends</span> <span class="nc">Planet</span> <span class="k">with</span> <span class="nc">MongoMetaRecord</span><span class="o">[</span><span class="kt">Planet</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">collectionName</span> <span class="k">=</span> <span class="s">&quot;example.planet&quot;</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Country</span> <span class="k">private</span> <span class="o">()</span> <span class="k">extends</span> <span class="nc">MongoRecord</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span> <span class="k">with</span> <span class="nc">StringPk</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">Country</span>
  <span class="k">object</span> <span class="nc">planet</span> <span class="k">extends</span> <span class="nc">StringRefField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">Planet</span><span class="o">,</span> <span class="mi">128</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Country</span> <span class="k">extends</span> <span class="nc">Country</span> <span class="k">with</span> <span class="nc">MongoMetaRecord</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">collectionName</span> <span class="k">=</span> <span class="s">&quot;example.country&quot;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In a snippet we can make us of the link:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HelloWorld</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">uk</span> <span class="k">=</span> <span class="nc">Country</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="s">&quot;uk&quot;</span><span class="o">)</span> <span class="n">openOr</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">earth</span> <span class="k">=</span> <span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">id</span><span class="o">(</span><span class="s">&quot;earth&quot;</span><span class="o">).</span><span class="n">review</span><span class="o">(</span><span class="s">&quot;Harmless&quot;</span><span class="o">).</span><span class="n">save</span>
    <span class="nc">Country</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">id</span><span class="o">(</span><span class="s">&quot;uk&quot;</span><span class="o">).</span><span class="n">planet</span><span class="o">(</span><span class="n">earth</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">is</span><span class="o">).</span><span class="n">save</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">facts</span> <span class="k">=</span>
    <span class="s">&quot;.country *&quot;</span> <span class="o">#&gt;</span> <span class="n">uk</span><span class="o">.</span><span class="n">id</span> <span class="o">&amp;</span>
    <span class="s">&quot;.planet&quot;</span> <span class="o">#&gt;</span> <span class="n">uk</span><span class="o">.</span><span class="n">planet</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">p</span> <span class="k">=&gt;</span>
      <span class="s">&quot;.name *&quot;</span> <span class="o">#&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="o">&amp;</span>
      <span class="s">&quot;.review *&quot;</span> <span class="o">#&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">review</span> <span class="o">}</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>For the value <span class="monospaced">uk</span> we lookup an existing record, or create one if none
is found. Note that <span class="monospaced">earth</span> is created as a separate Mongo record, and
then referenced in the <span class="monospaced">planet</span> field with the id of the planet.</p></div>
<div class="paragraph"><p>Retrieving the reference is via the <span class="monospaced">obj</span> method, which returns a
<span class="monospaced">Box[Planet]</span> in this example.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_76">Discussion</h4>
<div class="paragraph"><p>Referenced records are fetched from Mongo when you call the <span class="monospaced">obj</span> method
on a <span class="monospaced">MongoRefField</span>. You can see this by turning on logging in the
Mongo driver. Do this by adding the following to the start of your
<span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">System</span><span class="o">.</span><span class="n">setProperty</span><span class="o">(</span><span class="s">&quot;DEBUG.MONGO&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">)</span>
<span class="nc">System</span><span class="o">.</span><span class="n">setProperty</span><span class="o">(</span><span class="s">&quot;DB.TRACE&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Having done this, the first time you run the snippet above your console
will include:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>INFO: find: cookbook.example.country { "_id" : "uk"}
INFO: update: cookbook.example.planet { "_id" : "earth"} { "_id" : "earth" ,
    "review" : "Harmless"}
INFO: update: cookbook.example.country { "_id" : "uk"} { "_id" : "uk" ,
    "planet" : "earth"}
INFO: find: cookbook.example.planet { "_id" : "earth"}</pre>
</div></div>
<div class="paragraph"><p>What you&#8217;re seeing here is the initial look up for "uk", followed by the
creation of the "earth" record and an update which is saving the "uk"
record. Finally, there is a lookup of "earth" when <span class="monospaced">uk.obj</span> is called in
the <span class="monospaced">fact</span> method.</p></div>
<div class="paragraph"><p>The <span class="monospaced">obj</span> call will cache the <span class="monospaced">planet</span> reference. That means you could
say&#8230;</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;.country *&quot;</span> <span class="o">#&gt;</span> <span class="n">uk</span><span class="o">.</span><span class="n">id</span> <span class="o">&amp;</span>
<span class="s">&quot;.planet *&quot;</span> <span class="o">#&gt;</span> <span class="n">uk</span><span class="o">.</span><span class="n">planet</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">id</span><span class="o">)</span> <span class="o">&amp;</span>
<span class="s">&quot;.review *&quot;</span> <span class="o">#&gt;</span> <span class="n">uk</span><span class="o">.</span><span class="n">planet</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">review</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>&#8230;and you&#8217;d still only see one query for the "earth" record despite
calling <span class="monospaced">obj</span> multiple times. The flip side of that is if the "earth"
record was updated elsewhere in Mongo after you called <span class="monospaced">obj</span> you would
not see the change from a call to <span class="monospaced">uk.obj</span> unless you reloaded the <span class="monospaced">uk</span>
record first.</p></div>
<div class="sect4">
<h5 id="_querying_by_reference">Querying by Reference</h5>
<div class="paragraph"><p>Searching for records by a reference is straight-forward:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">earth</span> <span class="k">:</span> <span class="kt">Planet</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">val</span> <span class="n">onEarth</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span><span class="k">=</span> <span class="nc">Country</span><span class="o">.</span><span class="n">findAll</span><span class="o">(</span><span class="nc">Country</span><span class="o">.</span><span class="n">planet</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="n">earth</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">is</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Or in this case, because we have <span class="monospaced">String</span> references, we could just say:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">onEarth</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span><span class="k">=</span> <span class="nc">Country</span><span class="o">.</span><span class="n">findAll</span><span class="o">(</span><span class="nc">Country</span><span class="o">.</span><span class="n">planet</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="s">&quot;earth&quot;</span><span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect4">
<h5 id="_updating_and_deleting">Updating and Deleting</h5>
<div class="paragraph"><p>Updating a reference is as you&#8217;d expect:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">uk</span><span class="o">.</span><span class="n">planet</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">review</span><span class="o">(</span><span class="s">&quot;Mostly harmless.&quot;</span><span class="o">).</span><span class="n">update</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This would result in the changed field being set:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>INFO: update: cookbook.example.planet { "_id" : "earth"} { "$set" : {
   "review" : "Mostly harmless."}}</pre>
</div></div>
<div class="paragraph"><p>A <span class="monospaced">uk.planet.obj</span> call will now return a planet with the new review.</p></div>
<div class="paragraph"><p>Or you could replace the reference with another:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">uk</span><span class="o">.</span><span class="n">planet</span><span class="o">(</span> <span class="nc">Planet</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">id</span><span class="o">(</span><span class="s">&quot;mars&quot;</span><span class="o">).</span><span class="n">save</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">is</span> <span class="o">).</span><span class="n">save</span>
</pre></div></div></div>
<div class="paragraph"><p>Again, note that the reference is via the id of the record (<span class="monospaced">save.id.is</span>), not the record itself.</p></div>
<div class="paragraph"><p>To remove the reference:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">uk</span><span class="o">.</span><span class="n">planet</span><span class="o">(</span><span class="nc">Empty</span><span class="o">).</span><span class="n">save</span>
</pre></div></div></div>
<div class="paragraph"><p>This removes the link, but the Mongo record pointed to by the link will remain in the database. If you remove
the object being referenced, a later call to <span class="monospaced">obj</span> will return an
<span class="monospaced">Empty</span> box.</p></div>
</div>
<div class="sect4">
<h5 id="_types_of_link">Types of Link</h5>
<div class="paragraph"><p>The example uses a <span class="monospaced">StringRefField</span> as the Mongo records themselves use <span class="monospaced">String</span> as the <span class="monospaced">_id</span>. Other reference types are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">ObjectIdRefField</span>&#8201;&#8212;&#8201;possibly the most frequently used kind of reference, when you want to reference via the usual default <span class="monospaced">ObjectId</span> reference in Mongo.
</p>
</li>
<li>
<p>
<span class="monospaced">UUIDRefField</span>&#8201;&#8212;&#8201;for records with an ID based on <span class="monospaced">java.util.UUID</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">StringRefField</span>&#8201;&#8212;&#8201;as used in this example, where you control the ID as a <span class="monospaced">String</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">IntRefField</span> and <span class="monospaced">LongRefField</span>&#8201;&#8212;&#8201;for when you&#8217;re using a numeric value as an ID.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_74">See Also</h4>
<div class="paragraph"><p>10Gen Inc&#8217;s <em>Data Modeling Decisions</em> describes embedding of documents compared to referencing objects. You&#8217;ll find the article at: <a href="http://docs.mongodb.org/manual/core/data-modeling/">http://docs.mongodb.org/manual/core/data-modeling/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="QueryingWithRogue">Using Rogue</h3>
<div class="sect3">
<h4 id="_problem_76">Problem</h4>
<div class="paragraph"><p>You want to use Foursquare&#8217;s type-safe domain specific language (DSL), Rogue, for querying and updating Mongo records.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_76">Solution</h4>
<div class="paragraph"><p>You need to include the Rogue dependency in your build and import Rogue into your code.</p></div>
<div class="paragraph"><p>For the first step, edit <span class="monospaced">build.sbt</span> and add:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;com.foursquare&quot;</span> <span class="o">%%</span> <span class="s">&quot;rogue&quot;</span> <span class="o">%</span> <span class="s">&quot;1.1.8&quot;</span> <span class="n">intransitive</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>In your code <span class="monospaced">import com.foursquare.rogue._</span> and then start using Rogue.  For example, using the Scala console (see <a href="#MongoScalaConsole">[MongoScalaConsole]</a>):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">com.foursquare.rogue.Rogue._</span>
<span class="k">import</span> <span class="nn">com.foursquare.rogue.Rogue._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">code.model._</span>
<span class="k">import</span> <span class="nn">code.model._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Country</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">id</span> <span class="n">eqs</span> <span class="s">&quot;uk&quot;</span><span class="o">).</span><span class="n">fetch</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">code.model.Country</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="k">class</span> <span class="nc">code</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="nc">Country</span><span class="o">={</span><span class="nc">_id</span><span class="k">=</span><span class="n">uk</span><span class="o">,</span>
  <span class="n">population</span><span class="k">=</span><span class="nc">Map</span><span class="o">(</span><span class="nc">Brighton</span><span class="o">-&gt;</span><span class="mi">134293</span><span class="o">,</span> <span class="nc">Liverpool</span><span class="o">-&gt;</span><span class="mi">469017</span><span class="o">,</span> <span class="nc">Birmingham</span><span class="o">-&gt;</span><span class="mi">970892</span><span class="o">)})</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Country</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">id</span> <span class="n">eqs</span> <span class="s">&quot;uk&quot;</span><span class="o">).</span><span class="n">count</span>
<span class="n">res2</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Country</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">id</span> <span class="n">eqs</span> <span class="s">&quot;uk&quot;</span><span class="o">).</span>
  <span class="n">modify</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">population</span> <span class="n">at</span> <span class="s">&quot;Brighton&quot;</span> <span class="n">inc</span> <span class="mi">1</span><span class="o">).</span><span class="n">updateOne</span><span class="o">()</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_77">Discussion</h4>
<div class="paragraph"><p>Rogue is able to use information in your Lift Record to offer an elegant way to query and update records. It&#8217;s type safe meaning, for example, if you try to use an <span class="monospaced">Int</span> where a <span class="monospaced">String</span> is expected in a query, Mongo would allow that and fail to find results at runtime, but Rogue enables Scala to reject the query at compile timeRogue</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Country</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">id</span> <span class="n">eqs</span> <span class="mi">7</span><span class="o">).</span><span class="n">fetch</span>
<span class="o">&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">20</span><span class="k">:</span> <span class="kt">error:</span> <span class="k">type</span> <span class="kt">mismatch</span><span class="o">;</span>
 <span class="n">found</span>   <span class="k">:</span> <span class="kt">Int</span><span class="o">(</span><span class="err">7</span><span class="o">)</span>
 <span class="kt">required:</span> <span class="kt">String</span>
              <span class="nc">Country</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">id</span> <span class="n">eqs</span> <span class="mi">7</span><span class="o">).</span><span class="n">fetch</span>
</pre></div></div></div>
<div class="paragraph"><p>The DSL constructs a query which we then <span class="monospaced">fetch</span> to send the query to MongoDB. That last method, <span class="monospaced">fetch</span>, is just one of the ways to run the query. Others include:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">count</span>&#8201;&#8212;&#8201;queries Mongo for the size of the result set.
</p>
</li>
<li>
<p>
<span class="monospaced">countDistinct</span>&#8201;&#8212;&#8201;the number of distinct values in the results.
</p>
</li>
<li>
<p>
<span class="monospaced">exists</span>&#8201;&#8212;&#8201;true if there&#8217;s any record that matches the query.
</p>
</li>
<li>
<p>
<span class="monospaced">get</span>&#8201;&#8212;&#8201;returns an <span class="monospaced">Option[T]</span> from the query.
</p>
</li>
<li>
<p>
<span class="monospaced">fetch(limit: Int)</span>&#8201;&#8212;&#8201;like <span class="monospaced">fetch</span> but returns at most <span class="monospaced">limit</span> results.
</p>
</li>
<li>
<p>
<span class="monospaced">updateOne</span>, <span class="monospaced">updateMulti</span>, <span class="monospaced">upsertOne</span> and <span class="monospaced">upsertMulti</span>&#8201;&#8212;&#8201;modify a single document, or all documents, that match the query.
</p>
</li>
<li>
<p>
<span class="monospaced">findAndDeleteOne</span> and <span class="monospaced">bulkDelete_!!</span>&#8201;&#8212;&#8201;to delete records.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The query language itself is expressive, and the best place to explore the variety of queries is in the <span class="monospaced">QueryTest</span> specification in the source for Rogue.  You&#8217;ll find a link to this in the README of the project on Github.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Rogue is working towards a v2 release which introduces a number of new concepts. If you want to give it a try, take a look at the
instructions and comments on the Rogue
mailing list at: <a href="https://groups.google.com/d/topic/rogue-users/SdtFCU-w3ng/">https://groups.google.com/d/topic/rogue-users/SdtFCU-w3ng/</a>.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_75">See Also</h4>
<div class="paragraph"><p>For geospacial queries, see <a href="#MongoGeospatial">[MongoGeospatial]</a>.</p></div>
<div class="paragraph"><p>The README page for Rogue is a great starting point, and includes a link to <span class="monospaced">QueryTest</span> giving plenty of example queries to crib from: <a href="https://github.com/foursquare/rogue">https://github.com/foursquare/rogue</a>.</p></div>
<div class="paragraph"><p>The motivation for Rogue is described in a Foursquare engineering blog post: <a href="http://engineering.foursquare.com/2011/01/21/rogue-a-type-safe-scala-dsl-for-querying-mongodb/">http://engineering.foursquare.com/2011/01/21/rogue-a-type-safe-scala-dsl-for-querying-mongodb/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MongoGeospatial">Storing Geospatial Values</h3>
<div class="sect3">
<h4 id="_problem_77">Problem</h4>
<div class="paragraph"><p>You want to store latitude and longitude information in Mongo.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_77">Solution</h4>
<div class="paragraph"><p>Use Rogue&#8217;s <span class="monospaced">LatLong</span> class to embed location information in your model. For
example, we can store the location of a city like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">com.foursquare.rogue.Rogue._</span>
<span class="k">import</span> <span class="nn">com.foursquare.rogue.LatLong</span>

<span class="k">class</span> <span class="nc">City</span> <span class="k">private</span> <span class="o">()</span> <span class="k">extends</span> <span class="nc">MongoRecord</span><span class="o">[</span><span class="kt">City</span><span class="o">]</span> <span class="k">with</span> <span class="nc">ObjectIdPk</span><span class="o">[</span><span class="kt">City</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">meta</span> <span class="k">=</span> <span class="nc">City</span>

  <span class="k">object</span> <span class="nc">name</span> <span class="k">extends</span> <span class="nc">StringField</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">60</span><span class="o">)</span>

  <span class="k">object</span> <span class="nc">loc</span> <span class="k">extends</span> <span class="nc">MongoCaseClassField</span><span class="o">[</span><span class="kt">City</span>, <span class="kt">LatLong</span><span class="o">](</span><span class="k">this</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">City</span> <span class="k">extends</span> <span class="nc">City</span> <span class="k">with</span> <span class="nc">MongoMetaRecord</span><span class="o">[</span><span class="kt">City</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">net.liftweb.mongodb.BsonDSL._</span>
  <span class="n">ensureIndex</span><span class="o">(</span><span class="n">loc</span><span class="o">.</span><span class="n">name</span> <span class="o">-&gt;</span> <span class="s">&quot;2d&quot;</span><span class="o">,</span> <span class="n">unique</span><span class="k">=</span><span class="kc">true</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">collectionName</span> <span class="k">=</span> <span class="s">&quot;example.city&quot;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We can store values like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">place</span> <span class="k">=</span> <span class="nc">LatLong</span><span class="o">(</span><span class="mf">50.819059</span><span class="o">,</span> <span class="o">-</span><span class="mf">0.136642</span><span class="o">)</span>
<span class="k">val</span> <span class="n">city</span> <span class="k">=</span> <span class="nc">City</span><span class="o">.</span><span class="n">createRecord</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&quot;Brighton, UK&quot;</span><span class="o">).</span><span class="n">loc</span><span class="o">(</span><span class="n">pos</span><span class="o">).</span><span class="n">save</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This will produce data in Mongo that looks like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;50f2f9d43004ad90bbc06b83&quot;</span><span class="p">),</span>
  <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;Brighton, UK&quot;</span><span class="p">,</span>
  <span class="s2">&quot;loc&quot;</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;lat&quot;</span> <span class="o">:</span> <span class="mf">50.819059</span><span class="p">,</span>
    <span class="s2">&quot;long&quot;</span> <span class="o">:</span> <span class="o">-</span><span class="mf">0.136642</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_78">Discussion</h4>
<div class="paragraph"><p>MongoDB supports <em>geospatial indexes</em>, and we&#8217;re making use of this by doing two things.  First,
we are storing the location information in one of MongoDB&#8217;s permitted formats.  The format is
an embedding document containing the coordinates. We could also have use a array of two values
to represent the point.</p></div>
<div class="paragraph"><p>Second, we&#8217;re creating a index of type "2d", which allows us to use Mongo&#8217;s geospatial functions such as <span class="monospaced">$near</span> and <span class="monospaced">$within</span>. The <span class="monospaced">unique=true</span> in the <span class="monospaced">ensureIndex</span> highlights that you can control
whether locations needs to be unique (<span class="monospaced">true</span>, no duplications) or not (<span class="monospaced">false</span>).</p></div>
<div class="paragraph"><p>With regard to the unique index, you&#8217;ll note that we&#8217;re calling <span class="monospaced">save(true)</span> on the <span class="monospaced">City</span> in
this example, rather than the plain <span class="monospaced">save</span> in most other recipes.  We could use <span class="monospaced">save</span> here, and
it would work fine, but difference is that <span class="monospaced">save(true)</span> raises the <em>write concern</em> level
from "normal" to "safe".</p></div>
<div class="paragraph"><p>With the normal write concern, the call to <span class="monospaced">save</span> would return as soon
as the request has gone down the wire to the Mongo server.  This gives a certain degree of reliability in that
<span class="monospaced">save</span> would fail if the network had gone away. However, there&#8217;s no indication that the server has
processed the request.  For example, if we tried to insert a city at the exact same location as one that was already in the database, the index uniqueness rule would be violated and the record would not be saved.  With just <span class="monospaced">save</span> (or <span class="monospaced">save(false)</span>) our Lift application would not receive this error, and the call would fail silently. Raising the concern to "safe" causes <span class="monospaced">save(true)</span> to wait for an acknowledgment from the Mongo server, which means the application will receive exceptions for some kinds of errors.</p></div>
<div class="paragraph"><p>As an example, if we tried to insert a duplicate city, our call to <span class="monospaced">save(true)</span> would result in:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">com</span><span class="o">.</span><span class="n">mongodb</span><span class="o">.</span><span class="nc">MongoException$DuplicateKey</span><span class="k">:</span> <span class="kt">E11000</span> <span class="kt">duplicate</span> <span class="kt">key</span>
  <span class="n">error</span> <span class="n">index</span><span class="k">:</span> <span class="kt">cookbook.example.city.$loc_2d</span>
</pre></div></div></div>
<div class="paragraph"><p>There are other levels of write concern, available via another variant of <span class="monospaced">save</span> which takes a <span class="monospaced">WriteConcern</span> as an argument.</p></div>
<div class="paragraph"><p>If you ever need to drop an index, the MongoDB command is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>db.example.city.dropIndex( "loc_2d" )</pre>
</div></div>
<div class="sect4">
<h5 id="_querying">Querying</h5>
<div class="paragraph"><p>The reason this recipe uses Rogue&#8217;s <span class="monospaced">LatLong</span> class is to enable us to query using the Rogue DSL.  Suppose we&#8217;ve inserted other cities into our collection:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; db.example.city.find({}, {_id:0} )
{"name": "London, UK", "loc": {"lat": 51.5, "long": -0.166667} }
{"name": "Brighton, UK", "loc": {"lat": 50.819059, "long": -0.136642} }
{"name": "Paris, France", "loc": {"lat": 48.866667, "long": 2.333333} }
{"name": "Berlin, Germany", "loc": {"lat": 52.533333, "long": 13.416667} }
{"name": "Sydney, Australia", "loc": {"lat": -33.867387, "long": 151.207629} }
{"name": "New York, USA", "loc": {"lat": 40.714623, "long": -74.006605} }</pre>
</div></div>
<div class="paragraph"><p>We can now find those cities within a 500km of London:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">com.foursquare.rogue.</span><span class="o">{</span><span class="nc">LatLong</span><span class="o">,</span> <span class="nc">Degrees</span><span class="o">}</span>

<span class="k">val</span> <span class="n">centre</span> <span class="k">=</span> <span class="nc">LatLong</span><span class="o">(</span><span class="mf">51.5</span><span class="o">,</span> <span class="o">-</span><span class="mf">0.166667</span><span class="o">)</span>
<span class="k">val</span> <span class="n">radius</span> <span class="k">=</span> <span class="nc">Degrees</span><span class="o">(</span> <span class="o">(</span><span class="mi">500</span> <span class="o">/</span> <span class="mf">6378.137</span><span class="o">).</span><span class="n">toDegrees</span> <span class="o">)</span>
<span class="k">val</span> <span class="n">nearby</span> <span class="k">=</span> <span class="nc">City</span><span class="o">.</span><span class="n">where</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">loc</span> <span class="n">near</span> <span class="o">(</span><span class="n">centre</span><span class="o">.</span><span class="n">lat</span><span class="o">,</span> <span class="n">centre</span><span class="o">.</span><span class="n">long</span><span class="o">,</span> <span class="n">radius</span><span class="o">)</span> <span class="o">).</span><span class="n">fetch</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>This would query MongoDB with this clause&#8230;</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{ "loc" : { "$near" : [ 51.5 , -0.166667 , 4.491576420597608]}}</pre>
</div></div>
<div class="paragraph"><p>&#8230;which will identify London, Brighton and Paris as near to London.</p></div>
<div class="paragraph"><p>The form of the query is a centre point and a spherical radius.  Records falling
inside that radius match the query and are returned closest first. We calculate
the radius in radians: 500km divided by the radius of the Earth, approximately 6378km, gives
us an angle in radians. We convert this to <span class="monospaced">Degrees</span> as required by Rogue.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_76">See Also</h4>
<div class="paragraph"><p>The MongoDB manual discusses geospatial index at: <a href="http://docs.mongodb.org/manual/core/geospatial-indexes/">http://docs.mongodb.org/manual/core/geospatial-indexes/</a>.</p></div>
<div class="paragraph"><p>You can learn more about write concerns at <a href="http://docs.mongodb.org/manual/core/write-operations/">http://docs.mongodb.org/manual/core/write-operations/</a>, and
the various values to pass to <span class="monospaced">save</span> are described in the Java MongoDB driver: <a href="http://api.mongodb.org/java/current/">http://api.mongodb.org/java/current/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MongoScalaConsole">Running Queries from the Scala Console</h3>
<div class="sect3">
<h4 id="_problem_78">Problem</h4>
<div class="paragraph"><p>You want to try out a few queries interactively from the Scala console.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_78">Solution</h4>
<div class="paragraph"><p>Start the console from your project, call <span class="monospaced">boot()</span>, and then interact with your model.</p></div>
<div class="paragraph"><p>For example, using the
Mongo records developed as part of <a href="#ConnectingToMongo">[ConnectingToMongo]</a>, we can perform a basic query:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sbt
...
&gt; console
[info] Compiling 1 Scala source to /cookbook_mongo/target/scala-2.9.1/classes...
[info] Starting scala interpreter...
[info]
Welcome to Scala version 2.9.1.final ...
Type in expressions to have them evaluated.
Type :help for more information.

scala&gt; import bootstrap.liftweb._
import bootstrap.liftweb._

scala&gt; new Boot().boot

scala&gt; import code.model._
import code.model._

scala&gt; Country.findAll
res2: List[code.model.Country] = List(class code.model.Country={_id=uk,
  population=Map(Brighton -&gt; 134293, Liverpool -&gt; 469017,
  Birmingham -&gt; 970892)})

scala&gt; :q</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_79">Discussion</h4>
<div class="paragraph"><p>Running everything in <span class="monospaced">Boot</span> may be a little heavy handed, especially if you starting up various services and background tasks.  All we need to do is define a database connection. For example, using the example code presented in <a href="#ConnectingToMongo">[ConnectingToMongo]</a>, we could initialise a conection with:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>scala&gt; import bootstrap.liftweb._
import bootstrap.liftweb._

scala&gt; import net.liftweb.mongodb._
import net.liftweb.mongodb._

scala&gt; MongoUrl.defineDb(DefaultMongoIdentifier,
  "mongodb://127.0.0.1:27017/cookbook")

scala&gt; Country.findAll
res2: List[code.model.Country] = List(class code.model.Country={_id=uk,
  population=Map(Brighton -&gt; 134293, Liverpool -&gt; 469017,
    Birmingham -&gt; 970892)})</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_77">See Also</h4>
<div class="paragraph"><p><a href="#ConnectingToMongo">[ConnectingToMongo]</a> for connecting to MongoDB and <a href="#QueryingWithRogue">[QueryingWithRogue]</a> for querying with Rogue.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="MongoUnitTest">Unit Testing Record with Mongo</h3>
<div class="sect3">
<h4 id="_problem_79">Problem</h4>
<div class="paragraph"><p>You want to write unit tests to run against your Lift Record code with MongoDB.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_79">Solution</h4>
<div class="paragraph"><p>Using the Specs2 testing framework, surround your specification with a <em>context</em> which creates and connects to a database for each test and destroys it after the test runs.</p></div>
<div class="paragraph"><p>Create a Scala trait to set up and destroy a connection to Mongo.  We&#8217;ll be mixing this trait into your specifications:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.http.</span><span class="o">{</span><span class="nc">Req</span><span class="o">,</span> <span class="n">S</span><span class="o">,</span> <span class="nc">LiftSession</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.StringHelpers</span>
<span class="k">import</span> <span class="nn">net.liftweb.common.Empty</span>
<span class="k">import</span> <span class="nn">net.liftweb.mongodb._</span>
<span class="k">import</span> <span class="nn">com.mongodb.ServerAddress</span>
<span class="k">import</span> <span class="nn">com.mongodb.Mongo</span>
<span class="k">import</span> <span class="nn">org.specs2.mutable.Around</span>
<span class="k">import</span> <span class="nn">org.specs2.execute.Result</span>

<span class="k">trait</span> <span class="nc">MongoTestKit</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">server</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Mongo</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServerAddress</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">,</span> <span class="mi">27017</span><span class="o">))</span>

  <span class="k">def</span> <span class="n">dbName</span> <span class="k">=</span> <span class="s">&quot;test_&quot;</span><span class="o">+</span><span class="k">this</span><span class="o">.</span><span class="n">getClass</span><span class="o">.</span><span class="n">getName</span>
    <span class="o">.</span><span class="n">replace</span><span class="o">(</span><span class="s">&quot;.&quot;</span><span class="o">,</span> <span class="s">&quot;_&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">toLowerCase</span>

  <span class="k">def</span> <span class="n">initDb</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="nc">MongoDB</span><span class="o">.</span><span class="n">defineDb</span><span class="o">(</span><span class="nc">DefaultMongoIdentifier</span><span class="o">,</span> <span class="n">server</span><span class="o">,</span> <span class="n">dbName</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">destroyDb</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">MongoDB</span><span class="o">.</span><span class="n">use</span><span class="o">(</span><span class="nc">DefaultMongoIdentifier</span><span class="o">)</span> <span class="o">{</span> <span class="n">d</span> <span class="k">=&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">dropDatabase</span><span class="o">()</span> <span class="o">}</span>
    <span class="nc">MongoDB</span><span class="o">.</span><span class="n">close</span>
  <span class="o">}</span>

  <span class="k">trait</span> <span class="nc">TestLiftSession</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">session</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LiftSession</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="nc">StringHelpers</span><span class="o">.</span><span class="n">randomString</span><span class="o">(</span><span class="mi">20</span><span class="o">),</span> <span class="nc">Empty</span><span class="o">)</span>
    <span class="k">def</span> <span class="n">inSession</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">init</span><span class="o">(</span><span class="nc">Req</span><span class="o">.</span><span class="n">nil</span><span class="o">,</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span> <span class="n">a</span> <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">MongoContext</span> <span class="k">extends</span> <span class="nc">Around</span> <span class="k">with</span> <span class="nc">TestLiftSession</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">around</span><span class="o">[</span><span class="kt">T</span> <span class="k">&lt;%</span> <span class="kt">Result</span><span class="o">](</span><span class="n">testToRun</span><span class="k">:</span> <span class="o">=&gt;</span><span class="n">T</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
      <span class="n">initDb</span><span class="o">()</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">inSession</span> <span class="o">{</span>
          <span class="n">testToRun</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">destroyDb</span><span class="o">()</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This trait provides the plumbing for connection to a Mongo server running locally, and creates a database based on the name of the class it is mixed into.  The important part is the <span class="monospaced">MongoContext</span> which ensures that <span class="monospaced">around</span> your specification the database is initialized, and that after your specification is run, it is cleaned up.</p></div>
<div class="paragraph"><p>To use this in a specification, mix in the trait and then add the context:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">org.specs2.mutable._</span>

<span class="k">class</span> <span class="nc">MySpec</span> <span class="k">extends</span> <span class="nc">Specification</span> <span class="k">with</span> <span class="nc">MongoTestKit</span> <span class="o">{</span>

  <span class="n">sequential</span>

  <span class="s">&quot;My Record&quot;</span> <span class="n">should</span> <span class="o">{</span>

    <span class="s">&quot;be able to create records&quot;</span> <span class="n">in</span> <span class="nc">MongoContext</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">r</span> <span class="k">=</span> <span class="nc">MyRecord</span><span class="o">.</span><span class="n">createRecord</span>
      <span class="c1">// ...your useful test here...</span>
      <span class="n">r</span><span class="o">.</span><span class="n">valueBox</span><span class="o">.</span><span class="n">isDefined</span> <span class="n">must</span> <span class="n">beTrue</span>
    <span class="o">}</span>

  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>You can now run the test in SBT by typing <span class="monospaced">test</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; test
[info] Compiling 1 Scala source to target/scala-2.9.1/test-classes...
[info] My Record should
[info] + be able to create records
[info]
[info]
[info] Total for specification MySpec
[info] Finished in 1 second, 199 ms
[info] 1 example, 0 failure, 0 error
[info]
[info] Passed: : Total 1, Failed 0, Errors 0, Passed 0, Skipped 0
[success] Total time: 1 s, completed 03-Jan-2013 22:47:54</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_80">Discussion</h4>
<div class="paragraph"><p>Lift normally provides all the scaffolding you need to connect and run against MongoDB. Without a running Lift application, we need to ensure Mongo is configured when our tests run outside of Lift, and that&#8217;s what the <span class="monospaced">MongoTestKit</span> trait is providing for us.</p></div>
<div class="paragraph"><p>The one unusual part of the test set up is including a <span class="monospaced">TestLiftSession</span>. This provides an empty session around your test, which is useful if you are accessing or testing state-related code (e.g., access to <span class="monospaced">S</span>).  It&#8217;s not strictly necessary for running tests against Record, but it has been included here because you may want to do that at some point, for example if you are testing user login via Mongo Records.</p></div>
<div class="paragraph"><p>There are a few nice tricks in SBT to help you run tests. Running <span class="monospaced">test</span> will run all the tests in your project. If you want to focus on just one test, you can:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; test-only org.example.code.MySpec</pre>
</div></div>
<div class="paragraph"><p>This command also supports wildcards, so if we only wanted to run tests that start with the word "Mongo" we could:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; test-only org.example.code.Mongo*</pre>
</div></div>
<div class="paragraph"><p>There&#8217;s also <span class="monospaced">test-quick</span> (in SBT 0.12) which will only run tests that have not been run, have changed, or failed last time and <span class="monospaced">~test</span> to watch for changes in tests and run them.</p></div>
<div class="paragraph"><p><span class="monospaced">test-only</span> together with modifications to <span class="monospaced">around</span> in <span class="monospaced">MongoTestKit</span> can be a good way to track down any issues you have with a test.  By disabling the call to <span class="monospaced">destroyDb()</span> you can jump into the MongoDB shell and examine the state of the database after a test has run.</p></div>
<div class="paragraph"><p>One way to resolve that is to clean up each individual collection, by defining the collections you need to clean up, and replacing <span class="monospaced">destroyDb</span> with a method that will remove all entries in those collections:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">lazy</span> <span class="k">val</span> <span class="n">collections</span> <span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">MongoMetaRecord</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="nc">MyRecord</span><span class="o">)</span>

<span class="k">def</span> <span class="n">destroyDb</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">collections</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="k">_</span> <span class="n">bulkDelete_!!</span> <span class="k">new</span> <span class="nc">BasicDBObject</span><span class="o">)</span>
  <span class="nc">MongoDB</span><span class="o">.</span><span class="n">close</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that the collection list is <span class="monospaced">lazy</span> to avoid start up of the Record system before we&#8217;ve initialized our database connections.</p></div>
<div class="sect4">
<h5 id="_database_cleanup">Database Cleanup</h5>
<div class="paragraph"><p>Around each test we&#8217;ve simply deleted the database so the next time we try to use it, it&#8217;ll be empty.  In some situations you may not be able to do this.  For example, if you&#8217;re running tests against a database hosted with companies such as MongoLabs or MongoHQ, then deleting the database will mean you won&#8217;t be able to connect to it next time you run.</p></div>
</div>
<div class="sect4">
<h5 id="_parallel_tests">Parallel Tests</h5>
<div class="paragraph"><p>If your tests are modifying data and have the potential to interact, you&#8217;ll want to stop SBT from running your tests in parallel. A symptom of this would be tests that fail apparently randomly, or working tests that stop working when you add a new test, or tests that seem to lock up.  Disable by adding the following to <span class="monospaced">build.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">parallelExecution</span> <span class="n">in</span> <span class="nc">Test</span> <span class="o">:=</span> <span class="kc">false</span>
</pre></div></div></div>
<div class="paragraph"><p>You&#8217;ll notice that the example specification includes the line: <span class="monospaced">sequential</span>.  This disables the default behaviour in Specs2 of running all tests concurrently.</p></div>
</div>
<div class="sect4">
<h5 id="_running_tests_in_ides">Running tests in IDEs</h5>
<div class="paragraph"><p>IntelliJ IDEA detects and allows you to runs Specs2 tests automatically.  With Eclipse, you&#8217;ll need to include the JUnit runner annotation at the start of your specification:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">org.junit.runner.RunWith</span>
<span class="k">import</span> <span class="nn">org.specs2.runner.JUnitRunner</span>

<span class="nd">@RunWith</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">JUnitRunner</span><span class="o">])</span>
<span class="k">class</span> <span class="nc">MySpec</span> <span class="k">extends</span> <span class="nc">Specification</span> <span class="k">with</span> <span class="nc">MongoTestKit</span>  <span class="o">{</span>
<span class="o">...</span>
</pre></div></div></div>
<div class="paragraph"><p>You can then "Run As&#8230;" the class in Eclipse.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_78">See Also</h4>
<div class="paragraph"><p>Specs2 is documented at: <a href="http://specs2.org/">http://specs2.org/</a>.</p></div>
<div class="paragraph"><p>If you prefer to use the Scala Test framework (<a href="http://www.scalatest.org">http://www.scalatest.org</a>), take a look at Tim Nelson&#8217;s <em>Mongo Auth</em> Lift module at <a href="https://github.com/eltimn/lift-mongoauth">https://github.com/eltimn/lift-mongoauth</a>. It includes tests using that framework that run against Mongo.  Much of what Tim has written there has been used to produce this recipe for Specs2.</p></div>
<div class="paragraph"><p>The Lift Mongo Record library includes a variation on testing with Specs2, using just <span class="monospaced">Before</span> and <span class="monospaced">After</span> rather than the <span class="monospaced">around</span> example used in this recipe. If you prefer that approach, you&#8217;ll find the code in: <a href="https://github.com/lift/framework/tree/master/persistence/mongodb-record/src/test/scala/net/liftweb/mongodb/record">https://github.com/lift/framework/tree/master/persistence/mongodb-record/src/test/scala/net/liftweb/mongodb/record</a>.</p></div>
<div class="paragraph"><p>Flapdoodle (<a href="https://github.com/flapdoodle-oss/embedmongo.flapdoodle.de">https://github.com/flapdoodle-oss/embedmongo.flapdoodle.de</a> provides a way to automate the download, install, set up and clean up of a MongoDB database. This automation is something you can wrap around your unit tests, and a Specs2 integration is included using the same <span class="monospaced">Before</span> and <span class="monospaced">After</span> approach to testing used by Lift Mongo Record: <a href="https://github.com/athieriot/specs2-embedmongo">https://github.com/athieriot/specs2-embedmongo</a>.</p></div>
<div class="paragraph"><p>The test interface provided by SBT, such as the <span class="monospaced">test</span> command, also supports the ability to fork tests, set specific configurations for test cases, and ways to select which tests are run. You&#8217;ll find it at: <a href="http://www.scala-sbt.org/release/docs/Detailed-Topics/Testing">http://www.scala-sbt.org/release/docs/Detailed-Topics/Testing</a>.</p></div>
<div class="paragraph"><p>The Lift Wiki describes more about unit testing and Lift sessions:
<a href="https://www.assembla.com/wiki/show/liftweb/Unit_Testing_Snippets_With_A_Logged_In_User">https://www.assembla.com/wiki/show/liftweb/Unit_Testing_Snippets_With_A_Logged_In_User</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Around">Around Lift</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter gives examples of working with Lift and other systems, such
as sending email or scheduling tasks.</p></div>
<div class="paragraph"><p>Many of the recipes in this chapter have code examples in a project at Github: <a href="https://github.com/LiftCookbook/cookbook_around">https://github.com/LiftCookbook/cookbook_around</a>.</p></div>
<div class="sect2">
<h3 id="SendTextEmail">Sending Plain Text Email</h3>
<div class="sect3">
<h4 id="_problem_80">Problem</h4>
<div class="paragraph"><p>You want to send a plain text email from your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_80">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">Mailer</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.Mailer</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Mailer._</span>

<span class="nc">Mailer</span><span class="o">.</span><span class="n">sendMail</span><span class="o">(</span>
  <span class="nc">From</span><span class="o">(</span><span class="s">&quot;you@example.org&quot;</span><span class="o">),</span>
  <span class="nc">Subject</span><span class="o">(</span><span class="s">&quot;Hello&quot;</span><span class="o">),</span>
  <span class="nc">To</span><span class="o">(</span><span class="s">&quot;other@example.org&quot;</span><span class="o">),</span>
  <span class="nc">PlainMailBodyType</span><span class="o">(</span><span class="s">&quot;Hello from Lift&quot;</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_81">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">Mailer</span> sends the message asynchronously, meaning <span class="monospaced">sendMail</span> will
return immediately, so you don&#8217;t have to worry about the time costs of
negotiating with an SMTP server. There&#8217;s also a <span class="monospaced">blockingSendMail</span>
method if you want to wait.</p></div>
<div class="paragraph"><p>By default, the SMTP server used will be <span class="monospaced">localhost</span>. You can change
this by setting the <span class="monospaced">mail.smtp.host</span> property.
For example, edit <span class="monospaced">src/mail/resources/props/default.props</span> and add the line:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>mail.smtp.host=smtp.example.org</pre>
</div></div>
<div class="paragraph"><p>The signature of <span class="monospaced">sendMail</span> requires a <span class="monospaced">From</span>, <span class="monospaced">Subject</span> and then any
number of <span class="monospaced">MailTypes</span>:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">To</span>&#8201;&#8212;&#8201;the recipient email address.
</p>
</li>
<li>
<p>
<span class="monospaced">CC</span>&#8201;&#8212;&#8201;ditto
</p>
</li>
<li>
<p>
<span class="monospaced">BCC</span>&#8201;&#8212;&#8201;ditto
</p>
</li>
<li>
<p>
<span class="monospaced">ReplyTo</span>&#8201;&#8212;&#8201;the address mail clients should use for replies.
</p>
</li>
<li>
<p>
<span class="monospaced">MessageHeader</span>&#8201;&#8212;&#8201;key/value pairs to include as headers in the message.
</p>
</li>
<li>
<p>
<span class="monospaced">PlainMailBodyType</span>&#8201;&#8212;&#8201;a plain text email sent with UTF-8 encoding.
</p>
</li>
<li>
<p>
<span class="monospaced">PlainPlusBodyType</span>&#8201;&#8212;&#8201;a plain text email, where you specify the encoding.
</p>
</li>
<li>
<p>
<span class="monospaced">XHTMLMailBodyType</span>&#8201;&#8212;&#8201;for HTML email (<a href="#HTMLEmail">[HTMLEmail]</a>).
</p>
</li>
<li>
<p>
<span class="monospaced">XHTMLPlusImages</span>&#8201;&#8212;&#8201;for attachments (<a href="#EmailWithAttachments">[EmailWithAttachments]</a>).
</p>
</li>
</ul></div>
<div class="paragraph"><p>In the example above we added two types:<span class="monospaced">PlainMailBodyType</span>
and <span class="monospaced">To</span>.  Adding more as as you&#8217;d expect:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Mailer</span><span class="o">.</span><span class="n">sendMail</span><span class="o">(</span>
  <span class="nc">From</span><span class="o">(</span><span class="s">&quot;you@example.org&quot;</span><span class="o">),</span>
  <span class="nc">Subject</span><span class="o">(</span><span class="s">&quot;Hello&quot;</span><span class="o">),</span>
  <span class="nc">To</span><span class="o">(</span><span class="s">&quot;other@example.org&quot;</span><span class="o">),</span>
  <span class="nc">To</span><span class="o">(</span><span class="s">&quot;someone@example.org&quot;</span><span class="o">),</span>
  <span class="nc">MessageHeader</span><span class="o">(</span><span class="s">&quot;X-Ignore-This&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">),</span>
  <span class="nc">PlainMailBodyType</span><span class="o">(</span><span class="s">&quot;Hello from Lift&quot;</span><span class="o">)</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>The address-like <span class="monospaced">MailTypes</span> (<span class="monospaced">To</span>, <span class="monospaced">CC</span>, <span class="monospaced">BCC</span>, <span class="monospaced">ReplyTo</span>) can be given an optional "personal name":</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">From</span><span class="o">(</span><span class="s">&quot;you@example.org&quot;</span><span class="o">,</span> <span class="nc">Full</span><span class="o">(</span><span class="s">&quot;Example Corporation&quot;</span><span class="o">))</span>
</pre></div></div></div>
<div class="paragraph"><p>This would appear in your mailbox as:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>From: Example Corporation &lt;you@example.org&gt;</pre>
</div></div>
<div class="paragraph"><p>The default character set is UTF-8. If you need to change this replace
the use of <span class="monospaced">PlainMailBodyType</span> with
<span class="monospaced">PlainPlusBodyType("Hello from Lift", "ISO8859_1")</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_79">See Also</h4>
<div class="paragraph"><p><a href="#EmailWithAttachments">[EmailWithAttachments]</a> describes email with attachments.</p></div>
<div class="paragraph"><p>For HTML email, see <a href="#HTMLEmail">[HTMLEmail]</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="LogEmail">Logging Email Rather Than Sending</h3>
<div class="sect3">
<h4 id="_problem_81">Problem</h4>
<div class="paragraph"><p>You don&#8217;t want email sent when developing your Lift application locally,
but you do want to see what would have been sent.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_81">Solution</h4>
<div class="paragraph"><p>Assign a logging function to <span class="monospaced">Mailer.devModeSend</span> in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.Mailer._</span>
<span class="k">import</span> <span class="nn">javax.mail.internet.</span><span class="o">{</span><span class="nc">MimeMessage</span><span class="o">,</span><span class="nc">MimeMultipart</span><span class="o">}</span>

<span class="nc">Mailer</span><span class="o">.</span><span class="n">devModeSend</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">set</span><span class="o">(</span> <span class="o">(</span><span class="n">m</span><span class="k">:</span> <span class="kt">MimeMessage</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Would have sent: &quot;</span><span class="o">+</span><span class="n">m</span><span class="o">.</span><span class="n">getContent</span><span class="o">)</span>
<span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>When you send an email with <span class="monospaced">Mailer</span>, no SMTP server will be contacted, and
instead you&#8217;ll see output to your log:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Would have sent: Hello from Lift</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_82">Discussion</h4>
<div class="paragraph"><p>The Lift Mailer allows you to control how email is sent at each run mode:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">devModeSend</span>&#8201;&#8212;&#8201;will send email by default.
</p>
</li>
<li>
<p>
<span class="monospaced">testModeSend</span>&#8201;&#8212;&#8201;only log that a message would have been sent.
</p>
</li>
<li>
<p>
<span class="monospaced">stagingModeSend</span>&#8201;&#8212;&#8201;will send email by default.
</p>
</li>
<li>
<p>
<span class="monospaced">productionModeSend</span>&#8201;&#8212;&#8201;will send email by default.
</p>
</li>
<li>
<p>
<span class="monospaced">pilotModeSend</span>&#8201;&#8212;&#8201;will send email by default.
</p>
</li>
<li>
<p>
<span class="monospaced">profileModeSend</span>&#8201;&#8212;&#8201;will send email by default.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <span class="monospaced">testModeSend</span> logs a reference to the <span class="monospaced">MimeMessage</span>, meaning your log
would show a message like:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Sending javax.mail.internet.MimeMessage@4a91a883</pre>
</div></div>
<div class="paragraph"><p>This recipe has changed just the behaviour of <span class="monospaced">Mailer</span> when your Lift
application is in developer mode (which it is by default). We&#8217;re logging
just the body part of the message.</p></div>
<div class="paragraph"><p>Java Mail doesn&#8217;t include a utility to display all the
parts of an email, so if you want more information you&#8217;ll need to
roll your own function.  For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="n">display</span><span class="o">(</span><span class="n">m</span><span class="k">:</span> <span class="kt">MimeMessage</span><span class="o">)</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">nl</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;line.separator&quot;</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">from</span> <span class="k">=</span> <span class="s">&quot;From: &quot;</span><span class="o">+</span><span class="n">m</span><span class="o">.</span><span class="n">getFrom</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">).</span><span class="n">mkString</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">subj</span> <span class="k">=</span> <span class="s">&quot;Subject: &quot;</span><span class="o">+</span><span class="n">m</span><span class="o">.</span><span class="n">getSubject</span>

  <span class="k">def</span> <span class="n">parts</span><span class="o">(</span><span class="n">mm</span><span class="k">:</span> <span class="kt">MimeMultipart</span><span class="o">)</span> <span class="k">=</span> <span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="n">mm</span><span class="o">.</span><span class="n">getCount</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">mm</span><span class="o">.</span><span class="n">getBodyPart</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">body</span> <span class="k">=</span> <span class="n">m</span><span class="o">.</span><span class="n">getContent</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">mm</span><span class="k">:</span> <span class="kt">MimeMultipart</span> <span class="o">=&gt;</span>
      <span class="k">val</span> <span class="n">bodyParts</span> <span class="k">=</span> <span class="k">for</span> <span class="o">(</span><span class="n">part</span> <span class="k">&lt;-</span> <span class="n">parts</span><span class="o">(</span><span class="n">mm</span><span class="o">))</span> <span class="k">yield</span> <span class="n">part</span><span class="o">.</span><span class="n">getContent</span><span class="o">.</span><span class="n">toString</span>
      <span class="n">bodyParts</span><span class="o">.</span><span class="n">mkString</span><span class="o">(</span><span class="n">nl</span><span class="o">)</span>

    <span class="k">case</span> <span class="n">otherwise</span> <span class="k">=&gt;</span> <span class="n">otherwise</span><span class="o">.</span><span class="n">toString</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="n">to</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="n">rt</span> <span class="k">&lt;-</span> <span class="nc">List</span><span class="o">(</span><span class="nc">RecipientType</span><span class="o">.</span><span class="nc">TO</span><span class="o">,</span> <span class="nc">RecipientType</span><span class="o">.</span><span class="nc">CC</span><span class="o">,</span> <span class="nc">RecipientType</span><span class="o">.</span><span class="nc">BCC</span><span class="o">)</span>
    <span class="n">address</span> <span class="k">&lt;-</span> <span class="nc">Option</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="n">getRecipients</span><span class="o">(</span><span class="n">rt</span><span class="o">))</span> <span class="n">getOrElse</span> <span class="nc">Array</span><span class="o">()</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">rt</span><span class="o">.</span><span class="n">toString</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">address</span><span class="o">.</span><span class="n">toString</span>

  <span class="nc">List</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">.</span><span class="n">mkString</span><span class="o">(</span><span class="n">nl</span><span class="o">),</span> <span class="n">subj</span><span class="o">,</span> <span class="n">body</span><span class="o">)</span> <span class="n">mkString</span> <span class="n">nl</span>
<span class="o">}</span>

<span class="nc">Mailer</span><span class="o">.</span><span class="n">devModeSend</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">set</span><span class="o">(</span> <span class="o">(</span><span class="n">m</span><span class="k">:</span> <span class="kt">MimeMessage</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Would have sent: &quot;</span><span class="o">+</span><span class="n">display</span><span class="o">(</span><span class="n">m</span><span class="o">))</span>
<span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This would produce output of the form:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Would have sent: From: you@example.org
To: other@example.org
To: someone@example.org
Subject: Hello
Hello from Lift</pre>
</div></div>
<div class="paragraph"><p>This example <span class="monospaced">display</span> function is mostly straight-forward. The <span class="monospaced">body</span> value handles multi-part messages by extracting the each body part.  This is triggered when sending more structured emails, such as the HTML emails described in <a href="#HTMLEmail">[HTMLEmail]</a>.</p></div>
<div class="paragraph"><p>The key part of this recipe is setting a
<span class="monospaced">MimeMessage =&gt; Unit</span> function on <span class="monospaced">Mailer.devModeSend</span>.  We happen to be logging, but you can use this function to handle the email any way you want. Examples might include logging and then sending, or recording information about the send in a database.</p></div>
<div class="paragraph"><p>If you want to debug the mail system while it&#8217;s actually sending the email, enable the Java Mail debug mode.  In <span class="monospaced">default.props</span> add:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="na">mail.debug</span><span class="o">=</span><span class="s">true</span>
</pre></div></div></div>
<div class="paragraph"><p>This produces low-level output from the <span class="monospaced">javax.mail</span> system when email is sent:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>DEBUG: JavaMail version 1.4.4
DEBUG: successfully loaded resource: /META-INF/javamail.default.providers
DEBUG SMTP: useEhlo true, useAuth false
DEBUG SMTP: trying to connect to host "localhost", port 25, isSSL false
...</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_80">See Also</h4>
<div class="paragraph"><p>Run modes are described at: <a href="https://www.assembla.com/spaces/liftweb/wiki/Run_Modes">https://www.assembla.com/spaces/liftweb/wiki/Run_Modes</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="HTMLEmail">Sending HTML email</h3>
<div class="sect3">
<h4 id="_problem_82">Problem</h4>
<div class="paragraph"><p>You want to send an HTML email from your Lift application.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_82">Solution</h4>
<div class="paragraph"><p>Give <span class="monospaced">Mailer</span> a <span class="monospaced">NodeSeq</span> containing your HTML message:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.Mailer</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Mailer._</span>

<span class="k">val</span> <span class="n">msg</span> <span class="k">=</span> <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
     <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="nc">Hello</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
   <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="nc">Hello</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
   <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>

<span class="nc">Mailer</span><span class="o">.</span><span class="n">sendMail</span><span class="o">(</span>
  <span class="nc">From</span><span class="o">(</span><span class="s">&quot;me@example.org&quot;</span><span class="o">),</span>
  <span class="nc">Subject</span><span class="o">(</span><span class="s">&quot;Hello&quot;</span><span class="o">),</span>
  <span class="nc">To</span><span class="o">(</span><span class="s">&quot;you@example.org&quot;</span><span class="o">),</span>
  <span class="n">msg</span><span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_83">Discussion</h4>
<div class="paragraph"><p>An implicit converts the <span class="monospaced">NodeSeq</span> into a <span class="monospaced">XHTMLMailBodyType</span>. This
ensures the mime type of the email is "text/html". Despite the name of
"XHTML", the message is to converted for transmission using
HTML5 semantics.</p></div>
<div class="paragraph"><p>The character encoding for HTML email, UTF-8, can be changed by setting
<span class="monospaced">mail.charset</span> in your Lift properties file.</p></div>
<div class="paragraph"><p>If you want to set both the text and HTML version of a message, supply each body wrapped in the appropriate <span class="monospaced">BodyType</span> class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">html</span> <span class="k">=</span> <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="nc">Hello</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="nc">Hello</span><span class="o">!&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>

<span class="k">var</span> <span class="n">text</span> <span class="k">=</span> <span class="s">&quot;Hello!&quot;</span>

<span class="nc">Mailer</span><span class="o">.</span><span class="n">sendMail</span><span class="o">(</span>
  <span class="nc">From</span><span class="o">(</span><span class="s">&quot;me@example.org&quot;</span><span class="o">),</span>
  <span class="nc">Subject</span><span class="o">(</span><span class="s">&quot;Hello&quot;</span><span class="o">),</span>
  <span class="nc">To</span><span class="o">(</span><span class="s">&quot;you@example.org&quot;</span><span class="o">),</span>
  <span class="nc">PlainMailBodyType</span><span class="o">(</span><span class="n">text</span><span class="o">),</span>
  <span class="nc">XHTMLMailBodyType</span><span class="o">(</span><span class="n">html</span><span class="o">)</span>
<span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This message would be sent as a "multipart/alternative":</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Content-Type: multipart/alternative;
  boundary="----=_Part_1_1197390963.1360226660982"
Date: Thu, 07 Feb 2013 02:44:22 -0600 (CST)

------=_Part_1_1197390963.1360226660982
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit

Hello!
------=_Part_1_1197390963.1360226660982
Content-Type: text/html; charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;Hello&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;h1&gt;Hello!&lt;/h1&gt;
      &lt;/body&gt;
    &lt;/html&gt;
------=_Part_1_1197390963.1360226660982--</pre>
</div></div>
<div class="paragraph"><p>When receiving a message with this content, it is up to the mail client to decide which version to show (text or HTML).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_81">See Also</h4>
<div class="paragraph"><p>For sending with attachments, see <a href="#EmailWithAttachments">[EmailWithAttachments]</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="AuthEmail">Sending Authenticated Email</h3>
<div class="sect3">
<h4 id="_problem_83">Problem</h4>
<div class="paragraph"><p>You need to authenticate with an SMTP server to send email.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_83">Solution</h4>
<div class="paragraph"><p>Set the <span class="monospaced">Mailer.authenticator</span> in <span class="monospaced">Boot</span> with the credentials for your
SMTP server, and enable the <span class="monospaced">mail.smtp.auth</span> flag in your Lift properties
file.</p></div>
<div class="paragraph"><p>Modify <span class="monospaced">Boot.scala</span> to include:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.</span><span class="o">{</span><span class="nc">Props</span><span class="o">,</span> <span class="nc">Mailer</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">javax.mail.</span><span class="o">{</span><span class="nc">Authenticator</span><span class="o">,</span><span class="nc">PasswordAuthentication</span><span class="o">}</span>

<span class="nc">Mailer</span><span class="o">.</span><span class="n">authenticator</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">user</span> <span class="k">&lt;-</span> <span class="nc">Props</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;mail.user&quot;</span><span class="o">)</span>
  <span class="n">pass</span> <span class="k">&lt;-</span> <span class="nc">Props</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;mail.password&quot;</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="k">new</span> <span class="nc">Authenticator</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">getPasswordAuthentication</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">PasswordAuthentication</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">pass</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In this example we expect the username and password to come from Lift
properties, so we need to modify
<span class="monospaced">src/main/resources/props/default.props</span> to include them:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">mail</span><span class="o">.</span><span class="n">smtp</span><span class="o">.</span><span class="n">auth</span><span class="k">=</span><span class="kc">true</span>
<span class="n">mail</span><span class="o">.</span><span class="n">user</span><span class="k">=</span><span class="n">me</span><span class="nd">@example</span><span class="o">.</span><span class="n">org</span>
<span class="n">mail</span><span class="o">.</span><span class="n">password</span><span class="k">=</span><span class="n">correct</span> <span class="n">horse</span> <span class="n">battery</span> <span class="n">staple</span>
<span class="n">mail</span><span class="o">.</span><span class="n">smtp</span><span class="o">.</span><span class="n">host</span><span class="k">=</span><span class="n">smtp</span><span class="o">.</span><span class="n">sendgrid</span><span class="o">.</span><span class="n">net</span>
</pre></div></div></div>
<div class="paragraph"><p>When you send email, the credentials in <span class="monospaced">default.props</span> will be used to authenticate with the SMTP server.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_84">Discussion</h4>
<div class="paragraph"><p>We&#8217;ve used Lift properties as a way to configure SMTP authentication.
This has the benefit of allowing us to enable authentication for just
some run modes. For example, if our <span class="monospaced">default.props</span> did not contain
authentication settings, but our <span class="monospaced">production.default.props</span> did, then no
authentication would happen in development mode, ensuring we can&#8217;t
accidentally send email outside of a production environment.</p></div>
<div class="paragraph"><p>You don&#8217;t have to use a properties file for this: the Lift Mailer
also supports JNDI, or you could lookup a username and password some other way and set <span class="monospaced">Mailer.authenticator</span> when you have the values.</p></div>
<div class="paragraph"><p>However, some mail services such as SendGrid do require <span class="monospaced">mail.smtp.auth=true</span> to be set, and that should go into your Lift properties file or set as a JVM argument: <span class="monospaced">-Dmail.smtp.auth=true</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_82">See Also</h4>
<div class="paragraph"><p>As well as <span class="monospaced">mail.smtp.auth</span> there are a range of settings to control the Java Mail API. examples include controlling port numbers and timeouts.  These are listed at: <a href="http://javamail.kenai.com/nonav/javadocs/com/sun/mail/smtp/package-summary.html">http://javamail.kenai.com/nonav/javadocs/com/sun/mail/smtp/package-summary.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="EmailWithAttachments">Sending Email with Attachments</h3>
<div class="sect3">
<h4 id="_problem_84">Problem</h4>
<div class="paragraph"><p>You want to send an email with one or more attachments.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_84">Solution</h4>
<div class="paragraph"><p>Use the <span class="monospaced">Mailer</span> <span class="monospaced">XHTMLPlusImages</span> to package a message with one or more attachments.</p></div>
<div class="paragraph"><p>Suppose we want to construct a CSV file and send it via email:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">content</span> <span class="k">=</span> <span class="s">&quot;Planet,Discoverer\r\n&quot;</span> <span class="o">+</span>
  <span class="s">&quot;HR 8799 c, Marois et al\r\n&quot;</span> <span class="o">+</span>
  <span class="s">&quot;Kepler-22b, Kepler Science Team\r\n&quot;</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">CSVFile</span><span class="o">(</span><span class="n">bytes</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">],</span>
  <span class="n">filename</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;file.csv&quot;</span><span class="o">,</span>
  <span class="n">mime</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;text/csv; charset=utf8; header=present&quot;</span> <span class="o">)</span>

<span class="k">val</span> <span class="n">attach</span> <span class="k">=</span> <span class="nc">CSVFile</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="n">mkString</span><span class="o">.</span><span class="n">getBytes</span><span class="o">(</span><span class="s">&quot;utf8&quot;</span><span class="o">))</span>

<span class="k">val</span> <span class="n">body</span> <span class="k">=</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">Please</span> <span class="n">research</span> <span class="n">the</span> <span class="n">enclosed</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="k">val</span> <span class="n">msg</span> <span class="k">=</span> <span class="nc">XHTMLPlusImages</span><span class="o">(</span><span class="n">body</span><span class="o">,</span>
  <span class="nc">PlusImageHolder</span><span class="o">(</span><span class="n">attach</span><span class="o">.</span><span class="n">filename</span><span class="o">,</span> <span class="n">attach</span><span class="o">.</span><span class="n">mime</span><span class="o">,</span> <span class="n">attach</span><span class="o">.</span><span class="n">bytes</span><span class="o">))</span>

<span class="nc">Mailer</span><span class="o">.</span><span class="n">sendMail</span><span class="o">(</span>
  <span class="nc">From</span><span class="o">(</span><span class="s">&quot;me@example.org&quot;</span><span class="o">,</span>
  <span class="nc">Subject</span><span class="o">(</span><span class="s">&quot;Planets&quot;</span><span class="o">),</span>
  <span class="nc">To</span><span class="o">(</span><span class="s">&quot;you@example.org&quot;</span><span class="o">),</span>
  <span class="n">msg</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>What&#8217;s happening here is that our message is <span class="monospaced">XHTMLPlusImages</span> with accepts
a body message and attachment.  The attachment, the <span class="monospaced">PlusImageHolder</span>, is an <span class="monospaced">Array[Byte]</span>, mime-type and a filename.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_85">Discussion</h4>
<div class="paragraph"><p><span class="monospaced">XHTMLPlusImages</span> can also accept more than one <span class="monospaced">PlusImageHolder</span> if you
have more than one file to attach.  Although the name <span class="monospaced">PlusImageHolder</span> may suggest it is for attachment images, you can attach any kind of data as an <span class="monospaced">Array[Byte]</span> with an appropriate mime type.</p></div>
<div class="paragraph"><p>By default the attachment is sent with an "inline" disposition. This controls the <span class="monospaced">Content-Disposition</span> header in the message, and "inline" means the content is intended for display automatically when the message is shown.  The alternative is "attachment", and this can be indicated with a option final parameter to <span class="monospaced">PlusImageHolder</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">PlusImageHolder</span><span class="o">(</span><span class="n">attach</span><span class="o">.</span><span class="n">filename</span><span class="o">,</span> <span class="n">attach</span><span class="o">.</span><span class="n">mime</span><span class="o">,</span> <span class="n">attach</span><span class="o">.</span><span class="n">bytes</span><span class="o">,</span> <span class="n">attachment</span><span class="k">=</span><span class="kc">true</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>In reality, the mail client will display the message how it wants to, but this extra parameter may give you a little more control.</p></div>
<div class="paragraph"><p>To attach a pre-made file, you can use <span class="monospaced">LiftRules.loadResource</span> to fetch content from the classpath.  As an example, if our project contained a file called <span class="monospaced">Kepler-22b_System_Diagram.jpg</span> in the <span class="monospaced">src/main/resources/</span> folder, we could load and attach it like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">filename</span> <span class="k">=</span> <span class="s">&quot;Kepler-22b_System_Diagram.jpg&quot;</span>

<span class="k">val</span> <span class="n">msg</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">(</span> <span class="n">bytes</span> <span class="k">&lt;-</span> <span class="nc">LiftRules</span><span class="o">.</span><span class="n">loadResource</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">)</span> <span class="o">)</span>
  <span class="k">yield</span> <span class="nc">XHTMLPlusImages</span><span class="o">(</span>
    <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">Please</span> <span class="n">research</span> <span class="k">this</span> <span class="n">planet</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;,</span>
    <span class="nc">PlusImageHolder</span><span class="o">(</span><span class="n">filename</span><span class="o">,</span> <span class="s">&quot;image/jpg&quot;</span><span class="o">,</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">)</span>

<span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="n">m</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">Mailer</span><span class="o">.</span><span class="n">sendMail</span><span class="o">(</span>
      <span class="nc">From</span><span class="o">(</span><span class="s">&quot;me@example.org&quot;</span><span class="o">),</span>
      <span class="nc">Subject</span><span class="o">(</span><span class="s">&quot;Planet attachment&quot;</span><span class="o">),</span>
      <span class="nc">To</span><span class="o">(</span><span class="s">&quot;you@example.org&quot;</span><span class="o">),</span>
      <span class="n">m</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Planet file not found&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>As the contents of <span class="monospaced">src/main/resources</span> is included on the classpath, we pass the filename to <span class="monospaced">loadResource</span> with a leading <span class="monospaced">/</span> character so the file can be found at the right place on the classpath.</p></div>
<div class="paragraph"><p>The <span class="monospaced">loadResource</span> returns a <span class="monospaced">Box[Array[Byte]]</span> as we have no guarantee the file will exist. We map this to a <span class="monospaced">Box[XHTMLPlusImages]</span> and match on that result to either send the email, or log that the file wasn&#8217;t found.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_83">See Also</h4>
<div class="paragraph"><p>Messages are sent using the "multipart/related" mime heading, with an "inline" disposition.  Lift ticket #1197 links to a discussion regarding "multipart/mixed" which may be preferable for working around issues with Microsoft Exchange. See: <a href="https://github.com/lift/framework/issues/1197">https://github.com/lift/framework/issues/1197</a>.</p></div>
<div class="paragraph"><p>RFC 2183 describes the "Content-Disposition" header: <a href="http://www.ietf.org/rfc/rfc2183.txt">http://www.ietf.org/rfc/rfc2183.txt</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RunLater">Run a Task Later</h3>
<div class="sect3">
<h4 id="_problem_85">Problem</h4>
<div class="paragraph"><p>You want to schedule code to run at some future time.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_85">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">net.liftweb.util.Schedule</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.Schedule</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="nc">Schedule</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;doing it&quot;</span><span class="o">),</span> <span class="mi">30</span> <span class="n">seconds</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This would cause "doing it" to be printed on the console 30
seconds from now.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_86">Discussion</h4>
<div class="paragraph"><p>The signature for <span class="monospaced">Schedule</span> used above expects a function of type <span class="monospaced">() =&gt; Unit</span>, which is the thing we want to happen in the future, and a <span class="monospaced">TimeSpan</span> from Lift&#8217;s <span class="monospaced">TimeHelpers</span> which is when we want it to happen.  The <span class="monospaced">30 seconds</span> value gives us a <span class="monospaced">TimeSpan</span> via the <span class="monospaced">Helpers._</span> import, but there&#8217;s a variation which accepts a <span class="monospaced">Long</span> millisecond value if you prefer that:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Schedule</span><span class="o">.</span><span class="n">perform</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;doing it&quot;</span><span class="o">),</span> <span class="mi">30</span><span class="o">*</span><span class="mi">1000L</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Behind the scenes, Lift is making use of the <span class="monospaced">ScheduledExecutorService</span> from <span class="monospaced">java.util.concurrent</span>, and as such returns a <span class="monospaced">ScheduledFuture[Unit]</span>.  You can use this future to <span class="monospaced">cancel</span> the operation before it runs.</p></div>
<div class="paragraph"><p>It may be a surprise to find that you can call <span class="monospaced">Schedule</span> with just a function as an argument, and not a delay value.  This version runs the function immediately, but on a worker thread.  This is a convenient way to asynchronously run other tasks without going to the trouble of creating an actor for the purpose.</p></div>
<div class="paragraph"><p>There is also a <span class="monospaced">Schedule.schedule</span> method which will send a specified
actor a specified message after a given delay.  This takes a <span class="monospaced">TimeSpan</span> delay, but again there&#8217;s also a <span class="monospaced">Schedule.perform</span> version that accepts a <span class="monospaced">Long</span> as a delay.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_84">See Also</h4>
<div class="paragraph"><p><a href="#RunTasksPeriodically">[RunTasksPeriodically]</a> includes an example of scheduling with actors.</p></div>
<div class="paragraph"><p><span class="monospaced">ScheduledFuture</span> is documented via the Java Doc for <span class="monospaced">Future</span> at: <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/Future.html">http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/Future.html</a>.  If you&#8217;re building complex, low-level, cancellable concurrency functions, it&#8217;s advisable to have a copy of <em>Java Concurrency in Practice</em> close by (Goetz <em>et al.</em>, 2006, Addison-Wesley Professional).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="RunTasksPeriodically">Run Tasks Periodically</h3>
<div class="sect3">
<h4 id="_problem_86">Problem</h4>
<div class="paragraph"><p>You want a scheduled task to run periodically (repeatedly).</p></div>
</div>
<div class="sect3">
<h4 id="_solution_86">Solution</h4>
<div class="paragraph"><p>Use <span class="monospaced">net.liftweb.util.Schedule</span> ensuring that you call <span class="monospaced">schedule</span> again
during your task to re-schedule it. For example, using an actor:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.util.Schedule</span>
<span class="k">import</span> <span class="nn">net.liftweb.actor.LiftActor</span>
<span class="k">import</span> <span class="nn">net.liftweb.util.Helpers._</span>

<span class="k">object</span> <span class="nc">MyScheduledTask</span> <span class="k">extends</span> <span class="nc">LiftActor</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">DoIt</span><span class="o">()</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Stop</span><span class="o">()</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">stopped</span> <span class="k">=</span> <span class="kc">false</span>

   <span class="k">def</span> <span class="n">messageHandler</span> <span class="k">=</span> <span class="o">{</span>
     <span class="k">case</span> <span class="nc">DoIt</span> <span class="k">if</span> <span class="o">!</span><span class="n">stopped</span> <span class="k">=&gt;</span>
        <span class="nc">Schedule</span><span class="o">.</span><span class="n">schedule</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">DoIt</span><span class="o">,</span> <span class="mi">10</span> <span class="n">minutes</span><span class="o">)</span>
       <span class="c1">// ... do useful work here</span>

     <span class="k">case</span> <span class="nc">Stop</span> <span class="k">=&gt;</span>
       <span class="n">stopped</span> <span class="k">=</span> <span class="kc">true</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The example creates a <span class="monospaced">LiftActor</span> for the work to be done. On receipt of
a <span class="monospaced">DoIt</span> message, the actor re-schedules itself before doing whatever
useful work needs to be done. In this way, the actor will be called
every 10 minutes.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_87">Discussion</h4>
<div class="paragraph"><p>The <span class="monospaced">Schedule.schedule</span> call is ensuring that <span class="monospaced">this</span> actor is sent the
<span class="monospaced">DoIt</span> message after 10 minutes.</p></div>
<div class="paragraph"><p>To start this process off, possibly in <span class="monospaced">Boot.scala</span>, just send the
<span class="monospaced">DoIt</span> message to the actor:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">MyScheduledTask</span> <span class="o">!</span> <span class="nc">MyScheduledTask</span><span class="o">.</span><span class="nc">DoIt</span>
</pre></div></div></div>
<div class="paragraph"><p>To ensure the process stops correctly when Lift shuts down, we register
a shutdown hook in <span class="monospaced">Boot.scala</span> to send the <span class="monospaced">Stop</span> message to prevent
future re-schedules:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">unloadHooks</span><span class="o">.</span><span class="n">append</span><span class="o">(</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">MyScheduledTask</span> <span class="o">!</span> <span class="nc">MyScheduledTask</span><span class="o">.</span><span class="nc">Stop</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Without the <span class="monospaced">Stop</span> message the actor would continue to be rescheduled
until the JVM exits. This may be acceptable, but note that during
development with SBT, without the <span class="monospaced">Stop</span> message, you will continue to
schedule tasks after issuing the <span class="monospaced">container:stop</span> command.</p></div>
<div class="paragraph"><p>Schedule returns a <span class="monospaced">ScheduledFuture[Unit]</span> from the Java concurrency
library, which allows you to <span class="monospaced">cancel</span> the activity.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_85">See Also</h4>
<div class="paragraph"><p>Chapter 1 of <em>Lift in Action</em> (Perrett, 2011, Manning Publications Co) includes a Comet Actor clock example that uses <span class="monospaced">Schedule</span>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="FetchURLs">Fetching URLs</h3>
<div class="sect3">
<h4 id="_problem_87">Problem</h4>
<div class="paragraph"><p>You want your Lift application to fetch a URL, and process it as text, JSON, XML or HTML.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_87">Solution</h4>
<div class="paragraph"><p>Use <em>Dispatch</em>, "a library for asynchronous HTTP interaction".</p></div>
<div class="paragraph"><p>Before you start, include Dispatch dependency in your <span class="monospaced">build.sbt</span> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&quot;net.databinder.dispatch&quot;</span> <span class="o">%%</span> <span class="s">&quot;dispatch-core&quot;</span> <span class="o">%</span> <span class="s">&quot;0.9.5&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>Using the example from the Dispatch documentation, we can make a HTTP request to try to determine the country from the service at <a href="http://www.hostip.info/use.html">http://www.hostip.info/use.html</a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">dispatch._</span>
<span class="k">val</span> <span class="n">svc</span> <span class="k">=</span> <span class="n">url</span><span class="o">(</span><span class="s">&quot;http://api.hostip.info/country.php&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">country</span> <span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Http</span><span class="o">(</span><span class="n">svc</span> <span class="nc">OK</span> <span class="n">as</span><span class="o">.</span><span class="nc">String</span><span class="o">)</span>

<span class="n">println</span><span class="o">(</span><span class="n">country</span><span class="o">())</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that the result <span class="monospaced">country</span> is not a <span class="monospaced">String</span> but a <span class="monospaced">Promise[String]</span>, and we <span class="monospaced">apply</span> to wait for the resulting value.</p></div>
<div class="paragraph"><p>The result printed will be a country code such as <span class="monospaced">GB</span>, or <span class="monospaced">XX</span> if the country cannot be determined from your IP address.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_88">Discussion</h4>
<div class="paragraph"><p>This short example expects a 200 (OK) status result and turns the result into a <span class="monospaced">String</span>, but that a tiny part of what Dispatch is capable of.  We&#8217;ll explore further in this section.</p></div>
<div class="paragraph"><p>What if the request doesn&#8217;t return a 200? In that case, with the code we have, we&#8217;d get an exception such as: "Unexpected response status: 404". There are a few ways to change that.</p></div>
<div class="paragraph"><p>We can ask for an <span class="monospaced">Option</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">result</span> <span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">country</span><span class="o">.</span><span class="n">option</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>As you&#8217;d expect, this will give a <span class="monospaced">None</span> or <span class="monospaced">Some[String]</span>. However, if you have debug level logging enabled in your application you&#8217;ll see the request and response and error messages from the underlying Netty library.  You can tune these messages by adding a logger setting to <span class="monospaced">default.logback.xml</span> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;com.ning.http.client&quot;</span> <span class="na">level=</span><span class="s">&quot;WARN&quot;</span><span class="nt">/&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>A second possibility is to use <span class="monospaced">either</span> with the usual convention that the <span class="monospaced">Right</span> is the expected result and <span class="monospaced">Left</span> signifies a failure:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">country</span><span class="o">.</span><span class="n">either</span><span class="o">()</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Left</span><span class="o">(</span><span class="n">status</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">status</span><span class="o">.</span><span class="n">getMessage</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">Right</span><span class="o">(</span><span class="n">cc</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">cc</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This will print a result as we are forcing the evaluation with an apply via <span class="monospaced">either()</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">Promise[T]</span> implements <span class="monospaced">map</span>, <span class="monospaced">flatMap</span>, <span class="monospaced">filter</span>, <span class="monospaced">fold</span> and all the usual methods you&#8217;d expect to allow you to compose.  This means you can use the promise with a for comprehension:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">codeLength</span> <span class="k">=</span> <span class="k">for</span> <span class="o">(</span><span class="n">cc</span> <span class="k">&lt;-</span> <span class="n">country</span><span class="o">)</span> <span class="k">yield</span> <span class="n">cc</span><span class="o">.</span><span class="n">length</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that <span class="monospaced">codeLength</span> is a <span class="monospaced">Promise[Int]</span>.  To get the value you can evaluate <span class="monospaced">codeLength()</span> and you&#8217;ll get a result of <span class="monospaced">2</span>.</p></div>
<div class="paragraph"><p>As well as extracting string values with <span class="monospaced">as.String</span> there are other options, including&#8230;</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">as.Bytes</span>&#8201;&#8212;&#8201;to work with <span class="monospaced">Promise[Array[Byte]]</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">as.File</span>&#8201;&#8212;&#8201;to write to a file, as in <span class="monospaced">Http(svc &gt; as.File(new File("/tmp/cc")) )</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">as.Response</span>&#8201;&#8212;&#8201;to allow you to provide a <span class="monospaced">client.Response =&gt; T</span> function to use on the response.
</p>
</li>
<li>
<p>
<span class="monospaced">as.xml.Elem</span>&#8201;&#8212;&#8201;to parse XML response.
</p>
</li>
</ul></div>
<div class="paragraph"><p>As an example of <span class="monospaced">as.xml.Elem</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">svc</span> <span class="k">=</span> <span class="n">url</span><span class="o">(</span><span class="s">&quot;http://api.hostip.info/?ip=12.215.42.19&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">country</span>  <span class="k">=</span> <span class="nc">Http</span><span class="o">(</span><span class="n">svc</span> <span class="o">&gt;</span> <span class="n">as</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="nc">Elem</span><span class="o">)</span>
<span class="n">println</span><span class="o">(</span><span class="n">country</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">\\</span> <span class="s">&quot;description&quot;</span><span class="o">)())</span>
</pre></div></div></div>
<div class="paragraph"><p>This example is parsing the XML response to the request, which returns a <span class="monospaced">Promise[scala.xml.Elem]</span>.  We&#8217;re picking out the description node of the XML via a <span class="monospaced">map</span>, which will be a <span class="monospaced">Promise[NodeSeq]</span> which we then force to evaluate.  The output is something like:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;gml:description</span>
  <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="na">xmlns:gml=</span><span class="s">&quot;http://www.opengis.net/gml&quot;</span><span class="nt">&gt;</span>
     This is the Hostip Lookup Service
<span class="nt">&lt;/gml:description&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>That example assumes the request is going to be well-formed. In addition to the core Databinder library, there are extensions for JSoup and TagSoup to assist in parsing HTML that isn&#8217;t necessarily well-formed.</p></div>
<div class="paragraph"><p>For example, to use JSoup, include the dependency:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&quot;net.databinder.dispatch&quot;</span> <span class="o">%%</span> <span class="s">&quot;dispatch-jsoup&quot;</span> <span class="o">%</span> <span class="s">&quot;0.9.5&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>You can then use the features of JSoup, such as picking out elements of a page using CSS selectors:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">org.jsoup.nodes.Document</span>

<span class="k">val</span> <span class="n">svc</span> <span class="k">=</span> <span class="n">url</span><span class="o">(</span><span class="s">&quot;http://www.example.org&quot;</span><span class="o">).</span><span class="n">setFollowRedirects</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="k">val</span> <span class="n">title</span> <span class="k">=</span> <span class="nc">Http</span><span class="o">(</span><span class="n">svc</span> <span class="o">&gt;</span> <span class="n">as</span><span class="o">.</span><span class="n">jsoup</span><span class="o">.</span><span class="nc">Document</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;h1&quot;</span><span class="o">).</span><span class="n">text</span><span class="o">).</span><span class="n">option</span>
<span class="n">println</span><span class="o">(</span> <span class="n">title</span><span class="o">()</span> <span class="n">getOrElse</span> <span class="s">&quot;unknown title&quot;</span> <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>He we are applying JSoup&#8217;s <span class="monospaced">select</span> function to pick out the <span class="monospaced">&lt;h1&gt;</span> element on the page, taking the text of the element which we turn into a <span class="monospaced">Promise[Option[String]]</span>.  The result, unless <em>example.org</em> has changed, will be "Example Domain".</p></div>
<div class="paragraph"><p>As a final example of using Dispatch, we can pipe a request into Lift&#8217;s JSON library:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftweb.json._</span>
<span class="k">import</span> <span class="nn">com.ning.http.client</span>

<span class="k">object</span> <span class="nc">asJson</span> <span class="k">extends</span> <span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="nc">Response</span> <span class="k">=&gt;</span> <span class="nc">JValue</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">client.Response</span><span class="o">)</span> <span class="k">=</span> <span class="nc">JsonParser</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">getResponseBody</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">svc</span> <span class="k">=</span> <span class="n">url</span><span class="o">(</span><span class="s">&quot;http://api.hostip.info/get_json.php?ip=212.58.241.131&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">json</span> <span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">JValue</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Http</span><span class="o">(</span><span class="n">svc</span> <span class="o">&gt;</span> <span class="n">asJson</span><span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">HostInfo</span><span class="o">(</span><span class="n">country_name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">country_code</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">formats</span> <span class="k">=</span> <span class="nc">DefaultFormats</span>

<span class="k">val</span> <span class="n">hostInfo</span> <span class="k">=</span> <span class="n">json</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">extract</span><span class="o">[</span><span class="kt">HostInfo</span><span class="o">])()</span>
</pre></div></div></div>
<div class="paragraph"><p>The URL we&#8217;re calling returns a JSON representation for location information for the IP address we&#8217;ve passed.</p></div>
<div class="paragraph"><p>By providing a <span class="monospaced">Response =&gt; JValue</span> to Dispatch we&#8217;re able to pass the response body through to the JSON parser. We can then map on the <span class="monospaced">Promise[JValue]</span> to apply whatever Lift JSON functions we want to. In this case, we&#8217;re extracting a simple case class.</p></div>
<div class="paragraph"><p>The result from the above would show <span class="monospaced">hostInfo</span> as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">HostInfo</span><span class="o">(</span><span class="nc">UNITED</span> <span class="nc">KINGDOM</span><span class="o">,</span><span class="nc">GB</span><span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_86">See Also</h4>
<div class="paragraph"><p>The Dispatch documentation is well-written and guides you through the way Dispatch approaches HTTP.  Do spend some time with it at: <a href="http://dispatch.databinder.net/Dispatch.html">http://dispatch.databinder.net/Dispatch.html</a>.</p></div>
<div class="paragraph"><p>To see what&#8217;s available on Dispatch&#8217;s <span class="monospaced">Promise</span>, browse the source: <a href="https://github.com/dispatch/reboot/blob/master/core/src/main/scala/promise.scala">https://github.com/dispatch/reboot/blob/master/core/src/main/scala/promise.scala</a>.</p></div>
<div class="paragraph"><p>For questions about Dispatch, the best place is the Dispatch Google Group: <a href="https://groups.google.com/forum/!forum/dispatch-scala">https://groups.google.com/forum/!forum/dispatch-scala</a>.</p></div>
<div class="paragraph"><p>The previous major version of Dispatch, 0.8.x ("Dispatch Classic"), is quite different from the "reboot" of the project as version 0.9.  Consequently, examples you may see that use 0.8.x will need some conversion to run with 0.9.x.  Nathan Hamblen&#8217;s blog describes the change: <a href="http://code.technically.us/post/17038250904/fables-of-the-reconstruction-part-2-have-you-tried">http://code.technically.us/post/17038250904/fables-of-the-reconstruction-part-2-have-you-tried</a>.</p></div>
<div class="paragraph"><p>For working with JSoup, take a look at the JSoup Cookbook at: <a href="http://jsoup.org/cookbook/">http://jsoup.org/cookbook/</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deployment">Production Deployment</h2>
<div class="sectionbody">
<div class="paragraph"><p>Deploying a Lift application to production means little more than packaging it and ensuring you set the <em>run mode</em> to <span class="monospaced">production</span>. The recipes in this chapter show how to do this for various hosted services.</p></div>
<div class="paragraph"><p>You can also install and run a <em>container</em> such as Tomcat or Jetty on your own servers. Containers were introduced in <a href="#RunningYourApplication">[RunningYourApplication]</a>. This brings with it the need to understand how to install, configure, start, stop and manage each container, and how to integrate it with load balancers or other front-ends. These are large topics, and you can find out more from such sources as:</p></div>
<div class="ulist"><ul>
<li>
<p>
The deployment section of the Lift Wiki at <a href="https://www.assembla.com/spaces/liftweb/wiki/Deployment">https://www.assembla.com/spaces/liftweb/wiki/Deployment</a>.
</p>
</li>
<li>
<p>
Timothy Perrett (2012), <em>Lift in Action</em>, Chapter 15, "Deployment and scaling", Manning Publications Co.
</p>
</li>
<li>
<p>
Jason Brittain and Ian F. Darwin (2007), <em>Tomcat: The Definitive Guide</em>, O&#8217;Reilly Media, Inc.
</p>
</li>
<li>
<p>
Tanuj Khare (2012) <em>Apache Tomcat 7 Essentials</em>, Packt Publishing.
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="CloudBees">Deploying to CloudBees</h3>
<div class="sect3">
<h4 id="_problem_88">Problem</h4>
<div class="paragraph"><p>You have an account with the CloudBees PaaS hosting environment, and you
want to deploy your Lift application there.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_88">Solution</h4>
<div class="paragraph"><p>Use the SBT <span class="monospaced">package</span> command to produce a WAR file that can be deployed
to CloudBees, and then use the CloudBees SDK to configure and deploy your
application.</p></div>
<div class="paragraph"><p>From within the CloudBees "Grand Central" console, create a new application under your account. In what follows we&#8217;ll assume your account is called <em>myaccount</em> and your application is called <em>myapp</em>.</p></div>
<div class="paragraph"><p>For the best performance you will want to ensure the Lift run mode is set to
"production". Do this from the CloudBees SDK command line:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees config:set -a myaccount/myapp run.mode<span class="o">=</span>production
</pre></div></div></div>
<div class="paragraph"><p>This will set the run mode to production for your CloudBees applications
identified as "myaccount/myapp". Omitting the <span class="monospaced">-a</span> will set it for your
whole CloudBees account.</p></div>
<div class="paragraph"><p>CloudBees will remember this setting, so you only need to do it once.</p></div>
<div class="paragraph"><p>You can then deploy:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sbt package
...
<span class="o">[</span>info<span class="o">]</span> Packaging /Users/richard/myapp/target/scala-2.9.1/myapp.war...
...
<span class="nv">$ </span>bees app:deploy -a myaccount/myapp ./target/scala-2.9.1/myapp.war
</pre></div></div></div>
<div class="paragraph"><p>This will send your WAR file to CloudBees and deploy it.  You&#8217;ll see the location (URL) of your application output from the bees <span class="monospaced">app:deploy</span> command when it completes.</p></div>
<div class="paragraph"><p>If you change a configuration setting, you will need to restart the application for setting
to take effect. Deploying the application will do this, otherwise run the <span class="monospaced">bees app:restart</span> command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees app:restart -a myaccount/myapp
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_89">Discussion</h4>
<div class="paragraph"><p>If you are deploying an application to multiple CloudBees
instances, be aware that by default CloudBees will round robin requests
to each instance. If you use any of Lift&#8217;s state features you&#8217;ll want to
enable session affinity (sticky sessions):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees app:update -a myaccount/myapp <span class="nv">stickySession</span><span class="o">=</span><span class="nb">true</span>
</pre></div></div></div>
<div class="paragraph"><p>If you are using comet, it&#8217;ll work fine, but the CloudBees default is to enable
<em>request buffering</em>. This allows CloudBees to do smart things, such as re-routing
requests in a cluster if one machine does not respond. A
consequence of request buffering is that long-polling comet requests will timeout more
often. To turn this feature off, run the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees app:update -a myaccount/myapp <span class="nv">disableProxyBuffering</span><span class="o">=</span><span class="nb">true</span>
</pre></div></div></div>
<div class="paragraph"><p>As with the run mode setting, CloudBees will remember these settings, so you
only need to set them once.</p></div>
<div class="paragraph"><p>Finally, you may want to increase the <em>permanent generation</em> memory setting of the JVM. By default, an application has 64M assigned for the permgen. To increase this to 128M, run the <span class="monospaced">bees app:update</span> commannd:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees app:update -a myaccount/myapp <span class="nv">jvmPermSize</span><span class="o">=</span>128
</pre></div></div></div>
<div class="paragraph"><p>The commands <span class="monospaced">bees app:info</span> and <span class="monospaced">bees config:list</span> will report back the settings for your application.</p></div>
<div class="sect4">
<h5 id="_rdbms_configuration">RDBMS Configuration</h5>
<div class="paragraph"><p>If you are using a SQL database in your application, you&#8217;ll want to
configure <span class="monospaced">src/main/webapp/WEB-INF/cloudbees-web.xml</span>. For
example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;cloudbees-web-app</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.cloudbees.com/xml/webapp/1&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;appid&gt;</span>myaccount/myapp<span class="nt">&lt;/appid&gt;</span>

<span class="nt">&lt;resource</span> <span class="na">name=</span><span class="s">&quot;jdbc/mydb&quot;</span> <span class="na">auth=</span><span class="s">&quot;Container&quot;</span> <span class="na">type=</span><span class="s">&quot;javax.sql.DataSource&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;dbuser&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;dbpassword&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;jdbc:cloudbees://mydb&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- For these connections settings, see:</span>
<span class="c">   http://commons.apache.org/dbcp/configuration.html</span>
<span class="c">  --&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;maxActive&quot;</span> <span class="na">value=</span><span class="s">&quot;10&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;maxIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;2&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;maxWait&quot;</span> <span class="na">value=</span><span class="s">&quot;15000&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;removeAbandoned&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;removeAbandonedTimeout&quot;</span> <span class="na">value=</span><span class="s">&quot;300&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;logAbandoned&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- Avoid idle timeouts --&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;validationQuery&quot;</span> <span class="na">value=</span><span class="s">&quot;SELECT 1&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;testOnBorrow&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>

 <span class="nt">&lt;/resource&gt;</span>

<span class="nt">&lt;/cloudbees-web-app&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>The above is a JNDI database configuration, defining a connection to a
CloudBees database called "mydb". This will be used by Lift if the JNDI
name is referenced in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">DefaultConnectionIdentifier</span><span class="o">.</span><span class="n">jndiName</span> <span class="k">=</span> <span class="s">&quot;jdbc/mydb&quot;</span>

<span class="k">if</span> <span class="o">(!</span><span class="nc">DB</span><span class="o">.</span><span class="n">jndiJdbcConnAvailable_?</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// set up alternative local database connection here</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Because the JDNI setting is only defined in <span class="monospaced">cloudbees-web.xml</span> it will
only be available in a CloudBees environment. This means you can develop
against a different database locally, and use your CloudBees database
when deploying.</p></div>
</div>
<div class="sect4">
<h5 id="_host_ip_and_port_number">Host IP and Port Number</h5>
<div class="paragraph"><p>Generally you don&#8217;t need to know about your deployed instance&#8217;s public host name and port number. Requests to your application URL are routed to the specific instance by CloudBees. However there are situations, especially when you have multiple instances, where you do need to find this out. For example, if you want to receive messages from Amazon&#8217;s Simple Notification Service (SNS), then each instance will need to give a direct URL to SNS when the application boots.</p></div>
<div class="paragraph"><p>To get the public hostname, you need to make a HTTP request to <span class="monospaced">http://instance-data/latest/meta-data/public-hostname</span>, as documented at <a href="https://developer.cloudbees.com/bin/view/Main/Finding+out+app+port+and+hostname">https://developer.cloudbees.com/bin/view/Main/Finding+out+app+port+and+hostname</a>.  For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">io.Source</span>

<span class="k">val</span> <span class="n">beesPublicHostname</span> <span class="k">:</span> <span class="kt">Box</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">tryo</span> <span class="o">{</span>
  <span class="nc">Source</span><span class="o">.</span><span class="n">fromURL</span><span class="o">(</span><span class="s">&quot;http://instance-data/latest/meta-data/public-hostname&quot;</span><span class="o">).</span>
    <span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">head</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This will return a <span class="monospaced">Full</span> hostname on the CloudBees environment, but when running locally will fail and return a <span class="monospaced">Failure</span>. For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Failure</span><span class="o">(</span><span class="n">instance</span><span class="o">-</span><span class="n">data</span><span class="o">,</span><span class="nc">Full</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="nc">UnknownHostException</span><span class="k">:</span> <span class="kt">instance-data</span><span class="o">),</span><span class="nc">Empty</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>The port number can be found from the name of a file in the <span class="monospaced">.genapps/ports</span> folder of your application deployment:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">val</span> <span class="n">beesPort</span> <span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">portsDir</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">getenv</span><span class="o">(</span><span class="s">&quot;PWD&quot;</span><span class="o">),</span> <span class="s">&quot;.genapp/ports&quot;</span><span class="o">)</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">files</span> <span class="k">&lt;-</span> <span class="nc">Option</span><span class="o">(</span><span class="n">portsDir</span><span class="o">.</span><span class="n">list</span><span class="o">)</span>
    <span class="n">port</span> <span class="k">&lt;-</span> <span class="n">files</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">asInt</span><span class="o">).</span><span class="n">headOption</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">port</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The <span class="monospaced">java.io.File#list</span> method returns a list of filenames in a directory, but will return null if the directory doesn&#8217;t exist or if there are any IO errors.  For this reason, we wrap it in <span class="monospaced">Option</span> to convert null values to <span class="monospaced">None</span>.</p></div>
<div class="paragraph"><p>Running locally this will return a <span class="monospaced">None</span>, but on CloudBees you&#8217;ll see a <span class="monospaced">Full[Int]</span> port number.</p></div>
<div class="paragraph"><p>You might put these two values together as follows:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">java.net.InetAddress</span>

<span class="k">val</span> <span class="n">hostAndPort</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
  <span class="o">(</span><span class="n">beesPublicHostname</span> <span class="n">openOr</span> <span class="nc">InetAddress</span><span class="o">.</span><span class="n">getLocalHost</span><span class="o">.</span><span class="n">getHostAddress</span><span class="o">)</span> <span class="o">+</span>
  <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">beesPort</span> <span class="n">getOrElse</span> <span class="mi">8080</span><span class="o">).</span><span class="n">toString</span>
</pre></div></div></div>
<div class="paragraph"><p>Running locally <span class="monospaced">hostAndPort</span> might be <span class="monospaced">192.168.1.60:8080</span> and running on CloudBees it would be something like <span class="monospaced">ec2-204-236-222-252.compute-1.amazonaws.com:8520</span>.</p></div>
</div>
<div class="sect4">
<h5 id="_java_version">Java Version</h5>
<div class="paragraph"><p>Currently the default JVM provided by CloudBees is JDK 7, but you can select 6, 7 and 8.
To change the default Java Virtual Machine, use the <span class="monospaced">bees config:set</span> command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees config:set -a myaccount/myapp -Rjava_version<span class="o">=</span>1.8
</pre></div></div></div>
<div class="paragraph"><p>Excluding the application identifier <span class="monospaced">-a myaccount/myapp</span> from the command will set the JVM as the default for all applications in the account. The  <span class="monospaced">bees config:set</span> command will update the configuration, but not take effect until the application(s) have been updated or restarted.</p></div>
<div class="paragraph"><p>The JVM can also be changed when an application is deployed or updated via following commands:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees app:deploy -a myaccount/myapp sample.war  -Rjava_version<span class="o">=</span>1.6
<span class="nv">$ </span>bees app:update -a myaccount/myapp -Rjava_version<span class="o">=</span>1.7
</pre></div></div></div>
<div class="paragraph"><p>To confirm which JVM an application is currently running, use the
<span class="monospaced">bees config:list</span> command, which will display Java version. As can be seen below:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees config:list -a myaccount/myapp
Runtime Parameters:
  <span class="nv">java_version</span><span class="o">=</span>1.6
</pre></div></div></div>
</div>
<div class="sect4">
<h5 id="_container_version">Container Version</h5>
<div class="paragraph"><p>CloudBees offer several containers: Tomcat 6.0.32 (the default), Tomcat 7, JBoss 7.02, JBoss 7.1 and GlassFish 3.</p></div>
<div class="paragraph"><p>To change containers the application will need to be redeployed as CloudBees uses different file configurations for the various containers.  Hence we use the <span class="monospaced">bees app:deploy</span> command. The following example updates to Tomcat 7:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees app:deploy -t tomcat7 -a myaccount/myapp sample.war
</pre></div></div></div>
<div class="paragraph"><p>The JVM and container commands can be run as a single <span class="monospaced">bees app:deploy</span> as follows:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees app:deploy -t tomcat -a myaccount/myapp sample.war -Rjava_version<span class="o">=</span>1.6
</pre></div></div></div>
<div class="paragraph"><p>This would deploy <span class="monospaced">sample.war</span> to the "myapp" application on "myaccount" with Tomcat 6.0.32 and JDK 6.</p></div>
<div class="paragraph"><p>To determine which container an application is deployed to, use the command <span class="monospaced">bees app:info</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>bees app:info -a myaccount/myapp
Application     : myaccount/myapp
Title           : myapp
Created         : Wed Mar 20 11:02:40 EST 2013
Status          : active
URL             : myapp.myaccount.cloudbees.net
clusterSize     : 1
container       : java_free
containerType   : tomcat
idleTimeout     : 21600
maxMemory       : 256
proxyBuffering  : <span class="nb">false</span>
securityMode    : PUBLIC
serverPool      : stax-global <span class="o">(</span>Stax Global Pool<span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect4">
<h5 id="_clickstarts">ClickStarts</h5>
<div class="paragraph"><p>ClickStart Applications are templates to quickly get an application, and automated build, up and running at CloudBees. The Lift ClickStart creates a private Git source repository at CloudBees which contains a Lift 2.4 application, provisions a MySQL database, creates a Maven-based Jenkins build, and deploys the application.  All you need to do is provide a name for the application (without whitespace).</p></div>
<div class="paragraph"><p>To access the Git source repository created for you, you&#8217;ll need to upload a SSH public key. You can do this in the "My Keys" section of your account settings on the CloudBees web site.</p></div>
<div class="paragraph"><p>The build that&#8217;s created for you will automatically build and deploy your application to CloudBees when you push changes to your Git repository.</p></div>
<div class="paragraph"><p>If all of that&#8217;s a good match to the technologies and services you want to use, ClickStart is a great way to deploy your application. Alternatively, it gives you a starting point from which you can modify elements; or you could fork the CloudBees Lift template and create your own from <a href="https://github.com/CloudBees-community/lift_template">https://github.com/CloudBees-community/lift_template</a>.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_87">See Also</h4>
<div class="paragraph"><p>The CloudBees SDK provides command line tools for configuring and controlling applications. It can be found at <a href="https://wiki.cloudbees.com/bin/view/RUN/BeesSDK">https://wiki.cloudbees.com/bin/view/RUN/BeesSDK</a>.</p></div>
<div class="paragraph"><p>The CloudBees developer portal (<a href="https://developer.cloudbees.com">https://developer.cloudbees.com</a>)contains a "Resources" section which provides details of the CloudBees services.</p></div>
<div class="paragraph"><p>The JVM PermGen settings for CloudBees are described at <a href="https://wiki.cloudbees.com/bin/view/RUN/JVM+PermGen+Space">https://wiki.cloudbees.com/bin/view/RUN/JVM+PermGen+Space</a>, and settings for which JVM is used can be found at <a href="https://developer.cloudbees.com/bin/view/RUN/JVMVersion">https://developer.cloudbees.com/bin/view/RUN/JVMVersion</a>. For information about the containers, see: <a href="https://developer.cloudbees.com/bin/view/RUN/ClickStack">https://developer.cloudbees.com/bin/view/RUN/ClickStack</a>.</p></div>
<div class="paragraph"><p>A plugin is available to automate deployments from SBT. The plugin and the excellent
instructions for installing and configuring it can be found at <a href="https://github.com/timperrett/sbt-cloudbees-plugin">https://github.com/timperrett/sbt-cloudbees-plugin</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="Beanstalk">Deploying to Amazon Elastic Beanstalk</h3>
<div class="sect3">
<h4 id="_problem_89">Problem</h4>
<div class="paragraph"><p>You want to run your Lift application on Amazon Web Services (AWS) Elastic Beanstalk.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_89">Solution</h4>
<div class="paragraph"><p>Create a new Tomcat 7 <em>environment</em>, use SBT to package your Lift application as a WAR file, and then deploy the application to your environment.</p></div>
<div class="paragraph"><p>To create a new environment, visit the AWS console, navigate to Elastic Beanstalk and select "Apache Tomcat 7" as your environment. This will create and launch a default Beanstalk application. This will take a few minutes, but eventually report "Successfully running version Sample Application". You&#8217;ll be shown the URL of the application (something like <span class="monospaced">http://default-environment-nsdmixm7ja.elasticbeanstalk.com</span>) and visiting the URL you&#8217;re given will show the running default Amazon application.</p></div>
<div class="paragraph"><p>Prepare your WAR file by running:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sbt package
</pre></div></div></div>
<div class="paragraph"><p>This will write a WAR file into the <span class="monospaced">target</span> folder.  To deploy this WAR file from the AWS Beanstalk web console (see <a href="#ConsoleImage">[ConsoleImage]</a>), select the "Versions" tab under the "Elastic Beanstalk Application Details" and click the "Upload new version" button. You&#8217;ll be given a dialog where you give a version label and use the "Choose file" button to select the WAR file you just built.  You can either upload and deploy in one step, or upload first and then select the version in the console and hit the "Deploy" button.</p></div>
<div class="paragraph"><p>The Beanstalk console will show "Environment updating&#8230;" and after some minutes it&#8217;ll report "Successfully running".  Your Lift application is now deployed and running on Beanstalk.</p></div>
<div class="paragraph"><p>A final step is to enable Lift&#8217;s production run mode. From the environment in the AWS Beanstalk web console, follow the "Edit Configuration" link. A dialog will appear, and under the "Container" tab add <span class="monospaced">-Drun.mode=production</span> to the "JVM Command Line Options" and hit "Apply Changes" to redeploy your application.</p></div>
<div class="imageblock" id="ConsoleImage">
<div class="content">
<img src="images/beanstalkconsole.png" alt="images/beanstalkconsole.png" width="640">
</div>
<div class="title">Figure 6. AWS Console, with Elastic Beanstalk service selected.</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_90">Discussion</h4>
<div class="paragraph"><p>Elastic Beanstalk provides a pre-built stack of software and infrastructure, in this case: Linux, Tomcat 7, a 64 bit "t1.micro" EC2 instance, load balancing, and an S3 bucket. That&#8217;s the <em>environment</em> and it has reasonable default settings.  Beanstalk also provides an easy way to deploy your Lift application.  As we&#8217;ve seen in this recipe, you upload an application (WAR file) to Beanstalk and deploy it to the environment.</p></div>
<div class="paragraph"><p>As with many cloud providers keep in mind that you want to avoid local file storage. The reason for this is to allow instances to be terminated or restarted without data loss. With your Beanstalk application you do have a file system and you can write to it, but it is lost if the image is restarted. You can get persistent local file storage, for example using Amazon Elastic Block Storage, but you&#8217;re fighting against the nature of the platform.</p></div>
<div class="paragraph"><p>Log files are written to the local file system. To access them, from the AWS console, navigate to your environment, into the "Logs" tab and hit the "Snapshot" button. This will take a copy of the logs and store them in an S3 bucket, and give you a link to the file contents.  This is a single file showing the content of variety of log files, and <span class="monospaced">catalina.out</span> will be the one showing any output from your Lift application.  If you want to try to keep these log files around, you can configure the environment to rotate the logs to S3 every hour from the "Container" tab under "Edit Configuration".</p></div>
<div class="paragraph"><p>The Lift application WAR files are stored in the same S3 bucket that the logs are stored in. From the AWS console, you&#8217;ll find it under the S3 page listed with a name like <span class="monospaced">elasticbeanstalk-us-east-1-5989673916964</span>. You&#8217;ll note that the AWS uploads makes your WAR filename unique by adding a prefix to each filename. If you need to be able to tell the difference between these files in S3, one good approach is to is to bump the <span class="monospaced">version</span> value in your <span class="monospaced">build.sbt</span> file.  This version number is included in the WAR filename.</p></div>
<div class="sect4">
<h5 id="_multiple_instances">Multiple Instances</h5>
<div class="paragraph"><p>Beanstalks enables <em>auto scaling</em> by default. That is, it launches a single instance of your Lift application, but if the load increases above a threshold, up to four instances may be running.</p></div>
<div class="paragraph"><p>If you&#8217;re making use of Lift&#8217;s state features, you&#8217;ll need to enable sticky sessions from the "Load Balancer" tab of the environment configuration. It&#8217;s a check box named "Enable Session Stickiness"--it&#8217;s easy to miss, but that tab does scroll to show more options if you don&#8217;t see it first time.</p></div>
</div>
<div class="sect4">
<h5 id="_working_with_a_database">Working with a Database</h5>
<div class="paragraph"><p>There&#8217;s nothing unusual you have to do to use Lift and a database from Beanstalk. However, Beanstalk does try to make it easy for you to work with Amazon&#8217;s Relational Database Service (RDS).  Either when creating your Beanstalk environment, or from the configuration options later, you can add an RDS instance, which cab be an Oracle, SQL-Server or MySQL database.</p></div>
<div class="paragraph"><p>The MySQL option will create a MySQL 5.5 InnoDB database. The database will be accessible from Beanstalk, but not from elsewhere on the Internet. To change that, modify the security groups for the RDS instance from the AWS web console.  For example, you might permit access from your IP address.</p></div>
<div class="paragraph"><p>When your application launches with an associated RDS instance, the JVM system properties include settings for the database name, host, port, user and password.  You could pull them together like this in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Class</span><span class="o">.</span><span class="n">forName</span><span class="o">(</span><span class="s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">connection</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">host</span> <span class="k">&lt;-</span> <span class="nc">Box</span> <span class="o">!!</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;RDS_HOSTNAME&quot;</span><span class="o">)</span>
  <span class="n">port</span> <span class="k">&lt;-</span> <span class="nc">Box</span> <span class="o">!!</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;RDS_PORT&quot;</span><span class="o">)</span>
  <span class="n">db</span>   <span class="k">&lt;-</span> <span class="nc">Box</span> <span class="o">!!</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;RDS_DB_NAME&quot;</span><span class="o">)</span>
  <span class="n">user</span> <span class="k">&lt;-</span> <span class="nc">Box</span> <span class="o">!!</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;RDS_USERNAME&quot;</span><span class="o">)</span>
  <span class="n">pass</span> <span class="k">&lt;-</span> <span class="nc">Box</span> <span class="o">!!</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;RDS_PASSWORD&quot;</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(</span>
    <span class="s">&quot;jdbc:mysql://%s:%s/%s&quot;</span> <span class="n">format</span> <span class="o">(</span><span class="n">host</span><span class="o">,</span><span class="n">port</span><span class="o">,</span><span class="n">db</span><span class="o">),</span>
    <span class="n">user</span><span class="o">,</span> <span class="n">pass</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>That would give you a <span class="monospaced">Box[Connection]</span> which, if <span class="monospaced">Full</span>, you could use in a <span class="monospaced">SquerylRecord.initWithSquerylSession</span> call for example (see <a href="#Squeryl">[Squeryl]</a>).</p></div>
<div class="paragraph"><p>Alternatively you might want to guarantee a connection by supplying defaults for all the values with something like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Class</span><span class="o">.</span><span class="n">forName</span><span class="o">(</span><span class="s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">connection</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">host</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;RDS_HOSTNAME&quot;</span><span class="o">,</span> <span class="s">&quot;localhost&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">port</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;RDS_PORT&quot;</span><span class="o">,</span> <span class="s">&quot;3306&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">db</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;RDS_DB_NAME&quot;</span><span class="o">,</span> <span class="s">&quot;db&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">user</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;RDS_USERNAME&quot;</span><span class="o">,</span> <span class="s">&quot;sa&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">pass</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">getProperty</span><span class="o">(</span><span class="s">&quot;RDS_PASSWORD&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">)</span>

  <span class="nc">DriverManager</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(</span>
    <span class="s">&quot;jdbc:mysql://%s:%s/%s&quot;</span> <span class="n">format</span> <span class="o">(</span><span class="n">host</span><span class="o">,</span><span class="n">port</span><span class="o">,</span><span class="n">db</span><span class="o">),</span>
    <span class="n">user</span><span class="o">,</span> <span class="n">pass</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_88">See Also</h4>
<div class="paragraph"><p>Amazon provide a walk-through with screen shots, showing how to create a Beanstalk application.  It&#8217;s at: <a href="http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/GettingStarted.Walkthrough.html">http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/GettingStarted.Walkthrough.html</a>.</p></div>
<div class="paragraph"><p><em>Elastic Beanstalk</em>, by van Villet <em>et al</em> (2011, O&#8217;Reilly Media, Inc) goes into the details of the Beanstalk infrastructure, how to work with Eclipse, enabling continuous integration, and how to hack the instance, for example to use NGINX as a front-end to Beanstalk.</p></div>
<div class="paragraph"><p>The Amazon documentation for "Configuring Databases with AWS Elastic Beanstalk" describes the RDS settings in more detail: <a href="http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/using-features.managing.db.html">http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/using-features.managing.db.html</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="HerokuDeployment">Deploying to Heroku</h3>
<div class="sect3">
<h4 id="_problem_90">Problem</h4>
<div class="paragraph"><p>You want to deploy your Lift application to your account on the Heroku cloud platform.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_90">Solution</h4>
<div class="paragraph"><p>Package your Lift application as a WAR file and use the Heroku deploy plugin to send and run your application. This will give you an application running under Tomcat 7. Anyone can use this method to deploy an application but Heroku only provide support for it for Enterprise Java customers.</p></div>
<div class="paragraph"><p>This recipe walks through the process in three stages: one-time set up; deployment of the WAR; and configuration of your Lift application for production performance.</p></div>
<div class="paragraph"><p>If you&#8217;ve not already done so, download and install the Heroku command line tools ("Toolbelt") and login using your Heuroku credentials and upload an SSH key:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ heroku login
Enter your Heroku credentials.
Email: you@example.org
Password (typing will be hidden):
Found the following SSH public keys:
1) github.pub
2) id_rsa.pub
Which would you like to use with your Heroku account? 2
Uploading SSH public key ~/.ssh/id_rsa.pub... done
Authentication successful.</pre>
</div></div>
<div class="paragraph"><p>Install the deploy plugin:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ heroku plugins:install https://github.com/heroku/heroku-deploy
Installing heroku-deploy... done</pre>
</div></div>
<div class="paragraph"><p>With that one-time set up complete, you can create an application on Heroku. Here we&#8217;ve not specified a name so we given a random name of <span class="monospaced">glacial-waters-6292</span> which we will use throughout this recipe:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ heroku create
Creating glacial-waters-6292... done, stack is cedar
http://glacial-waters-6292.herokuapp.com/ | git@heroku.com:glacial-waters-6292.git</pre>
</div></div>
<div class="paragraph"><p>Before deploying, we set the Lift run mode to production.  This is done via the <span class="monospaced">config:set</span> command.  First check the current settings for <span class="monospaced">JAVA_OPTS</span> and then modify the options by adding <span class="monospaced">-Drun.mode=production</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ heroku config:get JAVA_OPTS --app glacial-waters-6292
-Xmx384m -Xss512k -XX:+UseCompressedOops

$ heroku config:set JAVA_OPTS="-Drun.mode=production -Xmx384m -Xss512k
  -XX:+UseCompressedOops" --app glacial-waters-6292</pre>
</div></div>
<div class="paragraph"><p>We can deploy to Heroku by packaging the application as a WAR file, and then running the Heroku <span class="monospaced">deploy:war</span> command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sbt package
....
<span class="o">[</span>info<span class="o">]</span> Packaging target/scala-2.9.1/myapp-0.0.1.war ...
....
<span class="nv">$ </span>heroku deploy:war --war target/scala-2.9.1/myapp-0.0.1.war
  --app glacial-waters-6292
Uploading target/scala-2.9.1/myapp-0.0.1.war............done
Deploying to glacial-waters-6292.........done
Created release v6
</pre></div></div></div>
<div class="paragraph"><p>Your Lift application is now running on Heroku.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_91">Discussion</h4>
<div class="paragraph"><p>There are a few important comments regarding Lift applications on Heroku. First, note that there&#8217;s no support for session affinity. This means if you deploy to multiple <em>dynos</em> (Heroku terminology for instances), there is no co-ordination over which requests go to which servers. As a consequence, you won&#8217;t be able to make use of Lift&#8217;s stateful features and will want to turn them off (<a href="#RunningStateless">[RunningStateless]</a> describes for how to do that).</p></div>
<div class="paragraph"><p>Second, if you are using Lift comet features, there&#8217;s an adjustment to make in <span class="monospaced">Boot.scala</span> to work a little better in the Heroku environment:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">LiftRules</span><span class="o">.</span><span class="n">cometRequestTimeout</span> <span class="k">=</span> <span class="nc">Full</span><span class="o">(</span><span class="mi">25</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This setting controls how long Lift waits before testing a comet connection. We&#8217;re replacing the Lift default of 120 seconds
with 25 seconds because Heroku terminates connections after 30 seconds.  Although Lift recovers from this, the user experience may be to see a delay when interacting with a page.</p></div>
<div class="paragraph"><p>A third important point to note is that the dyno will be restarted every day. Additionally, if you are only running one web dyno, it will be idled after an hour of inactivity. You can see this happening by tailing your application log:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>heroku logs -t --app glacial-waters-6292
...
2012-12-31T11:31:39+00:00 heroku<span class="o">[</span>web.1<span class="o">]</span>: Idling
2012-12-31T11:31:41+00:00 heroku<span class="o">[</span>web.1<span class="o">]</span>: Stopping all processes with SIGTERM
2012-12-31T11:31:43+00:00 heroku<span class="o">[</span>web.1<span class="o">]</span>: Process exited with status 143
2012-12-31T11:31:43+00:00 heroku<span class="o">[</span>web.1<span class="o">]</span>: State changed from up to down
</pre></div></div></div>
<div class="paragraph"><p>Anyone visiting your Lift application will cause Heroku to unidle your application.</p></div>
<div class="paragraph"><p>Note, though, that the application was stopped with a <span class="monospaced">SIGTERM</span>.  This is a Unix signal sent to a process, the JVM in this case, to request it to stop.  Unfortunately the Tomcat application on Heroku does not use this signal to request Lift to shutdown. This may be of little consequence to you, but if you do have external resources you want to release to other actions to take at shutdown, you need to register a shutdown hook with the JVM.</p></div>
<div class="paragraph"><p>For example, you might add this to <span class="monospaced">Boot.scala</span> if you&#8217;re running on Heroku:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="o">().</span><span class="n">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="nc">Thread</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="s">&quot;Shutdown hook being called&quot;</span><span class="o">)</span>
    <span class="c1">// Do useful clean up here</span>
  <span class="o">}</span>
<span class="o">})</span>
</pre></div></div></div>
<div class="paragraph"><p>Do not count on being able to do much during shutdown.  Heroku allows around 10 seconds before killing the JVM after issuing the <span class="monospaced">SIGTERM</span>.</p></div>
<div class="paragraph"><p>Possibly a more general approach is to perform clean up using Lift&#8217;s unload hooks (see <a href="#ShutdownHooks">[ShutdownHooks]</a>) and then arrange the hooks to be called when Heroku sends the signal to terminate:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="o">().</span><span class="n">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="nc">Thread</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">LiftRules</span><span class="o">.</span><span class="n">unloadHooks</span><span class="o">.</span><span class="n">toList</span><span class="o">.</span><span class="n">foreach</span><span class="o">{</span> <span class="n">f</span> <span class="k">=&gt;</span> <span class="n">tryo</span> <span class="o">{</span> <span class="n">f</span><span class="o">()</span> <span class="o">}</span> <span class="o">}</span>
  <span class="o">}</span>
<span class="o">})</span>
</pre></div></div></div>
<div class="paragraph"><p>This handling of <span class="monospaced">SIGTERM</span> may be a surprise, but if we look at how the application is running on Heroku, things become clearer.  The dyno is an allocation of resources (512m of memory) and allows an arbitrary command to run. The command being run is a Java process starting a "webapp runner" package. You can see this in two ways. First, if you shell to your dyno, you&#8217;ll see a WAR file as well as a JAR file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>heroku run bash --app glacial-waters-6292
Running <span class="sb">`</span>bash<span class="sb">`</span> attached to terminal... up, run.8802
~ <span class="nv">$ </span>ls
Procfile  myapp-0.0.1.war  webapp-runner-7.0.29.3.jar
</pre></div></div></div>
<div class="paragraph"><p>Second, by looking at the processes executing:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>heroku ps --app glacial-waters-6292
<span class="o">===</span> web: <span class="sb">`</span><span class="k">${</span><span class="nv">PRE_JAVA</span><span class="k">}</span>java <span class="k">${</span><span class="nv">JAVA_OPTS</span><span class="k">}</span> -jar webapp-runner-7.0.29.3.jar
 --port <span class="k">${</span><span class="nv">PORT</span><span class="k">}</span> <span class="k">${</span><span class="nv">WEBAPP_RUNNER_OPTS</span><span class="k">}</span> myapp-0.0.1.war<span class="sb">`</span>
web.1: up 2013/01/01 22:37:35 <span class="o">(</span>~ 31s ago<span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Here we see a Java process executing a JAR file called <span class="monospaced">webapp-runner-7.0.29.3.jar</span> which is passed our WAR file as an argument. This is not identical to the Tomcat <span class="monospaced">catalina.sh</span> script you may be more familiar with, but instead is this launcher process: <a href="https://github.com/jsimone/webapp-runner">https://github.com/jsimone/webapp-runner</a>. As it does not register a handler to deal with <span class="monospaced">SIGTERM</span>, so we will have to if we need to release any resources during shutdown.</p></div>
<div class="paragraph"><p>All of this means that if you want to launch a Lift application in a different way, you can. You&#8217;d need to wrap an appropriate container (Jetty or Tomcat for example), and provide a <span class="monospaced">main</span> method for Heroku to call. This is sometimes called "containerless deployment".</p></div>
<div class="paragraph"><p>If you are not a Heruoku Enterprise Java customer, and you&#8217;re uncomfortable with the unsupported nature of the <span class="monospaced">deploy:war</span> plugin, you now know what you need to do to run in a supported way: provide a <span class="monospaced">main</span> method that launches you application and listen for connections. The <em>See Also</em> section gives pointers for how to do this.</p></div>
<div class="sect4">
<h5 id="_database_access_in_heroku">Database Access in Heroku</h5>
<div class="paragraph"><p>Heroku make no restrictions on which databases you can connect to from your Lift application, but they try to make it easy to use their PostgreSQL service by attaching a free database to applications you create.</p></div>
<div class="paragraph"><p>You can find out if you have a database by running the <span class="monospaced">pg</span> command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>heroku pg --app glacial-waters-6292
<span class="o">===</span> HEROKU_POSTGRESQL_BLACK_URL <span class="o">(</span>DATABASE_URL<span class="o">)</span>
Plan:        Dev
Status:      available
Connections: 0
PG Version:  9.1.6
Created:     2012-12-31 10:02 UTC
Data Size:   5.9 MB
Tables:      0
Rows:        0/10000 <span class="o">(</span>In compliance<span class="o">)</span>
Fork/Follow: Unsupported
</pre></div></div></div>
<div class="paragraph"><p>The URL of the database is provided to your Lift application as the <span class="monospaced">DATABASE_URL</span> environment variable. It will have a value something like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>postgres://gghetjutddgr:RNC_lINakkk899HHYEFUppwG@ec2-54-243-230-119.compute-1.
 amazonaws.com:5432/d44nsahps11hda</pre>
</div></div>
<div class="paragraph"><p>This URL contains a user name, password, host and database name, but needs to be manipulated to be used by JDBC.  To do so, you might include the following in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> <span class="nc">Box</span> <span class="o">!!</span> <span class="nc">System</span><span class="o">.</span><span class="n">getenv</span><span class="o">(</span><span class="s">&quot;DATABASE_URL&quot;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Full</span><span class="o">(</span><span class="n">url</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">initHerokuDb</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="c1">// configure local database perhaps</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">initHerokuDb</span><span class="o">(</span><span class="n">dbInfo</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Class</span><span class="o">.</span><span class="n">forName</span><span class="o">(</span><span class="s">&quot;org.postgresql.Driver&quot;</span><span class="o">)</span>

  <span class="c1">// Extract credentials from Heroku database URL:</span>
  <span class="k">val</span> <span class="n">dbUri</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">URI</span><span class="o">(</span><span class="n">dbInfo</span><span class="o">)</span>
  <span class="k">val</span> <span class="nc">Array</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">pass</span><span class="o">)</span> <span class="k">=</span> <span class="n">dbUri</span><span class="o">.</span><span class="n">getUserInfo</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;:&quot;</span><span class="o">)</span>

  <span class="c1">// Construct JDBC connection string from the URI:</span>
  <span class="k">def</span> <span class="n">connection</span> <span class="k">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(</span>
    <span class="s">&quot;jdbc:postgresql://&quot;</span> <span class="o">+</span> <span class="n">dbUri</span><span class="o">.</span><span class="n">getHost</span> <span class="o">+</span> <span class="sc">&#39;:&#39;</span> <span class="o">+</span> <span class="n">dbUri</span><span class="o">.</span><span class="n">getPort</span> <span class="o">+</span>
      <span class="n">dbUri</span><span class="o">.</span><span class="n">getPath</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">pass</span><span class="o">)</span>

  <span class="nc">SquerylRecord</span><span class="o">.</span><span class="n">initWithSquerylSession</span><span class="o">(</span>
    <span class="nc">Session</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">connection</span><span class="o">,</span> <span class="k">new</span> <span class="nc">PostgreSqlAdapter</span><span class="o">))</span>

  <span class="n">S</span><span class="o">.</span><span class="n">addAround</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoanWrapper</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">inTransaction</span> <span class="o">{</span> <span class="n">f</span> <span class="o">}</span>
  <span class="o">})</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Here we are testing for the presence of the <span class="monospaced">DATABASE_URL</span> environment variable, which would indicate that we are in the Heroku environment. The example code then goes on to initialize Squeryl Record in Lift (described in <a href="#Squeryl">[Squeryl]</a>) using the Heroku database settings.</p></div>
<div class="paragraph"><p>For it to run <span class="monospaced">build.sbt</span> needs the appropriate dependencies for Record and PostgresSQL:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">...</span>
<span class="s">&quot;postgresql&quot;</span> <span class="o">%</span> <span class="s">&quot;postgresql&quot;</span> <span class="o">%</span> <span class="s">&quot;9.1-901.jdbc4&quot;</span><span class="o">,</span>
<span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-record&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span><span class="o">,</span>
<span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-squeryl-record&quot;</span> <span class="o">%</span> <span class="n">liftVersion</span><span class="o">,</span>
<span class="o">...</span>
</pre></div></div></div>
<div class="paragraph"><p>With this in place, your Lift application can make use of the Heroku database. You can also access the database from the shell, e.g.,:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>pg:psql --app glacial-waters-6292
psql <span class="o">(</span>9.1.4, server 9.1.6<span class="o">)</span>
SSL connection <span class="o">(</span>cipher: DHE-RSA-AES256-SHA, bits: 256<span class="o">)</span>
Type <span class="s2">&quot;help&quot;</span> <span class="k">for </span>help.

<span class="nv">d44nsahps11hda</span><span class="o">=</span>&gt; <span class="se">\d</span>
No relations found.
<span class="nv">d44nsahps11hda</span><span class="o">=</span>&gt; <span class="se">\q</span>
<span class="err">$</span>
</pre></div></div></div>
<div class="paragraph"><p>To access via a JDBC tool outside of the Heroku environment, you&#8217;ll need to include parameters to force SSL. For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>jdbc:postgresql://ec2-54-243-230-119.compute-1.amazonaws.com:5432/d44nsahps11hda?
  username=gghetjutddgr&amp;password=RNC_lINakkk899HHYEFUppwG&amp;ssl=true&amp;sslfactory=
  org.postgresql.ssl.NonValidatingFactory</pre>
</div></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_89">See Also</h4>
<div class="paragraph"><p>Both the Scala and Java articles at Heroku are useful to learn more of the details described in this recipe: <a href="https://devcenter.heroku.com/categories/scala">https://devcenter.heroku.com/categories/scala</a> and <a href="https://devcenter.heroku.com/categories/java">https://devcenter.heroku.com/categories/java</a>.</p></div>
<div class="paragraph"><p><em>Dynos and the Dyno Manifold</em> are described at: <a href="https://devcenter.heroku.com/articles/dynos">https://devcenter.heroku.com/articles/dynos</a>.</p></div>
<div class="paragraph"><p>The JVM shutdown hooks are described in the JDK documentation: <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Runtime.html">http://docs.oracle.com/javase/7/docs/api/java/lang/Runtime.html</a>.</p></div>
<div class="paragraph"><p>Heroku&#8217;s guide to containerless deployment makes use of Maven to package your application, as is documented at <a href="https://devcenter.heroku.com/articles/java-webapp-runner">https://devcenter.heroku.com/articles/java-webapp-runner</a>.  There are also a template SBT project from Matthew Henderson that includes a <span class="monospaced">JettyLauncher</span> class: <a href="https://github.com/ghostm/lift_blank_heroku">https://github.com/ghostm/lift_blank_heroku</a>.</p></div>
<div class="paragraph"><p>The way Heroku deal with comet long-poling is described at <a href="https://devcenter.heroku.com/articles/request-timeout">https://devcenter.heroku.com/articles/request-timeout</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="DistributedComet">Distributing Comet Across Multiple Servers</h3>
<div class="sect3">
<h4 id="_problem_91">Problem</h4>
<div class="paragraph"><p>You use Lift&#8217;s Comet support, and want to run across multiple servers for increased redundancy or to handle increased load.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_91">Solution</h4>
<div class="paragraph"><p>Use the <em>publish/subscribe</em> (pubsub) model to connect each server to a <em>topic</em> and route comet message out to the topic where it can be broadcast to all servers that are part of your application.</p></div>
<div class="paragraph"><p>There are a variety of technologies you can use to accomplish this, such as databases, message systems, actor systems. For this recipe we will use the RabitMQ message service, but there are examples using CouchDB and Amazon&#8217;s Simple Notification Service in the <em>See Also</em> section.</p></div>
<div class="paragraph"><p>Regardless of the technology, the principle is that illustrated in <a href="#DistributedCometDiagram">[DistributedCometDiagram]</a>. A comet event originating on one Lift application, is sent to a service for redistribution. It is the responsibility of this service (labeled as "topic" in the figure) is to ensure all the participating Lift applications receive the event so it can be processed as normal by Lift.</p></div>
<div class="imageblock" id="DistributedCometDiagram">
<div class="content">
<img src="images/topic.png" alt="images/topic.png" width="640">
</div>
<div class="title">Figure 7. Comet events originating on one server are distributed via a topic.</div>
</div>
<div class="paragraph"><p>The first step is to download and install RabbitMQ from <a href="http://rabbitmq.com/">http://rabbitmq.com/</a>. Then start the server:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ ./sbin/rabbitmq-server -detatched</pre>
</div></div>
<div class="paragraph"><p>This command will produce various messages as it starts but will eventually say: "broker running".</p></div>
<div class="paragraph"><p>The Lift application we&#8217;ll use to demonstrate the pubsub pattern is the real-time chat application, described in <em>Simply Lift</em>.
The first modification is to include the Lift module to talk to RabbitMQ. This is a one-line addition to the <span class="monospaced">libraryDependencies</span> in <span class="monospaced">build.sbt</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s">&quot;net.liftmodules&quot;</span> <span class="o">%%</span> <span class="s">&quot;amqp&quot;</span> <span class="o">%</span> <span class="o">(</span><span class="n">liftVersion</span> <span class="o">+</span> <span class="s">&quot;-1.1&quot;</span><span class="o">),</span>
</pre></div></div></div>
<div class="paragraph"><p>AMQP stands for Advanced Message Queuing Protocol, a protocol that RabbitMQ talks. The AMQP module provides abstract actors to send and receive messages, and we will implement these actors as <span class="monospaced">RemoteSend</span> and <span class="monospaced">RemoteReceiver</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">code.comet</span>

<span class="k">import</span> <span class="nn">net.liftmodules.amqp._</span>
<span class="k">import</span> <span class="nn">com.rabbitmq.client._</span>

<span class="k">object</span> <span class="nc">Rabbit</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">factory</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConnectionParameters</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">host</span> <span class="k">=</span> <span class="s">&quot;127.0.0.1&quot;</span>
  <span class="k">val</span> <span class="n">port</span> <span class="k">=</span> <span class="mi">5672</span>
  <span class="k">val</span> <span class="n">exchange</span> <span class="k">=</span> <span class="s">&quot;lift.chat&quot;</span>
  <span class="k">val</span> <span class="n">routing</span> <span class="k">=</span> <span class="s">&quot;&quot;</span>
  <span class="k">val</span> <span class="n">durable</span> <span class="k">=</span> <span class="kc">true</span>
  <span class="k">val</span> <span class="n">noAck</span> <span class="k">=</span> <span class="kc">false</span>

  <span class="k">object</span> <span class="nc">RemoteSend</span> <span class="k">extends</span> <span class="nc">AMQPSender</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">factory</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span>
    <span class="n">exchange</span><span class="o">,</span> <span class="n">routing</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">configure</span><span class="o">(</span><span class="n">channel</span><span class="k">:</span> <span class="kt">Channel</span><span class="o">)</span> <span class="k">=</span>
      <span class="n">channel</span><span class="o">.</span><span class="n">exchangeDeclare</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="s">&quot;fanout&quot;</span><span class="o">,</span> <span class="n">durable</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">RemoteReceiver</span> <span class="k">extends</span> <span class="nc">AMQPDispatcher</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">factory</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">configure</span><span class="o">(</span><span class="n">channel</span><span class="k">:</span> <span class="kt">Channel</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
      <span class="n">channel</span><span class="o">.</span><span class="n">exchangeDeclare</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="s">&quot;fanout&quot;</span><span class="o">,</span> <span class="n">durable</span><span class="o">)</span>
      <span class="k">val</span> <span class="n">queueName</span> <span class="k">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">queueDeclare</span><span class="o">().</span><span class="n">getQueue</span><span class="o">()</span>
      <span class="n">channel</span><span class="o">.</span><span class="n">queueBind</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">routing</span><span class="o">)</span>
      <span class="n">channel</span><span class="o">.</span><span class="n">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">noAck</span><span class="o">,</span>
        <span class="k">new</span> <span class="nc">SerializedConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="k">this</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This code is establishing <span class="monospaced">RemoteSend</span> and <span class="monospaced">RemoteReceiver</span> actors that serialise <span class="monospaced">String</span> values via RabbitMQ.  This code is explored in the <em>Discussion</em> section below.</p></div>
<div class="paragraph"><p>To make use of this and route comet messages over RabbitMQ we need to make two changes.  In <span class="monospaced">Boot.scala</span> we need to start listening for messages from RabbitMQ:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">RemoteReceiver</span> <span class="o">!</span> <span class="nc">AMQPAddListener</span><span class="o">(</span><span class="nc">ChatServer</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This is attaching the <span class="monospaced">ChatServer</span> as a listener for AMQP messages from the <span class="monospaced">RemoteReciver</span>.</p></div>
<div class="paragraph"><p>The final change is to the <span class="monospaced">ChatServer</span> itself.  The regular behaviour of the <span class="monospaced">ChatServer</span> is to receive a <span class="monospaced">String</span> message from a client and update all the screens attached to the comet server:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">override</span> <span class="k">def</span> <span class="n">lowPriority</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">s</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="n">msgs</span> <span class="o">:+=</span> <span class="n">s</span><span class="o">;</span> <span class="n">updateListeners</span><span class="o">()</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The change to route messages over RabbitMQ is to redirect any <span class="monospaced">String</span> from clients to RabbitMQ, and handle any AMQP messages from RabbitMQ and update all clients:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">override</span> <span class="k">def</span> <span class="n">lowPriority</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">AMQPMessage</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">msgs</span> <span class="o">:+=</span> <span class="n">s</span><span class="o">;</span> <span class="n">updateListeners</span><span class="o">()</span>
  <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">RemoteSend</span> <span class="o">!</span> <span class="nc">AMQPMessage</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This change means all our comet chat messages go out to RabbitMQ where they are distributed to all the instances of our Lift application, and all the instances receive the messages back as <span class="monospaced">AMQPMessage</span> instances and update chat clients as normal.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_92">Discussion</h4>
<div class="paragraph"><p>To run more than one instance of your Lift application locally, you&#8217;ll want to start SBT as normal, and then in another terminal start again but on a different port number:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sbt
...
&gt; set port in container.Configuration := 9090
[info] Reapplying settings...
[info] Set current project to RabbitMQ Chat (in build file:rabbitmq_chat/)
&gt; container:start</pre>
</div></div>
<div class="paragraph"><p>You can then visit one application at <span class="monospaced">http://127.0.0.1:8080</span> and another at <span class="monospaced">http://127.0.0.1:9090</span>.</p></div>
<div class="paragraph"><p>In the example code, you can see that <span class="monospaced">AMQPSender[T]</span> and <span class="monospaced">AMQPDispatcher[T]</span> take care of most of the work for us, and we provide some configuration.  In the case of <span class="monospaced">RemoteSend</span> we&#8217;re configuring the <span class="monospaced">AMQPSender</span> to work with <span class="monospaced">String</span> messages and to work with an <em>exchange</em> called "lift.chat". In RabbitMQ the exchange is the entity we send messages to, and the exchange has the responsibility for passing on the message.  In this case the exchange is a <em>fanout</em> (a simple kind of topic) where each subscriber receives a copy of any messages sent to the exchange.  This is clearly what we want to get our chat messages sent to all connected Lift instances of the chat application.</p></div>
<div class="paragraph"><p>The <span class="monospaced">RemoteReceiver</span> is also configured to receive <span class="monospaced">String</span> messages, although the configuration is a little longer. Here, as well as indicating the exchange to be used, we declare a <em>temporary queue</em> for our Lift instance.  The queue is the place where RabbitMQ sends messages, and what we&#8217;re saying here is that each receiver has its own queue. The fanout exchange will ensure any message sent to the exchange is placed into every queue. The queue has a random name assigned by RabbitMQ and is destroyed we disconnect from it.</p></div>
<div class="paragraph"><p>The final part of the <span class="monospaced">RemoteReceiver</span> is to specify how we consume messages. The default behaviour of <span class="monospaced">RemoteSend</span> is to serialise objects, so we mirror that in the receiver by using the <span class="monospaced">SerializedConsumer</span> class provided by the AMQP module.</p></div>
<div class="paragraph"><p>To see the behaviour of RabbitMQ, it&#8217;s useful to install the management web console.  From the directory where you installed RabbitMQ:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ ./sbin/rabbitmq-plugins enable rabbitmq_management</pre>
</div></div>
<div class="paragraph"><p>Visit the administrative web interface at <span class="monospaced">http://127.0.0.1:15672/</span> and login.  The default username and password is "guest".</p></div>
<div class="paragraph"><p>Having to have RabbitMQ (or other type of pubsub solution) running during development may be inconvenient. In that case, you can simply not initialize the service in <span class="monospaced">Boot.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">if</span> <span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">productionMode</span><span class="o">)</span>
  <span class="nc">RemoteReceiver</span> <span class="o">!</span> <span class="nc">AMQPAddListener</span><span class="o">(</span><span class="nc">ChatServer</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>And in the chat server, only send to local clients:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">override</span> <span class="k">def</span> <span class="n">lowPriority</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">AMQPMessage</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">msgs</span> <span class="o">:+=</span> <span class="n">s</span><span class="o">;</span> <span class="n">updateListeners</span><span class="o">()</span>
  <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">productionMode</span><span class="o">)</span> <span class="nc">RemoteSend</span> <span class="o">!</span> <span class="nc">AMQPMessage</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="k">else</span> <span class="o">{</span> <span class="n">msgs</span> <span class="o">:+=</span> <span class="n">s</span><span class="o">;</span> <span class="n">updateListeners</span><span class="o">()</span> <span class="o">}</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that <span class="monospaced">Props.productionMode</span> is <span class="monospaced">true</span> for the run modes of <span class="monospaced">Production</span>, <span class="monospaced">Staging</span> and <span class="monospaced">Pilot</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_90">See Also</h4>
<div class="paragraph"><p>The Lift Chat example is described in <em>Simply Lift</em> at <a href="http://simply.liftweb.net/">http://simply.liftweb.net/</a>. The source code used in this recipe can be found at: <a href="https://github.com/LiftCookbook/rabbitmq_chat">https://github.com/LiftCookbook/rabbitmq_chat</a>.</p></div>
<div class="paragraph"><p>The Lift AMQP module is: <a href="https://github.com/liftmodules/amqp">https://github.com/liftmodules/amqp</a>.</p></div>
<div class="paragraph"><p>If you want to learn more about RabbitMQ, take a look at the tutorials (<a href="http://www.rabbitmq.com/tutorials/tutorial-five-java.html">http://www.rabbitmq.com/tutorials/tutorial-five-java.html</a>) or Alvaro Videla and Jason J.W. Williams (2012), <em>RabbitMQ in Action: Distributed Messaging for Everyone</em>, Manning Publications.</p></div>
<div class="paragraph"><p>Diego Medina has implemented a distributed comet solution using CouchDB, and has described it in a blog post at <a href="https://fmpwizard.telegr.am/blog/distributed-comet-chat-lift">https://fmpwizard.telegr.am/blog/distributed-comet-chat-lift</a>.</p></div>
<div class="paragraph"><p>Amazon&#8217;s Simple Notification Service (SNS) is a fanout facility so can also be used to implement this pattern. You can find a Lift module for SNS at <a href="https://github.com/SpiralArm/liftmodules-aws-sns">https://github.com/SpiralArm/liftmodules-aws-sns</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ContributingAndHelp">Contributing, Bug Reports &amp; Getting Help</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="GettingHelp">You&#8217;d Like Some Help</h3>
<div class="sect3">
<h4 id="_problem_92">Problem</h4>
<div class="paragraph"><p>You&#8217;re stuck on something in Lift and you&#8217;d like some help.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_92">Solution</h4>
<div class="paragraph"><p>Ask a question on the Lift mailing list at <a href="https://groups.google.com/group/liftweb">https://groups.google.com/group/liftweb</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_93">Discussion</h4>
<div class="paragraph"><p>You will find some information about Lift on StackOverflow, Quora and elsewhere, but the mailing list is <em>the</em> place to go to get help and support. You can search the archive to see if your question has already been addressed, but questions are very welcome as it helps the Lift community understand what users need and what might be causing problems or need explanation. Much of what you&#8217;re reading here originates from questions that have been asked on the mailing list.</p></div>
<div class="paragraph"><p>New members to the mailing list are moderated to help reduce spam. This means the first time you post your message may take a few hours to show up.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_91">See Also</h4>
<div class="paragraph"><p>The Lift community is one of the things that makes Lift what it is. Please take a look at <a href="http://liftweb.net/community">http://liftweb.net/community</a> before posting: you&#8217;ll get the best response with a polite question.</p></div>
<div class="paragraph"><p>If you need paid consulting, development or SLA-backed support, there&#8217;s a list of organizations on the Wiki at <a href="https://www.assembla.com/spaces/liftweb/wiki/Commercial_Support">https://www.assembla.com/spaces/liftweb/wiki/Commercial_Support</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="HowToReportBugs">How to Report Bugs</h3>
<div class="sect3">
<h4 id="_problem_93">Problem</h4>
<div class="paragraph"><p>You&#8217;ve found a bug and want to report it.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_93">Solution</h4>
<div class="paragraph"><p>Discuss your findings on the Lift mailing list, saying what you&#8217;re
seeing, and what you&#8217;d expect to see.</p></div>
<div class="paragraph"><p>By all means look at the existing tickets to see if your issue is there or recently fixed, but please do not
raise a ticket unless asked to do so by a Lift committer on the mailing list.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_94">Discussion</h4>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>If Lift is not behaving as you expect, please ask questions about what
you&#8217;re seeing. The ideal form of these questions is "When I do X, my
Lift app does Y, but I expect it to do Z, why?" This provides a set of
language to discuss your application and the way that Lift responds to
requests. Perhaps there&#8217;s a way of improving Lift. Perhaps there&#8217;s a
concept that&#8217;s different in Lift than you might be used to. Perhaps
there&#8217;s a documentation issue that can help bridge the gap between what
Lift is doing and what you expect it to do. Most importantly, just
because Lift is behaving differently than you expect it to, it&#8217;s not
necessarily a bug in Lift.</p></div>
</div>
<div class="attribution">
<em>http://lift.la/expected-behavior-in-the-lift-community</em><br>
&#8212; David Pollack
</div></div>
<div class="paragraph"><p>A great way to get help with the issue you have, or getting a bug fixed, is to produce a small example to illustrate the problem and posting it on GitHub. The key is to provide instructions so someone can run the example and see exactly what you see without having to jump though hoops.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_92">See Also</h4>
<div class="paragraph"><p>You&#8217;ll find a list of tickets at <a href="http://ticket.liftweb.net/">http://ticket.liftweb.net/</a>.</p></div>
<div class="paragraph"><p>If you&#8217;re asked to, or want to, post example code there&#8217;s a guide at <a href="http://www.assembla.com/wiki/show/liftweb/Posting_example_code">http://www.assembla.com/wiki/show/liftweb/Posting_example_code</a>.</p></div>
<div class="paragraph"><p>If you&#8217;ve found a bug, and you&#8217;re asked to create a ticket, the main thing to do is to include a link to the mailing list discussion of the issue, as described at <a href="http://www.assembla.com/wiki/show/liftweb/Creating_tickets">http://www.assembla.com/wiki/show/liftweb/Creating_tickets</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="LiftCodeContributions">Contributing Small Code Changes and ScalaDoc</h3>
<div class="sect3">
<h4 id="_problem_94">Problem</h4>
<div class="paragraph"><p>You have a small change or ScalaDoc improvement you&#8217;d like incorporated into Lift.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_94">Solution</h4>
<div class="paragraph"><p>You can issue pull requests against the Lift source providing your change meets one of the following requirements:</p></div>
<div class="ulist"><ul>
<li>
<p>
It&#8217;s change to a comment.
</p>
</li>
<li>
<p>
It&#8217;s example code.
</p>
</li>
<li>
<p>
It&#8217;s a <em>small</em> change, enhancements, or bug fix to Lift.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Your pull request must include an edit to add your signature to the bottom of the <span class="monospaced">contributors.md</span> file.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_95">Discussion</h4>
<div class="paragraph"><p>Historically Lift had a strict contributor policy of simply not accepting any code contributions except from committers who had signed an agreement to assign copyright to the Lift project.  This allowed corporations wanting to adopt Lift to do so without litigation concerns.</p></div>
<div class="paragraph"><p>The safety is still there, now via the requirement for a signature on the contributors file, which reads:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>By submitting this pull request which includes my name and email address (the email address may be in a non-robot readable format), I agree that the entirety of the contribution is my own original work, that there are no prior claims on this work including, but not limited to, any agreements I may have with my employer or other contracts, and that I license this work under an Apache 2.0 license.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>What&#8217;s a small change? That&#8217;s a good question, and if you&#8217;re unsure, talk about your proposed change on the mailing list.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_93">See Also</h4>
<div class="paragraph"><p>This contribution policy was introduced in November 2012, and can be read about at <a href="http://www.lift.la/blog/new_contribution_policy">http://www.lift.la/blog/new_contribution_policy</a>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">contributors.md</span> file is found at: <a href="https://github.com/lift/framework/blob/master/contributors.md">https://github.com/lift/framework/blob/master/contributors.md</a>.</p></div>
<div class="paragraph"><p>The Lift source is on GitHub at <a href="https://github.com/lift/">https://github.com/lift/</a>.  The <em>framework</em> project is probably the one you want, although you&#8217;ll also find Git repositories for examples and Lift web sites there.</p></div>
<div class="paragraph"><p>GitHub provide an introduction to pull requests at <a href="https://help.github.com/articles/using-pull-requests">https://help.github.com/articles/using-pull-requests</a>.</p></div>
<div class="paragraph"><p><a href="#modules">[modules]</a> describes how to share code of any size via Lift modules.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="wiki">Contributing Documentation</h3>
<div class="sect3">
<h4 id="_problem_95">Problem</h4>
<div class="paragraph"><p>You&#8217;d like to contribute documentation to Lift.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_95">Solution</h4>
<div class="paragraph"><p>Update or add to the Lift wiki at <a href="https://www.assembla.com/wiki/show/liftweb">https://www.assembla.com/wiki/show/liftweb</a>.</p></div>
<div class="paragraph"><p>You&#8217;ll need to sign in, or create a free account, with Assembla, the company that hosts the wiki. You then need to become a <em>watcher</em> of the Lift wiki, which is offered as a link on the top right of the Lift wiki page.  As a watcher you can edit pages and create new pages.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_96">Discussion</h4>
<div class="paragraph"><p>If you&#8217;re unsure about a change you&#8217;d like to make, just ask for feedback on the Lift mailing list.</p></div>
<div class="paragraph"><p>One limitation of the watcher role on Assembla is that you cannot move pages. If you create a new page in the wrong section, or want to reorganise pages, you&#8217;ll need to ask on the Lift mailing list for someone with permissions to do that for you.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_94">See Also</h4>
<div class="paragraph"><p>The markup format for the Wiki pages is Textile. A reference guide can be found at: <a href="http://redcloth.org/hobix.com/textile/">http://redcloth.org/hobix.com/textile/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="AddRecipe">How to Add a New Recipe to this Cookbook</h3>
<div class="sect3">
<h4 id="_problem_96">Problem</h4>
<div class="paragraph"><p>You&#8217;d like to add a section or chapter to this cookbook.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_96">Solution</h4>
<div class="paragraph"><p>If you&#8217;re comfortable using Git, you can fork the repository and send a
pull request.</p></div>
<div class="paragraph"><p>Alternatively, download a template file, write your recipe, and email
to the Lift mailing list at <a href="https://groups.google.com/group/liftweb">https://groups.google.com/group/liftweb</a>.</p></div>
<div class="paragraph"><p>You can find the template file at: <a href="https://raw.github.com/d6y/lift-cookbook/master/template.asciidoc">https://raw.github.com/d6y/lift-cookbook/master/template.asciidoc</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_97">Discussion</h4>
<div class="paragraph"><p>Anything you&#8217;ve puzzled over, or things which have surprised you, impressed you or are non-obvious are great topics for recipes. Improvements, discussions and clarifications of existing recipes are welcome too.</p></div>
<div class="paragraph"><p>The cookbook is structured using a markup language called Asciidoc. If you&#8217;re familiar with Markdown or Textile, you&#8217;ll find similarities. For the cookbook you only need to know about section headings, source code formatting and links.  Examples of all of these are in the <span class="monospaced">template.asciidoc</span> file.</p></div>
<div class="paragraph"><p>To find out where to make a change you need to know that each chapter is a separate file, and each recipe is a section in that file.</p></div>
<div class="sect4">
<h5 id="_licensing">Licensing</h5>
<div class="paragraph"><p>We ask contributors the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
You agree to license your work (including the words you write, the code you use and any images) to us under the Creative Commons Attribution, Non Commercial, No Derivatives license.
</p>
</li>
<li>
<p>
You assert that the work is your own, or you have the necessary permission for the work.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To keep things simple, all author royalties from this book are given to charity.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_95">See Also</h4>
<div class="paragraph"><p>The source to this book is at: <a href="https://github.com/d6y/lift-cookbook/">https://github.com/d6y/lift-cookbook/</a>.</p></div>
<div class="paragraph"><p>The AsciiDoc cheetsheet at <a href="http://powerman.name/doc/asciidoc">http://powerman.name/doc/asciidoc</a> is a quick way to get into AsciiDoc, but if you need more, the AsciiDoc home page has the details: <a href="http://www.methods.co.nz/asciidoc/">http://www.methods.co.nz/asciidoc/</a>.</p></div>
<div class="paragraph"><p>GitHub provide an introduction to pull requests at <a href="https://help.github.com/articles/using-pull-requests">https://help.github.com/articles/using-pull-requests</a>.</p></div>
<div class="paragraph"><p><a href="#wiki">[wiki]</a> describes other ways to contribution documentation to Lift.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="modules">Sharing Code in Modules</h3>
<div class="sect3">
<h4 id="_problem_97">Problem</h4>
<div class="paragraph"><p>You have code you&#8217;d like to share between Lift projects.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_97">Solution</h4>
<div class="paragraph"><p>Create a Lift module, and then reference the module from your Lift projects.</p></div>
<div class="paragraph"><p>As an example, let&#8217;s create a module to embed the Snowstorm snow fall effect on every page in your Lift web application (please don&#8217;t do this).</p></div>
<div class="paragraph"><p>There&#8217;s nothing special about modules: they are code, packaged and used like any other dependency. What makes them possible is the exposure of extension points via <span class="monospaced">LiftRules</span>. The main convention is to have an <span class="monospaced">init</span> method that Lift applications can use to initialize your module.</p></div>
<div class="paragraph"><p>For our snow storm we&#8217;re going to package some JavaScript and inject the script onto every page.</p></div>
<div class="paragraph"><p>Starting with the <span class="monospaced">lift_blank</span> template downloaded from liftweb.net, we can remove all the source and HTML files as this won&#8217;t be a runnable Lift application in itself. However, it will leave us with the regular Lift structure and build configuration.</p></div>
<div class="paragraph"><p>Our module will need the Snowstorm JavaScript file from <a href="https://github.com/scottschiller/snowstorm/">https://github.com/scottschiller/snowstorm/</a> copied as <span class="monospaced">resources/toserve/snowstorm.js</span>.  This will place the JavaScript file on the classpath of our Lift application.</p></div>
<div class="paragraph"><p>The final piece of the module is to ensure the JavaScript is included on every page:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">package</span> <span class="nn">net.liftmodules.snowstorm</span>

<span class="k">import</span> <span class="nn">net.liftweb.http._</span>

<span class="k">object</span> <span class="nc">Snowstorm</span> <span class="o">{</span>

 <span class="k">def</span> <span class="n">init</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

  <span class="nc">ResourceServer</span><span class="o">.</span><span class="n">allow</span> <span class="o">{</span>
     <span class="k">case</span> <span class="s">&quot;snowstorm.js&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="k">=&gt;</span> <span class="kc">true</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">addSnow</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">LiftSession</span><span class="o">,</span> <span class="n">r</span><span class="k">:</span> <span class="kt">Req</span><span class="o">)</span> <span class="k">=</span> <span class="n">S</span><span class="o">.</span><span class="n">putInHead</span><span class="o">(</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;/classpath/snowstorm.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span> <span class="o">)</span>

  <span class="nc">LiftSession</span><span class="o">.</span><span class="n">onBeginServicing</span> <span class="k">=</span> <span class="n">addSnow</span> <span class="k">_</span> <span class="o">::</span>  <span class="nc">LiftSession</span><span class="o">.</span><span class="n">onBeginServicing</span>

 <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Here we are plugging into Lift&#8217;s processing pipeline and adding the required
JavaScript to the head of every page.</p></div>
<div class="paragraph"><p>We modify <span class="monospaced">build.sbt</span> to give the module a name, organisation and version number.  We also can remove many of the dependencies and the web plugin as we only depend on the web API elements of Lift:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">name</span> <span class="o">:=</span> <span class="s">&quot;snowstorm&quot;</span>

<span class="n">version</span> <span class="o">:=</span> <span class="s">&quot;1.0.0&quot;</span>

<span class="n">organization</span> <span class="o">:=</span> <span class="s">&quot;net.liftmodules&quot;</span>

<span class="n">scalaVersion</span> <span class="o">:=</span> <span class="s">&quot;2.9.1&quot;</span>

<span class="n">resolvers</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
   <span class="s">&quot;snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;http://oss.sonatype.org/content/repositories/snapshots&quot;</span><span class="o">,</span>
   <span class="s">&quot;releases&quot;</span> <span class="n">at</span> <span class="s">&quot;http://oss.sonatype.org/content/repositories/releases&quot;</span>
<span class="o">)</span>

<span class="n">scalacOptions</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">&quot;-deprecation&quot;</span><span class="o">,</span> <span class="s">&quot;-unchecked&quot;</span><span class="o">)</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5-RC2&quot;</span>
  <span class="nc">Seq</span><span class="o">(</span>
    <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-webkit&quot;</span>  <span class="o">%</span> <span class="n">liftVersion</span>  <span class="o">%</span> <span class="s">&quot;compile&quot;</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We can publish this plugin to the repository on disk by starting SBT and typing:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>publish-local</pre>
</div></div>
<div class="paragraph"><p>With our module built and published, we can now include it in our Lift applications. To do that, modify the Lift application&#8217;s <span class="monospaced">build.sbt</span> to reference this new "snowstorm" dependency:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="s">&quot;2.5-RC2&quot;</span>
  <span class="nc">Seq</span><span class="o">(</span>
  <span class="o">...</span>
  <span class="s">&quot;net.liftmodules&quot;</span> <span class="o">%%</span> <span class="s">&quot;snowstorm&quot;</span> <span class="o">%</span> <span class="s">&quot;1.0.0&quot;</span><span class="o">,</span>
  <span class="o">...</span>
</pre></div></div></div>
<div class="paragraph"><p>In our Lift application&#8217;s <span class="monospaced">Boot.scala</span> we finally initialise the plugin:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">net.liftmodules.snowstorm.Snowstorm</span>
<span class="nc">Snowstorm</span><span class="o">.</span><span class="n">init</span><span class="o">()</span>
</pre></div></div></div>
<div class="paragraph"><p>When we run our Lift application, white snow will be falling on every page, supplied by the module.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_98">Discussion</h4>
<div class="paragraph"><p>The module is self contained: there&#8217;s no need for users to copy JavaScript files around or modify their templates.  To achieve that we&#8217;ve made use of <span class="monospaced">ResourceServer</span>.  When we reference the JavaScript file via <span class="monospaced">/classpath/snowstorm.js</span>, Lift will attempt to locate <span class="monospaced">snowstorm.js</span> from the classpath.  This is what we want for our Lift application because <span class="monospaced">snowstorm.js</span> will be inside the module JAR file.</p></div>
<div class="paragraph"><p>However, we do not want to expose all files on the classpath to anyone visiting our application. To avoid that, Lift looks for resources inside a <span class="monospaced">toserve</span> folder, which for our purposes means files and folders inside <span class="monospaced">src/main/resources/toserve</span>.  You can think of <span class="monospaced">/classpath</span> meaning <span class="monospaced">toserve</span> (although, you can change those values via <span class="monospaced">LiftRules.resourceServerPath</span> and <span class="monospaced">ResourceServer.baseResourceLocation</span>).</p></div>
<div class="paragraph"><p>As a further precaution you need to explicitly allow access to these resources.  That&#8217;s done with:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nc">ResourceServer</span><span class="o">.</span><span class="n">allow</span> <span class="o">{</span>
  <span class="k">case</span> <span class="s">&quot;snowstorm.js&quot;</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="k">=&gt;</span> <span class="kc">true</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We&#8217;re just always returning <span class="monospaced">true</span> for anyone who asks for this resource, but we could dynamically control access here if we wanted.</p></div>
<div class="paragraph"><p><span class="monospaced">S.putInHead</span> adds the JavaScript to the head of a page, and is triggered on every page by <span class="monospaced">LiftSession.onBeginServicing</span> (also discussed in <a href="#OnSession">[OnSession]</a>). We could make use of <span class="monospaced">Req</span> here to restrict the snow storm to particular pages, but we&#8217;re adding it to every page.</p></div>
<div class="paragraph"><p>Hopefully you can see that anything you can do in a Lift application you can probably turn into a Lift module.  A typical approach might be to have functionality in a Lift application, and then factor out settings in <span class="monospaced">Boot</span> into a module <span class="monospaced">init</span> method.  For example, if you wanted to provide REST services as a module, that would be possible and is an approach taken by the Lift Paypal module.</p></div>
<div class="sect4">
<h5 id="_making_your_module_available">Making your Module Available</h5>
<div class="paragraph"><p>If you do want your module to be used by a wider audience, you need to publish it to a public repository, such as Sonatype or CloudBees. You&#8217;ll also want to keep your module up-to-date with Lift releases. There are a few conventions around this.</p></div>
<div class="paragraph"><p>One convention is to include the Lift version as part of the module version number.  For example, version 1.0.0 of your module for Lift 2.5 would be "2.5-1.0.0".  This is verbose but makes it clear which version of your module is compatible with which versions of Lift.  It also means you need to keep your module up-to-date with Lift releases.</p></div>
<div class="paragraph"><p>One way to ease that is to make a modification to your module build to allow the Lift version number to change. This makes it possible to automate the build when new versions of Lift are released. To do that, create <span class="monospaced">project/LiftModule.scala</span> in your module:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">sbt._</span>
<span class="k">import</span> <span class="nn">sbt.Keys._</span>

<span class="k">object</span> <span class="nc">LiftModuleBuild</span> <span class="k">extends</span> <span class="nc">Build</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">liftVersion</span> <span class="k">=</span> <span class="nc">SettingKey</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;liftVersion&quot;</span><span class="o">,</span>
    <span class="s">&quot;Version number of the Lift Web Framework&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">project</span> <span class="k">=</span> <span class="nc">Project</span><span class="o">(</span><span class="s">&quot;LiftModule&quot;</span><span class="o">,</span> <span class="n">file</span><span class="o">(</span><span class="s">&quot;.&quot;</span><span class="o">))</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>This defines a setting to control the Lift version number.  You use it in your module <span class="monospaced">build.sbt</span> like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">name</span> <span class="o">:=</span> <span class="s">&quot;snowstorm&quot;</span>

<span class="n">liftVersion</span> <span class="o">&lt;&lt;=</span> <span class="n">liftVersion</span> <span class="o">??</span> <span class="s">&quot;2.5-SNAPSHOT&quot;</span>

<span class="n">version</span> <span class="o">&lt;&lt;=</span> <span class="n">liftVersion</span> <span class="n">apply</span> <span class="o">{</span> <span class="k">_</span> <span class="o">+</span> <span class="s">&quot;-1.0.0-SNAPSHOT&quot;</span> <span class="o">}</span>

<span class="o">...</span>

<span class="n">libraryDependencies</span> <span class="o">&lt;++=</span> <span class="n">liftVersion</span> <span class="o">{</span> <span class="n">v</span> <span class="k">=&gt;</span>
  <span class="s">&quot;net.liftweb&quot;</span> <span class="o">%%</span> <span class="s">&quot;lift-webkit&quot;</span> <span class="o">%</span> <span class="n">v</span> <span class="o">%</span> <span class="s">&quot;compile-&gt;default&quot;</span> <span class="o">::</span>
  <span class="nc">Nil</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>What this gives you is a way for the version of your module to depend on the <span class="monospaced">liftVersion</span> value.  This in turn can be set via a script.  This is what we do to publish a range of Lift Modules after each Lift release, as described at <a href="https://www.assembla.com/spaces/liftweb/wiki/Releasing_the_modules">https://www.assembla.com/spaces/liftweb/wiki/Releasing_the_modules</a>.</p></div>
<div class="paragraph"><p>Don&#8217;t forget to announce your module on the Lift mailing list.</p></div>
</div>
<div class="sect4">
<h5 id="_debugging_your_module">Debugging Your Module</h5>
<div class="paragraph"><p>When working on a module and testing it in a Lift application, it would be a chore to have to publish your module each time you changed it. Fortunately, SBT allows your Lift application to depend on the source of a module.  To use this, change your Lift project to remove the dependency on the published module and instead add a local dependency by creating <span class="monospaced">project/LocalModuleDev.scala</span>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">import</span> <span class="nn">sbt._</span>
<span class="k">object</span> <span class="nc">LocalModuleDev</span> <span class="k">extends</span> <span class="nc">Build</span> <span class="o">{</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="n">root</span> <span class="k">=</span> <span class="nc">Project</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">file</span><span class="o">(</span><span class="s">&quot;.&quot;</span><span class="o">))</span> <span class="n">dependsOn</span><span class="o">(</span><span class="n">snow</span><span class="o">)</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="n">snow</span> <span class="k">=</span> <span class="nc">ProjectRef</span><span class="o">(</span><span class="n">uri</span><span class="o">(</span><span class="s">&quot;../snowstorm&quot;</span><span class="o">),</span> <span class="s">&quot;LiftModule&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We are assuming that the snowstorm source can be found at <span class="monospaced">../snowstorm</span> relative to the Lift application we are using. With this in place, when you build your Lift project, SBT will automatically compile and depend on changes in the local <span class="monospaced">snowstorm</span> module.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_96">See Also</h4>
<div class="paragraph"><p>Originally Lift included a set of modules, but these have been separated out to individual projects at <a href="https://github.com/liftmodules/">https://github.com/liftmodules/</a>.  The Lift contributor policy outlined in <a href="#LiftCodeContributions">[LiftCodeContributions]</a> doesn&#8217;t apply to Lift modules: you&#8217;re free to contribute to these modules as you would any other open source project.</p></div>
<div class="paragraph"><p>The Lift wiki pages for modules can be reached via <a href="http://liftmodules.net">http://liftmodules.net</a>.</p></div>
<div class="paragraph"><p>The Snowstorm project ("setting CPUs on fire worldwide every winter since 2003") is at: <a href="https://github.com/scottschiller/snowstorm/">https://github.com/scottschiller/snowstorm/</a> and the module developed for this recipe is at <a href="https://github.com/LiftCookbook/snowstorm-example-module">https://github.com/LiftCookbook/snowstorm-example-module</a>.</p></div>
<div class="paragraph"><p>To publish to Sonatype, take a look at their guide: <a href="https://docs.sonatype.org/display/Repository/Sonatype+OSS+Maven+Repository+Usage+Guide">https://docs.sonatype.org/display/Repository/Sonatype+OSS+Maven+Repository+Usage+Guide</a>. CloudBees offer an open source repository, which you can learn about via <a href="http://www.cloudbees.com/foss/foss-dev.cb">http://www.cloudbees.com/foss/foss-dev.cb</a>.</p></div>
<div class="paragraph"><p>There are other ways to structure common code between Lift applications. For an example that uses SBT modules and Git, see the mailing list discussion on "Modularize Lift Applications" at <a href="https://groups.google.com/d/msg/liftweb/7GA5t0lefzI/c1wf6W1keDcJ">https://groups.google.com/d/msg/liftweb/7GA5t0lefzI/c1wf6W1keDcJ</a>.</p></div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated 2013-03-26 08:51:56 GMT
</div>
</div>
</body>
</html>
